
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AudioSystem=exports.parseAudioEventPath=exports.parseAudioEventPathInConfig=exports.INVALID_AUDIO_EVENT_VALUE=void 0;const puerts_1=require("puerts"),UE=require("ue"),Info_1=require("../Common/Info"),Log_1=require("../Common/Log"),FNameUtil_1=require("../Utils/FNameUtil"),AudioEventPool_1=require("./AudioEventPool"),ExecutionQueue_1=require("./ExecutionQueue"),INVALID_PLAYING_ID=0;function instanceOf(e,t){return e.IsValid()&&e.IsA(t.StaticClass())&&e.GetWorld()?.IsValid()}function parseAudioEventPathInConfig(e){var t=/^\/Game\/Aki\/WwiseAudio\/Events\/(?<name>\w+)/.exec(e);return t||Log_1.Log.CheckWarn()&&Log_1.Log.Warn("Audio",56,"[Core.AudioSystem] 非法的 AudioEvent 路径",["path",e],["reason","未在 /Game/Aki/WwiseAudio/Events/ 路径下或命名不符合规范"]),t?.groups?.name}function parseAudioEventPath(e){e="string"==typeof e?e:e.ToAssetPathName();return e?e.split(".").at(-1)?.toLowerCase():void 0}exports.INVALID_AUDIO_EVENT_VALUE=0,exports.parseAudioEventPathInConfig=parseAudioEventPathInConfig,exports.parseAudioEventPath=parseAudioEventPath;class AudioSystem{static Tick(e){this.a8.Tick(e)}static PostEvent(i,o,s){return!i||i.length<1?(Log_1.Log.CheckError()&&Log_1.Log.Error("Audio",42,"[Core.AudioSystem] 空的音频事件event参数"),exports.INVALID_AUDIO_EVENT_VALUE):this.h8.Enqueue(async e=>{var t=await this.l8(i,o,s);t&&(this._8.set(e,t),this.u8.set(t,e))})}static async l8(t,i,o={}){if(!t||t.length<1)Log_1.Log.CheckError()&&Log_1.Log.Error("Audio",42,"[Core.AudioSystem] 空的音频事件event参数");else{var s=await this.a8.GetAudioEvent(t);if(s){var{ExternalSourceName:n,ExternalSourceMediaName:r}=o,{CallbackMask:n=1,CallbackHandler:r}=(n&&r&&UE.WwiseExternalSourceStatics.SetExternalSourceMediaByName(n,r),o),n=1|n,r=this.c8(r);let e=void 0;if(void 0===i)e=s.PostOnActor(void 0,r,n,!1);else if(i instanceof UE.TransformDouble){var a=i.GetLocation(),u=i.GetRotation().Rotator();e=s.D_PostAtLocation(a,u,r,n,Info_1.Info.World)}else if(instanceOf(i,UE.Actor)){var{StopWhenOwnerDestroyed:a=!1}=o;e=s.PostOnActor(i,r,n,a)}else{if(!instanceOf(i,UE.AkComponent))return void(Log_1.Log.CheckWarn()&&Log_1.Log.Warn("Audio",56,"[Core.AudioSystem] PostEvent 执行失败",["Event",t],["Args",o],["Reason","目标对象无效"]));var{StopWhenOwnerDestroyed:u=!1}=o;e=s.PostOnComponent(i,r,n,u)}if(e!==INVALID_PLAYING_ID)return e;Log_1.Log.CheckError()&&Log_1.Log.Error("Audio",56,"[Core.AudioSystem] PostEvent 执行失败",["Event",t],["Target",void 0===i?"Global":i instanceof UE.TransformDouble?i.ToString():i.GetName()],["Args",o],["Reason","SoundEngine 内部异常"])}}}static c8(i){const o=(e,t)=>{i?.(e,t),0===e&&((0,puerts_1.releaseManualReleaseDelegate)(o),e=t.PlayingID,t=this.u8.get(e))&&(this.u8.delete(e),this._8.delete(t))};return(0,puerts_1.toManualReleaseDelegate)(o)}static ExecuteAction(...e){if("string"==typeof e[0]){const[o,s,n={}]=e;!o||o.length<1?Log_1.Log.CheckError()&&Log_1.Log.Error("Audio",42,"[Core.AudioSystem] 空的音频事件event参数"):this.h8.Enqueue(()=>{var{Actor:e,TransitionDuration:t,TransitionFadeCurve:i}=n;UE.KuroAudioStatics.ExecuteActionOnEventName(o,s,e,t,i)})}else{const[r,a,u={}]=e;0===a&&this.h8.Cancel(r)||this.h8.Enqueue(()=>{var e,t,i=this._8.get(r);i&&({TransitionDuration:e,TransitionFadeCurve:t}=u,UE.KuroAudioStatics.ExecuteActionOnPlayingId(i,a,e,t))})}}static SeekOnEvent(t,i,o={}){!t||t.length<1?Log_1.Log.CheckError()&&Log_1.Log.Error("Audio",42,"[Core.AudioSystem] 空的音频事件event参数"):this.h8.Enqueue(()=>{var e;void 0===o.Handle?UE.KuroAudioStatics.SeekOnEventName(t,i,o.Actor,void 0,o.SnapToMarker):(e=this._8.get(o.Handle))&&UE.KuroAudioStatics.SeekOnEventName(t,i,o.Actor,e,o.SnapToMarker)})}static GetSourcePlayPosition(e){var e=this._8.get(e);return!e||-1===(e=UE.KuroAudioStatics.GetSourcePlayPosition(e))?void 0:e}static SetSwitch(e,t,i){this.h8.Enqueue(()=>{UE.KuroAudioStatics.SetSwitch(e,t,i)})}static SetState(e,t){this.h8.Enqueue(()=>{UE.KuroAudioStatics.SetState(e,t)})}static SetRtpcValue(o,s,n={}){this.h8.Enqueue(()=>{var{Actor:e,TransitionDuration:t,TransitionFadeCurve:i}=n;UE.KuroAudioStatics.SetRtpcValue(o,s,e,t,i)})}static StopAll(e){this.h8.Enqueue(()=>{UE.KuroAudioStatics.StopAll(e)})}static GetAkComponent(e,t={}){var{SocketName:t,OnCreated:i}=t;let o=void 0;o="string"==typeof t?FNameUtil_1.FNameUtil.GetDynamicFName(0<t.length?t:"None"):t&&0<t.toString().length?t:FNameUtil_1.FNameUtil.GetDynamicFName("None");t=(0,puerts_1.$ref)(!1);let s=void 0;return instanceOf(e,UE.Actor)?s=UE.KuroAudioStatics.GetAkComponent(e.RootComponent,o,t):instanceOf(e,UE.SceneComponent)&&(s=UE.KuroAudioStatics.GetAkComponent(e,o,t)),(0,puerts_1.$unref)(t)&&(e=s?.GetOwner(),i)&&e&&s&&i(e,s),s}static PreloadAudioEvent(e){this.a8.PreloadAudioEvent(e)}static ReleaseAudioEvent(e){this.a8.ReleaseAudioEvent(e)}}(exports.AudioSystem=AudioSystem).a8=new AudioEventPool_1.AudioEventPool,AudioSystem.h8=new ExecutionQueue_1.ExecutionQueue,AudioSystem._8=new Map,AudioSystem.u8=new Map;
//# sourceMappingURL=AudioSystem.js.map