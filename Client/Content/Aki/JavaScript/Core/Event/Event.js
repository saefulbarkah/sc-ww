
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Event=void 0;const Log_1=require("../Common/Log"),Stats_1=require("../Common/Stats"),Macro_1=require("../Preprocessor/Macro");class Event{constructor(t){this.rK=t,this.nK=new Map,this.Djl=new Map,this.sK=void 0,this.aK=void 0,this.hK=new Array,this.unh=new Map}cnh(t,e,i,r){let s=r.get(t);s||(s=new Map,r.set(t,s)),s.set(i,e)}mnh(t,e,i){var r=i.get(t);r&&(r.delete(e),0===r.size)&&i.delete(t)}dnh(t,e,i){i=i.get(t);if(i)return i.get(e)}AddHoldKeyHandle(t,e,i){this.cnh(t,i,e,this.unh)}RemoveHoldKeyHandle(t,e){this.mnh(t,e,this.unh)}GetHoldKeyByHandle(t,e){return this.dnh(t,e,this.unh)}Has(t,e){var i,e=Event.lK.get(e);return!!e&&((i=this.nK.get(t))&&i.has(e)?!(i=this._K.get(t))||!i.has(e):void 0!==(i=this.uK.get(t))&&i.has(e))}Add(t,e){return this.YW(t,e,0)}Once(t,e){return this.YW(t,e,1)}Remove(t,e){e=Event.lK.get(e);return!!e&&this.O7(t,e)}ClearObject(t){var e=this.nK.get(t);if(e)for(const i of e.keys())this.O7(t,i);return!0}Emit(e,...i){if(this.cK(e))return Log_1.Log.CheckError()&&Log_1.Log.Error("Event",1,"事件重复派发，请检查事件链是否产生循环调用",["name",this.rK[e]],["emitting",this.hK]),!1;this.mK(e,!0);var r=this.nK.get(e);if(r){!Stats_1.Stat.Enable||(a=this.rK[e],Event.dK.get(a))||(h=Stats_1.Stat.CreateNoFlameGraph("Event."+this.rK[e]),Event.dK.set(a,h));let t=void 0;for(const o of r){var s=o[0],n=s.deref();if(n){if(!(t=t||this._K.get(e))||!t.has(s)){1===o[1]&&this.O7(e,s);Event.CK.get(n);try{n(...i)}catch(t){t instanceof Error?Log_1.Log.CheckError()&&Log_1.Log.ErrorWithStack("Event",1,"事件处理方法执行异常",t,["name",this.rK[e]],["error",t.message]):Log_1.Log.CheckError()&&Log_1.Log.Error("Event",1,"事件处理方法执行异常",["name",this.rK[e]],["error",t])}}}else Log_1.Log.CheckError()&&Log_1.Log.Error("Event",1,"事件处理方法已被回收",["eventName",this.rK[e]],["stack",void 0]),r.delete(s),0===r.size&&this.nK.delete(e)}}this.mK(e,!1);var a=this._K.get(e);if(a){for(const t of a.values())this.gK(e,t);a.clear(),this._K.delete(e)}var h=this.uK.get(e);if(h){for(const v of h)this.fK(e,v[0],v[1]);h.clear(),this.uK.delete(e)}return!0}YW(t,e,i){if(void 0===this.rK[t])return Log_1.Log.CheckError()&&Log_1.Log.Error("Event",1,"事件名不存在，请检查事件名是否正确",["name",t]),!1;let r=Event.lK.get(e);if(r||(r=new WeakRef(e),Event.lK.set(e,r)),Stats_1.Stat.Enable&&!Event.CK.has(e)&&(s=e.name,Event.CK.set(e,s&&0<s.length?Stats_1.Stat.CreateNoFlameGraph("EventHandle."+s):void 0)),!this.cK(t))return this.fK(t,r,i);var e=this.nK.get(t),s=this._K.get(t);if(e&&e.has(r))return s&&s.has(r)?(s.delete(r),!0):(Log_1.Log.CheckError()&&Log_1.Log.Error("Event",1,"事件已存在，请检查同一个事件名同一个处理函数的注册逻辑",["name",this.rK[t]]),!1);let n=this.uK.get(t);return n&&n.has(r)?(Log_1.Log.CheckError()&&Log_1.Log.Error("Event",1,"事件重复注册在待修改列表，请检查同一个事件名同一个处理函数的注册逻辑",["name",this.rK[t]]),!1):(n||(n=new Map,this.uK.set(t,n)),n.set(r,i),!0)}fK(t,e,i){let r=this.nK.get(t);if(r){if(r.has(e))return Log_1.Log.CheckError()&&Log_1.Log.Error("Event",1,"事件重复注册，请检查同一个事件名同一个处理函数的注册逻辑",["name",this.rK[t]]),!1}else r=new Map,this.nK.set(t,r);return r.set(e,i),!0}O7(t,e){if(!this.cK(t))return this.gK(t,e);var i=this.nK.get(t),r=this.uK.get(t);if(!i||!i.has(e))return r&&r.has(e)?(r.delete(e),!0):(Log_1.Log.CheckError()&&Log_1.Log.Error("Event",1,"事件不存在，请检查同一个事件名同一个处理函数的移除逻辑",["name",this.rK[t]]),!1);let s=this._K.get(t);return s&&s.has(e)?(Log_1.Log.CheckError()&&Log_1.Log.Error("Event",1,"事件重复移除在待移除列表，请检查同一个事件名同一个处理函数的移除逻辑",["name",this.rK[t]]),!1):(s||(s=new Set,this._K.set(t,s)),s.add(e),!0)}gK(t,e){var i=this.nK.get(t);return i&&i.delete(e)?(0===i.size&&this.nK.delete(t),!0):(Log_1.Log.CheckError()&&Log_1.Log.Error("Event",1,"事件不存在，请检查同一个事件名同一个处理函数的移除逻辑",["name",this.rK[t]]),!1)}cK(t){var e=Math.floor(t/32);return e<this.hK.length&&!!(this.hK[e]&1<<t%32)}mK(t,e){for(var i=Math.floor(t/32),t=t%32;this.hK.length<i;)this.hK.push(0);this.hK.length===i?this.hK.push(e?1<<t:0):e?this.hK[i]|=1<<t:this.hK[i]&=~(1<<t)}get uK(){return this.sK||(this.sK=new Map),this.sK}get _K(){return this.aK||(this.aK=new Map),this.aK}}(exports.Event=Event).lK=new WeakMap,Event.dK=new Map,Event.CK=new WeakMap;
//# sourceMappingURL=Event.js.map