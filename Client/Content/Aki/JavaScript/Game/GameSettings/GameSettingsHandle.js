
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.GameSettingsHandleForImageQuality=exports.GameSettingsHandleExtend=exports.GameSettingsHandle=void 0;const Info_1=require("../../Core/Common/Info"),Log_1=require("../../Core/Common/Log"),EventDefine_1=require("../Common/Event/EventDefine"),EventSystem_1=require("../Common/Event/EventSystem"),LocalStorage_1=require("../Common/LocalStorage"),ConfigManager_1=require("../Manager/ConfigManager"),MenuTool_1=require("../Module/Menu/MenuTool"),GameSettingsUtils_1=require("./GameSettingsUtils");class GameSettingsHandle{constructor(t){this.GameSettingId=void 0,this.CurrentValue=0,this.EditorValue=0,this.LocalStorageGlobalKey=void 0,this.IsSkipInitializeApply=!1,this.GetDefaultValueCallback=void 0,this.kNa=void 0,this.IsInitializeApplied=!1,this.NNa=void 0,this.HasLocalStorageValue=!1,this.OnCurrentValueChange=void 0,this.GameSettingId=t.GameSettingId,this.LocalStorageGlobalKey=t.LocalStorageGlobalKey,this.NNa=t.AllowPlatform,this.IsSkipInitializeApply=!0===t.IsSkipInitializeApply,this.GetDefaultValueCallback=t.GetDefaultValue,this.kNa=t.ApplyCallback}Load(){var t;return void 0===this.LocalStorageGlobalKey?(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("GameSettings",64,"加载游戏设置失败，原因：没有LocalStorageGlobalKey",["FunctionId",this.GameSettingId]),!1):void 0===(t=LocalStorage_1.LocalStorage.GetGlobal(this.LocalStorageGlobalKey))?(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("GameSettings",64,"加载游戏设置失败，原因：拿不到本地数据",["FunctionId",this.GameSettingId]),!1):(this.HasLocalStorageValue=!0,this.CurrentValue=Number(t),this.EditorValue=this.CurrentValue,Log_1.Log.CheckDebug()&&Log_1.Log.Debug("GameSettings",64,"加载游戏设置成功",["FunctionId",this.GameSettingId],["CurrentValue",this.CurrentValue]),!0)}Save(){return void 0!==this.LocalStorageGlobalKey&&(this.HasLocalStorageValue=!0,Log_1.Log.CheckDebug()&&Log_1.Log.Debug("GameSettings",64,"保存游戏设置成功",["FunctionId",this.GameSettingId],["EditorValue",this.EditorValue],["CurrentValue",this.CurrentValue]),LocalStorage_1.LocalStorage.SetGlobal(this.LocalStorageGlobalKey,this.CurrentValue))}SetApplySave(t){return this.Set(t),!!this.Apply()&&this.Save()}Set(t,e=!1){this.EditorValue=t,Log_1.Log.CheckDebug()&&Log_1.Log.Debug("GameSettings",64,"设定游戏设置成功",["FunctionId",this.GameSettingId],["value",t],["directly",e]),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnGameplaySettingsSet,this.GameSettingId,t,e)}RefreshCurrentValue(){this.CurrentValue!==this.EditorValue&&(this.CurrentValue=this.EditorValue,this.OnCurrentValueChange)&&this.OnCurrentValueChange(this.CurrentValue)}Apply(){return!!this.fMa(this.EditorValue)&&(this.RefreshCurrentValue(),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("GameSettings",64,"应用游戏设置成功",["FunctionId",this.GameSettingId],["CurrentValue",this.CurrentValue]),!0)}fMa(t){return!(!this.IsAllowPlatform()||this.kNa&&!this.kNa(t))}IsAllowPlatform(){var t;return!this.NNa||((t=this.NNa.has(Info_1.Info.PlatformType))||Log_1.Log.CheckDebug()&&Log_1.Log.Debug("GameSettings",64,"设置项不符合平台设定",["FunctionId",this.GameSettingId],["current PlatformType",Info_1.Info.PlatformType],["allowed PlatformType",this.NNa]),t)}InitializeApply(){var t;return!this.IsInitializeApplied&&(t=this.Apply(),this.IsInitializeApplied=!0,Log_1.Log.CheckDebug()&&Log_1.Log.Debug("GameSettings",64,"初始化应用游戏设置",["GameSettingId",this.GameSettingId],["bSuccess",t],["editor value",this.EditorValue],["current value",this.CurrentValue]),t)}ReApply(){return this.fMa(this.CurrentValue)}GetGameSettingId(){return this.GameSettingId}GetCurrentValue(){return this.CurrentValue}GetEditorValue(){return this.EditorValue}}class GameSettingsHandleExtend extends(exports.GameSettingsHandle=GameSettingsHandle){Load(){if(void 0===this.LocalStorageGlobalKey)return Log_1.Log.CheckError()&&Log_1.Log.Error("GameSettings",64,"加载【拓展】游戏设置失败，原因：没有LocalStorageGlobalKey",["FunctionId",this.GameSettingId]),!1;let t=LocalStorage_1.LocalStorage.GetGlobal(this.LocalStorageGlobalKey);if(void 0===t){Log_1.Log.CheckDebug()&&Log_1.Log.Debug("GameSettings",64,"加载【拓展】游戏设置失败，原因：拿不到本地数据。尝试拿取配置数据",["FunctionId",this.GameSettingId]);var e=ConfigManager_1.ConfigManager.MenuBaseConfig.GetMenuConfigListByFunctionId(this.GameSettingId);if(void 0===e)return Log_1.Log.CheckError()&&Log_1.Log.Error("GameSettings",64,"加载【拓展】游戏配置表数据失败",["FunctionId",this.GameSettingId]),!1;for(const i of e)if(MenuTool_1.MenuTool.CheckPlatform(i.Platform)){t=i.OptionsDefault;break}if(void 0===t)return Log_1.Log.CheckError()&&Log_1.Log.Error("GameSettings",64,"加载【拓展】游戏配置表数据失败，没有当前平台的数据",["FunctionId",this.GameSettingId]),!1}return this.HasLocalStorageValue=!0,this.CurrentValue=Number(t),this.EditorValue=this.CurrentValue,Log_1.Log.CheckDebug()&&Log_1.Log.Debug("GameSettings",64,"加载【拓展】游戏设置成功",["FunctionId",this.GameSettingId],["CurrentValue",this.CurrentValue]),!0}}exports.GameSettingsHandleExtend=GameSettingsHandleExtend;class GameSettingsHandleForImageQuality extends GameSettingsHandle{SetApplySaveWithAutoFlag(t){return!!this.IsAllowPlatform()&&!GameSettingsUtils_1.GameSettingsUtils.ApplyImageQualityWithAutoFlag(t,!0)&&(this.RefreshCurrentValue(),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("GameSettings",64,"应用游戏设置成功（带参）, autoFlag",["FunctionId",this.GameSettingId],["CurrentValue",this.CurrentValue]),this.Save())}}exports.GameSettingsHandleForImageQuality=GameSettingsHandleForImageQuality;
//# sourceMappingURL=GameSettingsHandle.js.map