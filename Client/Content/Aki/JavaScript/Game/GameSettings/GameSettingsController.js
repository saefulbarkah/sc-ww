
"use strict";var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.GameSettingsController=void 0;const UE=require("ue"),Info_1=require("../../Core/Common/Info"),Log_1=require("../../Core/Common/Log"),ControllerBase_1=require("../../Core/Framework/ControllerBase"),Macro_1=require("../../Core/Preprocessor/Macro"),TimerSystem_1=require("../../Core/Timer/TimerSystem"),LauncherGameSettingLib_1=require("../../Launcher/Util/LauncherGameSettingLib"),EventDefine_1=require("../Common/Event/EventDefine"),EventSystem_1=require("../Common/Event/EventSystem"),LocalStorage_1=require("../Common/LocalStorage"),LocalStorageDefine_1=require("../Common/LocalStorageDefine"),GlobalData_1=require("../GlobalData"),ConfigManager_1=require("../Manager/ConfigManager"),ModelManager_1=require("../Manager/ModelManager"),MenuTool_1=require("../Module/Menu/MenuTool"),GameSettingsDeviceRender_1=require("./GameSettingsDeviceRender"),GameSettingsDeviceRenderDefine_1=require("./GameSettingsDeviceRenderDefine"),GameSettingsLevelRender_1=require("./GameSettingsLevelRender"),GameSettingsManager_1=require("./GameSettingsManager"),GameSettingsUtils_1=require("./GameSettingsUtils");class GameSettingsController extends ControllerBase_1.ControllerBase{static OnInit(){return Log_1.Log.CheckInfo()&&Log_1.Log.Info("Render",41,"GameSettingsController-OnInit"),this.Ore(),!0}static OnClear(){return this.kre(),!0}static Ore(){EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnStartLoadingState,this.hMe),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.WorldDone,this._Me),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.ClearWorld,this.uMe),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnSubLevelAdded,this.J2a)}static kre(){EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnStartLoadingState,this.hMe),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.WorldDone,this._Me),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.ClearWorld,this.uMe),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnSubLevelAdded,this.J2a)}static kot(){this.IRe=TimerSystem_1.TimerSystem.Delay(this.q7e,GameSettingsDeviceRenderDefine_1.WHOLE_SHADOW_CACHE_DELAY_TIME)}static xHe(){this.IRe&&(TimerSystem_1.TimerSystem.Has(this.IRe)&&TimerSystem_1.TimerSystem.Remove(this.IRe),this.IRe=void 0)}static fGa(){if(LocalStorage_1.LocalStorage.GetGlobal(LocalStorageDefine_1.ELocalStorageGlobalKey.HasLocalGameSettings,!1)){Log_1.Log.CheckInfo()&&Log_1.Log.Info("GameSettings",8,"本地有游戏设置保存，还原本地游戏设置");var e=GameSettingsManager_1.GameSettingsManager.GetCurrentValue(10);if(!GameSettingsUtils_1.GameSettingsUtils.PreApplyImageQuality(e))return;for(const a of GameSettingsManager_1.GameSettingsManager.GetGameSettingsHandleMap().values())a.Load()&&(a.IsSkipInitializeApply?Log_1.Log.CheckInfo()&&Log_1.Log.Info("GameSettings",8,"初始化应用游戏设置 - 跳过此设置应用",["GameSettingId",a.GetGameSettingId()]):a.InitializeApply())}else{Log_1.Log.CheckInfo()&&Log_1.Log.Info("GameSettings",8,"首次启动游戏，应用默认游戏设置"),this.NJa=LocalStorage_1.LocalStorage.GetGlobal(LocalStorageDefine_1.ELocalStorageGlobalKey.GameQualitySetting);var t,e=LauncherGameSettingLib_1.LauncherGameSettingLib.LoadPlayMenuInfo();this.FJa=new Map,void 0!==this.NJa&&this.NJa.KeyQualityLevel<=3&&(Log_1.Log.CheckInfo()&&Log_1.Log.Info("GameSettings",64,"[设置系统]->存在老数据，进行兼容设置"),GameSettingsUtils_1.GameSettingsUtils.PreApplyImageQuality(this.NJa.KeyQualityLevel),t=LocalStorage_1.LocalStorage.GetGlobal(LocalStorageDefine_1.ELocalStorageGlobalKey.CameraShakeStrength),this.FJa.set(68,this.NJa.KeySuperResolution),this.FJa.set(5,this.NJa.KeyPcWindowMode),this.FJa.set(7,this.NJa.KeyBrightness),this.FJa.set(87,this.NJa.KeyFsrEnable),this.FJa.set(125,this.NJa.KeyXessEnable??1),this.FJa.set(126,this.NJa.KeyXessQuality??2),this.FJa.set(127,this.NJa.KeyMetalFxEnable),this.FJa.set(128,this.NJa.KeyIrxEnable??1),this.FJa.set(89,this.NJa.HorizontalViewSensitivity),this.FJa.set(90,this.NJa.VerticalViewSensitivity),this.FJa.set(91,this.NJa.AimHorizontalViewSensitivity),this.FJa.set(92,this.NJa.AimVerticalViewSensitivity),this.FJa.set(93,t),this.FJa.set(94,this.NJa.MobileHorizontalViewSensitivity),this.FJa.set(95,this.NJa.MobileVerticalViewSensitivity),this.FJa.set(96,this.NJa.MobileAimHorizontalViewSensitivity),this.FJa.set(97,this.NJa.MobileAimVerticalViewSensitivity),this.FJa.set(99,this.NJa.CommonSpringArmLength),this.FJa.set(100,this.NJa.FightSpringArmLength),this.FJa.set(101,this.NJa.IsResetFocusEnable),this.FJa.set(102,this.NJa.IsSidestepCameraEnable),this.FJa.set(103,this.NJa.IsSoftLockCameraEnable),this.FJa.set(104,this.NJa.JoystickShakeStrength),this.FJa.set(105,this.NJa.JoystickShakeType),this.FJa.set(108,this.NJa.JoystickMode),this.FJa.set(109,this.NJa.IsAutoSwitchSkillButtonMode),this.FJa.set(122,this.NJa.AimAssistEnable),this.FJa.set(130,this.NJa.HorizontalViewRevert),this.FJa.set(131,this.NJa.VerticalViewRevert),this.FJa.set(106,this.NJa.WalkOrRunRate)),void 0!==e&&(this.FJa.set(1,e?.get(1)),this.FJa.set(2,e?.get(2)),this.FJa.set(3,e?.get(3)),this.FJa.set(4,e?.get(4)),this.FJa.set(69,e?.get(69)),this.FJa.set(70,e?.get(70))),this.vGa(),this.MGa(),GameSettingsManager_1.GameSettingsManager.InitSetApplySave(129,1),GameSettingsManager_1.GameSettingsManager.InitSetApplySave(134,1)}LocalStorage_1.LocalStorage.SetGlobal(LocalStorageDefine_1.ELocalStorageGlobalKey.HasLocalGameSettings,!0)}static vGa(){Log_1.Log.CheckDebug()&&Log_1.Log.Debug("GameSettings",65,"InitializeApply[ImageQuality]");var e=this.NJa?.KeyQualityLevel??GameSettingsDeviceRender_1.GameSettingsDeviceRender.GameQualitySettingLevel,t=GameSettingsDeviceRender_1.GameSettingsDeviceRender.GetDeviceReaderFeatureData(e);if(t){var a=GameSettingsManager_1.GameSettingsManager.Get(10);if(a){if(a.Set(e,!0),!GameSettingsUtils_1.GameSettingsUtils.PreApplyImageQuality(e))return;a.IsInitializeApplied=!0,a.RefreshCurrentValue(),a.Save()}var a=Info_1.Info.IsPcOrGamepadPlatform(),i=GameSettingsManager_1.GameSettingsManager.Get(11)?.HasLocalStorageValue?GameSettingsDeviceRender_1.GameSettingsDeviceRender.GetFrameIndexByList(GameSettingsManager_1.GameSettingsManager.GetCurrentValue(11)):GameSettingsDeviceRender_1.GameSettingsDeviceRender.GetFrameIndexByList(t.FPS),n=(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("GameSettings",65,"[FPSDebug]InitializeApplyImageQuality",["fpsIndex",i],["feature FPS",t.FPS]),GameSettingsManager_1.GameSettingsManager.Get(54)?.HasLocalStorageValue?GameSettingsManager_1.GameSettingsManager.GetCurrentValue(54):this.NJa?.KeyNewShadowQuality??t.ShadowQuality),s=GameSettingsManager_1.GameSettingsManager.Get(55)?.HasLocalStorageValue?GameSettingsManager_1.GameSettingsManager.GetCurrentValue(55):this.NJa?.KeyNiagaraQuality??t.FxQuality,g=GameSettingsManager_1.GameSettingsManager.Get(56)?.HasLocalStorageValue?GameSettingsManager_1.GameSettingsManager.GetCurrentValue(56):this.NJa?.KeyImageDetail??t.ImageDetail,r=GameSettingsManager_1.GameSettingsManager.Get(57)?.HasLocalStorageValue?GameSettingsManager_1.GameSettingsManager.GetCurrentValue(57):this.NJa?.KeyAntiAliasing??t.AntiAliasing,o=GameSettingsManager_1.GameSettingsManager.Get(58)?.HasLocalStorageValue?GameSettingsManager_1.GameSettingsManager.GetCurrentValue(58):this.NJa?.KeySceneAo??t.AO,l=GameSettingsManager_1.GameSettingsManager.Get(63)?.HasLocalStorageValue?GameSettingsManager_1.GameSettingsManager.GetCurrentValue(63):this.NJa?.KeyVolumeFog??t.VolumeFog,_=GameSettingsManager_1.GameSettingsManager.Get(64)?.HasLocalStorageValue?GameSettingsManager_1.GameSettingsManager.GetCurrentValue(64):this.NJa?.KeyVolumeLight??t.VolumeLight,S=GameSettingsManager_1.GameSettingsManager.Get(65)?.HasLocalStorageValue?GameSettingsManager_1.GameSettingsManager.GetCurrentValue(65):this.NJa?.KeyMotionBlur,m=void 0===S?t.MotionBlur:0===S?0:2,S=(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("GameSettings",65,"[FPSDebug]InitializeApplyImageQuality",["oldMotionBlurValue",S],["cfgMotionBlurValue",t.MotionBlur],["motionBlur",m],["currentMotionBlur",GameSettingsManager_1.GameSettingsManager.GetCurrentValue(65)],["NewmotionBlur",LocalStorage_1.LocalStorage.GetGlobal(LocalStorageDefine_1.ELocalStorageGlobalKey.MotionBlur)]),GameSettingsManager_1.GameSettingsManager.Get(66)?.HasLocalStorageValue?GameSettingsManager_1.GameSettingsManager.GetCurrentValue(66):this.NJa?.KeyPcVsync??t.VSync),G=GameSettingsManager_1.GameSettingsManager.Get(67)?.HasLocalStorageValue?GameSettingsManager_1.GameSettingsManager.GetCurrentValue(67):this.NJa?.KeyMobileResolution??t.ScreenPercentage,h=GameSettingsManager_1.GameSettingsManager.Get(132)?.HasLocalStorageValue?GameSettingsManager_1.GameSettingsManager.GetCurrentValue(132):this.NJa?.KeyBloomEnable??t.Bloom,t=GameSettingsManager_1.GameSettingsManager.Get(79)?.HasLocalStorageValue?GameSettingsManager_1.GameSettingsManager.GetCurrentValue(79):this.NJa?.KeyNpcDensity??t.NpcDensity;GameSettingsManager_1.GameSettingsManager.InitSetApplySave(11,i),GameSettingsManager_1.GameSettingsManager.InitSetApplySave(54,n),GameSettingsManager_1.GameSettingsManager.InitSetApplySave(55,s),GameSettingsManager_1.GameSettingsManager.InitSetApplySave(56,g),GameSettingsManager_1.GameSettingsManager.InitSetApplySave(57,r),GameSettingsManager_1.GameSettingsManager.InitSetApplySave(58,o),GameSettingsUtils_1.GameSettingsUtils.ApplySceneLightQuality(e),GameSettingsManager_1.GameSettingsManager.InitSetApplySave(63,l),GameSettingsManager_1.GameSettingsManager.InitSetApplySave(64,_),GameSettingsManager_1.GameSettingsManager.InitSetApplySave(65,m),GameSettingsManager_1.GameSettingsManager.InitSetApplySave(67,G),GameSettingsManager_1.GameSettingsManager.InitSetApplySave(132,h),GameSettingsManager_1.GameSettingsManager.InitSetApplySave(79,t),a&&GameSettingsManager_1.GameSettingsManager.InitSetApplySave(66,S)}}static MGa(){Log_1.Log.CheckDebug()&&Log_1.Log.Debug("GameSettings",65,"InitializeApply[MenuConfig]");var e=ConfigManager_1.ConfigManager.MenuBaseConfig.GetMenuBaseConfig();if(e)for(const a of e)if(MenuTool_1.MenuTool.CheckPlatform(a.Platform)){var t=a.FunctionId;if(10===t)Log_1.Log.CheckDebug()&&Log_1.Log.Debug("GameSettings",65,"画质相关的已经在前面设置过了，不要在[InitializeApplyMenuConfig]再设置了");else{let e=0;switch(a.SetType){case 1:e=a.SliderDefault;break;case 2:case 4:e=a.OptionsDefault;break;default:e=0}Log_1.Log.CheckDebug()&&Log_1.Log.Debug("GameSettings",65,"最后一部的初始化设值",["gameSettingsId",t],["HasLocalStorageValue",GameSettingsManager_1.GameSettingsManager.Get(t)?.HasLocalStorageValue],["GetCurrentValue",GameSettingsManager_1.GameSettingsManager.GetCurrentValue(t)],["OldDataMigrationDataMap",this.FJa?.get(t)],["defaultValue",e]),e=GameSettingsManager_1.GameSettingsManager.Get(t)?.HasLocalStorageValue?GameSettingsManager_1.GameSettingsManager.GetCurrentValue(t):this.FJa?.get(t)??e,GameSettingsManager_1.GameSettingsManager.InitSetApplySave(t,e)}}}}exports.GameSettingsController=GameSettingsController,(_a=GameSettingsController).IRe=void 0,GameSettingsController.NJa=void 0,GameSettingsController.FJa=void 0,GameSettingsController.hMe=()=>{var e;GameSettingsManager_1.GameSettingsManager.IsGameSettingsAppliedOnOpenLoading?Log_1.Log.CheckInfo()&&Log_1.Log.Info("Render",8,"游戏设置已经初始化应用过"):(Log_1.Log.CheckInfo()&&Log_1.Log.Info("Render",41,"初始化-应用设置参数1111"),Info_1.Info.IsPcPlatform()&&(e=GameSettingsDeviceRender_1.GameSettingsDeviceRender.DeviceType,Log_1.Log.CheckInfo()&&Log_1.Log.Info("Render",41,"重新设置PC性能分级",["deviceType",e]),11===e?(UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.ViewDistanceQuality 0"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.AntiAliasingQuality 1"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.PostProcessQuality 0"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.TextureQuality 1"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.EffectsQuality 1"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.FoliageQuality 0"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"r.LandscapeReverseLODScaleFactor 2")):12===e?(UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.ViewDistanceQuality 1"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.AntiAliasingQuality 2"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.PostProcessQuality 1"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.TextureQuality 1"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.EffectsQuality 2"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.FoliageQuality 1"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"r.LandscapeReverseLODScaleFactor 1")):13===e?(UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.ViewDistanceQuality 2"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.AntiAliasingQuality 2"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.PostProcessQuality 2"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.TextureQuality 2"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.EffectsQuality 3"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.FoliageQuality 2"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"r.CapsuleKuroAO 1"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"r.LandscapeReverseLODScaleFactor 0")):14===e&&(UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.ViewDistanceQuality 3"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.AntiAliasingQuality 3"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.PostProcessQuality 3"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.TextureQuality 3"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.EffectsQuality 3"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"sg.FoliageQuality 3"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"r.CapsuleKuroAO 1"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"r.LandscapeReverseLODScaleFactor 0"))),_a.fGa(),GameSettingsManager_1.GameSettingsManager.ConvertLocalMenuData(),GameSettingsUtils_1.GameSettingsUtils.CheckLocalCustomImageQuality(),GameSettingsManager_1.GameSettingsManager.ConvertViewSensitivity(),GameSettingsDeviceRender_1.GameSettingsDeviceRender.CancelAllPerformanceLimit(),GameSettingsManager_1.GameSettingsManager.IsGameSettingsAppliedOnOpenLoading=!0)},GameSettingsController._Me=()=>{ModelManager_1.ModelManager.GameModeModel.UseWorldPartition?(Log_1.Log.CheckInfo()&&Log_1.Log.Info("Render",60,"进入大世界-调整渲染参数"),Info_1.Info.IsPcOrGamepadPlatform()||(UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"r.Mobile.EnableKuroSpotlightsShadow 0"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"r.FogVisibilityCulling.Enable 1")),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"r.Shadow.CacheWholeSceneShadows 1"),_a.xHe()):(Log_1.Log.CheckInfo()&&Log_1.Log.Info("Render",60,"进入副本-调整渲染参数"),Info_1.Info.IsPcOrGamepadPlatform()||(UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"r.Mobile.EnableKuroSpotlightsShadow 1"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"r.FogVisibilityCulling.Enable 0")),GameSettingsLevelRender_1.GameSettingsLevelRender.Get().SetLevelRenderSettings(),UE.LandscapeProxy.SetKuroLandscapeFOVFactor(0),_a.xHe(),_a.kot());var e=GameSettingsManager_1.GameSettingsManager.Get(58);e&&e.Apply()},GameSettingsController.uMe=()=>{ModelManager_1.ModelManager.GameModeModel.UseWorldPartition||(Log_1.Log.CheckInfo()&&Log_1.Log.Info("Render",60,"退出副本-调整渲染参数"),GameSettingsLevelRender_1.GameSettingsLevelRender.Get().RevertLevelRenderSetting(),UE.LandscapeProxy.SetKuroLandscapeFOVFactor(-1),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"r.Shadow.CacheWholeSceneShadows 1"),_a.xHe())},GameSettingsController.J2a=()=>{UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"r.Shadow.CacheWholeSceneShadows 0"),_a.xHe(),_a.kot()},GameSettingsController.q7e=()=>{_a.IRe=void 0,UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"r.Shadow.CacheWholeSceneShadows 1")},GameSettingsController.OnGameUserSettingsUINeedsUpdate=()=>{TimerSystem_1.TimerSystem.Next(_a.OnUEGameUserSettingsUpdate)},GameSettingsController.OnUEGameUserSettingsUpdate=()=>{var e=UE.GameUserSettings.GetGameUserSettings(),t=2===e.GetFullscreenMode()?1:0,t=(GameSettingsManager_1.GameSettingsManager.GetEditValue(5)!==t&&(GameSettingsManager_1.GameSettingsManager.Set(5,t),GameSettingsManager_1.GameSettingsManager.RefreshCurrentValue(5),GameSettingsManager_1.GameSettingsManager.Save(5)),GameSettingsManager_1.GameSettingsManager.GetEditValue(6)),e=GameSettingsDeviceRender_1.GameSettingsDeviceRender.GetResolutionIndexByList(e.GetScreenResolution());t!==e&&(GameSettingsManager_1.GameSettingsManager.Set(6,e),GameSettingsManager_1.GameSettingsManager.RefreshCurrentValue(6),GameSettingsManager_1.GameSettingsManager.Save(6))};
//# sourceMappingURL=GameSettingsController.js.map