
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.LocalStorage=void 0;const puerts_1=require("puerts"),UE=require("ue"),Info_1=require("../../Core/Common/Info"),Log_1=require("../../Core/Common/Log"),Stats_1=require("../../Core/Common/Stats"),GlobalData_1=require("../GlobalData"),EventDefine_1=require("./Event/EventDefine"),EventSystem_1=require("./Event/EventSystem"),LocalStorageCache_1=require("./LocalStorageCache"),LocalStorageDefine_1=require("./LocalStorageDefine"),DBPATH="LocalStorage/LocalStorage",DEVICEDBPATH="DeviceSaved/DeviceStorage",DBSUFFIX=".db",TABLENAME="LocalStorage",DBNUM=10,ISUSEDB=!0,USE_THREAD=!0,USE_CACHE=!0,SQLITE_ERR=-1,SQLITE_NO_DATA=1,CHECK_COMPLEX_THRESHOLD=600,USE_JOURNAL_MODE=2;function getJournalMode(e){switch(e){case 0:return"PRAGMA journal_mode=DELETE";case 1:return"PRAGMA journal_mode=TRUNCATE";case 2:return"PRAGMA journal_mode=PERSIST";case 3:return"PRAGMA journal_mode=MEMORY";case 4:return"PRAGMA journal_mode=OFF"}}class LocalStorage{static Initialize(){this.IC||(this.IC=!0,ISUSEDB&&(LocalStorage.cde(),LocalStorage.mde()),LocalStorage.dde())}static Destroy(){LocalStorage.j8=void 0,LocalStorage.ve.Clear(),LocalStorage.Cde()}static GetGlobal(e,a=void 0){if(this.IC){var t=LocalStorage.gde(e);if(t){if(USE_CACHE){var o=LocalStorage.Mgc(t);if(o)return LocalStorage.pde(o)}var r,o=LocalStorage.fde(t,!1);if(o[0])return(o=o[1])?(r=LocalStorage.pde(o),USE_CACHE&&LocalStorage.Egc(t,o),r):a}}else Log_1.Log.CheckError()&&Log_1.Log.Error("LocalStorage",16,"GetGlobal LocalStorage未初始化",["key",e])}static SetGlobal(e,a){if(!this.IC)return Log_1.Log.CheckError()&&Log_1.Log.Error("LocalStorage",16,"GetGlobal LocalStorage未初始化",["key",e]),!1;var t=LocalStorage.gde(e);if(!t)return!1;if(null==a)return Log_1.Log.CheckError()&&Log_1.Log.Error("LocalStorage",30,"value值非法",["keyName",t],["value",a]),!1;a=LocalStorage.O8(a);if(!a)return!1;if(USE_CACHE){if(LocalStorage.Mgc(t)===a)return!0;LocalStorage.Egc(t,a)}return LocalStorage.ugl(e,t,a),LocalStorage.vde(t,a,!1)}static DeleteGlobal(e){e=LocalStorage.gde(e);return!!e&&LocalStorage.Mde(e,!1)}static GetDeviceSaved(e,a=void 0){e=LocalStorage.O4l(e);if(e){if(USE_CACHE){var t=LocalStorage.Mgc(e);if(t)return LocalStorage.pde(t)}var o,t=LocalStorage.fde(e,!0);if(t[0])return(t=t[1])?(o=LocalStorage.pde(t),USE_CACHE&&LocalStorage.Egc(e,t),o):a}}static SetDeviceSaved(e,a){var t=LocalStorage.O4l(e);if(!t)return!1;if(null==a)return Log_1.Log.CheckError()&&Log_1.Log.Error("LocalStorage",30,"value值非法",["keyName",t],["value",a]),!1;a=LocalStorage.O8(a);if(!a)return!1;if(USE_CACHE){if(LocalStorage.Mgc(t)===a)return!0;LocalStorage.Egc(t,a)}return LocalStorage.ugl(e,t,a),LocalStorage.vde(t,a,!0)}static DeleteDeviceSaved(e){e=LocalStorage.O4l(e);return!!e&&LocalStorage.Mde(e,!0)}static GetPlayer(e,a=void 0){e=LocalStorage.Ede(e);if(e){if(USE_CACHE){var t=LocalStorage.Mgc(e);if(t)return LocalStorage.pde(t)}var o,t=LocalStorage.fde(e,!1);if(t[0])return(t=t[1])?(o=LocalStorage.pde(t),USE_CACHE&&LocalStorage.Egc(e,t),o):a}}static SetPlayer(e,a){var t=LocalStorage.Ede(e);if(!t)return!1;if(null==a)return Log_1.Log.CheckError()&&Log_1.Log.Error("LocalStorage",30,"value值非法",["keyName",t],["value",a]),!1;a=LocalStorage.O8(a);if(!a)return!1;if(USE_CACHE){if(LocalStorage.Mgc(t)===a)return!0;LocalStorage.Egc(t,a)}return LocalStorage.ugl(e,t,a),LocalStorage.vde(t,a,!1)}static DeletePlayer(e){e=LocalStorage.Ede(e);return!!e&&LocalStorage.Mde(e,!1)}static cde(){var e;LocalStorage.Sde||(e=UE.KuroLauncherLibrary.GameSavedDir(),LocalStorage.Sde=e+DBPATH+DBSUFFIX,LocalStorage.F4l=e+DEVICEDBPATH+DBSUFFIX)}static mde(){this.yde.Start();let a=LocalStorage.Sde,t=UE.KuroSqliteLibrary.OpenCreateDB(a,USE_THREAD);if(!t){Log_1.Log.CheckError()&&Log_1.Log.Error("LocalStorage",30,"打开DB失败！",["dbFilePath",a]);for(let e=2;e<=DBNUM;e++){var o=UE.KuroLauncherLibrary.GameSavedDir();if(a=o+DBPATH+e+DBSUFFIX,t=UE.KuroSqliteLibrary.OpenCreateDB(a,USE_THREAD)){LocalStorage.Sde=a;break}}if(!t)return Log_1.Log.CheckError()&&Log_1.Log.Error("LocalStorage",30,"创建10次DB都失败！",["dbFilePath",a]),this.yde.Stop(),!1}UE.KuroSqliteLibrary.Execute(a,getJournalMode(USE_JOURNAL_MODE));let r=LocalStorage.F4l;if(!(t=UE.KuroSqliteLibrary.OpenCreateDB(r,USE_THREAD))){Log_1.Log.CheckError()&&Log_1.Log.Error("LocalStorage",2,"打开DB失败！",["deviceDbPath",r]);for(let e=2;e<=DBNUM;e++){var _=UE.KuroLauncherLibrary.GameSavedDir();if(r=_+DEVICEDBPATH+e+DBSUFFIX,t=UE.KuroSqliteLibrary.OpenCreateDB(r,USE_THREAD)){LocalStorage.F4l=r;break}}if(!t)return Log_1.Log.CheckError()&&Log_1.Log.Error("LocalStorage",2,"创建10次DB都失败！",["deviceDbPath",r]),this.yde.Stop(),!1}return UE.KuroSqliteLibrary.Execute(r,getJournalMode(USE_JOURNAL_MODE)),t=LocalStorage.Ide(),this.yde.Stop(),t}static Ide(){this.Tde.Start();var e=LocalStorage.Sde,a=`create table if not exists ${TABLENAME}(key text primary key not null , value text not null)`,e=(UE.KuroSqliteLibrary.Execute(e,a)||Log_1.Log.CheckError()&&Log_1.Log.Error("LocalStorage",30,"创建DbTable失败！",["command",a]),LocalStorage.F4l);return(e=UE.KuroSqliteLibrary.Execute(e,a))||Log_1.Log.CheckError()&&Log_1.Log.Error("LocalStorage",2,"创建DeviceDbTable失败！",["command",a]),this.Tde.Stop(),e}static fde(e,a){if(!ISUSEDB){const o=UE.KuroRenderingRuntimeBPPluginBPLibrary.GetString(GlobalData_1.GlobalData.World,e,"");return[!0,o]}var a=a?LocalStorage.F4l:LocalStorage.Sde,e=`SELECT value FROM ${TABLENAME} WHERE key ='${e}'`,t=(0,puerts_1.$ref)(void 0),a=UE.KuroSqliteLibrary.QueryValue(a,e,t);if(a===SQLITE_ERR)return[!1,void 0];if(a===SQLITE_NO_DATA)return[!0,void 0];const o=(0,puerts_1.$unref)(t);return[!0,o]}static vde(e,a,t){var o;return ISUSEDB?(t=t?LocalStorage.F4l:LocalStorage.Sde,o=`insert into ${TABLENAME} (key,value) values('${e}' , '${a}') on CONFLICT(key) do update set value = '${a}'`,USE_THREAD?(UE.KuroSqliteLibrary.ExecuteAsync(t,o),!0):UE.KuroSqliteLibrary.Execute(t,o)):(UE.KuroRenderingRuntimeBPPluginBPLibrary.SetString(GlobalData_1.GlobalData.World,e,a),UE.KuroRenderingRuntimeBPPluginBPLibrary.Save(GlobalData_1.GlobalData.World),!0)}static Mgc(e){return LocalStorage.ve.Get(e)}static Egc(e,a){LocalStorage.ve.Set(e,a)}static Mde(e,a){return!ISUSEDB||(a=a?LocalStorage.F4l:LocalStorage.Sde,e=`delete from ${TABLENAME} where key = '${e}'`,USE_THREAD?(UE.KuroSqliteLibrary.ExecuteAsync(a,e),!0):UE.KuroSqliteLibrary.Execute(a,e))}static dde(){EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.ChangePlayerInfoId,this.Lde)}static Cde(){EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.ChangePlayerInfoId,this.Lde)}static gde(e){if(null==e)Log_1.Log.CheckError()&&Log_1.Log.Error("LocalStorage",30,"key值非法",["key",e]);else{var a=LocalStorageDefine_1.ELocalStorageGlobalKey[e];if(a)return a;Log_1.Log.CheckError()&&Log_1.Log.Error("LocalStorage",30,"keyName值非法",["key",e])}}static O4l(e){if(null==e)Log_1.Log.CheckError()&&Log_1.Log.Error("LocalStorage",30,"key值非法",["key",e]);else{var a=LocalStorageDefine_1.ELocalStorageDeviceKey[e];if(a)return a;Log_1.Log.CheckError()&&Log_1.Log.Error("LocalStorage",30,"keyName值非法",["key",e])}}static Ede(e){if(null==e)Log_1.Log.CheckError()&&Log_1.Log.Error("LocalStorage",30,"key值非法",["key",e]);else{var a=LocalStorageDefine_1.ELocalStoragePlayerKey[e];if(a){if(LocalStorage.j8)return a+"_"+LocalStorage.j8;Log_1.Log.CheckError()&&Log_1.Log.Error("LocalStorage",30,"尚未获取到playerId，无法操作Player相关的存储值！",["keyName",a])}else Log_1.Log.CheckError()&&Log_1.Log.Error("LocalStorage",30,"keyName值非法！",["key",e],["keyName",a])}}static ugl(e,a,t){LocalStorage.cgl.has(e)||Info_1.Info.IsBuildShipping||(t?.length??0)>=CHECK_COMPLEX_THRESHOLD&&Log_1.Log.CheckWarn()&&Log_1.Log.Warn("LocalStorage",63,"[存储对象复杂度检查]->存储对象疑似属性过多,请考虑拆分对象",["storageKey",e],["keyName",a],["encodedValue",t])}static O8(a){try{return JSON.stringify(a,LocalStorage.Dde)}catch(e){e instanceof Error?Log_1.Log.CheckError()&&Log_1.Log.ErrorWithStack("LocalStorage",30,"序列化异常",e,["value",a],["error",e.message]):Log_1.Log.CheckError()&&Log_1.Log.Error("LocalStorage",30,"序列化异常",["value",a],["error",e])}}static pde(a){try{return JSON.parse(a,LocalStorage.Rde)}catch(e){e instanceof Error?Log_1.Log.CheckError()&&Log_1.Log.ErrorWithStack("LocalStorage",30,"反序列化异常",e,["text",a],["error",e.message]):Log_1.Log.CheckError()&&Log_1.Log.Error("LocalStorage",30,"反序列化异常",["text",a],["error",e])}}}(exports.LocalStorage=LocalStorage).Sde=void 0,LocalStorage.F4l=void 0,LocalStorage.j8=void 0,LocalStorage.ve=new LocalStorageCache_1.LocalStorageCache,LocalStorage.IC=!1,LocalStorage.yde=Stats_1.Stat.Create("LocalStorage_OpenOrCreateDb"),LocalStorage.Tde=Stats_1.Stat.Create("LocalStorage_CreateTable"),LocalStorage.Lde=e=>{LocalStorage.j8=e,EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.LocalStorageInitPlayerId)},LocalStorage.cgl=new Set([LocalStorageDefine_1.ELocalStorageGlobalKey.PlayMenuInfo,LocalStorageDefine_1.ELocalStorageGlobalKey.MenuData,LocalStorageDefine_1.ELocalStorageGlobalKey.CombineAction,LocalStorageDefine_1.ELocalStoragePlayerKey.GetItemConfigListSaveKey]),LocalStorage.Dde=(e,a)=>{if(void 0===a)return"___undefined___";if(Number.isNaN(a))return"___NaN___";if(a===1/0)return"___Infinity___";if(a===-1/0)return"___-Infinity___";if(null===a)return null;switch(typeof a){case"boolean":return a?"___1B___":"___0B___";case"bigint":return a+"___BI___";case"object":return a instanceof Map?{___MetaType___:"___Map___",Content:Array.from(a.entries())}:a instanceof Set?{___MetaType___:"___Set___",Content:Array.from(a.values())}:a;default:return a}},LocalStorage.Rde=(e,a)=>{if(null==a)return a;switch(typeof a){case"string":switch(a){case"___undefined___":return;case"___NaN___":return NaN;case"___Infinity___":return 1/0;case"___-Infinity___":return-1/0;default:{let e=a;if("___1B___"===e)return!0;if("___0B___"===e)return!1;if(e.endsWith("___BI___"))return e=e.replace("___BI___",""),BigInt(e)}return a}case"object":var t=a;if(t?.___MetaType___){if("___Map___"===t.___MetaType___)return new Map(t.Content);if("___Set___"===t.___MetaType___)return new Set(t.Content)}return a;default:return a}};
//# sourceMappingURL=LocalStorage.js.map