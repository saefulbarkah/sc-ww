
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const UE=require("ue"),Log_1=require("../../Core/Common/Log"),MathUtils_1=require("../../Core/Utils/MathUtils"),TsBaseCharacter_1=require("../Character/TsBaseCharacter"),CharacterNameDefines_1=require("../NewWorld/Character/Common/CharacterNameDefines"),GravityUtils_1=require("../Utils/GravityUtils");class TurningParams{constructor(t){this.NeedTurn=!1,this.AddRate=0,this.TotalTime=0,this.StartAngle=0,this.EndAngle=0,this.PreFrameAngle=0,this.IsInit=!1,this.IsRootMotionValid=!1,this.TotalTime=t}CalcTurningRate(t,i,e){var r=t.Entity.GetComponent(166),r=(this.EndAngle=r.MainAnimInstance.GetMainAnimsCurveValueWithDelta(CharacterNameDefines_1.CharacterNameDefines.ROOT_LOOK,this.TotalTime-i),this.StartAngle=r.MainAnimInstance.GetMainAnimsCurveValueWithDelta(CharacterNameDefines_1.CharacterNameDefines.ROOT_LOOK,-e),Log_1.Log.CheckInfo()&&Log_1.Log.Info("Test",6,"TurnAdd 1058338",["EntityId",t.Entity.Id],["endAngle",this.EndAngle],["startTime",i],["startAngle",this.StartAngle]),this.EndAngle-this.StartAngle);MathUtils_1.MathUtils.IsNearlyZero(r)||(e=MathUtils_1.MathUtils.WrapAngle(GravityUtils_1.GravityUtils.GetAngleOffsetFromCurrentToInput(t))-(this.IsRootMotionValid?r:0),this.AddRate=e/r,this.NeedTurn=!0,this.PreFrameAngle=this.StartAngle,this.IsInit=!0,Log_1.Log.CheckInfo()&&Log_1.Log.Info("Test",6,"TurnAdd 1058338",["EntityId",t.Entity.Id],["needAddAngle",e],["Current",t.ActorForwardProxy],["Input",t.InputFacingProxy]))}}class TsAnimNotifyStateTurnAdd extends UE.KuroAnimNotifyState{Constructor(){}K2_NotifyBegin(t,i,e){t=t.GetOwner();if(!(t instanceof TsBaseCharacter_1.default))return!1;var r=t.CharacterActorComponent;if(!r?.Valid)return!1;if(r.GetSequenceBinding())return!1;if(!r.IsMoveAutonomousProxy)return!1;TsAnimNotifyStateTurnAdd.Initialize();e=new TurningParams(e),e.IsRootMotionValid=!r.Actor.GetAttachParentActor()?.IsValid(),TsAnimNotifyStateTurnAdd.CachedMap.set(t,e),t=r.Entity.GetComponent(170);return t&&(t.IsTurning=!0),!0}K2_NotifyTick(t,i,e){var r,n,s,t=t.GetOwner();return t instanceof TsBaseCharacter_1.default&&!(!(r=t.CharacterActorComponent)?.Valid||r.GetSequenceBinding()||!r.IsMoveAutonomousProxy||!(n=r.Entity.GetComponent(166))?.Valid||!(t=TsAnimNotifyStateTurnAdd.CachedMap.get(t))||(t.IsInit||t.CalcTurningRate(r,this.CurrentTimeLength,e),!t.NeedTurn)||(e=t.AddRate,n=n.MainAnimInstance.GetMainAnimsCurveValueWithDelta(CharacterNameDefines_1.CharacterNameDefines.ROOT_LOOK,0),s=t.PreFrameAngle,TsAnimNotifyStateTurnAdd.TmpRotator.Yaw=e*(n-s),r.AddActorLocalRotation(TsAnimNotifyStateTurnAdd.TmpRotator,"TsAnimNotifyStateTurnAdd",!1),t.PreFrameAngle=n,0))}K2_NotifyEnd(t,i){t=t.GetOwner();if(!(t instanceof TsBaseCharacter_1.default))return!1;var e=t.CharacterActorComponent;if(!e?.Valid)return!1;if(e.GetSequenceBinding())return!1;if(!e.IsMoveAutonomousProxy)return!1;TsAnimNotifyStateTurnAdd.CachedMap?.delete(t);t=e.Entity.GetComponent(170);return t&&(t.IsTurning=!1),Log_1.Log.CheckInfo()&&Log_1.Log.Info("Test",6,"TurnAdd End",["EntityId",e.Entity.Id],["Current",e.ActorForwardProxy],["Input",e.InputFacingProxy]),!0}GetNotifyName(){return"根据RootLook曲线控制角色转向"}static Initialize(){TsAnimNotifyStateTurnAdd.IsInit||(TsAnimNotifyStateTurnAdd.CachedMap=new Map,TsAnimNotifyStateTurnAdd.TmpRotator=new UE.Rotator(0,0,0),TsAnimNotifyStateTurnAdd.IsInit=!0)}}TsAnimNotifyStateTurnAdd.IsInit=!1,TsAnimNotifyStateTurnAdd.CachedMap=void 0,TsAnimNotifyStateTurnAdd.TmpRotator=void 0,exports.default=TsAnimNotifyStateTurnAdd;
//# sourceMappingURL=TsAnimNotifyStateTurnAdd.js.map