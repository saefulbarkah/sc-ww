
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const UE=require("ue"),EntitySystem_1=require("../../Core/Entity/EntitySystem"),Vector_1=require("../../Core/Utils/Math/Vector"),TsBaseCharacter_1=require("../Character/TsBaseCharacter"),BlackboardController_1=require("../World/Controller/BlackboardController");class AddLocationBlackboardParams{constructor(){this.TotalDuration=-0,this.AddOffset=Vector_1.Vector.Create(),this.RunTime=-0}}const paramsPool=new Array,paramsMaps=new Map,tmpVector=Vector_1.Vector.Create();class TsAnimNotifyStateAddLocationBlackboard extends UE.KuroAnimNotifyState{constructor(){super(...arguments),this.AddLocationKey="",this.Curve=void 0,this.NeedChangeToFlying=!1,this.黑板类型=0}Constructor(){}K2_NotifyBegin(r,t,a){var e=r.GetOwner();if(!(e instanceof TsBaseCharacter_1.default))return!1;var o=e.CharacterActorComponent.Entity.Id;if(!this.AddLocationKey)return!1;let s=paramsMaps.get(this.AddLocationKey);s||(s=new Map,paramsMaps.set(this.AddLocationKey,s));var i=0<paramsPool.length?paramsPool.pop():new AddLocationBlackboardParams;switch(i.TotalDuration=a,i.RunTime=0,this.黑板类型){case 0:var n=BlackboardController_1.BlackboardController.GetVectorValueByEntity(o,this.AddLocationKey);if(!n)return!1;i.AddOffset.FromUeVector(n);break;case 1:n=BlackboardController_1.BlackboardController.GetVectorValueByEntity(o,this.AddLocationKey);if(!n)return!1;i.AddOffset.FromUeVector(n),i.AddOffset.SubtractionEqual(e.CharacterActorComponent.ActorLocationProxy);break;case 2:case 3:{let r=void 0;if(!(r=2===this.黑板类型?BlackboardController_1.BlackboardController.GetEntityIdByEntity(o,this.AddLocationKey):BlackboardController_1.BlackboardController.GetIntValueByEntity(o,this.AddLocationKey)))return!1;n=EntitySystem_1.EntitySystem.Get(r);if(!n?.Valid)return!1;n=n.GetComponent(1);i.AddOffset.DeepCopy(n.ActorLocationProxy),i.AddOffset.SubtractionEqual(e.CharacterActorComponent.ActorLocationProxy);break}default:return!1}return s.set(o,i),this.NeedChangeToFlying&&e.KuroSetMovementMode({Mode:5,Context:"[TsAnimNotifyStateAddLocationBlackboard.K2_NotifyBegin]"}),!0}K2_NotifyTick(t,r,a){t=t.GetOwner();if(!(t instanceof TsBaseCharacter_1.default))return!1;var t=t.CharacterActorComponent.Entity,e=t.Id,o=paramsMaps.get(this.AddLocationKey);if(!o)return!1;o=o.get(e);if(!o)return!1;if(!(o.RunTime>=o.TotalDuration)){e=Math.min(o.TotalDuration,o.RunTime+a);let r=0;r=this.Curve?this.Curve.GetFloatValue(e/o.TotalDuration)-this.Curve.GetFloatValue(o.RunTime/o.TotalDuration):(e-o.RunTime)/o.TotalDuration;t=t.GetComponent(173);o.AddOffset.Multiply(r,tmpVector),t.MoveCharacter(tmpVector,a),o.RunTime=e}return!0}K2_NotifyEnd(r,t){var a,e,r=r.GetOwner();return r instanceof TsBaseCharacter_1.default&&!!(a=paramsMaps.get(this.AddLocationKey))&&(r=r.CharacterActorComponent.Entity.Id,(e=a.get(r))&&(paramsPool.push(e),a.delete(r)),!0)}GetNotifyName(){return"黑板位置设置角色位置偏移"}}exports.default=TsAnimNotifyStateAddLocationBlackboard;
//# sourceMappingURL=TsAnimNotifyStateAddLocationBlackboard.js.map