
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.LevelEventClientSetPlayerPos=void 0;const UE=require("ue"),Log_1=require("../../../Core/Common/Log"),Protocol_1=require("../../../Core/Define/Net/Protocol"),EntitySystem_1=require("../../../Core/Entity/EntitySystem"),TimerSystem_1=require("../../../Core/Timer/TimerSystem"),Rotator_1=require("../../../Core/Utils/Math/Rotator"),Vector_1=require("../../../Core/Utils/Math/Vector"),MathUtils_1=require("../../../Core/Utils/MathUtils"),IAction_1=require("../../../UniverseEditor/Interface/IAction"),Global_1=require("../../Global"),GlobalData_1=require("../../GlobalData"),ModelManager_1=require("../../Manager/ModelManager"),TeleportController_1=require("../../Module/Teleport/TeleportController"),TeleportDefine_1=require("../../Module/Teleport/TeleportDefine"),LevelGeneralBase_1=require("../LevelGeneralBase"),LevelGeneralContextDefine_1=require("../LevelGeneralContextDefine"),LevelGeneralNetworks_1=require("../LevelGeneralNetworks");class LevelEventClientSetPlayerPos extends LevelGeneralBase_1.LevelEventBase{constructor(){super(...arguments),this.OPt=void 0,this.hpl=!1,this.yJi=0,this._pl=e=>{var t,r,o,l,i,a,n,s;this.OPt&&Global_1.Global.BaseCharacter?.IsValid()&&(a=ModelManager_1.ModelManager.CreatureModel.GetCompleteEntityData(this.OPt.TelePortConfig.SourcePosEntityId),r=ModelManager_1.ModelManager.CreatureModel.GetCompleteEntityData(this.OPt.TelePortConfig.TargetPosEntityId),a)&&r&&(l=Global_1.Global.BaseCharacter.CharacterActorComponent,(t=Rotator_1.Rotator.Create()).Set(a.Transform.Rot?.X??0,a.Transform.Rot?.Y??0,a.Transform.Rot?.Z??0),(i=Vector_1.Vector.Create()).Set(a.Transform.Pos.X,a.Transform.Pos.Y,a.Transform.Pos.Z),(a=Rotator_1.Rotator.Create()).Set(r.Transform.Rot?.X??0,r.Transform.Rot?.Y??0,r.Transform.Rot?.Z??0),(s=Vector_1.Vector.Create()).Set(r.Transform.Pos.X,r.Transform.Pos.Y,r.Transform.Pos.Z),r=a.Yaw-t.Yaw,a=Rotator_1.Rotator.Create(0,r,0),r=MathUtils_1.MathUtils.WrapAngle(l.ActorRotationProxy.Yaw+r),o=Rotator_1.Rotator.Create(0,r,0),n=Vector_1.Vector.Create(),l.ActorLocationProxy.Subtraction(i,n),l=Vector_1.Vector.Create(),a.Quaternion().RotateVector(n,l),i=Vector_1.Vector.Create(),s.Addition(l,i),(a=Global_1.Global.BaseCharacter.CharacterActorComponent?.Entity.GetComponent(66))&&(a.CollectSampleAndSend(!0),n=a.GetEnableMovementSync(),this.hpl=n)&&a.SetEnableMovementSync(!1),this.upl(i,o,e))?(Log_1.Log.CheckInfo()&&Log_1.Log.Info("LevelEvent",50,"开始客户端传送",["开始位置",Global_1.Global.BaseCharacter.CharacterActorComponent?.ActorLocationProxy],["目标位置",i],["开始角度",t.Yaw],["目标角度",r],["原因","ClientSetPlayerPos"]),TeleportController_1.TeleportController.QueryCanTeleportNoLoading(i.ToUeVector())?(ModelManager_1.ModelManager.TeleportModel.TeleportMode=4,TeleportController_1.TeleportController.TeleportToPositionNoLoading(i.ToUeVector(),o.ToUeRotator(),"ClientSetPlayerPos").finally(this.cpl)):(ModelManager_1.ModelManager.TeleportModel.TeleportMode=1,s=new TeleportDefine_1.TeleportContext(Protocol_1.Aki.Protocol.v4s.Xvs,void 0,void 0,void 0,void 0),TeleportController_1.TeleportController.TeleportToPositionNoSync(i.ToUeVector(),o.ToUeRotator(),"ClientSetPlayerPos",s).finally(this.cpl),ModelManager_1.ModelManager.WorldMapModel.WaitToTeleportMarkConfigId=void 0)):(this.cpl(),this.FinishExecute(!1))},this.cpl=()=>{this.FinishExecute(!0),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"r.MotionBlur.Amount "+this.yJi),Global_1.Global.BaseCharacter?.IsValid()&&this.hpl&&((Global_1.Global.BaseCharacter.CharacterActorComponent?.Entity.GetComponent(66))?.SetEnableMovementSync(!0),this.hpl=!1)}}ExecuteNew(e,t){this.OPt=e,this.OPt&&this.OPt.TelePortConfig.Type===IAction_1.EClientTeleportType.RelativeEntityPos&&t instanceof LevelGeneralContextDefine_1.TriggerContext&&Global_1.Global.BaseCharacter?.IsValid()?ModelManager_1.ModelManager.TeleportModel.IsTeleport?(Log_1.Log.CheckError()&&Log_1.Log.Error("Teleport",50,"当前正处于传送过程中，无法进行客户端先行传送",["TriggerId",t.TriggerEntityId],["ActionId",this.ActionIndex]),this.FinishExecute(!1)):(this.yJi=UE.KismetSystemLibrary.GetConsoleVariableFloatValue("r.MotionBlur.Amount"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"r.InvalidSeveralFrameOcculusion 30"),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"r.MotionBlur.Amount 0"),TimerSystem_1.TimerSystem.Delay(()=>{this._pl(t)},100)):this.FinishExecute(!1)}upl(t,r,e){if(!e.TriggerEntityId)return!1;var o=EntitySystem_1.EntitySystem.Get(e.TriggerEntityId);if(!o)return!1;o=o.GetComponent(0);const l=o.GetPbDataId();o=o.GetCreatureDataId();return LevelGeneralNetworks_1.LevelGeneralNetworks.RequestClientTeleportByClientTrigger(o,l,t,r,this.ActionIndex,1===e.TriggerType,e=>{e&&e.Q4n===Protocol_1.Aki.Protocol.Q4n.KRs||Log_1.Log.CheckError()&&Log_1.Log.Error("LevelEvent",50,"客户端传送请求失败",["TriggerId",l],["ActionId",this.ActionIndex],["Location",t],["Rotation",r])}),!0}}exports.LevelEventClientSetPlayerPos=LevelEventClientSetPlayerPos;
//# sourceMappingURL=LevelEventClientSetPlayerPos.js.map