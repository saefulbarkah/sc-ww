
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.FishingQteModel=void 0;const puerts_1=require("puerts"),ue_1=require("ue"),Log_1=require("../../../Core/Common/Log"),ModelBase_1=require("../../../Core/Framework/ModelBase"),StringUtils_1=require("../../../Core/Utils/StringUtils"),IGlobal_1=require("../../../UniverseEditor/Interface/IGlobal"),PublicUtil_1=require("../../Common/PublicUtil"),ConfigManager_1=require("../../Manager/ConfigManager"),ModelManager_1=require("../../Manager/ModelManager"),DockyardItemBlockOriginalData_1=require("../../Module/Activity/ActivityContent/Fishing/Dockyard/Base/DockyardItemBlockOriginalData"),FishingController_1=require("../../Module/Activity/ActivityContent/Fishing/FishingController"),ScrollingTipsController_1=require("../../Module/ScrollingTips/ScrollingTipsController"),PreloadConfigStatementPart4_1=require("../../Preload/PreloadConfigStatementPart4"),FishingQteDefine_1=require("./FishingQteDefine"),PERCENT_CONVERT=.01;class FishingQteModel extends ModelBase_1.ModelBase{constructor(){super(...arguments),this.CurrentGameplayId=0,this.CurrentFishingPointConfigId=0,this.CurrentFishingPointCreatureDataId=0,this.CurrentInteractType=0,this.GameInfo=void 0,this.GSl=void 0,this.kSl=void 0,this.CurrentFishingIconType=void 0,this.oO_=1,this.nO_=1,this.h8_=0,this.pt_=new Map,this.sO_=new Map,this.Ki_=[]}get GameConfig(){return PublicUtil_1.PublicUtil.UseDbConfig()?this.GSl:this.kSl}async GameplayStart(t,i){t=ModelManager_1.ModelManager.FishingModel.GetFishingPointDataByPbEntityId(t);if(!t)return!1;t.IsValid()||await FishingController_1.FishingController.RequestFishingPointInfo(t.SceneId,t.Id);var e,r=ConfigManager_1.ConfigManager.FishingConfig.GetFishingPointConfigById(t.Id);return ModelManager_1.ModelManager.FishingModel.GetFishingTechUnlock(r.UnlockTech)?0===t.CurrentCount?(Log_1.Log.CheckError()&&Log_1.Log.Error("LevelPlay",37,"[FishingQte] 交互点可捕捞次数不足",["捕捞点配置Id",t.Id]),!1):(e=r.ShowItem,e=ConfigManager_1.ConfigManager.FishingConfig.GetFishingItemConfig(e),this.CurrentFishingPointCreatureDataId=i,this.CurrentFishingPointConfigId=t.Id,this.CurrentGameplayId=t.GamePlayId,this.CurrentInteractType=0,this.CurrentFishingIconType=1===e.Type?0:1,this.On_(t.CurrentCount)):(i=ConfigManager_1.ConfigManager.FishingConfig.GetFishingTechById(r.UnlockTech),e=PreloadConfigStatementPart4_1.configMultiTextLang.GetLocalTextNew("Fishing_TechUnlockTip2"),t=PreloadConfigStatementPart4_1.configMultiTextLang.GetLocalTextNew(i.Name),r=StringUtils_1.StringUtils.Format(e,t),ScrollingTipsController_1.ScrollingTipsController.ShowTipsByText(r),!1)}GameplayStartByTempFishPoint(t){var i=ModelManager_1.ModelManager.FishingModel.GetTempFishingPointDataByCreatureDataId(t);return i?0===i.CurrentCount?(Log_1.Log.CheckError()&&Log_1.Log.Error("LevelPlay",37,"[FishingQte] 交互点可捕捞次数不足",["临时捕捞点实体Id",i.CreatureDataId]),!1):(this.CurrentFishingPointCreatureDataId=t,this.CurrentFishingPointConfigId=0,this.CurrentGameplayId=i.GamePlayId,this.CurrentInteractType=1,this.CurrentFishingIconType=0,this.On_(i.CurrentCount)):(Log_1.Log.CheckError()&&Log_1.Log.Error("LevelPlay",37,"[FishingQte] 无法查到对应临时捕捞点信息",["CreatureDataId",t]),!1)}On_(t){this.aO_(),this.NSl(),this.GameInfo||(this.GameInfo=new FishingQteDefine_1.FishingQteGameInfo),this.GameInfo.Clear();var i=this.GameConfig.IsAnticlockwise?1:0,i=(this.GameInfo.CreateRingInfo(i),this.GameInfo.MaxRound=t,this.GameConfig.InvalidArea);return this.GameInfo.GetRingInfo().IsWholeRing=0===i.length,this.AccumulatePerfectCombo=0,this.pt_.clear(),this.sO_.clear(),this.Ki_.length=0,Log_1.Log.CheckInfo()&&Log_1.Log.Info("LevelPlay",37,"[FishingQte] 捕鱼玩法开始",["LevelGameplayId",this.CurrentGameplayId],["FishingPointId",this.CurrentFishingPointConfigId],["cIncId",this.CurrentFishingPointCreatureDataId]),!0}aO_(){this.nO_=1,this.oO_=1;var t,i=ModelManager_1.ModelManager.FishingModel.EffectType2TechIdsMap,e=i.get(11);if(e)for(const s of e)ModelManager_1.ModelManager.FishingModel.GetFishingTechUnlock(s)&&(t=ConfigManager_1.ConfigManager.FishingConfig.GetFishingTechById(s).Effect[0],t=ConfigManager_1.ConfigManager.FishingConfig.GetFishingTechEffectById(t),this.nO_+=t.Params[0]*PERCENT_CONVERT);var r,e=i.get(10);if(e)for(const a of e)ModelManager_1.ModelManager.FishingModel.GetFishingTechUnlock(a)&&(r=ConfigManager_1.ConfigManager.FishingConfig.GetFishingTechById(a).Effect[0],r=ConfigManager_1.ConfigManager.FishingConfig.GetFishingTechEffectById(r),this.oO_+=r.Params[0]*PERCENT_CONVERT)}NSl(){var t,i,e;PublicUtil_1.PublicUtil.UseDbConfig()?this.GSl=ConfigManager_1.ConfigManager.FishingConfig.GetFishingQteConfig(this.CurrentGameplayId):(i=IGlobal_1.globalConfig.FishingRouletteConfig)?(i=(0,PublicUtil_1.getConfigPath)(i),e=(t="",puerts_1.$ref)(""),ue_1.KuroStaticLibrary.LoadFileToString(e,i),t=(0,puerts_1.$unref)(e),(i=JSON.parse(t))&&(e=i.find(t=>t.Id===this.CurrentGameplayId),this.kSl=e,this.kSl.CursorSpeed=this.l8_(e.CursorSpeed),this.kSl.RouletteRotateSpeed=this.l8_(e.RouletteRotateSpeed),this.kSl.PerfectAppearRate=this.l8_(e.PerfectAppearRate))):Log_1.Log.CheckError()&&Log_1.Log.Error("LevelPlay",37,"[FishingQte] 捕鱼转盘玩法找不到Json数据配置")}l8_(t){var t=t.replace("[","").replace("]","").split(","),i=new Map;for(const r of t){var e=r.split(":");i.set(Number(e[0]),Number(e[1]))}return i}EnterNextRound(){this.GameInfo.CurrentRound=Math.min(this.GameInfo.CurrentRound+1,this.GameInfo.MaxRound),this.GameInfo.CurrentRound!==this.GameInfo.MaxRound?this.GameInfo.CurrentScore-=this.GameConfig.MaxScore:this.GameInfo.SetGameStage(4)}get ScoreUp(){return this.GameConfig.ScoreUp*this.nO_}get HitAreaScore(){return this.GameConfig.HitAreaScore*this.oO_}get PerfectScore(){return this.GameConfig.PerfectScore*this.oO_}set AccumulatePerfectCombo(t){this.h8_=t,this._8_()}get AccumulatePerfectCombo(){return this.h8_}OnQteOn(){this.GameInfo.CurrentScore+=this.HitAreaScore,this.AccumulatePerfectCombo++}OnPerfectOn(){this.GameInfo.CurrentScore+=this.PerfectScore,this.AccumulatePerfectCombo++}OnMissOn(){this.GameInfo.CurrentScore=Math.max(0,this.GameInfo.CurrentScore-this.GameConfig.MistakeScore),this.AccumulatePerfectCombo=0}_8_(){var t=this.AccumulatePerfectCombo;this.GameInfo.CursorSpeed=this.c8_(t,this.GameConfig.CursorSpeed),this.GameInfo.RingSpeed=this.c8_(t,this.GameConfig.RouletteRotateSpeed),this.GameInfo.PerfectAppearRate=this.c8_(t,this.GameConfig.PerfectAppearRate),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("LevelPlay",37,"[FishingQte] ComboInfoChange",["Combo",this.AccumulatePerfectCombo],["CursorSpeed",this.GameInfo.CursorSpeed],["RingSpeed",this.GameInfo.RingSpeed],["PerfectAppearRate",this.GameInfo.PerfectAppearRate])}c8_(i,t){var e=Array.from(t.entries());for(let t=0;t<e.length;t++){var r=e[t][0],s=e[t][1];if(!(t<e.length-1))return s;var a=e[t+1][0];if(r<=i&&i<a)return s}return 0}SetTempGetDataListFromServer(t,i){for(const r of t){var e=new DockyardItemBlockOriginalData_1.DockyardItemBlockOriginalData(r);this.pt_.set(r.b9n,e),this.sO_.set(r.b9n,i),this.Ki_.push(e)}}GetTempGetDataList(){var t=Array.from(this.pt_.values());return this.pt_.clear(),this.sO_.clear(),this.Ki_.length=0,t}ShiftTempGetData(){return this.Ki_.shift()}IsTempGetDataEmpty(){return 0===this.Ki_.length}GetTempGetDataTag(t){return this.sO_.get(t)??0}}exports.FishingQteModel=FishingQteModel;
//# sourceMappingURL=FishingQteModel.js.map