
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BigStuffedDollView=void 0;const UE=require("ue"),Log_1=require("../../../Core/Common/Log"),EntitySystem_1=require("../../../Core/Entity/EntitySystem"),TimerSystem_1=require("../../../Core/Timer/TimerSystem"),EventDefine_1=require("../../Common/Event/EventDefine"),EventSystem_1=require("../../Common/Event/EventSystem"),TimeUtil_1=require("../../Common/TimeUtil"),ControllerHolder_1=require("../../Manager/ControllerHolder"),ModelManager_1=require("../../Manager/ModelManager"),LevelSequencePlayer_1=require("../../Module/Common/LevelSequencePlayer"),ConfirmBoxDefine_1=require("../../Module/ConfirmBox/ConfirmBoxDefine"),LguiUtil_1=require("../../Module/Util/LguiUtil"),PreloadControllerClassPart2_1=require("../../Preload/PreloadControllerClassPart2"),UiTickViewBase_1=require("../../Ui/Base/UiTickViewBase"),BlackboardController_1=require("../../World/Controller/BlackboardController"),LevelGeneralCommons_1=require("../LevelGeneralCommons"),LevelGeneralNetworks_1=require("../LevelGeneralNetworks"),BigStuffedDefine_1=require("./BigStuffedDefine"),BigStuffedDollController_1=require("./BigStuffedDollController"),BigStuffedDollChallengeFailItem_1=require("./View/BigStuffedDollChallengeFailItem"),BigStuffedDollChallengeSuccessItem_1=require("./View/BigStuffedDollChallengeSuccessItem"),BigStuffedDollProgressItem_1=require("./View/BigStuffedDollProgressItem"),BigStuffedDollTipItem_1=require("./View/BigStuffedDollTipItem"),BigStuffedRingItem_1=require("./View/BigStuffedRingItem"),GameCountDownItem_1=require("./View/GameCountDownItem"),PrepareCountDownItem_1=require("./View/PrepareCountDownItem"),BONUS_TIME_TIPSTAYTIME=3e3,COUNTDOWNSTART="CountDownStart",COUNTDOWNOVER="CountDownOver",GAMEOVER="GameOver",PRESS_FAIL_COUNT="PressFailCount",PRESS_COMMONAREA_SUCCESS_COUNT="PressCommonAreaSuccessCount",PRESS_PERFECTAREA_SUCCESS_COUNT="PressPerfectAreaSuccessCount",PRESS_BONUSAREA_SUCCESS_COUNT="PressBonusAreaSuccessCount",FINISH_SKILL_OVER="FinishSkillOver",DELAY_FINISH_TIME="DelayFinishTime",QTE_ROCK_DESTORY_EVENT="BrokenRockEventKey6";class BigStuffedDollView extends UiTickViewBase_1.UiTickViewBase{constructor(){super(...arguments),this.hfl=new Map,this._fl=new BigStuffedDollProgressItem_1.BigStuffedDollProgressItem,this.ufl=new PrepareCountDownItem_1.PrepareCountDownItem,this.cfl=new GameCountDownItem_1.GameCountDownItem,this.wOi=new BigStuffedDollTipItem_1.BigStuffedDollTipItem,this.mfl=new BigStuffedDollChallengeSuccessItem_1.BigStuffedDollChallengeSuccessItem,this.dfl=new BigStuffedDollChallengeFailItem_1.BigStuffedDollChallengeFailItem,this.Cfl=0,this.gfl=!1,this.ZUl=void 0,this.eDl=void 0,this.tDl=void 0,this.iDl=void 0,this.E0=-1,this.rDl=0,this.oDl=0,this.nDl=0,this.HDe=void 0,this.U6l=!1,this.pfl=e=>{var t=ModelManager_1.ModelManager.BigStuffedDollModel,i=ModelManager_1.ModelManager.SceneTeamModel,s=i.GetCurrentEntity;switch(i.IsPhantomTeam&&i.IsTeamReady&&s&&s.Entity&&(this.E0=s.Entity.Id),e){case 1:this.GetButton(1)?.SetSelfInteractive(!1),this.GetButton(8)?.SetSelfInteractive(!1),BigStuffedDollController_1.BigStuffedDollController.SetBooleanValueThenSendEvent(this.E0,COUNTDOWNSTART,!0),this.ufl.StartCountDown(),this.wOi.ShowTips("TeddyBear_Intro",BONUS_TIME_TIPSTAYTIME);for(var[,r]of this.hfl)r.OnArrowExit();t.ArrowEnterNextValidArea();break;case 2:if(100!==t.LastGameStage){this.ufl.Hide();var a=t.GetGlobalTime();if(this.cfl.StartCountDown(a),this.GetButton(8)?.SetSelfInteractive(!0),this.GetButton(1)?.SetSelfInteractive(!0),-1!==this.E0){BigStuffedDollController_1.BigStuffedDollController.SetBooleanValueThenSendEvent(this.E0,COUNTDOWNOVER,!0);a=s.Entity.GetComponent(35);if(!a)break;a.BeginSkill(t.Config.NormalSkill)}}break;case 3:this.GetButton(1)?.SetSelfInteractive(!1),this.WGn(t.GameResult);break;case 4:break;case 5:this.CloseMe()}},this._Wl=e=>{e===ModelManager_1.ModelManager.BigStuffedDollModel.BehaviorTreeConfigId&&this.cWl()},this.ffl=(e,t,i)=>{for(var[,s]of this.hfl)e!==t&&(s.Id===e&&s.OnArrowExit(),s.Id===t)&&s.OnArrowEnter(),s.OnArrowStayAreaUpdate(i)},this.XPl=(e,t,i)=>{var s=this.hfl.get(e);if(s){var r=s.Config;if(r){var a=ModelManager_1.ModelManager.BigStuffedDollModel;switch(t){case 0:this._fl.AddScore(-a.GetScoreDown()),this.nDl++,BigStuffedDollController_1.BigStuffedDollController.SetIntValueThenSendEvent(this.E0,PRESS_FAIL_COUNT,this.nDl);break;case 1:this._fl.AddScore(r.GoodScore),a.ArrowEnterNextValidArea(),s.SpawnContinuousArea(i),this.rDl++,BigStuffedDollController_1.BigStuffedDollController.SetIntValueThenSendEvent(this.E0,PRESS_COMMONAREA_SUCCESS_COUNT,this.rDl);break;case 2:this._fl.AddScore(r.PerfectScore),a.ArrowEnterNextValidArea(),s.SpawnContinuousArea(i),this.rDl++,BigStuffedDollController_1.BigStuffedDollController.SetIntValueThenSendEvent(this.E0,PRESS_PERFECTAREA_SUCCESS_COUNT,this.rDl);break;case 3:this._fl.AddScore(r.BonusScore),this.oDl++,BigStuffedDollController_1.BigStuffedDollController.SetIntValueThenSendEvent(this.E0,PRESS_BONUSAREA_SUCCESS_COUNT,this.oDl),this.Afl()}}else Log_1.Log.CheckError()&&Log_1.Log.Error("SceneGameplay",18,"[BigStuffedDoll]RingItemAreaClick:找不到当前的RingConfig",["ringId",e])}else Log_1.Log.CheckError()&&Log_1.Log.Error("SceneGameplay",18,"[BigStuffedDoll]RingItemAreaClick:找不到当前的RingItem",["ringId",e])},this._5e=()=>{const e=ModelManager_1.ModelManager.BigStuffedDollModel;e.SetGameStage(100);var t=new ConfirmBoxDefine_1.ConfirmBoxDataNew(232);t.FunctionMap.set(2,this.yAl),t.SetCloseFunction(()=>{e.SetGameStage(e.LastGameStage)}),ControllerHolder_1.ControllerHolder.ConfirmBoxController.ShowConfirmBoxNew(t)},this.yAl=()=>{ModelManager_1.ModelManager.BigStuffedDollModel.GameResult=!1,ModelManager_1.ModelManager.BigStuffedDollModel.SetGameStage(3)},this.aDl=()=>{Log_1.Log.CheckInfo()&&Log_1.Log.Info("SceneGameplay",18,"[BigStuffedDoll]QteButton Click");var e,t,i=ModelManager_1.ModelManager.BigStuffedDollModel.GameInfo,s=i.CurrentArrowStayRingId,s=i.GetRingInfo(s);s?(e=i.CurrentArrowStayCellIndex,(t=this.aTl(s.GetBonusAreas(),e))?this.Dfl(3,t):(t=this.aTl(s.GetPerfectAreas(),e))?this.Dfl(2,t):(t=this.aTl(s.GetGoodAreas(),e))?this.Dfl(1,t):this.Dfl(0,void 0)):Log_1.Log.CheckError()&&Log_1.Log.Error("SceneGameplay",18,"[BigStuffedDoll]QteButtonClick:找不到当前所在的圆环",["ringId",i.CurrentArrowStayRingId])},this.lDl=()=>{this.hDl(0)},this._Dl=()=>{this.hDl(1)},this.uDl=e=>{switch(e){case"Start":case"Press":this.tDl.PlayLevelSequenceByName("Loop")}},this.cDl=e=>{switch(e){case"Start":case"Press":this.iDl.PlayLevelSequenceByName("Loop")}}}OnRegisterComponent(){this.ComponentRegisterInfos=[[0,UE.UIItem],[1,UE.UIButtonComponent],[2,UE.UIItem],[3,UE.UIButtonComponent],[4,UE.UIButtonComponent],[5,UE.UIItem],[6,UE.UIItem],[7,UE.UIItem],[8,UE.UIButtonComponent]],this.BtnBindInfo=[[1,this._5e],[3,this.lDl],[4,this._Dl],[8,this.aDl]]}async OnBeforeStartAsync(){var e=ModelManager_1.ModelManager.BigStuffedDollModel.Config;e?(this.GetButton(8)?.RootUIComp.SetUIActive(!0),this.ZUl=this.GetButton(3),this.tDl=new LevelSequencePlayer_1.LevelSequencePlayer(this.ZUl.RootUIComp),this.tDl.BindSequenceCloseEvent(this.uDl),this.ZUl.RootUIComp.SetUIActive(!1),this.eDl=this.GetButton(4),this.iDl=new LevelSequencePlayer_1.LevelSequencePlayer(this.eDl.RootUIComp),this.iDl.BindSequenceCloseEvent(this.cDl),this.eDl.RootUIComp.SetUIActive(!1),await this.yfl(e),await this.Efl(e),await this.Ifl(),await this.Tfl(),await this.Lfl(),await this.Rfl(),await this.Ufl()):Log_1.Log.CheckError()&&Log_1.Log.Error("SceneGameplay",18,"[BigStuffedDoll]找不到玩法配置")}OnStart(){super.OnStart()}OnAfterShow(){super.OnAfterShow(),ModelManager_1.ModelManager.BigStuffedDollModel.EnterNextGameStage()}OnBeforeDestroy(){this.tDl?.Clear(),this.tDl=void 0,this.iDl?.Clear(),this.iDl=void 0,this.ZUl=void 0,this.eDl=void 0,BlackboardController_1.BlackboardController.RemoveValueByEntity(this.E0,COUNTDOWNSTART),BlackboardController_1.BlackboardController.RemoveValueByEntity(this.E0,COUNTDOWNOVER),BlackboardController_1.BlackboardController.RemoveValueByEntity(this.E0,GAMEOVER),BlackboardController_1.BlackboardController.RemoveValueByEntity(this.E0,PRESS_FAIL_COUNT),BlackboardController_1.BlackboardController.RemoveValueByEntity(this.E0,PRESS_COMMONAREA_SUCCESS_COUNT),BlackboardController_1.BlackboardController.RemoveValueByEntity(this.E0,PRESS_PERFECTAREA_SUCCESS_COUNT),BlackboardController_1.BlackboardController.RemoveValueByEntity(this.E0,PRESS_BONUSAREA_SUCCESS_COUNT),BlackboardController_1.BlackboardController.RemoveValueByEntity(this.E0,FINISH_SKILL_OVER);var e=EntitySystem_1.EntitySystem.Get(this.E0)?.GetComponent(35);e&&e.EndSkill(ModelManager_1.ModelManager.BigStuffedDollModel.Config.NormalSkill,"BigStuffedDollView.OnBeforeDestroy")}OnAfterDestroy(){this.HDe&&this.HDe()}OnTick(e){this._fl.OnTick(e),this.cfl.OnTick(e);for(var[,t]of this.hfl){t.OnTick(e);t=t.GetCurrentArrowStayCellIndex();t&&(ModelManager_1.ModelManager.BigStuffedDollModel.GameInfo.CurrentArrowStayCellIndex=t)}var i=ModelManager_1.ModelManager.BlackboardModel.GetBooleanValueByEntity(this.E0,FINISH_SKILL_OVER),s=ModelManager_1.ModelManager.BigStuffedDollModel.GetGameStage();i&&4===s&&!this.U6l&&(LevelGeneralCommons_1.LevelGeneralCommons.PrechangeStateTag(ModelManager_1.ModelManager.BigStuffedDollModel.BrokenRockEntityPbDataId,1001667892,"大个布偶坚固岩石玩法：终结一拳播放完毕"),LevelGeneralNetworks_1.LevelGeneralNetworks.RequestEntitySendEvent(ModelManager_1.ModelManager.BigStuffedDollModel.BrokenRockEntityCreatureDataId,QTE_ROCK_DESTORY_EVENT),i=ModelManager_1.ModelManager.BlackboardModel.GetFloatValueByEntity(this.E0,DELAY_FINISH_TIME)??TimerSystem_1.MIN_TIME/1e3,TimerSystem_1.TimerSystem.Delay(()=>{this.mfl.ShowTip()},1e3*i),this.U6l=!0)}async yfl(i){if(this.hfl.clear(),0===i.Rings.length)Log_1.Log.CheckError()&&Log_1.Log.Error("SceneGameplay",18,"[BigStuffedDoll]玩法配置的环数量为0");else{var s=this.GetItem(6),r=this.GetItem(5),a=[];for(let t=0;t<i.Rings.length;t++){let e=s;0!==t&&(e=LguiUtil_1.LguiUtil.CopyItem(s,r));var o=i.Rings[t],l=new BigStuffedRingItem_1.BigStuffedRingItem(o,e.GetOwner());this.hfl.set(o,l),a.push(l)}await Promise.all([...a.map(async e=>e.InitAsync())])}}async Efl(e){var t=this.GetItem(2);await this._fl.CreateThenShowByActorAsync(t.GetOwner()),this._fl.Init(e)}async Ifl(){await this.ufl.CreateByResourceIdAsync("UiView_PrepareCountdownFloatTips_Prefab",this.RootItem),await this.ufl.HideAsync()}async Tfl(){await this.cfl.CreateByResourceIdAsync("UiView_CountDown_Prefab",this.RootItem),await this.cfl.HideAsync()}async Rfl(){await this.mfl.CreateByResourceIdAsync("UiView_Challenge_Success_Prefab",this.RootItem),await this.mfl.HideAsync()}async Ufl(){await this.dfl.CreateByResourceIdAsync("UiView_Challenge_Failed_Prefab",this.RootItem),await this.dfl.HideAsync()}async Lfl(){var e=this.GetItem(7);await this.wOi.CreateByActorAsync(e.GetOwner()),await this.wOi.HideAsync()}OnAddEventListener(){EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnBigStuffedDollGameStageUpdate,this.pfl),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnBigStuffedDollArrowStayAreaUpdate,this.ffl),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnBigStuffedDollRingItemSequencePlayStart,this.XPl)}OnRemoveEventListener(){EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnBigStuffedDollGameStageUpdate,this.pfl),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnBigStuffedDollArrowStayAreaUpdate,this.ffl),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnBigStuffedDollRingItemSequencePlayStart,this.XPl),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.GeneralLogicTreePrepareRollbackFinish,this._Wl)}async WGn(e){e?(this.HDe=this.OpenParam,this.GetItem(0)?.SetUIActive(!1),BigStuffedDollController_1.BigStuffedDollController.SetBooleanValueThenSendEvent(this.E0,GAMEOVER,!0),(EntitySystem_1.EntitySystem.Get(this.E0)?.GetComponent(35))?.BeginSkill(ModelManager_1.ModelManager.BigStuffedDollModel.Config.FinishSkill),this.cfl.Hide(()=>{ModelManager_1.ModelManager.BigStuffedDollModel.EnterNextGameStage()})):(await PreloadControllerClassPart2_1.LevelLoadingController.WaitOpenLoading(16,3),BigStuffedDollController_1.BigStuffedDollController.SetBooleanValueThenSendEvent(this.E0,GAMEOVER,!0),LevelGeneralNetworks_1.LevelGeneralNetworks.RequestEntitySendEvent(ModelManager_1.ModelManager.BigStuffedDollModel.BrokenRockEntityCreatureDataId,"DboQTEFailed"),this.GetItem(0)?.SetUIActive(!1),await this.cfl.HideAsync(),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.GeneralLogicTreePrepareRollbackFinish,this._Wl))}async cWl(){await PreloadControllerClassPart2_1.LevelLoadingController.WaitCloseLoading(16,3),this.dfl.ShowTip("Text_RoleChallengeFail_Text")}Afl(){this.gfl=!0,this.wOi.ShowTips("TeddyBear_Bonus",BONUS_TIME_TIPSTAYTIME),this.GetItem(5)?.SetUIActive(!1),this.GetButton(8)?.RootUIComp.SetUIActive(!1),this.ZUl?.RootUIComp.SetUIActive(!0),this.tDl?.PlayLevelSequenceByName("Start"),this.eDl?.RootUIComp.SetUIActive(!0),this.iDl?.PlayLevelSequenceByName("Start")}hDl(e){if(this.gfl){var t=ModelManager_1.ModelManager.BigStuffedDollModel.GameInfo.CurrentArrowStayRingId,t=this.hfl.get(t)?.Config;switch(t&&this._fl.AddScore(t.BonusScore),e){case 0:this.tDl?.StopCurrentSequence(!1,!0),this.tDl?.PlayLevelSequenceByName("Press");break;case 1:this.iDl?.StopCurrentSequence(!1,!0),this.iDl?.PlayLevelSequenceByName("Press")}}}aTl(e,t){for(var[,i]of e){var s=i.StartCellIndex,r=i.EndCellIndex;if(s<=r){if(s<=t&&t<=r)return i}else if(s<=t&&t<=BigStuffedDefine_1.BIGSTUFFEDDOLL_RINGCELLCOUNT||1<=t&&t<=r)return i}}Dfl(e,t){var i=ModelManager_1.ModelManager.BigStuffedDollModel.GameInfo,s=i.CurrentArrowStayRingId,s=this.hfl.get(s);if(s){var r=s.Config;if(r){var a=TimeUtil_1.TimeUtil.GetServerStopTimeStamp();if(!(a-this.Cfl<=r.ColdTime)){this.Cfl=TimeUtil_1.TimeUtil.GetServerStopTimeStamp();const o=this.GetButton(8);o?.SetSelfInteractive(!1),TimerSystem_1.TimerSystem.Delay(()=>{o?.SetSelfInteractive(!0)},r.ColdTime),s.OnAreaClick(e,t)}}else Log_1.Log.CheckError()&&Log_1.Log.Error("SceneGameplay",18,"[BigStuffedDoll]OnAreaClick:找不到当前的RingConfig",["ringId",i.CurrentArrowStayRingId])}else Log_1.Log.CheckError()&&Log_1.Log.Error("SceneGameplay",18,"[BigStuffedDoll]OnAreaClick:找不到当前的RingItem",["ringId",i.CurrentArrowStayRingId])}}exports.BigStuffedDollView=BigStuffedDollView;
//# sourceMappingURL=BigStuffedDollView.js.map