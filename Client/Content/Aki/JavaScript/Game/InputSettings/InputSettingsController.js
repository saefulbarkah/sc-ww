
"use strict";var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.InputSettingsController=void 0;const Log_1=require("../../Core/Common/Log"),Protocol_1=require("../../Core/Define/Net/Protocol"),ControllerBase_1=require("../../Core/Framework/ControllerBase"),Net_1=require("../../Core/Net/Net"),Platform_1=require("../../Launcher/Platform/Platform"),EventDefine_1=require("../Common/Event/EventDefine"),EventSystem_1=require("../Common/Event/EventSystem"),GameSettingsManager_1=require("../GameSettings/GameSettingsManager"),ConfigManager_1=require("../Manager/ConfigManager"),ControllerHolder_1=require("../Manager/ControllerHolder"),ModelManager_1=require("../Manager/ModelManager"),InputSettingsManager_1=require("./InputSettingsManager");class InputSettingsController extends ControllerBase_1.ControllerBase{static OnInit(){return Net_1.Net.Register(16176,InputSettingsController.eYa),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnGetPlayerBasicInfo,this.Wvi),!0}static OnClear(){return Net_1.Net.UnRegister(16176),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnGetPlayerBasicInfo,this.Wvi),!0}static $eh(){ModelManager_1.ModelManager.SkillButtonUiModel.GamepadData?.AddChangeKeyReason(1),ModelManager_1.ModelManager.LoginModel.IsNewAccount?(Log_1.Log.CheckInfo()&&Log_1.Log.Info("InputSettings",11,"新号没有输入数据，还原至配置表配置"),InputSettingsManager_1.InputSettingsManager.ResetDefaultInputKey()):Log_1.Log.CheckInfo()&&Log_1.Log.Info("InputSettings",11,"老号没有输入数据，默认本地存储按键"),ModelManager_1.ModelManager.SkillButtonUiModel.GamepadData?.RemoveChangeKeyReason(1)}static InputSettingRequest(){var t=new Protocol_1.Aki.Protocol.goh;Net_1.Net.Call(22420,Protocol_1.Aki.Protocol.goh.create(t),this.tYa)}static InputSettingUpdateRequest(t){var e=new Protocol_1.Aki.Protocol.poh;e.iYa=this.Rth(t),Net_1.Net.Call(27722,Protocol_1.Aki.Protocol.poh.create(e),this.rYa)}static RefreshInputSettingsFromProtoData(n){if(!n||!n.oYa||n.oYa.length<=0)Log_1.Log.CheckInfo()&&Log_1.Log.Info("InputSettings",11,"[RefreshInputSettingsFromProtoData]服务端没有数据，使用本地配置"),this.$eh(),GameSettingsManager_1.GameSettingsManager.ReApply(130),GameSettingsManager_1.GameSettingsManager.ReApply(131);else{ModelManager_1.ModelManager.SkillButtonUiModel.GamepadData?.AddChangeKeyReason(1);let t="";let e=!1;for(const o of n.oYa){var a=o.nYa;a===Protocol_1.Aki.Protocol.rah.Proto_Mouse&&(t=InputSettingsManager_1.InputSettingsManager.DeviceLang,InputSettingsManager_1.InputSettingsManager.DeviceLang=o.Sza),e=(e=(e=e||this.sYa(o.Rsh,a))||this.aYa(o.Tsh,a))||this.lYa(o.Lsh,a)}Platform_1.Platform.IsPcPlatform()&&InputSettingsManager_1.InputSettingsManager.ChangeActionAndAxisPcKeys(t),ModelManager_1.ModelManager.SkillButtonUiModel.GamepadData?.RemoveChangeKeyReason(1),e?this.InputSettingUpdateRequest(!1):(GameSettingsManager_1.GameSettingsManager.ReApply(130),GameSettingsManager_1.GameSettingsManager.ReApply(131))}}static aYa(t,e){if(!t)return Log_1.Log.CheckInfo()&&Log_1.Log.Info("InputSettings",11,"从Proto_InputSettingData刷新Action输入时，没有输入数据，还原至默认输入按键",["actionData",t]),InputSettingsManager_1.InputSettingsManager.RefreshAllActionKeys(!0),!1;var n=Object.keys(t),a=ConfigManager_1.ConfigManager.InputSettingsConfig;let o=!1;for(const m of n){var r=InputSettingsManager_1.InputSettingsManager.GetActionBinding(m);if(r){var i=t[m];if(i){var g=i.K7n;switch(e){case Protocol_1.Aki.Protocol.rah.Proto_Mouse:var _=r.GetKeyboardVersion();if(o=o||g<_,g<_){_=a?.GetActionMappingConfigByActionName(m);if(!_)continue;let t=[];t=InputSettingsManager_1.InputSettingsManager.CheckUseFrenchKeyboard?_.FrancePcKeys:_.PcKeys,r.SetKeyboardKeys(t);_=InputSettingsManager_1.InputSettingsManager.GetCombinationActionBindingByActionName(m);if(_){var s,u,p=new Map;_.GetPcKeyNameMap(p);for([s,u]of p)InputSettingsManager_1.InputSettingsManager.RemoveCombinationActionKeyMap(m,s,u)}Log_1.Log.CheckDebug()&&Log_1.Log.Debug("InputSettings",11,"从Proto_InputSettingData刷新Action输入时，键鼠配置版本号大于服务端版本号，键鼠使用默认配置",["actionName",m],["keyNameList",t])}else{_=i.hYa;r.SetKeyboardKeys(_),r.SetKeyboardVersion(g),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("InputSettings",11,"从Proto_InputSettingData刷新Action输入时，更新键鼠输入按键",["actionName",m],["keyNameList",_])}break;case Protocol_1.Aki.Protocol.rah.uVn:p=r.GetGamepadVersion();if(o=o||g<p,g<p){_=a?.GetActionMappingConfigByActionName(m);if(!_)continue;var c=_.GamepadKeys,S=(r.SetGamepadKeys(c),InputSettingsManager_1.InputSettingsManager.GetCombinationActionBindingByActionName(m));if(S){var l,f,I=new Map;S.GetGamepadKeyNameMap(I);for([l,f]of I)InputSettingsManager_1.InputSettingsManager.RemoveCombinationActionKeyMap(m,l,f)}Log_1.Log.CheckDebug()&&Log_1.Log.Debug("InputSettings",11,"从Proto_InputSettingData刷新Action输入时，手柄配置版本号大于服务端手柄版本号，手柄使用默认配置",["actionName",m],["keyNameList",c])}else{S=i.hYa;if(r.SetGamepadKeys(S),r.SetGamepadVersion(g),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("InputSettings",11,"从Proto_InputSettingData刷新Action输入时，更新手柄输入按键",["actionName",m],["keyNameList",S]),0<S.length&&"Gamepad_Invalid"!==S[0]){Log_1.Log.CheckDebug()&&Log_1.Log.Debug("InputSettings",11,"Proto_InputSettingData服务器发现有单键配置,尝试删除本地组合键配置",["actionName",m],["keyNameList",S]);I=InputSettingsManager_1.InputSettingsManager.GetCombinationActionBindingByActionName(m);if(I){var M,v,c=new Map;I.GetGamepadKeyNameMap(c);for([M,v]of c)InputSettingsManager_1.InputSettingsManager.RemoveCombinationActionKeyMap(m,M,v)}}}}}}}return o}static lYa(t,e){if(!t)return Log_1.Log.CheckInfo()&&Log_1.Log.Info("InputSettings",11,"从Proto_InputSettingData刷新Action输入时，没有输入数据，还原至默认输入按键",["axisMap",t]),InputSettingsManager_1.InputSettingsManager.RefreshAllAxisKeys(!0),!1;var n=Object.keys(t),a=ConfigManager_1.ConfigManager.InputSettingsConfig;let o=!1;for(const I of n){var r=InputSettingsManager_1.InputSettingsManager.GetAxisBinding(I);if(r){var i=t[I];if(i){var g=i.K7n;switch(e){case Protocol_1.Aki.Protocol.rah.Proto_Mouse:var _=r.GetKeyboardVersion();if(o=o||g<_,g<_){_=a?.GetAxisMappingConfigByAxisName(I);if(!_)continue;let t=new Map;t=InputSettingsManager_1.InputSettingsManager.CheckUseFrenchKeyboard?_.FrancePcKeys:_.PcKeys,r.SetKeyboardKeys(t),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("InputSettings",11,"从Proto_InputSettingData刷新Axis输入时，键鼠配置版本号大于服务端版本号，键鼠使用默认配置",["axisName",I],["keyboardKeyScaleMap",t])}else{var s=new Map,u=i.Esh;for(const M of Object.keys(u)){var p=u[M];s.set(M,p/1e3)}r.SetKeyboardKeys(s),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("InputSettings",11,"从Proto_InputSettingData刷新Axis输入时，更新键鼠输入按键",["actionName",I],["keyScaleMap",s])}break;case Protocol_1.Aki.Protocol.rah.uVn:_=r.GetGamepadVersion();if(o=o||g<_,g<_){var c=a?.GetAxisMappingConfigByAxisName(I);if(!c)continue;c=c.GamepadKeys;r.SetGamepadKeys(c),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("InputSettings",11,"从Proto_InputSettingData刷新Axis输入时，手柄配置版本号大于服务端版本号，手柄使用默认配置",["axisName",I],["gamepadKeyScaleMap",c])}else{var S=new Map,l=i.Esh;for(const v of Object.keys(l)){var f=l[v];S.set(v,f/1e3)}r.SetGamepadKeys(S),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("InputSettings",11,"从Proto_InputSettingData刷新Axis输入时，更新手柄输入按键",["actionName",I],["gamepadKeyScaleMap",S])}}}}}return o}static sYa(t,e){if(!t)return Log_1.Log.CheckInfo()&&Log_1.Log.Info("InputSettings",11,"从Proto_InputSettingData刷新Action输入时，没有输入数据，还原至默认输入按键",["actionData",t]),InputSettingsManager_1.InputSettingsManager.RefreshCombinationActionKeys(!0),!1;var n=Object.keys(t),a=ConfigManager_1.ConfigManager.InputSettingsConfig;let o=!1;for(const c of n){var r=InputSettingsManager_1.InputSettingsManager.TryGetCombinationActionBinding(c);if(r){var i=t[c];if(i){var g=i.K7n;switch(e){case Protocol_1.Aki.Protocol.rah.Proto_Mouse:var _=r.GetKeyboardVersion();if(o=o||g<_,g<_){_=a?.GetCombinationActionConfigByActionName(c);if(!_)continue;_=_.PcKeys;InputSettingsManager_1.InputSettingsManager.SetCombinationActionKeyboardKeys(c,_),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("InputSettings",11,"从Proto_InputSettingData刷新CombinationAction输入时，键鼠配置版本号大于服务端版本号，键鼠使用默认配置",["actionName",c],["keyboardKeys",_])}else{var s=new Map;for(const S of i.Ish)s.set(S.hYa[0],S.hYa[1]);InputSettingsManager_1.InputSettingsManager.SetCombinationActionKeyboardKeys(c,s),r.SetKeyboardVersion(g),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("InputSettings",11,"从Proto_InputSettingData刷新Action输入时，更新键鼠输入按键",["actionName",c],["keyNameMap",s])}break;case Protocol_1.Aki.Protocol.rah.uVn:_=r.GetGamepadVersion();if(o=o||g<_,g<_){var u=a?.GetCombinationActionConfigByActionName(c);if(!u)continue;u=u.GamepadKeys;InputSettingsManager_1.InputSettingsManager.SetCombinationActionGamepadKeys(c,u),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("InputSettings",11,"从Proto_InputSettingData刷新Action输入时，手柄配置版本号大于服务端手柄版本号，手柄使用默认配置",["actionName",c],["gamepadKeys",u])}else{var p=new Map;for(const l of i.Ish)p.set(l.hYa[0],l.hYa[1]);InputSettingsManager_1.InputSettingsManager.SetCombinationActionGamepadKeys(c,p),r.SetGamepadVersion(g),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("InputSettings",11,"从Proto_InputSettingData刷新Action输入时，更新手柄输入按键",["actionName",c],["keyNameMap",p])}}}}}return o}static Rth(t){var e,n,a,o,r,i,g,_,s=new Protocol_1.Aki.Protocol.iYa,u=new Protocol_1.Aki.Protocol.oah,p=new Protocol_1.Aki.Protocol.oah,c=(u.nYa=Protocol_1.Aki.Protocol.rah.Proto_Mouse,u.Sza=InputSettingsManager_1.InputSettingsManager.DeviceLang,p.nYa=Protocol_1.Aki.Protocol.rah.uVn,InputSettingsManager_1.InputSettingsManager.GetActionBindingMap());for([e,n]of c){var S=[],l=t?0:n.GetKeyboardVersion(),S=(n.GetPcKeyNameList(S),this._Ya(e,u,S,l),[]),l=t?0:n.GetGamepadVersion();n.GetGamepadKeyNameList(S),this._Ya(e,p,S,l)}for([a,o]of InputSettingsManager_1.InputSettingsManager.GetAxisBindingMap()){var f=new Map,I=t?0:o.GetKeyboardVersion(),f=(o.GetPcKeyScaleMap(f),this.uYa(a,u,f,I),new Map),I=t?0:o.GetGamepadVersion();o.GetGamepadKeyScaleMap(f),this.uYa(a,p,f,I)}for([r,i]of InputSettingsManager_1.InputSettingsManager.GetCombinationActionBindingMap()){var M=new Map,v=t?0:i.GetKeyboardVersion(),M=(i.GetPcKeyNameMap(M),this.cYa(r,u,M,v),new Map),v=t?0:i.GetGamepadVersion();i.GetGamepadKeyNameMap(M),this.cYa(r,p,M,v)}for([g,_]of InputSettingsManager_1.InputSettingsManager.GetCombinationAxisBindingMap()){var m=new Map,L=t?0:_.GetKeyboardVersion(),m=(_.GetPcKeyNameMap(m),this.mYa(g,u,m,L),new Map),L=t?0:_.GetGamepadVersion();_.GetGamepadKeyNameMap(m),this.mYa(g,p,m,L)}return s.oYa=[u,p],s}static _Ya(t,e,n,a){var o=new Protocol_1.Aki.Protocol.tah;o.dYa=t,o.K7n=a,o.hYa=n,e.Tsh[t]=o}static uYa(t,e,n,a){var o,r,i=new Protocol_1.Aki.Protocol.iah;i.CYa=t,i.K7n=a;for([o,r]of n){var g=Math.round(1e3*r);i.Esh[o]=g}e.Lsh[t]=i}static cYa(t,e,n,a){var o,r,i=new Protocol_1.Aki.Protocol.Rsh;i.dYa=t,i.K7n=a;for([o,r]of n){var g=new Protocol_1.Aki.Protocol.eah;g.hYa=[o,r],i.Ish.push(g)}e.Rsh[t]=i}static mYa(t,e,n,a){var o,r,i=new Protocol_1.Aki.Protocol.Ash;i.CYa=t,i.K7n=a;for([o,r]of n){var g=new Protocol_1.Aki.Protocol.eah;g.hYa=[o,r],i.Ish.push(g)}e.Ash[t]=i}}exports.InputSettingsController=InputSettingsController,(_a=InputSettingsController).Wvi=()=>{Log_1.Log.CheckInfo()&&Log_1.Log.Info("InputSettings",11,"登录直接请求服务端输入数据"),_a.InputSettingRequest()},InputSettingsController.eYa=t=>{Log_1.Log.CheckDebug()&&Log_1.Log.Debug("InputSettings",11,"服务端通知更新按键信息"),_a.RefreshInputSettingsFromProtoData(t.iYa),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnInputSettingUpdateNotify)},InputSettingsController.tYa=t=>{!t||!t.iYa||t.iYa.oYa.length<=0?(Log_1.Log.CheckInfo()&&Log_1.Log.Info("InputSettings",11,"服务端没有数据，使用本地配置并同步给服务端"),_a.$eh(),Platform_1.Platform.IsMobilePlatform()||_a.InputSettingUpdateRequest(!ModelManager_1.ModelManager.LoginModel.IsNewAccount)):(Log_1.Log.CheckInfo()&&Log_1.Log.Info("InputSettings",11,"服务端有对应数据,使用服务端数据刷新本地输入数据"),_a.RefreshInputSettingsFromProtoData(t?.iYa),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnInputSettingResponse))},InputSettingsController.rYa=t=>{t&&t.Q4n!==Protocol_1.Aki.Protocol.Q4n.KRs&&ControllerHolder_1.ControllerHolder.ErrorCodeController.OpenErrorCodeTipView(t.Q4n,29049)};
//# sourceMappingURL=InputSettingsController.js.map