
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CreatureGroupController=void 0;const Log_1=require("../../../Core/Common/Log"),DisjointSet_1=require("../../../Core/Container/DisjointSet"),EntitySystem_1=require("../../../Core/Entity/EntitySystem"),EventDefine_1=require("../../Common/Event/EventDefine"),EventSystem_1=require("../../Common/Event/EventSystem"),ControllerHolder_1=require("../../Manager/ControllerHolder"),ModelManager_1=require("../../Manager/ModelManager"),PreloadControllerClassPart1_1=require("../../Preload/PreloadControllerClassPart1");class CreatureGroupController extends PreloadControllerClassPart1_1.ControllerBase{static OnClear(){return this.sTa.Clear(),!0}static AddBindEntity(r,e){this.sTa.Union(r,e),Log_1.Log.CheckInfo()&&Log_1.Log.Info("Entity",19,"[实体生命周期:实体绑组] 建立实体绑定",["CreatureDataIdA",r],["CreatureDataIdB",e])}static HasBindGroup(r){return this.sTa.Has(r)}static GetBindGroup(r){return this.sTa.GetSet(r)}static tr_(r){var r=ModelManager_1.ModelManager.CreatureModel.GetEntity(r);if(r?.Valid&&r.Entity)return 64&(r=r.Entity.Flag)?64:32&r?32:16&r?16:8&r?8:4&r?4:2&r?2:1&r?1:0}static ir_(r){let e=4;for(const o of r){var t=this.tr_(o);void 0!==t&&(e=Math.max(e,t))}return e}static rr_(r){let e=16;for(const o of r){var t=this.tr_(o);void 0!==t&&(e=Math.min(e,t))}return e}static or_(){var r,e;CreatureGroupController.nr_=!1,0<CreatureGroupController.sr_.size&&(r=[...CreatureGroupController.sr_.keys()][0],e=CreatureGroupController.sr_.get(r),CreatureGroupController.sr_.delete(r),CreatureGroupController.RefreshBindGroup(r,e))}static RefreshBindGroup(r,e){var t=CreatureGroupController.GetBindGroup(r),o=[["CreatureDataId",r],["bindGroup",t],["EntityId",ModelManager_1.ModelManager.CreatureModel.GetEntity(r)?.Id],["reason",e]];if(t){var n=this.ir_(t),a=this.rr_(t);if(o.push(["highestFlag",n],["lowestFlag",a]),16<=a){Log_1.Log.CheckInfo()&&Log_1.Log.Info("Entity",19,"[实体生命周期:实体绑组] 实体组激活完毕，删除实体组及相应缓存",...o);for(const i of t)CreatureGroupController.sr_.delete(i);CreatureGroupController.sTa.DeleteSet(r),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.RemoveEntityFromBindGroup,t),this.or_()}else if(CreatureGroupController.nr_)Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Entity",19,"[实体生命周期:实体绑组] 绑组递归调用，缓存执行",...o),CreatureGroupController.sr_.set(r,e);else{if(CreatureGroupController.nr_=!0,n<=a){Log_1.Log.CheckInfo()&&Log_1.Log.Info("Entity",19,"[实体生命周期:实体绑组] 整组推进生命周期",...o);for(const u of t)CreatureGroupController.ar_(u)}else if(4<n){Log_1.Log.CheckInfo()&&Log_1.Log.Info("Entity",19,"[实体生命周期:实体绑组] 部分推进生命周期",...o);for(const C of t){var l=CreatureGroupController.tr_(C);l&&l<n&&CreatureGroupController.ar_(C)}}else Log_1.Log.CheckInfo()&&Log_1.Log.Info("Entity",19,"[实体生命周期:实体绑组] 同组尚未start，暂时阻塞",...o);this.or_()}}else Log_1.Log.CheckError()&&Log_1.Log.Error("Entity",19,"[实体生命周期:实体绑组] 实体不在实体组中",...o),this.or_()}static ar_(r){var e=ModelManager_1.ModelManager.CreatureModel.GetEntity(r),t=CreatureGroupController.tr_(r),o=[["CreatureDataId",r],["EntityId",e?.Id],["ExecutedFlag",t]];e?.Valid&&e.Entity?t?t<4||16<=t?Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Entity",19,"[实体生命周期:实体绑组]实体无需推进",...o):4===t?ControllerHolder_1.ControllerHolder.CreatureController.ActivateEntityRequest(e):8===t?(EntitySystem_1.EntitySystem.PostActive(e.Entity),CreatureGroupController.RefreshBindGroup(r,"postActive")):Log_1.Log.CheckError()&&Log_1.Log.Error("Entity",19,"[实体生命周期:实体绑组]预期外的flag类型",...o):Log_1.Log.CheckError()&&Log_1.Log.Error("Entity",19,"[实体生命周期:实体绑组]实体Flag为空",...o):Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Entity",19,"[实体生命周期:实体绑组]推进不存在的实体生命周期",...o)}static RemoveFromBindGroup(e,t){var o=CreatureGroupController.GetBindGroup(e);if(o){let r=void 0;for(const n of o)if(void 0!==n&&n!==e){r=n;break}CreatureGroupController.sTa.Delete(e),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.RemoveEntityFromBindGroup,e),void 0!==r&&(CreatureGroupController.HasBindGroup(r)?CreatureGroupController.RefreshBindGroup(r,t):CreatureGroupController.ar_(r))}}}(exports.CreatureGroupController=CreatureGroupController).sTa=new DisjointSet_1.DisjointSet,CreatureGroupController.nr_=!1,CreatureGroupController.sr_=new Map;
//# sourceMappingURL=CreatureGroupController.js.map