
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.WaitEntityToLoadTask=void 0;const Log_1=require("../../../Core/Common/Log"),Stats_1=require("../../../Core/Common/Stats"),Pool_1=require("../../../Core/Container/Pool"),PriorityQueue_1=require("../../../Core/Container/PriorityQueue"),Protocol_1=require("../../../Core/Define/Net/Protocol"),ResourceSystem_1=require("../../../Core/Resource/ResourceSystem"),TimerSystem_1=require("../../../Core/Timer/TimerSystem"),Vector_1=require("../../../Core/Utils/Math/Vector"),EventDefine_1=require("../../Common/Event/EventDefine"),EventSystem_1=require("../../Common/Event/EventSystem"),ModelManager_1=require("../../Manager/ModelManager"),PreloadDefine_1=require("../../Preload/PreloadDefine"),PlayerVelocityController_1=require("../Controller/PlayerVelocityController");class EntityHandleCallbackPair{constructor(){this.Handle=void 0,this.Dto=[],this.CreatureDataId=0,this.PbDataId=0,this.AngleRatio=0,this.Priority=0,this.Order=0,this.Version=0}AddCallback(t){t&&this.Dto.push(t)}ClearCallbacks(){this.Dto.length=0}InvokeCallbacks(i){this.Dto.forEach(t=>{try{t(i)}catch(t){t instanceof Error?Log_1.Log.CheckError()&&Log_1.Log.ErrorWithStack("Preload",60,"预加载实体:加载回调异常",t,["result",i]):Log_1.Log.CheckError()&&Log_1.Log.Error("Preload",60,"预加载实体:加载回调异常",["result",i])}})}}const NORMAL_MAX_LOADING_ENTITY_COUNT=4,HIGH_SPEED_MAX_LOADING_ENTITY_COUNT=1,DELAY_CHECK_HIGH_SPEED=200,HIGH_SPEED_IGNORED_ANGLE_RATIO=.3,ENABLE_SUSPEND_LOADING_FOR_HIGH_SPEED_MODE=!1;class WaitEntityToLoadTask{constructor(t,i){this.nya=()=>0,this.HWa=()=>{},this.FEa=new PriorityQueue_1.PriorityQueue((t,i)=>{var e=this.VEa(t.AngleRatio);return e===this.VEa(i.AngleRatio)?t.Priority===i.Priority?t.Order-i.Order:t.Priority-i.Priority:e?1:-1}),this.HEa=new Map,this.jWa=new Map,this.jEa=[],this.WEa=NORMAL_MAX_LOADING_ENTITY_COUNT,this.QEa=0,this.KEa=void 0,this.$Ea=!1,this.XEa=!1,this.WWa=0,this.YEa=Vector_1.Vector.Create(),this.JEa=Vector_1.Vector.Create(),this.zEa=Vector_1.Vector.Create(),this.ZEa=Vector_1.Vector.Create(),this.eya=Vector_1.Vector.Create(),this.tya=Stats_1.Stat.Create("WaitEntityToLoadTask.Sort"),this.iya=Stats_1.Stat.Create("WaitEntityToLoadTask.UpdatePriority"),this.rya=t=>{for(this.GEa(t);0===this.oya(););},this.nya=t,this.HWa=i}OnInit(){this.Vr(),this.WEa=NORMAL_MAX_LOADING_ENTITY_COUNT,this.QEa=0,this.$Ea=PlayerVelocityController_1.PlayerVelocityController.IsHighSpeedMode(),this.XEa=!1}OnClear(){this.sya(),this.FEa.Clear(),this.HEa.clear(),this.jWa.clear(),this.jEa.length=0,this.KEa&&(TimerSystem_1.TimerSystem.Remove(this.KEa),this.KEa=void 0)}Vr(){EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnHighSpeedModeChanged,this.rya)}sya(){EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnHighSpeedModeChanged,this.rya)}static aya(t,i,e,r){let s=this.hya.Get();return(s=s||WaitEntityToLoadTask.hya.Create()).Handle=t,s.CreatureDataId=e,s.PbDataId=r,s.Priority=t.Priority,s.AngleRatio=0,s.Order=0,s.AddCallback(i),s.Version++,s}QWa(t){0===this.FEa.Size&&(this.WWa=0),t.Order=this.WWa++}KWa(t){let i=this.jWa.get(t);return i=i||this.HEa.get(t)}static Hza(t){var i=t.Entity.GetComponent(0);return!(PreloadDefine_1.PreloadSetting.UseNewPreload&&i.GetPreloadFinished()||((i=i.GetEntityType())===Protocol_1.Aki.Protocol.kks.Proto_Custom||i===Protocol_1.Aki.Protocol.kks.Proto_PlayerEntity)&&(i===Protocol_1.Aki.Protocol.kks.Proto_PlayerEntity&&(t.Priority=105),1))}QueueToInvoke(t,i,e,r){let s=this.KWa(t);s?s.AddCallback(i):(s=WaitEntityToLoadTask.aya(t,i,e,r),WaitEntityToLoadTask.Hza(t)?this.QEa<this.WEa?(ModelManager_1.ModelManager.CreatureModel.EnableEntityLog&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("Preload",60,"预加载实体:直接加载",["EntityId",t.Id],["CreatureDataId",s.CreatureDataId],["PbDataId",s.PbDataId],["Priority",s.Priority],["Order",s.Order],["Version",s.Version]),this.lya(s)):(this.QWa(s),this.FEa.Push(s),this.HEa.set(s.Handle,s),this.jEa.push(s.Handle),ModelManager_1.ModelManager.CreatureModel.EnableEntityLog&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("Preload",60,"预加载实体:进入加载队列",["EntityId",t.Id],["CreatureDataId",s.CreatureDataId],["PbDataId",s.PbDataId],["Priority",s.Priority],["Order",s.Order],["Version",s.Version],["Remain",this.FEa.Size])):(ModelManager_1.ModelManager.CreatureModel.EnableEntityLog&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("Preload",60,"预加载实体:不需要预加载，直接唤醒",["EntityId",t.Id],["CreatureDataId",s.CreatureDataId],["PbDataId",s.PbDataId],["Priority",s.Priority],["Order",s.Order],["Version",s.Version]),this.jza(s)))}Flush(){for(;!this.FEa.Empty;)this.$Wa()}RemoveEntity(t){var i=this.KWa(t);i&&(this.HEa.delete(t)&&this.FEa.Remove(i),this.XWa(i,4),ModelManager_1.ModelManager.CreatureModel.EnableEntityLog)&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("Preload",60,"预加载实体:移除加载队列",["RemoveType","Outside"],["EntityId",t.Id],["CreatureDataId",i.CreatureDataId],["PbDataId",i.PbDataId],["AngleRatio",i.AngleRatio],["Priority",i.Priority],["Order",i.Order],["Version",i.Version],["Remain",this.FEa.Size])}XWa(t,i){ModelManager_1.ModelManager.CreatureModel.EnableEntityLog&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("Preload",60,"预加载实体:执行加载回调",["EntityId",t.Handle.Id],["CreatureDataId",t.CreatureDataId],["PbDataId",t.PbDataId],["Priority",t.Priority],["Order",t.Order],["Version",t.Version],["Result",i]),this.jWa.delete(t.Handle),t.InvokeCallbacks(i),t.ClearCallbacks(),WaitEntityToLoadTask.hya.Put(t)}YWa(i,t,e){const r=e??i.Version;this.jWa.has(i.Handle)&&r===i.Version&&(3===t?this.HWa(i.Handle,t=>{this.jWa.has(i.Handle)&&r===i.Version&&this.XWa(i,t)}):this.XWa(i,t))}jza(t){this.jWa.set(t.Handle,t),this.YWa(t,3)}lya(i){let e=!1,r=void 0,s=!1;const o=()=>{var t;r&&(r.Valid()&&TimerSystem_1.TimerSystem.Remove(r),r=void 0),!e&&s&&(t=ModelManager_1.ModelManager.PreloadModel.AllEntityAssetMap.get(i.CreatureDataId),Log_1.Log.CheckError())&&Log_1.Log.Error("Preload",60,"预加载实体:加载超时",["EntityId",i.Handle.Id],["CreatureDataId",i.CreatureDataId],["PbDataId",i.PbDataId],["Priority",i.Priority],["Order",i.Order],["Version",i.Version],["Remain",this.FEa.Size],["InLoading",this.QEa],["HasAssetElement",t?"Yes":"No"],["LoadState",t?t.LoadState:"None"],["CollectMinorAssets",t?t.CollectMinorAsset:"None"]),e!==s&&(this.QEa--,this.oya())};const a=i.Version;var t=t=>{e=!0,this.YWa(i,t,a),o()},_=(this.QEa++,this.jWa.set(i.Handle,i),this.nya(i.Handle,t));1!==_?t(_):r=TimerSystem_1.TimerSystem.Delay(()=>{s=!0,o()},ResourceSystem_1.ASYNC_LOAD_TIMEOUT_MS)}GEa(t){this.XEa=this.$Ea!==t,this.XEa&&(this.$Ea=t,this.WEa=t?HIGH_SPEED_MAX_LOADING_ENTITY_COUNT:NORMAL_MAX_LOADING_ENTITY_COUNT)}VEa(t){return!(!ENABLE_SUSPEND_LOADING_FOR_HIGH_SPEED_MODE||!this.$Ea)&&t>HIGH_SPEED_IGNORED_ANGLE_RATIO}_ya(){return 0<this.FEa.Size&&this.QEa<this.WEa}$Wa(){var t=this.FEa.Pop();this.HEa.delete(t.Handle),ModelManager_1.ModelManager.CreatureModel.EnableEntityLog&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("Preload",60,"预加载实体:移除加载队列",["RemoveType","InvokeTop"],["EntityId",t.Handle.Id],["CreatureDataId",t.CreatureDataId],["PbDataId",t.PbDataId],["AngleRatio",t.AngleRatio],["Priority",t.Priority],["Order",t.Order],["Version",t.Version],["Remain",this.FEa.Size]),this.lya(t)}oya(){if(!this._ya())return 1;this.uya();var t=this.FEa.Top;return this.VEa(t.AngleRatio)?(this.KEa||(ModelManager_1.ModelManager.CreatureModel.EnableEntityLog&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("Preload",60,"预加载实体:实体加载延迟检测(开始)",["EntityId",t.Handle.Id],["CreatureDataId",t.CreatureDataId],["PbDataId",t.PbDataId],["AngleRatio",t.AngleRatio],["Priority",t.Priority],["Order",t.Order],["Version",t.Version],["InLoading",this.QEa],["Remain",this.FEa.Size]),this.KEa=TimerSystem_1.TimerSystem.Forever(()=>{let t=1;for(;;)if(0!==(t=this.oya()))break;1===t&&(TimerSystem_1.TimerSystem.Remove(this.KEa),this.KEa=void 0,ModelManager_1.ModelManager.CreatureModel.EnableEntityLog)&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("Preload",60,"预加载实体:实体加载延迟检测(结束)",["InLoading",this.QEa],["Remain",this.FEa.Size])},DELAY_CHECK_HIGH_SPEED)),2):(this.$Wa(),0)}uya(){this.FEa.Size>this.WEa-this.QEa?(this.tya.Start(),(this.cya()||this.XEa)&&(this.XEa=!1,this.FEa.Heapify()),this.tya.Stop()):this.jEa.length=0}cya(){var t=ModelManager_1.ModelManager.SceneTeamModel.GetCurrentEntity?.Entity?.GetComponent(3);if(!t)return!1;this.iya.Start();let i=!1;return Vector_1.Vector.PointsAreSame(this.YEa,t.ActorLocationProxy)&&Vector_1.Vector.PointsAreSame(this.JEa,t.ActorForwardProxy)?0<this.jEa.length&&(this.jEa.forEach(t=>{t=this.HEa.get(t);t&&this.mya(t)}),this.jEa.length=0,i=!0):(this.YEa.DeepCopy(t.ActorLocationProxy),this.JEa.DeepCopy(t.ActorForwardProxy),this.JEa.AdditionEqual(PlayerVelocityController_1.PlayerVelocityController.GetAvgVelocity()).GetSafeNormal(this.zEa),this.jEa.length=0,this.HEa.forEach((t,i)=>{this.mya(t)}),i=!0),this.iya.Stop(),i}mya(t){var i=t.Handle.Entity.GetComponent(0).GetLocation(),i=(this.ZEa.DeepCopy(i),Vector_1.Vector.DistSquared(this.ZEa,this.YEa)),e=(this.YEa.Subtraction(this.ZEa,this.eya),this.eya.Normalize()?Vector_1.Vector.DotProduct(this.eya,this.zEa):-1),e=.5*e+.5;t.AngleRatio=e,t.Priority=i*e}}(exports.WaitEntityToLoadTask=WaitEntityToLoadTask).hya=new Pool_1.Pool(200,()=>new EntityHandleCallbackPair);
//# sourceMappingURL=WaitEntityToLoadTask.js.map