
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const UE=require("ue"),Log_1=require("../../../../Core/Common/Log"),ResourceSystem_1=require("../../../../Core/Resource/ResourceSystem"),TimerSystem_1=require("../../../../Core/Timer/TimerSystem"),MathUtils_1=require("../../../../Core/Utils/MathUtils"),GlobalData_1=require("../../../GlobalData"),BasePerformComponent_1=require("../../../NewWorld/Character/Common/Component/BasePerformComponent"),ServerGmController_1=require("../../../World/Controller/ServerGmController"),TsTaskAbortImmediatelyBase_1=require("./TsTaskAbortImmediatelyBase");class TsTaskPlayMontage extends TsTaskAbortImmediatelyBase_1.default{constructor(){super(...arguments),this.Montage=void 0,this.MontagePath="",this.ExpressionId=0,this.LoopDuration=0,this.RepeatTimes=0,this.KeepMontageWhenEnd=!1,this.MaskInteract=!1,this.IsInitTsVariables=!1,this.TsMontage="",this.TsMaskInteract=!1,this.IsPlayLoop=!1,this.LoopMontage=!1,this.TsLoopDuration=0,this.TsRepeatTimes=0,this.TsExpressionId=0,this.TsKeepMontageWhenEnd=!1,this.InteractComponent=void 0,this.HasAborted=!1,this.PlayingMontageId=0,this.PlayingMontage=void 0,this.Entity=void 0}Constructor(){super.Constructor(),this.IsInitTsVariables=!1,this.TsMontage="",this.TsMaskInteract=!1,this.IsPlayLoop=!1,this.LoopMontage=!1,this.TsLoopDuration=0,this.TsRepeatTimes=0,this.TsExpressionId=0,this.TsKeepMontageWhenEnd=!1,this.InteractComponent=void 0,this.HasAborted=!1,this.PlayingMontageId=0,this.PlayingMontage=void 0,this.Entity=void 0}InitTsVariables(){this.IsInitTsVariables&&!GlobalData_1.GlobalData.IsPlayInEditor||(this.IsInitTsVariables=!0,this.TsMontage=this.Montage.ToAssetPathName(),""===this.TsMontage&&(this.TsMontage=this.MontagePath),this.TsMaskInteract=this.MaskInteract,this.TsLoopDuration=this.LoopDuration,this.TsRepeatTimes=this.RepeatTimes,this.TsExpressionId=this.ExpressionId,this.TsKeepMontageWhenEnd=this.KeepMontageWhenEnd)}ReceiveExecuteAI(t,s){this.InitTsVariables();var i=t.AiController;i?(this.Entity=i.CharActorComp.Entity,ServerGmController_1.ServerGmController.AnimalDebug&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("AI",6,"AnimalDebug PlayMontage",["Tree",this.TreeAsset?.GetName()],["TsMontage",this.TsMontage]),""===this.TsMontage?(Log_1.Log.CheckWarn()&&Log_1.Log.Warn("BehaviorTree",29,"播放蒙太奇未配置",["ConfigID",this.Entity?.GetComponent(0)?.GetPbDataId()],["BehaviorTree",this.TreeAsset.GetName()]),this.FinishExecute(!0)):(this.InteractComponent=this.Entity.GetComponent(186),this.TsMaskInteract&&this.InteractComponent&&this.InteractComponent.SetInteractionState(!1,"TsTaskPlayMontage ReceiveExecuteAI"),this.IsPlayLoop=0!==this.TsLoopDuration,this.LoopMontage=-1===this.TsLoopDuration||-1===this.TsRepeatTimes,this.HasAborted=!1,this.TsKeepMontageWhenEnd?this.PlayMontageKeepEnd():this.PlayMontageByPerformComp())):(Log_1.Log.CheckError()&&Log_1.Log.Error("BehaviorTree",29,"错误的Controller类型",["Type",t.GetClass().GetName()]),this.FinishExecute(!0))}OnAbort(){this.TsMaskInteract&&this.InteractComponent&&this.InteractComponent.SetInteractionState(!0,"TsTaskPlayMontage OnClear"),this.InteractComponent=void 0,this.HasAborted=!0,this.TsKeepMontageWhenEnd?this.StopMontageKeepEnd():(this.Entity?.GetComponent(40))?.ClearAndStopMontage(this.PlayingMontageId)}PlayMontageByPerformComp(){var t=ServerGmController_1.ServerGmController.AnimalDebug,s=this.Entity.GetComponent(40),i=new BasePerformComponent_1.PlayMontageConfig(this.RepeatTimes,this.LoopDuration,this.IsPlayLoop,this.LoopMontage);this.PlayingMontageId=s.LoadAndPlayMontage(this.TsMontage,i,t=>{this.TsExpressionId&&t?.BodyMontage?.IsValid()&&(this.Entity?.GetComponent(176))?.ExpressionController?.ChangeFaceForExpression(t.BodyMontage,this.TsExpressionId)},()=>{ServerGmController_1.ServerGmController.AnimalDebug&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("AI",6,"AnimalDebug PlayMontage3",["HasAborted",this.HasAborted]),this.HasAborted||this.FinishExecute(!0)},()=>(ServerGmController_1.ServerGmController.AnimalDebug&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("AI",6,"AnimalDebug PlayMontage4"),!this.HasAborted)),t&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("AI",6,"AnimalDebug PlayMontage2",["PlayingMontageId",this.PlayingMontageId]),this.PlayingMontageId<0&&this.FinishExecute(!0)}PlayMontageKeepEnd(){const o=this.Entity.GetComponent(38);o?ResourceSystem_1.ResourceSystem.LoadAsync(this.TsMontage,UE.AnimMontage,i=>{if(i?.IsValid())if(o?.MainAnimInstance){if(!this.HasAborted){var e=i.SequenceLength*MathUtils_1.MathUtils.SecondToMillisecond,h=new BasePerformComponent_1.PlayMontageConfig(this.RepeatTimes,this.LoopDuration,this.IsPlayLoop,this.LoopMontage);h.CalculatePlayTime(e);let t=h.PlayMontageTime;var e=o.MainAnimInstance.GetCurrentActiveMontage();e?.IsValid()&&e===i?(e=o.MainAnimInstance.Montage_GetPosition(i),o.MainAnimInstance.Montage_Play(i,void 0,void 0,e,!1),t=Math.max(t-e*MathUtils_1.MathUtils.SecondToMillisecond,TimerSystem_1.MIN_TIME)):o.MainAnimInstance.Montage_Play(i);let s=void 0;o.UpdateLoopState(i,!0),h.IsInfiniteLoop||(s=TimerSystem_1.TimerSystem.Delay(()=>{o?.MainAnimInstance?.GetCurrentActiveMontage()===i&&o.StopMontageForLoopState(i),o.CurMontageTimerHandle=void 0,this.HasAborted||this.Finish(!0)},t))?(this.TsExpressionId&&(o?.Entity?.GetComponent(176))?.ExpressionController?.ChangeFaceForExpression(i,this.TsExpressionId),(e=o.CurMontageTimerHandle)&&TimerSystem_1.TimerSystem.Remove(e),o.CurMontageTimerHandle=s,this.PlayingMontage=i):this.Finish(!0)}}else this.Finish(!0);else this.Finish(!0)}):this.Finish(!0)}StopMontageKeepEnd(){var t;this.PlayingMontage?.IsValid()&&(t=this.Entity?.GetComponent(38))&&t.MainAnimInstance?.GetCurrentActiveMontage()===this.PlayingMontage&&(t.StopMontageForLoopState(this.PlayingMontage,!1),t.CurMontageTimerHandle=void 0)}}exports.default=TsTaskPlayMontage;
//# sourceMappingURL=TsTaskPlayMontage.js.map