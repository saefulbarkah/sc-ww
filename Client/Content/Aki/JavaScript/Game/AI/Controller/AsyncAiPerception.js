
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AsyncAiPerception=void 0;const cpp_1=require("cpp"),UE=require("ue"),Log_1=require("../../../Core/Common/Log"),Stats_1=require("../../../Core/Common/Stats"),Time_1=require("../../../Core/Common/Time"),EntitySystem_1=require("../../../Core/Entity/EntitySystem"),JsModelManager_1=require("../../../Core/Model/JsModelManager"),TickProcessSystem_1=require("../../../Core/Tick/TickProcessSystem"),Vector_1=require("../../../Core/Utils/Math/Vector"),EventDefine_1=require("../../Common/Event/EventDefine"),EventSystem_1=require("../../Common/Event/EventSystem"),ConfigManager_1=require("../../Manager/ConfigManager"),ModelManager_1=require("../../Manager/ModelManager"),CampUtils_1=require("../../NewWorld/Character/Common/Blueprint/Utils/CampUtils"),CombatLog_1=require("../../Utils/CombatLog"),ServerGmController_1=require("../../World/Controller/ServerGmController"),MINUS_HALF=-180,MINUS_QUATER=-90;class AiSenseObject{constructor(t){this.AiSense=t,this.AiSenseObjectData=new cpp_1.FAiSenseObject,this.AiSenseObjectData.AiSenseId=t.Id,this.AiSenseObjectData.AiSenseHorizontalAngle=new UE.Vector2D(t.HorizontalAngle.Min,t.HorizontalAngle.Max),this.AiSenseObjectData.AiSenseVerticalAngle=new UE.Vector2D(t.VerticalAngle.Min,t.VerticalAngle.Max),this.AiSenseObjectData.AiSenseCantBeBlock=t.CantBeBlock,this.AiSenseObjectData.AiSenseBlockType=t.BlockType,this.AiSenseObjectData.WithAngleHorizontal=t.HorizontalAngle.Min>MINUS_HALF||t.HorizontalAngle.Max<180,this.AiSenseObjectData.WithAngleVertical=t.VerticalAngle.Min>MINUS_QUATER||t.VerticalAngle.Max<90,this.AiSenseObjectData.SenseDistanceRangeMin=t.SenseDistanceRange.Min,this.AiSenseObjectData.SenseDistanceRangeMax=t.SenseDistanceRange.Max,this.AiSenseObjectData.SquaredWalkSenseRate=t.WalkSenseRate*t.WalkSenseRate,this.AiSenseObjectData.SquaredAirSenseRate=t.AirSenseRate*t.AirSenseRate}}class AsyncAiPerception{constructor(t,i,s){this.Bte=t,this.AiSenseGroup=i,this.AiPerceptionData=void 0,this.Allies=new Set,this.Enemies=new Set,this.Neutrals=new Set,this.SceneItems=new Set,this.AllEnemies=new Set,this.ShareAllyLink=new Set,this.voe=new Set,this.Moe=new Set,this.Eoe=new Set,this.f6=new Array,this.VWl=void 0,this.jWl=void 0,this.HWl=void 0,this.yoe=void 0,this.Ioe=[],this.Loe=new Array,this.Doe=new Map,this.MaxSenseRange=0,this.Poe=!1,this._tl=!1,this.NQl=t=>{if(this.AiPerceptionData&&this.Poe){var i=this.VWl.Num();for(let t=0;t<i;t++){var s=this.VWl.GetKey(t);s!==this.E0&&(s=EntitySystem_1.EntitySystem.Get(s))&&this.Voe(s,!1)}this.Allies.clear(),this.Enemies.clear(),this.Neutrals.clear(),this.AllEnemies.clear(),this.VWl.Empty(),this.VWl.Add(this.E0,0)}},this.VQl=t=>{this.AiPerceptionData&&(this.VWl.Empty(),this.VWl.Add(this.E0,0),this.jWl.Empty())},this.d3r=-1;var e=t.CharActorComp?.CreatureData;this._tl=122000237===e?.GetPbDataId()||24000053===e?.GetPbDataId(),this.E0=t.CharActorComp.Entity.Id,this.AiPerceptionData=JsModelManager_1.JsModelManager.AddAiPerception(this.E0),this.AiPerceptionData.MingZhongZhiGuiLog=this.tha,this.AiPerceptionData.AiSenseGroupLoseDelayRange=new UE.Vector2D(i.LoseDelay.Min,i.LoseDelay.Max),this.VWl=this.AiPerceptionData.EntitiesInSense,this.jWl=this.AiPerceptionData.EntitiesToAdd,this.yoe=this.AiPerceptionData.EntitiesRemoveTime,this.HWl=this.AiPerceptionData.EntitiesNotSense,this.Noe=t.CharActorComp.Actor.Camp,this.VWl.Add(this.E0,0);let h=-1;for(const n of s){var r=new AiSenseObject(n);this.Loe.push(r),0<++h||(this.tha&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("AI",6,"EnableAiSense Init",["Actor",this.Bte.CharActorComp.Actor.GetName()],["AiSenseObject",r.AiSense.Id]),r.AiSenseObjectData.WithAngleHorizontal&&++this.AiPerceptionData.WithAngleHorizontalCount,r.AiSenseObjectData.WithAngleVertical&&++this.AiPerceptionData.WithAngleVerticalCount,n.SenseDistanceRange.Max>this.MaxSenseRange&&(this.MaxSenseRange=n.SenseDistanceRange.Max),this.AiPerceptionData.ActivateAiSenseObjects.Get(r.AiSense.SenseTarget)?.Add(r.AiSenseObjectData))}this.Ooe=i?i.ShareDis*i.ShareDis:0}get tha(){return this._tl&&ServerGmController_1.ServerGmController.MingzhongzhiguiDebug}GetEnableAiSenseDebug(){let i="感知配置激活情况: ";for(let t=0;t<this.Loe.length;++t){var s=this.Loe[t],e=this.Loe[t].AiSense.Id,s=this.AiPerceptionData.ActivateAiSenseObjects.Get(s.AiSense.SenseTarget).Contains(s.AiSenseObjectData);i+=e+":"+s+"; "}return i}Foe(t,i){var s=this.AiPerceptionData.ActivateAiSenseObjects.Get(t.AiSense.SenseTarget);s.Contains(t.AiSenseObjectData)!==i&&(Log_1.Log.CheckInfo()&&Log_1.Log.Info("AI",6,"EnableAiSense",["Actor",this.Bte.CharActorComp.Actor.GetName()],["AiSenseObject",t.AiSense.Id],["enable",i]),i?(t.AiSenseObjectData.WithAngleHorizontal&&++this.AiPerceptionData.WithAngleHorizontalCount,t.AiSenseObjectData.WithAngleVertical&&++this.AiPerceptionData.WithAngleVerticalCount,s.Add(t.AiSenseObjectData)):(t.AiSenseObjectData.WithAngleHorizontal&&--this.AiPerceptionData.WithAngleHorizontalCount,t.AiSenseObjectData.WithAngleVertical&&--this.AiPerceptionData.WithAngleVerticalCount,-1<(i=s.FindIndex(t.AiSenseObjectData))&&s.RemoveAt(i)))}SetAiSenseEnable(t,i){t<0||this.Loe.length<=t||this.Foe(this.Loe[t],i)}SetAllAiSenseEnable(t){t||TickProcessSystem_1.TickProcessSystem.RegisterOnceTickProcess(6,!0,this.NQl),this.Poe=!t,CombatLog_1.CombatLog.Info("Ai",this.Bte.CharActorComp?.Entity,"禁用全部感知",["forbid",this.Poe])}AddOrRemoveAiSense(t,i){i&&!this.Doe.has(t)&&(s=ConfigManager_1.ConfigManager.AiConfig.LoadAiSense(t.toString()))&&this.Doe.set(t,new AiSenseObject(s));var s=this.Doe.get(t);s&&this.Foe(s,i)}EnableAiSenseByType(t,i){for(const e of this.Loe)e.AiSense.SenseType===t&&this.Foe(e,i);for(var[,s]of this.Doe)s.AiSense.SenseType===t&&this.Foe(s,i)}Clear(t=!0){this.Allies.clear(),this.Enemies.clear(),this.Neutrals.clear(),this.SceneItems.clear(),this.AllEnemies.clear(),this.f6.length=0,t?(this.Ioe.length=0,this.AiPerceptionData&&(JsModelManager_1.JsModelManager.RemoveAiPerception(this.AiPerceptionData.Handle),this.AiPerceptionData=void 0)):TickProcessSystem_1.TickProcessSystem.RegisterOnceTickProcess(6,!0,this.VQl)}Tick(){Time_1.Time.Frame!==Time_1.Time.LastPauseTimeFrame&&Time_1.Time.Frame!==Time_1.Time.LastResumeTimeFrame&&Time_1.Time.Frame!==Time_1.Time.LastResumeTimeFrame+1&&this.Bte.CharActorComp?.Valid&&(this.AiSenseGroup?this.Poe||(this.d3r===Time_1.Time.Frame?Log_1.Log.CheckInfo()&&Log_1.Log.Info("AI",36,"[AsyncAiPerception::Tick] Execute twice or more in one frame. Error!!!!"):(this.d3r=Time_1.Time.Frame,this.WWl())):this.Koe())}WWl(){var t;this.AiPerceptionData&&(t={AiPerceptionHandle:this.AiPerceptionData.Handle},global.startAsyncTask("Task/AiPerceptionTask",t,t=>{this.QWl()},!0))}QWl(){if(this.AiPerceptionData){let i=this.VWl.Num();for(let t=i-1;-1<t;t--){var s,e=this.VWl.GetKey(t);e===this.E0||(s=EntitySystem_1.EntitySystem.Get(e))?.Valid&&s.Active||(this.VWl.Remove(e),this.yoe.Remove(e),this.Allies.delete(e)&&this.Bte.AiPerceptionEvents.CollectAiRemovePerceptionEventByEntityId(!1,e,1),this.Enemies.delete(e)&&this.Bte.AiPerceptionEvents.CollectAiRemovePerceptionEventByEntityId(!1,e,2),this.Neutrals.delete(e)&&this.Bte.AiPerceptionEvents.CollectAiRemovePerceptionEventByEntityId(!1,e,0),this.SceneItems.delete(e))}i=this.HWl.Num();for(let t=0;t<i;t++){var h=this.HWl.Get(t),h=EntitySystem_1.EntitySystem.Get(h);h?.Valid&&this.Voe(h,!1)}this.HWl.Empty(),i=this.jWl.Num();for(let t=0;t<i;t++){var r=this.jWl.GetKey(t),n=this.jWl.Get(r);void 0!==n&&(this.VWl.Set(r,n),(n=EntitySystem_1.EntitySystem.Get(r))?.Valid)&&this.Voe(n,!0)}this.jWl.Empty(),this.Woe(),this.Koe()}}Voe(i,s){var e=i.Id,i=i.GetComponent(3);if(i?.Valid){var h=CampUtils_1.CampUtils.GetCampRelationship(this.Noe,i.Actor.Camp);let t=void 0;switch(h){case 1:t=this.Allies;break;case 2:t=this.Enemies;break;default:t=this.Neutrals}s?t.has(e)||(t.add(e),this.Bte.AiPerceptionEvents.CollectAiPerceptionEventByActorComp(!0,i,h),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnAiSenseEntityEnter,this.E0,i.Entity)):t.delete(e)&&(this.Bte.AiPerceptionEvents.CollectAiPerceptionEventByActorComp(!1,i,h),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnAiSenseEntityLeave,this.E0,i.Entity))}else s?this.SceneItems.has(e)||(this.SceneItems.add(e),this.Bte.AiPerceptionEvents.OnSenseSceneItem(i)):this.SceneItems.delete(e)}Woe(){if(!(this.AiSenseGroup.ShareDis<=0)){var t,i,s=this.Bte.CharActorComp.ActorLocationProxy,e=(ModelManager_1.ModelManager.CreatureModel.GetEntitiesInRangeWithLocation(s,this.AiSenseGroup.ShareDis,62,this.Ioe),this.voe.clear(),this.voe.add(this.E0),this.Bte.CharActorComp.Actor.Camp);for(const r of this.Ioe)!r.Entity?.Active||this.voe.has(r.Entity.Id)||!(t=r.Entity.GetComponent(3))?.Valid||e!==t.Actor.Camp||Vector_1.Vector.DistSquared(s,t.ActorLocationProxy)>this.Ooe||(this.voe.add(r.Entity.Id),this.ShareAllyLink.has(r.Entity.Id))||(t=r.Entity.GetComponent(41))?.Valid&&t.AiController.AiPerception?.Moe.add(this.E0);for(const n of this.ShareAllyLink)this.voe.has(n)||(i=EntitySystem_1.EntitySystem.Get(n))?.Valid&&(i=i.GetComponent(41))?.Valid&&i.AiController.AiPerception?.Moe.delete(this.E0);var h=this.voe;this.voe=this.ShareAllyLink,this.ShareAllyLink=h}}Koe(){this.AllEnemies.clear();for(const i of this.Enemies)this.AllEnemies.add(i);this.Eoe.clear(),this.f6.length=0,this.Eoe.add(this.E0);for(const s of this.Moe)this.f6.push(s),this.Eoe.add(s);for(;0<this.f6.length;){var t=this.f6.pop(),t=EntitySystem_1.EntitySystem.Get(t);if(t?.Valid){t=t.GetComponent(41);if(t?.Valid&&t.AiController.AiPerception){for(const e of t.AiController.AiPerception.Enemies)this.AllEnemies.add(e);for(const h of t.AiController.AiPerception.Moe)this.Eoe.has(h)||(this.Eoe.add(h),this.f6.push(h))}}}}}(exports.AsyncAiPerception=AsyncAiPerception).KWl=Stats_1.Stat.Create("AsyncAiPerception.AfterAsyncTask"),AsyncAiPerception.boe=Stats_1.Stat.Create("AsyncAiPerception.SenseActor"),AsyncAiPerception.qoe=Stats_1.Stat.Create("AsyncAiPerception.FindShareAlly"),AsyncAiPerception.Goe=Stats_1.Stat.Create("AsyncAiPerception.RefreshAllEnemies");
//# sourceMappingURL=AsyncAiPerception.js.map