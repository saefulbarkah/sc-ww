
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CharMaterialControllerV2=void 0;const Log_1=require("../../../../../Core/Common/Log"),Stats_1=require("../../../../../Core/Common/Stats"),RenderConfig_1=require("../../../Config/RenderConfig"),CharRenderBase_1=require("../../Manager/CharRenderBase");class CharMaterialControllerHandle{constructor(){this.HandleId=0,this.UserData=void 0,this.AssetData=void 0,this.ExtraMeshBodyName=void 0}}class CharMaterialControllerV2 extends CharRenderBase_1.CharRenderBase{constructor(){super(...arguments),this.Uhr=void 0,this.Mel=void 0,this.Sel=new Map}GetStatName(){return"CharMaterialControllerV2"}Start(){this.Uhr=this.GetRenderingComponent().GetComponent(RenderConfig_1.RenderConfig.IdMaterialContainerV2),this.Uhr.AddEffectFinishCallback(e=>{this.yel(e)});var e=this.RenderComponent.GetComponent(RenderConfig_1.RenderConfig.IdExtraMesh);this.Mel=e,this.OnInitSuccess()}GetEffectCount(){return this.Sel.size}GetRuntimeMaterialControllerValid(e){return this.Sel.has(e)}SetEffectProgress(e,t){this.Sel.has(t)&&this.Uhr?.SetEffectProgress(t,e)}AddMaterialControllerData(e,t,r){var a,i,s,n=Stats_1.Stat.CreateNoFlameGraph("CharMaterialControllerV2_AddData_"+e.GetName()),o=(n.Start(),new CharMaterialControllerHandle);return this.DealWithExtraMesh(e,o)?(s=1===e.DataType,a=2===e.DataType,i=e.HiddenAfterEffect,s=this.Uhr.AddEffect(e,s,a,r,i),o.HandleId=s,o.UserData=t,o.AssetData=e,this.Sel.set(s,o),Log_1.Log.CheckInfo()&&Log_1.Log.Info("RenderCharacter",25,"添加材质控制器",["IdentifyName",this.Uhr.IdentifyName],["AssetData",e.GetName()],["Handle",s]),n.Stop(),s):-1}RemoveMaterialControllerData(e){var t=this.Sel.get(e);return!!t&&(this.Uhr?.RemoveEffect(e),Log_1.Log.CheckInfo()&&Log_1.Log.Info("RenderCharacter",25,"直接移除材质控制器",["IdentifyName",this.Uhr.IdentifyName],["AssetData",t.AssetData?.GetName()],["Handle",e]),!0)}RemoveMaterialControllerDataWithEnding(e){var t=this.Sel.get(e);return!!t&&(this.Uhr?.SetEffectLoop(e,!1),this.Uhr?.SetEffectPause(e,!1),Log_1.Log.CheckInfo()&&Log_1.Log.Info("RenderCharacter",25,"移除材质控制器WithEnding",["IdentifyName",this.Uhr.IdentifyName],["AssetData",t.AssetData?.GetName()],["Handle",e]),!0)}OnResetRenderState(){this.Sel.clear()}yel(e){var t=this.Sel.get(e);t&&(this.Sel.delete(e),t.ExtraMeshBodyName&&this.Mel?.RemoveExtraSkeletalMeshUsage(t.ExtraMeshBodyName),Log_1.Log.CheckInfo())&&Log_1.Log.Info("RenderCharacter",25,"自动移除材质控制器",["IdentifyName",this.Uhr.IdentifyName],["AssetData",t.AssetData?.GetName()],["Handle",e])}DealWithExtraMesh(e,t){if(6===e.SpecifiedBodyType){if(!this.Mel)return Log_1.Log.CheckError()&&Log_1.Log.Error("RenderCharacter",25,"材质控制器添加失败，ExtraMesh不存在",["Actor",this.GetRenderingComponent().GetOwner().GetName()],["添加的材质控制器名称",e.GetName()]),!1;if(1!==e.MaterialModifyType)return Log_1.Log.CheckError()&&Log_1.Log.Error("RenderCharacter",25,"材质控制器添加失败，ExtraMesh只支持材质替换",["Actor",this.GetRenderingComponent().GetOwner().GetName()],["添加的材质控制器名称",e.GetName()]),!1;if(6!==e.SpecifiedBodyType)return!1;e=RenderConfig_1.RenderConfig.GetBodyNamesByBodyType(1)[0];this.Mel.EnsureExtraMesh(e),this.Mel.AddExtraSkeletalMeshUsage(e),t.ExtraMeshBodyName=e}return!0}Update(){}LateUpdate(){}Destroy(){}GetComponentId(){return RenderConfig_1.RenderConfig.IdMaterialControllerV2}}exports.CharMaterialControllerV2=CharMaterialControllerV2;
//# sourceMappingURL=CharMaterialControllerV2.js.map