
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PlayerInputHandle=void 0;const Info_1=require("../../Core/Common/Info"),Log_1=require("../../Core/Common/Log"),Vector_1=require("../../Core/Utils/Math/Vector"),EventDefine_1=require("../Common/Event/EventDefine"),EventSystem_1=require("../Common/Event/EventSystem"),InputSettings_1=require("../InputSettings/InputSettings"),ControllerHolder_1=require("../Manager/ControllerHolder"),ModelManager_1=require("../Manager/ModelManager"),LguiEventSystemManager_1=require("../Ui/LguiEventSystem/LguiEventSystemManager"),TouchFingerManager_1=require("../Ui/TouchFinger/TouchFingerManager"),CombinationActionHandle_1=require("./CombinationActionHandle"),CombinationAxisHandle_1=require("./CombinationAxisHandle");class PlayerInputHandle{constructor(){this.Zde=new Map,this.IsPrintKeyName=!1,this.eCe=void 0,this.tCe=void 0,this.wDa=new Map,this.JQa=new Map,this.l$a=new Map,this._$a=new Set,this.ZQa=!1,this.QJa=!1,this.fZt=t=>{this.ZQa!==t&&(this.ZQa=t)&&(this.QJa=!0)},this.iK_=()=>{Log_1.Log.CheckInfo()&&Log_1.Log.Info("MobileInputSwitch",10,"手柄断开,清理输入缓存");for(const t of this.wDa)ControllerHolder_1.ControllerHolder.InputDistributeController.InputAxis(t[0],0);this.wDa.clear();for(const e of this.JQa)ControllerHolder_1.ControllerHolder.InputDistributeController.InputAxis(e[0],0);this.JQa.clear()}}Initialize(){this.eCe=new CombinationActionHandle_1.CombinationActionHandle,this.tCe=new CombinationAxisHandle_1.CombinationAxisHandle,Info_1.Info.AxisInputOptimize&&EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnShowMouseCursor,this.fZt),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.MobileGamepadDisconnect,this.iK_)}Clear(){this.eCe.Clear(),this.eCe=void 0,this.tCe.Clear(),this.tCe=void 0,this.wDa.clear(),this.l$a?.clear(),this.l$a=void 0,this._$a?.clear(),this._$a=void 0,Info_1.Info.AxisInputOptimize&&EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnShowMouseCursor,this.fZt),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.MobileGamepadDisconnect,this.iK_)}Tick(t){if(this.tCe?.Tick(t),Info_1.Info.AxisInputOptimize)if(this.QJa){this.QJa=!1;for(const e of this.wDa)ControllerHolder_1.ControllerHolder.InputDistributeController.InputAxis(e[0],0);for(const o of this.JQa)ControllerHolder_1.ControllerHolder.InputDistributeController.InputAxis(o[0],0)}else{for(const n of this.wDa)ControllerHolder_1.ControllerHolder.InputDistributeController.InputAxis(n[0],n[1]);if(ModelManager_1.ModelManager.InputModel.LastClearAxisValue){for(const i of this.JQa)ControllerHolder_1.ControllerHolder.InputDistributeController.InputAxis(i[0],i[1],!0);ModelManager_1.ModelManager.InputModel.ResetLastTemporaryClearAxisValues()}}}InputAction(t,e,o){this.u$a(t)&&(o=o.KeyName.toString(),this.c$a(o))&&this.iCe(o)&&(this.m$a(t)?ControllerHolder_1.ControllerHolder.InputDistributeController.InputAction(t,e):this.yF_(t,e))}InputAxis(t,e,o=!1){Info_1.Info.IsMobileInputModel()&&Info_1.Info.IsInTouch()||(Info_1.Info.AxisInputOptimize?o?this.wDa.set(t,e):(this.JQa.set(t,e),ControllerHolder_1.ControllerHolder.InputDistributeController.InputAxis(t,e)):ControllerHolder_1.ControllerHolder.InputDistributeController.InputAxis(t,e))}TouchBegin(t,e){var t=Number(t),o={TouchType:0,TouchId:t,TouchPosition:this.oCe(t,e)};TouchFingerManager_1.TouchFingerManager.StartTouch(t,e),LguiEventSystemManager_1.LguiEventSystemManager.InputTouchTrigger(!0,t,e),ControllerHolder_1.ControllerHolder.InputDistributeController.InputTouch(t,o)}TouchEnd(t,e){var t=Number(t),o={TouchType:1,TouchId:t,TouchPosition:this.oCe(t,e)};TouchFingerManager_1.TouchFingerManager.EndTouch(t),LguiEventSystemManager_1.LguiEventSystemManager.InputTouchTrigger(!1,t,e),ControllerHolder_1.ControllerHolder.InputDistributeController.InputTouch(t,o)}TouchMove(t,e){var t=Number(t),o={TouchType:2,TouchId:t,TouchPosition:this.oCe(t,e)};TouchFingerManager_1.TouchFingerManager.MoveTouch(t,e),LguiEventSystemManager_1.LguiEventSystemManager.InputLguiTouchMove(t,e),ControllerHolder_1.ControllerHolder.InputDistributeController.InputTouch(t,o)}PressAnyKey(t){var e;Info_1.Info.IsMobileInputModel()&&Info_1.Info.IsInTouch()&&ModelManager_1.ModelManager.PlatformModel?.IsKeyFromGamepadKey(t.KeyName.toString())||(e=t.KeyName.toString(),this.eCe.PressAnyKey(e),this.tCe.PressAnyKey(e),this.d$a(e,!0),this.IsPrintKeyName&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("InputSettings",10,"按下按键",["KeyName",e]),ControllerHolder_1.ControllerHolder.InputDistributeController.InputKey(e,!0),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnInputAnyKey,!0,t))}ReleaseAnyKey(t){var e;Info_1.Info.IsMobileInputModel()&&Info_1.Info.IsInTouch()&&ModelManager_1.ModelManager.PlatformModel?.IsKeyFromGamepadKey(t.KeyName.toString())||(e=t.KeyName.toString(),this.eCe.ReleaseAnyKey(e),this.tCe.ReleaseAnyKey(e),this.d$a(e,!1),this.IsPrintKeyName&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("InputSettings",10,"抬起按键",["KeyName",e]),ControllerHolder_1.ControllerHolder.InputDistributeController.InputKey(e,!1),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnInputAnyKey,!1,t))}d$a(t,e){var o=this.C$a(t);if(o&&this.c$a(t)&&this.iCe(t))for(const n of o){if(!this.m$a(n)&&e)return;ControllerHolder_1.ControllerHolder.InputDistributeController.InputAction(n,e)}}c$a(t){if(Info_1.Info.IsMobileInputModel()){if(InputSettings_1.InputSettings.IsKeyboardKey(t)||InputSettings_1.InputSettings.IsMouseButton(t))return!1;if(Info_1.Info.IsInTouch()&&ModelManager_1.ModelManager.PlatformModel?.IsKeyFromGamepadKey(t))return!1;if(Info_1.Info.IsInGamepad()&&!ModelManager_1.ModelManager.PlatformModel?.IsKeyFromGamepadKey(t))return!1}return!0}m$a(t){return this.eCe.CheckCombinationAction(t)}yF_(t,e){e||ModelManager_1.ModelManager.InputDistributeModel.IsActionInPress(t)&&ControllerHolder_1.ControllerHolder.InputDistributeController.InputAction(t,!1)}rCe(t){return this.Zde.get(t)}oCe(t,e){var o=this.rCe(t);return o?(o.Set(e.X,e.Y,e.Z),o):this.nCe(t,e)}nCe(t,e){e=Vector_1.Vector.Create(e);return this.Zde.set(t,e),e}iCe(t){return!!Info_1.Info.IsGmLockGamepad||!(Info_1.Info.IsInGamepad()&&InputSettings_1.InputSettings.IsKeyboardKey(t)||Info_1.Info.IsInKeyBoard()&&InputSettings_1.InputSettings.IsGamepadKey(t))}SetCustomAction(t,e){let o=this.l$a?.get(t);o||(o=new Set,this.l$a?.set(t,o)),o.add(e),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("InputSettings",10,"[CustomAction]设置临时Action输入按键",["keyName",t],["actionName",e],["CustomKeyActionMap",this.l$a])}ResetAllCustomAction(t){this.d$a(t,!1),this.l$a?.delete(t),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("InputSettings",10,"[CustomAction]还原所有临时Action输入按键",["keyName",t],["CustomKeyActionMap",this.l$a])}ResetCustomAction(t,e){var o=this.l$a?.get(t);o&&(o.delete(e),Log_1.Log.CheckDebug())&&Log_1.Log.Debug("InputSettings",10,"[CustomAction]还原临时Action输入按键",["keyName",t],["CustomKeyActionMap",this.l$a])}C$a(t){t=this.l$a?.get(t);if(t)return t}GetCurrentPlatformCustomActionKeyNameList(t){if(this.l$a){var e,o,n=Info_1.Info.IsInKeyBoard(),i=Info_1.Info.IsInGamepad(),r=[];for([e,o]of this.l$a)o.has(t)&&(n&&InputSettings_1.InputSettings.IsKeyboardKey(e)||i&&InputSettings_1.InputSettings.IsGamepadKey(e))&&r.push(e);if(!(r.length<=0))return r}}SetActionEnable(t,e){e?this._$a?.delete(t):this._$a?.add(t)}u$a(t){return!this._$a?.has(t)}}exports.PlayerInputHandle=PlayerInputHandle;
//# sourceMappingURL=PlayerInputHandle.js.map