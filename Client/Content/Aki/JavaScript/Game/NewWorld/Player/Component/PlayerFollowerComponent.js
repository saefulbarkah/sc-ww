
"use strict";var __decorate=this&&this.__decorate||function(t,e,o,i){var r,s=arguments.length,n=s<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,o,i);else for(var l=t.length-1;0<=l;l--)(r=t[l])&&(n=(s<3?r(n):3<s?r(e,o,n):r(e,o))||n);return 3<s&&n&&Object.defineProperty(e,o,n),n};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PlayerFollowerComponent=void 0;const Log_1=require("../../../../Core/Common/Log"),Protocol_1=require("../../../../Core/Define/Net/Protocol"),EntityComponent_1=require("../../../../Core/Entity/EntityComponent"),RegisterComponent_1=require("../../../../Core/Entity/RegisterComponent"),MathUtils_1=require("../../../../Core/Utils/MathUtils"),EventDefine_1=require("../../../Common/Event/EventDefine"),EventSystem_1=require("../../../Common/Event/EventSystem"),ModelManager_1=require("../../../Manager/ModelManager"),WaitEntityTask_1=require("../../../World/Define/WaitEntityTask");let PlayerFollowerComponent=class PlayerFollowerComponent extends EntityComponent_1.EntityComponent{constructor(){super(...arguments),this.j8=0,this.qHa=new Map,this.qeh=0,this.OHa=void 0,this.GHa=void 0,this.kHa=void 0}OnInitData(){var t=this.Entity.CheckGetComponent(0),t=(this.j8=t?.GetPlayerId()??0,t?.ComponentDataMap.get("jr1")?.jr1?.yo1);return t&&this.UpdateFollowers(t),!0}OnClear(){return this.j8=0,this.NHa(),this.qHa.clear(),!0}UpdateFollowers(t){for(const s of t){let t=void 0;switch(s.h5n){case Protocol_1.Aki.Protocol.Summon.tJs.Proto_EPlayerFollowerExploreSkill:t=100;break;case Protocol_1.Aki.Protocol.Summon.tJs.Proto_EPlayerFollowerAuxiliary:t=101}var e;t?(e=MathUtils_1.MathUtils.LongToNumber(s.F4n))<=0?this.qHa.delete(t):this.qHa.set(t,e):Log_1.Log.CheckWarn()&&Log_1.Log.Warn("Battle",48,"Follower类型异常",["Type",s.h5n])}var o,i,r=[-1,0];for([o,i]of this.qHa)o>r[0]&&(r[0]=o,r[1]=i);r[0]<0?this.NHa():(t=r[1])!==this.qeh&&(this.NHa(),this.qeh=t,this.FHa())}OnFollowerAdd(t){t===this.qeh&&this.FHa()}FHa(){const e=this.qeh,o=ModelManager_1.ModelManager.CreatureModel.GetEntity(e);o?.Valid&&o.Id!==this.OHa?.Id&&(this.kHa?.Cancel(),this.kHa=void 0,o.IsInit?this.hGl(e,o):this.kHa=WaitEntityTask_1.WaitEntityTask.Create(e,t=>{t&&this.hGl(e,o)},-1))}async hGl(t,e){var o=e.Entity?.GetComponent(210);o&&(await o.LoadConfigPromise?.Promise,e.Valid)&&t===this.qeh&&(this.OHa=e,this.GHa=o,this.j8===ModelManager_1.ModelManager.CreatureModel.GetPlayerId())&&(o.Possess(),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnPlayerFollowerCreate,e))}NHa(){this.kHa?.Cancel(),this.kHa=void 0,this.GHa&&this.j8===ModelManager_1.ModelManager.CreatureModel.GetPlayerId()&&(this.GHa.UnPossess(),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnPlayerFollowerDestroy)),this.qeh=0,this.OHa=void 0,this.GHa=void 0}SetFollowerEnable(t){this.GHa?.SetEnable(t)}GetFollower(){return this.OHa}IsFollowerEnable(){return this.GHa?.IsEnable??!1}};PlayerFollowerComponent=__decorate([(0,RegisterComponent_1.RegisterComponent)(212)],PlayerFollowerComponent),exports.PlayerFollowerComponent=PlayerFollowerComponent;
//# sourceMappingURL=PlayerFollowerComponent.js.map