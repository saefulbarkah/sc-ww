
"use strict";var __decorate=this&&this.__decorate||function(e,t,o,i){var r,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,o,i);else for(var l=e.length-1;0<=l;l--)(r=e[l])&&(n=(s<3?r(n):3<s?r(t,o,n):r(t,o))||n);return 3<s&&n&&Object.defineProperty(t,o,n),n};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PlayerFollowerComponent=void 0;const Log_1=require("../../../../Core/Common/Log"),Protocol_1=require("../../../../Core/Define/Net/Protocol"),EntityComponent_1=require("../../../../Core/Entity/EntityComponent"),RegisterComponent_1=require("../../../../Core/Entity/RegisterComponent"),MathUtils_1=require("../../../../Core/Utils/MathUtils"),EventDefine_1=require("../../../Common/Event/EventDefine"),EventSystem_1=require("../../../Common/Event/EventSystem"),ModelManager_1=require("../../../Manager/ModelManager"),WaitEntityTask_1=require("../../../World/Define/WaitEntityTask");let PlayerFollowerComponent=class PlayerFollowerComponent extends EntityComponent_1.EntityComponent{constructor(){super(...arguments),this.j8=0,this.MWa=new Map,this.heh=0,this.SWa=void 0,this.yWa=void 0,this.EWa=void 0}OnInitData(){var e=this.Entity.CheckGetComponent(0),e=(this.j8=e?.GetPlayerId()??0,e?.ComponentDataMap.get("hEl")?.hEl?.IEl);return e&&this.UpdateFollowers(e),!0}OnClear(){return this.j8=0,this.IWa(),this.MWa.clear(),!0}UpdateFollowers(e){for(const s of e){let e=void 0;switch(s.h5n){case Protocol_1.Aki.Protocol.Summon.tJs.Proto_EPlayerFollowerExploreSkill:e=100;break;case Protocol_1.Aki.Protocol.Summon.tJs.Proto_EPlayerFollowerAuxiliary:e=101}var t;e?(t=MathUtils_1.MathUtils.LongToNumber(s.F4n))<=0?this.MWa.delete(e):this.MWa.set(e,t):Log_1.Log.CheckWarn()&&Log_1.Log.Warn("Battle",48,"Follower类型异常",["Type",s.h5n])}var o,i,r=[-1,0];for([o,i]of this.MWa)o>r[0]&&(r[0]=o,r[1]=i);r[0]<0?this.IWa():(e=r[1])!==this.heh&&(this.IWa(),this.heh=e,this.TWa())}OnFollowerAdd(e){e===this.heh&&this.TWa()}TWa(){var e,t=this.heh;const o=ModelManager_1.ModelManager.CreatureModel.GetEntity(t);o?.Valid&&o.Id!==this.SWa?.Id&&!this.EWa&&(e=e=>{this.EWa=void 0,e&&(e=o.Entity?.GetComponent(206))&&(this.SWa=o,this.yWa=e,this.j8===ModelManager_1.ModelManager.CreatureModel.GetPlayerId())&&(e.Possess(),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnPlayerFollowerCreate,o))},o.IsInit?e(!0):this.EWa=WaitEntityTask_1.WaitEntityTask.Create(t,e,-1))}IWa(){this.EWa?.Cancel(),this.EWa=void 0,this.yWa&&this.j8===ModelManager_1.ModelManager.CreatureModel.GetPlayerId()&&(this.yWa.UnPossess(),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnPlayerFollowerDestroy)),this.heh=0,this.SWa=void 0,this.yWa=void 0}SetFollowerEnable(e){this.yWa?.SetEnable(e)}GetFollower(){return this.SWa}IsFollowerEnable(){return this.yWa?.IsEnable??!1}};PlayerFollowerComponent=__decorate([(0,RegisterComponent_1.RegisterComponent)(208)],PlayerFollowerComponent),exports.PlayerFollowerComponent=PlayerFollowerComponent;
//# sourceMappingURL=PlayerFollowerComponent.js.map