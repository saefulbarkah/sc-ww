
"use strict";var __decorate=this&&this.__decorate||function(t,e,o,r){var i,n=arguments.length,s=n<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,r);else for(var f=t.length-1;0<=f;f--)(i=t[f])&&(s=(n<3?i(s):3<n?i(e,o,s):i(e,o))||s);return 3<n&&s&&Object.defineProperty(e,o,s),s};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PlayerBuffComponent=void 0;const Info_1=require("../../../../Core/Common/Info"),Stats_1=require("../../../../Core/Common/Stats"),CommonDefine_1=require("../../../../Core/Define/CommonDefine"),Protocol_1=require("../../../../Core/Define/Net/Protocol"),RegisterComponent_1=require("../../../../Core/Entity/RegisterComponent"),MathUtils_1=require("../../../../Core/Utils/MathUtils"),EventDefine_1=require("../../../Common/Event/EventDefine"),EventSystem_1=require("../../../Common/Event/EventSystem"),ModelManager_1=require("../../../Manager/ModelManager"),CombatMessage_1=require("../../../Module/CombatMessage/CombatMessage"),CombatLog_1=require("../../../Utils/CombatLog"),BaseBuffComponent_1=require("../../Character/Common/Component/Abilities/BaseBuffComponent"),ActiveBuffConfigs_1=require("../../Character/Common/Component/Abilities/Buff/ActiveBuffConfigs"),ExtraEffectManager_1=require("../../Character/Common/Component/Abilities/ExtraEffect/ExtraEffectManager");let PlayerBuffComponent=class PlayerBuffComponent extends BaseBuffComponent_1.BaseBuffComponent{constructor(){super(...arguments),this.PlayerId=0,this.BuffEffectManager=void 0,this.xie=()=>{this.BuffLock++;var t=new Set;for(const r of this.TagListenerDict.values())for(const i of r)t.add(i);for(const n of t){var e,o=this.GetBuffByHandle(n);o&&(this.CheckRemove(o.Config,o.GetInstigator())?this.RemoveBuffInner(n,-1,!0,"因为切人导致不满足tag条件"):(e=this.CheckActivate(o.Config,o.GetInstigator()))!==o.IsActive()&&this.OnBuffActiveChanged(o,e))}this.BuffLock--}}OnCreate(){return this.BuffEffectManager=new ExtraEffectManager_1.PlayerExtraEffectManager(this),!0}OnInitData(t){var e=this.Entity.CheckGetComponent(0);return this.PlayerId=e?.GetPlayerId()??0,0!==this.PlayerId||(CombatLog_1.CombatLog.Error("Actor",this.Entity,"PlayerId为0",["EntityId",this.Entity.Id]),!1)}OnStart(){return EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnChangeRole,this.xie),!0}OnActivate(){this.InitBornBuff()}OnClear(){this.TriggerMap.clear();for(const t of this.BuffContainer.values())t.Destroy();return super.OnClear(),!0}OnEnd(){return EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnChangeRole,this.xie),!0}IsPaused(){return this.GetCurrentBuffComponent()?.IsPaused()??!1}InitBornBuff(){var t=this.Entity.CheckGetComponent(0)?.ComponentDataMap.get("vys")?.vys;if(t){var e=t.EIs;if(e)for(const f of e){var o=MathUtils_1.MathUtils.LongToBigInt(f.b6n);for(let t=0;t<f.GTs.length;t++)this.SetBuffEffectCd(o,t,f.GTs[t]*CommonDefine_1.MILLIONSECOND_PER_SECOND)}e=t.SIs;if(e)for(const a of e){var r=a,i=MathUtils_1.MathUtils.LongToBigInt(r.b6n??-1),n=MathUtils_1.MathUtils.LongToNumber(r.Rjn),s=r.cVn??ActiveBuffConfigs_1.INVALID_BUFF_HANDLE;this.AddBuffRemote(i,s,{Level:r.F6n,InstigatorId:n,ApplyType:r.xjn,Duration:r.n5n,RemainDuration:r.QEs,IsActive:r.WHn,ServerId:r.wjn,OuterStackCount:r.Bjn,Reason:"服务器通过通知FightBuffComponent恢复PlayerBuff",MessageId:MathUtils_1.MathUtils.LongToBigInt(r.$8n)}),this.BuffContainer.get(s)?.SetRemainDuration(r.QEs)}}}GetDebugName(){return"player_"+this.PlayerId}GetEntity(){return ModelManager_1.ModelManager.SceneTeamModel?.GetTeamItem(this.PlayerId,{ParamType:2,IsControl:!0})?.EntityHandle?.Entity}GetTimeScale(){var t=this.GetEntity();return(t?.TimeDilation??1)*(t?.GetComponent(111)?.CurrentTimeScale??1)}GetCurrentBuffComponent(){return this.GetEntity()?.GetComponent(163)}GetSkillComponent(){return this.GetEntity()?.GetComponent(35)}GetAttributeComponent(){return this.GetEntity()?.GetComponent(162)}GetTagComponent(){return this.GetEntity()?.GetComponent(194)}CheckAdd(t,e,o){return!this.GetTagComponent()||super.CheckAdd(t,e,o)}CheckActivate(t,e){return!this.GetTagComponent()||super.CheckActivate(t,e)}HasBuffRoutineExpirationLock(t){return 0<(this.BuffRoutineExpirationLock.get(t)??0)||0<(this.GetCurrentBuffComponent()?.BuffRoutineExpirationLock.get(t)??0)}GetActorComponent(){return this.GetEntity()?.GetComponent(3)}GetBuffLevel(t){return this.GetEntity()?.GetComponent(163)?.GetBuffLevel(t)}GetCueComponent(){return this.Entity.GetComponent(213)}GetBuffTotalStackById(t,e=!1){return(this.GetCurrentBuffComponent()?.GetBuffTotalStackById(t,e)??0)+super.GetBuffTotalStackById(t,e)}HasBuffAuthority(){return ModelManager_1.ModelManager.PlayerInfoModel.GetId()===this.PlayerId}AddBuffInner(t,e,o,r,i,n,s,f,a,u,h,C,m,c,_,l){return 5!==e.FormationPolicy&&t!==ActiveBuffConfigs_1.DYNAMIC_BUFF_ID?(CombatLog_1.CombatLog.Warn("Buff",this.Entity,"暂不支持对编队实体增删非编队buff",["buffId",t],["reason",C]),ActiveBuffConfigs_1.INVALID_BUFF_HANDLE):super.AddBuffInner(t,e,o,r,i,n,s,f,a,u,h,C,m,c,_,l)}OnBuffAdded(t,e,o,r,i,n,s,f,a,u,h){if(t){this.BroadcastAddBuff(t,o,u,f,h);var C=t.Config,e=(super.OnBuffAdded(t,e,o,r,i,n,s,f,a,u,h),ModelManager_1.ModelManager.SceneTeamModel?.GetTeamItemsByPlayer(this.PlayerId)??[]);for(const _ of e){var m=_.EntityHandle?.Entity;if(_.EntityHandle?.Valid&&m){var c=m?.GetComponent(163);if(c&&C.RemoveBuffWithTags&&0<C.RemoveBuffWithTags.length){const h=`因为buff${t.Id}(handle=${t.Handle})的RemoveBuffWithTags导致移除`;for(const l of C.RemoveBuffWithTags)c.HasBuffAuthority()&&c.RemoveBuffByTag(l,h),c.TagComponent.RemoveTag(l)}_.EntityHandle?.IsInit&&(m?.GetComponent(19))?.CreateGameplayCueByBuff(t)}}}}OnBuffRemoved(t,e,o,r,i){if(t){this.BroadcastRemoveBuff(t,e,i,r),super.OnBuffRemoved(t,e,o,r,i);e=ModelManager_1.ModelManager.SceneTeamModel?.GetTeamItemsByPlayer(this.PlayerId);if(e)for(const n of e)n.EntityHandle?.IsInit&&(n.EntityHandle?.Entity?.GetComponent(19))?.DestroyGameplayCueByBuff(t);this.Entity.GetComponent(214)?.DestroyPlayerGameplayCueByBuff(t),Info_1.Info.IsBuildDevelopmentOrDebug&&(this.Entity.GetComponent(24)?.OnBuffRemoved(t),this.Entity.GetComponent(20)?.OnBuffRemoved(t))}}OnBuffStackIncreased(t,e,o,r,i,n,s,f,a,u,h,C,m){t&&(this.BroadcastBuffStackChanged(t,e,o,!1,m,r),super.OnBuffStackIncreased(t,e,o,r,i,n,s,f,a,u,h,C,m))}OnBuffStackDecreased(t,e,o,r,i){t&&(this.BroadcastBuffStackChanged(t,e,o,r,i),super.OnBuffStackDecreased(t,e,o,r,i))}OnBuffActiveChanged(t,e){t&&t.IsActive()!==e&&(this.BroadcastActivateBuff(t,e),super.OnBuffActiveChanged(t,e))}BroadcastAddBuff(t,e,o,r,i){!t||t.Id<0||!this.NeedBroadcastBuff(t,r)||!t.IsInstantBuff()&&t.Handle<0||((r=Protocol_1.Aki.Protocol.R3n.create()).uVn=t.Handle,r.s5n=MathUtils_1.MathUtils.BigIntToLong(t.Id),r.F6n=t.Level,r.Rjn=t.InstigatorId??0,r.xjn=e,r.n5n=t.Duration,r.Bjn=t.StackCount,r.WHn=t.IsActive(),CombatMessage_1.CombatNet.Call(17711,this.Entity,Protocol_1.Aki.Protocol.R3n.create(r),void 0,t.PreMessageId,t.MessageId,o))}BroadcastActivateBuff(t,e){var o;!t||t.Id<0||!this.NeedBroadcastBuff(t)||((o=Protocol_1.Aki.Protocol.$3n.create()).uVn=t.Handle,o.qjn=e,CombatMessage_1.CombatNet.Call(24873,this.Entity,o))}BroadcastBuffStackChanged(t,e,o,r,i,n){var s;!t||t.Id<0||!this.NeedBroadcastBuff(t)||((s=Protocol_1.Aki.Protocol.u4n.create()).cVn=t.Handle,s.Gjn=o,s.Ojn=r,s.Rjn=n??0,CombatMessage_1.CombatNet.Call(23324,this.Entity,s,void 0))}BroadcastRemoveBuff(t,e,o,r){var i,n;!t||t.Id<0||!this.NeedBroadcastBuff(t)||(i=this.Entity.GetComponent(0)?.GetCreatureDataId(),(n=Protocol_1.Aki.Protocol.x3n.create()).uVn=t.Handle,n.F4n=MathUtils_1.MathUtils.NumberToLong(i),n.Ojn=e,CombatMessage_1.CombatNet.Call(23310,this.Entity,n,void 0,o,void 0,r))}AddBuffOrder(t,e){CombatLog_1.CombatLog.Warn("Buff",this.Entity,"[buffComp] 客户端暂不能给其它玩家添加队伍buff",["buffId",t],["持有者",this.GetDebugName()],["原因",e.Reason])}RemoveBuffOrder(t,e,o){CombatLog_1.CombatLog.Warn("Buff",this.Entity,"[buffComp] 客户端暂不能给其它玩家移除队伍buff",["buffId",t],["持有者",this.GetDebugName()],["原因",o])}FormationBuffApplyRequest(){}};PlayerBuffComponent=__decorate([(0,RegisterComponent_1.RegisterComponent)(188)],PlayerBuffComponent),exports.PlayerBuffComponent=PlayerBuffComponent;
//# sourceMappingURL=PlayerBuffComponent.js.map