
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BulletActionInitBullet=void 0;const Log_1=require("../../../../Core/Common/Log"),Time_1=require("../../../../Core/Common/Time"),Protocol_1=require("../../../../Core/Define/Net/Protocol"),FNameUtil_1=require("../../../../Core/Utils/FNameUtil"),GameplayTagUtils_1=require("../../../../Core/Utils/GameplayTagUtils"),MathCommon_1=require("../../../../Core/Utils/Math/MathCommon"),GlobalData_1=require("../../../GlobalData"),ModelManager_1=require("../../../Manager/ModelManager"),BulletController_1=require("../BulletController"),BulletUtil_1=require("../BulletUtil"),BulletPool_1=require("../Model/BulletPool"),BulletActionBase_1=require("./BulletActionBase"),BULLET_TAG_PREFIX="子弹.";class BulletActionInitBullet extends BulletActionBase_1.BulletActionBase{OnExecute(){var l=this.BulletInfo,e=l.BulletInitParams,o=l.BulletDataMain,t=(l.GenerateTime=Time_1.Time.WorldTime,l.PreContextId=e.FromRemote?0n:e.ContextId,l.ContextId=e.FromRemote?e.ContextId:ModelManager_1.ModelManager.CombatMessageModel.GenMessageId(),e.TargetId),t=(l.TargetId=t,l.SetTargetById(t),l.AttackerCreatureDataComp);if(t){t.GetEntityType()!==Protocol_1.Aki.Protocol.kks.Proto_Player?l.AttackerCamp=t.GetEntityCamp():l.AttackerCamp=0,l.IsAutonomousProxy=l.AttackerActorComp.IsAutonomousProxy,l.AttackerPlayerId=t.GetPlayerId(),l.SkillLevel=l.AttackerSkillComp?.GetSkillLevelBySkillInfoId(e.SkillId)??0;var r,t=o.Move;0<t.UpDownAngleLimit&&(_=BulletUtil_1.BulletUtil.GetTargetLocation(l.TargetActorComp,FNameUtil_1.FNameUtil.GetDynamicFName(t.InitVelocityDirParam),l))&&((r=BulletPool_1.BulletPool.CreateVector()).FromUeVector(_),_=l.AttackerActorComp,(a=BulletPool_1.BulletPool.CreateVector()).FromUeVector(_.ActorLocationProxy),a.SubtractionEqual(r),0<(_=a.Size())&&(u=0<(u=a.Z)?u:-1*u,t.UpDownAngleLimit<Math.asin(u/_)*MathCommon_1.MathCommon.RadToDeg)&&l.SetTargetById(0),BulletPool_1.BulletPool.RecycleVector(a),BulletPool_1.BulletPool.RecycleVector(r));const i=o.Base.TagId;0<i&&l.AddTagId(i);t=o.Logic.PresentTagIds;for(const i of t)l.AddTagId(i);if(GlobalData_1.GlobalData.IsPlayInEditor){0<i&&this.O5o(i,e.BulletRowName,"子弹的'基础设置.子弹标签'中的值必须是以[子弹.]开头的");for(const i of t)0<i&&this.O5o(i,e.BulletRowName,"子弹的'逻辑设置.预设.预设标签'中的值必须是以[子弹.]开头的")}var u=o.Base.Shape,_=l.Size,a=e.Size;a?3===u?_.Set(a.X,0,a.Z):_.FromUeVector(a):_.FromUeVector(o.Base.Size),0<o.Children.length&&BulletController_1.BulletController.AddSimpleAction(l,10),BulletController_1.BulletController.AddSimpleAction(l,2),BulletController_1.BulletController.AddSimpleAction(l,3),BulletController_1.BulletController.AddSimpleAction(l,6),0<o.Summon.EntityId&&BulletController_1.BulletController.AddSimpleAction(l,12),BulletController_1.BulletController.AddSimpleAction(l,4),o.Logic.DestroyOnFrozen&&BulletController_1.BulletController.AddSimpleAction(l,15),BulletController_1.BulletController.AddSimpleAction(l,7),BulletController_1.BulletController.AddSimpleAction(l,8),BulletController_1.BulletController.AddSimpleAction(l,5),BulletController_1.BulletController.AddSimpleAction(l,9)}else BulletController_1.BulletController.DestroyBullet(l.BulletEntityId,!1)}O5o(l,e,o){l=GameplayTagUtils_1.GameplayTagUtils.GetNameByTagId(l);l?.startsWith(BULLET_TAG_PREFIX)||Log_1.Log.CheckError()&&Log_1.Log.Error("Bullet",17,o,["BulletId",e],["Tag",l])}}exports.BulletActionInitBullet=BulletActionInitBullet;
//# sourceMappingURL=BulletActionInitBullet.js.map