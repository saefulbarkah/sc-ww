
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BulletActionInitMove=void 0;const UE=require("ue"),Info_1=require("../../../../Core/Common/Info"),Log_1=require("../../../../Core/Common/Log"),Stats_1=require("../../../../Core/Common/Stats"),QueryTypeDefine_1=require("../../../../Core/Define/QueryTypeDefine"),RegisterComponent_1=require("../../../../Core/Entity/RegisterComponent"),FNameUtil_1=require("../../../../Core/Utils/FNameUtil"),MathCommon_1=require("../../../../Core/Utils/Math/MathCommon"),Rotator_1=require("../../../../Core/Utils/Math/Rotator"),Vector_1=require("../../../../Core/Utils/Math/Vector"),MathUtils_1=require("../../../../Core/Utils/MathUtils"),StringUtils_1=require("../../../../Core/Utils/StringUtils"),TraceElementCommon_1=require("../../../../Core/Utils/TraceElementCommon"),EffectSystem_1=require("../../../Effect/EffectSystem"),Global_1=require("../../../Global"),GlobalData_1=require("../../../GlobalData"),ModelManager_1=require("../../../Manager/ModelManager"),ActorUtils_1=require("../../../Utils/ActorUtils"),ColorUtils_1=require("../../../Utils/ColorUtils"),BulletConstant_1=require("../../Bullet/BulletConstant"),BulletController_1=require("../BulletController"),BulletUtil_1=require("../BulletUtil"),BulletMoveInfo_1=require("../Model/BulletMoveInfo"),BulletPool_1=require("../Model/BulletPool"),BulletTraceElementPool_1=require("../Model/BulletTraceElementPool"),BulletActionBase_1=require("./BulletActionBase"),DEFAULT_GRAVITY=-1e3,DEFAULT_UP_DISTANCE=500,PROFILE_AIMED_TOWARD="BulletMoveAimedToward",PROFILE_STICK_GROUND="BulletMoveStickGround",PROFILE_STICK_WATER="BulletMoveStickWater";class BulletActionInitMove extends BulletActionBase_1.BulletActionBase{constructor(){super(...arguments),this.Pe=void 0,this.z5o=!1,this.Z5o=void 0,this.eVo=void 0,this.tVo=!1}get iVo(){return this.z5o||(this.z5o=!0,this.Z5o=this.oVo(this.rVo,this.Pe.Move.SkeletonComponentName)),this.Z5o}set rVo(t){this.eVo!==t&&(this.eVo=t,this.z5o=!1,this.Z5o=void 0)}get rVo(){return this.eVo||(this.eVo=this.BulletInfo.AttackerActorComp),this.eVo}Clear(){super.Clear(),this.Pe=void 0,this.z5o=!1,this.Z5o=void 0,this.eVo=void 0,this.tVo=!1}OnExecute(){var t=this.BulletInfo.BulletInitParams;const e=this.BulletInfo.BulletDataMain;var l=(this.Pe=e).Move,o=e.Obstacle,i=this.BulletInfo.MoveInfo,r=(i.BulletSpeedRatio=1,this.BulletInfo.AttackerSkillComp),r=(this.BulletInfo.TargetActorComp?.Valid&&r?.Valid&&(1===this.BulletInfo.CreateSource||r.CurrentSkill)&&r.SkillTargetSocket&&(this.BulletInfo.SkillBoneName=FNameUtil_1.FNameUtil.GetDynamicFName(r.SkillTargetSocket)),i.BulletSpeed=l.Speed,i.ObstaclesOffset.FromUeVector(o.Center),BulletActionInitMove.nVo.Start(),this.sVo(),this.aVo(),BulletActionInitMove.nVo.Stop(),BulletActionInitMove.hVo.Start(),e.Base),o=e.Aimed;if(!r.StickGround&&o.AimedCtrlDir&&(t.FromRemote?i.BeginSpeedRotator.FromUeRotator(t.InitialTransform.Rotator()):this.lVo(i.BeginSpeedRotator),this.BulletInfo.SetActorRotation(i.BeginSpeedRotator.ToUeRotator())),this._Vo(),this.uVo(),this.cVo(),this.mVo(),0<l.TrackParams.length){const e=l.TrackParams[0];i.MinFollowHeight=e.Y,i.SpeedFollowTarget=e.X,0<e.Z&&(i.FollowTargetBottom=!1)}BulletActionInitMove.hVo.Stop(),i.LastFramePosition.FromUeVector(this.BulletInfo.GetActorLocation()),i.FollowBoneBulletRotator.FromUeRotator(this.BulletInfo.GetActorRotation()),this.BulletInfo.ApplyCacheLocationAndRotation()}oVo(t,e){if(e!==StringUtils_1.NONE_STRING){var l=t.Actor.K2_GetComponentsByClass(UE.SkeletalMeshComponent.StaticClass()),o=l?l.Num():0;for(let t=0;t<o;t++){var i=l.Get(t);if(i?.IsValid()&&i.GetName()===e)return i}}return t.SkeletalMesh}dVo(t){var e,l,o=this.Pe.Move;0===o.FollowType?(l=this.BulletInfo,e=this.oVo(t?.Valid?t:l.AttackerActorComp,o.SkeletonComponentName),o.IsLockScale&&l.Actor.RootComponent.SetAbsolute(!1,!1,!0),l.ApplyCacheLocationAndRotation(),l.ActorComponent.SetAttachToComponent(e,o.BoneName,1,1,1,!0),l.InitPosition.FromUeVector(l.ActorComponent.ActorLocationProxy)):3===o.FollowType&&(e=this.BulletInfo,l=this.oVo(t?.Valid?t:e.AttackerActorComp,o.SkeletonComponentName),o.IsLockScale&&e.Actor.RootComponent.SetAbsolute(!1,!1,!0),e.ApplyCacheLocationAndRotation(),e.ActorComponent.SetAttachToComponent(l,o.BoneName,0,0,0,!0),e.Actor.D_K2_SetActorRelativeLocation(e.BornLocationOffset.ToUeVector(),!1,void 0,!1),e.Actor.K2_SetActorRelativeRotation(Rotator_1.Rotator.ZeroRotator,!1,void 0,!0),e.InitPosition.FromUeVector(e.ActorComponent.ActorLocationProxy))}sVo(){var t=this.BulletInfo;switch(this.Pe.Base.BornPositionStandard){case 0:this.CVo(t.AttackerActorComp);break;case 1:this.gVo(t.BaseTransformEntity?.Entity?.GetComponent(1));break;case 7:case 8:case 5:case 10:case 9:case 4:this.fVo(t.BaseTransformEntity);break;case 11:this.fVo(t.BaseTransformEntity,!0);break;case 3:this.vVo(t);break;case 2:this.MVo(MathUtils_1.MathUtils.DefaultTransformProxy);break;case 6:this.EVo()}BulletConstant_1.BulletConstant.OpenMoveLog&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("Bullet",20,"BulletActionInitMove OnStartBaseLocation",["Bullet",this.BulletInfo?.BulletRowName],["Location",this.BulletInfo?.GetActorLocation()])}CVo(t){this.MVo(void 0),this.dVo(t)}gVo(t){var e=BulletMoveInfo_1.BulletMoveInfo.TempTransform1;this.SVo(t,e),this.MVo(e),(0,RegisterComponent_1.isComponentInstance)(t,3)&&this.dVo(t)}fVo(t,e=!1){var l=BulletMoveInfo_1.BulletMoveInfo.TempTransform1,t=t?.Entity?.GetComponent(1);(0,RegisterComponent_1.isComponentInstance)(t,3)?(this.SVo(t,l,e),this.rVo=t,e?this.j2a(l):this.MVo(l),this.dVo(t)):(this.SVo(t,l),this.MVo(l))}vVo(t){var e,l,o,i;4===this.Pe.Move.FollowType?this.yVo(t):(e=BulletMoveInfo_1.BulletMoveInfo.TempTransform1,o=t.BulletInitParams,i=this.Pe.Base,l=BulletPool_1.BulletPool.CreateVector(),e.FromUeTransform(o.InitialTransform),l.FromUeVector(e.GetLocation()),l.Equals(Vector_1.Vector.ZeroVectorProxy)?this.MVo(e):(t.BulletInitParams.FromRemote||(o=i.BornPositionRandom,i=BulletPool_1.BulletPool.CreateVector(!0),o.Equals(Vector_1.Vector.ZeroVectorProxy)||(i.X=this.HY(o.X),i.Y=this.HY(o.Y),i.Z=this.HY(o.Z)),t.BornLocationOffset.Equals(Vector_1.Vector.ZeroVectorProxy)||i.AdditionEqual(t.BornLocationOffset),i.Equals(Vector_1.Vector.ZeroVectorProxy)||e.TransformPosition(i,l),BulletPool_1.BulletPool.RecycleVector(i)),t.SetActorLocation(l),t.InitPosition.FromUeVector(l)),BulletPool_1.BulletPool.RecycleVector(l))}yVo(t){var e,l=ModelManager_1.ModelManager.BulletModel.GetBulletEntityById(t.ParentEntityId);l?(l=l.GetBulletInfo(),t.ParentEffect=l.EffectInfo.Effect,(e=EffectSystem_1.EffectSystem.GetSureEffectActor(t.ParentEffect))?BulletUtil_1.BulletUtil.AttachParentEffectSkeleton(t,e,t.ParentEffect)&&t.InitPosition.FromUeVector(t.ActorComponent.ActorLocationProxy):(e=l.MoveInfo.LastFramePosition,t.SetActorLocation(e),t.InitPosition.FromUeVector(e),BulletController_1.BulletController.AddSimpleAction(t,10))):(Log_1.Log.CheckWarn()&&Log_1.Log.Warn("Temp",17,"子弹为跟随父子弹特效骨骼，但是找不到父子弹",["EntityId",t.BulletEntityId],["BulletRowName",t.BulletRowName],["ParentEntityId",t.ParentEntityId]),this.MVo(void 0))}EVo(){var t=BulletUtil_1.BulletUtil.GetCurrentRole(this.BulletInfo),e=BulletMoveInfo_1.BulletMoveInfo.TempTransform1;e.FromUeTransform(t.ActorTransform),this.rVo=t,this.MVo(e),this.dVo(t)}j2a(t){var e=this.BulletInfo,l=this.Pe.Base,o=BulletPool_1.BulletPool.CreateVector(),l=l.BornPositionRandom,l=(l.Equality(Vector_1.Vector.ZeroVectorProxy)?o.FromUeVector(e.BornLocationOffset):(e.BulletInitParams.FromRemote?o.FromUeVector(e.RandomPosOffset):(o.X=this.HY(l.X),o.Y=this.HY(l.Y),o.Z=this.HY(l.Z),e.RandomPosOffset.FromUeVector(o)),o.AdditionEqual(e.BornLocationOffset)),BulletPool_1.BulletPool.CreateVector());t.TransformPosition(o,l),e.SetActorLocation(l),e.InitPosition.FromUeVector(l),BulletPool_1.BulletPool.RecycleVector(o),BulletPool_1.BulletPool.RecycleVector(l)}MVo(t){var e=this.BulletInfo,l=e.MoveInfo,o=this.Pe.Base,i=this.Pe.Move,r=o.BornPositionRandom,a=e.AttackerActorComp,_=BulletPool_1.BulletPool.CreateVector(),r=(r.Equality(Vector_1.Vector.ZeroVectorProxy)?_.FromUeVector(e.BornLocationOffset):(e.BulletInitParams.FromRemote?_.FromUeVector(e.RandomPosOffset):(_.X=this.HY(r.X),_.Y=this.HY(r.Y),_.Z=this.HY(r.Z),e.RandomPosOffset.FromUeVector(_)),_.AdditionEqual(e.BornLocationOffset)),BulletPool_1.BulletPool.CreateVector()),s=BulletPool_1.BulletPool.CreateVector();FNameUtil_1.FNameUtil.IsNothing(i.BoneName)||!this.iVo?(0===o.BornPositionStandard&&(_.Z-=a.ScaledHalfHeight),(t||((o=BulletMoveInfo_1.BulletMoveInfo.TempTransform1).SetRotation(a.ActorQuatProxy),o.SetLocation(a.ActorLocationProxy),o.SetScale3D(a.ActorScaleProxy),o)).TransformPosition(_,r)):(l.SocketTransform.FromUeTransform(this.iVo.D_GetSocketTransform(i.BoneName,0)),r.FromUeVector(l.SocketTransform.GetLocation()),a.ActorQuatProxy.RotateVector(_,s),r.AdditionEqual(s)),e.SetActorLocation(r),e.InitPosition.FromUeVector(r),BulletPool_1.BulletPool.RecycleVector(_),BulletPool_1.BulletPool.RecycleVector(r),BulletPool_1.BulletPool.RecycleVector(s)}SVo(t,e,l=!1){var o=this.BulletInfo,i=o.AttackerActorComp;t?.Valid?(e.FromUeTransform(t.GetSocketTransform(o.SkillBoneName)),(t=BulletPool_1.BulletPool.CreateVector()).FromUeVector(e.GetLocation()),this.IVo(t),e.SetLocation(t),BulletPool_1.BulletPool.RecycleVector(t)):(l&&Log_1.Log.CheckError()&&Log_1.Log.Error("Bullet",20,"出生位置需要完全基于目标, 但是目标不存在",["子弹ID",o.BulletRowName]),e.Reset(),(t=BulletPool_1.BulletPool.CreateVector()).FromUeVector(i.ActorLocation),this.IVo(t),e.SetLocation(t),BulletPool_1.BulletPool.RecycleVector(t)),l||e.SetRotation(i.ActorQuat)}IVo(t){var e,l,o=this.BulletInfo,i=this.BulletInfo.BulletDataMain.Base,r=(this.tVo=!1,BulletPool_1.BulletPool.CreateVector()),i=(r.FromUeVector(i.BornDistLimit),r.Y),a=r.X,_=r.Z;r.IsZero()||(e=o.AttackerActorComp.ActorLocationProxy,r.FromUeVector(t),i<(l=Vector_1.Vector.Dist(r,e))?(r.SubtractionEqual(e),r.Normalize(),r.MultiplyEqual(i),r.AdditionEqual(e),this.tVo=!0):l<=a?(this.tVo=!0,o.TargetActorComp?.Valid?(r.SubtractionEqual(e),r.Normalize(),r.MultiplyEqual(a)):(r.FromUeVector(o.AttackerActorComp.ActorForward),r.MultiplyEqual(_)),r.AdditionEqual(e)):r.FromUeVector(t),t.FromUeVector(r)),BulletPool_1.BulletPool.RecycleVector(r)}lVo(t){var e=this.BulletInfo,l=this.BulletInfo.BulletDataMain.Aimed,o=Global_1.Global.CharacterCameraManager,i=BulletPool_1.BulletPool.CreateVector(),r=BulletPool_1.BulletPool.CreateVector(),a=BulletPool_1.BulletPool.CreateVector(),_=BulletPool_1.BulletPool.CreateVector(),l=(i.FromUeVector(o.D_GetCameraLocation()),r.FromUeVector(o.GetActorForwardVector()),r.MultiplyEqual(l.DistLimit),r.AdditionEqual(i),e.MoveInfo.AimedLineTraceElement||(e.MoveInfo.AimedLineTraceElement=BulletTraceElementPool_1.BulletTraceElementPool.GetTraceLineElement(ModelManager_1.ModelManager.BulletModel.ObjectTypeTakeAim,e.AttackerId,e.CollisionInfo.IgnoreQueries)),e.MoveInfo.AimedLineTraceElement),s=(TraceElementCommon_1.TraceElementCommon.SetStartLocation(l,i),TraceElementCommon_1.TraceElementCommon.SetEndLocation(l,r),TraceElementCommon_1.TraceElementCommon.LineTrace(l,PROFILE_AIMED_TOWARD));let n=-1;if(s){var u=l.HitResult,h=u.GetHitCount(),B=BulletPool_1.BulletPool.CreateVector(),c=BulletPool_1.BulletPool.CreateVector();c.FromUeVector(o.GetActorForwardVector());for(let t=0;t<h;t++){BulletConstant_1.BulletConstant.OpenMoveLog&&Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Bullet",20,"BulletAimedToward",["ActorLabel",GlobalData_1.GlobalData.IsPlayInEditor?u.Actors.Get(t)?.ActorLabel:u.Actors.Get(t)?.GetName()]);var v=u.Components.Get(t).GetCollisionProfileName();if(!BulletConstant_1.BulletConstant.ProfileNameWater.op_Equality(v))if(TraceElementCommon_1.TraceElementCommon.GetHitLocation(u,t,a),B.FromUeVector(a),B.SubtractionEqual(e.GetActorLocation()),B.Normalize(),0<Vector_1.Vector.DotProduct(c,B)){v=u.Actors?.Get(t);if(v?.IsValid()){v=ActorUtils_1.ActorUtils.GetEntityByActor(v,!1)?.Entity?.GetComponent(3);if(!v||BulletUtil_1.BulletUtil.AttackedCondition(e,v)){n=t;break}}}}BulletPool_1.BulletPool.RecycleVector(B),BulletPool_1.BulletPool.RecycleVector(c)}BulletConstant_1.BulletConstant.OpenMoveLog&&UE.KismetSystemLibrary.D_DrawDebugSphere(GlobalData_1.GlobalData.World,(n<0?r:a).ToUeVector(),10,10,ColorUtils_1.ColorUtils.LinearGreen,10),_.FromUeVector(e.GetActorLocation());s=n<0?r:a,_.SubtractionEqual(s),_.MultiplyEqual(-1),l=UE.KismetMathLibrary.FindLookAtRotation(e.GetActorLocation().ToUeVectorOld(),s.ToUeVectorOld()),o=e.AttackerActorComp?.ActorForwardProxy;o&&o.Normalize(MathCommon_1.MathCommon.KindaSmallNumber),_.Normalize(MathCommon_1.MathCommon.KindaSmallNumber),t.FromUeRotator(l),BulletPool_1.BulletPool.RecycleVector(i),BulletPool_1.BulletPool.RecycleVector(r),BulletPool_1.BulletPool.RecycleVector(a),BulletPool_1.BulletPool.RecycleVector(_)}aVo(){var t,e,l,o,i,r=this.Pe.Aimed,a=this.Pe.Move;r.AimedCtrlDir||3===a.FollowType||5===a.Trajectory||4===a.Trajectory||(t=(r=this.BulletInfo).MoveInfo,e=this.Pe.Base,this.TVo(t.BeginSpeedRotator),l=BulletPool_1.BulletPool.CreateRotator(),a.InitVelocityRot.IsNearlyZero()||(l.FromUeRotator(t.BeginSpeedRotator),MathUtils_1.MathUtils.ComposeRotator(a.InitVelocityRot,l,t.BeginSpeedRotator)),(o=r.BulletInitParams.BeginRotatorOffset)&&((i=BulletPool_1.BulletPool.CreateRotator()).FromUeRotator(o),l.FromUeRotator(t.BeginSpeedRotator),MathUtils_1.MathUtils.ComposeRotator(i,l,t.BeginSpeedRotator),BulletPool_1.BulletPool.RecycleRotator(i)),e.StickGround&&!e.IgnoreGradient?BulletPool_1.BulletPool.RecycleRotator(l):(e.Rotator.IsNearlyZero()||(r.IsCollisionRelativeRotationModify=!0),a.InitVelocityDirRandom.IsZero()||this.LVo(t.BeginSpeedRotator,a.InitVelocityDirRandom),BulletUtil_1.BulletUtil.ClampBeginRotator(r),r.SetActorRotation(t.BeginSpeedRotator),BulletPool_1.BulletPool.RecycleRotator(l),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Bullet",20,"BulletActionInitMove OnStartSpeedRotator",["Bullet",r.BulletRowName],["Rot",r.GetActorRotation()])))}LVo(t,e){var l,o;0<e.X?(o=BulletPool_1.BulletPool.CreateVector(),this.BulletInfo.BulletInitParams.FromRemote?o.FromUeVector(this.BulletInfo.RandomInitSpeedOffset):(l=UE.KismetMathLibrary.RandomUnitVectorInConeInDegrees(Vector_1.Vector.ForwardVector,e.X),o.FromUeVector(l),this.BulletInfo.RandomInitSpeedOffset.FromUeVector(o)),t.Quaternion().RotateVector(o,o),MathUtils_1.MathUtils.VectorToRotator(o,t),BulletPool_1.BulletPool.RecycleVector(o)):(0<e.Y||0<e.Z)&&(l=BulletPool_1.BulletPool.CreateRotator(),this.BulletInfo?.BulletInitParams.FromRemote?l.Set(this.BulletInfo.RandomInitSpeedOffset.Y,this.BulletInfo.RandomInitSpeedOffset.Z,0):(o=this.HY(e.Y),e=this.HY(e.Z),l.Set(o,e,0),this.BulletInfo.RandomInitSpeedOffset.Set(0,o,e)),(o=BulletPool_1.BulletPool.CreateRotator()).FromUeRotator(t),MathUtils_1.MathUtils.ComposeRotator(l,o,t),BulletPool_1.BulletPool.RecycleRotator(l),BulletPool_1.BulletPool.RecycleRotator(o))}TVo(t){let e=void 0;var l=this.BulletInfo,o=l.MoveInfo,i=this.Pe.Move,r=i.InitVelocityDirParam;switch(i.InitVelocityDirStandard){case 0:if(FNameUtil_1.FNameUtil.IsEmpty(i.BoneName)||0===i.FollowType)return void t.FromUeRotator(l.AttackerActorComp.ActorRotationProxy);o.SocketTransform.GetRotation().Rotator(t);var a=i.FollowSkeletonRotLimit,_=l.GetActorRotation();return 1<=a.X&&(t.Roll=_.Roll),1<=a.Y&&(t.Pitch=_.Pitch),void(1<=a.Z&&(t.Yaw=l.AttackerActorComp.ActorRotationProxy.Yaw));case 3:_=l.TransformCreate.Rotator();if(Rotator_1.Rotator.ZeroRotatorProxy.Equals2(_))break;return void t.FromUeRotator(_);case 2:a=l.AttackerActorComp;if(a)return e=r!==StringUtils_1.NONE_STRING?a.Actor.Mesh.D_GetSocketLocation(FNameUtil_1.FNameUtil.GetDynamicFName(r)):a.ActorLocation,void t.FromUeRotator(BulletUtil_1.BulletUtil.FindLookAtRotDouble(l.GetActorLocation(),e,i.InitVelocityKeepUp));break;case 1:return(e=BulletUtil_1.BulletUtil.GetTargetLocation(l.TargetActorComp,StringUtils_1.StringUtils.IsNothing(r)?l.SkillBoneName:FNameUtil_1.FNameUtil.GetDynamicFName(r),l))?void t.FromUeRotator(BulletUtil_1.BulletUtil.FindLookAtRotDouble(l.GetActorLocation(),e,i.InitVelocityKeepUp)):void t.FromUeRotator(l.AttackerActorComp.ActorRotationProxy);case 4:return void t.FromUeRotator(l.GetActorRotation());case 5:case 8:case 9:case 11:case 6:case 10:_=l.GetBaseVelocityTarget();return _?.Valid?(e=_.GetSocketLocation(FNameUtil_1.FNameUtil.GetDynamicFName(r)),void t.FromUeRotator(BulletUtil_1.BulletUtil.FindLookAtRotDouble(l.GetActorLocation(),e,i.InitVelocityKeepUp))):void t.FromUeRotator(l.AttackerActorComp.ActorRotationProxy);case 12:a=l.GetBaseVelocityTarget();return a?.Valid?void t.FromUeRotator(a.ActorRotationProxy):void t.FromUeRotator(l.AttackerActorComp.ActorRotationProxy);case 7:_=BulletUtil_1.BulletUtil.GetCurrentRole(this.BulletInfo);return _?.Valid?(e=_.GetSocketLocation(FNameUtil_1.FNameUtil.GetDynamicFName(r)),void t.FromUeRotator(BulletUtil_1.BulletUtil.FindLookAtRotDouble(l.GetActorLocation(),e,i.InitVelocityKeepUp))):void t.FromUeRotator(l.AttackerActorComp.ActorRotationProxy)}t.FromUeRotator(Rotator_1.Rotator.ZeroRotatorProxy)}uVo(){var e=this.BulletInfo,l=e.MoveInfo,o=e.BulletDataMain.Move;if(3===o.Trajectory){var i=o.TrackParams,r=i.length,a=i[0],i=1<r?i[1]:void 0,_=BulletPool_1.BulletPool.CreateVector();let t=0;if(0===o.TrackTarget||10===o.TrackTarget){o=BulletUtil_1.BulletUtil.GetCurrentRole(e);if(!o)return Log_1.Log.CheckError()&&Log_1.Log.Error("Bullet",20,"围绕中心旋转子弹获取不到当前玩家控制的角色",["Id",e.BulletRowName],["Attacker",e.AttackerActorComp.Actor.GetName()]),BulletController_1.BulletController.DestroyBullet(e.BulletEntityId,!1),void BulletPool_1.BulletPool.RecycleVector(_);l.RoundCenter.FromUeVector(e.InitPosition),i?BulletUtil_1.BulletUtil.AroundBulletAxisAndBeginVector(a,i,l.RoundOnceAxis,_,o):(t=o.ActorRotation.Yaw,_.FromUeVector(Vector_1.Vector.ForwardVectorProxy))}else{o=e.TargetActorComp;o?.Valid?(this.DVo(o),i?BulletUtil_1.BulletUtil.AroundBulletAxisAndBeginVector(a,i,l.RoundOnceAxis,_,o):(t=o.ActorRotation.Yaw,_.FromUeVector(o.ActorForward))):(l.RoundCenter.FromUeVector(e.InitPosition),i?BulletUtil_1.BulletUtil.AroundBulletAxisAndBeginVector(a,i,l.RoundOnceAxis,_):_.FromUeVector(Vector_1.Vector.ForwardVectorProxy))}o=BulletPool_1.BulletPool.CreateVector();1<r?(_.RotateAngleAxis(a.Y,l.RoundOnceAxis,o),o.MultiplyEqual(a.X),o.AdditionEqual(l.RoundCenter),e.SetActorLocation(o)):(_.RotateAngleAxis(a.Y,Vector_1.Vector.UpVectorProxy,o),o.Z=-Math.sin((t+a.Y)*MathCommon_1.MathCommon.DegToRad)*Math.tan(a.Z*MathCommon_1.MathCommon.DegToRad),o.Normalize(),o.MultiplyEqual(a.X),o.AdditionEqual(l.RoundCenter),e.SetActorLocation(o),l.RoundOnceAxis.Set(0,Math.sin(a.Z*MathCommon_1.MathCommon.DegToRad),Math.cos(a.Z*MathCommon_1.MathCommon.DegToRad))),l.AroundAngle=a.Y,BulletPool_1.BulletPool.RecycleVector(_),BulletPool_1.BulletPool.RecycleVector(o)}}DVo(t){var e=this.BulletInfo,l=e.MoveInfo;e.ClearCacheLocationAndRotation(),e.ActorComponent.SetActorTransform(t.ActorTransform),l.RoundCenter.FromUeVector(t.ActorTransform.TransformPosition(e.BornLocationOffset.ToUeVector())),l.RoundCenterLastLocation.FromUeVector(t.ActorLocation)}cVo(){var r=this.Pe.Move,a=r.Trajectory,_=4===a;if(_||5===a){a=r.TrackParams;if(a&&!(a.length<2)){var s=this.BulletInfo,n=s.MoveInfo;let t=0,e=!1,l=0,o=void 0;_?(u=a[2],o=a[3],u&&(t=u.X,e=0<u.Z,l=u.Y)):(u=a[1],o=a[2],u&&(t=u.Y)),n.GravityMoveRotator.Reset();var u=s.Attacker?.GetComponent(3),h=s.TargetActorComp,B=BulletPool_1.BulletPool.CreateVector(),c=FNameUtil_1.FNameUtil.GetDynamicFName(r.TrackTargetBlackboardKey),c=BulletUtil_1.BulletUtil.GetTargetLocation(h,FNameUtil_1.FNameUtil.IsNothing(c)?s.SkillBoneName:c,s);if(c){h?.Valid&&(0,RegisterComponent_1.isComponentInstance)(h,3)?(B.FromUeVector(c),0!==t&&(B.Z+=h.Actor.CapsuleComponent.CapsuleHalfHeight*t),e&&(v=h.Entity?.GetComponent(176))&&(B.Z-=v.GetHeightAboveGround())):B.FromUeVector(c);var v=BulletPool_1.BulletPool.CreateVector(!0);const U=BulletPool_1.BulletPool.CreateVector();switch(r.DestOffsetForward){case 0:U.FromUeVector(s.AttackerActorComp.ActorForwardProxy);break;case 2:B.Subtraction(s.AttackerActorComp.ActorLocationProxy,U),U.Z=0,U.Normalize();break;case 1:U.FromUeVector(h.ActorForwardProxy)}var c=r.DestOffset.X,m=r.DestOffset.Y,M=r.DestOffset.Z;0!==m&&(P=BulletPool_1.BulletPool.CreateVector(),Vector_1.Vector.CrossProduct(U,Vector_1.Vector.UpVectorProxy,P),P.MultiplyEqual(m),v.AdditionEqual(P),BulletPool_1.BulletPool.RecycleVector(P)),0!==c&&(U.MultiplyEqual(c),v.AdditionEqual(U)),0!==M&&((m=BulletPool_1.BulletPool.CreateVector()).FromUeVector(Vector_1.Vector.UpVectorProxy),m.MultiplyEqual(M),v.AdditionEqual(m),BulletPool_1.BulletPool.RecycleVector(m)),B.AdditionEqual(v),BulletPool_1.BulletPool.RecycleVector(v),BulletPool_1.BulletPool.RecycleVector(U)}else B.FromUeVector(u.ActorForwardProxy),B.MultiplyEqual(a[0].X),B.AdditionEqual(u.ActorLocationProxy);let i=0;var P=a[0],m=(_?(M=0<(c=a[1]).Z?c.Z:1,n.Gravity=0!==P.Z?P.Z:DEFAULT_GRAVITY,m=Vector_1.Vector.Dist2D(B,s.GetActorLocation()),m+=l,m=Math.max(m,P.X),m=Math.min(m,P.Y),n.BulletSpeed2D=m/M,v=B.Z-s.GetActorLocation().Z,v=Math.max(v,c.X),v=Math.min(v,c.Y),n.BulletSpeedZ=v/M-.5*n.Gravity*M,n.BulletSpeed=Math.sqrt(Math.pow(n.BulletSpeed2D,2)+Math.pow(n.BulletSpeedZ,2)),i=Math.atan(n.BulletSpeedZ/n.BulletSpeed2D)*MathCommon_1.MathCommon.RadToDeg):(i=a[1].X,n.Gravity=0!==P.Z?P.Z:DEFAULT_GRAVITY,u=Vector_1.Vector.Dist2D(B,s.GetActorLocation()),_=B.Z-s.GetActorLocation().Z,n.BulletSpeed2D=Math.sqrt(Math.abs(u*u*n.Gravity/(2*_-2*Math.tan(i*MathCommon_1.MathCommon.DegToRad)*u))),n.BulletSpeedZ=Math.tan(i*MathCommon_1.MathCommon.DegToRad)*n.BulletSpeed2D,n.BulletSpeed=Math.sqrt(Math.pow(n.BulletSpeed2D,2)+Math.pow(n.BulletSpeedZ,2)),n.BulletSpeed=Math.max(P.X,n.BulletSpeed),n.BulletSpeed=Math.min(P.Y,n.BulletSpeed),n.BulletSpeedZ=Math.sin(i*MathCommon_1.MathCommon.DegToRad)*n.BulletSpeed,n.BulletSpeed2D=Math.cos(i*MathCommon_1.MathCommon.DegToRad)*n.BulletSpeed),n.GravityMoveRotator);const U=BulletPool_1.BulletPool.CreateVector();B.Subtraction(s.GetActorLocation(),U),U.Normalize(),MathUtils_1.MathUtils.LookRotationUpFirst(U,Vector_1.Vector.UpVectorProxy,m),BulletPool_1.BulletPool.RecycleVector(U),m.Pitch=i,r.InitVelocityRot.IsNearlyZero()||((c=BulletPool_1.BulletPool.CreateRotator()).FromUeRotator(m),MathUtils_1.MathUtils.ComposeRotator(r.InitVelocityRot,c,m),BulletPool_1.BulletPool.RecycleRotator(c)),!o||1!==o.X&&2!==o.X||(s.SetActorRotation(m),n.ActorRotateParabola=2===o.X),BulletPool_1.BulletPool.RecycleVector(B)}}}mVo(){var t=this.BulletInfo,e=t.MoveInfo,l=t.AttackerMoveComp,o=this.Pe.Move,i=o.FollowType;0!==i&&3!==i||(t.ActorComponent.NeedDetach=!0),l?.HasBaseMovement&&!this.Pe.Base.NotFollowMovePlatform&&(0===o.Speed?t.ActorComponent.NeedDetach||(t.ApplyCacheLocationAndRotation(),t.ActorComponent.SetAttachToComponent(t.AttackerActorComp.Actor.BasedMovement.MovementBase,FNameUtil_1.FNameUtil.NONE,1,1,1,!1),t.ActorComponent.NeedDetach=!0):(e.IsOnBaseMovement=!0,(i=l.DeltaBaseMovementSpeed)&&e.LastBaseMovementSpeed.FromUeVector(i)))}_Vo(){var i=this.BulletInfo,r=this.Pe.Base;if(r.StickGround){var a=BulletPool_1.BulletPool.CreateVector(),e=BulletPool_1.BulletPool.CreateVector(),_=(BulletMoveInfo_1.BulletMoveInfo.StickGroundLineTrace||(BulletMoveInfo_1.BulletMoveInfo.StickGroundLineTrace=BulletTraceElementPool_1.BulletTraceElementPool.NewTraceElementByTraceChannel(UE.TraceLineElement.StaticClass(),QueryTypeDefine_1.KuroTraceTypeQuery.IkGround)),Info_1.Info.IsBuildDevelopmentOrDebug&&(_=(s=ModelManager_1.ModelManager.BulletModel.ShowBulletTrace(this.BulletInfo.Attacker.Id))?2:0,BulletMoveInfo_1.BulletMoveInfo.StickGroundLineTrace.SetDrawDebugTrace(_),s)&&(TraceElementCommon_1.TraceElementCommon.SetTraceColor(BulletMoveInfo_1.BulletMoveInfo.StickGroundLineTrace,ColorUtils_1.ColorUtils.LinearGreen),TraceElementCommon_1.TraceElementCommon.SetTraceHitColor(BulletMoveInfo_1.BulletMoveInfo.StickGroundLineTrace,ColorUtils_1.ColorUtils.LinearRed)),BulletMoveInfo_1.BulletMoveInfo.StickGroundLineTrace),s=i.BaseTransformEntity?.Entity?.GetComponent(3),n=(e.FromUeVector(i.GetActorLocation()),s?.Valid&&!this.tVo&&(0,RegisterComponent_1.isComponentInstance)(s,3));let l=0;l=(n?s.GetSocketLocation(i.SkillBoneName):(e.Z+=DEFAULT_UP_DISTANCE,i.GetActorLocation())).Z;var n=e.X,u=e.Y,h=e.Z,B=(_.SetStartLocation(n,u,h),e.Z-=r.StickTraceLen+DEFAULT_UP_DISTANCE,e.X),c=e.Y,v=e.Z,m=(_.SetEndLocation(B,c,v),TraceElementCommon_1.TraceElementCommon.LineTrace(_,PROFILE_STICK_GROUND));const d=_.HitResult;let t=!0,o=Number.MAX_VALUE;if(m){var M=d.GetHitCount();if(0<M){o=Math.abs(d.LocationZ_Array.Get(0)-l);let e=0;t=!0;for(let t=1;t<M;t++){var P=d.LocationZ_Array.Get(t),P=Math.abs(P-l);o>P&&(o=P,e=t)}TraceElementCommon_1.TraceElementCommon.GetHitLocation(d,e,a),i.SetActorLocation(a),r.IgnoreGradient||TraceElementCommon_1.TraceElementCommon.GetImpactNormal(d,e,a)}}if(r.StickWater){BulletMoveInfo_1.BulletMoveInfo.StickWaterLineTrace||(BulletMoveInfo_1.BulletMoveInfo.StickWaterLineTrace=BulletTraceElementPool_1.BulletTraceElementPool.NewTraceElementByTraceChannel(UE.TraceLineElement.StaticClass(),QueryTypeDefine_1.KuroTraceTypeQuery.Water));_=BulletMoveInfo_1.BulletMoveInfo.StickWaterLineTrace,m=(_.SetStartLocation(n,u,h),_.SetEndLocation(B,c,v),TraceElementCommon_1.TraceElementCommon.LineTrace(_,PROFILE_STICK_WATER));if(m){const d=_.HitResult;var U=d.GetHitCount();if(0<U){let e=-1;t=!0;for(let t=0;t<U;t++){var C=d.LocationZ_Array.Get(t),C=Math.abs(C-l);o>C&&(o=C,e=t)}-1<e&&(TraceElementCommon_1.TraceElementCommon.GetHitLocation(d,e,a),i.SetActorLocation(a),r.IgnoreGradient||TraceElementCommon_1.TraceElementCommon.GetImpactNormal(d,e,a))}}}t?r.IgnoreGradient&&a.FromUeVector(Vector_1.Vector.UpVectorProxy):(s?.Valid?(a.FromUeVector(s.ActorLocationProxy),a.Z-=s.ScaledHalfHeight):(a.FromUeVector(i.GetActorLocation()),a.Z-=r.Size.Z),i.SetActorLocation(a),a.FromUeVector(Vector_1.Vector.UpVectorProxy));n=BulletPool_1.BulletPool.CreateRotator();r.IgnoreGradient||(MathUtils_1.MathUtils.LookRotationUpFirst(Vector_1.Vector.ForwardVectorProxy,a,n),i.SetActorRotation(n),0!==i.AttackerActorComp.ActorRotationProxy.Yaw&&(n.Set(0,i.AttackerActorComp.ActorRotationProxy.Yaw,0),i.AddBulletLocalRotator(n.ToUeRotator()))),BulletPool_1.BulletPool.RecycleVector(a),BulletPool_1.BulletPool.RecycleVector(e),BulletPool_1.BulletPool.RecycleRotator(n)}}HY(t){return 0===t?0:Math.random()*t}}(exports.BulletActionInitMove=BulletActionInitMove).nVo=Stats_1.Stat.Create("BulletInitMoveBase"),BulletActionInitMove.hVo=Stats_1.Stat.Create("BulletInitMoveSpecial");
//# sourceMappingURL=BulletActionInitMove.js.map