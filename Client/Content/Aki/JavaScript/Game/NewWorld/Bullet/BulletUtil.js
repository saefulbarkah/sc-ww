
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BulletUtil=void 0;const UE=require("ue"),Log_1=require("../../../Core/Common/Log"),Time_1=require("../../../Core/Common/Time"),Protocol_1=require("../../../Core/Define/Net/Protocol"),EntitySystem_1=require("../../../Core/Entity/EntitySystem"),RegisterComponent_1=require("../../../Core/Entity/RegisterComponent"),MathCommon_1=require("../../../Core/Utils/Math/MathCommon"),Quat_1=require("../../../Core/Utils/Math/Quat"),Rotator_1=require("../../../Core/Utils/Math/Rotator"),Vector_1=require("../../../Core/Utils/Math/Vector"),MathUtils_1=require("../../../Core/Utils/MathUtils"),SpaceUtils_1=require("../../../Core/Utils/SpaceUtils"),StringUtils_1=require("../../../Core/Utils/StringUtils"),TimeUtil_1=require("../../Common/TimeUtil"),EffectSystem_1=require("../../Effect/EffectSystem"),Global_1=require("../../Global"),ModelManager_1=require("../../Manager/ModelManager"),PhantomUtil_1=require("../../Module/Phantom/PhantomUtil"),CharacterUtils_1=require("../Character/CharacterUtils"),CampUtils_1=require("../Character/Common/Blueprint/Utils/CampUtils"),PawnTimeScaleComponent_1=require("../Pawn/Component/PawnTimeScaleComponent"),BulletController_1=require("./BulletController"),BulletStaticFunction_1=require("./BulletStaticMethod/BulletStaticFunction"),BulletPool_1=require("./Model/BulletPool"),QUARTER_PI_DEGREE=45;class BulletUtil{static GetTargetLocation(t,e,r){return 10===r.BulletDataMain.Move.TrackTarget?r.BulletInitParams.InitTargetLocation:t?.Valid&&t.Entity?.IsInit?t.GetSocketLocation(e):void 0}static AttackedCondition(t,e){if(!e?.Entity?.Valid||this.DoesEntityContainsTag(e.Entity,1008164187)||this.DoesEntityContainsTag(e.Entity,-208062360))return!1;var r=e.Entity.GetComponent(0);if(11===t.BulletCamp)return r.GetEntityType()===Protocol_1.Aki.Protocol.kks.Proto_Vision?r.GetPlayerId()===t.AttackerPlayerId:(o=ModelManager_1.ModelManager.GameModeModel.IsMulti?ModelManager_1.ModelManager.SceneTeamModel.GetTeamItem(t.AttackerPlayerId,{ParamType:2,IsControl:!0}).EntityHandle.Id:Global_1.Global.BaseCharacter.GetEntityIdNoBlueprint(),ModelManager_1.ModelManager.CharacterModel.IsValid(o)?o===e.Entity.Id:(Log_1.Log.CheckError()&&Log_1.Log.Error("Bullet",20,"子弹对小队攻击，找不到当前控制玩家",["Id",t.BulletRowName],["Attacker",t.AttackerActorComp?.Actor?.GetName()],["CurrentEntityId",o]),!1));var o=t.AttackerCamp;let i=0;r.GetEntityType()!==Protocol_1.Aki.Protocol.kks.Proto_Player&&(i=r.GetEntityCamp());r=2*CampUtils_1.CampUtils.GetCampRelationship(o,i);return e===t.AttackerActorComp?!!(1&t.BulletCamp):!!(t.BulletCamp&r)}static DoesEntityContainsTag(t,e){return!!t&&(!!t.GetComponent(182)?.HasTag(e)||!!(t=t.GetComponent(191))&&t.HasTag(e))}static GetCurrentRole(t){return ModelManager_1.ModelManager.GameModeModel.IsMulti?ModelManager_1.ModelManager.SceneTeamModel.GetTeamItem(t.AttackerPlayerId,{ParamType:2,IsControl:!0}).EntityHandle?.Entity?.GetComponent(3):Global_1.Global.BaseCharacter?.CharacterActorComponent}static ShakeTest(t,e){if(!CharacterUtils_1.CharacterUtils.CanCharacterMonsterOrSummonedDisplayEffect(t.AttackerHandle))return!1;let r=!1;var o=t.BulletDataMain.Render;return(0,RegisterComponent_1.isComponentInstance)(e,3)&&e.IsRoleAndCtrlByMe&&0<o.VictimCameraShakeOnHit.length&&o.CameraShakeCountMax>t.ShakeNumbers&&(r=!0),(r=t.Attacker&&t.IsAutonomousProxy&&(0<o.AttackerCameraShakeOnHit.length||0<o.AttackerCameraShakeOnHitWeakPoint.length)&&o.CameraShakeCountMax>t.ShakeNumbers&&BulletUtil.IsPlayerOrSummons(t)?!0:r)&&t.ShakeNumbers++,r}static IsPlayerOrSummons(t){return!!t.AttackerActorComp.IsRoleAndCtrlByMe||!(!t.AttackerActorComp.IsAutonomousProxy||!t.BulletDataMain.Render.CameraShakeToSummonOwner||!(t=t.AttackerCreatureDataComp.GetSummonerPlayerId())||t!==ModelManager_1.ModelManager.PlayerInfoModel.GetId())}static SummonBullet(t,e,r,o,i=void 0,l=void 0,a=!0){var n=BulletController_1.BulletController.GetActionCenter().CreateBulletActionInfo(11);n.ChildrenType=e,n.Victim=r,n.IsStayInCharacter=o,n.CreateOnAuthority=a,i&&(n.ParentImpactPoint=Vector_1.Vector.Create(i)),l&&(n.ParentLastPosition=Vector_1.Vector.Create(l)),BulletController_1.BulletController.GetActionRunner().AddAction(t,n)}static CheckSupport(t,e){t=t.BulletDataMain.Execution.SupportCamp;if(t&&0<t.length)for(const r of t)if(r===e)return!0;return!1}static ProcessHandOverEffectToSon(t,e){e?.Valid&&(e=e.GetBulletInfo()).BulletDataMain.Render.HandOverParentEffect&&BulletStaticFunction_1.BulletStaticFunction.HandOverEffects(t,e)}static FrozenBulletTime(t,e){t.FrozenTime=e*TimeUtil_1.TimeUtil.InverseMillisecond,BulletUtil.BulletFrozen(t)}static BulletFrozen(t){t.IsFrozen=!0;var e=t.ActorComponent;e&&(e.SetBulletCustomTimeDilation(0),BulletStaticFunction_1.BulletStaticFunction.SetBulletEffectTimeScale(t.EffectInfo,0))}static BulletUnfrozen(t){t.IsFrozen=!1,t.ActorComponent.SetBulletCustomTimeDilation(1),BulletStaticFunction_1.BulletStaticFunction.SetBulletEffectTimeScale(t.EffectInfo,1)}static FrozenCharacterBullet(t,e,r=0){t=ModelManager_1.ModelManager.BulletModel.GetBulletSetByAttacker(t);if(t)for(const i of t){var o=i.GetBulletInfo();!StringUtils_1.StringUtils.IsEmpty(e)&&o.BulletDataMain.BulletName!==e||BulletUtil.FrozenBulletTime(o,r)}}static UnFrozenCharacterBullet(t,e){t=ModelManager_1.ModelManager.BulletModel.GetBulletSetByAttacker(t);if(t)for(const o of t){var r=o.GetBulletInfo();!StringUtils_1.StringUtils.IsEmpty(e)&&r.BulletDataMain.BulletName!==e||BulletUtil.BulletUnfrozen(r)}}static SetTimeScale(t,e,r,o,i,l,a=0,n=0){if(i<=0||t.BulletDataMain.TimeScale.TimeScaleWithAttacker)return 0;if(0<a&&i<=a)return 0;var a=Time_1.Time.WorldTimeSeconds-a,s=a+i;let u=n;0<=n&&(t.TimeScaleId+=1,u=t.TimeScaleId);n=new PawnTimeScaleComponent_1.TimeScale(a,s,e,r,o,i,u,l,(0,PawnTimeScaleComponent_1.getSourceGroup)(l));return t.TimeScaleList.Push(n),t.TimeScaleMap.set(u,n),u}static RemoveTimeScale(t,e){t=t.TimeScaleMap.get(e);t&&(t.MarkDelete=!0)}static SetVictimTimeScale(t,e,r,o,i,l,a,n,s,u=!1){a<=0||(r=r.SetTimeScale(o,i,l,a,n,u),s&&0<r&&(o=EntitySystem_1.EntitySystem.Get(t)?.GetBulletInfo().CollisionInfo)&&o.HitTimeScaleEntityMap.set(e,r))}static GetHitRotator(t,e,r){r.FromUeRotator(e.ActorRotationProxy);var o=t.BulletDataMain.Base.RelativeDirection;if(3===o)return!1;if((0,RegisterComponent_1.isComponentInstance)(e,3)&&e.Entity.GetComponent(191)?.HasTag(855966206))return!1;var i=t.AttackerActorComp,l=Vector_1.Vector.Create();switch(o){case 0:l.FromUeVector(i.ActorLocationProxy),l.SubtractionEqual(e.ActorLocationProxy),MathUtils_1.MathUtils.LookRotationUpFirst(l,e.ActorUpProxy,r);break;case 1:l.FromUeVector(t.ActorComponent.ActorLocationProxy),l.SubtractionEqual(e.ActorLocationProxy),MathUtils_1.MathUtils.LookRotationUpFirst(l,e.ActorUpProxy,r);break;case 2:t.MoveInfo.BulletSpeedDir.Equals(Vector_1.Vector.ZeroVectorProxy,MathCommon_1.MathCommon.KindaSmallNumber)?(l.FromUeVector(t.ActorComponent.ActorForward),l.Z=0,l.MultiplyEqual(-1)):l.Set(-t.MoveInfo.BulletSpeedDir.X,-t.MoveInfo.BulletSpeedDir.Y,0),MathUtils_1.MathUtils.LookRotationUpFirst(l,e.ActorUpProxy,r);break;case 4:SpaceUtils_1.SpaceUtils.IsLocationInSideBullet(t,e.ActorLocationProxy)?(l.FromUeVector(e.ActorLocationProxy),l.SubtractionEqual(t.ActorComponent.ActorLocationProxy)):(l.FromUeVector(t.ActorComponent.ActorLocationProxy),l.SubtractionEqual(e.ActorLocationProxy)),MathUtils_1.MathUtils.LookRotationUpFirst(l,e.ActorUpProxy,r)}return!0}static SetHitRotator(t,e,r){return BulletUtil.GetHitRotator(t,e,this.TmpRotator)&&!e.Entity.GetComponent(191)?.HasTag(1447214865)&&(this.TmpRotator2.Set(0,r,0),this.TmpRotator.Quaternion(this.TmpQuat),this.TmpRotator2.Quaternion(this.TmpQuat2),this.TmpQuat.Multiply(this.TmpQuat2,this.TmpQuat),this.TmpQuat.Rotator(this.TmpRotator),e.SetActorRotation(this.TmpRotator.ToUeRotator(),this.constructor.name,!1),(0,RegisterComponent_1.isComponentInstance)(e,3))&&e.SetInputRotator(this.TmpRotator),this.TmpRotator.ToUeRotator()}static GetOverrideHitAnimByAngle(t,e,r){let o=e;var e=(0,RegisterComponent_1.isComponentInstance)(t,188),i=ModelManager_1.ModelManager.BulletModel,l=i.SelfAdaptBeHitAnim.has(o);return(l||e)&&(r=((r-180-t.ActorRotationProxy.Yaw+QUARTER_PI_DEGREE)%360+360)%360,t=Math.floor(r/90),l?o=(i.HeavyHitAnim.has(o)?i.Index2HeavyHitAnimMap:i.Index2LightHitAnimMap)[t]:e&&(o=i.Index2HeavyHitAnimMap[t])),o}static CheckBulletAttackerExist(t){var e;return!(!t.AttackerHandle?.Valid||(!(e=t.AttackerCreatureDataComp?.GetCreatureDataId())||e!==ModelManager_1.ModelManager.BulletModel?.SceneBulletOwnerId)&&void 0===t.AttackerActorComp?.Actor)}static FindLookAtRot(t,e,r){var o,i;return r?((r=BulletPool_1.BulletPool.CreateVector()).FromUeVector(e),(o=BulletPool_1.BulletPool.CreateVector()).FromUeVector(t),r.SubtractionEqual(o),i=UE.KismetMathLibrary.MakeRotFromZX(Vector_1.Vector.UpVector,r.ToUeVector(!0)),BulletPool_1.BulletPool.RecycleVector(r),BulletPool_1.BulletPool.RecycleVector(o),i):UE.KismetMathLibrary.FindLookAtRotation(t.ToUeVector(!0),e)}static ClampBeginRotator(r){var o=r.BulletDataMain.Move.BeginVelocityLimitMap;if(!(o.size<=0)){var i=BulletPool_1.BulletPool.CreateRotator(),l=(r.AttackerActorComp.ActorRotationProxy.Clamp(i),BulletPool_1.BulletPool.CreateRotator());r.MoveInfo.BeginSpeedRotator.Clamp(l);let t=l.Pitch,e=(void 0!==(n=o.get(0))&&t<MathCommon_1.MathCommon.FlatAngle&&(t=Math.min(t,n)),void 0!==(n=o.get(1))&&t>MathCommon_1.MathCommon.FlatAngle&&(t=Math.max(t,MathCommon_1.MathCommon.RoundAngle-n)),l.Yaw);e=e>MathCommon_1.MathCommon.FlatAngle?e-MathCommon_1.MathCommon.RoundAngle:e;var a,n=o.get(3),s=(s=i.Yaw)>MathCommon_1.MathCommon.FlatAngle?s-MathCommon_1.MathCommon.RoundAngle:s;void 0!==n&&0<(a=e-s)&&a<MathCommon_1.MathCommon.FlatAngle&&n<a&&(e=Rotator_1.Rotator.ClampAxis(i.Yaw+n)),void 0!==(n=o.get(2))&&0<(a=s-e)&&a<MathCommon_1.MathCommon.FlatAngle&&n<a&&(e=Rotator_1.Rotator.ClampAxis(i.Yaw-n)),BulletPool_1.BulletPool.RecycleRotator(i),BulletPool_1.BulletPool.RecycleRotator(l),r.MoveInfo.BeginSpeedRotator.Pitch=t,r.MoveInfo.BeginSpeedRotator.Yaw=e}}static CreateBulletFromAN(t,e,r,o,i,l,a,n,s){var u=t.GetEntityNoBlueprint();let _=u?.GetComponent(195);s&&(s=PhantomUtil_1.PhantomUtil.GetSummonedEntity(u,Protocol_1.Aki.Protocol.Summon.x3s.Proto_ESummonTypeConcomitantCustom)?.Entity,_=s?.GetComponent(195));u=_?.CreateAnimNotifyContent(void 0,e),s=BulletController_1.BulletController.CreateBulletCustomTarget(t,e,r,{SkillId:Number(o),SyncType:i?1:0,InitTargetLocation:l,LocationOffset:a,BeginRotatorOffset:n},u);return s?s.Id:-1}static AttachParentEffectSkeleton(t,e,r){var o=t.BulletDataMain.Move;return o.IsLockScale&&t.Actor.RootComponent.SetAbsolute(!1,!1,!0),t.ClearCacheLocationAndRotation(),t.ActorComponent.ResetAllCachedTime(),t.ActorComponent.NeedDetach=!0,EffectSystem_1.EffectSystem.AttachToEffectSkeletalMesh(r,t.Actor,o.BoneName,0),t.Actor.K2_SetActorRelativeLocation(t.BornLocationOffset.ToUeVector(),!1,void 0,!1),t.Actor.K2_SetActorRelativeRotation(Rotator_1.Rotator.ZeroRotator,!1,void 0,!0),!0}}(exports.BulletUtil=BulletUtil).TmpRotator=Rotator_1.Rotator.Create(),BulletUtil.TmpRotator2=Rotator_1.Rotator.Create(),BulletUtil.TmpQuat=Quat_1.Quat.Create(),BulletUtil.TmpQuat2=Quat_1.Quat.Create(),BulletUtil.TmpVector=Vector_1.Vector.Create();
//# sourceMappingURL=BulletUtil.js.map