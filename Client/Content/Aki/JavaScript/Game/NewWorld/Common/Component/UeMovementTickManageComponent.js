
"use strict";var UeMovementTickManageComponent_1,__decorate=this&&this.__decorate||function(t,e,i,s){var o,h=arguments.length,n=h<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,i,s);else for(var r=t.length-1;0<=r;r--)(o=t[r])&&(n=(h<3?o(n):3<h?o(e,i,n):o(e,i))||n);return 3<h&&n&&Object.defineProperty(e,i,n),n};Object.defineProperty(exports,"__esModule",{value:!0}),exports.UeMovementTickManageComponent=exports.UeMovementTickController=void 0;const puerts_1=require("puerts"),UE=require("ue"),Log_1=require("../../../../Core/Common/Log"),Time_1=require("../../../../Core/Common/Time"),EntityComponent_1=require("../../../../Core/Entity/EntityComponent"),RegisterComponent_1=require("../../../../Core/Entity/RegisterComponent"),TickSystem_1=require("../../../../Core/Tick/TickSystem"),Rotator_1=require("../../../../Core/Utils/Math/Rotator"),Vector_1=require("../../../../Core/Utils/Math/Vector"),MathUtils_1=require("../../../../Core/Utils/MathUtils"),ControllerHolder_1=require("../../../Manager/ControllerHolder"),MIN_MODEL_BUFFER_TIME=60;class UeMovementTickController{static AddManager(t,e){for(;this.Managers.length<=e;)this.Managers.push(new Set);this.Managers[e].add(t)}static DeleteManager(t,e){for(;this.Managers.length<=e;)this.Managers.push(new Set);this.Managers[e].delete(t)}static PreTickManagers(e){this.PreTickedManagers.length=0;for(let t=this.Managers.length-1;0<=t;--t)for(const i of this.Managers[t])i.Active&&(i.PreProxyTick(e),this.PreTickedManagers.push(i))}static TickManagers(){for(const t of this.PreTickedManagers)t.ProxyTick()}static EnableParallelPerformMovement(t){this.Enabled=t}}(exports.UeMovementTickController=UeMovementTickController).Managers=new Array,UeMovementTickController.PreTickedManagers=new Array,UeMovementTickController.Enabled=!0;let UeMovementTickManageComponent=UeMovementTickManageComponent_1=class UeMovementTickManageComponent extends EntityComponent_1.EntityComponent{constructor(){super(...arguments),this.Hte=void 0,this.o4o=void 0,this.oRe=void 0,this.FQl=void 0,this.Msn=void 0,this.Esn=void 0,this.kHl=0,this.OHl=0,this.Dsn=0,this.Gh1=!1,this.zHl=0,this.JHl=void 0,this.ZHl=Vector_1.Vector.Create(),this.eWl=Rotator_1.Rotator.Create(),this.ysn=!1,this.Pil=(0,puerts_1.$ref)(void 0),this.utl=!1,this.Frozen=!1,this.Isn=0,this.OnEntityBudgetTickEnableChange=t=>{this.oRe?.Valid&&t&&this.oRe.ConsumeRootMotion()}}static get Dependencies(){return[3]}get TickMode(){return this.Dsn}set TickMode(t){var e;this.Dsn!==t&&(e=this.Dsn,this.Dsn=t,1===e?(UeMovementTickController.DeleteManager(this,0),TickSystem_1.TickSystem.CleanMovementProxyTickFunction(this.o4o),this.kHl=0,this.OHl=0):1===t&&(UeMovementTickController.AddManager(this,0),TickSystem_1.TickSystem.SetMovementProxyTickFunction(0,this.o4o,1)),3===e?(this.o4o.SetKuroOnlyTickOutside(!0),this.o4o.SetComponentTickEnabled(!1)):3===t&&(this.o4o.SetKuroOnlyTickOutside(!1),this.o4o.SetComponentTickEnabled(!0)))}get ForbiddenTickPose(){return this.ysn}set ForbiddenTickPose(t){this.ysn!==t&&(this.ysn=t,this.o4o.bForbiddenTickPose=t)}get TeleportLock(){return this.utl}set TeleportLock(t){this.utl=t}OnInit(){return!0}OnStart(){return this.Hte=this.Entity.GetComponent(3),this.Msn=this.Entity.GetComponent(39),this.FQl=this.Entity.GetComponent(221),this.o4o=this.Hte.Owner.GetComponentByClass(UE.CharacterMovementComponent.StaticClass()),this.Esn=this.Entity.GetComponent(27),!!this.o4o&&(this.o4o.SetKuroOnlyTickOutside(!0),this.o4o.SetComponentTickEnabled(!1),this.oRe=this.Entity.GetComponent(166),this.ForbiddenTickPose=1<this.Entity.GetTickInterval(),this.Isn=Time_1.Time.Frame,this.utl=!1,this.TickMode=UeMovementTickController.Enabled?1:2,!0)}OnEnd(){return this.TickMode=0,!(this.JHl=void 0)}OnDisable(){this.Hte?.Actor&&(this.Hte.Actor.BasedMovement.MovementBase=void 0),this.Hte?.IsRoleAndCtrlByMe&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("Movement",6,"UeMovementTickManageComponent Disable",["Entity",this.Entity.Id],["DisableInfo",this.DumpDisableInfo()])}OnEnable(){this.Hte?.IsRoleAndCtrlByMe&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("Movement",6,"UeMovementTickManageComponent Enable",["Entity",this.Entity.Id]),this.Isn=Time_1.Time.Frame}OnTick(t){2===this.TickMode&&(this.TickMovement(t),this.ResetCachedTransformAndSetModelBuffer(),UeMovementTickController.Enabled)&&(this.TickMode=1)}PreProxyTick(t){this.kHl++,this.OHl+=this.Entity.TimeDilation*t,this.kHl>=this.Entity.GetTickInterval()&&this.TickMovement(this.OHl)}ProxyTick(){this.kHl>=this.Entity.GetTickInterval()&&(this.ResetCachedTransformAndSetModelBuffer(),this.kHl=0,this.OHl=0),UeMovementTickController.Enabled||(this.TickMode=2)}TickMovement(t){if(this.Gh1=!1,this.Hte?.LastActorLocation.DeepCopy(this.Hte.ActorLocationProxy),this.wil(),this.o4o&&!this.TeleportLock&&!ControllerHolder_1.ControllerHolder.WorldController.GetIsWorldOriginInUiMode()&&!this.Hte?.Actor.GetAttachRootParentActor()){if(this.Esn&&this.Esn.MarkDebugRecord("移动组件更新前 ",void 0,!0),this.FQl)for(const o of this.FQl.PassengerInfoMap.values())(o.PassengerEntity?.GetComponent(27))?.MarkDebugRecord("载具移动组件更新前",void 0,!0);this.Msn.ConsumeForceFallingSpeed();var e,i,s=this.Entity.GetComponent(111)?.CurrentTimeScale??1;this.Msn.IsSpecialMove||(this.Msn&&(this.Msn.GetAndConsumeAddMove(t*MathUtils_1.MathUtils.MillisecondToSecond*s,UeMovementTickManageComponent_1.Lz,UeMovementTickManageComponent_1.Gue),UeMovementTickManageComponent_1.Lz.IsNearlyZero()||this.o4o.SetAddMove(UeMovementTickManageComponent_1.Lz.ToUeVector()),UeMovementTickManageComponent_1.Gue.IsNearlyZero()||this.Hte?.AddActorLocalRotation(UeMovementTickManageComponent_1.Gue.ToUeRotator(),"叠加旋转",!1)),e=1<this.Entity.GetTickInterval(),this.ForbiddenTickPose=e||this.Frozen,this.zHl=0,(i=this.oRe?.Actor?.Mesh)&&i.bEnableUpdateRateOptimizations&&(i.GetAnimUpdateRateParameters(this.Pil),(i=(0,puerts_1.$unref)(this.Pil)).bSkipUpdate)&&i.UpdateRate>this.Entity.GetTickInterval()&&(this.zHl=i.UpdateRate*t/Math.max(1,this.Entity.GetTickInterval())),e&&this.oRe?.Valid&&this.Hte.Owner.WasRecentlyRenderedOnScreen()&&(this.zHl=Math.max(t,this.zHl)),this.zHl<MIN_MODEL_BUFFER_TIME||!this.oRe?this.o4o.KuroTickComponentOutside(t*MathUtils_1.MathUtils.MillisecondToSecond*s):(this.JHl=this.oRe.GetMeshTransform(),this.ZHl.DeepCopy(this.Hte.ActorLocationProxy),this.eWl.DeepCopy(this.Hte.ActorRotationProxy),this.o4o.KuroTickComponentOutside(t*MathUtils_1.MathUtils.MillisecondToSecond*s),this.Hte.ResetAllCachedTime())),this.Gh1=!0}}ResetCachedTransformAndSetModelBuffer(){if(this.Gh1&&(this.Msn.IsSpecialMove||this.Hte.ResetAllCachedTime(),!(this.JHl&&this.zHl>=MIN_MODEL_BUFFER_TIME)||this.ZHl.Equals(this.Hte.ActorLocationProxy)&&this.eWl.Equals(this.Hte.ActorRotationProxy)||(this.oRe.SetModelBuffer(this.JHl,this.zHl),this.JHl=void 0),this.Msn.ApplyForceSpeedAndRecordSpeed(),this.Esn&&this.Esn.MarkDebugRecord("移动组件更新后",void 0,!0),this.FQl))for(const e of this.FQl.PassengerInfoMap.values()){var t=e.PassengerEntity?.GetComponent(27);(e.PassengerEntity?.GetComponent(1))?.ResetAllCachedTime(),t?.MarkDebugRecord("载具移动组件更新后",void 0,!0)}}wil(){this.Hte?.IsRoleAndCtrlByMe&&1<Time_1.Time.Frame-this.Isn&&Log_1.Log.CheckWarn()&&Log_1.Log.Warn("Movement",6,"[b1057126] 角色更新异常",["DebugLastTickFrame",this.Isn],["Current",Time_1.Time.Frame]),this.Isn=Time_1.Time.Frame}};UeMovementTickManageComponent.Lz=Vector_1.Vector.Create(),UeMovementTickManageComponent.Gue=Rotator_1.Rotator.Create(),UeMovementTickManageComponent=UeMovementTickManageComponent_1=__decorate([(0,RegisterComponent_1.RegisterComponent)(102)],UeMovementTickManageComponent),exports.UeMovementTickManageComponent=UeMovementTickManageComponent;
//# sourceMappingURL=UeMovementTickManageComponent.js.map