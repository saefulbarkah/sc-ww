
"use strict";var __decorate=this&&this.__decorate||function(t,i,e,s){var h,o=arguments.length,n=o<3?i:null===s?s=Object.getOwnPropertyDescriptor(i,e):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,i,e,s);else for(var r=t.length-1;0<=r;r--)(h=t[r])&&(n=(o<3?h(n):3<o?h(i,e,n):h(i,e))||n);return 3<o&&n&&Object.defineProperty(i,e,n),n};Object.defineProperty(exports,"__esModule",{value:!0}),exports.UeMovementTickManageComponent=void 0;const puerts_1=require("puerts"),UE=require("ue"),Log_1=require("../../../../Core/Common/Log"),Time_1=require("../../../../Core/Common/Time"),EntityComponent_1=require("../../../../Core/Entity/EntityComponent"),RegisterComponent_1=require("../../../../Core/Entity/RegisterComponent"),Rotator_1=require("../../../../Core/Utils/Math/Rotator"),Vector_1=require("../../../../Core/Utils/Math/Vector"),MathUtils_1=require("../../../../Core/Utils/MathUtils"),MIN_MODEL_BUFFER_TIME=60;let UeMovementTickManageComponent=class UeMovementTickManageComponent extends EntityComponent_1.EntityComponent{constructor(){super(...arguments),this.Hte=void 0,this.o4o=void 0,this.oRe=void 0,this.Msn=void 0,this.Esn=void 0,this.Ssn=Vector_1.Vector.Create(),this.Gwa=Rotator_1.Rotator.Create(),this.ysn=!1,this.Lth=(0,puerts_1.$ref)(void 0),this.Mth=!1,this.Frozen=!1,this.Isn=0,this.OnEntityBudgetTickEnableChange=t=>{this.oRe?.Valid&&t&&this.oRe.ConsumeRootMotion()}}static get Dependencies(){return[3]}get ForbiddenTickPose(){return this.ysn}set ForbiddenTickPose(t){this.ysn!==t&&(this.ysn=t,this.o4o.bForbiddenTickPose=t)}get TeleportLock(){return this.Mth}set TeleportLock(t){this.Mth=t}OnInit(){return!0}OnStart(){return this.Hte=this.Entity.GetComponent(3),this.Msn=this.Entity.GetComponent(38),this.o4o=this.Hte.Owner.GetComponentByClass(UE.CharacterMovementComponent.StaticClass()),this.Esn=this.Entity.GetComponent(27),!(!this.o4o||(this.o4o.SetKuroOnlyTickOutside(!0),this.o4o.SetComponentTickEnabled(!1),this.oRe=this.Entity.GetComponent(163),this.ForbiddenTickPose=1<this.Entity.GetTickInterval(),this.Isn=Time_1.Time.Frame,this.Mth=!1))}OnDisable(){this.Hte?.Actor&&(this.Hte.Actor.BasedMovement.MovementBase=void 0),this.Hte?.IsRoleAndCtrlByMe&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("Movement",6,"UeMovementTickManageComponent Disable",["Entity",this.Entity.Id],["DisableInfo",this.DumpDisableInfo()])}OnEnable(){this.Hte?.IsRoleAndCtrlByMe&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("Movement",6,"UeMovementTickManageComponent Enable",["Entity",this.Entity.Id]),this.Isn=Time_1.Time.Frame}OnTick(i){if(this.Hte?.LastActorLocation.DeepCopy(this.Hte.ActorLocationProxy),this.Dth(),this.o4o&&!this.TeleportLock){this.Esn&&this.Esn.MarkDebugRecord("移动组件更新前 ",void 0,!0),this.Msn.ConsumeForceFallingSpeed();var e=this.Hte.Owner.CustomTimeDilation;if(this.Msn.CanMove&&!this.Msn.IsSpecialMove){var s=1<this.Entity.GetTickInterval();this.ForbiddenTickPose=s||this.Frozen;let t=0;var h=this.oRe?.Actor?.Mesh;h&&h.bEnableUpdateRateOptimizations&&(h.GetAnimUpdateRateParameters(this.Lth),(h=(0,puerts_1.$unref)(this.Lth)).bSkipUpdate)&&h.UpdateRate>this.Entity.GetTickInterval()&&(t=h.UpdateRate*i/this.Entity.GetTickInterval()),(t=s&&this.oRe?.Valid&&this.Hte.Owner.WasRecentlyRenderedOnScreen()?Math.max(i,t):t)<MIN_MODEL_BUFFER_TIME||!this.oRe?(this.o4o.KuroTickComponentOutside(i*MathUtils_1.MathUtils.MillisecondToSecond*e),this.Hte.ResetAllCachedTime()):(h=this.oRe.GetMeshTransform(),this.Ssn.DeepCopy(this.Hte.ActorLocationProxy),this.Gwa.DeepCopy(this.Hte.ActorRotationProxy),this.o4o.KuroTickComponentOutside(i*MathUtils_1.MathUtils.MillisecondToSecond*e),this.Hte.ResetAllCachedTime(),this.Ssn.Equals(this.Hte.ActorLocationProxy)&&this.Gwa.Equals(this.Hte.ActorRotationProxy)||this.oRe.SetModelBuffer(h,t))}this.Msn.ApplyForceSpeedAndRecordSpeed(),this.Esn&&this.Esn.MarkDebugRecord("移动组件更新后",void 0,!0)}}Dth(){this.Hte?.IsRoleAndCtrlByMe&&1<Time_1.Time.Frame-this.Isn&&Log_1.Log.CheckWarn()&&Log_1.Log.Warn("Movement",6,"[b1057126] 角色更新异常",["DebugLastTickFrame",this.Isn],["Current",Time_1.Time.Frame]),this.Isn=Time_1.Time.Frame}};UeMovementTickManageComponent=__decorate([(0,RegisterComponent_1.RegisterComponent)(101)],UeMovementTickManageComponent),exports.UeMovementTickManageComponent=UeMovementTickManageComponent;
//# sourceMappingURL=UeMovementTickManageComponent.js.map