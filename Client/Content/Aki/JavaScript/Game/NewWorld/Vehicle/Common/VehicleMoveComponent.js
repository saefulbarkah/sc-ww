
"use strict";var __decorate=this&&this.__decorate||function(t,i,s,h){var e,r=arguments.length,o=r<3?i:null===h?h=Object.getOwnPropertyDescriptor(i,s):h;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,i,s,h);else for(var n=t.length-1;0<=n;n--)(e=t[n])&&(o=(r<3?e(o):3<r?e(i,s,o):e(i,s))||o);return 3<r&&o&&Object.defineProperty(i,s,o),o};Object.defineProperty(exports,"__esModule",{value:!0}),exports.VehicleMoveComponent=void 0;const UE=require("ue"),Log_1=require("../../../../Core/Common/Log"),EntityComponent_1=require("../../../../Core/Entity/EntityComponent"),RegisterComponent_1=require("../../../../Core/Entity/RegisterComponent"),Quat_1=require("../../../../Core/Utils/Math/Quat"),Rotator_1=require("../../../../Core/Utils/Math/Rotator"),Vector_1=require("../../../../Core/Utils/Math/Vector"),MathUtils_1=require("../../../../Core/Utils/MathUtils"),GravityUtils_1=require("../../../Utils/GravityUtils"),MIN_MOVE_SPEED=20,INVALID_FORCE_SPEED=-1e8,cannotResponseInputTag=[-648310348,-2044964178,1008164187,191377386];let VehicleMoveComponent=class VehicleMoveComponent extends EntityComponent_1.EntityComponent{constructor(){super(...arguments),this.ActorComp=void 0,this.AnimComp=void 0,this.TagComponent=void 0,this.VehicleMovement=void 0,this.IsMoving=!1,this.HasMoveInput=!1,this.IsSpecialMove=!1,this.DeltaTimeSeconds=0,this.IsStopInternal=!1,this.ForceSpeed=Vector_1.Vector.Create(INVALID_FORCE_SPEED,INVALID_FORCE_SPEED,INVALID_FORCE_SPEED),this.Speed=0,this.AimYawRate=0,this.Acceleration=Vector_1.Vector.Create(),this.PreviousAimYaw=0,this.PreviousVelocity=Vector_1.Vector.Create(),this.TurnRate=1,this.CanMoveWithDistanceInternal=!0,this.CanMoveFromInputInternal=!0,this.AdditiveTurnYaw=0,this.AdditiveTurnYawCache=0,this.AdditiveTurnDuration=0,this.AdditiveTurnElapsedTime=0,this.CannotResponseInputCount=0,this.CanResponseInputTasks=new Array,this.GravityDirectInternal=Vector_1.Vector.Create(0,0,-1),this.GravityUpInternal=Vector_1.Vector.Create(0,0,1),this.IsStandardGravityInternal=!0,this.TmpVector=Vector_1.Vector.Create(),this.TmpRotator=Rotator_1.Rotator.Create(),this.TmpQuat=Quat_1.Quat.Create(),this.TmpQuat2=Quat_1.Quat.Create(),this.OnResponseInputTagsChanged=(t,i)=>{i?(0===this.CannotResponseInputCount&&(this.HasMoveInput=!1),++this.CannotResponseInputCount):--this.CannotResponseInputCount}}get CanMoveFromInput(){return this.CanMoveFromInputInternal}set CanMoveFromInput(t){this.CanMoveFromInputInternal=t}SetGravityDirect(t){this.SetGravityDirectByNumber(t.X,t.Y,t.Z)}get GravityDirect(){return this.GravityDirectInternal}get GravityUp(){return this.GravityUpInternal}get IsStandardGravity(){return this.IsStandardGravityInternal}OnInitData(t){return!0}OnInit(t){return this.IsStandardGravityInternal=!0,this.GravityDirectInternal.Set(0,0,-1),this.GravityUpInternal.Set(0,0,1),!0}OnStart(){if(this.ActorComp=this.Entity.GetComponent(214),this.AnimComp=this.Entity.GetComponent(215),this.TagComponent=this.Entity.GetComponent(191),this.VehicleMovement=this.ActorComp.Actor.GetComponentByClass(UE.KuroVehicleMovementComponent.StaticClass()),!this.VehicleMovement)return!1;if(this.GravityDirectInternal.FromUeVector(this.VehicleMovement.Kuro_GetGravityDirect()),this.IsStandardGravityInternal=Math.abs(this.GravityDirectInternal.Z+1)<MathUtils_1.MathUtils.SmallNumber,this.IsStandardGravityInternal&&this.GravityDirectInternal.Set(0,0,-1),this.GravityDirectInternal.UnaryNegation(this.GravityUpInternal),this.VehicleMovement.GravityScale=2,this.CannotResponseInputCount=0,this.TagComponent)for(const t of cannotResponseInputTag)this.TagComponent.HasTag(t)&&++this.CannotResponseInputCount,this.CanResponseInputTasks.push(this.TagComponent.ListenForTagAddOrRemove(t,this.OnResponseInputTagsChanged));return!0}OnActivate(){}OnTick(i){if(super.OnTick(i),this.CanMoveWithDistanceInternal=this.Entity.DistanceWithCamera<=7e3,this.ActorComp&&(this.DeltaTimeSeconds=i*MathUtils_1.MathUtils.MillisecondToSecond,!this.IsSpecialMove)){this.IsStopInternal?this.Speed=0:this.Speed=this.ActorComp.ActorVelocityProxy.Size2D(),this.IsMoving=this.Speed>MIN_MOVE_SPEED;var s=1<this.Entity.GetTickInterval()&&this.AnimComp?.Valid&&this.ActorComp.Owner.WasRecentlyRenderedOnScreen();let t=void 0;s&&(t=this.AnimComp.GetMeshTransform()),this.CanResponseInput()?(this.SetInfoVar(),this.CacheVar()):this.HasMoveInput=!1,this.ActorComp.IsMoveAutonomousProxy&&(s&&this.IsMoving&&this.AnimComp.SetModelBuffer(t,i),this.ActorComp.Actor.AddMovementInput(this.ActorComp.InputDirect,1,!1))}}OnEnd(){for(const t of this.CanResponseInputTasks)t.EndTask();return!(this.CanResponseInputTasks.length=0)}OnClear(){return!0}OnDisable(t){}OnEnable(){}SetInfoVar(){this.DeltaTimeSeconds>MathUtils_1.MathUtils.SmallNumber&&(this.Acceleration.DeepCopy(this.ActorComp.ActorVelocityProxy),this.Acceleration.SubtractionEqual(this.PreviousVelocity),this.Acceleration.DivisionEqual(this.DeltaTimeSeconds),this.AimYawRate=Math.abs(this.ActorComp.ActorRotationProxy.Yaw-this.PreviousAimYaw)/this.DeltaTimeSeconds),this.HasMoveInput=GravityUtils_1.GravityUtils.GetPlanarSizeSquared2D(this.ActorComp,this.ActorComp.InputDirectProxy)>MathUtils_1.MathUtils.SmallNumber}CacheVar(){this.PreviousVelocity.DeepCopy(this.ActorComp.ActorVelocityProxy),this.PreviousAimYaw=this.ActorComp.ActorRotation.Yaw}SetGravityDirectByNumber(t,i,s,h=0){this.TmpVector.X=t,this.TmpVector.Y=i,this.TmpVector.Z=s,this.TmpVector.Normalize()&&!this.GravityDirectInternal.Equals(this.TmpVector)&&(t=Math.acos(Vector_1.Vector.DotProduct(this.GravityDirectInternal,this.TmpVector))/Math.PI*500,Quat_1.Quat.FindBetween(this.GravityDirectInternal,this.TmpVector,this.TmpQuat),this.TmpQuat.Multiply(this.ActorComp.ActorQuatProxy,this.TmpQuat2),this.TmpQuat.Rotator(this.TmpRotator),this.IsStandardGravityInternal=Math.abs(this.TmpVector.Z+1)<MathUtils_1.MathUtils.SmallNumber,this.IsStandardGravityInternal?this.GravityDirectInternal.Set(0,0,-1):this.GravityDirectInternal.DeepCopy(this.TmpVector),this.GravityDirectInternal.UnaryNegation(this.GravityUpInternal),this.VehicleMovement&&this.VehicleMovement.Kuro_SetGravityDirect(this.GravityDirectInternal.ToUeVector()),this.AnimComp?this.AnimComp.SetLocationAndRotatorWithModelBuffer(this.ActorComp.ActorLocationProxy.ToUeVector(),this.TmpRotator.ToUeRotator(),t,"SetGravity"):this.ActorComp.SetActorRotation(this.TmpRotator.ToUeRotator(),"SetGravity"),this.TmpQuat.RotateVector(this.ActorComp.InputDirectProxy,this.TmpVector),this.ActorComp.SetInputDirect(this.TmpVector),this.TmpQuat.RotateVector(this.ActorComp.InputFacingProxy,this.TmpVector),this.ActorComp.SetInputFacing(this.TmpVector))}CanResponseInput(){return 0===this.CannotResponseInputCount}SpeedScaled(t){return t}ApplyForceSpeedAndRecordSpeed(){this.ForceSpeed.X!==INVALID_FORCE_SPEED&&(this.ForceSpeed.ContainsNaN()?Log_1.Log.CheckError()&&Log_1.Log.Error("Movement",6,"ForceSpeed Nan.",["V",this.ForceSpeed]):this.VehicleMovement.Velocity=this.ForceSpeed.ToUeVector(),this.ActorComp.ResetCachedVelocityTime(),this.ForceSpeed.X=INVALID_FORCE_SPEED)}SetForceSpeed(t){t.ContainsNaN()&&Log_1.Log.CheckError()&&Log_1.Log.Error("Movement",6,"SetForceSpeed Contains NaN",["speed",t]),this.ForceSpeed.DeepCopy(t),this.VehicleMovement&&(this.VehicleMovement.Velocity=this.ForceSpeed.ToUeVector()),this.ActorComp&&this.ActorComp.ResetCachedVelocityTime()}CanMove(){return this.CanMoveFromInputInternal&&this.CanMoveWithDistanceInternal}};VehicleMoveComponent=__decorate([(0,RegisterComponent_1.RegisterComponent)(216)],VehicleMoveComponent),exports.VehicleMoveComponent=VehicleMoveComponent;
//# sourceMappingURL=VehicleMoveComponent.js.map