
"use strict";var __decorate=this&&this.__decorate||function(e,t,r,i){var o,s=arguments.length,h=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)h=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;0<=a;a--)(o=e[a])&&(h=(s<3?o(h):3<s?o(t,r,h):o(t,r))||h);return 3<s&&h&&Object.defineProperty(t,r,h),h};Object.defineProperty(exports,"__esModule",{value:!0}),exports.VehiclePerformComponent=void 0;const cpp_1=require("cpp"),UE=require("ue"),QueryTypeDefine_1=require("../../../../Core/Define/QueryTypeDefine"),RegisterComponent_1=require("../../../../Core/Entity/RegisterComponent"),MathCommon_1=require("../../../../Core/Utils/Math/MathCommon"),Rotator_1=require("../../../../Core/Utils/Math/Rotator"),Vector_1=require("../../../../Core/Utils/Math/Vector"),MathUtils_1=require("../../../../Core/Utils/MathUtils"),ControllerHolder_1=require("../../../Manager/ControllerHolder"),ModelManager_1=require("../../../Manager/ModelManager"),GameBudgetAllocatorConfigCreator_1=require("../../../World/Define/GameBudgetAllocatorConfigCreator"),BaseVehiclePerformComponent_1=require("./BaseVehiclePerformComponent");let VehiclePerformComponent=class VehiclePerformComponent extends BaseVehiclePerformComponent_1.BaseVehiclePerformComponent{constructor(){super(...arguments),this.ActorComp=void 0,this.AnimComp=void 0,this.MoveComp=void 0,this.TagComp=void 0,this.IsBeingImpacted=!1,this.CollisionStrength=0,this.CollisionDirection=0,this.CollisionVelocity=Vector_1.Vector.Create(),this.HasRoleAndCtrlByMe=!1,this.IsHidePassenger=!1,this.LastActorRotation=Rotator_1.Rotator.Create(),this.VehicleTagListeners=void 0,this.OnEnterHitCollision=(e,t,r,i,o)=>{this.CalculateImpactStrength(o),this.CalculateImpactDirection(o),this.IsBeingImpacted=!0,this.MoveComp?.EnableUeMovementTick("载具受到碰撞")}}OnStart(){if(!super.OnStart())return!1;this.ActorComp=this.Entity.GetComponent(228),this.AnimComp=this.Entity.GetComponent(229),this.MoveComp=this.Entity.GetComponent(230),this.TagComp=this.Entity.GetComponent(200),this.HasRoleAndCtrlByMe=!1;var e=this.ActorComp?.Owner;return e?.IsValid()&&e.CapsuleComponent.OnComponentHit.Add(this.OnEnterHitCollision),!!this.InitVehicleConfig()}OnTick(e){this.UpdateRotYawSpeed(e)}LoadVehicleConfigAsset(){if(this.ActorComp?.Actor.VehicleMovementComponent?.IsValid())return super.LoadVehicleConfigAsset()}Enter(e,t){super.Enter(e,t);for(const r of this.PassengerInfoMap.values())if(r.IsDriver&&r.IsRolePassenger()){this.Entity.GameBudgetManagedToken&&cpp_1.FKuroGameBudgetAllocatorInterface.MarkActorInFighting(GameBudgetAllocatorConfigCreator_1.GameBudgetAllocatorConfigCreator.TsNormalEntityGroupConfig.GroupName,this.Entity.GameBudgetManagedToken,!0);break}e.GetComponent(3)?.IsAutonomousProxy&&this.AddVehicleTagListeners()}Leave(e,t=0){super.Leave(e,t);let r=!1;for(const i of this.PassengerInfoMap.values())if(i.IsDriver&&i.IsRolePassenger()){r=!0;break}r||this.Entity.GameBudgetManagedToken&&cpp_1.FKuroGameBudgetAllocatorInterface.MarkActorInFighting(GameBudgetAllocatorConfigCreator_1.GameBudgetAllocatorConfigCreator.TsNormalEntityGroupConfig.GroupName,this.Entity.GameBudgetManagedToken,!1),e.GetComponent(3)?.Owner?.IsAutonomousProxy&&this.RemoveVehicleTagListeners()}CheckIfCanLeave(){return!0}CheckIfCanSprint(){return!0}CheckIfCanRiderSharing(){return!!ModelManager_1.ModelManager.VehicleModel?.CanRiderSharing}AddVehicleTagListeners(){}RemoveVehicleTagListeners(){}CalculateImpactStrength(e){var t=e.Component,r=this.TmpVector1,i=this.TmpVector2;r.FromUeVector(e.ImpactNormal),i.Reset(),t&&i.FromUeVector(t.GetComponentVelocity()),this.ActorComp.ActorVelocityProxy.Subtraction(i,this.CollisionVelocity),this.CollisionStrength=Math.abs(Vector_1.Vector.DotProduct(this.CollisionVelocity,r))}CalculateImpactDirection(e){var t=this.CollisionVelocity.ToUeVector(),r=this.ActorComp.ActorRight,r=t.CosineAngle2D(r),r=MathCommon_1.MathCommon.RadianToDegree(Math.acos(r)),i=this.ActorComp.ActorForward,t=t.CosineAngle2D(i),i=MathCommon_1.MathCommon.RadianToDegree(Math.acos(t));r>MathCommon_1.MathCommon.RightAngle?this.CollisionDirection=-1*i:this.CollisionDirection=i}EnterVehiclePerform(e){e.IsRolePassenger(!0)&&(this.HasRoleAndCtrlByMe=!0,this.IgnorePlatformCollisionToCamera(!0)),this.IsHidePassenger&&e.PassengerEntity&&ControllerHolder_1.ControllerHolder.CreatureController.SetActorVisible(e.PassengerEntity,!1,!1,!0,"LeaveVehiclePerform")}LeaveVehiclePerform(e){e.IsRolePassenger(!0)&&(this.HasRoleAndCtrlByMe=!1,this.IgnorePlatformCollisionToCamera(!1)),this.IsHidePassenger&&e.PassengerEntity&&ControllerHolder_1.ControllerHolder.CreatureController.SetActorVisible(e.PassengerEntity,!0,!0,!0,"LeaveVehiclePerform")}IgnorePlatformCollisionToCamera(e){var t=this.ActorComp?.Actor.PlatformActor;t?.IsValid()&&(t=t.GetComponentByClass(UE.StaticMeshComponent.StaticClass()))?.IsValid()&&(e?t.SetCollisionResponseToChannel(QueryTypeDefine_1.KuroCollisionChannel.Camera,0):t.SetCollisionResponseToChannel(QueryTypeDefine_1.KuroCollisionChannel.Camera,2))}CheckCanPerformHit(){return!0}OnBulletHit(e,t){}GetVehicleVelocity(e){this.ActorComp&&e.DeepCopy(this.ActorComp.ActorVelocityProxy)}UpdateRotYawSpeed(e){var t=this.LastActorRotation.Yaw,r=this.ActorComp.ActorRotationProxy.Yaw;this.ActorComp.SimulatedRotYawSpeed=MathUtils_1.MathUtils.WrapAngle(r-t)/(.001*e),this.LastActorRotation.DeepCopy(this.ActorComp.ActorRotationProxy)}};VehiclePerformComponent=__decorate([(0,RegisterComponent_1.RegisterComponent)(231)],VehiclePerformComponent),exports.VehiclePerformComponent=VehiclePerformComponent;
//# sourceMappingURL=VehiclePerformComponent.js.map