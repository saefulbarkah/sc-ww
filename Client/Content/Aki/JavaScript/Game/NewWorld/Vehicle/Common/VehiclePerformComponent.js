
"use strict";var __decorate=this&&this.__decorate||function(e,t,i,r){var s,h=arguments.length,n=h<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;0<=o;o--)(s=e[o])&&(n=(h<3?s(n):3<h?s(t,i,n):s(t,i))||n);return 3<h&&n&&Object.defineProperty(t,i,n),n};Object.defineProperty(exports,"__esModule",{value:!0}),exports.VehiclePerformComponent=void 0;const Log_1=require("../../../../Core/Common/Log"),EntityComponent_1=require("../../../../Core/Entity/EntityComponent"),RegisterComponent_1=require("../../../../Core/Entity/RegisterComponent"),MathCommon_1=require("../../../../Core/Utils/Math/MathCommon"),Vector_1=require("../../../../Core/Utils/Math/Vector"),IComponent_1=require("../../../../UniverseEditor/Interface/IComponent"),VehicleInfoDefines_1=require("./VehicleInfoDefines");let VehiclePerformComponent=class VehiclePerformComponent extends EntityComponent_1.EntityComponent{constructor(){super(...arguments),this.ActorComp=void 0,this.AnimComp=void 0,this.MoveComp=void 0,this.InputComp=void 0,this.TagComp=void 0,this.IsBeingImpacted=!1,this.CollisionStrength=0,this.CollisionDirection=0,this.CollisionVelocity=Vector_1.Vector.Create(),this.Drivers=new Set,this.PassengerInfoMap=new Map,this.SeatInfoMap=new Map,this.MaxSeatCount=0,this.DriverSeat=-1,this.CanBeenManipulated=!0,this.TmpVector1=Vector_1.Vector.Create(),this.TmpVector2=Vector_1.Vector.Create(),this.TmpVector3=Vector_1.Vector.Create(),this.OnEnterHitCollision=(e,t,i,r,s)=>{this.CalculateImpactStrength(s),this.CalculateImpactDirection(s),this.IsBeingImpacted=!0}}OnInitData(e){var t=this.Entity.GetComponent(0).GetPbEntityInitData();return t?.ComponentsData&&(t=(0,IComponent_1.getComponent)(t.ComponentsData,"VehicleComponent"))&&(this.MaxSeatCount=t.SeatCount,this.DriverSeat=t.DriverSeat??-1),!0}OnInit(e){return!0}OnStart(){this.ActorComp=this.Entity.GetComponent(214),this.AnimComp=this.Entity.GetComponent(215),this.MoveComp=this.Entity.GetComponent(216),this.InputComp=this.Entity.GetComponent(219),this.TagComp=this.Entity.GetComponent(191);var e=this.ActorComp?.Owner;return e?.IsValid()&&e.CapsuleComponent.OnComponentHit.Add(this.OnEnterHitCollision),!0}OnActivate(){}OnTick(e){}OnEnd(){return!0}OnClear(){return!0}OnDisable(e){}OnEnable(){}Enter(e,t){var i,r;return!!this.EnterConditionCheck(e,t)&&(i=this.DriverSeat===t,(r=new VehicleInfoDefines_1.VehiclePassengerInfo).VehicleEntity=this.Entity,r.PassengerEntity=e,r.IsDriver=i,r.Seat=t,this.PassengerInfoMap.set(e.Id,r),this.SeatInfoMap.set(t,r),i&&this.Drivers.add(e),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Vehicle",50,"[VehiclePerformComp] 进入载具",["Vehicle",this.ActorComp?.CreatureData.GetPbDataId()],["Passenger",e.GetComponent(0)?.GetPbDataId()],["Seat",t],["isDriver",i]),this.OnEnterVehicle(r),!0)}Leave(e){if(!this.LeaveConditionCheck(e))return!1;Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Vehicle",50,"[VehiclePerformComp] 退出载具",["Vehicle",this.ActorComp?.CreatureData.GetPbDataId()],["Passenger",e.GetComponent(0)?.GetPbDataId()],["isDriver",this.Drivers.has(e)]);var t=this.PassengerInfoMap.get(e.Id);return this.OnLeaveVehicle(t),this.PassengerInfoMap.delete(e.Id),this.Drivers.delete(e),!0}IsDriver(e){return this.Drivers.has(e)}IsPassenger(e){return this.PassengerInfoMap.has(e.Id)}EnterConditionCheck(e,t){return!!this.CanBeenManipulated&&!(t<0||t>=this.MaxSeatCount||this.SeatInfoMap.has(t)||!(t=e.GetComponent(213))||t.IsOnVehicle)}LeaveConditionCheck(e){return!0}CalculateImpactStrength(e){var t=e.Component,i=this.TmpVector1,r=this.TmpVector2;i.FromUeVector(e.ImpactNormal),r.Reset(),t&&r.FromUeVector(t.GetComponentVelocity()),this.ActorComp.ActorVelocityProxy.Subtraction(r,this.CollisionVelocity),this.CollisionStrength=Math.abs(Vector_1.Vector.DotProduct(this.CollisionVelocity,i))}CalculateImpactDirection(e){var t=this.CollisionVelocity.ToUeVector(),i=this.ActorComp.ActorRight,i=t.CosineAngle2D(i),i=MathCommon_1.MathCommon.RadianToDegree(Math.acos(i)),r=this.ActorComp.ActorForward,t=t.CosineAngle2D(r),r=MathCommon_1.MathCommon.RadianToDegree(Math.acos(t));i>MathCommon_1.MathCommon.RightAngle?this.CollisionDirection=-1*r:this.CollisionDirection=r}OnEnterVehicle(e){}OnLeaveVehicle(e){}EnterVehiclePerform(e){}LeaveVehiclePerform(e){}};VehiclePerformComponent=__decorate([(0,RegisterComponent_1.RegisterComponent)(217)],VehiclePerformComponent),exports.VehiclePerformComponent=VehiclePerformComponent;
//# sourceMappingURL=VehiclePerformComponent.js.map