
"use strict";var __decorate=this&&this.__decorate||function(t,e,o,r){var i,s=arguments.length,n=s<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,o,r);else for(var a=t.length-1;0<=a;a--)(i=t[a])&&(n=(s<3?i(n):3<s?i(e,o,n):i(e,o))||n);return 3<s&&n&&Object.defineProperty(e,o,n),n};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CharacterFollowComponent=void 0;const UE=require("ue"),Log_1=require("../../../../../Core/Common/Log"),Protocol_1=require("../../../../../Core/Define/Net/Protocol"),EntityComponent_1=require("../../../../../Core/Entity/EntityComponent"),EntitySystem_1=require("../../../../../Core/Entity/EntitySystem"),RegisterComponent_1=require("../../../../../Core/Entity/RegisterComponent"),ModelManager_1=require("../../../../Manager/ModelManager"),ActorUtils_1=require("../../../../Utils/ActorUtils");var EProtoSummonType=Protocol_1.Aki.Protocol.Summon.x3s;const PhantomUtil_1=require("../../../../Module/Phantom/PhantomUtil");let CharacterFollowComponent=class CharacterFollowComponent extends EntityComponent_1.EntityComponent{constructor(){super(...arguments),this.u1t=void 0,this.v5r=[],this.JGi=0,this.SummonTypeInternal=0,this.IsSummonerInternal=!1}get FollowIds(){return this.v5r}get RoleId(){return this.JGi}get SummonType(){return this.SummonTypeInternal}OnStart(){return this.u1t=this.Entity.GetComponent(0),!0}OnActivate(){return this.fJs(),!0}OnEnd(){return this.DeleteFollowEntity(),!0}SetRoleId(t,e,o=!1){this.JGi=t,this.SummonTypeInternal=e,this.IsSummonerInternal=o,0!==this.JGi&&(t=EntitySystem_1.EntitySystem.Get(this.JGi)?.GetComponent(86))&&this.Entity.GetComponent(34)?.ResetRoleGrowComponent(t)}GetRoleActor(){var t=EntitySystem_1.EntitySystem.Get(this.JGi);if(t?.Valid)return t.GetComponent(1).Owner}GetFollowActor(){var t=this.v5r,e=UE.NewArray(UE.Actor);if(t)for(const r of t){var o=EntitySystem_1.EntitySystem.Get(r);o?.Valid&&(o=o.GetComponent(1).Owner)&&e.Add(o)}return e}SetFollowId(t){-1!==this.v5r.indexOf(t)?Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Character",22,"Add the Same Summon Id:",["id",t]):this.v5r.push(t)}DeleteFollowEntity(){var t=ModelManager_1.ModelManager.CreatureModel.GetEntity(this.u1t.GetSummonerId());t?.Valid&&t.Entity.GetComponent(49).pJs(this.Entity.Id)}GetAttributeHolder(t=!1){if(!(t&&this.IsSummonerInternal||0===this.RoleId||2!==this.SummonType)){t=EntitySystem_1.EntitySystem.Get(this.RoleId);if(t?.Valid)return t;Log_1.Log.CheckError()&&Log_1.Log.Error("Character",20,"FollowComp role is inValid",["Id",this.RoleId],["SelfId",this.u1t?.GetCreatureDataId()])}}SetFollowData(e,o){if(e?.IsValid()){var e=ActorUtils_1.ActorUtils.GetEntityByActor(e),r=e?.Entity?.GetComponent(49);if(r){var i=this.u1t.GetVisionComponent();let t=!1;i&&(i=PhantomUtil_1.PhantomUtil.GetVisionData(i.VisionId))&&(t=0===i.类型),r.SetRoleId(this.Entity.Id,o,t),this.SetFollowId(e.Id)}else Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Character",22,"该角色没有CharacterFollowComponent组件")}else Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Character",22,"SetFollowData 对象为null")}Reset(t=0){this.pJs(t),this.SummonTypeInternal=0,this.JGi=0}GetToRoleDistance(){var t;return this.RoleId&&(t=EntitySystem_1.EntitySystem.Get(this.RoleId))&&this.Entity&&this.Entity.GetComponent(1)&&t.GetComponent(1)?UE.Vector.Dist(this.Entity.GetComponent(1).ActorLocation,t.GetComponent(1).ActorLocation):-1}fJs(){var e=ModelManager_1.ModelManager.CreatureModel.GetEntity(this.u1t.GetSummonerId());if(e?.Valid){if(this.u1t.SummonType===EProtoSummonType.Proto_ESummonTypeConcomitantVision){var o=this.u1t.GetVisionComponent();let t=!1;o&&(o=PhantomUtil_1.PhantomUtil.GetVisionData(o.VisionId))&&(t=0===o.类型);o=e.Entity.GetComponent(49);this.SetRoleId(e.Id,2,t),o.SetFollowId(this.Entity.Id)}var t=this.Entity.GetComponent(191);if(t)switch(t.RemoveTag(-1615796724),this.u1t?.SummonType){case EProtoSummonType.Proto_ESummonTypeConcomitantVision:t.AddTag(-1885259054);break;case EProtoSummonType.Proto_ESummonTypeConcomitantCustom:t.AddTag(231190961);break;case EProtoSummonType.Proto_ESummonTypeConcomitantPhantomRole:t.AddTag(-260700306);break;default:EProtoSummonType.Proto_ESummonTypeDefault;t.AddTag(1450201850)}}}pJs(t){0!==t?-1!==(t=this.v5r.indexOf(t))&&this.v5r.splice(t,1):this.v5r=[]}};CharacterFollowComponent=__decorate([(0,RegisterComponent_1.RegisterComponent)(49)],CharacterFollowComponent),exports.CharacterFollowComponent=CharacterFollowComponent;
//# sourceMappingURL=CharacterFollowComponent.js.map