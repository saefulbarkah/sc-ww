
"use strict";var CharacterBuffComponent_1,__decorate=this&&this.__decorate||function(t,e,o,i){var r,s=arguments.length,f=s<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)f=Reflect.decorate(t,e,o,i);else for(var a=t.length-1;0<=a;a--)(r=t[a])&&(f=(s<3?r(f):3<s?r(e,o,f):r(e,o))||f);return 3<s&&f&&Object.defineProperty(e,o,f),f};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CharacterBuffComponent=void 0;const Info_1=require("../../../../../../Core/Common/Info"),Stats_1=require("../../../../../../Core/Common/Stats"),CommonDefine_1=require("../../../../../../Core/Define/CommonDefine"),Protocol_1=require("../../../../../../Core/Define/Net/Protocol"),EntitySystem_1=require("../../../../../../Core/Entity/EntitySystem"),RegisterComponent_1=require("../../../../../../Core/Entity/RegisterComponent"),GameplayTagUtils_1=require("../../../../../../Core/Utils/GameplayTagUtils"),MathUtils_1=require("../../../../../../Core/Utils/MathUtils"),ModelManager_1=require("../../../../../Manager/ModelManager"),CombatMessage_1=require("../../../../../Module/CombatMessage/CombatMessage"),CombatLog_1=require("../../../../../Utils/CombatLog"),BaseBuffComponent_1=require("./BaseBuffComponent"),ActiveBuffConfigs_1=require("./Buff/ActiveBuffConfigs"),CharacterAttributeTypes_1=require("./CharacterAttributeTypes"),CharacterBuffController_1=require("./CharacterBuffController"),ExtraEffectManager_1=require("./ExtraEffect/ExtraEffectManager"),NO_BROADCAST_CD_THRESHOLD=1e4;let CharacterBuffComponent=CharacterBuffComponent_1=class CharacterBuffComponent extends BaseBuffComponent_1.BaseBuffComponent{constructor(){super(...arguments),this.ActorComponent=void 0,this.AttributeComponent=void 0,this.DeathComponent=void 0,this.TagComponent=void 0,this.TimeScaleComponent=void 0,this.CueComponent=void 0,this.PauseLocks=new Set,this.BuffEffectManager=void 0,this.Vbr=!1,this.Hbr=ActiveBuffConfigs_1.INVALID_BUFF_HANDLE}GetDebugName(){return(this.CreatureDataComponent?.GetCreatureDataId()??"非正常实体(entity id="+this.Entity?.Id)+""}GetEntity(){return this.Entity}AddPauseLock(t){this.PauseLocks.add(t),this.RefreshTimeScale()}RemovePauseLock(t){this.PauseLocks.delete(t),this.RefreshTimeScale()}IsPaused(){return 0<this.PauseLocks.size}GetTimeScale(){return this.Entity.TimeDilation*(this.TimeScaleComponent?.CurrentTimeScale??1)}GetAttributeComponent(){return this.AttributeComponent}GetTagComponent(){return this.TagComponent}GetSkillComponent(){return this.Entity.GetComponent(35)}GetActorComponent(){return this.ActorComponent}GetCueComponent(){return this.CueComponent}get CreatureDataId(){return this.CreatureDataComponent.GetCreatureDataId()}OnInitData(){return this.BuffEffectManager=new ExtraEffectManager_1.ExtraEffectManager(this),!0}OnInit(){return super.OnInit(),this.ActorComponent=this.Entity.CheckGetComponent(3),this.AttributeComponent=this.Entity.CheckGetComponent(162),this.TagComponent=this.Entity.CheckGetComponent(194),this.CueComponent=this.Entity.GetComponent(19),this.DeathComponent=this.Entity.GetComponent(15),this.TimeScaleComponent=this.Entity.GetComponent(111),!0}OnStart(){return this.BuffEffectManager?.Clear(),!0}InitBornBuff(){var t=this.CreatureDataComponent.ComponentDataMap,e=t.get("mys")?.mys?.MIs;if(e&&this.HasBuffAuthority())for(const u of e){var o=MathUtils_1.MathUtils.LongToNumber(u.Rjn),i=u.$8n?MathUtils_1.MathUtils.LongToBigInt(u.$8n):void 0,r=MathUtils_1.MathUtils.LongToBigInt(u.b6n);this.AddBuffLocal(r,{InstigatorId:o,Level:u.F6n,ApplyType:u.xjn,PreMessageId:i,Duration:u.n5n,IsIterable:u.Pjn,OuterStackCount:u.Bjn,ServerId:u.wjn,IsServerOrder:!0,Reason:"服务端或其它客户端请求添加Buff(缓冲) messageId="+i})}e=t.get("vys")?.vys?.EIs,t=t.get("vys")?.vys?.SIs;if(e)for(const c of e){var s=MathUtils_1.MathUtils.LongToBigInt(c.b6n);for(let t=0;t<c.GTs.length;t++)this.SetBuffEffectCd(s,t,c.GTs[t]*CommonDefine_1.MILLIONSECOND_PER_SECOND)}if(t)for(const l of t){var f=l,a=MathUtils_1.MathUtils.LongToBigInt(f.b6n??-1),n=MathUtils_1.MathUtils.LongToNumber(f.Rjn),h=f.cVn??ActiveBuffConfigs_1.INVALID_BUFF_HANDLE;this.AddBuffRemote(a,h,{Level:f.F6n,InstigatorId:n,ApplyType:f.xjn,Duration:f.n5n,RemainDuration:f.QEs,IsActive:f.WHn,ServerId:f.wjn,OuterStackCount:f.Bjn,Reason:"服务器通过通知FightBuffComponent恢复Buff",MessageId:MathUtils_1.MathUtils.LongToBigInt(f.$8n)}),this.BuffContainer.get(h)?.SetRemainDuration(f.QEs)}}OnClear(){this.TriggerMap.clear();for(const t of[...this.BuffContainer.values()])t.Destroy();return this.PauseLocks.clear(),super.OnClear(),!0}OnActivate(){for(const t of this.GetAllBuffs())this.CueComponent?.CreateGameplayCueByBuff(t);this.Vbr=!0,this.InitBornBuff()}HasBuffAuthority(){var t;return!(this.CreatureDataComponent&&(this.CreatureDataComponent.GetEntityType()!==Protocol_1.Aki.Protocol.kks.Proto_Monster||!this.DeathComponent?.IsDead()))||(t=this.CreatureDataComponent?.GetSummonerPlayerId(),ModelManager_1.ModelManager.PlayerInfoModel.GetId()===t)}AddBuffWithServerId(e,o,i,r,s){if(!(e<=ActiveBuffConfigs_1.NULL_BUFF_ID))for(let t=0;t<i;t++){var f=this.AddBuffLocal(e,{InstigatorId:this.CreatureDataId,Level:o,Duration:ActiveBuffConfigs_1.DEFAULT_SERVER_GE_DURATION,ServerId:r,Reason:s}),a=CharacterBuffController_1.default.GetBuffDefinition(e);f===ActiveBuffConfigs_1.INVALID_BUFF_HANDLE&&CombatLog_1.CombatLog.Error("Buff",this.Entity,"系统buff添加失败",["buffId",e],["serverId",r],["持有者",this.GetDebugName()],["说明",a?.Desc])}}RemoveBuffByServerIdLocal(t,e){if(this.HasBuffAuthority())for(const i of[...this.BuffContainer.values()]){var o=i.Handle;this.BuffGarbageSet.has(o)||i.ServerId===t&&this.RemoveBuffInner(o,-1,!0,e)}else CombatLog_1.CombatLog.Error("Buff",this.Entity,"[buffComp] 服务端通知移除非本客户端控制角色持有的系统Buff，需要服务端检查协议是否下发正确",["buffId",t],["持有者",this.GetDebugName()])}RemoveBuffByTagName(t,e=void 0){t=GameplayTagUtils_1.GameplayTagUtils.GetTagIdByName(t);void 0!==t&&this.RemoveBuffByTag(t,e)}RemoveBuffByTag(i,r=void 0){var t;void 0!==i&&(this.HasBuffAuthority()?this.RemoveBuffByTagLocal(i,r):((t=Protocol_1.Aki.Protocol.Y3n.create()).bjn=[i],CombatMessage_1.CombatNet.Call(16704,this.Entity,t,t=>{if(t?.Q4n===Protocol_1.Aki.Protocol.Q4n.Proto_ErrSceneEntityNotExist){var e=GameplayTagUtils_1.GameplayTagUtils.GetNameByTagId(i);for(const o of this.BuffContainer.values())o.Config.GrantedTags?.some(t=>GameplayTagUtils_1.GameplayTagUtils.IsChildTag(t,i))&&this.RemoveBuffInner(o.Handle,-1,!0,r??"移除tag "+e)}})))}RemoveAllBuffs(t){if(this.HasBuffAuthority())for(const e of[...this.BuffContainer.keys()])this.RemoveBuffByHandle(e,-1,t);else for(const o of this.BuffContainer.values())o?.IsValid()&&this.RemoveBuffOrder(o.Id,-1,t)}RemoveAllBuffsByInstigator(t,e){var o=t?.CreatureDataId,t=[...this.BuffContainer.keys()];if(this.HasBuffAuthority())for(const r of t)this.GetBuffByHandle(r)?.InstigatorId===o&&this.RemoveBuffByHandle(r,-1,e);else for(const s of t){var i=this.GetBuffByHandle(s);i?.InstigatorId===o&&this.RemoveBuffOrder(i.Id,-1,e)}}RemoveAllDurationBuffs(t){var e=[];for(const o of this.BuffContainer.values())2===o.Config.DurationPolicy&&e.push(o.Handle);for(const i of e)this.RemoveBuffByHandle(i,-1,t)}GetBuffLevel(t){var e=this.Entity.GetComponent(87)?.GetSkillLevelByBuffId(t);return void 0!==e&&0<e||void 0!==(e=this.Entity.GetComponent(37)?.GetVisionLevelByBuffId(t))&&0<e?e:void 0}OnBuffAdded(t,e,o,i,r,s,f,a,n,h,u){if(t){this.BroadcastAddBuff(t,o,h,a,u);var c=t.Config;if(super.OnBuffAdded(t,e,o,i,r,s,f,a,n,h,u),c.RemoveBuffWithTags&&0<c.RemoveBuffWithTags.length){const u=`因为buff${t.Id}(handle=${t.Handle})的RemoveBuffWithTags导致移除`;for(const l of c.RemoveBuffWithTags)this.HasBuffAuthority()&&this.RemoveBuffByTag(l,u),this.TagComponent.RemoveTag(l)}this.Vbr&&this.CueComponent?.CreateGameplayCueByBuff(t),n&&this.ShareApplyBuffInner(t,e,o,t.MessageId,r,f)}}ShareApplyBuffInner(t,e,o,i,r,s){var f,a,n;this.HasBuffAuthority()&&(f=this.Entity.GetComponent(50)?.RoleId)&&4===t.Config?.FormationPolicy&&(f=EntitySystem_1.EntitySystem.Get(f)?.GetComponent(163))&&(a=t.Id,n=t.Handle,f.AddBuffLocal(a,{InstigatorId:t.InstigatorId??ActiveBuffConfigs_1.NULL_INSTIGATOR_ID,Level:t.Level,OuterStackCount:e,ApplyType:o,PreMessageId:i,Duration:r,ServerId:s,IsIterable:!1,Reason:`因为buff${a}(handle=${n})的队伍共享机制导致的buff添加`}))}OnBuffRemoved(t,e,o,i,r){t&&(this.BroadcastRemoveBuff(t,e,i,r),super.OnBuffRemoved(t,e,o,i,r),this.Vbr&&this.CueComponent?.DestroyGameplayCueByBuff(t),Info_1.Info.IsBuildDevelopmentOrDebug)&&(this.Entity.GetComponent(24)?.OnBuffRemoved(t),this.Entity.GetComponent(20)?.OnBuffRemoved(t))}OnBuffStackIncreased(t,e,o,i,r,s,f,a,n,h,u,c,l){t&&(this.BroadcastBuffStackChanged(t,e,o,!1,l,i),super.OnBuffStackIncreased(t,e,o,i,r,s,f,a,n,h,u,c,l),this.HasBuffAuthority())&&u&&this.ShareApplyBuffInner(t,s,f,t.MessageId,n,h)}OnBuffStackDecreased(t,e,o,i,r){t&&(this.BroadcastBuffStackChanged(t,e,o,i,r),super.OnBuffStackDecreased(t,e,o,i,r))}OnBuffActiveChanged(t,e){t&&t.IsActive()!==e&&(this.BroadcastActivateBuff(t,e),super.OnBuffActiveChanged(t,e))}BroadcastAddBuff(t,e,o,i,r){!t||t.Id<0||!this.NeedBroadcastBuff(t,i)||!t.IsInstantBuff()&&t.Handle<0||((i=Protocol_1.Aki.Protocol.R3n.create()).uVn=t.Handle,i.s5n=MathUtils_1.MathUtils.BigIntToLong(t.Id),i.F6n=t.Level,t.InstigatorId&&(i.Rjn=MathUtils_1.MathUtils.NumberToLong(t.InstigatorId)),i.xjn=e,i.n5n=t.GetRemainDuration(),i.wjn=t.ServerId,i.Bjn=t.StackCount,CombatMessage_1.CombatNet.Call(17711,this.Entity,Protocol_1.Aki.Protocol.R3n.create(i),void 0,t.PreMessageId,t.MessageId,o))}BroadcastActivateBuff(t,e){var o;!t||t.Id<0||!this.NeedBroadcastBuff(t)||((o=Protocol_1.Aki.Protocol.$3n.create()).uVn=t.Handle,o.qjn=e,CombatMessage_1.CombatNet.Call(24873,this.Entity,o))}BroadcastBuffStackChanged(t,e,o,i,r,s){var f;!t||t.Id<0||!this.NeedBroadcastBuff(t)||((f=Protocol_1.Aki.Protocol.u4n.create()).cVn=t.Handle,f.Gjn=o,f.Ojn=i,f.Rjn=s??0,CombatMessage_1.CombatNet.Call(23324,this.Entity,f,void 0))}BroadcastRemoveBuff(t,e,o,i){var r;!t||t.Id<0||!this.NeedBroadcastBuff(t)||((r=Protocol_1.Aki.Protocol.x3n.create()).uVn=t.Handle,r.F4n=MathUtils_1.MathUtils.NumberToLong(this.CreatureDataId),r.Ojn=e,CombatMessage_1.CombatNet.Call(23310,this.Entity,r,void 0,i,void 0,o))}RemoveBuffOrder(e,o,i){var t;e<=0||(CharacterBuffController_1.default.GetBuffDefinition(e),(t=Protocol_1.Aki.Protocol.X3n.create()).s5n=MathUtils_1.MathUtils.BigIntToLong(e),t.Bjn=o,CombatMessage_1.CombatNet.Call(21283,this.Entity,t,t=>{t?.Q4n===Protocol_1.Aki.Protocol.Q4n.Proto_ErrSceneEntityNotExist&&(t=this.GetBuffById(e))&&this.RemoveBuffInner(t.Handle,o,!0,i,void 0,!1)}))}AddBuffOrder(e,{InstigatorId:o,Level:i=ActiveBuffConfigs_1.DEFAULT_BUFF_LEVEL,OuterStackCount:r=0,ApplyType:s=Protocol_1.Aki.Protocol.uFs.Proto_Common,PreMessageId:f=void 0,Duration:a=ActiveBuffConfigs_1.USE_INTERNAL_DURATION,ServerId:n=void 0,IsIterable:h=!0,Reason:u}){var t;e<=0||((t=Protocol_1.Aki.Protocol.Q3n.create()).s5n=MathUtils_1.MathUtils.BigIntToLong(e),t.F6n=i,t.Bjn=r,t.Rjn=MathUtils_1.MathUtils.NumberToLong(o),t.xjn=s,t.n5n=a,t.wjn=n??0,t.Pjn=h,CombatMessage_1.CombatNet.Call(17108,this.Entity,t,t=>{t?.Q4n===Protocol_1.Aki.Protocol.Q4n.Proto_ErrSceneEntityNotExist&&this.AddBuffInner(e,CharacterBuffController_1.default.GetBuffDefinition(e),o,i,r,s,f,void 0,a,void 0,n??0,u,h,!1,!1,void 0)},f))}UpdateSysGrowBuff(t){0<=this.Hbr&&this.RemoveBuffByHandleLocal(this.Hbr,-1,"更新系统成长值");const o=CharacterBuffController_1.default.CreateDynamicBuffRef();o.StackingType=0,o.DurationPolicy=1,o.Modifiers=[],o.Desc="系统成长buff",t.forEach((t,e)=>{0!==t&&o.Modifiers.push({AttributeId:e,Value1:[t],Value2:[0],CalculationPolicy:[0]})}),this.Hbr=this.AddBuffInner(ActiveBuffConfigs_1.DYNAMIC_BUFF_ID,o,this.CreatureDataId,1,void 0,Protocol_1.Aki.Protocol.uFs.Proto_Common,void 0,void 0,ActiveBuffConfigs_1.USE_INTERNAL_DURATION,void 0,ActiveBuffConfigs_1.DEFAULT_GE_SERVER_ID,"更新系统成长值",!1,!0,!1,void 0)}AddAttributeRateModifierLocal(t,e,o){var i;return 0===e?ActiveBuffConfigs_1.INVALID_BUFF_HANDLE:((i=CharacterBuffController_1.default.CreateDynamicBuffRef()).StackingType=0,i.DurationPolicy=1,i.Modifiers=[],i.Desc=o,i.Modifiers.push({AttributeId:t,Value1:[e*CharacterAttributeTypes_1.PER_TEN_THOUSAND],Value2:[0],CalculationPolicy:[1]}),this.AddBuffInner(ActiveBuffConfigs_1.DYNAMIC_BUFF_ID,i,this.CreatureDataId,1,void 0,Protocol_1.Aki.Protocol.uFs.Proto_Common,void 0,void 0,ActiveBuffConfigs_1.USE_INTERNAL_DURATION,void 0,ActiveBuffConfigs_1.DEFAULT_GE_SERVER_ID,o,!1,!0,!1,void 0))}AddTagWithReturnHandle(t,e=-1){var o;return!t||t.length<=0?ActiveBuffConfigs_1.INVALID_BUFF_HANDLE:((o=CharacterBuffController_1.default.CreateDynamicBuffRef()).GrantedTags=[...t],o.StackingType=0,o.DurationPolicy=1,0<e&&(o.DurationPolicy=2,o.DurationCalculationPolicy=[0],o.DurationMagnitude=[e]),o.Desc="AddTagWithReturnHandle",this.AddBuffInner(ActiveBuffConfigs_1.DYNAMIC_BUFF_ID,o,this.CreatureDataId,1,void 0,Protocol_1.Aki.Protocol.uFs.Proto_Common,void 0,void 0,e,void 0,ActiveBuffConfigs_1.DEFAULT_GE_SERVER_ID,"添加tag",!1,!0,!1,void 0))}SetBuffEffectCd(t,e,o){super.SetBuffEffectCd(t,e,o);t=this.GetBuffById(t)?.Handle??ActiveBuffConfigs_1.INVALID_BUFF_HANDLE;this.HasBuffAuthority()&&t!==ActiveBuffConfigs_1.INVALID_BUFF_HANDLE&&o>NO_BROADCAST_CD_THRESHOLD&&((o=Protocol_1.Aki.Protocol.I4n.create()).cVn=t,o.c5n=e,CombatMessage_1.CombatNet.Call(20812,this.Entity,o))}GetDebugBuffString(t=""){let o="";var e=[...t.matchAll(/[0-9]+/g)].map(t=>t[0]??"");for(const r of this.BuffContainer.values()){const s=String(r.Id);if(!(0<e.length)||e.some(t=>s.startsWith(t))){let e=(r.Id===ActiveBuffConfigs_1.DYNAMIC_BUFF_ID?"系统buff":(this.HasBuffAuthority()?"RemoteBuff_":"Buff_")+s)+`(${this.BuffGarbageSet.has(r.Handle)?"销毁":r.IsActive()?"激活":"失效"})  handle: ${r.Handle},  层数: ${r.StackCount},  等级: ${r.Level} 
    施加者: ${r.GetInstigatorActorComponent()?.Actor.GetName()},  时长: ${r.Duration<0?"无限":r.GetRemainDuration().toFixed(1)+"/"+r.Duration.toFixed(1)},  ${0<r.Period?`周期: ${r.GetRemainPeriod()?.toFixed(1)}/`+r.Period.toFixed(1):""}
    说明: ${r.Config?.Desc}
`;r.Config.GrantedTags?.forEach(t=>{e+=`    +附加标签 ${GameplayTagUtils_1.GameplayTagUtils.GetNameByTagId(t)}
`});for(const f of this.BuffEffectManager.GetEffectsByHandle(r.Handle))e+=`    +持续效果 ${""}(cd:${(this.GetBuffEffectCd(r.Id,f.Index)/CommonDefine_1.MILLIONSECOND_PER_SECOND).toFixed(1)}s)
`;for(const a of r.Config.EffectInfos){var i=a.ExecutionEffect;ExtraEffectManager_1.ExtraEffectManager.IsPeriodExecution(a.ExtraEffectId)&&i&&(e+="    +周期效果 \n")}o+=e+"\n"}}return o}};CharacterBuffComponent.jbr=Stats_1.Stat.Create("AddBuff_Born"),CharacterBuffComponent.Kbr=Stats_1.Stat.Create("AddBuff_SysGrow"),CharacterBuffComponent.Qbr=Stats_1.Stat.Create("AddBuff_AttributeRateModifier"),CharacterBuffComponent.Xbr=Stats_1.Stat.Create("AddBuff_AddTag"),CharacterBuffComponent=CharacterBuffComponent_1=__decorate([(0,RegisterComponent_1.RegisterComponent)(163)],CharacterBuffComponent),exports.CharacterBuffComponent=CharacterBuffComponent;
//# sourceMappingURL=CharacterBuffComponent.js.map