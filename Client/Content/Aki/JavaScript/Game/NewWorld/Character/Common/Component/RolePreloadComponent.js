
"use strict";var RolePreloadComponent_1,__decorate=this&&this.__decorate||function(t,e,o,i){var r,l=arguments.length,n=l<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,o,i);else for(var s=t.length-1;0<=s;s--)(r=t[s])&&(n=(l<3?r(n):3<l?r(e,o,n):r(e,o))||n);return 3<l&&n&&Object.defineProperty(e,o,n),n};Object.defineProperty(exports,"__esModule",{value:!0}),exports.RolePreloadComponent=exports.characterCommonSkillSet=void 0;const UE=require("ue"),Log_1=require("../../../../../Core/Common/Log"),Stats_1=require("../../../../../Core/Common/Stats"),MonsterBattleConfById_1=require("../../../../../Core/Define/ConfigQuery/MonsterBattleConfById"),Protocol_1=require("../../../../../Core/Define/Net/Protocol"),EntityComponent_1=require("../../../../../Core/Entity/EntityComponent"),RegisterComponent_1=require("../../../../../Core/Entity/RegisterComponent"),ResourceSystem_1=require("../../../../../Core/Resource/ResourceSystem"),DataTableUtil_1=require("../../../../../Core/Utils/DataTableUtil"),ConfigManager_1=require("../../../../Manager/ConfigManager"),ModelManager_1=require("../../../../Manager/ModelManager"),PreloadDefine_1=require("../../../../Preload/PreloadDefine"),CombatLog_1=require("../../../../Utils/CombatLog"),PreloadControllerNew_1=require("../../../../World/Controller/PreloadControllerNew");exports.characterCommonSkillSet=new Set([100005,100006,100007]);let RolePreloadComponent=RolePreloadComponent_1=class RolePreloadComponent extends EntityComponent_1.EntityComponent{constructor(){super(...arguments),this.u1t=void 0,this.tRr=void 0,this.XJr=void 0,this.$Jr=!1,this.fGn=void 0,this.pGn=0,this.YJr=(t,e)=>{if(e&&!this.$Jr&&this.tRr){e=this.u1t.GetEntityType();if(e===Protocol_1.Aki.Protocol.kks.Proto_Monster){if(CombatLog_1.CombatLog.Warn("Skill",this.Entity,"开始加载技能和子弹"),this.$Jr=!0,RolePreloadComponent_1.Yrh.Start(),this.JJr(!0),RolePreloadComponent_1.Yrh.Stop(),RolePreloadComponent_1.zrh.Start(),this.vGn(),RolePreloadComponent_1.zrh.Stop(),RolePreloadComponent_1.Jrh.Start(),this.tRr.DtSkillInfo){e=new Array;DataTableUtil_1.DataTableUtil.GetDataTableAllRowNamesFromTable(this.tRr.DtSkillInfo,e);for(const i of e){var o=Number(i);this.tRr.LoadedSkills.has(o)||this.LoadSkillAsync(o)}}RolePreloadComponent_1.Jrh.Stop(),RolePreloadComponent_1.Zrh.Start(),this.MGn(),RolePreloadComponent_1.Zrh.Stop()}}}}OnInitData(){return PreloadDefine_1.PreloadSetting.UseNewPreload&&(this.tRr=this.Entity.GetComponent(34),this.u1t=this.Entity.GetComponent(0),this.Entity.GetComponent(191).ListenForTagAddOrRemove(1996802261,this.YJr)),!0}InitPreload(t){this.XJr=t,this.tRr&&(this.SGn(),this.EGn(),this.zJr(),this.ZJr())}SGn(){var t=this.XJr?.BlueprintClassPath;t&&(this.fGn=ConfigManager_1.ConfigManager.WorldConfig.GetCharacterFightInfo(t))}EGn(){if(this.u1t.IsAutoRole())this.pGn=2;else{if(this.u1t.IsMonster()){var t=this.u1t.GetMonsterComponent()?.FightConfigId;if(t){t=MonsterBattleConfById_1.configMonsterBattleConfById.GetConfig(t);if(t&&0<t.RoleMappingId)return void(this.pGn=2)}}ModelManager_1.ModelManager.RoguelikeModel.CheckInRoguelikeOnly()||ModelManager_1.ModelManager.BattleLinkModel.CheckInBattleLink()?this.pGn=1:this.pGn=0}}zJr(){var t,e,o;this.tRr&&(o=this.XJr,(t=this.fGn?.SkillDataTable.ToAssetPathName())?.length&&"None"!==t&&((e=ResourceSystem_1.ResourceSystem.GetLoadedAsset(t,UE.DataTable))?.IsValid()||CombatLog_1.CombatLog.Warn("Skill",this.Entity,"SkillComponent中找不到技能表",["ActorPath",o.BlueprintClassPath],["技能表Path",t]),this.tRr.DtSkillInfo=e),0!==this.pGn&&(t=this.fGn?.SkillDataTableMap.Get(this.pGn)?.ToAssetPathName())&&0<t.length&&"None"!==t&&((e=ResourceSystem_1.ResourceSystem.GetLoadedAsset(t,UE.DataTable))?.IsValid()||CombatLog_1.CombatLog.Warn("Skill",this.Entity,"SkillComponent中找不到玩法额外技能表",["加载类型",this.pGn],["ActorPath",o.BlueprintClassPath],["额外技能表Path",t]),this.tRr.DtSkillInfoExtra=e),(o=this.u1t.GetEntityType())===Protocol_1.Aki.Protocol.kks.Proto_Player?this.tzr():o===Protocol_1.Aki.Protocol.kks.Proto_Vision?this.izr():this.u1t?.SummonType!==Protocol_1.Aki.Protocol.Summon.x3s.Proto_ESummonTypeDefault?this.tzr():o===Protocol_1.Aki.Protocol.kks.Proto_Monster&&this.ozr())}tzr(){if(this.tRr){var t=new Array,e=(DataTableUtil_1.DataTableUtil.GetDataTableAllRowNamesFromTable(this.tRr.DtSkillInfo,t),new Set);for(const r of t){var o=Number(r);e.add(o),PreloadControllerNew_1.PreloadControllerNew.CollectAssetBySkillId(this.XJr,o,!1)}this.MGn();for(const l of ConfigManager_1.ConfigManager.WorldConfig.GetRoleCommonSkillRowNames()){var i=Number(l);exports.characterCommonSkillSet.has(i)&&!e.has(i)&&PreloadControllerNew_1.PreloadControllerNew.CollectAssetBySkillId(this.XJr,i,!1)}}}LoadSkillAsync(e){var t;this.XJr.FightAssetManager.SkillAssetManager.GetSkill(e)||(t=PreloadControllerNew_1.PreloadControllerNew.CollectAssetBySkillId(this.XJr,e,!1))&&PreloadControllerNew_1.PreloadControllerNew.LoadAssetAsync(t,this.XJr.LoadPriority,!1,void 0,t=>{t?Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Preload",4,"技能加载完毕",["SkillId",e]):Log_1.Log.CheckError()&&Log_1.Log.Error("Preload",4,"技能加载失败",["SkillId",e])})}FlushSkill(t){PreloadControllerNew_1.PreloadControllerNew.FlushSkill(this.XJr,t)}RemoveSkill(t){PreloadControllerNew_1.PreloadControllerNew.RemoveSkill(this.XJr,t)}ozr(){if(this.tRr&&this.tRr.DtSkillInfo){var t,e,o=new Array;DataTableUtil_1.DataTableUtil.GetDataTableAllRowWithKeysFromTable(this.tRr.DtSkillInfo,o);for(const i of o)void 0!==i[0]&&void 0!==i[1]&&(t=Number(i[0]),(e=i[1])&&8===e.SkillGenre)&&PreloadControllerNew_1.PreloadControllerNew.CollectAssetBySkillId(this.XJr,t,!1)}}izr(){if(this.tRr){var t=new Array;if(this.tRr.DtSkillInfo){DataTableUtil_1.DataTableUtil.GetDataTableAllRowNamesFromTable(this.tRr.DtSkillInfo,t);for(const e of t)PreloadControllerNew_1.PreloadControllerNew.CollectAssetBySkillId(this.XJr,Number(e),!1)}for(const o of ConfigManager_1.ConfigManager.WorldConfig.GetVisionCommonSkillRowNames())PreloadControllerNew_1.PreloadControllerNew.CollectAssetBySkillId(this.XJr,Number(o),!1);this.MGn()}}MGn(){if(this.tRr&&0!==this.pGn){var t=this.tRr.DtSkillInfoExtra;if(t){var e=new Array;DataTableUtil_1.DataTableUtil.GetDataTableAllRowNamesFromTable(t,e);for(const i of e){var o=Number(i);PreloadControllerNew_1.PreloadControllerNew.CollectAssetBySkillId(this.XJr,o,!1)}}}}ZJr(){var t=this.u1t.GetEntityType();t===Protocol_1.Aki.Protocol.kks.Proto_Player||t===Protocol_1.Aki.Protocol.kks.Proto_Vision?this.JJr(!1,!0):this.JJr(!1,!1),this.vGn()}JJr(t=!1,e=!0){var o;this.tRr&&(o=this.fGn?.BulletDataTable?.ToAssetPathName())?.length&&"None"!==o&&(o=ResourceSystem_1.ResourceSystem.GetLoadedAsset(o,UE.DataTable),this.IGn(o,t,e)&&(this.tRr.DtBulletInfo=o),0!==this.pGn)&&(o=this.fGn?.BulletDataTableMap.Get(this.pGn)?.ToAssetPathName())&&0<o.length&&"None"!==o&&(o=ResourceSystem_1.ResourceSystem.GetLoadedAsset(o,UE.DataTable),this.IGn(o,t,e))&&(this.tRr.DtBulletInfoExtra=o)}IGn(t,e=!1,o=!0){var i=this.XJr;if(!t?.IsValid())return Log_1.Log.CheckError()&&Log_1.Log.Error("Character",4,"[预加载] 加载角色子弹表失败。",["Path",i.BlueprintClassPath],["子弹表Path",this.fGn?.BulletDataTable?.ToAssetPathName()]),!1;if(!t)return!1;if(o){var r=new Array,l=(DataTableUtil_1.DataTableUtil.GetDataTableAllRowWithKeysFromTable(t,r),r.length);for(let t=0;t<l;++t){var n=r[t];if(void 0!==n[0]&&void 0!==n[1]){let t=void 0;try{t=BigInt(n[0])}catch(t){Log_1.Log.CheckError()&&Log_1.Log.Error("Editor",4,"子弹ID不合法",["子弹Id",n[0]]);continue}n=PreloadControllerNew_1.PreloadControllerNew.CollectAssetByBulletId(i,t);e&&n&&PreloadControllerNew_1.PreloadControllerNew.LoadAssetAsync(n,this.XJr.LoadPriority,!1)}}}return!0}vGn(){if(this.tRr){const e=this.fGn?.HitEffectTable.ToAssetPathName();var t;if(e&&0<e.length&&"None"!==e&&(t=ResourceSystem_1.ResourceSystem.GetLoadedAsset(e,UE.DataTable),this.tRr.DtHitEffect=t),0!==this.pGn){const e=this.fGn?.HitEffectTableMap.Get(this.pGn)?.ToAssetPathName();e&&0<e.length&&"None"!==e&&(t=ResourceSystem_1.ResourceSystem.GetLoadedAsset(e,UE.DataTable),this.tRr.DtHitEffectExtra=t)}}}};RolePreloadComponent.Yrh=Stats_1.Stat.Create("Preload.MonsterBeginFight.InitAllBullet"),RolePreloadComponent.zrh=Stats_1.Stat.Create("Preload.MonsterBeginFight.InitHitEffect"),RolePreloadComponent.Jrh=Stats_1.Stat.Create("Preload.MonsterBeginFight.InitAllSkill"),RolePreloadComponent.Zrh=Stats_1.Stat.Create("Preload.MonsterBeginFight.InitAllExSkill"),RolePreloadComponent=RolePreloadComponent_1=__decorate([(0,RegisterComponent_1.RegisterComponent)(203)],RolePreloadComponent),exports.RolePreloadComponent=RolePreloadComponent;
//# sourceMappingURL=RolePreloadComponent.js.map