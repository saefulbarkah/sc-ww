
"use strict";var RolePreloadComponent_1,__decorate=this&&this.__decorate||function(e,o,t,r){var i,l=arguments.length,a=l<3?o:null===r?r=Object.getOwnPropertyDescriptor(o,t):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,o,t,r);else for(var n=e.length-1;0<=n;n--)(i=e[n])&&(a=(l<3?i(a):3<l?i(o,t,a):i(o,t))||a);return 3<l&&a&&Object.defineProperty(o,t,a),a};Object.defineProperty(exports,"__esModule",{value:!0}),exports.RolePreloadComponent=void 0;const UE=require("ue"),Log_1=require("../../../../../Core/Common/Log"),Stats_1=require("../../../../../Core/Common/Stats"),MonsterBattleConfById_1=require("../../../../../Core/Define/ConfigQuery/MonsterBattleConfById"),Protocol_1=require("../../../../../Core/Define/Net/Protocol"),EntityComponent_1=require("../../../../../Core/Entity/EntityComponent"),RegisterComponent_1=require("../../../../../Core/Entity/RegisterComponent"),ResourceSystem_1=require("../../../../../Core/Resource/ResourceSystem"),DataTableUtil_1=require("../../../../../Core/Utils/DataTableUtil"),ConfigManager_1=require("../../../../Manager/ConfigManager"),ModelManager_1=require("../../../../Manager/ModelManager"),PreloadDefine_1=require("../../../../Preload/PreloadDefine"),CombatLog_1=require("../../../../Utils/CombatLog"),PreloadControllerNew_1=require("../../../../World/Controller/PreloadControllerNew"),characterCommonSkillSet=new Set([100005,100006,100007]);let RolePreloadComponent=RolePreloadComponent_1=class RolePreloadComponent extends EntityComponent_1.EntityComponent{constructor(){super(...arguments),this.u1t=void 0,this.tRr=void 0,this.XJr=void 0,this.$Jr=!1,this.fGn=void 0,this.C8_=[],this.PreloadSkillIds=new Set,this.YJr=(e,o)=>{if(o&&!this.$Jr&&this.tRr){o=this.u1t.GetEntityType();if(o===Protocol_1.Aki.Protocol.kks.Proto_Monster){if(CombatLog_1.CombatLog.Warn("Skill",this.Entity,"开始加载技能和子弹"),this.$Jr=!0,RolePreloadComponent_1.inh.Start(),this.JJr(!0),RolePreloadComponent_1.inh.Stop(),RolePreloadComponent_1.rnh.Start(),this.vGn(),RolePreloadComponent_1.rnh.Stop(),RolePreloadComponent_1.onh.Start(),this.tRr.DtSkillInfo){o=new Array;DataTableUtil_1.DataTableUtil.GetDataTableAllRowNamesFromTable(this.tRr.DtSkillInfo,o);for(const r of o){var t=Number(r);this.tRr.LoadedSkills.has(t)||this.LoadSkillAsync(t)}}RolePreloadComponent_1.onh.Stop(),RolePreloadComponent_1.nnh.Start(),this.MGn(),RolePreloadComponent_1.nnh.Stop()}}}}OnInitData(){return PreloadDefine_1.PreloadSetting.UseNewPreload&&(this.tRr=this.Entity.GetComponent(38),this.u1t=this.Entity.GetComponent(0),this.Entity.GetComponent(203).ListenForTagAddOrRemove(1996802261,this.YJr)),!0}InitPreload(e){this.XJr=e,this.tRr&&(this.SGn(),this.EGn(),this.zJr(),this.ZJr())}SGn(){var e=this.XJr?.BlueprintClassPath;e&&(this.fGn=ConfigManager_1.ConfigManager.WorldConfig.GetCharacterFightInfo(e))}EGn(){this.C8_.length=0;var e=ConfigManager_1.ConfigManager.InstanceDungeonConfig.GetConfig(ModelManager_1.ModelManager.CreatureModel.GetInstanceId());if(e&&0<e.FightInfoDtType.length)for(const o of e.FightInfoDtType)this.C8_.push(o);else if(this.u1t.IsAutoRole())this.C8_.push(2);else{if(this.u1t.IsMonster()){e=this.u1t.GetMonsterComponent()?.FightConfigId;if(e){e=MonsterBattleConfById_1.configMonsterBattleConfById.GetConfig(e);if(e&&0<e.RoleMappingId)return void this.C8_.push(2)}}(ModelManager_1.ModelManager.RoguelikeModel.CheckInRoguelikeOnly()||ModelManager_1.ModelManager.BattleLinkModel.CheckInBattleLink())&&this.C8_.push(1)}}zJr(){if(this.tRr){var e,o=this.XJr,t=this.fGn?.SkillDataTable.ToAssetPathName();t?.length&&"None"!==t&&((e=ResourceSystem_1.ResourceSystem.GetLoadedAsset(t,UE.DataTable))?.IsValid()||CombatLog_1.CombatLog.Warn("Skill",this.Entity,"SkillComponent中找不到技能表",["ActorPath",o.BlueprintClassPath],["技能表Path",t]),this.tRr.DtSkillInfo=e);for(const l of this.C8_){var r,i=this.fGn?.SkillDataTableMap.Get(l)?.ToAssetPathName();i&&0<i.length&&"None"!==i&&((r=ResourceSystem_1.ResourceSystem.GetLoadedAsset(i,UE.DataTable))?.IsValid()||CombatLog_1.CombatLog.Warn("Skill",this.Entity,"SkillComponent中找不到玩法额外技能表",["加载类型",l],["ActorPath",o.BlueprintClassPath],["额外技能表Path",i]),r)&&(this.tRr.DtSkillInfoExtraList||(this.tRr.DtSkillInfoExtraList=[]),this.tRr.DtSkillInfoExtraList.push(r))}t=this.u1t.GetEntityType();t===Protocol_1.Aki.Protocol.kks.Proto_Player?this.tzr():t===Protocol_1.Aki.Protocol.kks.Proto_Vision?this.izr():this.u1t?.SummonType!==Protocol_1.Aki.Protocol.Summon.x3s.Proto_ESummonTypeDefault?this.tzr():t===Protocol_1.Aki.Protocol.kks.Proto_Monster?this.ozr():t===Protocol_1.Aki.Protocol.kks.HI_&&this.qHl()}}tzr(){if(this.tRr){var e=new Array;DataTableUtil_1.DataTableUtil.GetDataTableAllRowNamesFromTable(this.tRr.DtSkillInfo,e);for(const t of e)this.bk_(Number(t));this.MGn();for(const r of ConfigManager_1.ConfigManager.WorldConfig.GetRoleCommonSkillRowNames()){var o=Number(r);characterCommonSkillSet.has(o)&&!this.PreloadSkillIds.has(o)&&this.bk_(o)}}}LoadSkillAsync(o){var e;this.XJr.FightAssetManager.SkillAssetManager.GetSkill(o)||(e=this.bk_(o))&&PreloadControllerNew_1.PreloadControllerNew.LoadAssetAsync(e,this.XJr.LoadPriority,!1,void 0,e=>{e?Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Preload",4,"技能加载完毕",["SkillId",o]):Log_1.Log.CheckError()&&Log_1.Log.Error("Preload",4,"技能加载失败",["SkillId",o])})}FlushSkill(e){PreloadControllerNew_1.PreloadControllerNew.FlushSkill(this.XJr,e)}RemoveSkill(e){PreloadControllerNew_1.PreloadControllerNew.RemoveSkill(this.XJr,e)}ozr(){if(this.tRr&&this.tRr.DtSkillInfo){var e=new Array;DataTableUtil_1.DataTableUtil.GetDataTableAllRowWithKeysFromTable(this.tRr.DtSkillInfo,e);for(const r of e)if(void 0!==r[0]&&void 0!==r[1]){var o=Number(r[0]),t=r[1];t&&8===t.SkillGenre&&this.bk_(o);for(let e=0;e<t.SkillTag.Num();e++)2057104696===t.SkillTag.Get(e).TagId&&(this.bk_(o),Log_1.Log.CheckDebug())&&Log_1.Log.Debug("Preload",4,"预加载怪物出场技能",["SkillId",o])}}}qHl(){if(this.tRr){var e=new Array;DataTableUtil_1.DataTableUtil.GetDataTableAllRowNamesFromTable(this.tRr.DtSkillInfo,e);for(const o of e)this.bk_(Number(o));this.MGn()}}izr(){if(this.tRr){var e=new Array;if(this.tRr.DtSkillInfo){DataTableUtil_1.DataTableUtil.GetDataTableAllRowNamesFromTable(this.tRr.DtSkillInfo,e);for(const o of e)this.bk_(Number(o))}for(const t of ConfigManager_1.ConfigManager.WorldConfig.GetVisionCommonSkillRowNames())this.bk_(Number(t));this.MGn()}}MGn(){if(this.tRr){var e=this.tRr.DtSkillInfoExtraList;if(e&&!(e.length<=0))for(const r of e){var o=new Array;DataTableUtil_1.DataTableUtil.GetDataTableAllRowNamesFromTable(r,o);for(const i of o){var t=Number(i);this.bk_(t)}}}}ZJr(){var e=this.u1t.GetEntityType();e===Protocol_1.Aki.Protocol.kks.Proto_Player||e===Protocol_1.Aki.Protocol.kks.Proto_Vision||e===Protocol_1.Aki.Protocol.kks.HI_?this.JJr(!1,!0):this.JJr(!1,!1),this.vGn()}JJr(e=!1,o=!0){if(this.tRr){var t=this.fGn?.BulletDataTable?.ToAssetPathName();if(t?.length&&"None"!==t){RolePreloadComponent_1.R6l.Start();t=ResourceSystem_1.ResourceSystem.GetLoadedAsset(t,UE.DataTable);this.IGn(t,e,o)&&(this.tRr.DtBulletInfo=t),RolePreloadComponent_1.R6l.Stop(),RolePreloadComponent_1.w6l.Start();for(const i of this.C8_){var r=this.fGn?.BulletDataTableMap.Get(i)?.ToAssetPathName();r&&0<r.length&&"None"!==r&&(r=ResourceSystem_1.ResourceSystem.GetLoadedAsset(r,UE.DataTable),this.IGn(r,e,o))&&(this.tRr.DtBulletInfoExtraList||(this.tRr.DtBulletInfoExtraList=[]),this.tRr.DtBulletInfoExtraList.push(r))}RolePreloadComponent_1.w6l.Stop()}}}IGn(e,o=!1,t=!0){var r=this.XJr;if(!e?.IsValid())return Log_1.Log.CheckError()&&Log_1.Log.Error("Character",4,"[预加载] 加载角色子弹表失败。",["Path",r.BlueprintClassPath],["子弹表Path",this.fGn?.BulletDataTable?.ToAssetPathName()]),!1;if(!e)return!1;if(t){RolePreloadComponent_1.P6l.Start();var i=new Array,l=(DataTableUtil_1.DataTableUtil.GetDataTableAllRowWithKeysFromTable(e,i),RolePreloadComponent_1.P6l.Stop(),i.length);for(let e=0;e<l;++e){var a=i[e];if(void 0!==a[0]&&void 0!==a[1]){let e=void 0;try{e=BigInt(a[0])}catch(e){Log_1.Log.CheckError()&&Log_1.Log.Error("Editor",4,"子弹ID不合法",["子弹Id",a[0]]);continue}RolePreloadComponent_1.U6l.Start();a=PreloadControllerNew_1.PreloadControllerNew.CollectAssetByBulletId(r,e);RolePreloadComponent_1.U6l.Stop(),o&&a&&(RolePreloadComponent_1.D6l.Start(),PreloadControllerNew_1.PreloadControllerNew.LoadAssetAsync(a,this.XJr.LoadPriority,!1),RolePreloadComponent_1.D6l.Stop())}}}return!0}vGn(){if(this.tRr){const t=this.fGn?.HitEffectTable.ToAssetPathName();var e,o;t&&0<t.length&&"None"!==t&&(e=ResourceSystem_1.ResourceSystem.GetLoadedAsset(t,UE.DataTable),this.tRr.DtHitEffect=e);for(const r of this.C8_){const t=this.fGn?.HitEffectTableMap.Get(r)?.ToAssetPathName();t&&0<t.length&&"None"!==t&&(o=ResourceSystem_1.ResourceSystem.GetLoadedAsset(t,UE.DataTable),this.tRr.DtHitEffectExtraList||(this.tRr.DtHitEffectExtraList=[]),this.tRr.DtHitEffectExtraList.push(o))}}}bk_(e){return this.PreloadSkillIds.add(e),PreloadControllerNew_1.PreloadControllerNew.CollectAssetBySkillId(this.XJr,e,!1)}};RolePreloadComponent.inh=Stats_1.Stat.Create("Preload.MonsterBeginFight.InitAllBullet"),RolePreloadComponent.R6l=Stats_1.Stat.Create("Preload.PreloadBullet1"),RolePreloadComponent.w6l=Stats_1.Stat.Create("Preload.PreloadBullet2"),RolePreloadComponent.P6l=Stats_1.Stat.Create("Preload.PreloadBulletGetDataTableAllRow"),RolePreloadComponent.U6l=Stats_1.Stat.Create("Preload.PreloadBulletCollectAssetByBulletId"),RolePreloadComponent.D6l=Stats_1.Stat.Create("Preload.PreloadBulletLoadAssetAsync"),RolePreloadComponent.rnh=Stats_1.Stat.Create("Preload.MonsterBeginFight.InitHitEffect"),RolePreloadComponent.onh=Stats_1.Stat.Create("Preload.MonsterBeginFight.InitAllSkill"),RolePreloadComponent.nnh=Stats_1.Stat.Create("Preload.MonsterBeginFight.InitAllExSkill"),RolePreloadComponent=RolePreloadComponent_1=__decorate([(0,RegisterComponent_1.RegisterComponent)(216)],RolePreloadComponent),exports.RolePreloadComponent=RolePreloadComponent;
//# sourceMappingURL=RolePreloadComponent.js.map