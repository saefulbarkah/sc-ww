
"use strict";var BaseAttributeComponent_1,__decorate=this&&this.__decorate||function(t,e,r,s){var i,a=arguments.length,o=a<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,r,s);else for(var h=t.length-1;0<=h;h--)(i=t[h])&&(o=(a<3?i(o):3<a?i(e,r,o):i(e,r))||o);return 3<a&&o&&Object.defineProperty(e,r,o),o};Object.defineProperty(exports,"__esModule",{value:!0}),exports.BaseAttributeComponent=exports.AttributeSnapshot=void 0;const Log_1=require("../../../../../../Core/Common/Log"),Stats_1=require("../../../../../../Core/Common/Stats"),CommonDefine_1=require("../../../../../../Core/Define/CommonDefine"),EntityComponent_1=require("../../../../../../Core/Entity/EntityComponent"),RegisterComponent_1=require("../../../../../../Core/Entity/RegisterComponent"),StatDefine_1=require("../../../../../Common/StatDefine"),ModelManager_1=require("../../../../../Manager/ModelManager"),CombatLog_1=require("../../../../../Utils/CombatLog"),AbilityUtils_1=require("./AbilityUtils"),CharacterAttributeTypes_1=require("./CharacterAttributeTypes");class AttributeSnapshot{constructor(){this.BaseValues={},this.CurrentValues={}}GetBaseValue(t){return this.BaseValues[CharacterAttributeTypes_1.EAttributeId[t]]}GetCurrentValue(t){return this.CurrentValues[CharacterAttributeTypes_1.EAttributeId[t]]}}exports.AttributeSnapshot=AttributeSnapshot;let BaseAttributeComponent=BaseAttributeComponent_1=class BaseAttributeComponent extends EntityComponent_1.EntityComponent{constructor(){super(...arguments),this.BaseValues=new Array(CharacterAttributeTypes_1.ATTRIBUTE_ID_MAX),this.CurrentValues=new Array(CharacterAttributeTypes_1.ATTRIBUTE_ID_MAX),this.ModifierLists=new Array(CharacterAttributeTypes_1.ATTRIBUTE_ID_MAX),this.BoundsLockerMap=new Map,this.CreatureDataComponent=void 0,this.BuffComponent=void 0,this.CurrentValueListenerMap=new Map,this.AnyCurrentValueListenerSet=new Set}OnInit(){return super.OnInit(),this.CreatureDataComponent=this.Entity.CheckGetComponent(0),this.BuffComponent=this.Entity.GetComponent(195),!0}OnCreate(){for(let t=0;t<CharacterAttributeTypes_1.ATTRIBUTE_ID_MAX;++t)this.BaseValues[t]=0;for(let t=0;t<CharacterAttributeTypes_1.ATTRIBUTE_ID_MAX;++t)this.CurrentValues[t]=0;for(let t=0;t<CharacterAttributeTypes_1.ATTRIBUTE_ID_MAX;++t)this.ModifierLists[t]=new Map;return!0}OnTick(t){this.AutoRecoverAttr(t)}IsWritableAttribute(t){if(CharacterAttributeTypes_1.attrsAutoRecoverSpeedMap.has(t)||CharacterAttributeTypes_1.attrsAutoRecoverMaxMap.has(t))return!0;switch(t){case CharacterAttributeTypes_1.EAttributeId.Proto_Tough:case CharacterAttributeTypes_1.EAttributeId.Proto_Jump:return!0;case CharacterAttributeTypes_1.EAttributeId.Proto_SpecialEnergy1:case CharacterAttributeTypes_1.EAttributeId.Proto_SpecialEnergy2:case CharacterAttributeTypes_1.EAttributeId.Proto_SpecialEnergy3:case CharacterAttributeTypes_1.EAttributeId.Proto_SpecialEnergy4:return!this.BuffComponent||this.BuffComponent.HasBuffAuthority();default:return!1}return!1}IsLocalAttribute(t){switch(t){case CharacterAttributeTypes_1.EAttributeId.Proto_Jump:return!0;case CharacterAttributeTypes_1.EAttributeId.Proto_SpecialEnergy1:case CharacterAttributeTypes_1.EAttributeId.Proto_SpecialEnergy2:case CharacterAttributeTypes_1.EAttributeId.Proto_SpecialEnergy3:case CharacterAttributeTypes_1.EAttributeId.Proto_SpecialEnergy4:return!this.BuffComponent||this.BuffComponent.HasBuffAuthority();default:return!1}return!1}SetBaseValue(e,r){if(this.IsWritableAttribute(e)){let t=r;var s,r=this.mbr(e),r=(void 0!==r&&(t=this.dbr(e,t,r)),CharacterAttributeTypes_1.attrsNotClampZero.includes(e)||(t=Math.max(t,0)),t=Math.floor(t),this.BaseValues[e]);r!==t&&(this.BaseValues[e]=t,r=this.CurrentValues[e],this.UpdateCurrentValue(e),s=this.CurrentValues[e],this.DispatchCurrentValueEvent(e,s,r))}}AddBaseValue(t,e){this.SetBaseValue(t,this.BaseValues[t]+e)}GetBaseValue(t){return this.BaseValues[t]}GetCurrentValue(t){return this.CurrentValues[t]}mbr(t){t=CharacterAttributeTypes_1.attributeIdsWithMax.get(t);if(t)return this.GetCurrentValue(t)}SyncValueFromServer(t,e,r){this.IsLocalAttribute(t)||(this.BaseValues[t]!==e&&(this.BaseValues[t]=e),e=this.CurrentValues[t],this.CurrentValues[t]=r,this.DispatchCurrentValueEvent(t,r,e))}UpdateCurrentValue(e){if(this.IsWritableAttribute(e)){let t=this.Cbr(e);var r=CharacterAttributeTypes_1.attrsCurrentValueClamp.get(e),r=(r&&(t=Math.min(t,r)),CharacterAttributeTypes_1.attrsNotClampZero.includes(e)||(t=Math.max(t,0)),this.CurrentValues[e]);r!==t&&(this.CurrentValues[e]=t)}}TakeSnapshot(){var e=new AttributeSnapshot;for(let t=1;t<CharacterAttributeTypes_1.ATTRIBUTE_ID_MAX;t++){var r=CharacterAttributeTypes_1.EAttributeId[t];r&&(e.BaseValues[r]=this.BaseValues[t]??0,e.CurrentValues[r]=this.CurrentValues[t]??0)}return e}AddModifier(t,e){var r,s;return!this.IsWritableAttribute(t)||t<=CharacterAttributeTypes_1.EAttributeId.Proto_EAttributeType_None||t>=CharacterAttributeTypes_1.ATTRIBUTE_ID_MAX?-1:(r=BaseAttributeComponent_1.ModifierHandleGenerator++,this.ModifierLists[t]=this.ModifierLists[t]??new Map,this.ModifierLists[t].set(r,e),e=this.CurrentValues[t],this.UpdateCurrentValue(t),s=this.CurrentValues[t],this.DispatchCurrentValueEvent(t,s,e),r)}RemoveModifier(t,e){var r;this.ModifierLists[t]?.delete(e)&&(e=this.CurrentValues[t],this.UpdateCurrentValue(t),r=this.CurrentValues[t],this.DispatchCurrentValueEvent(t,r,e))}*GetAllModifiers(t){if(this.ModifierLists[t])for(const e of this.ModifierLists[t].values())yield e}Cbr(t){var e=this.BaseValues[t];if(!this.ModifierLists[t])return e;let r=0,s=0,i=1;var a=this.CheckIfNeedAdvanceMultiply(t);for(const h of this.GetAllModifiers(t)){let e=0;switch(h.Type){case 0:e=h.Value1;break;case 1:s+=h.Value1;break;case 2:case 4:{let t=h.SnapshotSource;void 0===t&&(t=AbilityUtils_1.AbilityUtils.GetAttrValue(0===h.SourceEntity?this:ModelManager_1.ModelManager.CreatureModel.GetEntity(h.SourceEntity)?.Entity?.GetComponent(159),h.SourceAttributeId,h.SourceCalculationType));var o=h.Min;if(o&&(t-=o)<=0)break;o=h.Ratio,o=(o&&(t/=o),e=t*h.Value1*CharacterAttributeTypes_1.DIVIDED_TEN_THOUSAND+h.Value2,h.Max);if(o&&e>o&&(e=o),4===h.Type)return e;break}case 3:return h.Value1;case 9:i*=h.Value1*CharacterAttributeTypes_1.DIVIDED_TEN_THOUSAND}0!==e&&(a?i*=e*CharacterAttributeTypes_1.DIVIDED_TEN_THOUSAND+1:r+=e)}return Math.floor((e*(s*CharacterAttributeTypes_1.DIVIDED_TEN_THOUSAND+1)+r)*i)}SyncRecoverPropFromServer(t,e,r,s,i){var a=CharacterAttributeTypes_1.attrsAutoRecoverSpeedMap.get(t),o=CharacterAttributeTypes_1.attrsAutoRecoverMaxMap.get(t);a&&o?(this.SyncValueFromServer(a,s,s),this.SyncValueFromServer(o,r,r),a=e+s*i*CommonDefine_1.SECOND_PER_MILLIONSECOND,this.SyncValueFromServer(t,a,a)):Log_1.Log.CheckError()&&Log_1.Log.Error("Battle",35,"自动属性未注册",["属性",t])}AutoRecoverAttr(t){for(var[e,r]of CharacterAttributeTypes_1.attrsAutoRecoverSpeedMap.entries()){r=this.GetCurrentValue(r);0!==r&&this.AddBaseValue(e,r*t*CommonDefine_1.SECOND_PER_MILLIONSECOND)}}AddBoundsLocker(t,e,r){if(!this.IsWritableAttribute(t))return-1;let s=this.BoundsLockerMap.get(t);return s||this.BoundsLockerMap.set(t,s=new Map),s.has(r)?Log_1.Log.CheckError()&&Log_1.Log.Error("Battle",22,"重复添加属性BoundsLock",["attrId",t],["handle",r]):(s.set(r,e),this.SetBaseValue(t,this.BaseValues[t])),r}RemoveBoundsLocker(t,e){var r=this.BoundsLockerMap.get(t);return!!r&&!!r.delete(e)&&(this.SetBaseValue(t,this.BaseValues[t]),!0)}*GetAllBoundsLocker(t){t=this.BoundsLockerMap.get(t);if(t)for(const e of t.values())yield e}dbr(t,e,r){let s=e,i=void 0,a=r;for(const h of this.GetAllBoundsLocker(t)){var o;h.LockLowerBounds&&(o=h.LowerPercent*r+h.LowerOffset,i=Math.max(i??o,o)),h.LockUpperBounds&&(o=h.UpperPercent*r+h.UpperOffset,a=Math.min(a??o,o))}return void 0!==a&&(s=Math.min(a,s)),s=void 0!==i?Math.max(i,s):s}AddIntervalLock(t,e,r,s,i){var a;r!==CharacterAttributeTypes_1.EAttributeId.Proto_Life&&(s={LockUpperBounds:!(a={LockUpperBounds:!0,LockLowerBounds:!1,UpperPercent:s*CharacterAttributeTypes_1.DIVIDED_TEN_THOUSAND,UpperOffset:i,LowerPercent:0,LowerOffset:0}),LockLowerBounds:!0,UpperPercent:1,UpperOffset:0,LowerPercent:s*CharacterAttributeTypes_1.DIVIDED_TEN_THOUSAND,LowerOffset:i},this.AddBoundsLocker(r,0===t?a:s,e))}RemoveIntervalLock(t,e,r){this.RemoveBoundsLocker(r,e)}AddStateAttributeLock(t,e,r,s){r={LockUpperBounds:!0,LockLowerBounds:!0,UpperPercent:r*CharacterAttributeTypes_1.DIVIDED_TEN_THOUSAND,UpperOffset:s,LowerPercent:r*CharacterAttributeTypes_1.DIVIDED_TEN_THOUSAND,LowerOffset:s};this.AddBoundsLocker(e,r,t)}RemoveStateAttributeLock(t,e){this.RemoveBoundsLocker(e,t)}AddListener(t,e,r){var s=this.CurrentValueListenerMap.get(t);s?s.add(e):((s=new Set).add(e),this.CurrentValueListenerMap.set(t,s))}AddListeners(t,e,r){t.forEach(t=>{this.AddListener(t,e,r)})}RemoveListener(t,e){t=this.CurrentValueListenerMap.get(t);return!!t&&(t.delete(e),!0)}RemoveListeners(t,e){t.forEach(t=>{this.RemoveListener(t,e)})}AddGeneralListener(t){this.AnyCurrentValueListenerSet.add(t)}RemoveGeneralListener(t){this.AnyCurrentValueListenerSet.delete(t)}DispatchCurrentValueEvent(e,r,s){if(s!==r){var i=this.CurrentValueListenerMap.get(e);if(i){let t=BaseAttributeComponent_1.pbr.get(e);t||BaseAttributeComponent_1.pbr.set(e,t=Stats_1.Stat.CreateNoFlameGraph(`CurrentAttr#${e} event`,StatDefine_1.BATTLESTAT_GROUP));for(const a of i){t?.Start();try{a(e,r,s)}catch(t){CombatLog_1.CombatLog.ErrorWithStack("Attribute",this.Entity,"属性回调异常",t,["属性",e])}t?.Stop()}}for(const t of this.AnyCurrentValueListenerSet){BaseAttributeComponent_1.vbr.Start();try{t(e,r,s)}catch(t){CombatLog_1.CombatLog.ErrorWithStack("Attribute",this.Entity,"全局属性回调异常",t,["属性",e])}BaseAttributeComponent_1.vbr.Stop()}}}CheckIfNeedAdvanceMultiply(t){switch(t){case CharacterAttributeTypes_1.EAttributeId.Proto_CdReduse:case CharacterAttributeTypes_1.EAttributeId.Proto_ToughChange:case CharacterAttributeTypes_1.EAttributeId.Proto_SkillToughRatio:case CharacterAttributeTypes_1.EAttributeId.vVn:case CharacterAttributeTypes_1.EAttributeId.Proto_AutoAttackSpeed:case CharacterAttributeTypes_1.EAttributeId.Proto_CastAttackSpeed:return!0;default:return!1}}GetDebugString(){var e=[];for(let t=1;t<CharacterAttributeTypes_1.ATTRIBUTE_ID_MAX;++t){var r=t;0===this.BaseValues[r]&&0===this.CurrentValues[r]||e.push(`${r} ${this.BaseValues[r]} `+this.CurrentValues[r])}return e.join("|")}GetLockDebugString(){let s="";return this.BoundsLockerMap.forEach((t,r)=>{t.forEach((t,e)=>{t.LockLowerBounds&&(s+=`属性:${r} 下限:${100*t.LowerPercent}%+${t.LowerOffset} handle:${e}
`),t.LockUpperBounds&&(s+=`属性:${r} 上限:${100*t.UpperPercent}%+${t.UpperOffset} handle:${e}
`)})}),s}};BaseAttributeComponent.ModifierHandleGenerator=100,BaseAttributeComponent.pbr=new Map,BaseAttributeComponent.vbr=Stats_1.Stat.Create("AnyCurrentAttr event",StatDefine_1.BATTLESTAT_GROUP),BaseAttributeComponent=BaseAttributeComponent_1=__decorate([(0,RegisterComponent_1.RegisterComponent)(158)],BaseAttributeComponent),exports.BaseAttributeComponent=BaseAttributeComponent;
//# sourceMappingURL=BaseAttributeComponent.js.map