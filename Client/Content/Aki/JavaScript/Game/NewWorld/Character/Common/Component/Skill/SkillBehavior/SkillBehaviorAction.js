
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SkillBehaviorAction=void 0;const puerts_1=require("puerts"),UE=require("ue"),Protocol_1=require("../../../../../../../Core/Define/Net/Protocol"),EntitySystem_1=require("../../../../../../../Core/Entity/EntitySystem"),Vector_1=require("../../../../../../../Core/Utils/Math/Vector"),MathUtils_1=require("../../../../../../../Core/Utils/MathUtils"),CameraUtility_1=require("../../../../../../Camera/CameraUtility"),TsBaseCharacter_1=require("../../../../../../Character/TsBaseCharacter"),Global_1=require("../../../../../../Global"),GlobalData_1=require("../../../../../../GlobalData"),ControllerHolder_1=require("../../../../../../Manager/ControllerHolder"),ModelManager_1=require("../../../../../../Manager/ModelManager"),PhantomUtil_1=require("../../../../../../Module/Phantom/PhantomUtil"),CombatLog_1=require("../../../../../../Utils/CombatLog"),WorldGlobal_1=require("../../../../../../World/WorldGlobal"),BulletUtil_1=require("../../../../../Bullet/BulletUtil"),SceneItemReferenceComponent_1=require("../../../../../SceneItem/SceneItemReferenceComponent"),SkillBehaviorMisc_1=require("./SkillBehaviorMisc");class SkillBehaviorAction{static BeginGroup(a,i){if(i.Entity.GetComponent(3).IsAutonomousProxy)for(let e=0;e<a.Num();e++)this.Begin(a.Get(e),i)}static Begin(e,a){try{switch(e.ActionType){case 0:this.tZo(e,a);break;case 1:this.bd(e,a);break;case 2:this.iZo(e,a);break;case 3:this.oZo(e,a);break;case 4:this.rZo(e,a);break;case 5:this.nZo(e,a);break;case 6:this.sZo(e,a);break;case 7:this.aZo(e,a);break;case 8:this.hZo(e,a);break;case 9:this.bst(e,a);break;case 10:this.lZo(e,a);break;case 11:this._Zo(e,a);break;case 12:this.Kpl(e,a)}}catch(e){e instanceof Error?CombatLog_1.CombatLog.ErrorWithStack("Skill",a.Entity,"SkillBehaviorAction.Begin异常",e,["技能Id",a.Skill.SkillId],["技能名",a.Skill.SkillName]):CombatLog_1.CombatLog.Error("Skill",a.Entity,"SkillBehaviorAction.Begin异常",["技能Id",a.Skill.SkillId],["技能名",a.Skill.SkillName])}}static End(i){SkillBehaviorMisc_1.paramMap.get(i)?.forEach(a=>{try{switch(a.ActionType){case 2:a.Entity.GetComponent(21).RemoveCueByHandle(a.GameplayCue);break;case 6:a.Entity.GetComponent(3).Actor.KuroSetMovementMode({Mode:a.MovementMode,Context:"[SkillBehaviorAction.End]"});break;case 7:a.Entity.GetComponent(3).Actor.CapsuleComponent.SetCollisionResponseToChannel(a.CollisionChannel,a.CollisionResponse);break;case 8:a.SummonSkillComponent.EndSkill(a.SummonSkillId,"SkillBehaviorAction.End")}}catch(e){e instanceof Error?CombatLog_1.CombatLog.ErrorWithStack("Skill",a.Entity,"SkillBehaviorAction.End异常",e,["技能Id",i.SkillId],["技能名",i.SkillName],["技能行为",a.ActionType]):CombatLog_1.CombatLog.Error("Skill",a.Entity,"SkillBehaviorAction.End异常",["技能Id",i.SkillId],["技能名",i.SkillName],["技能行为",a.ActionType])}}),SkillBehaviorMisc_1.paramMap.delete(i)}static tZo(i,a){var r=a.Entity.GetComponent(3);let t=r.ActorLocation,e=r.ActorForward;switch(i.LocationType){case 0:break;case 1:if(a.SkillComponent.SkillTarget){[t,e]=(0,SkillBehaviorMisc_1.getLocationAndDirection)(a.SkillComponent.SkillTarget.Entity.GetComponent(1).Owner);var o=a.SkillComponent.GetTargetTransform().GetLocation(),l=(0,SkillBehaviorMisc_1.traceWall)(r,Vector_1.Vector.Create(t),Vector_1.Vector.Create(o),i.DebugTrace);if(l&&l[0])break;t=o}break;case 2:l=ModelManager_1.ModelManager.SceneTeamModel.GetCurrentEntity.Entity.GetComponent(32).GetCurrentTarget();l&&([t,e]=(0,SkillBehaviorMisc_1.getLocationAndDirection)(l.Entity.GetComponent(1).Owner));break;case 3:[t,e]=(0,SkillBehaviorMisc_1.getLocationAndDirection)(Global_1.Global.BaseCharacter);break;case 4:o=ModelManager_1.ModelManager.CreatureModel.GetEntity(a.Entity.GetComponent(0).GetSummonerId())?.Entity?.GetComponent(1);[t,e]=(0,SkillBehaviorMisc_1.getLocationAndDirection)(o.Owner);break;case 5:[t,e]=(0,SkillBehaviorMisc_1.getLocationAndDirection)(ModelManager_1.ModelManager.CameraModel.FightCamera.GetComponent(4).CameraActor);break;case 6:l=ControllerHolder_1.ControllerHolder.BlackboardController.GetVectorValueByEntity(a.Entity.Id,i.BlackboardKey);t=WorldGlobal_1.WorldGlobal.ToUeVector(l);break;case 7:o=ControllerHolder_1.ControllerHolder.BlackboardController.GetIntValueByEntity(a.Entity.Id,i.BlackboardKey),l=EntitySystem_1.EntitySystem.Get(o);l?.Valid&&([t,e]=(0,SkillBehaviorMisc_1.getLocationAndDirection)(l.GetComponent(164).Owner))}switch(i.LocationForwardType){case 0:break;case 1:e=r.Actor.D_GetActorForwardVector();break;case 2:var c=r.ActorLocation.op_Subtraction(t);e.Set(c.X,c.Y,0);break;case 3:c=t.op_Subtraction(Global_1.Global.CharacterCameraManager.D_GetCameraLocation());e.Set(c.X,c.Y,0);break;case 4:(e=Global_1.Global.BaseCharacter.D_K2_GetActorLocation().op_Subtraction(t)).Set(e.X,e.Y,0)}var s,_=Vector_1.Vector.Create(t),n=new UE.TransformDouble(e.Rotation(),t,Vector_1.Vector.OneVectorDouble),k=UE.KismetMathLibrary.Conv_VectorToVectorDouble(i.LocationOffset);if(t=n.TransformPositionNoScale(k),i.Restrict){let e=r.ActorLocation;switch(i.RestrictType){case 0:e=Global_1.Global.BaseCharacter.D_K2_GetActorLocation();break;case 1:break;case 2:a.Entity.GetComponent(0).IsMonster()&&(s=r.GetInitLocation(),e.Set(s.X,s.Y,s.Z))}n=t.op_Subtraction(e).Size2D();n>i.RestrictDistance&&(k=i.RestrictDistance/n,MathUtils_1.MathUtils.LerpVector(e,t,k,t))}let v=Vector_1.Vector.Create(t);if(i.BestSpot){if(3===i.Strategy&&r.SetActorLocation(Global_1.Global.BaseCharacter.D_K2_GetActorLocation(),SkillBehaviorMisc_1.CONTEXT+".QTE设置位置保底",!1),!_.Equals(v))switch(i.Strategy){case 0:var h=(0,SkillBehaviorMisc_1.traceWall)(r,_,v,i.DebugTrace);if(!h)return;v=h[1];break;case 1:case 2:case 3:{let e=!1;var M=Vector_1.Vector.Create(),S=Vector_1.Vector.Create();v.Subtraction(_,M);for(const m of SkillBehaviorMisc_1.angles){M.RotateAngleAxis(m,Vector_1.Vector.UpVectorProxy,S),_.Addition(S,v);var b=(0,SkillBehaviorMisc_1.traceWall)(r,_,v,i.DebugTrace);if(!b)return;if(!b[0]){e=!0,v=b[1];break}}if(!e)return;let a=void 0;if(2===i.Strategy?0!==i.LocationType&&(a=Vector_1.Vector.Create(r.ActorLocation)):3===i.Strategy&&(a=Vector_1.Vector.Create(Global_1.Global.BaseCharacter.D_K2_GetActorLocation())),a){var h=Vector_1.Vector.Create(v),d=(0,SkillBehaviorMisc_1.traceWall)(r,a,h,i.DebugTrace);if(!d)return;var u=d[0];if(u){var B=u.GetHitCount();for(let e=0;e<B;e++)if(-1!==u.Actors.Get(e).Tags.FindIndex(SceneItemReferenceComponent_1.AIR_WALL)){v=d[1];break}}}break}}if(i.OnGround){n=(0,SkillBehaviorMisc_1.traceGround)(r,v,Vector_1.Vector.Create(v.X,v.Y,v.Z+SkillBehaviorMisc_1.DELTA_HEIGHT),i.DebugTrace);if(!n[0])return;(v=n[1]).Z+=i.GroundOffset}}if(t=v.ToUeVector(),0<i.Navigation&&!UE.NavigationSystemV1.D_K2_ProjectPointToNavigation(GlobalData_1.GlobalData.World,t,void 0,void 0,void 0,SkillBehaviorMisc_1.queryExtent)){k=(0,puerts_1.$ref)(void 0);if(!UE.NavigationSystemV1.D_K2_GetRandomLocationInNavigableRadius(GlobalData_1.GlobalData.World,t,k,i.Navigation))return;t=(0,puerts_1.$unref)(k)}r.SetActorLocation(t,SkillBehaviorMisc_1.CONTEXT+".Final",!1)}static bd(e,a){let i=void 0,r=void 0;switch(e.RotationType){case 0:r=a.SkillComponent.SkillTarget;break;case 1:r=ModelManager_1.ModelManager.SceneTeamModel.GetCurrentEntity;break;case 2:var t=a.Entity.GetComponent(0);r=ModelManager_1.ModelManager.CreatureModel.GetEntity(t.GetSummonerId());break;case 3:i=ModelManager_1.ModelManager.CameraModel.FightCamera.GetComponent(4).CameraActor.D_K2_GetActorLocation();break;case 4:a.SkillComponent.SkillTarget===ModelManager_1.ModelManager.SceneTeamModel.GetCurrentEntity?i=ModelManager_1.ModelManager.CameraModel.FightCamera.GetComponent(4).CameraActor.D_K2_GetActorLocation():r=a.SkillComponent.SkillTarget;break;default:r=ModelManager_1.ModelManager.CharacterModel.GetHandleByEntity(a.Entity)}r&&r.Entity!==a.Entity&&(i=r.Entity.GetComponent(1).ActorLocation);var o,l=a.Entity.GetComponent(3);let c=void 0;(c=i?((o=i.op_Subtraction(l.ActorLocation)).Z=0,o.Rotation()):l.ActorRotation).Yaw+=e.DirectionOffset,l.SetActorRotation(c,"SkillBehaviorAction.SetDirection")}static iZo(a,i){var r=i.Entity.GetComponent(21);for(let e=0;e<a.Cues.Num();e++){var t=a.Cues.Get(e),o=r.AddCue(Number(t.CueId),{Sync:!0});t.Stop&&(0,SkillBehaviorMisc_1.getEndSkillBehaviorParamList)(i.Skill).push({Entity:i.Entity,ActionType:a.ActionType,GameplayCue:o})}}static oZo(a,i){for(let e=0;e<a.Bullets.Num();e++){var r,t=a.Bullets.Get(e);for(let e=0;e<t.bulletCount;e++){let e=-1;i.Skill.MontageContextId?(r=i.Entity.GetComponent(3).Actor)instanceof TsBaseCharacter_1.default&&(e=BulletUtil_1.BulletUtil.CreateBulletFromAN(r,t.bulletRowName,i.Entity.GetComponent(3).ActorTransform,i.Skill.SkillId.toString(),!0,void 0)):e=ControllerHolder_1.ControllerHolder.BulletController.CreateBulletCustomTarget(i.Entity,t.bulletRowName,i.Entity.GetComponent(3).ActorTransform,{SkillId:i.Skill.SkillId,SkillContextId:i.Skill.CombatMessageId,SyncType:1},i.Skill.CombatMessageId).Id,t.BlackboardKey&&ControllerHolder_1.ControllerHolder.BlackboardController.SetIntValueByEntity(i.Entity.Id,t.BlackboardKey,e)}}}static rZo(e,a){a=ModelManager_1.ModelManager.CreatureModel.GetEntityById(a.Entity.Id);CameraUtility_1.CameraUtility.CheckApplyCameraModifyCondition(a,e.CameraModifierSettings,e.CameraEffectiveClientType,e.CameraModifierConditions)&&ControllerHolder_1.ControllerHolder.CameraController.FightCamera.LogicComponent.ApplyCameraModify(e.Tag,e.Duration,e.BlendInTime,e.BlendOutTime,e.CameraModifierSettings,void 0,e.BreakBlendOutTime,e.BlendInCurve,e.BlendOutCurve,void 0,e.CameraAttachSocket.toString())}static nZo(e,a){ControllerHolder_1.ControllerHolder.CameraController.SequenceCamera.PlayerComponent.PlayCameraSequence(e.CameraSequenceSettings,e.ResetLockOnCamera,e.AdditiveRotation,a.Entity.GetComponent(3).Actor,e.CameraAttachSocket,e.CameraDetectSocket,e.ExtraSphereLocation,e.ExtraDetectSphereRadius,e.IsShowExtraSphere)}static sZo(e,a){a.Entity.GetComponent(3).Actor.KuroSetMovementMode({Mode:e.BeginMovementMode,Context:"[SkillBehaviorAction.SetMovementMode]"}),(0,SkillBehaviorMisc_1.getEndSkillBehaviorParamList)(a.Skill).push({Entity:a.Entity,ActionType:e.ActionType,MovementMode:e.EndMovementMode})}static aZo(e,a){var i=a.Entity.GetComponent(3).Actor.CapsuleComponent;e.CollisionRestore&&(0,SkillBehaviorMisc_1.getEndSkillBehaviorParamList)(a.Skill).push({Entity:a.Entity,ActionType:e.ActionType,CollisionChannel:e.CollisionChannel,CollisionResponse:i.GetCollisionResponseToChannel(e.CollisionChannel)}),i.SetCollisionResponseToChannel(e.CollisionChannel,e.CollisionResponse)}static hZo(e,a){var i=PhantomUtil_1.PhantomUtil.GetSummonedEntity(a.Entity,Protocol_1.Aki.Protocol.Summon.x3s.Proto_ESummonTypeConcomitantCustom,e.FollowIndex);i&&(i=i.Entity.GetComponent(39),e.StopSummonSkill&&(0,SkillBehaviorMisc_1.getEndSkillBehaviorParamList)(a.Skill).push({Entity:a.Entity,ActionType:e.ActionType,SummonSkillComponent:i,SummonSkillId:e.SummonSkillId}),i.BeginSkill(e.SummonSkillId,{Target:a.SkillComponent.SkillTarget?.Entity,Context:"SkillBehaviorAction.UseSummonSkill"}))}static bst(e,a){let i=void 0;switch(e.BuffTarget){case 0:i=a.Entity.GetComponent(169);break;case 1:i=a.SkillComponent.SkillTarget?.Entity?.GetComponent(169)}var r,t;i&&(e.Add?(r={InstigatorId:ModelManager_1.ModelManager.CreatureModel.GetCreatureDataId(a.Entity.Id),Reason:"从技能行为添加Buff",PreMessageId:a.Skill.CombatMessageId},a.Skill.MontageContextId?(t=a.Entity.GetComponent(169),i.AddBuffFromAnimNotify(Number(e.BuffId),t,r)):i.AddBuff(Number(e.BuffId),r)):i.RemoveBuff(Number(e.BuffId),-1,"从技能行为移除Buff"))}static lZo(e,a){a=EntitySystem_1.EntitySystem.GetComponent(a.Entity.Id,200);a?.Valid&&"None"!==e.Tag.TagName&&(e.Add?a.AddTag(e.Tag.TagId):a.RemoveTag(e.Tag.TagId))}static _Zo(e,a){a=EntitySystem_1.EntitySystem.GetComponent(a.Entity.Id,19);a?.Valid&&a.TryExitWeakTime()}static Kpl(e,a){a=EntitySystem_1.EntitySystem.GetComponent(a.Entity.Id,39);a?.Valid&&a.PlaySkillMontageWithEndAbility(e.MontageIndex,e.StartSection,e.StartTime)}}exports.SkillBehaviorAction=SkillBehaviorAction;
//# sourceMappingURL=SkillBehaviorAction.js.map