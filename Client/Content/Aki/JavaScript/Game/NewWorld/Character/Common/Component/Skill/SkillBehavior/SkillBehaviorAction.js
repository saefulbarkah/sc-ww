
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SkillBehaviorAction=void 0;const puerts_1=require("puerts"),UE=require("ue"),Protocol_1=require("../../../../../../../Core/Define/Net/Protocol"),EntitySystem_1=require("../../../../../../../Core/Entity/EntitySystem"),Quat_1=require("../../../../../../../Core/Utils/Math/Quat"),Rotator_1=require("../../../../../../../Core/Utils/Math/Rotator"),Vector_1=require("../../../../../../../Core/Utils/Math/Vector"),MathUtils_1=require("../../../../../../../Core/Utils/MathUtils"),CameraUtility_1=require("../../../../../../Camera/CameraUtility"),TsBaseCharacter_1=require("../../../../../../Character/TsBaseCharacter"),Global_1=require("../../../../../../Global"),GlobalData_1=require("../../../../../../GlobalData"),ControllerHolder_1=require("../../../../../../Manager/ControllerHolder"),ModelManager_1=require("../../../../../../Manager/ModelManager"),PhantomUtil_1=require("../../../../../../Module/Phantom/PhantomUtil"),CombatLog_1=require("../../../../../../Utils/CombatLog"),WorldGlobal_1=require("../../../../../../World/WorldGlobal"),SkillBehaviorBatchBulletTask_1=require("../../../../../Bullet/BulletStaticMethod/SkillBehaviorBatchBulletTask"),BulletUtil_1=require("../../../../../Bullet/BulletUtil"),SceneItemReferenceComponent_1=require("../../../../../SceneItem/SceneItemReferenceComponent"),SkillBehaviorMisc_1=require("./SkillBehaviorMisc"),tmpVector=Vector_1.Vector.Create(),tmpQuat=Quat_1.Quat.Create(),tmpRotator=Rotator_1.Rotator.Create();class SkillBehaviorAction{static BeginGroup(t,a){if(a.Entity.GetComponent(3).IsAutonomousProxy)for(let e=0;e<t.Num();e++)this.Begin(t.Get(e),a)}static Begin(e,t){try{switch(e.ActionType){case 0:this.tZo(e,t);break;case 1:this.bd(e,t);break;case 2:this.iZo(e,t);break;case 3:this.oZo(e,t);break;case 4:this.rZo(e,t);break;case 5:this.nZo(e,t);break;case 6:this.sZo(e,t);break;case 7:this.aZo(e,t);break;case 8:this.hZo(e,t);break;case 9:this.bst(e,t);break;case 10:this.lZo(e,t);break;case 11:this._Zo(e,t);break;case 12:this.Kpl(e,t);break;case 13:this.K4_(e,t);break;case 14:this.fQ_(t.Entity,e.CommonConf,t.Skill.SkillId)}}catch(e){e instanceof Error?CombatLog_1.CombatLog.ErrorWithStack("Skill",t.Entity,"SkillBehaviorAction.Begin异常",e,["技能Id",t.Skill.SkillId],["技能名",t.Skill.SkillName]):CombatLog_1.CombatLog.Error("Skill",t.Entity,"SkillBehaviorAction.Begin异常",["技能Id",t.Skill.SkillId],["技能名",t.Skill.SkillName])}}static fQ_(e,t,a){SkillBehaviorBatchBulletTask_1.SkillBehaviorBatchBulletTask.Create(e,t,a).Start()}static End(a){SkillBehaviorMisc_1.paramMap.get(a)?.forEach(t=>{try{switch(t.ActionType){case 2:t.Entity.GetComponent(21).RemoveCueByHandle(t.GameplayCue);break;case 6:t.Entity.GetComponent(3).Actor.KuroSetMovementMode({Mode:t.MovementMode,Context:"[SkillBehaviorAction.End]"});break;case 7:t.Entity.GetComponent(3).Actor.CapsuleComponent.SetCollisionResponseToChannel(t.CollisionChannel,t.CollisionResponse);break;case 8:t.SummonSkillComponent.EndSkill(t.SummonSkillId,"SkillBehaviorAction.End")}}catch(e){e instanceof Error?CombatLog_1.CombatLog.ErrorWithStack("Skill",t.Entity,"SkillBehaviorAction.End异常",e,["技能Id",a.SkillId],["技能名",a.SkillName],["技能行为",t.ActionType]):CombatLog_1.CombatLog.Error("Skill",t.Entity,"SkillBehaviorAction.End异常",["技能Id",a.SkillId],["技能名",a.SkillName],["技能行为",t.ActionType])}}),SkillBehaviorMisc_1.paramMap.delete(a)}static tZo(a,t){var r=t.Entity.GetComponent(3);let i=r.ActorLocation,e=r.ActorForward;switch(a.LocationType){case 0:break;case 1:if(t.SkillComponent.SkillTarget){[i,e]=(0,SkillBehaviorMisc_1.getLocationAndDirection)(t.SkillComponent.SkillTarget.Entity.GetComponent(1).Owner);var o=t.SkillComponent.GetTargetTransform().GetLocation(),l=(0,SkillBehaviorMisc_1.traceWall)(r,Vector_1.Vector.Create(i),Vector_1.Vector.Create(o),a.DebugTrace);if(l&&l[0])break;i=o}break;case 2:l=ModelManager_1.ModelManager.SceneTeamModel.GetCurrentEntity.Entity.GetComponent(32).GetCurrentTarget();l&&([i,e]=(0,SkillBehaviorMisc_1.getLocationAndDirection)(l.Entity.GetComponent(1).Owner));break;case 3:[i,e]=(0,SkillBehaviorMisc_1.getLocationAndDirection)(Global_1.Global.BaseCharacter);break;case 4:o=ModelManager_1.ModelManager.CreatureModel.GetEntity(t.Entity.GetComponent(0).GetSummonerId())?.Entity?.GetComponent(1);[i,e]=(0,SkillBehaviorMisc_1.getLocationAndDirection)(o.Owner);break;case 5:[i,e]=(0,SkillBehaviorMisc_1.getLocationAndDirection)(ModelManager_1.ModelManager.CameraModel.FightCamera.GetComponent(4).CameraActor);break;case 6:l=ControllerHolder_1.ControllerHolder.BlackboardController.GetVectorValueByEntity(t.Entity.Id,a.BlackboardKey);i=WorldGlobal_1.WorldGlobal.ToUeVector(l);break;case 7:o=ControllerHolder_1.ControllerHolder.BlackboardController.GetIntValueByEntity(t.Entity.Id,a.BlackboardKey),l=EntitySystem_1.EntitySystem.Get(o);l?.Valid&&([i,e]=(0,SkillBehaviorMisc_1.getLocationAndDirection)(l.GetComponent(167).Owner))}switch(a.LocationForwardType){case 0:break;case 1:e=r.Actor.D_GetActorForwardVector();break;case 2:var c=r.ActorLocation.op_Subtraction(i);e.Set(c.X,c.Y,0);break;case 3:c=i.op_Subtraction(Global_1.Global.CharacterCameraManager.D_GetCameraLocation());e.Set(c.X,c.Y,0);break;case 4:(e=Global_1.Global.BaseCharacter.D_K2_GetActorLocation().op_Subtraction(i)).Set(e.X,e.Y,0)}var s,_=Vector_1.Vector.Create(i),n=new UE.TransformDouble(e.Rotation(),i,Vector_1.Vector.OneVectorDouble),k=UE.KismetMathLibrary.Conv_VectorToVectorDouble(a.LocationOffset);if(i=n.TransformPositionNoScale(k),a.Restrict){let e=r.ActorLocation;switch(a.RestrictType){case 0:e=Global_1.Global.BaseCharacter.D_K2_GetActorLocation();break;case 1:break;case 2:t.Entity.GetComponent(0).IsMonster()&&(s=r.GetInitLocation(),e.Set(s.X,s.Y,s.Z))}n=i.op_Subtraction(e).Size2D();n>a.RestrictDistance&&(k=a.RestrictDistance/n,MathUtils_1.MathUtils.LerpVector(e,i,k,i))}let v=Vector_1.Vector.Create(i);if(a.BestSpot){if(3===a.Strategy&&r.SetActorLocation(Global_1.Global.BaseCharacter.D_K2_GetActorLocation(),SkillBehaviorMisc_1.CONTEXT+".QTE设置位置保底",!1),!_.Equals(v))switch(a.Strategy){case 0:var h=(0,SkillBehaviorMisc_1.traceWall)(r,_,v,a.DebugTrace);if(!h)return;v=h[1];break;case 1:case 2:case 3:{let e=!1;var S=Vector_1.Vector.Create(),u=Vector_1.Vector.Create();v.Subtraction(_,S);for(const p of SkillBehaviorMisc_1.angles){S.RotateAngleAxis(p,Vector_1.Vector.UpVectorProxy,u),_.Addition(u,v);var M=(0,SkillBehaviorMisc_1.traceWall)(r,_,v,a.DebugTrace);if(!M)return;if(!M[0]){e=!0,v=M[1];break}}if(!e)return;let t=void 0;if(2===a.Strategy?0!==a.LocationType&&(t=Vector_1.Vector.Create(r.ActorLocation)):3===a.Strategy&&(t=Vector_1.Vector.Create(Global_1.Global.BaseCharacter.D_K2_GetActorLocation())),t){var h=Vector_1.Vector.Create(v),b=(0,SkillBehaviorMisc_1.traceWall)(r,t,h,a.DebugTrace);if(!b)return;var m=b[0];if(m){var d=m.GetHitCount();for(let e=0;e<d;e++)if(-1!==m.Actors.Get(e).Tags.FindIndex(SceneItemReferenceComponent_1.AIR_WALL)){v=b[1];break}}}break}}if(a.OnGround){n=(0,SkillBehaviorMisc_1.traceGroundWithGravity)(r,v,a.DebugTrace);if(!n[0])return;(v=n[1]).Z+=a.GroundOffset}}i=v.ToUeVector();k=a.Navigation;if(0<k){var n=t.Entity.GetComponent(176),B=Vector_1.Vector.Create();if(n.GravityUp.Multiply(k,B),!UE.NavigationSystemV1.D_K2_ProjectPointToNavigation(GlobalData_1.GlobalData.World,i,void 0,void 0,void 0,B.ToUeVector(),k)){n=(0,puerts_1.$ref)(void 0);if(!UE.NavigationSystemV1.D_K2_GetRandomLocationInNavigableRadius(GlobalData_1.GlobalData.World,i,n,k))return;i=(0,puerts_1.$unref)(n)}}r.SetActorLocation(i,SkillBehaviorMisc_1.CONTEXT+".Final",!1)}static bd(e,t){let a=void 0,r=void 0;switch(e.RotationType){case 0:r=t.SkillComponent.SkillTarget;break;case 1:r=ModelManager_1.ModelManager.SceneTeamModel.GetCurrentEntity;break;case 2:var i=t.Entity.GetComponent(0);r=ModelManager_1.ModelManager.CreatureModel.GetEntity(i.GetSummonerId());break;case 3:(a=tmpVector).FromUeVector(ModelManager_1.ModelManager.CameraModel.FightCamera.GetComponent(4).CameraActor.D_K2_GetActorLocation());break;case 4:t.SkillComponent.SkillTarget===ModelManager_1.ModelManager.SceneTeamModel.GetCurrentEntity?(a=tmpVector).FromUeVector(ModelManager_1.ModelManager.CameraModel.FightCamera.GetComponent(4).CameraActor.D_K2_GetActorLocation()):r=t.SkillComponent.SkillTarget;break;default:r=ModelManager_1.ModelManager.CharacterModel.GetHandleByEntity(t.Entity)}r&&r.Entity!==t.Entity&&(a=r.Entity.GetComponent(1).ActorLocationProxy);var o=t.Entity.GetComponent(3);a?(a.Subtraction(o.ActorLocationProxy,tmpVector),MathUtils_1.MathUtils.LookRotationUpFirst(tmpVector,o.MoveComp.GravityUp,tmpQuat)):tmpQuat.DeepCopy(o.ActorQuatProxy),0!==e.DirectionOffset&&(tmpRotator.Set(0,e.DirectionOffset,0),tmpQuat.Multiply(tmpRotator.Quaternion(),tmpQuat)),tmpQuat.Rotator(tmpRotator),o.SetActorRotation(tmpRotator.ToUeRotator(),"SkillBehaviorAction.SetDirection")}static iZo(t,a){var r=a.Entity.GetComponent(21);for(let e=0;e<t.Cues.Num();e++){var i=t.Cues.Get(e),o=r.AddCue(Number(i.CueId),{Sync:!0});i.Stop&&(0,SkillBehaviorMisc_1.getEndSkillBehaviorParamList)(a.Skill).push({Entity:a.Entity,ActionType:t.ActionType,GameplayCue:o})}}static oZo(t,a){for(let e=0;e<t.Bullets.Num();e++){var r,i=t.Bullets.Get(e);for(let e=0;e<i.bulletCount;e++){let e=-1;a.Skill.SkillBehaviorAnimNotifyMessageId?(r=a.Entity.GetComponent(3).Actor)instanceof TsBaseCharacter_1.default&&(e=BulletUtil_1.BulletUtil.CreateBulletFromAN(r,i.bulletRowName,a.Entity.GetComponent(3).ActorTransform,a.Skill.SkillId.toString(),!0,a.Skill.SkillBehaviorAnimNotifyMessageId)):e=ControllerHolder_1.ControllerHolder.BulletController.CreateBulletCustomTarget(a.Entity,i.bulletRowName,a.Entity.GetComponent(3).ActorTransform,{SkillId:a.Skill.SkillId,SkillContextId:a.Skill.CombatMessageId,SyncType:1},a.Skill.CombatMessageId).Id,i.BlackboardKey&&ControllerHolder_1.ControllerHolder.BlackboardController.SetIntValueByEntity(a.Entity.Id,i.BlackboardKey,e)}}}static rZo(e,t){t=ModelManager_1.ModelManager.CreatureModel.GetEntityById(t.Entity.Id);CameraUtility_1.CameraUtility.CheckApplyCameraModifyCondition(t,e.CameraModifierSettings,e.CameraEffectiveClientType,e.CameraModifierConditions)&&ControllerHolder_1.ControllerHolder.CameraController.FightCamera.LogicComponent.ApplyCameraModify(e.Tag,e.Duration,e.BlendInTime,e.BlendOutTime,e.CameraModifierSettings,void 0,e.BreakBlendOutTime,e.BlendInCurve,e.BlendOutCurve,void 0,e.CameraAttachSocket.toString())}static nZo(e,t){ControllerHolder_1.ControllerHolder.CameraController.SequenceCamera.PlayerComponent.PlayCameraSequence(e.CameraSequenceSettings,e.ResetLockOnCamera,e.AdditiveRotation,t.Entity.GetComponent(3).Actor,e.CameraAttachSocket,e.CameraDetectSocket,e.ExtraSphereLocation,e.ExtraDetectSphereRadius,e.IsShowExtraSphere)}static sZo(e,t){t.Entity.GetComponent(3).Actor.KuroSetMovementMode({Mode:e.BeginMovementMode,Context:"[SkillBehaviorAction.SetMovementMode]"}),(0,SkillBehaviorMisc_1.getEndSkillBehaviorParamList)(t.Skill).push({Entity:t.Entity,ActionType:e.ActionType,MovementMode:e.EndMovementMode})}static aZo(e,t){var a=t.Entity.GetComponent(3).Actor.CapsuleComponent;e.CollisionRestore&&(0,SkillBehaviorMisc_1.getEndSkillBehaviorParamList)(t.Skill).push({Entity:t.Entity,ActionType:e.ActionType,CollisionChannel:e.CollisionChannel,CollisionResponse:a.GetCollisionResponseToChannel(e.CollisionChannel)}),a.SetCollisionResponseToChannel(e.CollisionChannel,e.CollisionResponse)}static hZo(e,t){var a=PhantomUtil_1.PhantomUtil.GetSummonedEntity(t.Entity,Protocol_1.Aki.Protocol.Summon.x3s.Proto_ESummonTypeConcomitantCustom,e.FollowIndex);a&&(a=a.Entity.GetComponent(39),e.StopSummonSkill&&(0,SkillBehaviorMisc_1.getEndSkillBehaviorParamList)(t.Skill).push({Entity:t.Entity,ActionType:e.ActionType,SummonSkillComponent:a,SummonSkillId:e.SummonSkillId}),a.BeginSkill(e.SummonSkillId,{Target:t.SkillComponent.SkillTarget?.Entity,Context:"SkillBehaviorAction.UseSummonSkill"}))}static bst(e,t){let a=void 0;switch(e.BuffTarget){case 0:a=t.Entity.GetComponent(172);break;case 1:a=t.SkillComponent.SkillTarget?.Entity?.GetComponent(172)}var r;a&&(e.Add?(r=t.Skill.SkillBehaviorAnimNotifyMessageId||t.Skill.CombatMessageId,r={InstigatorId:ModelManager_1.ModelManager.CreatureModel.GetCreatureDataId(t.Entity.Id),Reason:"从技能行为添加Buff",PreMessageId:r},a.AddBuff(Number(e.BuffId),r)):a.RemoveBuff(Number(e.BuffId),-1,"从技能行为移除Buff"))}static lZo(e,t){t=EntitySystem_1.EntitySystem.GetComponent(t.Entity.Id,203);t?.Valid&&"None"!==e.Tag.TagName&&(e.Add?t.AddTag(e.Tag.TagId):t.RemoveTag(e.Tag.TagId))}static _Zo(e,t){t=EntitySystem_1.EntitySystem.GetComponent(t.Entity.Id,19);t?.Valid&&t.TryExitWeakTime()}static Kpl(e,t){t=EntitySystem_1.EntitySystem.GetComponent(t.Entity.Id,39);t?.Valid&&t.PlaySkillMontageWithEndAbility(e.MontageIndex,e.StartSection,e.StartTime)}static K4_(e,t){var a=EntitySystem_1.EntitySystem.GetComponent(t.Entity.Id,275);if(a?.Valid){var r=e.UpdateCustomValue.ValueName,i=r.Num();for(let e=0;e<i;e++){var o=r.Get(e);a.UpdateCustomValue(o)}}}}exports.SkillBehaviorAction=SkillBehaviorAction;
//# sourceMappingURL=SkillBehaviorAction.js.map