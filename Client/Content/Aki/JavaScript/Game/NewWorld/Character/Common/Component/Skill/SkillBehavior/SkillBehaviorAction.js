
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SkillBehaviorAction=void 0;const puerts_1=require("puerts"),UE=require("ue"),Protocol_1=require("../../../../../../../Core/Define/Net/Protocol"),EntitySystem_1=require("../../../../../../../Core/Entity/EntitySystem"),Vector_1=require("../../../../../../../Core/Utils/Math/Vector"),MathUtils_1=require("../../../../../../../Core/Utils/MathUtils"),CameraController_1=require("../../../../../../Camera/CameraController"),CameraUtility_1=require("../../../../../../Camera/CameraUtility"),TsBaseCharacter_1=require("../../../../../../Character/TsBaseCharacter"),Global_1=require("../../../../../../Global"),GlobalData_1=require("../../../../../../GlobalData"),ModelManager_1=require("../../../../../../Manager/ModelManager"),PhantomUtil_1=require("../../../../../../Module/Phantom/PhantomUtil"),CombatLog_1=require("../../../../../../Utils/CombatLog"),BlackboardController_1=require("../../../../../../World/Controller/BlackboardController"),WorldGlobal_1=require("../../../../../../World/WorldGlobal"),BulletController_1=require("../../../../../Bullet/BulletController"),BulletUtil_1=require("../../../../../Bullet/BulletUtil"),SceneItemReferenceComponent_1=require("../../../../../SceneItem/SceneItemReferenceComponent"),SkillBehaviorMisc_1=require("./SkillBehaviorMisc");class SkillBehaviorAction{static BeginGroup(a,r){if(r.Entity.GetComponent(3).IsAutonomousProxy)for(let e=0;e<a.Num();e++)this.Begin(a.Get(e),r)}static Begin(e,a){try{switch(e.ActionType){case 0:this.tZo(e,a);break;case 1:this.bd(e,a);break;case 2:this.iZo(e,a);break;case 3:this.oZo(e,a);break;case 4:this.rZo(e,a);break;case 5:this.nZo(e,a);break;case 6:this.sZo(e,a);break;case 7:this.aZo(e,a);break;case 8:this.hZo(e,a);break;case 9:this.bst(e,a);break;case 10:this.lZo(e,a);break;case 11:this._Zo(e,a)}}catch(e){e instanceof Error?CombatLog_1.CombatLog.ErrorWithStack("Skill",a.Entity,"SkillBehaviorAction.Begin异常",e,["技能Id",a.Skill.SkillId],["技能名",a.Skill.SkillName]):CombatLog_1.CombatLog.Error("Skill",a.Entity,"SkillBehaviorAction.Begin异常",["技能Id",a.Skill.SkillId],["技能名",a.Skill.SkillName])}}static End(r){SkillBehaviorMisc_1.paramMap.get(r)?.forEach(a=>{try{switch(a.ActionType){case 2:a.Entity.GetComponent(19).DestroyGameplayCueByHandle(a.GameplayCue);break;case 6:a.Entity.GetComponent(164).CharacterMovement.SetMovementMode(a.MovementMode);break;case 7:a.Entity.GetComponent(3).Actor.CapsuleComponent.SetCollisionResponseToChannel(a.CollisionChannel,a.CollisionResponse);break;case 8:a.SummonSkillComponent.EndSkill(a.SummonSkillId,"SkillBehaviorAction.End")}}catch(e){e instanceof Error?CombatLog_1.CombatLog.ErrorWithStack("Skill",a.Entity,"SkillBehaviorAction.End异常",e,["技能Id",r.SkillId],["技能名",r.SkillName],["技能行为",a.ActionType]):CombatLog_1.CombatLog.Error("Skill",a.Entity,"SkillBehaviorAction.End异常",["技能Id",r.SkillId],["技能名",r.SkillName],["技能行为",a.ActionType])}}),SkillBehaviorMisc_1.paramMap.delete(r)}static tZo(a,r){var i=r.Entity.GetComponent(3);let t=i.ActorLocation,e=i.ActorForward;switch(a.LocationType){case 0:break;case 1:if(r.SkillComponent.SkillTarget){[t,e]=(0,SkillBehaviorMisc_1.getLocationAndDirection)(r.SkillComponent.SkillTarget.Entity.GetComponent(1).Owner);var l=r.SkillComponent.GetTargetTransform().GetLocation(),o=(0,SkillBehaviorMisc_1.traceWall)(i,Vector_1.Vector.Create(t),Vector_1.Vector.Create(l),a.DebugTrace);if(o&&o[0])break;t=l}break;case 2:o=ModelManager_1.ModelManager.SceneTeamModel.GetCurrentEntity.Entity.GetComponent(29).GetCurrentTarget();o&&([t,e]=(0,SkillBehaviorMisc_1.getLocationAndDirection)(o.Entity.GetComponent(1).Owner));break;case 3:[t,e]=(0,SkillBehaviorMisc_1.getLocationAndDirection)(Global_1.Global.BaseCharacter);break;case 4:l=ModelManager_1.ModelManager.CreatureModel.GetEntity(r.Entity.GetComponent(0).GetSummonerId())?.Entity?.GetComponent(1);[t,e]=(0,SkillBehaviorMisc_1.getLocationAndDirection)(l.Owner);break;case 5:[t,e]=(0,SkillBehaviorMisc_1.getLocationAndDirection)(ModelManager_1.ModelManager.CameraModel.FightCamera.GetComponent(4).CameraActor);break;case 6:o=BlackboardController_1.BlackboardController.GetVectorValueByEntity(r.Entity.Id,a.BlackboardKey);t=WorldGlobal_1.WorldGlobal.ToUeVector(o);break;case 7:l=BlackboardController_1.BlackboardController.GetIntValueByEntity(r.Entity.Id,a.BlackboardKey),o=EntitySystem_1.EntitySystem.Get(l);o?.Valid&&([t,e]=(0,SkillBehaviorMisc_1.getLocationAndDirection)(o.GetComponent(155).Owner))}switch(a.LocationForwardType){case 0:break;case 1:e=i.Actor.GetActorForwardVector();break;case 2:(e=i.ActorLocation.op_Subtraction(t)).Set(e.X,e.Y,0);break;case 3:(e=t.op_Subtraction(Global_1.Global.CharacterCameraManager.GetCameraLocation())).Set(e.X,e.Y,0)}var c,s=Vector_1.Vector.Create(t),n=new UE.Transform(e.Rotation(),t,Vector_1.Vector.OneVector);if(t=n.TransformPositionNoScale(a.LocationOffset),a.Restrict){let e=i.ActorLocation;switch(a.RestrictType){case 0:e=Global_1.Global.BaseCharacter.K2_GetActorLocation();break;case 1:break;case 2:r.Entity.GetComponent(0).IsMonster()&&(c=i.GetInitLocation(),e.Set(c.X,c.Y,c.Z))}var n=t.op_Subtraction(e).Size2D();n>a.RestrictDistance&&(n=a.RestrictDistance/n,MathUtils_1.MathUtils.LerpVector(e,t,n,t))}let _=Vector_1.Vector.Create(t);if(!s.Equals(_)&&a.BestSpot){switch(a.Strategy){case 0:var k=(0,SkillBehaviorMisc_1.traceWall)(i,s,_,a.DebugTrace);if(!k)return;_=k[1];break;case 1:{let e=!1;var v=Vector_1.Vector.Create(),h=Vector_1.Vector.Create();_.Subtraction(s,v);for(const B of SkillBehaviorMisc_1.angles){v.RotateAngleAxis(B,Vector_1.Vector.UpVectorProxy,h),s.Addition(h,_);var b=(0,SkillBehaviorMisc_1.traceWall)(i,s,_,a.DebugTrace);if(!b)return;if(!b[0]){e=!0,_=b[1];break}}if(e)break;return}}if(0!==a.LocationType){var n=Vector_1.Vector.Create(i.ActorLocation),M=Vector_1.Vector.Create(_),S=(0,SkillBehaviorMisc_1.traceWall)(i,n,M,a.DebugTrace);if(!S)return;var d=S[0];if(d){var u=d.GetHitCount();for(let e=0;e<u;e++)if(-1!==d.Actors.Get(e).Tags.FindIndex(SceneItemReferenceComponent_1.AIR_WALL)){_=S[1];break}}}if(a.OnGround){n=(0,SkillBehaviorMisc_1.traceGround)(i,_,a.DebugTrace);if(!n[0])return;_=n[1]}}if(t=_.ToUeVector(),0<a.Navigation&&!UE.NavigationSystemV1.K2_ProjectPointToNavigation(GlobalData_1.GlobalData.World,t,void 0,void 0,void 0,SkillBehaviorMisc_1.queryExtent)){M=(0,puerts_1.$ref)(void 0);if(!UE.NavigationSystemV1.K2_GetRandomLocationInNavigableRadius(GlobalData_1.GlobalData.World,t,M,a.Navigation))return;t=(0,puerts_1.$unref)(M)}i.SetActorLocation(t,SkillBehaviorMisc_1.CONTEXT+".Final",!1)}static bd(e,a){let r=void 0,i=void 0;switch(e.RotationType){case 0:i=a.SkillComponent.SkillTarget;break;case 1:i=ModelManager_1.ModelManager.SceneTeamModel.GetCurrentEntity;break;case 2:var t=a.Entity.GetComponent(0);i=ModelManager_1.ModelManager.CreatureModel.GetEntity(t.GetSummonerId());break;case 3:r=ModelManager_1.ModelManager.CameraModel.FightCamera.GetComponent(4).CameraActor.K2_GetActorLocation();break;case 4:a.SkillComponent.SkillTarget===ModelManager_1.ModelManager.SceneTeamModel.GetCurrentEntity?r=ModelManager_1.ModelManager.CameraModel.FightCamera.GetComponent(4).CameraActor.K2_GetActorLocation():i=a.SkillComponent.SkillTarget;break;default:i=ModelManager_1.ModelManager.CharacterModel.GetHandleByEntity(a.Entity)}i&&i.Entity!==a.Entity&&(r=i.Entity.GetComponent(1).ActorLocation);var l,o=a.Entity.GetComponent(3);let c=void 0;(c=r?((l=r.op_Subtraction(o.ActorLocation)).Z=0,l.Rotation()):o.ActorRotation).Yaw+=e.DirectionOffset,o.SetActorRotation(c,"SkillBehaviorAction.SetDirection")}static iZo(a,r){var i=r.Entity.GetComponent(19);for(let e=0;e<a.Cues.Num();e++){var t=a.Cues.Get(e),l=i.CreateGameplayCue(t.CueId,{Sync:!0});t.Stop&&(0,SkillBehaviorMisc_1.getEndSkillBehaviorParamList)(r.Skill).push({Entity:r.Entity,ActionType:a.ActionType,GameplayCue:l})}}static oZo(a,r){for(let e=0;e<a.Bullets.Num();e++){var i,t=a.Bullets.Get(e);for(let e=0;e<t.bulletCount;e++){let e=-1;r.Skill.MontageContextId?(i=r.Entity.GetComponent(3).Actor)instanceof TsBaseCharacter_1.default&&(e=BulletUtil_1.BulletUtil.CreateBulletFromAN(i,t.bulletRowName,r.Entity.GetComponent(3).ActorTransform,r.Skill.SkillId.toString(),!0,void 0)):e=BulletController_1.BulletController.CreateBulletCustomTarget(r.Entity,t.bulletRowName,r.Entity.GetComponent(3).ActorTransform,{SkillId:r.Skill.SkillId,SyncType:1},r.Skill.CombatMessageId).Id,t.BlackboardKey&&BlackboardController_1.BlackboardController.SetIntValueByEntity(r.Entity.Id,t.BlackboardKey,e)}}}static rZo(e,a){a=ModelManager_1.ModelManager.CreatureModel.GetEntityById(a.Entity.Id);CameraUtility_1.CameraUtility.CheckApplyCameraModifyCondition(a,e.CameraModifierSettings,e.CameraEffectiveClientType,e.CameraModifierConditions)&&CameraController_1.CameraController.FightCamera.LogicComponent.ApplyCameraModify(e.Tag,e.Duration,e.BlendInTime,e.BlendOutTime,e.CameraModifierSettings,void 0,e.BreakBlendOutTime,void 0,void 0,void 0,e.CameraAttachSocket.toString())}static nZo(e,a){CameraController_1.CameraController.SequenceCamera.PlayerComponent.PlayCameraSequence(e.CameraSequenceSettings,e.ResetLockOnCamera,e.AdditiveRotation,a.Entity.GetComponent(3).Actor,e.CameraAttachSocket,e.CameraDetectSocket,e.ExtraSphereLocation,e.ExtraDetectSphereRadius,e.IsShowExtraSphere)}static sZo(e,a){a.Entity.GetComponent(164).CharacterMovement.SetMovementMode(e.BeginMovementMode),(0,SkillBehaviorMisc_1.getEndSkillBehaviorParamList)(a.Skill).push({Entity:a.Entity,ActionType:e.ActionType,MovementMode:e.EndMovementMode})}static aZo(e,a){var r=a.Entity.GetComponent(3).Actor.CapsuleComponent;e.CollisionRestore&&(0,SkillBehaviorMisc_1.getEndSkillBehaviorParamList)(a.Skill).push({Entity:a.Entity,ActionType:e.ActionType,CollisionChannel:e.CollisionChannel,CollisionResponse:r.GetCollisionResponseToChannel(e.CollisionChannel)}),r.SetCollisionResponseToChannel(e.CollisionChannel,e.CollisionResponse)}static hZo(e,a){var r=PhantomUtil_1.PhantomUtil.GetSummonedEntity(a.Entity,Protocol_1.Aki.Protocol.Summon.x3s.Proto_ESummonTypeConcomitantCustom,e.FollowIndex);r&&(r=r.Entity.GetComponent(34),e.StopSummonSkill&&(0,SkillBehaviorMisc_1.getEndSkillBehaviorParamList)(a.Skill).push({Entity:a.Entity,ActionType:e.ActionType,SummonSkillComponent:r,SummonSkillId:e.SummonSkillId}),r.BeginSkill(e.SummonSkillId,{Target:a.SkillComponent.SkillTarget?.Entity,Context:"SkillBehaviorAction.UseSummonSkill"}))}static bst(e,a){let r=void 0;switch(e.BuffTarget){case 0:r=a.Entity.GetComponent(160);break;case 1:r=a.SkillComponent.SkillTarget?.Entity?.GetComponent(160)}var i,t;r&&(e.Add?(i={InstigatorId:ModelManager_1.ModelManager.CreatureModel.GetCreatureDataId(a.Entity.Id),Reason:"从技能行为添加Buff",PreMessageId:a.Skill.CombatMessageId},a.Skill.MontageContextId?(t=a.Entity.GetComponent(160),r.AddBuffFromAnimNotify(e.BuffId,t,i)):r.AddBuff(e.BuffId,i)):r.RemoveBuff(e.BuffId,-1,"从技能行为移除Buff"))}static lZo(e,a){a=EntitySystem_1.EntitySystem.GetComponent(a.Entity.Id,190);a?.Valid&&"None"!==e.Tag.TagName&&(e.Add?a.AddTag(e.Tag.TagId):a.RemoveTag(e.Tag.TagId))}static _Zo(e,a){a=EntitySystem_1.EntitySystem.GetComponent(a.Entity.Id,18);a?.Valid&&a.TryExitWeakTime()}}exports.SkillBehaviorAction=SkillBehaviorAction;
//# sourceMappingURL=SkillBehaviorAction.js.map