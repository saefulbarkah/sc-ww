
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MontageManager=void 0;const UE=require("ue"),Log_1=require("../../../../../../Core/Common/Log"),Queue_1=require("../../../../../../Core/Container/Queue"),ResourceSystem_1=require("../../../../../../Core/Resource/ResourceSystem"),TimerSystem_1=require("../../../../../../Core/Timer/TimerSystem"),ObjectUtils_1=require("../../../../../../Core/Utils/ObjectUtils"),StringUtils_1=require("../../../../../../Core/Utils/StringUtils"),EventDefine_1=require("../../../../../Common/Event/EventDefine"),EventSystem_1=require("../../../../../Common/Event/EventSystem"),ModelManager_1=require("../../../../../Manager/ModelManager"),CharacterNameDefines_1=require("../../CharacterNameDefines"),MONTAGE_BLEND_TIME=.5,LOADING_ID=-2;class MontageManager{constructor(){this.hJ=1,this.oRe=void 0,this.sDe=void 0,this.j7l=ResourceSystem_1.ResourceSystem.InvalidId,this.YV_=void 0,this.zV_=void 0,this.WV_=void 0,this.JV_=void 0,this.ZV_=void 0,this.ej_=!1,this.tj_=new Queue_1.Queue,this.ij_=(e,t)=>{this.rj_.Montage_IsActive(e)||e===this.JV_&&(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("BasePerform",26,"[Montage] 实体播放蒙太奇结束",["pbDataId",this.sDe.PbDataId],["handle",this.hJ],["bInterrupted",t],["path",this.ZV_]),this.rj_.OnMontageEnded.Remove(this.ij_.bind(this)),this.oj_(t))}}get rj_(){return this.oRe.MainAnimInstance}Init(e){this.oRe=e,this.sDe=ModelManager_1.ModelManager.CreatureModel.GetEntityById(e.Entity.Id)}ClearObject(){return this.Clear(),!0}Clear(){this.oRe=void 0,this.sDe=void 0,this.j7l!==ResourceSystem_1.ResourceSystem.InvalidId&&ResourceSystem_1.ResourceSystem.CancelAsyncLoad(this.j7l),this.j7l=ResourceSystem_1.ResourceSystem.InvalidId,this.YV_?.Remove(),this.YV_=void 0,this.JV_=void 0,this.ZV_=void 0,this.zV_=void 0,this.WV_=void 0,this.tj_.Clear()}IsMontagePlaying(e){return void 0!==e?this.hJ===e:this.j7l!==ResourceSystem_1.ResourceSystem.InvalidId||ObjectUtils_1.ObjectUtils.IsValid(this.JV_)}PlayMontage(a){if(this.ej_)return Log_1.Log.CheckError()&&Log_1.Log.Error("BasePerform",26,"[Montage] 播放蒙太奇嵌套"),-1;this.ej_=!0;let r=void 0,o=void 0;!this.JV_||a.MontagePath!==this.ZV_&&a.MontageAsset!==this.JV_||(e=this.rj_.Montage_GetCurrentSection(this.JV_),o=this.JV_,a.InSectionToStartMontageAt?e.op_Equality(a.InSectionToStartMontageAt)&&(r=this.rj_.Montage_GetPosition(this.JV_)):e.op_Equality(CharacterNameDefines_1.CharacterNameDefines.END_SECTION)||(r=this.rj_.Montage_GetPosition(this.JV_))),this.StopMontage({Method:0,ImmediatelyCallback:!0});const n=this.hJ;if(a.OnStartCallback?.(n),this.WV_=a.OnEndCallback,this.zV_=a.OnPlayCallback,StringUtils_1.StringUtils.IsEmpty(a.MontagePath)&&!ObjectUtils_1.ObjectUtils.IsValid(a.MontageAsset)){for(Log_1.Log.CheckError()&&Log_1.Log.Error("BasePerform",26,"[Montage] 实体播放蒙太奇路径和资产都为空",["pbDataId",this.sDe.PbDataId]),this.oj_(),this.ej_=!1;!this.tj_.Empty;)this.tj_.Pop()?.();return-1}this.ZV_=a.MontagePath??UE.KismetSystemLibrary.GetPathName(a.MontageAsset);var e=e=>{if(this.j7l=ResourceSystem_1.ResourceSystem.InvalidId,e&&ObjectUtils_1.ObjectUtils.IsValid(e)&&this.nj_(e)){this.JV_=e;let t=r;if(void 0===t&&a.InSectionToStartMontageAt){var i=e.CompositeSections,s=i.Num();for(let e=0;e<s;e++){var h=i.Get(e);if(h.SectionName.op_Equality(a.InSectionToStartMontageAt)){t=h.SegmentBeginTime;break}}void 0===t&&Log_1.Log.CheckDebug()&&Log_1.Log.Debug("BasePerform",26,"[Montage] PlayMontage找不到片段",["montage",e.GetName()],["section",a.InSectionToStartMontageAt])}this.rj_.Montage_Play(this.JV_,void 0,void 0,t,!a.KeepOtherMontage),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("BasePerform",26,"[Montage] 实体播放蒙太奇",["pbDataId",this.sDe.PbDataId],["handle",n],["startTime",t],["isLoop",a.IsLoop],["path",this.ZV_]),this.sj_(a.Duration),this.aj_(a.IsLoop),o||this.rj_.OnMontageEnded.Add(this.ij_.bind(this)),this.zV_?.(this.JV_)}else this.oj_()};for(a.MontageAsset||o?e(a.MontageAsset??o):(this.j7l=LOADING_ID,e=ResourceSystem_1.ResourceSystem.LoadAsync(a.MontagePath,UE.AnimMontage,e),this.j7l===LOADING_ID&&(this.j7l=e)),this.ej_=!1;!this.tj_.Empty;)this.tj_.Pop()?.();return n===this.hJ?n:-1}StopMontage(e){if((void 0===e.HandleId||this.hJ===e.HandleId)&&this.ZV_){if(e.Montage){if(this.JV_!==e.Montage)return;if(UE.KismetSystemLibrary.GetPathName(e.Montage)!==this.ZV_)return}var t=e.Delay??0;if(t>TimerSystem_1.MIN_TIME&&t<TimerSystem_1.MAX_TIME)this.sj_(t,e.Method,t);else if(this.j7l!==ResourceSystem_1.ResourceSystem.InvalidId)this.oj_();else{Log_1.Log.CheckDebug()&&Log_1.Log.Debug("BasePerform",26,"[Montage] 实体停止蒙太奇",["id",this.sDe.PbDataId],["handle",this.hJ],["method",e.Method],["path",this.ZV_]);var i=this.JV_.CompositeSections,s=i.Num();let t=!1;for(let e=0;e<s;e++)if(i.Get(e).SectionName.op_Equality(CharacterNameDefines_1.CharacterNameDefines.END_SECTION)){t=!0;break}var h,a=e.BlendOutTime??MONTAGE_BLEND_TIME;switch(e.Method??0){case 0:this.rj_.Montage_Stop(a,this.JV_);break;case 1:t?(this.rj_.Montage_SetNextSection(CharacterNameDefines_1.CharacterNameDefines.START_SECTION,CharacterNameDefines_1.CharacterNameDefines.END_SECTION,this.JV_),this.rj_.Montage_SetNextSection(CharacterNameDefines_1.CharacterNameDefines.LOOP_SECTION,CharacterNameDefines_1.CharacterNameDefines.END_SECTION,this.JV_)):(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("BasePerform",26,"[Montage] 蒙太奇没有End片段，直接混出",["pbDataId",this.sDe.PbDataId],["path",this.ZV_]),this.rj_.Montage_Stop(a,this.JV_));break;case 4:t?this.rj_.Montage_SetNextSection(CharacterNameDefines_1.CharacterNameDefines.LOOP_SECTION,CharacterNameDefines_1.CharacterNameDefines.END_SECTION,this.JV_):(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("BasePerform",26,"[Montage] 蒙太奇没有End片段，直接混出",["pbDataId",this.sDe.PbDataId],["path",this.ZV_]),this.rj_.Montage_Stop(a,this.JV_));break;case 2:t?this.rj_.Montage_JumpToSection(CharacterNameDefines_1.CharacterNameDefines.END_SECTION,this.JV_):(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("BasePerform",26,"[Montage] 蒙太奇没有End片段，直接混出",["pbDataId",this.sDe.PbDataId],["path",this.ZV_]),this.rj_.Montage_Stop(a,this.JV_));break;case 3:t?(h=this.rj_.Montage_GetPosition(this.JV_),a<(h=this.JV_.SequenceLength-h)&&this.rj_.Montage_SetPlayRate(this.JV_,h/a),this.oRe.MainAnimInstance.Montage_SetNextSection(CharacterNameDefines_1.CharacterNameDefines.LOOP_SECTION,CharacterNameDefines_1.CharacterNameDefines.END_SECTION,this.JV_)):(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("BasePerform",26,"[Montage] 蒙太奇没有End片段，直接混出",["pbDataId",this.sDe.PbDataId],["path",this.ZV_]),this.rj_.Montage_Stop(a,this.JV_))}e.ImmediatelyCallback&&this.oj_()}}}ClearCallback(e){void 0!==e&&this.hJ!==e||(this.zV_=void 0,this.WV_=void 0)}sj_(e=0,t=2,i){this.YV_?.Remove(),this.YV_=void 0,e>TimerSystem_1.MIN_TIME&&e<TimerSystem_1.MAX_TIME&&(this.YV_=TimerSystem_1.TimerSystem.Delay(()=>{this.YV_=void 0,this.StopMontage({Method:t,BlendOutTime:i})},e))}aj_(e){if(void 0!==e){let t=!1,i=!1;for(let e=0;e<this.JV_.CompositeSections.Num();e++){var s=this.JV_.CompositeSections.Get(e);if(s.SectionName.op_Equality(CharacterNameDefines_1.CharacterNameDefines.LOOP_SECTION)){t=!0;break}if(s.SectionName.op_Equality(CharacterNameDefines_1.CharacterNameDefines.DEFAULT_SECTION_NAME)){i=!0;break}}t||i?e?t?this.rj_.Montage_SetNextSection(CharacterNameDefines_1.CharacterNameDefines.LOOP_SECTION,CharacterNameDefines_1.CharacterNameDefines.LOOP_SECTION,this.JV_):i&&this.rj_.Montage_SetNextSection(CharacterNameDefines_1.CharacterNameDefines.DEFAULT_SECTION_NAME,CharacterNameDefines_1.CharacterNameDefines.DEFAULT_SECTION_NAME,this.JV_):t?this.rj_.Montage_SetNextSection(CharacterNameDefines_1.CharacterNameDefines.LOOP_SECTION,CharacterNameDefines_1.CharacterNameDefines.END_SECTION,this.JV_):i&&this.rj_.Montage_SetNextSection(CharacterNameDefines_1.CharacterNameDefines.DEFAULT_SECTION_NAME,CharacterNameDefines_1.CharacterNameDefines.NULL_SECTION,this.JV_):Log_1.Log.CheckError()&&Log_1.Log.Error("BasePerform",26,"[Montage] 蒙太奇片段不合法",["montage",this.JV_.GetName()],["pbDataId",this.sDe.PbDataId])}}oj_(e=!0){const t=this.hJ,i=(this.hJ++,this.j7l!==ResourceSystem_1.ResourceSystem.InvalidId&&ResourceSystem_1.ResourceSystem.CancelAsyncLoad(this.j7l),this.JV_),s=(this.j7l=ResourceSystem_1.ResourceSystem.InvalidId,this.YV_?.Remove(),this.YV_=void 0,this.JV_=void 0,this.ZV_=void 0,this.zV_),h=this.WV_;this.zV_=void 0,this.WV_=void 0,i||(this.ej_?this.tj_.Push(()=>{s?.(void 0)}):s?.(void 0)),this.ej_?this.tj_.Push(()=>{h?.(i,e),EventSystem_1.EventSystem.EmitWithTarget(this.sDe,EventDefine_1.EEventName.PerformMontageStop,t)}):(h?.(i,e),EventSystem_1.EventSystem.EmitWithTarget(this.sDe,EventDefine_1.EEventName.PerformMontageStop,t))}nj_(t){var i=t.SlotAnimTracks,s=i.Num();for(let e=0;e<s;e++)if(!i.Get(e).SlotName.op_Equality(CharacterNameDefines_1.CharacterNameDefines.DEFAULT_SLOT))return Log_1.Log.CheckError()&&Log_1.Log.Error("BasePerform",26,"[Montage] 非DefaultSlot蒙太奇",["montage",t.GetName()],["pbDataId",this.sDe.PbDataId]),!1;return!0}}exports.MontageManager=MontageManager;
//# sourceMappingURL=MontageManager.js.map