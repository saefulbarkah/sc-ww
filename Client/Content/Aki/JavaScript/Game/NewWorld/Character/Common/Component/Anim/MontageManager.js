
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MontageManager=void 0;const UE=require("ue"),Log_1=require("../../../../../../Core/Common/Log"),Queue_1=require("../../../../../../Core/Container/Queue"),ResourceSystem_1=require("../../../../../../Core/Resource/ResourceSystem"),TimerSystem_1=require("../../../../../../Core/Timer/TimerSystem"),ObjectUtils_1=require("../../../../../../Core/Utils/ObjectUtils"),StringUtils_1=require("../../../../../../Core/Utils/StringUtils"),EventDefine_1=require("../../../../../Common/Event/EventDefine"),EventSystem_1=require("../../../../../Common/Event/EventSystem"),ModelManager_1=require("../../../../../Manager/ModelManager"),CharacterNameDefines_1=require("../../CharacterNameDefines"),MONTAGE_BLEND_TIME=.5,LOADING_ID=-2;class MontageManager{constructor(){this.hJ=1,this.oRe=void 0,this.sDe=void 0,this.j7l=ResourceSystem_1.ResourceSystem.InvalidId,this.sj_=void 0,this.aj_=void 0,this.ij_=void 0,this.hj_=void 0,this.lj_=void 0,this._j_=!1,this.cj_=new Queue_1.Queue,this.uj_=(e,t)=>{this.dj_.Montage_IsActive(e)||e===this.hj_&&(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("BasePerform",26,"[Montage] 实体播放蒙太奇结束",["pbDataId",this.sDe.PbDataId],["handle",this.hJ],["bInterrupted",t],["path",this.lj_]),this.dj_.OnMontageEnded.Remove(this.uj_.bind(this)),this.mj_(t))}}get dj_(){return this.oRe.MainAnimInstance}Init(e){this.oRe=e,this.sDe=ModelManager_1.ModelManager.CreatureModel.GetEntityById(e.Entity.Id)}ClearObject(){return this.Clear(),!0}Clear(){this.oRe=void 0,this.sDe=void 0,this.j7l!==ResourceSystem_1.ResourceSystem.InvalidId&&ResourceSystem_1.ResourceSystem.CancelAsyncLoad(this.j7l),this.j7l=ResourceSystem_1.ResourceSystem.InvalidId,this.sj_?.Remove(),this.sj_=void 0,this.hj_=void 0,this.lj_=void 0,this.aj_=void 0,this.ij_=void 0,this.cj_.Clear()}IsMontagePlaying(e){return void 0!==e?this.hJ===e:this.j7l!==ResourceSystem_1.ResourceSystem.InvalidId||ObjectUtils_1.ObjectUtils.IsValid(this.hj_)}PlayMontage(a){if(this._j_)return Log_1.Log.CheckError()&&Log_1.Log.Error("BasePerform",26,"[Montage] 播放蒙太奇嵌套"),-1;this._j_=!0;let r=void 0,o=void 0;!this.hj_||a.MontagePath!==this.lj_&&a.MontageAsset!==this.hj_||(e=this.dj_.Montage_GetCurrentSection(this.hj_),o=this.hj_,a.InSectionToStartMontageAt?e.op_Equality(a.InSectionToStartMontageAt)&&(r=this.dj_.Montage_GetPosition(this.hj_)):e.op_Equality(CharacterNameDefines_1.CharacterNameDefines.END_SECTION)||(r=this.dj_.Montage_GetPosition(this.hj_))),this.StopMontage({Method:0,ImmediatelyCallback:!0});const n=this.hJ;if(a.OnStartCallback?.(n),this.ij_=a.OnEndCallback,this.aj_=a.OnPlayCallback,StringUtils_1.StringUtils.IsEmpty(a.MontagePath)&&!ObjectUtils_1.ObjectUtils.IsValid(a.MontageAsset)){for(Log_1.Log.CheckError()&&Log_1.Log.Error("BasePerform",26,"[Montage] 实体播放蒙太奇路径和资产都为空",["pbDataId",this.sDe.PbDataId]),this.mj_(),this._j_=!1;!this.cj_.Empty;)this.cj_.Pop()?.();return-1}this.lj_=a.MontagePath??UE.KismetSystemLibrary.GetPathName(a.MontageAsset);var e=e=>{if(this.j7l=ResourceSystem_1.ResourceSystem.InvalidId,e&&ObjectUtils_1.ObjectUtils.IsValid(e)&&this.fj_(e)){this.hj_=e;let t=r;if(void 0===t&&a.InSectionToStartMontageAt){var i=e.CompositeSections,s=i.Num();for(let e=0;e<s;e++){var h=i.Get(e);if(h.SectionName.op_Equality(a.InSectionToStartMontageAt)){t=h.SegmentBeginTime;break}}void 0===t&&Log_1.Log.CheckDebug()&&Log_1.Log.Debug("BasePerform",26,"[Montage] PlayMontage找不到片段",["montage",e.GetName()],["section",a.InSectionToStartMontageAt])}this.dj_.Montage_Play(this.hj_,void 0,void 0,t,!a.KeepOtherMontage),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("BasePerform",26,"[Montage] 实体播放蒙太奇",["pbDataId",this.sDe.PbDataId],["handle",n],["startTime",t],["isLoop",a.IsLoop],["path",this.lj_]),this.gj_(a.Duration),this.Cj_(a.IsLoop),o||this.dj_.OnMontageEnded.Add(this.uj_.bind(this)),this.aj_?.(this.hj_)}else this.mj_()};for(a.MontageAsset||o?e(a.MontageAsset??o):(this.j7l=LOADING_ID,e=ResourceSystem_1.ResourceSystem.LoadAsync(a.MontagePath,UE.AnimMontage,e),this.j7l===LOADING_ID&&(this.j7l=e)),this._j_=!1;!this.cj_.Empty;)this.cj_.Pop()?.();return n===this.hJ?n:-1}StopMontage(e){if((void 0===e.HandleId||this.hJ===e.HandleId)&&this.lj_){if(e.Montage){if(this.hj_!==e.Montage)return;if(UE.KismetSystemLibrary.GetPathName(e.Montage)!==this.lj_)return}var t=e.Delay??0;if(t>TimerSystem_1.MIN_TIME&&t<TimerSystem_1.MAX_TIME)this.gj_(t,e.Method,t);else if(this.j7l!==ResourceSystem_1.ResourceSystem.InvalidId)this.mj_();else{Log_1.Log.CheckDebug()&&Log_1.Log.Debug("BasePerform",26,"[Montage] 实体停止蒙太奇",["id",this.sDe.PbDataId],["handle",this.hJ],["method",e.Method],["path",this.lj_]);var s=this.hj_.CompositeSections,h=s.Num();let t=!1,i=!1;for(let e=0;e<h;e++){var a=s.Get(e);!i&&a.SectionName.op_Equality(CharacterNameDefines_1.CharacterNameDefines.DEFAULT_SECTION_NAME)&&(i=!0),!t&&a.SectionName.op_Equality(CharacterNameDefines_1.CharacterNameDefines.END_SECTION)&&(t=!0)}var r,o=e.BlendOutTime??MONTAGE_BLEND_TIME;switch(e.Method??0){case 0:this.dj_.Montage_Stop(o,this.hj_);break;case 1:t?(this.dj_.Montage_SetNextSection(CharacterNameDefines_1.CharacterNameDefines.START_SECTION,CharacterNameDefines_1.CharacterNameDefines.END_SECTION,this.hj_),this.dj_.Montage_SetNextSection(CharacterNameDefines_1.CharacterNameDefines.LOOP_SECTION,CharacterNameDefines_1.CharacterNameDefines.END_SECTION,this.hj_)):i?this.dj_.Montage_SetNextSection(CharacterNameDefines_1.CharacterNameDefines.DEFAULT_SECTION_NAME,CharacterNameDefines_1.CharacterNameDefines.NULL_SECTION,this.hj_):(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("BasePerform",26,"[Montage] 蒙太奇既没有Default也没有End片段，直接混出",["pbDataId",this.sDe.PbDataId],["path",this.lj_]),this.dj_.Montage_Stop(o,this.hj_));break;case 4:t?this.dj_.Montage_SetNextSection(CharacterNameDefines_1.CharacterNameDefines.LOOP_SECTION,CharacterNameDefines_1.CharacterNameDefines.END_SECTION,this.hj_):(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("BasePerform",26,"[Montage] 蒙太奇没有End片段，直接混出",["pbDataId",this.sDe.PbDataId],["path",this.lj_]),this.dj_.Montage_Stop(o,this.hj_));break;case 2:t?this.dj_.Montage_JumpToSection(CharacterNameDefines_1.CharacterNameDefines.END_SECTION,this.hj_):(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("BasePerform",26,"[Montage] 蒙太奇没有End片段，直接混出",["pbDataId",this.sDe.PbDataId],["path",this.lj_]),this.dj_.Montage_Stop(o,this.hj_));break;case 3:t?(r=this.dj_.Montage_GetPosition(this.hj_),o<(r=this.hj_.SequenceLength-r)&&this.dj_.Montage_SetPlayRate(this.hj_,r/o),this.oRe.MainAnimInstance.Montage_SetNextSection(CharacterNameDefines_1.CharacterNameDefines.LOOP_SECTION,CharacterNameDefines_1.CharacterNameDefines.END_SECTION,this.hj_)):(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("BasePerform",26,"[Montage] 蒙太奇没有End片段，直接混出",["pbDataId",this.sDe.PbDataId],["path",this.lj_]),this.dj_.Montage_Stop(o,this.hj_))}e.ImmediatelyCallback&&this.mj_()}}}ClearCallback(e){void 0!==e&&this.hJ!==e||(this.aj_=void 0,this.ij_=void 0)}gj_(e=0,t=2,i){this.sj_?.Remove(),this.sj_=void 0,e>TimerSystem_1.MIN_TIME&&e<TimerSystem_1.MAX_TIME&&(this.sj_=TimerSystem_1.TimerSystem.Delay(()=>{this.sj_=void 0,this.StopMontage({Method:t,BlendOutTime:i})},e))}Cj_(e){if(void 0!==e){let t=!1,i=!1;for(let e=0;e<this.hj_.CompositeSections.Num();e++){var s=this.hj_.CompositeSections.Get(e);if(s.SectionName.op_Equality(CharacterNameDefines_1.CharacterNameDefines.LOOP_SECTION)){t=!0;break}if(s.SectionName.op_Equality(CharacterNameDefines_1.CharacterNameDefines.DEFAULT_SECTION_NAME)){i=!0;break}}t||i?e?t?this.dj_.Montage_SetNextSection(CharacterNameDefines_1.CharacterNameDefines.LOOP_SECTION,CharacterNameDefines_1.CharacterNameDefines.LOOP_SECTION,this.hj_):i&&this.dj_.Montage_SetNextSection(CharacterNameDefines_1.CharacterNameDefines.DEFAULT_SECTION_NAME,CharacterNameDefines_1.CharacterNameDefines.DEFAULT_SECTION_NAME,this.hj_):t?this.dj_.Montage_SetNextSection(CharacterNameDefines_1.CharacterNameDefines.LOOP_SECTION,CharacterNameDefines_1.CharacterNameDefines.END_SECTION,this.hj_):i&&this.dj_.Montage_SetNextSection(CharacterNameDefines_1.CharacterNameDefines.DEFAULT_SECTION_NAME,CharacterNameDefines_1.CharacterNameDefines.NULL_SECTION,this.hj_):Log_1.Log.CheckError()&&Log_1.Log.Error("BasePerform",26,"[Montage] 蒙太奇片段不合法",["montage",this.hj_.GetName()],["pbDataId",this.sDe.PbDataId])}}mj_(e=!0){const t=this.hJ,i=(this.hJ++,this.j7l!==ResourceSystem_1.ResourceSystem.InvalidId&&ResourceSystem_1.ResourceSystem.CancelAsyncLoad(this.j7l),this.hj_),s=(this.j7l=ResourceSystem_1.ResourceSystem.InvalidId,this.sj_?.Remove(),this.sj_=void 0,this.hj_=void 0,this.lj_=void 0,this.aj_),h=this.ij_;this.aj_=void 0,this.ij_=void 0,i||(this._j_?this.cj_.Push(()=>{s?.(void 0)}):s?.(void 0)),this._j_?this.cj_.Push(()=>{h?.(i,e),EventSystem_1.EventSystem.EmitWithTarget(this.sDe,EventDefine_1.EEventName.PerformMontageStop,t)}):(h?.(i,e),EventSystem_1.EventSystem.EmitWithTarget(this.sDe,EventDefine_1.EEventName.PerformMontageStop,t))}fj_(t){var i=t.SlotAnimTracks,s=i.Num();for(let e=0;e<s;e++)if(!i.Get(e).SlotName.op_Equality(CharacterNameDefines_1.CharacterNameDefines.DEFAULT_SLOT))return Log_1.Log.CheckError()&&Log_1.Log.Error("BasePerform",26,"[Montage] 非DefaultSlot蒙太奇",["montage",t.GetName()],["pbDataId",this.sDe.PbDataId]),!1;return!0}}exports.MontageManager=MontageManager;
//# sourceMappingURL=MontageManager.js.map