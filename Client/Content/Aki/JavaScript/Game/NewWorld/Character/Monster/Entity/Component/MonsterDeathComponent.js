
"use strict";var __decorate=this&&this.__decorate||function(e,t,i,s){var n,r=arguments.length,o=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,s);else for(var h=e.length-1;0<=h;h--)(n=e[h])&&(o=(r<3?n(o):3<r?n(t,i,o):n(t,i))||o);return 3<r&&o&&Object.defineProperty(t,i,o),o};Object.defineProperty(exports,"__esModule",{value:!0}),exports.MonsterDeathComponent=void 0;const UE=require("ue"),Protocol_1=require("../../../../../../Core/Define/Net/Protocol"),RegisterComponent_1=require("../../../../../../Core/Entity/RegisterComponent"),TimerSystem_1=require("../../../../../../Core/Timer/TimerSystem"),EventDefine_1=require("../../../../../Common/Event/EventDefine"),EventSystem_1=require("../../../../../Common/Event/EventSystem"),ControllerHolder_1=require("../../../../../Manager/ControllerHolder"),ModelManager_1=require("../../../../../Manager/ModelManager"),BaseDeathComponent_1=require("../../../Common/Component/Abilities/BaseDeathComponent"),CharacterUnifiedStateTypes_1=require("../../../Common/Component/Abilities/CharacterUnifiedStateTypes"),DIE_IN_AIE_REMOVE_DELAY=5e3;let MonsterDeathComponent=class MonsterDeathComponent extends BaseDeathComponent_1.BaseDeathComponent{constructor(){super(...arguments),this.Xte=void 0,this.sDe=void 0,this.s7r=void 0,this.DelayDestroyCallback=(e,t)=>{t||this.PlayDeathAnimation()},this.DeathTagTask=void 0,this.DeathTimerTask=void 0,this.OnDeathEnded=()=>{this.ClearDeathTasks(),this.Xte?.Valid&&(this.Xte.AddTag(1963731483),this.Xte.AddTag(-208062360)),this.Entity.Disable("[DeathComponent.SetActive] 死亡隐藏"),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.DropItemStarted,this.Entity?.Id),ControllerHolder_1.ControllerHolder.CreatureController.DelayRemoveEntityFinished(this.Entity)},this.zpe=()=>{this.IsDeadInternal||this.ncl()}}OnInitData(){return this.Xte=this.Entity.CheckGetComponent(191),!0}OnStart(){this.Entity.CheckGetComponent(0)?.GetLivingStatus()===Protocol_1.Aki.Protocol.JEs.Proto_Dead&&this.ExecuteDeath();var e,t=this.Entity.GetComponent(1)?.Owner;return t?.IsValid()&&(t=t.GetComponentByClass(UE.KuroRegionDetectComponent.StaticClass()),e=ModelManager_1.ModelManager.CreatureModel.GetEntityById(this.Entity.Id),t)&&e&&(this.sDe=e,EventSystem_1.EventSystem.AddWithTarget(e,EventDefine_1.EEventName.RemoveEntity,this.zpe)),!0}OnClear(){return this.ClearDeathTasks(),this.sDe&&(EventSystem_1.EventSystem.HasWithTarget(this.sDe,EventDefine_1.EEventName.RemoveEntity,this.zpe)&&EventSystem_1.EventSystem.RemoveWithTarget(this.sDe,EventDefine_1.EEventName.RemoveEntity,this.zpe),this.sDe=void 0),!0}ExecuteDeath(){return!!super.ExecuteDeath()&&(this.Entity.GetComponent(160)?.RemoveBuffByEffectType(36,"实体死亡移除冰冻buff"),this.Xte.AddTag(1008164187),this.Xte?.HasTag(-1615707547)?this.s7r=this.Xte.ListenForTagAddOrRemove(-1615707547,this.DelayDestroyCallback):(this.Entity.GetComponent(34)?.StopAllSkills("MonsterDeathComponent.ExecuteDeath"),this.Entity.GetComponent(92)?.ResetCharState(),this.Entity.GetComponent(160)?.RemoveAllDurationBuffs("实体死亡清理持续型buff"),this.PlayDeathAnimation()),this.ncl(),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.CharOnRoleDead,this.Entity.Id),EventSystem_1.EventSystem.EmitWithTarget(this.Entity,EventDefine_1.EEventName.CharOnRoleDeadTargetSelf),!0)}PlayDeathAnimation(){const i=this.Entity.CheckGetComponent(22);if(!ModelManager_1.ModelManager.DeadReviveModel.SkipDeathAnim&&!this.Xte?.HasTag(-1943786195)&&i?.Valid&&this.Entity.IsInit&&this.Entity.Active){var e=this.Entity.GetComponent(92)?.PositionState;if(e===CharacterUnifiedStateTypes_1.ECharPositionState.Water)i.PlayMontageWithCallBack(1,this.OnDeathEnded);else{if(e===CharacterUnifiedStateTypes_1.ECharPositionState.Air){if(this.Xte?.HasTag(31862857))return this.DeathTagTask=this.Xte.ListenForTagAddOrRemove(31862857,(e,t)=>{t||(i.HasMontage(3)?i.PlayMontageWithCallBack(3,this.OnDeathEnded):this.OnDeathEnded())}),void(this.DeathTimerTask=TimerSystem_1.TimerSystem.Delay(this.OnDeathEnded,DIE_IN_AIE_REMOVE_DELAY));if(i.HasMontage(2))return void i.PlayMontageWithCallBack(2,this.OnDeathEnded)}else if(e===CharacterUnifiedStateTypes_1.ECharPositionState.Ground&&i.HasMontage(0))return void i.PlayMontageWithCallBack(0,this.OnDeathEnded);this.OnDeathEnded()}}else this.OnDeathEnded()}ClearDeathTasks(){this.s7r?.EndTask(),this.s7r=void 0,this.DeathTagTask?.EndTask(),this.DeathTagTask=void 0,this.DeathTimerTask?.Remove(),this.DeathTimerTask=void 0}ncl(){var e=this.Entity.GetComponent(1)?.Owner;e?.IsValid()&&(e=e.GetComponentByClass(UE.KuroRegionDetectComponent.StaticClass()))&&e.ResetEventTargets()}};MonsterDeathComponent=__decorate([(0,RegisterComponent_1.RegisterComponent)(169)],MonsterDeathComponent),exports.MonsterDeathComponent=MonsterDeathComponent;
//# sourceMappingURL=MonsterDeathComponent.js.map