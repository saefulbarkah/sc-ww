
"use strict";var __decorate=this&&this.__decorate||function(t,e,i,s){var o,r=arguments.length,h=r<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)h=Reflect.decorate(t,e,i,s);else for(var n=t.length-1;0<=n;n--)(o=t[n])&&(h=(r<3?o(h):3<r?o(e,i,h):o(e,i))||h);return 3<r&&h&&Object.defineProperty(e,i,h),h};Object.defineProperty(exports,"__esModule",{value:!0}),exports.FollowShooterComponent=void 0;const UE=require("ue"),CustomPromise_1=require("../../../../../Core/Common/CustomPromise"),EntityComponent_1=require("../../../../../Core/Entity/EntityComponent"),RegisterComponent_1=require("../../../../../Core/Entity/RegisterComponent"),ResourceSystem_1=require("../../../../../Core/Resource/ResourceSystem"),TimerSystem_1=require("../../../../../Core/Timer/TimerSystem"),IComponent_1=require("../../../../../UniverseEditor/Interface/IComponent"),EventDefine_1=require("../../../../Common/Event/EventDefine"),EventSystem_1=require("../../../../Common/Event/EventSystem"),TimeUtil_1=require("../../../../Common/TimeUtil"),InputController_1=require("../../../../Input/InputController"),ControllerHolder_1=require("../../../../Manager/ControllerHolder"),ModelManager_1=require("../../../../Manager/ModelManager"),LockOnController_1=require("../../../../Module/LockOn/LockOnController"),LogReportController_1=require("../../../../Module/LogReport/LogReportController"),LogReportDefine_1=require("../../../../Module/LogReport/LogReportDefine"),DELAY_DISAPPEAR_MAX_TIME=5e3,lockOnTargetTag=199201016;let FollowShooterComponent=class FollowShooterComponent extends EntityComponent_1.EntityComponent{constructor(){super(...arguments),this.tRr=void 0,this.Xte=void 0,this.n$t=void 0,this.IsEnable=!1,this.j8=0,this.beh=!1,this.IsAutonomousProxy=!1,this.Bhh=void 0,this.Pia=!1,this.u4l=new Array,this.wia=new Array,this.Bia=new Array,this.bia=new Array,this.$Ia=!1,this.YIa=!1,this.FBa=0,this.VBa=void 0,this.AimType=0,this.LoadConfigPromise=void 0,this.xie=()=>{this.Gia(),this._rl(),this.kUa()},this.kUa=()=>{this.NUa()?this.Pia&&this.SetEnable(!0):this.SetEnable(!1)},this.HFt=0,this.io_=void 0,this.n$_=void 0,this.LockOnTarget=void 0,this.Fx_=!1}OnInitData(t){var e=this.Entity.GetComponent(0);return this.j8=e?.GetPlayerId()??0,this.IsAutonomousProxy=this.j8===ModelManager_1.ModelManager.CreatureModel.GetPlayerId(),this.IsAutonomousProxy&&(e=e?.GetPbEntityInitData())?.ComponentsData&&(e=(0,IComponent_1.getComponent)(e.ComponentsData,"FollowShooterComponent"))&&(this.n$_=e.LockableCategories,this.Bhh=InputController_1.InputController.CreateInputLayer(3),this.LoadConfigPromise=new CustomPromise_1.CustomPromise,ResourceSystem_1.ResourceSystem.LoadAsync(e.Config,UE.BP_FollowShooterConfig_C,t=>{if(t?.IsValid){this.io_=t,this.Pia=t.AutoEnable,this.$Ia=t.NeedUploadData,this.FBa=t.DelayDisappearMillisecond,this.AimType=t.AimType;var e=t.NeedInputActions;for(let t=0;t<e.Num();t++){var i=e.Get(t),s=i.State;this.Bhh?.RegisterInputAction([i.Action,s])}var o=t.AddTagsWhenEnable;for(let t=0;t<o.Num();t++){var r=o.Get(t);this.wia.push(r.TagId)}var h=t.AddTagsToPlayerWhenPossess;for(let t=0;t<h.Num();t++){var n=h.Get(t);this.u4l.push(n.TagId)}var l=t.DisableWhenCurrentRoleHasTags;for(let t=0;t<l.Num();t++){var a=l.Get(t);this.Bia.push(a.TagId)}this.LoadConfigPromise?.SetResult(),this.LoadConfigPromise=void 0}})),!0}OnStart(){var t=this.Entity.GetComponent(0).GetCreatureDataId();return ControllerHolder_1.ControllerHolder.FormationDataController.GetPlayerEntity(this.j8)?.GetComponent(218)?.OnFollowerAdd(t),this.IsAutonomousProxy&&(this.tRr=this.Entity.GetComponent(39),this.Xte=this.Entity.GetComponent(200),this.n$t=this.Entity.GetComponent(1),this.Bhh?.Start(this)),!0}OnEnd(){return this.SetEnable(!1),this.UnPossess(),this.FBa=0,this.VBa?.Remove(),this.VBa=void 0,this.AimType=0,this.u4l.length=0,this.wia.length=0,this.Pia=!1,this.j8=0,this.IsAutonomousProxy=!1,this.beh=!1,this.LoadConfigPromise?.SetResult(),this.LoadConfigPromise=void 0,this.Bhh&&(InputController_1.InputController.RemoveInputLayer(this.Bhh),this.Bhh.Clear(),this.Bhh=void 0),!0}OnTick(t){this.Pxl(t)}Possess(){if(this.IsAutonomousProxy&&!this.beh){this.beh=!0;for(const t of this.u4l)ControllerHolder_1.ControllerHolder.FormationDataController.AddPlayerTag(this.j8,t);this.Gia(),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnChangeRole,this.xie),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.ChangeMode,this.kUa),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnUpdateTeamGroupType,this.kUa),this.Pia&&this.SetEnable(!0)}}UnPossess(){if(this.IsAutonomousProxy&&this.beh){this.beh=!1;for(const t of this.u4l)ControllerHolder_1.ControllerHolder.FormationDataController.RemovePlayerTag(this.j8,t);this.SetEnable(!1),this.Wia(),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnChangeRole,this.xie),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.ChangeMode,this.kUa),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnUpdateTeamGroupType,this.kUa)}}SetEnable(t){if(this.IsAutonomousProxy&&this.IsEnable!==t)if(t){if(this.NUa()){this.VBa?.Remove(),this.VBa=void 0,this.IsEnable=!0,this.HFt=0,ControllerHolder_1.ControllerHolder.CreatureController.SetEntityEnable(this.Entity,!0,"Follower Enable",!0),this._rl();for(const e of this.wia)this.Xte?.AddTag(e),ControllerHolder_1.ControllerHolder.FormationDataController.AddPlayerTag(this.j8,e);EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnPlayerFollowerEnableChange,!0)}}else{this.Bhh&&InputController_1.InputController.RemoveInputLayer(this.Bhh);for(const i of this.wia)this.Xte?.RemoveTag(i),ControllerHolder_1.ControllerHolder.FormationDataController.RemovePlayerTag(this.j8,i);this.JIa(),this.IsEnable=!1,this.YIa=!1,EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnPlayerFollowerEnableChange,!1),this.Fx_&&(this.Xte?.RemoveTag(lockOnTargetTag),this.Fx_=!1),0<this.FBa&&this.FBa<=DELAY_DISAPPEAR_MAX_TIME?this.VBa||(this.VBa=TimerSystem_1.TimerSystem.Delay(()=>{this.VBa=void 0,ControllerHolder_1.ControllerHolder.CreatureController.SetEntityEnable(this.Entity,!1,"Follower Disable",!0)},this.FBa)):ControllerHolder_1.ControllerHolder.CreatureController.SetEntityEnable(this.Entity,!1,"Follower Disable",!0)}}NUa(){var t;return 1===ModelManager_1.ModelManager.SceneTeamModel.CurrentGroupType&&!(!(t=(ModelManager_1.ModelManager.SceneTeamModel.GetCurrentEntity?.Entity)?.GetComponent(200))||t.HasAnyTag(this.Bia))}Gia(){this.Wia();var t=(ModelManager_1.ModelManager.SceneTeamModel?.GetTeamItem(this.j8,{ParamType:2,IsControl:!0})?.EntityHandle?.Entity)?.GetComponent(200);if(t)for(const i of this.Bia){var e=t?.ListenForTagAddOrRemove(i,this.kUa);e&&this.bia.push(e)}}Wia(){for(const t of this.bia)t.EndTask();this.bia.length=0}_rl(){var t;this.IsEnable&&this.Bhh&&(InputController_1.InputController.RemoveInputLayer(this.Bhh),(t=ModelManager_1.ModelManager.SceneTeamModel.GetCurrentEntity)?.Valid)&&InputController_1.InputController.AddInputLayer(t.Id,this.Bhh)}ExecuteCommand(t){t&&1===t.CommandType&&(t=t.IntValue,this.tRr.BeginSkill(t,{Context:"Follower Begin Skill",Target:this.LockOnTarget?.Entity}),this.YIa=!0)}JIa(){if(this.$Ia){var e=new LogReportDefine_1.FollowShooterUseLogData;let t=ModelManager_1.ModelManager.SceneTeamModel.GetCurrentEntity?.Entity?.GetComponent(1)?.ActorLocationProxy;(t=t||this.n$t?.ActorLocationProxy)&&(e.i_area_id=ModelManager_1.ModelManager.AreaModel.AreaInfo.AreaId,e.i_father_area_id=ModelManager_1.ModelManager.AreaModel.AreaInfo.Father,e.f_pos_x=t.X,e.f_pos_y=t.Y,e.f_pos_z=t.Z,e.i_has_target=this.YIa?1:0,LogReportController_1.LogReportController.UnitLogReport(e))}}Pxl(t){!this.io_?.LockOnConfig.Enable||this.io_.LockOnConfig.GapTime<=0||(0===this.HFt&&(this.LockOnTarget=LockOnController_1.LockOnController.LockOnCircle(this.n$t.Owner,this.io_.LockOnConfig.Distance,this.io_.LockOnConfig.Radius,this.n$_),this.IsEnable)&&(this.LockOnTarget&&!this.Fx_?(this.Xte?.AddTag(lockOnTargetTag),this.Fx_=!0):!this.LockOnTarget&&this.Fx_&&(this.Xte?.RemoveTag(lockOnTargetTag),this.Fx_=!1)),this.HFt+=t,this.HFt>this.io_.LockOnConfig.GapTime*TimeUtil_1.TimeUtil.InverseMillisecond&&(this.HFt=0))}};FollowShooterComponent=__decorate([(0,RegisterComponent_1.RegisterComponent)(216)],FollowShooterComponent),exports.FollowShooterComponent=FollowShooterComponent;
//# sourceMappingURL=FollowShooterComponent.js.map