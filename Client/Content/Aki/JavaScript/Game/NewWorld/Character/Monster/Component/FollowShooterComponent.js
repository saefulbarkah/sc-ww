
"use strict";var __decorate=this&&this.__decorate||function(t,e,i,o){var s,r=arguments.length,n=r<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,i,o);else for(var h=t.length-1;0<=h;h--)(s=t[h])&&(n=(r<3?s(n):3<r?s(e,i,n):s(e,i))||n);return 3<r&&n&&Object.defineProperty(e,i,n),n};Object.defineProperty(exports,"__esModule",{value:!0}),exports.FollowShooterComponent=void 0;const UE=require("ue"),EntityComponent_1=require("../../../../../Core/Entity/EntityComponent"),RegisterComponent_1=require("../../../../../Core/Entity/RegisterComponent"),ResourceSystem_1=require("../../../../../Core/Resource/ResourceSystem"),TimerSystem_1=require("../../../../../Core/Timer/TimerSystem"),IComponent_1=require("../../../../../UniverseEditor/Interface/IComponent"),EventDefine_1=require("../../../../Common/Event/EventDefine"),EventSystem_1=require("../../../../Common/Event/EventSystem"),InputController_1=require("../../../../Input/InputController"),ControllerHolder_1=require("../../../../Manager/ControllerHolder"),ModelManager_1=require("../../../../Manager/ModelManager"),LogReportController_1=require("../../../../Module/LogReport/LogReportController"),LogReportDefine_1=require("../../../../Module/LogReport/LogReportDefine"),DELAY_DISAPPEAR_MAX_TIME=5e3;let FollowShooterComponent=class FollowShooterComponent extends EntityComponent_1.EntityComponent{constructor(){super(...arguments),this.tRr=void 0,this.Xte=void 0,this.IsEnable=!1,this.j8=0,this.aeh=!1,this.IsAutonomousProxy=!1,this.nah=void 0,this.Pia=!1,this.wia=new Array,this.Bia=new Array,this.bia=new Array,this.$Ia=!1,this.YIa=!1,this.FBa=0,this.VBa=void 0,this.xie=()=>{this.Gia(),this.utl(),this.kUa()},this.kUa=()=>{this.NUa()?this.Pia&&this.SetEnable(!0):this.SetEnable(!1)}}OnInitData(t){var e=this.Entity.GetComponent(0);return this.j8=e?.GetPlayerId()??0,this.IsAutonomousProxy=this.j8===ModelManager_1.ModelManager.CreatureModel.GetPlayerId(),this.IsAutonomousProxy&&(e=e?.GetPbEntityInitData())?.ComponentsData&&(e=(0,IComponent_1.getComponent)(e.ComponentsData,"FollowShooterComponent"))&&(this.nah=InputController_1.InputController.CreateInputLayer(3),ResourceSystem_1.ResourceSystem.LoadAsync(e.Config,UE.BP_FollowShooterConfig_C,t=>{if(t?.IsValid){this.Pia=t.AutoEnable,this.$Ia=t.NeedUploadData,this.FBa=t.DelayDisappearMillisecond;var e=t.NeedInputActions;for(let t=0;t<e.Num();t++){var i=e.Get(t),o=i.State;this.nah?.RegisterInputAction([i.Action,o])}var s=t.AddTagsWhenEnable;for(let t=0;t<s.Num();t++){var r=s.Get(t);this.wia.push(r.TagId)}var n=t.DisableWhenCurrentRoleHasTags;for(let t=0;t<n.Num();t++){var h=n.Get(t);this.Bia.push(h.TagId)}this.aeh&&(this.Gia(),this.Entity.IsInit)&&(this.Active||this.Pia)&&this.SetEnable(!0)}})),!0}OnStart(){var t=this.Entity.GetComponent(0).GetCreatureDataId();return ControllerHolder_1.ControllerHolder.FormationDataController.GetPlayerEntity(this.j8)?.GetComponent(208)?.OnFollowerAdd(t),this.IsAutonomousProxy&&(this.tRr=this.Entity.GetComponent(34),this.Xte=this.Entity.GetComponent(191),this.nah?.Start(this)),!0}OnEnd(){return this.SetEnable(!1),this.FBa=0,this.VBa?.Remove(),this.VBa=void 0,this.wia.length=0,this.Pia=!1,this.j8=0,this.IsAutonomousProxy=!1,this.aeh=!1,this.nah&&(InputController_1.InputController.RemoveInputLayer(this.nah),this.nah.Clear(),this.nah=void 0),!0}Possess(){this.IsAutonomousProxy&&!this.aeh&&(this.aeh=!0,this.Gia(),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnChangeRole,this.xie),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.ChangeMode,this.kUa),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnUpdateTeamGroupType,this.kUa),this.Pia)&&this.SetEnable(!0)}UnPossess(){this.IsAutonomousProxy&&this.aeh&&(this.aeh=!1,this.SetEnable(!1),this.Wia(),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnChangeRole,this.xie),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.ChangeMode,this.kUa),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnUpdateTeamGroupType,this.kUa))}SetEnable(t){if(this.IsAutonomousProxy&&this.IsEnable!==t)if(t){if(this.NUa()){this.VBa?.Remove(),this.VBa=void 0,this.IsEnable=!0,ControllerHolder_1.ControllerHolder.CreatureController.SetEntityEnable(this.Entity,!0,"Follower Enable",!0),this.utl();for(const e of this.wia)this.Xte?.AddTag(e),ControllerHolder_1.ControllerHolder.FormationDataController.AddPlayerTag(this.j8,e);EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnPlayerFollowerEnableChange,!0)}}else{this.nah&&InputController_1.InputController.RemoveInputLayer(this.nah);for(const i of this.wia)this.Xte?.RemoveTag(i),ControllerHolder_1.ControllerHolder.FormationDataController.RemovePlayerTag(this.j8,i);this.JIa(),this.IsEnable=!1,this.YIa=!1,EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnPlayerFollowerEnableChange,!1),0<this.FBa&&this.FBa<=DELAY_DISAPPEAR_MAX_TIME?this.VBa||(this.VBa=TimerSystem_1.TimerSystem.Delay(()=>{this.VBa=void 0,ControllerHolder_1.ControllerHolder.CreatureController.SetEntityEnable(this.Entity,!1,"Follower Disable",!0)},this.FBa)):ControllerHolder_1.ControllerHolder.CreatureController.SetEntityEnable(this.Entity,!1,"Follower Disable",!0)}}NUa(){var t;return 1===ModelManager_1.ModelManager.SceneTeamModel.CurrentGroupType&&!(!(t=(ModelManager_1.ModelManager.SceneTeamModel.GetCurrentEntity?.Entity)?.GetComponent(191))||t.HasAnyTag(this.Bia))}Gia(){this.Wia();var t=(ModelManager_1.ModelManager.SceneTeamModel?.GetTeamItem(this.j8,{ParamType:2,IsControl:!0})?.EntityHandle?.Entity)?.GetComponent(191);if(t)for(const i of this.Bia){var e=t?.ListenForTagAddOrRemove(i,this.kUa);e&&this.bia.push(e)}}Wia(){for(const t of this.bia)t.EndTask();this.bia.length=0}utl(){var t;this.IsEnable&&this.nah&&(InputController_1.InputController.RemoveInputLayer(this.nah),(t=ModelManager_1.ModelManager.SceneTeamModel.GetCurrentEntity)?.Valid)&&InputController_1.InputController.AddInputLayer(t.Id,this.nah)}ExecuteCommand(t){t&&1===t.CommandType&&(t=t.IntValue,this.tRr.BeginSkill(t,{Context:"Follower Begin Skill"}),this.YIa=!0)}JIa(){if(this.$Ia){var e=new LogReportDefine_1.FollowShooterUseLogData;let t=ModelManager_1.ModelManager.SceneTeamModel.GetCurrentEntity?.Entity?.GetComponent(1)?.ActorLocationProxy;(t=t||this.Entity.GetComponent(1)?.ActorLocationProxy)&&(e.i_area_id=ModelManager_1.ModelManager.AreaModel.AreaInfo.AreaId,e.i_father_area_id=ModelManager_1.ModelManager.AreaModel.AreaInfo.Father,e.f_pos_x=t.X,e.f_pos_y=t.Y,e.f_pos_z=t.Z,e.i_has_target=this.YIa?1:0,LogReportController_1.LogReportController.UnitLogReport(e))}}};FollowShooterComponent=__decorate([(0,RegisterComponent_1.RegisterComponent)(206)],FollowShooterComponent),exports.FollowShooterComponent=FollowShooterComponent;
//# sourceMappingURL=FollowShooterComponent.js.map