
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PerformGroupController=exports.PerformGroup=exports.PerformActionPlayMontage=exports.PerformActionChangeMaterial=exports.PerformAction=void 0;const Log_1=require("../../../../../Core/Common/Log"),ICommon_1=require("../../../../../UniverseEditor/Interface/ICommon"),IComponent_1=require("../../../../../UniverseEditor/Interface/IComponent");class PerformAction{constructor(){this.Uid=++PerformAction.MIe,this.Type=0,this.IsRegister=!1}Register(o){}UnRegister(){}Begin(){}Tick(o){}End(){}}(exports.PerformAction=PerformAction).MIe=0;class PerformActionChangeMaterial extends PerformAction{constructor(){super(...arguments),this.Type=2,this.DaPath="",this.NpcMatController=void 0}Register(o){this.IsRegister=!0;o=o.GetComponent(172);this.NpcMatController=o.MaterialController}UnRegister(){this.IsRegister=!1,this.NpcMatController=void 0}Begin(){this.IsRegister?""===this.DaPath?Log_1.Log.CheckError()&&Log_1.Log.Error("NPC",51,"[PerformAction]DaPath路径为空",["ActionId",this.Uid],["Type",this.Type]):this.NpcMatController.ApplySimpleMaterialEffect(this.DaPath):Log_1.Log.CheckError()&&Log_1.Log.Error("NPC",51,"[PerformAction]表现组行为没有注册",["ActionId",this.Uid],["Type",this.Type])}End(){this.IsRegister&&""!==this.DaPath&&this.NpcMatController.RemoveSimpleMaterialEffect()}}exports.PerformActionChangeMaterial=PerformActionChangeMaterial;class PerformActionPlayMontage extends PerformAction{constructor(){super(...arguments),this.Type=1}}exports.PerformActionPlayMontage=PerformActionPlayMontage;class PerformGroup{constructor(){this.Id=PerformGroup.Yla++,this.SwitchKey="None",this.ActionList=new Array}Register(o){for(const t of this.ActionList)t.Register(o)}UnRegister(){for(const o of this.ActionList)o.UnRegister()}Start(){for(const o of this.ActionList)Log_1.Log.CheckInfo()&&Log_1.Log.Info("NPC",51,"[PerformGroup]执行表现组行为",["GroupId",this.Id],["ActionType",o.Type],["ActionId",o.Uid]),o.Begin()}Tick(o){for(const t of this.ActionList)t.Tick(o)}Stop(){for(const o of this.ActionList)o.End()}}(exports.PerformGroup=PerformGroup).Yla=0;class PerformGroupController{constructor(){this.Entity=void 0,this.PerformStateMap=new Map,this.PerformGroupMap=new Map,this.CurrentRunningGroupMap=new Map}Init(t){this.Entity=t;var t=this.Entity.GetComponent(0),r=t.GetPbEntityInitData();if(r?.ComponentsData){var e,r=(0,IComponent_1.getComponent)(r.ComponentsData,"NpcPerformComponent")?.NpcPerformState;if(r){for(const n of r.Configs){var s=new PerformGroup,i=(s.SwitchKey=n.State,new PerformActionChangeMaterial);i.DaPath=n.MaterialDa??"",s.ActionList.push(i),this.AddPerformGroup(s)}for(const h of ICommon_1.npcPerformStateConfig[r.InitState.Type])this.PerformStateMap.has(h)||(e=new PerformGroup,this.AddPerformGroup(e));let o=t.ComponentDataMap.get("cla")?.cla?.Y4n;o=o||r.InitState.State,this.SwitchPerformState(o)}}}Tick(o){for(const t of this.CurrentRunningGroupMap.values())t.Tick(o)}AddPerformGroup(o){return!this.PerformStateMap.has(o.SwitchKey)&&(o.Register(this.Entity),this.PerformGroupMap.set(o.Id,o),this.PerformStateMap.set(o.SwitchKey,!1),!0)}RemovePerformGroup(o){return o.UnRegister(),this.PerformGroupMap.delete(o.Id),this.PerformStateMap.delete(o.SwitchKey),!0}SwitchPerformState(o){if(!this.PerformStateMap.get(o)){for(const t of this.PerformStateMap.keys())this.UpdatePerformState(t,!1);this.UpdatePerformState(o,!0)}}IsPerformStateEnabled(o){return!!this.PerformStateMap.get(o)}UpdatePerformState(o,t){var r=this.PerformStateMap.get(o);void 0!==r&&r!==t&&(this.PerformStateMap.set(o,t),this.UpdatePerformGroup())}UpdatePerformGroup(){for(const o of this.PerformGroupMap.values())this.CheckCondition(o)?this.StartPerformGroup(o):this.StopPerformGroup(o)}CheckCondition(o){return!!this.PerformStateMap.has(o.SwitchKey)&&this.PerformStateMap.get(o.SwitchKey)}IsGroupRunning(o){return this.CurrentRunningGroupMap.has(o.Id)}StartPerformGroup(o){var t;this.IsGroupRunning(o)||(t=this.Entity?.GetComponent(0),Log_1.Log.CheckInfo()&&Log_1.Log.Info("NPC",51,"[PerformGroupController]表现组开启",["PbDataId",t?.GetPbDataId()],["GroupId",o.Id],["Key",o.SwitchKey]),o.Start(),this.CurrentRunningGroupMap.set(o.Id,o))}StopPerformGroup(o){var t;this.IsGroupRunning(o)&&(t=this.Entity?.GetComponent(0),Log_1.Log.CheckInfo()&&Log_1.Log.Info("NPC",51,"[PerformGroupController]表现组关闭",["PbDataId",t?.GetPbDataId()],["GroupId",o.Id],["Key",o.SwitchKey]),o.Stop(),this.CurrentRunningGroupMap.delete(o.Id))}}exports.PerformGroupController=PerformGroupController;
//# sourceMappingURL=NpcPerformGroupController.js.map