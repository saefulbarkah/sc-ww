
"use strict";var __decorate=this&&this.__decorate||function(t,e,i,s){var o,h=arguments.length,n=h<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,i,s);else for(var r=t.length-1;0<=r;r--)(o=t[r])&&(n=(h<3?o(n):3<h?o(e,i,n):o(e,i))||n);return 3<h&&n&&Object.defineProperty(e,i,n),n};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SceneItemMoveComponent=exports.SceneItemSplineMoveParam=exports.MoveTarget=void 0;const puerts_1=require("puerts"),UE=require("ue"),Info_1=require("../../../../../Core/Common/Info"),Log_1=require("../../../../../Core/Common/Log"),Protocol_1=require("../../../../../Core/Define/Net/Protocol"),EntityComponent_1=require("../../../../../Core/Entity/EntityComponent"),RegisterComponent_1=require("../../../../../Core/Entity/RegisterComponent"),Net_1=require("../../../../../Core/Net/Net"),CurveFloatHandle_1=require("../../../../../Core/Utils/CurveFloatHandle"),Vector_1=require("../../../../../Core/Utils/Math/Vector"),MathUtils_1=require("../../../../../Core/Utils/MathUtils"),IAction_1=require("../../../../../UniverseEditor/Interface/IAction"),EventDefine_1=require("../../../../Common/Event/EventDefine"),EventSystem_1=require("../../../../Common/Event/EventSystem"),TimeUtil_1=require("../../../../Common/TimeUtil"),ModelManager_1=require("../../../../Manager/ModelManager"),OFFSET=100;class MoveTarget{constructor(t,e,i=0,s=-1,o=-1){this.TargetPosData=t,this.MoveTime=e,this.StayTime=i,this.MaxSpees=s,this.Acceleration=o}}exports.MoveTarget=MoveTarget;class SceneItemSplineMoveParam{constructor(t){this.Spline=t,this.IsRepeat=!1,this.IsCycle=!1,this.IsKeepLookAt=!1,this.TimeSec=0,this.TimeDisCurve=void 0,this.StartTimeOffset=0,this.StartDis=-1,this.EndDis=-1}}exports.SceneItemSplineMoveParam=SceneItemSplineMoveParam;let SceneItemMoveComponent=class SceneItemMoveComponent extends EntityComponent_1.EntityComponent{constructor(){super(...arguments),this.ActorComp=void 0,this.o4o=void 0,this.Nln=void 0,this.Oln=void 0,this.kln=!1,this.ZPl=!1,this.Anr=Vector_1.Vector.Create(),this.Fln=[],this._ii=1,this._ae=Vector_1.Vector.Create(),this.Due=Vector_1.Vector.Create(),this.Vln=Vector_1.Vector.Create(),this.Hln=-0,this.jln=!1,this.Wln=!1,this.BNn=!1,this.wNn=[],this.hIn=[],this.OnStopPatrol=()=>{this.jln=!1,this.RemoveStopMoveCallback(this.OnStopPatrol),0<this.Qd_.length&&this.RemoveAllOnArrivePointCallbacks(),Log_1.Log.CheckInfo()&&Log_1.Log.Info("SceneItem",39,"SceneItemMoveComponent 样条移动停止",["EntityId",this.Entity.Id]),EventSystem_1.EventSystem.EmitWithTarget(this.Entity,EventDefine_1.EEventName.OnSceneItemSplineMoveStopped,this.Entity)},this.lIn=()=>{this.BNn=!0;for(const t of this.hIn)t(this.Entity);this.BNn=!1;for(const e of this.wNn)this.hIn.push(e);this.wNn.length=0},this.Qd_=[]}static get Dependencies(){return[197,0]}get IsMovingPrepareCompleted(){return this.Wln}get IsMoving(){return Info_1.Info.EnableForceTick?0<this.Fln.length||0===this._ii:this.IsMovingPrepareCompleted?this.o4o.IsMoving():0<this.Fln.length}get ForceSyncing(){return this.ZPl}set ForceSyncing(t){this.ZPl=t,this.ZPl&&this.Nln?.SetEnableMovementSync(!0,"SceneItemMoveComponent ForceSyncing")}IsSplineMoving(){return!!this.IsMovingPrepareCompleted&&0!==this.o4o.GetSplineRunState()}GetDistanceAloneSpline(){return this.IsMovingPrepareCompleted?this.o4o.GetDistanceAlongSpline():0}OnStart(){var t=this.Entity.GetComponent(0);return this.ActorComp=this.Entity.GetComponent(197),this.Nln=this.Entity.GetComponent(153),this.Oln=this.Entity.GetComponent(125),this.Nln?.SetEnableMovementSync(!1,"SceneItemMoveComponent OnStart"),t&&t.GetPbEntityInitData()&&!Info_1.Info.EnableForceTick&&(this.o4o=this.ActorComp.Owner.GetComponentByClass(UE.KuroSceneItemMoveComponent.StaticClass()),this.o4o?.IsValid()||(this.o4o=this.ActorComp.Owner.AddComponentByClass(UE.KuroSceneItemMoveComponent.StaticClass(),!1,new UE.Transform,!1)),(t=t.GetInitGravityDirection())?(MathUtils_1.MathUtils.CommonTempVector.FromConfigVector(t),this.o4o.Kuro_SetGravityDirect(MathUtils_1.MathUtils.CommonTempVector.ToUeVectorOld())):this.o4o.Kuro_SetGravityDirect(Vector_1.Vector.DownVector),this.o4o.SetTickingMoveEnable(!1)),!0}OnActivate(){if(!Info_1.Info.EnableForceTick&&0<this.Fln.length){for(const t of this.Fln)this.o4o.AddMoveTarget(new UE.VectorDouble(t.TargetPosData.X??0,t.TargetPosData.Y??0,t.TargetPosData.Z??0),t.MoveTime,t.StayTime);this.Fln=[],this.o4o.SetTickingMoveEnable(!0),this.Oln.IsMoving=!0}this.Wln=!0}Kln(){return Vector_1.Vector.DistSquared(this._ae,this.Vln)>=this.Hln}OnTick(t){this.Oln.IsMoving?this.IsMoving&&2!==this.o4o.GetSimpleRunState()||(this.Oln.IsMoving=!1):this.IsMoving&&1===this.o4o.GetSimpleRunState()&&(this.Oln.IsMoving=!0),!this.kln||this.IsMoving||this.ForceSyncing||(this.kln=!1,this.Nln?.SetEnableMovementSync(!1,"SceneItemMoveComponent MoveStop"))}OnForceTick(t){var e,i;super.OnTick(t),0===this._ii?(this.Anr.Addition(this.ActorComp.ActorLocationProxy,this.Vln),this.Kln()?(this.ActorComp.SetActorLocation(this.Due.ToUeVector()),this._ii=1):this.ActorComp.SetActorLocation(this.Vln.ToUeVector())):this.Fln&&0!==this.Fln.length&&(e=this.Fln[0],this.Fln.splice(0,1),this.Due=Vector_1.Vector.Create(e.TargetPosData.X,e.TargetPosData.Y,e.TargetPosData.Z),e.MoveTime<=MathUtils_1.MathUtils.KindaSmallNumber?this.ActorComp.SetActorLocation(this.Due.ToUeVector()):(this._ae.DeepCopy(this.ActorComp.ActorLocationProxy),this.Hln=Vector_1.Vector.DistSquared(this._ae,this.Due),i=Vector_1.Vector.Create(),this.Due.Subtraction(this._ae,i),i.Division(e.MoveTime*TimeUtil_1.TimeUtil.InverseMillisecond/t,i),this.Anr=i,this._ii=0))}bSa(t){var e;!Info_1.Info.EnableForceTick&&this.IsMovingPrepareCompleted?(e=Vector_1.Vector.Create(t.TargetPosData.X??0,t.TargetPosData.Y??0,t.TargetPosData.Z??0),this.o4o.AddMoveTarget(e.ToUeVector(),t.MoveTime,t.StayTime,t.MaxSpees,t.Acceleration),this.Oln.IsMoving||this.AddStopMoveCallback(this.lIn),this.o4o.SetTickingMoveEnable(!0),e=Vector_1.Vector.Dist(e,this.ActorComp.ActorLocationProxy),0===this.o4o.GetSimpleRunState()&&e>OFFSET&&(this.Oln.IsMoving=!0)):this.Fln.push(t),Log_1.Log.CheckInfo()&&Log_1.Log.Info("Movement",31,"添加路径点",["moveTargetX",t.TargetPosData.X],["moveTargetY",t.TargetPosData.Y],["moveTargetZ",t.TargetPosData.Z],["Time",t.MoveTime])}AddMoveTarget(e){if(this.jln)Log_1.Log.CheckError()&&Log_1.Log.Error("SceneItem",31,"当前SceneItem正在巡逻中,不可再添加目标点",["PbDataId",this.Entity.GetComponent(0).GetPbDataId()]);else{let t=void 0;var i;t=e instanceof MoveTarget?e:(i=e.MoveMotion?.Type===IAction_1.EMoveMotion.VariableMotion?-1:e.MoveMotion?.Time??0,new MoveTarget(e.Point,i)),this.bSa(t),ModelManager_1.ModelManager.GameModeModel.IsMulti&&this.RequestMoveToTarget(t)}}AddSimpleRotation(t,e,i,s){this.o4o.InitRotationData(t,!1),this.o4o.AddRotationStep(e.ToUeRotator(),i.ToUeRotator(),s,0,void 0),this.o4o.StartRotate()}RequestMoveToTarget(t){var e=Protocol_1.Aki.Protocol.d0a.create();e.M0a=Protocol_1.Aki.Protocol.E0a.create(),e.M0a.F4n=this.ActorComp.CreatureData.GetCreatureDataId(),e.M0a.P5n={X:t.TargetPosData.X,Y:t.TargetPosData.Y,Z:t.TargetPosData.Z},e.M0a.g0a=t.MoveTime,e.M0a.f0a=t.StayTime,e.M0a.v0a=t.MaxSpees,e.M0a.p0a=t.Acceleration,Net_1.Net.Call(16737,e,t=>{})}HandleMoveToTarget(t){t=new MoveTarget({X:t.M0a.P5n.X,Y:t.M0a.P5n.Y,Z:t.M0a.P5n.Z},t.M0a.g0a,t.M0a.f0a,t.M0a.v0a,t.M0a.p0a);this.bSa(t)}StartPatrol(t,e,i,s,o,h,n,r=-1,a=-1){return!!this.o4o.StartMoveWithSpline(t,s,o,h,e,i,r,a)&&(this.jln=!0,this.kln=!0,this.Nln?.SetEnableMovementSync(!0,"SceneItemMoveComponent StartPatrol"),this.AddStopMoveCallback(this.OnStopPatrol),n&&this.AddStopMoveCallback(n),Log_1.Log.CheckInfo()&&Log_1.Log.Info("SceneItem",39,"SceneItemMoveComponent 样条移动开始",["EntityId",this.Entity.Id]),EventSystem_1.EventSystem.EmitWithTarget(this.Entity,EventDefine_1.EEventName.OnSceneItemSplineMoveStarted,this.Entity),!0)}static ParsePatrolParamsToSplineMoveParam(i,s,o,t,e,h,n){var r,a=new SceneItemSplineMoveParam(i);a.IsRepeat=t,a.IsCycle=e,a.IsKeepLookAt=h,a.StartTimeOffset=n;let c=i.GetSplineLength();t&&e&&!i.IsClosedLoop()&&(h=i.GetNumberOfSplinePoints()-1,n=i.GetLocationAtSplinePoint(0,0),t=i.GetLeaveTangentAtSplinePoint(h,0),e=i.GetLeaveTangentAtSplinePoint(0,0),n=n.op_Subtraction(t).GetSafeNormal(MathUtils_1.MathUtils.SmallNumber),t=i.GetArriveTangentAtSplinePoint(h,0),r=n,i.SetClosedLoop(!0),i.SetTangentsAtSplinePoint(0,n,e,0),i.SetTangentsAtSplinePoint(h,t,r,0),n=i.GetSplineLength(),c=n);var v=new CurveFloatHandle_1.CurveFloatHandle;let m=0;for(let e=0;e<=i.GetNumberOfSplineSegments();e++){var _=i.GetDistanceAlongSplineAtSplinePoint(e),l=o[e]<0?0:o[e]??0,p=s[e]<0?0:s[e]??0;let t=0;if(e<i.GetNumberOfSplineSegments()&&(S=i.GetDistanceAlongSplineAtSplinePoint(e+1),t=S-_),!t&&!l){v.AddKey(m,_,1);break}if(v.AddKey(m,_),!t){v.AddKey(m+l,_,1),m+=l;break}l&&v.AddKey(m+l,_);var S=p?Math.abs(t/p):0;v.AddKey(m+l+S,_+t,1),m+=l+S}return v.MapRangeClampedTimeAndValue([0,m],[0,1],[0,c],[0,1]),a.TimeSec=m,a.TimeDisCurve=v.ToUeCurveFloat(),a}StartPatrolAtConstantTime(t,e){return!!this.o4o.StartMoveWithSplineAtConstantTime(t.Spline,t.IsRepeat,t.IsCycle,t.IsKeepLookAt,t.TimeSec,t.TimeDisCurve,t.StartTimeOffset,t.StartDis,t.EndDis)&&(this.jln=!0,this.kln=!0,this.Nln?.SetEnableMovementSync(!0,"SceneItemMoveComponent StartPatrolAtConstantTime"),this.AddStopMoveCallback(this.OnStopPatrol),e&&this.AddStopMoveCallback(e),Log_1.Log.CheckInfo()&&Log_1.Log.Info("SceneItem",39,"SceneItemMoveComponent 样条移动开始",["EntityId",this.Entity.Id]),EventSystem_1.EventSystem.EmitWithTarget(this.Entity,EventDefine_1.EEventName.OnSceneItemSplineMoveStarted,this.Entity),!0)}StopMove(t=!1){var e,i;Info_1.Info.EnableForceTick?(this.Fln=[],this._ii=1):this.IsMovingPrepareCompleted?((this.hIn.length=0)<this.Qd_.length&&this.RemoveAllOnArrivePointCallbacks(),i=!!(e=this.o4o?.IsMoving(!0))&&0!==this.o4o?.GetSimpleRunState(),this.o4o.StopAllMove(t),e&&(i?Log_1.Log.CheckInfo()&&Log_1.Log.Info("SceneItem",39,"SceneItemMoveComponent 简单移动中断",["EntityId",this.Entity.Id]):(Log_1.Log.CheckInfo()&&Log_1.Log.Info("SceneItem",39,"SceneItemMoveComponent 样条移动中断",["EntityId",this.Entity.Id]),EventSystem_1.EventSystem.EmitWithTarget(this.Entity,EventDefine_1.EEventName.OnSceneItemSplineMoveBroken,this.Entity)))):this.Fln=[]}GetNextTarget(){var t,e;return this.o4o?.IsValid()?(t=(0,puerts_1.$ref)(new UE.VectorDouble),e=(0,puerts_1.$ref)(new UE.VectorDouble),{HasTarget:this.o4o.GetNextMoveTarget(t,e),Target:(0,puerts_1.$unref)(t),Velocity:(0,puerts_1.$unref)(e)}):(Log_1.Log.CheckError()&&Log_1.Log.Error("SceneItem",31,"SceneItemMoveComponent不存在",["PbDataId",this.Entity.GetComponent(0).GetPbDataId()],["IsEntityInit",this.Entity.IsInit]),{HasTarget:!1,Target:new UE.VectorDouble,Velocity:new UE.VectorDouble})}AddStopMoveCallback(t){this.o4o.OnStopCallback.Add(t)}RemoveStopMoveCallback(t){this.o4o.OnStopCallback.Remove(t)}AddOnArrivePointCallback(t){this.Qd_.push(t),this.o4o.OnArrivePointCallback.Add(t)}RemoveOnArrivePointCallback(t){this.o4o.OnArrivePointCallback.Remove(t)}RemoveAllOnArrivePointCallbacks(){for(const t of this.Qd_)this.o4o.OnArrivePointCallback.Remove(t);this.Qd_.length=0}AddStopMoveCallbackWithEntity(t){(this.BNn?this.wNn:this.hIn).push(t)}RemoveStopMoveCallbackWithEntity(t){this.hIn.includes(t)&&this.hIn.splice(this.hIn.indexOf(t),1)}ClearStopMoveCallbackWithEntity(){this.hIn.length=0}};SceneItemMoveComponent=__decorate([(0,RegisterComponent_1.RegisterComponent)(123)],SceneItemMoveComponent),exports.SceneItemMoveComponent=SceneItemMoveComponent;
//# sourceMappingURL=SceneItemMoveComponent.js.map