
"use strict";var RenderMaskComponent_1,__decorate=this&&this.__decorate||function(e,t,i,r){var a,o=arguments.length,s=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,r);else for(var n=e.length-1;0<=n;n--)(a=e[n])&&(s=(o<3?a(s):3<o?a(t,i,s):a(t,i))||s);return 3<o&&s&&Object.defineProperty(t,i,s),s};Object.defineProperty(exports,"__esModule",{value:!0}),exports.RenderMaskComponent=void 0;const UE=require("ue"),AudioSystem_1=require("../../../../../Core/Audio/AudioSystem"),Info_1=require("../../../../../Core/Common/Info"),Log_1=require("../../../../../Core/Common/Log"),QueryTypeDefine_1=require("../../../../../Core/Define/QueryTypeDefine"),EntityComponent_1=require("../../../../../Core/Entity/EntityComponent"),RegisterComponent_1=require("../../../../../Core/Entity/RegisterComponent"),FNameUtil_1=require("../../../../../Core/Utils/FNameUtil"),MathUtils_1=require("../../../../../Core/Utils/MathUtils"),TraceElementCommon_1=require("../../../../../Core/Utils/TraceElementCommon"),IComponent_1=require("../../../../../UniverseEditor/Interface/IComponent"),Global_1=require("../../../../Global"),GlobalData_1=require("../../../../GlobalData"),LevelGeneralContextDefine_1=require("../../../../LevelGamePlay/LevelGeneralContextDefine"),ControllerHolder_1=require("../../../../Manager/ControllerHolder"),ModelManager_1=require("../../../../Manager/ModelManager"),RenderDataManager_1=require("../../../../Render/Data/RenderDataManager"),ColorUtils_1=require("../../../../Utils/ColorUtils"),MAX_SPEED=600;let RenderMaskComponent=RenderMaskComponent_1=class RenderMaskComponent extends EntityComponent_1.EntityComponent{constructor(){super(...arguments),this.Lo=void 0,this.esl=!1,this.tsl=0,this.bsr=void 0,this.isl=!1,this.rsl=void 0,this.Sll=0,this.yll="",this.Hte=void 0,this.DebugMode=!1,this.FollowEntity=void 0,this._un=void 0}OnInitData(e){e=e.GetParam(RenderMaskComponent_1)[0];if(this.Lo=e,!this.Lo)return!1;switch(this.Lo.RenderConfig.Type){case IComponent_1.ERenderSpecifiedRangeType.FlowerBridge:this.tsl=this.Lo.RenderConfig.Radius,this.rsl=FNameUtil_1.FNameUtil.GetDynamicFName("PCG_FlowerBridge"),this.yll=(0,AudioSystem_1.parseAudioEventPath)(this.Lo.RenderConfig.AkEvent);break;case IComponent_1.ERenderSpecifiedRangeType.BookPage:this.tsl=this.Lo.RenderConfig.Radius,this.yll=(0,AudioSystem_1.parseAudioEventPath)(this.Lo.RenderConfig.AkEvent)}return!0}OnStart(){return this.bsr=UE.NewObject(UE.TraceSphereElement.StaticClass()),this.bsr.bIsSingle=!1,this.bsr.bTraceComplex=!1,this.bsr.bIgnoreSelf=!0,this.bsr.AddObjectTypeQuery(QueryTypeDefine_1.KuroObjectTypeQuery.WorldStatic),this.bsr.Radius=this.tsl,this.bsr.WorldContextObject=GlobalData_1.GlobalData.World,this.Hte=this.Entity.GetComponent(1),!0}OnEnd(){return this.osl(),this.bsr&&(this.bsr.Dispose(),this.bsr=void 0),!0}OnDisable(e){this.osl()}OnEnable(){this.nsl()}OnTick(e){var t=this.ssl(),i=this.esl!==t;if(t)return this.Swr(),this.asl()?(this.esl=t,this.nsl(),void this.Cl()):void this.osl();i&&(this.esl=t,this.osl())}nsl(){var e,t=RenderDataManager_1.RenderDataManager.Get().GetSceneInteractionMaterialParameterCollection();t?.IsValid()&&!this.isl&&(!this.Sll&&this.Hte&&(this.Sll=AudioSystem_1.AudioSystem.PostEvent(this.yll,this.Hte.Owner)),e=UE.KismetMaterialLibrary.GetScalarParameterValue(GlobalData_1.GlobalData.GameInstance.GetWorld(),t,FNameUtil_1.FNameUtil.GetDynamicFName("FlowerBridge_Radius")),UE.KuroMaterialParameterCollectionManager.SetScalarParameterValueTimeCurve(GlobalData_1.GlobalData.GameInstance.GetWorld(),t,FNameUtil_1.FNameUtil.GetDynamicFName("FlowerBridge_Radius"),this.tsl,e,.4,GlobalData_1.GlobalData.GameInstance.GetWorld(),!1),this.isl=!0)}osl(){var e,t=RenderDataManager_1.RenderDataManager.Get().GetSceneInteractionMaterialParameterCollection();t?.IsValid()&&this.isl&&(this.Sll&&(AudioSystem_1.AudioSystem.ExecuteAction(this.Sll,0),this.Sll=0),e=UE.KismetMaterialLibrary.GetScalarParameterValue(GlobalData_1.GlobalData.GameInstance.GetWorld(),t,FNameUtil_1.FNameUtil.GetDynamicFName("FlowerBridge_Radius")),UE.KuroMaterialParameterCollectionManager.SetScalarParameterValueTimeCurve(GlobalData_1.GlobalData.GameInstance.GetWorld(),t,FNameUtil_1.FNameUtil.GetDynamicFName("FlowerBridge_Radius"),0,e,.4,GlobalData_1.GlobalData.GameInstance.GetWorld(),!1),this.isl=!1)}Cl(){var e,t;RenderDataManager_1.RenderDataManager.Get().GetSceneInteractionMaterialParameterCollection()?.IsValid()&&(e=ModelManager_1.ModelManager.SceneTeamModel?.GetCurrentEntity)&&((e=e.Entity?.GetComponent(167))&&(t=MathUtils_1.MathUtils.RangeClamp(e.Speed,0,MAX_SPEED,0,1),this.DebugMode&&Log_1.Log.CheckDebug()&&Log_1.Log.Debug("SceneGameplay",7,"RenderMaskComponent",["CurSpeed",e.Speed],["RtpcValue",t]),AudioSystem_1.AudioSystem.SetRtpcValue("interact_level_chun_huaqiao",t)),this.Swr())}asl(){if(this.Lo?.RenderConfig.Type!==IComponent_1.ERenderSpecifiedRangeType.FlowerBridge)return!0;if(this.bsr?.IsValid()&&Global_1.Global.BaseCharacter?.IsValid()&&this.rsl){this.bsr.HitResult?.Clear(),TraceElementCommon_1.TraceElementCommon.SetStartLocation(this.bsr,Global_1.Global.BaseCharacter?.D_K2_GetActorLocation()),TraceElementCommon_1.TraceElementCommon.SetEndLocation(this.bsr,Global_1.Global.BaseCharacter?.D_K2_GetActorLocation());var e=TraceElementCommon_1.TraceElementCommon.SphereTrace(this.bsr,"RenderMaskComponent.RangeCheck");if(!e)return e;var t=this.bsr.HitResult.GetHitCount()??0;for(let e=0;e<t;++e){var i=(this.bsr.HitResult?.Actors?.Get(e))?.Tags.Contains(this.rsl);if(i)return i}}return!1}ssl(){var e;return!this._un?.IsLocked&&(!(e=this.Lo?.Condition)||ControllerHolder_1.ControllerHolder.LevelGeneralController.CheckConditionNew(e,void 0,LevelGeneralContextDefine_1.EntityContext.Create(this.Entity.Id)))}ToggleDebugMode(e){Info_1.Info.IsBuildDevelopmentOrDebug&&(this.DebugMode=e,TraceElementCommon_1.TraceElementCommon.SetTraceColor(this.bsr,ColorUtils_1.ColorUtils.LinearGreen),TraceElementCommon_1.TraceElementCommon.SetTraceHitColor(this.bsr,ColorUtils_1.ColorUtils.LinearRed),this.bsr.SetDrawDebugTrace(this.DebugMode?1:0))}Swr(){var e,t=RenderDataManager_1.RenderDataManager.Get().GetSceneInteractionMaterialParameterCollection();t?.IsValid()&&(this.FollowEntity&&this.FollowEntity.Valid||(this.zql(),this.FollowEntity))&&(e=this.FollowEntity.GetComponent(1)?.ActorLocation)&&(e=UE.KismetMathLibrary.Conv_VectorDoubleToVector(e),UE.KismetMaterialLibrary.SetVectorParameterValue(GlobalData_1.GlobalData.GameInstance.GetWorld(),t,FNameUtil_1.FNameUtil.GetDynamicFName("FlowerBridge_CenterPosition"),UE.KismetMathLibrary.Conv_VectorToLinearColor(e)))}zql(){var e=this.Lo?.RenderConfig;switch(e.CenterTarget.Type){case"Player":this.FollowEntity=ModelManager_1.ModelManager.SceneTeamModel?.GetCurrentEntity?.Entity;break;case"Self":this.FollowEntity=this.Entity;break;case"Target":this.FollowEntity=ModelManager_1.ModelManager.CreatureModel?.GetEntityByPbDataId(e.CenterTarget.EntityId)?.Entity}}};RenderMaskComponent=RenderMaskComponent_1=__decorate([(0,RegisterComponent_1.RegisterComponent)(237)],RenderMaskComponent),exports.RenderMaskComponent=RenderMaskComponent;
//# sourceMappingURL=RenderMaskComponent.js.map