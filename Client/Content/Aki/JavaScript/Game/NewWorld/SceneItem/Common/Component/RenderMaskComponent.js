
"use strict";var RenderMaskComponent_1,__decorate=this&&this.__decorate||function(e,t,i,r){var o,a=arguments.length,n=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var s=e.length-1;0<=s;s--)(o=e[s])&&(n=(a<3?o(n):3<a?o(t,i,n):o(t,i))||n);return 3<a&&n&&Object.defineProperty(t,i,n),n};Object.defineProperty(exports,"__esModule",{value:!0}),exports.RenderMaskComponent=void 0;const UE=require("ue"),AudioSystem_1=require("../../../../../Core/Audio/AudioSystem"),Info_1=require("../../../../../Core/Common/Info"),Log_1=require("../../../../../Core/Common/Log"),QueryTypeDefine_1=require("../../../../../Core/Define/QueryTypeDefine"),EntityComponent_1=require("../../../../../Core/Entity/EntityComponent"),RegisterComponent_1=require("../../../../../Core/Entity/RegisterComponent"),FNameUtil_1=require("../../../../../Core/Utils/FNameUtil"),MathUtils_1=require("../../../../../Core/Utils/MathUtils"),TraceElementCommon_1=require("../../../../../Core/Utils/TraceElementCommon"),IComponent_1=require("../../../../../UniverseEditor/Interface/IComponent"),Global_1=require("../../../../Global"),GlobalData_1=require("../../../../GlobalData"),LevelGeneralContextDefine_1=require("../../../../LevelGamePlay/LevelGeneralContextDefine"),ControllerHolder_1=require("../../../../Manager/ControllerHolder"),ModelManager_1=require("../../../../Manager/ModelManager"),RenderDataManager_1=require("../../../../Render/Data/RenderDataManager"),ColorUtils_1=require("../../../../Utils/ColorUtils"),MAX_SPEED=600;let RenderMaskComponent=RenderMaskComponent_1=class RenderMaskComponent extends EntityComponent_1.EntityComponent{constructor(){super(...arguments),this.Lo=void 0,this.Hnl=!1,this.jnl=0,this.bsr=void 0,this.Wnl=!1,this.Qnl=void 0,this.Qal=0,this.Kal="",this.Hte=void 0,this.DebugMode=!1,this._un=void 0}OnInitData(e){e=e.GetParam(RenderMaskComponent_1)[0];return this.Lo=e,!!this.Lo&&(this.Lo.RenderConfig.Type===IComponent_1.ERenderSpecifiedRangeType.FlowerBridge&&(this.jnl=this.Lo.RenderConfig.Radius,this.Qnl=FNameUtil_1.FNameUtil.GetDynamicFName("PCG_FlowerBridge"),this.Kal=(0,AudioSystem_1.parseAudioEventPath)(this.Lo.RenderConfig.AkEvent)),!0)}OnStart(){return this.bsr=UE.NewObject(UE.TraceSphereElement.StaticClass()),this.bsr.bIsSingle=!1,this.bsr.bTraceComplex=!1,this.bsr.bIgnoreSelf=!0,this.bsr.AddObjectTypeQuery(QueryTypeDefine_1.KuroObjectTypeQuery.WorldStatic),this.bsr.Radius=this.jnl,this.bsr.WorldContextObject=GlobalData_1.GlobalData.World,this.Hte=this.Entity.GetComponent(1),!0}OnEnd(){return this.Knl(),this.bsr&&(this.bsr.Dispose(),this.bsr=void 0),!0}OnDisable(e){this.Knl()}OnEnable(){this.$nl()}OnTick(e){var t=this.Xnl(),i=this.Hnl!==t;if(t)return this.Ynl()?(this.Hnl=t,this.$nl(),void this.Cl()):void this.Knl();i&&(this.Hnl=t,this.Knl())}$nl(){var e,t=RenderDataManager_1.RenderDataManager.Get().GetSceneInteractionMaterialParameterCollection();t?.IsValid()&&!this.Wnl&&(!this.Qal&&this.Hte&&(this.Qal=AudioSystem_1.AudioSystem.PostEvent(this.Kal,this.Hte.Owner)),e=UE.KismetMaterialLibrary.GetScalarParameterValue(GlobalData_1.GlobalData.GameInstance.GetWorld(),t,FNameUtil_1.FNameUtil.GetDynamicFName("FlowerBridge_Radius")),UE.KuroMaterialParameterCollectionManager.SetScalarParameterValueTimeCurve(GlobalData_1.GlobalData.GameInstance.GetWorld(),t,FNameUtil_1.FNameUtil.GetDynamicFName("FlowerBridge_Radius"),this.jnl,e,.4,GlobalData_1.GlobalData.GameInstance.GetWorld(),!1),this.Wnl=!0)}Knl(){var e,t=RenderDataManager_1.RenderDataManager.Get().GetSceneInteractionMaterialParameterCollection();t?.IsValid()&&this.Wnl&&(this.Qal&&(AudioSystem_1.AudioSystem.ExecuteAction(this.Qal,0),this.Qal=0),e=UE.KismetMaterialLibrary.GetScalarParameterValue(GlobalData_1.GlobalData.GameInstance.GetWorld(),t,FNameUtil_1.FNameUtil.GetDynamicFName("FlowerBridge_Radius")),UE.KuroMaterialParameterCollectionManager.SetScalarParameterValueTimeCurve(GlobalData_1.GlobalData.GameInstance.GetWorld(),t,FNameUtil_1.FNameUtil.GetDynamicFName("FlowerBridge_Radius"),0,e,.4,GlobalData_1.GlobalData.GameInstance.GetWorld(),!1),this.Wnl=!1)}Cl(){var e,t,i=RenderDataManager_1.RenderDataManager.Get().GetSceneInteractionMaterialParameterCollection();i?.IsValid()&&(t=ModelManager_1.ModelManager.SceneTeamModel?.GetCurrentEntity)&&((t=t.Entity?.GetComponent(164))&&(e=MathUtils_1.MathUtils.RangeClamp(t.Speed,0,MAX_SPEED,0,1),this.DebugMode&&Log_1.Log.CheckDebug()&&Log_1.Log.Debug("SceneGameplay",7,"RenderMaskComponent",["CurSpeed",t.Speed],["RtpcValue",e]),AudioSystem_1.AudioSystem.SetRtpcValue("interact_level_chun_huaqiao",e)),t=Global_1.Global.BaseCharacter?.K2_GetActorLocation())&&UE.KismetMaterialLibrary.SetVectorParameterValue(GlobalData_1.GlobalData.GameInstance.GetWorld(),i,FNameUtil_1.FNameUtil.GetDynamicFName("FlowerBridge_CenterPosition"),UE.KismetMathLibrary.Conv_VectorToLinearColor(t))}Ynl(){if(this.bsr?.IsValid()&&Global_1.Global.BaseCharacter?.IsValid()&&this.Qnl){this.bsr.HitResult?.Clear(),TraceElementCommon_1.TraceElementCommon.SetStartLocation(this.bsr,Global_1.Global.BaseCharacter?.K2_GetActorLocation()),TraceElementCommon_1.TraceElementCommon.SetEndLocation(this.bsr,Global_1.Global.BaseCharacter?.K2_GetActorLocation());var e=TraceElementCommon_1.TraceElementCommon.SphereTrace(this.bsr,"RenderMaskComponent.RangeCheck");if(!e)return e;var t=this.bsr.HitResult.GetHitCount()??0;for(let e=0;e<t;++e){var i=(this.bsr.HitResult?.Actors?.Get(e))?.Tags.Contains(this.Qnl);if(i)return i}}return!1}Xnl(){var e;return!this._un?.IsLocked&&(!(e=this.Lo?.Condition)||ControllerHolder_1.ControllerHolder.LevelGeneralController.CheckConditionNew(e,void 0,LevelGeneralContextDefine_1.EntityContext.Create(this.Entity.Id)))}ToggleDebugMode(e){Info_1.Info.IsBuildDevelopmentOrDebug&&(this.DebugMode=e,TraceElementCommon_1.TraceElementCommon.SetTraceColor(this.bsr,ColorUtils_1.ColorUtils.LinearGreen),TraceElementCommon_1.TraceElementCommon.SetTraceHitColor(this.bsr,ColorUtils_1.ColorUtils.LinearRed),this.bsr.SetDrawDebugTrace(this.DebugMode?1:0))}};RenderMaskComponent=RenderMaskComponent_1=__decorate([(0,RegisterComponent_1.RegisterComponent)(226)],RenderMaskComponent),exports.RenderMaskComponent=RenderMaskComponent;
//# sourceMappingURL=RenderMaskComponent.js.map