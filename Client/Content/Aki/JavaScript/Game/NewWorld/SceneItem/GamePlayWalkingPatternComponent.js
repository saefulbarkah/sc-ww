
"use strict";var GamePlayWalkingPatternComponent_1,__decorate=this&&this.__decorate||function(t,e,i,s){var n,o=arguments.length,r=o<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,s);else for(var a=t.length-1;0<=a;a--)(n=t[a])&&(r=(o<3?n(r):3<o?n(e,i,r):n(e,i))||r);return 3<o&&r&&Object.defineProperty(e,i,r),r};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GamePlayWalkingPatternComponent=void 0;const UE=require("ue"),ActorSystem_1=require("../../../Core/Actor/ActorSystem"),Log_1=require("../../../Core/Common/Log"),Queue_1=require("../../../Core/Container/Queue"),Protocol_1=require("../../../Core/Define/Net/Protocol"),EntityComponent_1=require("../../../Core/Entity/EntityComponent"),RegisterComponent_1=require("../../../Core/Entity/RegisterComponent"),Net_1=require("../../../Core/Net/Net"),TimerSystem_1=require("../../../Core/Timer/TimerSystem"),Vector_1=require("../../../Core/Utils/Math/Vector"),MathUtils_1=require("../../../Core/Utils/MathUtils"),IComponent_1=require("../../../UniverseEditor/Interface/IComponent"),EventDefine_1=require("../../Common/Event/EventDefine"),EventSystem_1=require("../../Common/Event/EventSystem"),TimeUtil_1=require("../../Common/TimeUtil"),EffectSystem_1=require("../../Effect/EffectSystem"),Global_1=require("../../Global"),GlobalData_1=require("../../GlobalData"),GameSplineUtils_1=require("../../LevelGamePlay/Common/GameSplineUtils"),TsGameSplineActor_1=require("../../LevelGamePlay/Common/TsGameSplineActor"),ControllerHolder_1=require("../../Manager/ControllerHolder"),ModelManager_1=require("../../Manager/ModelManager"),PreloadConfigStatementPart3_1=require("../../Preload/PreloadConfigStatementPart3");let GamePlayWalkingPatternComponent=GamePlayWalkingPatternComponent_1=class GamePlayWalkingPatternComponent extends EntityComponent_1.EntityComponent{constructor(){super(...arguments),this.Lo=void 0,this.Hte=void 0,this.mBe=void 0,this.bFl=void 0,this.Hnr=void 0,this.zie=void 0,this.BFl=void 0,this.qFl=void 0,this.kFl=void 0,this.GFl=void 0,this.qsh=void 0,this.Fsh=0,this.Hln=0,this.Wlh=0,this.OFl=0,this.NFl=0,this.FFl=void 0,this.VFl=new Queue_1.Queue,this.jFl=void 0,this.HFl=void 0,this.Vsh=0,this.r$t=!1,this.ksh=0,this.Nsh=0,this.wdt=-1,this.Qlh=-1,this.Nme=Vector_1.Vector.Create(),this.Hsh=Vector_1.Vector.Create(),this.g_n=(t,e)=>{this.WFl(t)},this.Etn=t=>{var e;t&&!this.r$t&&(this.r$t=!0,e=this.Nsh/this.ksh,this.Vsh=0,e>=this.Fsh&&e<=this.Hln?this.Vsh=100-(e-this.Fsh)/(this.Hln-this.Fsh)*100:e<this.Fsh?this.Vsh=100:this.Vsh=0,this.Vsh=Math.min(this.Vsh,this.Qlh/this.wdt*100),t)&&this.EDe()}}OnInitData(t){t=t.GetParam(GamePlayWalkingPatternComponent_1)[0];return this.Lo=t,!0}OnStart(){return this.Hte=this.Entity.GetComponent(191),this.mBe=this.Entity.GetComponent(122),this.bFl=this.Disable("GamePlayWalkingPatternComponent 默认关闭Tick"),this.QFl(),this.KFl(),this.mSe(),this.WFl(this.mBe.StateTagId),!0}QFl(){this.Hnr=ActorSystem_1.ActorSystem.Get(TsGameSplineActor_1.default.StaticClass(),MathUtils_1.MathUtils.DefaultTransformDouble),this.zie=GameSplineUtils_1.GameSplineUtils.InitGameSplineBySplineEntity(this.Lo.SplineEntityId,this.Hnr);var t=ModelManager_1.ModelManager.CreatureModel.GetCompleteEntityData(this.Lo.SplineEntityId);void 0===t?Log_1.Log.CheckError()&&Log_1.Log.Error("SceneItem",31,"[GamePlayWalkingPatternComponent]找不到entityData",["SplineEntityId",this.Lo.SplineEntityId]):void 0===(t=(0,IComponent_1.getComponent)(t.ComponentsData,"SplineComponent"))?Log_1.Log.CheckError()&&Log_1.Log.Error("SceneItem",31,"[GamePlayWalkingPatternComponent]找不到SplineComponent",["SplineEntityId",this.Lo.SplineEntityId]):t.Option.Type!==IComponent_1.ESplineType.Effect?Log_1.Log.CheckError()&&Log_1.Log.Error("SceneItem",31,"[GamePlayWalkingPatternComponent]引用的样条不是Effect类型",["SplineEntityId",this.Lo.SplineEntityId]):(this.BFl=t.Option.Effect,this.qFl=this.Lo.SpineEffectExistDuration,this.jFl=this.Lo.ReplaySpineEffect)}$Fl(){var t=ModelManager_1.ModelManager.CreatureModel.GetEntityByPbDataId(this.Lo.EndEntityId);t?.Valid&&t.Entity?.Valid?(this.qsh=t.Entity,EventSystem_1.EventSystem.AddWithTarget(this.qsh,EventDefine_1.EEventName.OnMyPlayerInOutRangeLocal,this.Etn)):Log_1.Log.CheckError()&&Log_1.Log.Error("BehaviorTree",31,"[WalkingPatternBehaviorNode]找不到EndEntity",["EndEntityId",this.Lo.EndEntityId])}KFl(){var t=PreloadConfigStatementPart3_1.configGlobalConfigFromCsvByName.GetConfig("WalkingPattern.MinDist");t&&(this.Fsh=parseInt(t.Value)),(t=PreloadConfigStatementPart3_1.configGlobalConfigFromCsvByName.GetConfig("WalkingPattern.MaxDist"))&&(this.Hln=parseInt(t.Value)),(t=PreloadConfigStatementPart3_1.configGlobalConfigFromCsvByName.GetConfig("WalkingPattern.CheckPointDist"))&&(this.Wlh=parseInt(t.Value)),(t=PreloadConfigStatementPart3_1.configGlobalConfigFromCsvByName.GetConfig("WalkingPattern.StepNum"))&&(this.OFl=parseInt(t.Value)),(t=PreloadConfigStatementPart3_1.configGlobalConfigFromCsvByName.GetConfig("WalkingPattern.RecordMinDist"))&&(this.NFl=parseInt(t.Value))}mSe(){EventSystem_1.EventSystem.AddWithTarget(this.Entity,EventDefine_1.EEventName.OnSceneItemStateChange,this.g_n)}OnTick(t){var e=Global_1.Global.BaseCharacter;e&&(this.Nme.FromUeVector(e.D_K2_GetActorLocation()),void 0!==this.FFl&&Vector_1.Vector.Dist2D(this.FFl,this.Nme)<this.NFl||(this.FFl=Vector_1.Vector.Create(this.Nme),this.Klh(),this.Wsh(),this.XFl()))}Klh(){var t,e;void 0===this.zie||this.Qlh>=this.wdt||(t=MathUtils_1.MathUtils.Clamp(this.Qlh,0,this.wdt-1),e=Vector_1.Vector.Create(this.zie?.D_GetLocationAtSplinePoint(t,1)),Vector_1.Vector.Dist2D(this.Nme,e)<this.Wlh&&(this.Qlh=t+1))}Wsh(){var t;void 0!==this.zie&&(this.Hsh.FromUeVector(this.zie.D_FindLocationClosestToWorldLocation(this.Nme.ToUeVector(),1)),t=Vector_1.Vector.Dist2D(this.Nme,this.Hsh),this.Nsh+=t,this.ksh++)}XFl(){var t,e;void 0!==Global_1.Global.BaseCharacter&&void 0!==this.Hte&&((t=Vector_1.Vector.Create(this.Nme)).SubtractionEqual(this.Hte.ActorLocationProxy),this.VFl.Size>=this.OFl&&this.VFl.Pop(),void 0!==(e=Global_1.Global.BaseCharacter.CharacterActorComponent?.HalfHeight)&&(t.Z-=e),this.VFl.Push(t))}OnEnd(){return this.YFl(),this.zFl(),this.dSe(),!0}dSe(){EventSystem_1.EventSystem.RemoveWithTarget(this.Entity,EventDefine_1.EEventName.OnSceneItemStateChange,this.g_n)}WFl(t){switch(951335035===t?this.bFl&&(this.Enable(this.bFl,"GamePlayWalkingPatternComponent 激活态开启Tick"),this.bFl=void 0):(void 0===this.bFl&&(this.bFl=this.Disable("GamePlayWalkingPatternComponent 非激活态关闭Tick")),void 0!==this.qsh&&EventSystem_1.EventSystem.HasWithTarget(this.qsh,EventDefine_1.EEventName.OnMyPlayerInOutRangeLocal,this.Etn)&&EventSystem_1.EventSystem.RemoveWithTarget(this.qsh,EventDefine_1.EEventName.OnMyPlayerInOutRangeLocal,this.Etn)),1052000749!==t&&this.zFl(),t){case 984890273:this.YFl(),this.zFl();break;case 934557416:this.JFl(),this.ZFl();break;case 951335035:this.$Fl(),this.ZFl(!1,this.qFl);break;case 1035223130:this.ZFl();break;case 1052000749:this.ZFl(!1),this.e3l()}}JFl(){this.ksh=0,this.Nsh=0,this.r$t=!1,this.wdt=this.zie?.GetNumberOfSplinePoints()??-1,this.Qlh=0}ZFl(t=!0,e=void 0){if(this.kFl&&(TimerSystem_1.TimerSystem.Remove(this.kFl),this.kFl=void 0),t)this.GFl&&this.YFl();else if(this.GFl)return void(void 0!==e&&(this.kFl=TimerSystem_1.TimerSystem.Delay(()=>{this.YFl()},e*TimeUtil_1.TimeUtil.InverseMillisecond)));this.GFl=EffectSystem_1.EffectSystem.SpawnEffect(GlobalData_1.GlobalData.World,MathUtils_1.MathUtils.DefaultTransformDouble,this.BFl,"WalkingPattern"),EffectSystem_1.EffectSystem.GetEffectActor(this.GFl).K2_AttachToActor(this.Hnr,void 0,2,2,2,!1),void 0!==e&&(this.kFl=TimerSystem_1.TimerSystem.Delay(()=>{this.YFl()},e*TimeUtil_1.TimeUtil.InverseMillisecond))}YFl(){this.GFl&&(EffectSystem_1.EffectSystem.StopEffectById(this.GFl,"WalkingPattern.StopPreviewEffect",!1),this.GFl=void 0)}e3l(){if(void 0!==this.jFl){this.HFl&&this.zFl();for(var t=UE.NewArray(UE.VectorDouble);!this.VFl.Empty;){var e=this.VFl.Pop();t.Add(e.ToUeVector())}var i=GameSplineUtils_1.GameSplineUtils.GenerateGuideEffect(this.Hte.ActorLocationProxy,t,this.jFl);this.HFl=i?.EffectHandle}}zFl(){this.HFl&&(EffectSystem_1.EffectSystem.StopEffectById(this.HFl,"WalkingPattern.StopPlaybackEffect",!1),this.HFl=void 0)}EDe(){var t=Protocol_1.Aki.Protocol.de1.create();t.ORs=ModelManager_1.ModelManager.CreatureModel.GetWorldOwner(),t.F4n=this.Hte.CreatureData.GetCreatureDataId(),t.Eps=this.Vsh,Net_1.Net.Call(22499,t,t=>{t?.Q4n!==Protocol_1.Aki.Protocol.Q4n.KRs&&ControllerHolder_1.ControllerHolder.ErrorCodeController.OpenErrorCodeTipView(t.Q4n,17145)})}};GamePlayWalkingPatternComponent=GamePlayWalkingPatternComponent_1=__decorate([(0,RegisterComponent_1.RegisterComponent)(253)],GamePlayWalkingPatternComponent),exports.GamePlayWalkingPatternComponent=GamePlayWalkingPatternComponent;
//# sourceMappingURL=GamePlayWalkingPatternComponent.js.map