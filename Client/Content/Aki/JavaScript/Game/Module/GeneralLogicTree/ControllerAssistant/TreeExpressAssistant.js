
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TreeExpressAssistant=void 0;const Protocol_1=require("../../../../Core/Define/Net/Protocol"),IQuest_1=require("../../../../UniverseEditor/Interface/IQuest"),EventDefine_1=require("../../../Common/Event/EventDefine"),EventSystem_1=require("../../../Common/Event/EventSystem"),PublicUtil_1=require("../../../Common/PublicUtil"),LevelGamePlayUtils_1=require("../../../LevelGamePlay/LevelGamePlayUtils"),LevelGeneralContextDefine_1=require("../../../LevelGamePlay/LevelGeneralContextDefine"),ConfigManager_1=require("../../../Manager/ConfigManager"),ModelManager_1=require("../../../Manager/ModelManager"),InteractBehaviorNode_1=require("../BehaviorNode/ChildQuestNode/InteractBehaviorNode"),ControllerAssistantBase_1=require("./ControllerAssistantBase"),ONE_HUNDRED=100;class TreeExpressAssistant extends ControllerAssistantBase_1.ControllerAssistantBase{constructor(){super(...arguments),this.eet=(e,t)=>{e&&this.ApplyOccupyTreeExpression(e.BtType,e.Id,e.IsInChallenge)},this.aYt=e=>{e&&this.ApplyOccupyTreeExpression(e.BtType,e.Id,e.IsInChallenge)}}OnDestroy(){}OnAddEvents(){EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.GeneralLogicTreeStartShowTrackText,this.eet),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.GeneralLogicTreeUpdateShowTrackText,this.aYt)}OnRemoveEvents(){EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.GeneralLogicTreeStartShowTrackText,this.eet),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.GeneralLogicTreeUpdateShowTrackText,this.aYt)}IsShowNodeStatus(e){let t=!1;switch(e.Type){case IQuest_1.EQuestScheduleType.ChildQuestCompleted:t=e.ShowComplete;break;case IQuest_1.EQuestScheduleType.TimeLeft:case IQuest_1.EQuestScheduleType.Condition:t=!0}return t}GetTitleTrackNodeId(e){let t=0;return t=e&&e.Type===IQuest_1.EQuestScheduleType.ChildQuestCompleted?e.ChildQuestId:t}IsShowTrackDistance(e,t){let r=!1;return r=t&&t.Type===IQuest_1.EQuestScheduleType.ChildQuestCompleted?!!this.IsShowNodeTrackDistance(e,t.ChildQuestId)&&t.ShowTracking:r}IsShowNodeTrackDistance(e,t){e=ModelManager_1.ModelManager.GeneralLogicTreeModel.GetBehaviorTree(e);return!!e&&(e.GetNode(t)?.ContainTag(0)??!1)}GetTitleText(t,r,e,a){let s=PublicUtil_1.PublicUtil.GetConfigTextByKey(r);var o=e;if(o){const _=ModelManager_1.ModelManager.GeneralLogicTreeModel.GetBehaviorTree(t);switch(o.Type){case IQuest_1.EQuestScheduleType.ChildQuestCompleted:var n=o;s=n.TitlePreState&&a?this.GetNodeTrackText(t,n.ChildQuestId,n.TitlePreState?.TidPreStateTitle,n.Vars,n.OnlyShowWhileRunning):this.GetNodeTrackText(t,n.ChildQuestId,r,n.Vars,n.OnlyShowWhileRunning);break;case IQuest_1.EQuestScheduleType.TimeLeft:s=PublicUtil_1.PublicUtil.GetConfigTextByKey(r),o.ShowTime&&(n=Math.floor(_.GetChallengeRemainTime(o.TimerType)),s=s.replace("{q_count}",""+n));break;case IQuest_1.EQuestScheduleType.EntityHP:var n=ModelManager_1.ModelManager.CreatureModel.GetEntityByPbDataId(o.EntityId);n&&(n=n.Entity.GetComponent(171))&&(i=n.GetCurrentValue(Protocol_1.Aki.Protocol.Vks.Proto_Life),n=n.GetCurrentValue(Protocol_1.Aki.Protocol.Vks.l5n),i=Math.floor(i/n*ONE_HUNDRED),s=(s=PublicUtil_1.PublicUtil.GetConfigTextByKey(r)).replace("{q_count}",i+"%"));break;case IQuest_1.EQuestScheduleType.ChildQuestCompletedCount:{const _=ModelManager_1.ModelManager.GeneralLogicTreeModel.GetBehaviorTree(t);if(!_)break;var n=PublicUtil_1.PublicUtil.GetConfigTextByKey(r),i=o.AssociatedChildQuestIds,l=i.length;let e=0;for(const u of i)_.GetNode(u)?.IsSuccess&&e++;s=`${n}(${e}/${l})`;break}case IQuest_1.EQuestScheduleType.Score:s=PublicUtil_1.PublicUtil.GetConfigTextByKey(r);i=this.ConvertStringToScoreTexture(ModelManager_1.ModelManager.ScoreModel.GetCurrentScore()?.toString());s=(s=s.replace("{currentScore}",""+i)).replace("{targetScore}",""+ModelManager_1.ModelManager.ScoreModel.GetTargetScore());break;case IQuest_1.EQuestScheduleType.TowerChallengeTitle:ModelManager_1.ModelManager.TowerModel.CheckInTower()&&(s=ModelManager_1.ModelManager.TowerModel.GetCurrentFloorName());break;case IQuest_1.EQuestScheduleType.Var:{const _=ModelManager_1.ModelManager.GeneralLogicTreeModel.GetBehaviorTree(t);if(!_)break;s=this.p2_(r,o.Var,void 0!==o.ShowAsWordArt,LevelGeneralContextDefine_1.GeneralLogicTreeContext.Create(_.BtType,_.TreeIncId,_.TreeConfigId));break}case IQuest_1.EQuestScheduleType.MultiVar:case IQuest_1.EQuestScheduleType.Condition:{const _=ModelManager_1.ModelManager.GeneralLogicTreeModel.GetBehaviorTree(t);if(!_)break;n=o.Vars;if(s=PublicUtil_1.PublicUtil.GetConfigTextByKey(r),!n||0===n.length)break;var c=o?.ShowAsWordArt;for(const v of n)s=this.p2_(s,v,void 0!==c,LevelGeneralContextDefine_1.GeneralLogicTreeContext.Create(_.BtType,_.TreeIncId,_.TreeConfigId));break}case IQuest_1.EQuestScheduleType.ProgressValue:var l=ModelManager_1.ModelManager.CreatureModel.GetEntityByPbDataId(o.TargetProgressEntity);l&&(i=l.Entity.GetComponent(127))&&(n=i.GetProgressData()?.CurrentValue??0,i=0===(l=i.GetProgressData()?.MaxValue??0)?0:Math.round(n/l*100),l=Math.round(n),s=(s=(s=PublicUtil_1.PublicUtil.GetConfigTextByKey(r)).replace("{percent}",i+"%")).replace("{real_progress}",""+l))}}return s}p2_(e,t,r,a){a=LevelGamePlayUtils_1.LevelGamePlayUtils.GetVarValue(t,a);return void 0===a?"":this.FormatStepTextByVarValue(e,t,a,r)}GetNodeTrackText(e,t,r,a,s){var o=ModelManager_1.ModelManager.GeneralLogicTreeModel.GetBehaviorTree(e);if(!o)return"";var n=o.GetNode(t);if(!n)return"";if(s&&!n.IsProcessing)return"";var i=r??n.TrackTextConfig;if(void 0===i||0===i.length)return"";let l=void 0;switch(n.TrackTextRule){case 0:l=PublicUtil_1.PublicUtil.GetConfigTextByKey(i);break;case 1:var c=PublicUtil_1.PublicUtil.GetConfigTextByKey(i),_=n.GetProgress()??"0",u=n.GetProgressMax()??"0";l=c.replace("{q_count}",_).replace("{q_countMax}",u);break;case 2:c=PublicUtil_1.PublicUtil.GetConfigTextByKey(i);l=n.GetCustomTrackText(c)}if(!(l="ChildQuest"===n.NodeType&&n instanceof InteractBehaviorNode_1.InteractBehaviorNode&&n.AlwaysFalseChildNode?n.OccupationInfo??l:l))return"";if(a&&0!==a.length)for(const v of a)l=this.p2_(l,v,!1,LevelGeneralContextDefine_1.GeneralLogicTreeContext.Create(o.BtType,o.TreeIncId,o.TreeConfigId));return l}FormatStepTextByVarValue(e,t,r,a){let s="",o=(s=PublicUtil_1.PublicUtil.GetConfigTextByKey(e),r.toString());switch(a&&"number"==typeof r&&(o=this.ConvertStringToScoreTexture(r.toString())),t.Source){case"Global":s=s.replace(`{${t.Keyword}}`,o);break;case"Other":case"Self":s=s.replace(`{${t.Name}}`,o)}return s=s.replace("{q_count}",o)}ConvertStringToScoreTexture(e){let t="";if(e)for(const a of e){var r=ConfigManager_1.ConfigManager.UiResourceConfig.GetResourcePath("T_Num"+a);t+=`<texture=${r}/>`}return t}ApplyOccupyTreeExpression(e,t,r){switch(e){case Protocol_1.Aki.Protocol.hps.Proto_BtTypeQuest:break;case Protocol_1.Aki.Protocol.hps.Proto_BtTypeInst:case Protocol_1.Aki.Protocol.hps.Proto_BtTypeLevelPlay:r&&this._Yt(t)}}_Yt(e){ModelManager_1.ModelManager.GeneralLogicTreeModel.ApplyExpressionOccupation(e)}TryReleaseExpressionOccupation(e){ModelManager_1.ModelManager.GeneralLogicTreeModel.TryReleaseExpressionOccupation(e)}}exports.TreeExpressAssistant=TreeExpressAssistant;
//# sourceMappingURL=TreeExpressAssistant.js.map