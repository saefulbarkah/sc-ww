
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TsPhotographer=void 0;const UE=require("ue"),Info_1=require("../../../Core/Common/Info"),CommonParamById_1=require("../../../Core/Define/ConfigCommon/CommonParamById"),QueryTypeDefine_1=require("../../../Core/Define/QueryTypeDefine"),ResourceSystem_1=require("../../../Core/Resource/ResourceSystem"),FNameUtil_1=require("../../../Core/Utils/FNameUtil"),Vector_1=require("../../../Core/Utils/Math/Vector"),MathUtils_1=require("../../../Core/Utils/MathUtils"),Global_1=require("../../Global"),GlobalData_1=require("../../GlobalData"),PhotographController_1=require("./PhotographController"),PhotographDefine_1=require("./PhotographDefine"),SOURCE_DISTANCE=300,CONFIG_PATH="/Game/Aki/Data/Camera/DA_FightCameraConfig.DA_FightCameraConfig",MOBILE_CONFIG_PATH="/Game/Aki/Data/Camera/DA_FightCameraConfig_Mobile.DA_FightCameraConfig_Mobile",MIN_DITHER=.01,HIDE_DISTANCE_OFFSET=50;class TsPhotographer extends UE.Actor{constructor(){super(...arguments),this.CapsuleCollision=void 0,this.CameraArm=void 0,this.CameraSphereTrace=void 0,this.CameraActor=void 0,this.ZeroVector=void 0,this.RelativeVectorCache=void 0,this.CameraToPlayerVectorCache=void 0,this.CameraToSourceVectorCache=void 0,this.MoveRotationCache=void 0,this.SourceRotationCache=void 0,this.PlayerSourceLocation=void 0,this.CameraInitializeTransform=void 0,this.SourceLocation=void 0,this.DefaultRotation=void 0,this.SourceMaxYaw=0,this.SourceMinYaw=0,this.SourceTotalYaw=0,this.SourceMaxPitch=0,this.SourceMinPitch=0,this.CameraArmUpVector=void 0,this.ActorUpVector=void 0,this.Character=void 0,this.StartDitherValue=0,this.StartHidePitch=0,this.CompleteHidePitch=0,this.IsLoadingConfigCompleted=!1,this.CurrentDither=0,this.PlayerLocation=void 0,this.CameraLocation=void 0,this.StartHideDistance=0,this.CompleteHideDistance=0,this.CameraUpAndDownMaxDistance=0,this.CameraLeftAndRightMaxDistance=0,this.CurCameraUpAndDownDistance=0,this.CurCameraLeftAndRightDistance=0}Constructor(){this.CameraSphereTrace=void 0,this.CameraActor=void 0,this.ZeroVector=void 0,this.RelativeVectorCache=void 0,this.CameraToPlayerVectorCache=void 0,this.CameraToSourceVectorCache=void 0,this.MoveRotationCache=void 0,this.SourceRotationCache=void 0,this.PlayerSourceLocation=void 0,this.CameraInitializeTransform=void 0,this.SourceLocation=void 0,this.DefaultRotation=void 0,this.SourceMaxYaw=0,this.SourceMinYaw=0,this.SourceTotalYaw=0,this.SourceMaxPitch=0,this.SourceMinPitch=0,this.CameraArmUpVector=void 0,this.ActorUpVector=void 0,this.Character=void 0,this.StartDitherValue=0,this.StartHidePitch=0,this.CompleteHidePitch=0,this.IsLoadingConfigCompleted=!1,this.CurrentDither=0,this.PlayerLocation=void 0,this.CameraLocation=void 0,this.StartHideDistance=0,this.CompleteHideDistance=0}Initialize(){this.ZeroVector=new UE.VectorDouble(0),this.RelativeVectorCache=new UE.Vector,this.CameraToPlayerVectorCache=new UE.VectorDouble,this.CameraToSourceVectorCache=new UE.VectorDouble,this.MoveRotationCache=new UE.Rotator,this.SourceRotationCache=new UE.Rotator,this.SourceLocation=new UE.Vector,this.DefaultRotation=new UE.Rotator(0,0,0),this.CameraLocation=Vector_1.Vector.Create(),this.PlayerLocation=Vector_1.Vector.Create(),this.SourceMaxYaw=CommonParamById_1.configCommonParamById.GetIntConfig("CameraSourceMaxYaw"),this.SourceMinYaw=CommonParamById_1.configCommonParamById.GetIntConfig("CameraSourceMinYaw"),this.SourceMaxPitch=CommonParamById_1.configCommonParamById.GetIntConfig("CameraSourceMaxPitch"),this.SourceMinPitch=CommonParamById_1.configCommonParamById.GetIntConfig("CameraSourceMinPitch"),this.CameraUpAndDownMaxDistance=CommonParamById_1.configCommonParamById.GetIntConfig("CameraUpAndDownDistance"),this.CameraLeftAndRightMaxDistance=CommonParamById_1.configCommonParamById.GetIntConfig("CameraLeftAndRightDistance"),this.SourceTotalYaw=0,this.CurCameraUpAndDownDistance=0,this.CurCameraLeftAndRightDistance=0,this.CurrentDither=0,this.CameraArmUpVector=new UE.VectorDouble(0,0,1),this.ActorUpVector=new UE.VectorDouble(0,0,1),this.Character=Global_1.Global.BaseCharacter,this.PlayerLocation.FromUeVector(this.Character.D_K2_GetActorLocation()),this.IsLoadingConfigCompleted=!1;var t=Info_1.Info.IsMobilePlatform()?MOBILE_CONFIG_PATH:CONFIG_PATH;ResourceSystem_1.ResourceSystem.LoadAsync(t,UE.BP_FightCameraConfig_C,t=>{var t=t.基础,i=(this.StartHidePitch=t.Get(42),t.Get(40)),h=t.Get(41);this.StartHideDistance=Math.max(i,h)+HIDE_DISTANCE_OFFSET,this.CompleteHideDistance=Math.min(i,h)+HIDE_DISTANCE_OFFSET,this.CompleteHidePitch=t.Get(43),this.StartDitherValue=t.Get(44),this.IsLoadingConfigCompleted=!0}),this.CameraSphereTrace=UE.NewObject(UE.TraceSphereElement.StaticClass()),this.CameraSphereTrace.bIsSingle=!1,this.CameraSphereTrace.bTraceComplex=!1,this.CameraSphereTrace.bIgnoreSelf=!0,this.CameraSphereTrace.SetTraceTypeQuery(QueryTypeDefine_1.KuroTraceTypeQuery.Camera),this.CameraSphereTrace.ActorsToIgnore.Add(this.Character),this.CameraSphereTrace.WorldContextObject=GlobalData_1.GlobalData.World,this.CameraSphereTrace.Radius=this.CameraArm.ProbeSize,this.RefreshDitherEffect()}ReceiveDestroyed(){this.Character=void 0,this.IsLoadingConfigCompleted=!1}ReceiveTick(t){this.RefreshDitherEffect()}RefreshDitherEffect(){var t;this.IsLoadingConfigCompleted&&this.CameraActor&&this.CameraArm&&(t=this.CameraActor.D_K2_GetActorLocation(),this.CameraLocation.FromUeVector(t),t=Vector_1.Vector.Dist(this.PlayerLocation,this.CameraLocation),t=this.GetPlayerDither(t,this.CameraArm.GetTargetRotation().Pitch),this.CurrentDither!==t)&&(this.CurrentDither=t,this.Character.SetDitherEffect(t,1))}GetPlayerDither(t,i){let h=1;t<this.StartHideDistance&&(h=MathUtils_1.MathUtils.RangeClamp(t,this.StartHideDistance,this.CompleteHideDistance,this.StartDitherValue,MIN_DITHER));t=MathUtils_1.MathUtils.WrapAngle(i);let s=1;return t>this.StartHidePitch&&(s=MathUtils_1.MathUtils.RangeClamp(t,this.StartHidePitch,this.CompleteHidePitch,this.StartDitherValue,MIN_DITHER)),Math.min(h,s)}SetPlayerSourceLocation(t){this.PlayerSourceLocation=t}SetCameraInitializeTransform(t){this.CameraInitializeTransform=t}GetCameraInitializeTransform(){return this.CameraInitializeTransform}ActivateCamera(t){t.K2_AttachToComponent(this.CameraArm,FNameUtil_1.FNameUtil.NONE,2,2,2,!1),this.CameraActor=t,this.SetFov(PhotographDefine_1.DEFAULT_FOV)}DeactivateCamera(){this.CameraActor?.IsValid()&&this.CameraActor.K2_DetachFromActor(1,1,1),this.CameraActor=void 0}SetCameraTransform(t){var t=t.GetTranslation(),i=this.CameraActor.D_K2_GetActorLocation();this.RelativeVectorCache.X=t.X-i.X,this.RelativeVectorCache.Y=t.Y-i.Y,this.RelativeVectorCache.Z=t.Z-i.Z,this.K2_AddActorWorldOffset(this.RelativeVectorCache,!1,void 0,!1)}MoveUp(t){var i;Math.abs(this.CurCameraUpAndDownDistance+t)<this.CameraUpAndDownMaxDistance&&(i=Vector_1.Vector.UpVector,this.CurCameraUpAndDownDistance+=t,i=i.op_Multiply(t),this.CameraArm.SocketOffset=this.CameraArm.SocketOffset.op_Addition(i))}MoveRight(t){var i;Math.abs(this.CurCameraLeftAndRightDistance+t)<this.CameraLeftAndRightMaxDistance&&(i=Vector_1.Vector.RightVector,this.CurCameraLeftAndRightDistance+=t,i=i.op_Multiply(t),this.CameraArm.SocketOffset=this.CameraArm.SocketOffset.op_Addition(i))}AddCameraArmPitchInput(t){var i,h;0===t||(i=this.CameraArm.GetTargetRotation().Pitch,0<t&&i<=this.SourceMinPitch)||t<0&&i>=this.SourceMaxPitch||(i=this.CameraArm.D_GetRightVector(),h=this.CameraArm.D_GetForwardVector(),h=UE.KismetMathLibrary.D_RotateAngleAxis(h,t,i),t=UE.KismetMathLibrary.D_FindLookAtRotation(this.ZeroVector,h),this.CapsuleCollision.K2_SetRelativeRotation(t,!1,void 0,!1))}AddCameraArmYawInput(t){var i;0!==t&&(i=this.CameraArm.D_GetForwardVector(),i=UE.KismetMathLibrary.D_RotateAngleAxis(i,t,this.CameraArmUpVector),t=UE.KismetMathLibrary.D_FindLookAtRotation(this.ZeroVector,i),this.CapsuleCollision.K2_SetRelativeRotation(t,!1,void 0,!1))}AddPhotographerYawInput(t){var i=this.PlayerSourceLocation,h=this.D_K2_GetActorLocation(),h=(this.CameraToPlayerVectorCache.X=h.X-i.X,this.CameraToPlayerVectorCache.Y=h.Y-i.Y,this.CameraToPlayerVectorCache.Z=h.Z-i.Z,this.SourceRotationCache.Yaw=t,this.SourceRotationCache.Pitch=0,this.SourceRotationCache.Roll=0,UE.KismetMathLibrary.D_GreaterGreater_VectorRotator(this.CameraToPlayerVectorCache,this.SourceRotationCache));h.X+=i.X,h.Y+=i.Y,h.Z+=i.Z,this.D_K2_SetActorLocation(h,!0,void 0,!1)}AddSourceYawInput(t){var i,h;this.SourceTotalYaw=MathUtils_1.MathUtils.Clamp(this.SourceTotalYaw+t,this.SourceMinYaw,this.SourceMaxYaw),this.SourceTotalYaw>=this.SourceMaxYaw||this.SourceTotalYaw<=this.SourceMinYaw||(h=this.D_K2_GetActorLocation(),i=this.CameraArm.D_GetForwardVector(),this.SourceLocation.X=i.X*-SOURCE_DISTANCE+h.X,this.SourceLocation.Y=i.Y*-SOURCE_DISTANCE+h.Y,this.SourceLocation.Z=i.Z*-SOURCE_DISTANCE+h.Z,this.CameraToSourceVectorCache.X=h.X-this.SourceLocation.X,this.CameraToSourceVectorCache.Y=h.Y-this.SourceLocation.Y,this.CameraToSourceVectorCache.Z=h.Z-this.SourceLocation.Z,this.MoveRotationCache.Yaw=t,this.MoveRotationCache.Pitch=0,this.MoveRotationCache.Roll=0,(i=UE.KismetMathLibrary.D_GreaterGreater_VectorRotator(this.CameraToSourceVectorCache,this.MoveRotationCache)).X+=this.SourceLocation.X,i.Y+=this.SourceLocation.Y,i.Z+=this.SourceLocation.Z,this.D_K2_SetActorLocation(i,!0,void 0,!1),h=this.D_GetActorForwardVector(),i=UE.KismetMathLibrary.D_RotateAngleAxis(h,-t,this.ActorUpVector),h=UE.KismetMathLibrary.Conv_VectorToRotator(i.op_ToVector()),this.K2_SetActorRotation(h,!1))}AddSourcePitchInput(t){var i,h=this.K2_GetActorRotation().Pitch;0<t&&h<=this.SourceMinPitch||t<0&&h>=this.SourceMaxPitch||(h=this.GetActorRightVector(),i=this.GetActorForwardVector(),i=UE.KismetMathLibrary.RotateAngleAxis(i,t,h),h=(t=UE.KismetMathLibrary.Conv_VectorToRotator(i)).Pitch,t.Pitch=h,this.K2_SetActorRotation(t,!1))}SetFov(t){let i=50;i=1===PhotographController_1.PhotographController.CameraCaptureType?MathUtils_1.MathUtils.Clamp(t,PhotographController_1.PhotographController.MinFov?PhotographController_1.PhotographController.MinFov.Value:PhotographDefine_1.MIN_FOV,PhotographController_1.PhotographController.MaxFov?PhotographController_1.PhotographController.MaxFov.Value:PhotographDefine_1.MAX_FOV):MathUtils_1.MathUtils.Clamp(t,PhotographDefine_1.MIN_FOV,PhotographDefine_1.MAX_FOV),this.CameraActor.CameraComponent.SetFieldOfView(i)}GetFov(){return this.CameraActor.CameraComponent.FieldOfView}ResetCamera(){this.CapsuleCollision.K2_SetRelativeRotation(this.DefaultRotation,!0,void 0,!1),this.D_K2_SetActorTransform(this.CameraInitializeTransform,!0,void 0,!1),this.D_K2_SetActorLocation(this.PlayerSourceLocation,!0,void 0,!1),this.SetFov(PhotographDefine_1.DEFAULT_FOV),this.CameraArm.SocketOffset=Vector_1.Vector.ZeroVector,this.SourceTotalYaw=0,this.CurCameraUpAndDownDistance=0,this.CurCameraLeftAndRightDistance=0,this.CurrentDither=0}SetCameraLUT(t){this.CameraActor&&(0===t.length?this.CameraActor.CameraComponent.PostProcessSettings.bOverride_ColorGradingLUT=!1:(this.CameraActor.CameraComponent.PostProcessSettings.bOverride_ColorGradingLUT=!0,ResourceSystem_1.ResourceSystem.LoadAsync(t,UE.Texture,t=>{this.CameraActor.CameraComponent.PostProcessSettings.ColorGradingLUT=t})))}}exports.TsPhotographer=TsPhotographer,exports.default=TsPhotographer;
//# sourceMappingURL=TsPhotographer.js.map