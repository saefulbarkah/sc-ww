
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TsPhotographer=void 0;const UE=require("ue"),Info_1=require("../../../Core/Common/Info"),CommonParamById_1=require("../../../Core/Define/ConfigCommon/CommonParamById"),ResourceSystem_1=require("../../../Core/Resource/ResourceSystem"),FNameUtil_1=require("../../../Core/Utils/FNameUtil"),Vector_1=require("../../../Core/Utils/Math/Vector"),MathUtils_1=require("../../../Core/Utils/MathUtils"),Global_1=require("../../Global"),PhotographController_1=require("./PhotographController"),PhotographDefine_1=require("./PhotographDefine"),SOURCE_DISTANCE=300,CONFIG_PATH="/Game/Aki/Data/Camera/DA_FightCameraConfig.DA_FightCameraConfig",MOBILE_CONFIG_PATH="/Game/Aki/Data/Camera/DA_FightCameraConfig_Mobile.DA_FightCameraConfig_Mobile",MIN_DITHER=.01,HIDE_DISTANCE_OFFSET=50;class TsPhotographer extends UE.Actor{constructor(){super(...arguments),this.CapsuleCollision=void 0,this.CameraArm=void 0,this.CameraActor=void 0,this.ZeroVector=void 0,this.RelativeVectorCache=void 0,this.CameraToPlayerVectorCache=void 0,this.CameraToSourceVectorCache=void 0,this.MoveRotationCache=void 0,this.SourceRotationCache=void 0,this.PlayerSourceLocation=void 0,this.CameraInitializeTransform=void 0,this.SourceLocation=void 0,this.DefaultRotation=void 0,this.SourceMaxYaw=0,this.SourceMinYaw=0,this.SourceTotalYaw=0,this.SourceMaxPitch=0,this.SourceMinPitch=0,this.CameraArmUpVector=void 0,this.ActorUpVector=void 0,this.Character=void 0,this.StartDitherValue=0,this.StartHidePitch=0,this.CompleteHidePitch=0,this.IsLoadingConfigCompleted=!1,this.CurrentDither=0,this.PlayerLocation=void 0,this.CameraLocation=void 0,this.StartHideDistance=0,this.CompleteHideDistance=0}Constructor(){this.CameraActor=void 0,this.ZeroVector=void 0,this.RelativeVectorCache=void 0,this.CameraToPlayerVectorCache=void 0,this.CameraToSourceVectorCache=void 0,this.MoveRotationCache=void 0,this.SourceRotationCache=void 0,this.PlayerSourceLocation=void 0,this.CameraInitializeTransform=void 0,this.SourceLocation=void 0,this.DefaultRotation=void 0,this.SourceMaxYaw=0,this.SourceMinYaw=0,this.SourceTotalYaw=0,this.SourceMaxPitch=0,this.SourceMinPitch=0,this.CameraArmUpVector=void 0,this.ActorUpVector=void 0,this.Character=void 0,this.StartDitherValue=0,this.StartHidePitch=0,this.CompleteHidePitch=0,this.IsLoadingConfigCompleted=!1,this.CurrentDither=0,this.PlayerLocation=void 0,this.CameraLocation=void 0,this.StartHideDistance=0,this.CompleteHideDistance=0}Initialize(){this.ZeroVector=new UE.VectorDouble(0),this.RelativeVectorCache=new UE.Vector,this.CameraToPlayerVectorCache=new UE.VectorDouble,this.CameraToSourceVectorCache=new UE.VectorDouble,this.MoveRotationCache=new UE.Rotator,this.SourceRotationCache=new UE.Rotator,this.SourceLocation=new UE.Vector,this.DefaultRotation=new UE.Rotator(0,0,0),this.CameraLocation=Vector_1.Vector.Create(),this.PlayerLocation=Vector_1.Vector.Create(),this.SourceMaxYaw=CommonParamById_1.configCommonParamById.GetIntConfig("CameraSourceMaxYaw"),this.SourceMinYaw=CommonParamById_1.configCommonParamById.GetIntConfig("CameraSourceMinYaw"),this.SourceMaxPitch=CommonParamById_1.configCommonParamById.GetIntConfig("CameraSourceMaxPitch"),this.SourceMinPitch=CommonParamById_1.configCommonParamById.GetIntConfig("CameraSourceMinPitch"),this.SourceTotalYaw=0,this.CameraArmUpVector=new UE.VectorDouble(0,0,1),this.ActorUpVector=new UE.VectorDouble(0,0,1),this.Character=Global_1.Global.BaseCharacter,this.PlayerLocation.FromUeVector(this.Character.D_K2_GetActorLocation()),this.IsLoadingConfigCompleted=!1;var i=Info_1.Info.IsMobilePlatform()?MOBILE_CONFIG_PATH:CONFIG_PATH;ResourceSystem_1.ResourceSystem.LoadAsync(i,UE.BP_FightCameraConfig_C,i=>{var i=i.基础,t=(this.StartHidePitch=i.Get(42),i.Get(40)),h=i.Get(41);this.StartHideDistance=Math.max(t,h)+HIDE_DISTANCE_OFFSET,this.CompleteHideDistance=Math.min(t,h)+HIDE_DISTANCE_OFFSET,this.CompleteHidePitch=i.Get(43),this.StartDitherValue=i.Get(44),this.IsLoadingConfigCompleted=!0}),this.RefreshDitherEffect()}ReceiveDestroyed(){this.Character=void 0,this.IsLoadingConfigCompleted=!1}ReceiveTick(i){this.RefreshDitherEffect()}RefreshDitherEffect(){var i;this.IsLoadingConfigCompleted&&this.CameraActor&&this.CameraArm&&(i=this.CameraActor.D_K2_GetActorLocation(),this.CameraLocation.FromUeVector(i),i=Vector_1.Vector.Dist(this.PlayerLocation,this.CameraLocation),i=this.GetPlayerDither(i,this.CameraArm.GetTargetRotation().Pitch),this.CurrentDither!==i)&&(this.CurrentDither=i,this.Character.SetDitherEffect(i,1))}GetPlayerDither(i,t){let h=1;i<this.StartHideDistance&&(h=MathUtils_1.MathUtils.RangeClamp(i,this.StartHideDistance,this.CompleteHideDistance,this.StartDitherValue,MIN_DITHER));i=MathUtils_1.MathUtils.WrapAngle(t);let s=1;return i>this.StartHidePitch&&(s=MathUtils_1.MathUtils.RangeClamp(i,this.StartHidePitch,this.CompleteHidePitch,this.StartDitherValue,MIN_DITHER)),Math.min(h,s)}SetPlayerSourceLocation(i){this.PlayerSourceLocation=i}SetCameraInitializeTransform(i){this.CameraInitializeTransform=i}GetCameraInitializeTransform(){return this.CameraInitializeTransform}ActivateCamera(i){i.K2_AttachToComponent(this.CameraArm,FNameUtil_1.FNameUtil.NONE,2,2,2,!1),this.CameraActor=i,this.SetFov(PhotographDefine_1.DEFAULT_FOV)}DeactivateCamera(){this.CameraActor?.IsValid()&&this.CameraActor.K2_DetachFromActor(1,1,1),this.CameraActor=void 0}SetCameraTransform(i){var i=i.GetTranslation(),t=this.CameraActor.D_K2_GetActorLocation();this.RelativeVectorCache.X=i.X-t.X,this.RelativeVectorCache.Y=i.Y-t.Y,this.RelativeVectorCache.Z=i.Z-t.Z,this.K2_AddActorWorldOffset(this.RelativeVectorCache,!1,void 0,!1)}AddCameraArmPitchInput(i){var t,h;0===i||(t=this.CameraArm.GetTargetRotation().Pitch,0<i&&t<=this.SourceMinPitch)||i<0&&t>=this.SourceMaxPitch||(t=this.CameraArm.D_GetRightVector(),h=this.CameraArm.D_GetForwardVector(),h=UE.KismetMathLibrary.D_RotateAngleAxis(h,i,t),i=UE.KismetMathLibrary.D_FindLookAtRotation(this.ZeroVector,h),this.CapsuleCollision.K2_SetRelativeRotation(i,!1,void 0,!1))}AddCameraArmYawInput(i){var t;0!==i&&(t=this.CameraArm.D_GetForwardVector(),t=UE.KismetMathLibrary.D_RotateAngleAxis(t,i,this.CameraArmUpVector),i=UE.KismetMathLibrary.D_FindLookAtRotation(this.ZeroVector,t),this.CapsuleCollision.K2_SetRelativeRotation(i,!1,void 0,!1))}AddPhotographerYawInput(i){var t=this.PlayerSourceLocation,h=this.D_K2_GetActorLocation(),h=(this.CameraToPlayerVectorCache.X=h.X-t.X,this.CameraToPlayerVectorCache.Y=h.Y-t.Y,this.CameraToPlayerVectorCache.Z=h.Z-t.Z,this.SourceRotationCache.Yaw=i,this.SourceRotationCache.Pitch=0,this.SourceRotationCache.Roll=0,UE.KismetMathLibrary.D_GreaterGreater_VectorRotator(this.CameraToPlayerVectorCache,this.SourceRotationCache));h.X+=t.X,h.Y+=t.Y,h.Z+=t.Z,this.D_K2_SetActorLocation(h,!0,void 0,!1)}AddSourceYawInput(i){var t,h;this.SourceTotalYaw=MathUtils_1.MathUtils.Clamp(this.SourceTotalYaw+i,this.SourceMinYaw,this.SourceMaxYaw),this.SourceTotalYaw>=this.SourceMaxYaw||this.SourceTotalYaw<=this.SourceMinYaw||(h=this.D_K2_GetActorLocation(),t=this.CameraArm.D_GetForwardVector(),this.SourceLocation.X=t.X*-SOURCE_DISTANCE+h.X,this.SourceLocation.Y=t.Y*-SOURCE_DISTANCE+h.Y,this.SourceLocation.Z=t.Z*-SOURCE_DISTANCE+h.Z,this.CameraToSourceVectorCache.X=h.X-this.SourceLocation.X,this.CameraToSourceVectorCache.Y=h.Y-this.SourceLocation.Y,this.CameraToSourceVectorCache.Z=h.Z-this.SourceLocation.Z,this.MoveRotationCache.Yaw=i,this.MoveRotationCache.Pitch=0,this.MoveRotationCache.Roll=0,(t=UE.KismetMathLibrary.D_GreaterGreater_VectorRotator(this.CameraToSourceVectorCache,this.MoveRotationCache)).X+=this.SourceLocation.X,t.Y+=this.SourceLocation.Y,t.Z+=this.SourceLocation.Z,this.D_K2_SetActorLocation(t,!0,void 0,!1),h=this.D_GetActorForwardVector(),t=UE.KismetMathLibrary.D_RotateAngleAxis(h,-i,this.ActorUpVector),h=UE.KismetMathLibrary.Conv_VectorToRotator(t.op_ToVector()),this.K2_SetActorRotation(h,!1))}AddSourcePitchInput(i){var t,h=this.K2_GetActorRotation().Pitch;0<i&&h<=this.SourceMinPitch||i<0&&h>=this.SourceMaxPitch||(h=this.GetActorRightVector(),t=this.GetActorForwardVector(),t=UE.KismetMathLibrary.RotateAngleAxis(t,i,h),h=(i=UE.KismetMathLibrary.Conv_VectorToRotator(t)).Pitch,i.Pitch=h,this.K2_SetActorRotation(i,!1))}SetFov(i){let t=50;t=1===PhotographController_1.PhotographController.CameraCaptureType?MathUtils_1.MathUtils.Clamp(i,PhotographController_1.PhotographController.MinFov?PhotographController_1.PhotographController.MinFov.Value:PhotographDefine_1.MIN_FOV,PhotographController_1.PhotographController.MaxFov?PhotographController_1.PhotographController.MaxFov.Value:PhotographDefine_1.MAX_FOV):MathUtils_1.MathUtils.Clamp(i,PhotographDefine_1.MIN_FOV,PhotographDefine_1.MAX_FOV),this.CameraActor.CameraComponent.SetFieldOfView(t)}GetFov(){return this.CameraActor.CameraComponent.FieldOfView}ResetCamera(){var i=Global_1.Global.BaseCharacter.D_GetTransform();this.CapsuleCollision.K2_SetRelativeRotation(this.DefaultRotation,!0,void 0,!1),this.D_K2_SetActorTransform(i,!0,void 0,!1),this.D_K2_SetActorLocation(this.PlayerSourceLocation,!0,void 0,!1),this.K2_AddActorWorldRotation(new UE.Rotator(0,180,0),!0,void 0,!1),this.SetFov(PhotographDefine_1.DEFAULT_FOV),this.SourceTotalYaw=0}}exports.TsPhotographer=TsPhotographer,exports.default=TsPhotographer;
//# sourceMappingURL=TsPhotographer.js.map