
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.LordGymPanel=void 0;const UE=require("ue"),Log_1=require("../../../../../Core/Common/Log"),DropPackageById_1=require("../../../../../Core/Define/ConfigQuery/DropPackageById"),ExchangeRewardById_1=require("../../../../../Core/Define/ConfigQuery/ExchangeRewardById"),LordGymEntranceGroupByMarkId_1=require("../../../../../Core/Define/ConfigQuery/LordGymEntranceGroupByMarkId"),LordGymEntranceSetByMarkId_1=require("../../../../../Core/Define/ConfigQuery/LordGymEntranceSetByMarkId"),MapMarkByMarkId_1=require("../../../../../Core/Define/ConfigQuery/MapMarkByMarkId"),MonsterInfoById_1=require("../../../../../Core/Define/ConfigQuery/MonsterInfoById"),MultiTextLang_1=require("../../../../../Core/Define/ConfigQuery/MultiTextLang"),Protocol_1=require("../../../../../Core/Define/Net/Protocol"),TimerSystem_1=require("../../../../../Core/Timer/TimerSystem"),StringUtils_1=require("../../../../../Core/Utils/StringUtils"),ConfigManager_1=require("../../../../Manager/ConfigManager"),ModelManager_1=require("../../../../Manager/ModelManager"),UiManager_1=require("../../../../Ui/UiManager"),ButtonItem_1=require("../../../Common/Button/ButtonItem"),LevelPlay_1=require("../../../LevelPlay/LevelPlay"),MapController_1=require("../../../Map/Controller/MapController"),MarkUiUtils_1=require("../../../Map/Mark/Misc/MarkUiUtils"),TeleportController_1=require("../../../Teleport/TeleportController"),GridProxyAbstract_1=require("../../../Util/Grid/GridProxyAbstract"),GenericLayout_1=require("../../../Util/Layout/GenericLayout"),LguiUtil_1=require("../../../Util/LguiUtil"),WorldMapSecondaryUi_1=require("../../ViewComponent/WorldMapSecondaryUi"),WorldMapController_1=require("../../WorldMapController"),WorldMapDefine_1=require("../../WorldMapDefine"),MapTipsActivateTipPanel_1=require("../Common/MapTipsActivateTipPanel"),SceneGameplayTipGrid_1=require("../SceneGameplayPanel/SceneGameplayTipGrid"),LordGymDifficultyStateItem_1=require("./LordGymDifficultyStateItem");class LordGymPanel extends WorldMapSecondaryUi_1.WorldMapSecondaryUi{constructor(){super(...arguments),this.Jbl=!1,this.Ymt=void 0,this.u2o=void 0,this.O2o=void 0,this.k2o=void 0,this.F2o=void 0,this.V2o=void 0,this.IRe=void 0,this.H2o=void 0,this.ZAt=void 0,this.j2o=!1,this.y8a=void 0,this.I8a=void 0,this.mth=void 0,this.OnCreateDifficultyItem=()=>new DifficultyItem,this.OnConfirmBtnClick=()=>{this.u2o&&(!this.u2o.IsLocked&&this.Jbl?(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Map",43,"[地图系统]CommonGamePlayPanel->传送",["markId",this.u2o.MarkId],["IsTracked",this.u2o.IsTracked]),WorldMapController_1.WorldMapController.TryTeleport(this.u2o.MarkConfigId)):(this.CheckAndShowCrossMapTips(this.u2o),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Map",43,"[地图系统]CommonGamePlayPanel->追踪",["markId",this.u2o.MarkId],["IsTracked",this.u2o.IsTracked]),MapController_1.MapController.RequestTrackMapMark(this.u2o.MarkType,this.u2o.MarkId,!this.u2o.IsTracked),this.Close()))},this.UOe=()=>{var e=ModelManager_1.ModelManager.MapModel.IsLevelPlayOccupied(this.Ymt.Id);e.IsOccupied&&(e=ModelManager_1.ModelManager.GeneralLogicTreeModel.GetBehaviorTree(e.QuestId),UiManager_1.UiManager.OpenView("QuestView",e.TreeConfigId))},this.T8a=()=>{var e=MarkUiUtils_1.MarkUiUtils.FindNearbyValidGotoMark(this.Map,this.u2o);e&&MarkUiUtils_1.MarkUiUtils.QuickGotoTeleport(this.u2o,e,()=>{this.Close()})},this.P8e=()=>{this.CheckAndShowCrossMapTips(this.u2o);var e=this.u2o;Log_1.Log.CheckInfo()&&Log_1.Log.Info("Map",63,"[地图系统]SceneGameplayPanel->追踪标记",["markId",e.MarkId],["IsTracked",e.IsTracked]),MapController_1.MapController.RequestTrackMapMark(e.MarkType,e.MarkId,!e.IsTracked),this.Close()}}GetResourceId(){return"UiView_InstanceEntranceTip_Prefab_2"}OnRegisterComponent(){this.ComponentRegisterInfos=WorldMapDefine_1.secondaryUiPanelComponentsRegisterInfoA,this.BtnBindInfo=[[15,this.UOe]]}async OnBeforeStartAsync(){return this.mth=new MapTipsActivateTipPanel_1.MapTipsActivateTipPanel,await this.mth.CreateByActorAsync(this.GetItem(31).GetOwner()),super.OnBeforeStartAsync()}OnStart(){this.RootItem.SetRaycastTarget(!1),this.H2o=new GenericLayout_1.GenericLayout(this.GetVerticalLayout(16),this.OnCreateDifficultyItem),this.H2o.SetActive(!0),this.ZAt=new ButtonItem_1.ButtonItem(this.GetButton(11).RootUIComp),this.ZAt.SetActive(!0),this.GetItem(32).SetUIActive(!1),this.ZAt.SetFunction(this.OnConfirmBtnClick),this.y8a=new ButtonItem_1.ButtonItem(this.GetButton(28).RootUIComp),this.y8a.SetFunction(this.P8e),this.I8a=new ButtonItem_1.ButtonItem(this.GetButton(29).RootUIComp),this.I8a.SetFunction(this.T8a)}OnBeforeDestroy(){this.H2o.ClearChildren(),this.AddChild(this.ZAt),this.y8a.Destroy(),this.I8a.Destroy(),this.mth.Destroy(),this.O2o&&(this.AddChild(this.O2o),this.O2o=void 0),this.k2o&&(this.AddChild(this.k2o),this.k2o=void 0),this.F2o=void 0,this.V2o=void 0}OnShowWorldMapSecondaryUi(e,t){e?(this.Jbl=t,this.u2o=e,this.SetSpriteByPath(this.u2o.IconPath,this.GetSprite(0),!1),this.Ymt=ModelManager_1.ModelManager.LevelPlayModel.GetLevelPlayInfo(e.MarkConfig.RelativeId),this.Ymt||(this.Ymt=new LevelPlay_1.LevelPlayInfo(e.MarkConfig.RelativeId),this.Ymt.InitConfig()),this.IRe=void 0,this.SHe(),this.l_i()):Log_1.Log.CheckError()&&Log_1.Log.Error("SceneGameplay",17,"玩法弹窗打开错误，地图标记不存在")}OnCloseWorldMapSecondaryUi(){this.IRe&&(TimerSystem_1.TimerSystem.Remove(this.IRe),this.IRe=void 0)}SHe(){var e=this.u2o.MarkConfigId,t=MapMarkByMarkId_1.configMapMarkByMarkId.GetConfig(e);if(t){this.GetText(1).ShowTextNew(t.MarkTitle);this.GetText(4).ShowTextNew(t.MarkDesc);var t=this.u2o.GetAreaText(),r=(t&&this.GetText(3).SetText(t),LordGymEntranceGroupByMarkId_1.configLordGymEntranceGroupByMarkId.GetConfigList(this.u2o.MarkId)),t=ModelManager_1.ModelManager.LevelPlayModel.GetLevelPlayConfig(this.Ymt.Id)?.LevelPlayRewardConfig;if(this.Jbl){var i=LordGymEntranceSetByMarkId_1.configLordGymEntranceSetByMarkId.GetConfig(this.u2o.MarkId),a=r.length,s=new Array(a);for(let e=0;e<a;e++){var o=r[e].LordGymList,n=o.length,h=new Array(n);let i="";for(let t=0;t<n;t++){var l=o[t],d=(0===t&&(d=ConfigManager_1.ConfigManager.LordGymConfig.GetLordGymConfig(l).MonsterList,d=MonsterInfoById_1.configMonsterInfoById.GetConfig(d[0]),i=d.Name),ModelManager_1.ModelManager.LordGymModel.GetLordGymIsUnLock(l)),_=ModelManager_1.ModelManager.LordGymModel.GetLordGymIsFinish(l),l=ModelManager_1.ModelManager.LordGymModel.GetLastGymFinish(l);let e=0;_?e=2:l&&d&&(e=1),h[t]=e}var M={NameTextId:i,StateList:h};s[e]=M}this.H2o.RefreshByData(s),this.F2o=ExchangeRewardById_1.configExchangeRewardById.GetConfig(i.PreviewRewardId)}else{var i=r[0],u=ConfigManager_1.ConfigManager.LordGymConfig.GetLordGymEntranceLordList(i.Id),i=ModelManager_1.ModelManager.LordGymModel.GetMaxDifficultyLordGymEntranceCanFight(i.Id)??1,t=(this.F2o=ExchangeRewardById_1.configExchangeRewardById.GetConfig(t.RewardConfig[i-1].RewardId),this.V2o=this.Ymt.FirstRewardId?ExchangeRewardById_1.configExchangeRewardById.GetConfig(this.Ymt.FirstRewardId):void 0,u[i-1]),y=(this.j2o=ModelManager_1.ModelManager.LordGymModel.GetLordGymIsFinish(t),u.length),g=new Array(y);for(let t=0;t<y;t++){var p=u[t],c=ConfigManager_1.ConfigManager.LordGymConfig.GetLordGymConfig(p),m=ModelManager_1.ModelManager.LordGymModel.GetLordGymIsUnLock(p),v=ModelManager_1.ModelManager.LordGymModel.GetLordGymIsFinish(p),p=ModelManager_1.ModelManager.LordGymModel.GetLastGymFinish(p);let e=0;v?e=2:p&&m&&(e=1);v={NameTextId:"LordGymDifficulty",NameTextArg:[c.Difficulty],StateList:[e]};g[t]=v}this.H2o.RefreshByData(g)}this.GetItem(9).SetUIActive(!1),this.GetItem(12).SetUIActive(!1),this.GetItem(8).SetUIActive(!1),this.GetItem(14).SetUIActive(!0),this.GetItem(26).SetUIActive(!1),this.GetVerticalLayout(5).RootUIComp.SetUIActive(!1),this.GetVerticalLayout(16).RootUIComp.SetUIActive(!0),this.GetItem(25).SetUIActive(!1),this.Ojl(),this.InitRewards(),this.W2o()}else Log_1.Log.CheckError()&&Log_1.Log.Error("SceneGameplay",17,"缺少标记配置",["MarkId",e])}Ojl(){let e=!1,t=!1,i=!1;var r,a,s;this.Jbl?(r=ModelManager_1.ModelManager.MapModel.GetMarkExtraShowState(this.u2o.MarkId).ShowFlag!==Protocol_1.Aki.Protocol.U5s.Proto_ShowDisable,i=r,e=MarkUiUtils_1.MarkUiUtils.IsShowGoto(this.u2o),t=!e):(r=ModelManager_1.ModelManager.MapModel.IsLevelPlayOccupied(this.Ymt.Id),e=!r.IsOccupied),this.ZAt.SetActive(t),this.ZAt.SetEnableClick(i),this.GetItem(32).SetUIActive(e),this.mth.SetUiActive(!1),e&&(r=this.GetButton(29),a=TeleportController_1.TeleportController.CheckCanTeleport(),s=MarkUiUtils_1.MarkUiUtils.FindNearbyValidGotoMark(this.Map,this.u2o),this.mth.SetUiActive(!a||void 0===s),r.SetSelfInteractive(a&&void 0!==s))}W2o(){var e=ModelManager_1.ModelManager.MapModel.IsLevelPlayOccupied(this.Ymt.Id);this.GetItem(12).SetUIActive(e.IsOccupied),e.IsOccupied&&(e=ModelManager_1.ModelManager.GeneralLogicTreeModel.GetBehaviorTree(e.QuestId),e=ModelManager_1.ModelManager.QuestNewModel.GetQuest(e.TreeConfigId),e=StringUtils_1.StringUtils.Format(MultiTextLang_1.configMultiTextLang.GetLocalTextNew("Quest_Require_Note")??"",e.Name),this.GetText(13).SetText(e))}InitRewards(){this.O2o||(t=this.GetItem(8).GetOwner(),e=this.GetVerticalLayout(7).RootUIComp,this.k2o=new SceneGameplayTipGrid_1.SceneGameplayTipGrid,this.k2o.Initialize(LguiUtil_1.LguiUtil.DuplicateActor(t,e)),this.O2o=new SceneGameplayTipGrid_1.SceneGameplayTipGrid,this.O2o.Initialize(LguiUtil_1.LguiUtil.DuplicateActor(t,e)));var e,t=ModelManager_1.ModelManager.WorldLevelModel.CurWorldLevel;this.Jbl?this.K2o(this.O2o,this.F2o,t,"NewLordGymPassReward",!1):(this.Ymt.IsFirstPass?this.K2o(this.k2o,void 0,0,"",this.j2o):this.K2o(this.k2o,this.V2o,t,"FirstPassReward"),this.K2o(this.O2o,this.F2o,t,"FirstPassReward",this.j2o))}K2o(e,r,a,t,s=!1){if(r){var o=r.PreviewReward;let i=void 0;if(o.has(a))i=o.get(a).MapIntInt;else for(let e=a-1;0<=e;e--)if(o.has(e)){i=o.get(e).MapIntInt;break}if(!i){var n,h=r.RewardId;let t=0;if(h.has(a))t=h.get(a);else for(let e=a-1;0<=e;e--)if(h.has(e)){t=h.get(e);break}t&&0<t&&((n=DropPackageById_1.configDropPackageById.GetConfig(t))?i=n.DropPreview:Log_1.Log.CheckError()&&Log_1.Log.Error("SceneGameplay",17,"兑换奖励表配置的掉落ID读取不到掉落奖励",["兑换奖励ID",r.Id]))}i?(e.Refresh(i,t,!0,s),e.SetActive(!0)):(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("SceneGameplay",17,"读取不到奖励配置",["兑换奖励ID",r.Id],["WorldLevel",a]),e.SetActive(!1))}else e.SetActive(!1)}l_i(){let e="";e=this.u2o.IsTracked?"InstanceDungeonEntranceCancelTrack":"InstanceDungeonEntranceTrack",this.ZAt.SetLocalText("TeleportFastMove"),this.y8a.SetLocalText(e)}}exports.LordGymPanel=LordGymPanel;class DifficultyItem extends GridProxyAbstract_1.GridProxyAbstract{constructor(){super(...arguments),this.Zbl=void 0,this.eql=()=>new LordGymDifficultyStateItem_1.LordGymDifficultyStateItem}OnRegisterComponent(){this.ComponentRegisterInfos=[[0,UE.UIText],[1,UE.UITexture],[2,UE.UIItem],[3,UE.UIText],[4,UE.UIHorizontalLayout],[5,UE.UIItem]]}OnStart(){this.GetItem(2)?.SetUIActive(!1),this.Zbl=new GenericLayout_1.GenericLayout(this.GetHorizontalLayout(4),this.eql,this.GetItem(5).GetOwner())}Refresh(e,t,i){e.NameTextArg?LguiUtil_1.LguiUtil.SetLocalTextNew(this.GetText(0),e.NameTextId,...e.NameTextArg):LguiUtil_1.LguiUtil.SetLocalTextNew(this.GetText(0),e.NameTextId),this.Zbl?.RefreshByData(e.StateList)}GetKey(e,t){return this.GridIndex}}
//# sourceMappingURL=LordGymPanel.js.map