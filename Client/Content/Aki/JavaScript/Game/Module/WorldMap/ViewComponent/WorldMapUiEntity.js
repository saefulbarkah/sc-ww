
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.WorldMapUiEntity=void 0;const UE=require("ue"),Info_1=require("../../../../Core/Common/Info"),Vector2D_1=require("../../../../Core/Utils/Math/Vector2D"),EventDefine_1=require("../../../Common/Event/EventDefine"),EventSystem_1=require("../../../Common/Event/EventSystem"),Global_1=require("../../../Global"),ConfigManager_1=require("../../../Manager/ConfigManager"),ModelManager_1=require("../../../Manager/ModelManager"),UiLayer_1=require("../../../Ui/UiLayer"),MapEntity_1=require("../../Map/Base/MapEntity"),MapDefine_1=require("../../Map/MapDefine"),MapUtil_1=require("../../Map/MapUtil"),WorldMapUtil_1=require("../WorldMapUtil"),RAD_2_DEG=180/Math.PI,DEG_PI_4=90;class WorldMapUiEntity extends MapEntity_1.MapEntity{constructor(){super(...arguments),this.jYa=void 0,this.WYa=void 0,this.QYa=void 0,this.ClickedItem=void 0,this.r8l=Vector2D_1.Vector2D.Create(),this.n4o=(s,r,h)=>{if(this.ClickedItem)this.MoveComponent.PushMap(this.ClickedItem,!1);else{let t=void 0,e=void 0;var n=Vector2D_1.Vector2D.Create(this.Map.GetRootItem().GetAnchorOffset()),a=this.MoveComponent.TweenTarget;let i=void 0;switch(h){case 1:case 2:case 3:case 4:case 5:i=this.s4o()}h=0===s?1:r/s;i?(t=n.SubtractionEqual(i).MultiplyEqual(h).AdditionEqual(i),a&&(e=a.SubtractionEqual(i).MultiplyEqual(h).AdditionEqual(i))):(t=n.MultiplyEqual(h),a&&(e=a.MultiplyEqual(h))),this.MoveComponent.SetMapPositionCauseByScaling(t,e,2)}this.SyncTransformToFrontContainer()},this.MarkEdgeSize=void 0,this.UpdateMarkItems=()=>{var t;this.UpdateSelfPlayerMark();for([,t]of this.Map.GetAllMarkItems())for(var[,e]of t)this.UpdateSingleMarkItem(e);this.ScaleComponent.FlushScaleDirty()},this.Hll=(t,e)=>{t=this.Map.GetMarkItem(t,e);t&&this.UpdateSingleMarkItem(t)},this.OnPlayerMarkPositionChanged=()=>{if(void 0!==this.Map){var t=this.Map.GetMarkItemsByType(11);if(t&&0!==t.size)for(var[,e]of t)this.UpdateSingleMarkItem(e)}}}get Map(){return this.jYa}set Map(t){void 0!==(this.jYa=t)&&(t=t.GetRootItem(),this.MapSize=Vector2D_1.Vector2D.Create(t.GetWidth(),t.GetHeight()))}get ViewPortSize(){return this.PropertyMap.tryGet(0)??Vector2D_1.Vector2D.ZeroVector}set ViewPortSize(t){this.PropertyMap.set(0,t)}get OutOfViewPortSize(){return this.PropertyMap.tryGet(1)??Vector2D_1.Vector2D.ZeroVector}set OutOfViewPortSize(t){this.PropertyMap.set(1,t)}get MapSize(){return this.PropertyMap.tryGet(2)??Vector2D_1.Vector2D.ZeroVector}set MapSize(t){this.PropertyMap.set(2,t)}set UiParams(t){this.WYa=t}get UiParams(){return this.WYa}set OpenParams(t){this.QYa=t}get OpenParams(){return this.QYa}get MapId(){return this.PropertyMap.tryGet(3)??this.OpenParams.MapId??MapDefine_1.BIG_WORLD_MAP_ID}set MapId(t){this.PropertyMap.set(3,t)}get IsInPlayerMap(){var t=ModelManager_1.ModelManager.WorldMapModel.LastBigSceneMiniMapInfo;if(t){t=t.AreaId,t=ConfigManager_1.ConfigManager.AreaConfig.GetLevelOneAreaId(t),t=ConfigManager_1.ConfigManager.AreaConfig.GetAreaInfo(t);if(t)return t.MapConfigId===this.MapId}t=MapUtil_1.MapUtil.GetCurrentMapOrDungeonId();return MapUtil_1.MapUtil.GetInstanceDungeonBelongWorldId(t)===this.MapId}get SecondaryUiComponent(){return this.GetComponent(1)}get InteractComponent(){return this.GetComponent(2)}get MoveComponent(){return this.GetComponent(3)}get ScaleComponent(){return this.GetComponent(4)}get PlayerComponent(){return this.GetComponent(5)}get MultiFloorComponent(){return this.GetComponent(6)}get QuickNavigateComponent(){return this.GetComponent(7)}OnInit(){this.Reset()}Reset(){var t;this.ScaleComponent.Initialize(),this.InitSelfPlayerMark(),this.SyncTransformToFrontContainer(),this.SecondaryUiComponent.IsSecondaryUiOpening||(this.OpenParams&&this.OpenParams.IsNotFocusTween&&(t=this.Map.GetMarkItem(this.OpenParams.MarkType,this.OpenParams.MarkId))&&(this.OpenParams.StartScale=this.ScaleComponent.MapScale,this.OpenParams.StartWorldPosition=Vector2D_1.Vector2D.Create(-t.UiPosition.X*this.OpenParams.StartScale,-t.UiPosition.Y*this.OpenParams.StartScale)),this.OpenParams?.StartScale&&this.ScaleComponent.SetMapScale(this.OpenParams.StartScale,6,!1),this.OpenParams?.StartWorldPosition?this.MoveComponent.SetMapPosition(this.OpenParams.StartWorldPosition,!1):MapUtil_1.MapUtil.CurrentInBigMap()?this.IsInPlayerMap&&(this.UpdateSelfPlayerMark(),this.MoveComponent.FocusPlayer(this.PlayerComponent.PlayerUiPosition,!1,1)):this.fdl()),this.OnPlayerMarkPositionChanged(),this.UpdateMarkItems(),this.SecondaryUiComponent.AllSecondaryPanelsUpdateMap()}RegisterComponents(){this.ViewPortSize=WorldMapUtil_1.WorldMapUtil.GetViewportSize(),this.AddComponent(1),this.AddComponent(2),this.AddComponent(3),this.AddComponent(5),this.AddComponent(6),this.AddComponent(7),this.AddComponent(4).ScaleChangeEvent=this.n4o,EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.UnTrackMark,this.UpdateMarkItems),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.TrackMark,this.UpdateMarkItems),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.MarkForceVisibleChanged,this.UpdateMarkItems),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.ScenePlayerLocationChanged,this.OnPlayerMarkPositionChanged),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnMapMarkTaskComplete,this.Hll)}OnDispose(){EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.UnTrackMark,this.UpdateMarkItems),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.TrackMark,this.UpdateMarkItems),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.MarkForceVisibleChanged,this.UpdateMarkItems),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.ScenePlayerLocationChanged,this.OnPlayerMarkPositionChanged),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnMapMarkTaskComplete,this.Hll),this.Map=void 0}OnTick(){this.Map?.Tick()}SyncTransformToFrontContainer(){this.Map.SyncTransformToFrontContainer()}s4o(){var e=Global_1.Global.CharacterController;if(e){let t=void 0;if(Info_1.Info.IsInKeyBoard()?t=Vector2D_1.Vector2D.Create(e.GetCursorPosition()):Info_1.Info.IsInTouch()&&(t=this.InteractComponent.MultiTouchOriginCenter),t){var i,e=UiLayer_1.UiLayer.UiRootItem.GetCanvasScaler();if(e)return e=e.ConvertPositionFromViewportToLGUICanvas(t.ToUeVector2D()),(i=WorldMapUtil_1.WorldMapUtil.GetViewportSizeByPool()).Set(e.X-i.X/2,e.Y-i.Y/2),i}}}InitSelfPlayerMark(){var t=this.IsInPlayerMap,e=this.Map.SelfPlayerNode;e.SetUIActive(t),t&&e.SetAsLastHierarchy()}UpdateSelfPlayerMark(){this.PlayerComponent.UpdatePlayerPosition();var t=this.PlayerComponent.PlayerRotation,e=this.PlayerComponent.PlayerUiPosition,i=this.ScaleComponent.MapScale,t=(this.Map.PlayerArrow.SetUIRelativeRotation(new UE.Rotator(0,t,0)),this.MoveComponent.MapUiPosition),s=Vector2D_1.Vector2D.Create(),[e,i]=(e.Multiply(i,s).Addition(t,s),this.ClampToMarkEdge(s)),r=this.Map.PlayerOutOfBoundIndicator;i?(this.PlayerComponent.PlayerOutOfBound=!0,this.Map.SelfPlayerNode.SetAnchorOffset(e.SubtractionEqual(t).DivisionEqual(this.ScaleComponent.MapScale).ToUeVector2D(!0)),e=Math.atan2(s.Y,s.X)*RAD_2_DEG-DEG_PI_4,r.SetUIRelativeRotation(new UE.Rotator(0,e,0))):(this.PlayerComponent.PlayerOutOfBound=!1,this.Map.SelfPlayerNode.SetAnchorOffset(this.PlayerComponent.PlayerUiPosition.ToUeVector2D())),r.SetUIActive(i)}fdl(){var t=MapUtil_1.MapUtil.GetLastBigScenePlayerUiPosition();this.UpdateSelfPlayerMark(),this.MoveComponent.FocusPlayer(t,!1,1)}ClampToMarkEdge(t){var e,i=this.MarkEdgeSize;return Math.abs(t.X)<i.X&&Math.abs(t.Y)<i.Y?[t,!1]:(e=Vector2D_1.Vector2D.Create(),Math.abs(t.X/t.Y)>i.X/i.Y?t.Multiply(i.X/Math.abs(t.X),e):t.Multiply(i.Y/Math.abs(t.Y),e),[e,!0])}pdl(t){return!(!t.PermanentUpdate&&this.D4o(t))}UpdateSingleMarkItem(e){if(this.pdl(e)){if(e.LogicUpdate(this.PlayerComponent.PlayerWorldPosition),e.ViewUpdate(this.PlayerComponent.PlayerWorldPosition,this.InteractComponent.IsDragging,this.ScaleComponent.IsScaleDirty),e.View){var t=this.ScaleComponent.MapScale,i=Vector2D_1.Vector2D.Create(e.UiPosition.X,e.UiPosition.Y);if(e.PermanentUpdate){var s=this.MoveComponent.MapUiPosition,r=Vector2D_1.Vector2D.Create();i.Multiply(t,r).Addition(s,r);const[h,n]=this.ClampToMarkEdge(r);n?(e.IsOutOfBound=!0,e.GetRootItemAsync().then(t=>{e.View?.SetOutOfBoundDirection(h)}),e.SetAnchorOffset(h.SubtractionEqual(s).DivisionEqual(t))):(e.IsOutOfBound=!1,e.SetAnchorOffset(i))}else e.IsOutOfBound=!1,e.SetAnchorOffset(i)}}else e.View?.IsViewReady&&e.View.SetUiActive(!1)}D4o(t){var e=this.MoveComponent.MapUiPosition;return this.r8l.Set(t.UiPosition.X*ModelManager_1.ModelManager.WorldMapModel.MapScale+e.X,t.UiPosition.Y*ModelManager_1.ModelManager.WorldMapModel.MapScale+e.Y),Math.abs(this.r8l.X)>this.OutOfViewPortSize.X||Math.abs(this.r8l.Y)>this.OutOfViewPortSize.Y}}exports.WorldMapUiEntity=WorldMapUiEntity;
//# sourceMappingURL=WorldMapUiEntity.js.map