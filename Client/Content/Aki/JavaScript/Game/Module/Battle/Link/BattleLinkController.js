
"use strict";var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.BattleLinkController=void 0;const UE=require("ue"),ActorSystem_1=require("../../../../Core/Actor/ActorSystem"),AudioSystem_1=require("../../../../Core/Audio/AudioSystem"),Info_1=require("../../../../Core/Common/Info"),Log_1=require("../../../../Core/Common/Log"),ControllerBase_1=require("../../../../Core/Framework/ControllerBase"),Net_1=require("../../../../Core/Net/Net"),TimerSystem_1=require("../../../../Core/Timer/TimerSystem"),MathUtils_1=require("../../../../Core/Utils/MathUtils"),EventDefine_1=require("../../../Common/Event/EventDefine"),EventSystem_1=require("../../../Common/Event/EventSystem"),TimeUtil_1=require("../../../Common/TimeUtil"),Global_1=require("../../../Global"),ConfigManager_1=require("../../../Manager/ConfigManager"),ModelManager_1=require("../../../Manager/ModelManager"),BulletController_1=require("../../../NewWorld/Bullet/BulletController"),PreloadConfigStatementPart1_1=require("../../../Preload/PreloadConfigStatementPart1"),PreloadControllerClassPart1_1=require("../../../Preload/PreloadControllerClassPart1"),InputDistributeController_1=require("../../../Ui/InputDistribute/InputDistributeController"),InputMappingsDefine_1=require("../../../Ui/InputDistribute/InputMappingsDefine"),UiManager_1=require("../../../Ui/UiManager"),GameModeController_1=require("../../../World/Controller/GameModeController"),BattleUiControl_1=require("../../BattleUi/BattleUiControl"),BattleLinkDefine_1=require("./BattleLinkDefine"),RenderUtil_1=require("../../../Render/Utils/RenderUtil"),actionNames=[InputMappingsDefine_1.actionMappings.切换角色1,InputMappingsDefine_1.actionMappings.切换角色2,InputMappingsDefine_1.actionMappings.切换角色3,InputMappingsDefine_1.actionMappings.切换角色4,InputMappingsDefine_1.actionMappings.技能1],seqCameraTag=new UE.FName("SequenceCamera"),bgTag=new UE.FName("Character");class BattleLinkController extends ControllerBase_1.ControllerBase{static OnInit(){return Net_1.Net.Register(20059,this.X0l),Net_1.Net.Register(25094,this.Y0l),!0}static OnClear(){return Net_1.Net.UnRegister(20059),Net_1.Net.UnRegister(25094),this.Nmt(),!0}static OnPreload(){var t;if(ModelManager_1.ModelManager.BattleLinkModel?.CheckInBattleLink())return this.yWe(),this.oJa(),(t=ModelManager_1.ModelManager.CreatureModel?.GetPlayerId())&&(t=ModelManager_1.ModelManager.SceneTeamModel.GetTeamPlayerData(t)?.GetCurrentGroup())&&(t=(t?.GetRoleList()).map(t=>ConfigManager_1.ConfigManager.RoleConfig.GetBaseRoleId(t.RoleId)),ModelManager_1.ModelManager.BattleLinkModel.SetRoleIdList(t)),["BattleLinkController",ModelManager_1.ModelManager.BattleLinkModel.PreloadRes()]}static OnLeaveLevel(){return this.Nmt(),this.Tza=!1,this.awa&&(this.awa.SequencePlayer?.IsPlaying()&&this.awa.SequencePlayer?.Stop(),ActorSystem_1.ActorSystem.Put("BattleLinkController.OnLeaveLevel",this.awa)),this.awa=void 0,this.j3&&(TimerSystem_1.TimerSystem.Remove(this.j3),this.j3=void 0,this.eRe()),this.Aza&&BattleUiControl_1.BattleUiControl.SetBattleViewVisible(this.Aza),this.Aza=void 0,this.tdl&&GameModeController_1.GameModeController.SetTimeDilation(1),this.tdl=!1,this.ynh.clear(),this.Snh=!0}static yWe(){this.SHa||(this.SHa=!0,InputDistributeController_1.InputDistributeController.BindActions(actionNames,this.gTn),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnBattleLinkToggle,this.s5a),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.CharUseSkill,this.BJe),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnUpdateSceneTeam,this.dLe))}static Nmt(){this.SHa&&(this.SHa=!1,InputDistributeController_1.InputDistributeController.UnBindActions(actionNames,this.gTn),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnBattleLinkToggle,this.s5a),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.CharUseSkill,this.BJe),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnUpdateSceneTeam,this.dLe))}static oJa(){this.awa||(this.awa=ActorSystem_1.ActorSystem.Get(UE.LevelSequenceActor.StaticClass(),MathUtils_1.MathUtils.DefaultTransform,void 0,!1))}static Enh(e){if(!this.ynh.has(e)){var i=ModelManager_1.ModelManager.CreatureModel.GetPlayerId(),i=ModelManager_1.ModelManager.SceneTeamModel.GetTeamPlayerData(i).GetCurrentGroup().GetRoleList();let t=0;for(const a of i){var n=ModelManager_1.ModelManager.CreatureModel.GetEntity(a.CreatureDataId);n.Entity.Id===e&&(this.ynh.set(n.Entity.Id,n),Log_1.Log.CheckDebug())&&Log_1.Log.Debug("Battle",67,"[BattleLink]缓存Entity成功",["entityId",e]),this.ynh.has(n.Entity.Id)&&(t+=1)}t===i.length&&(this.Snh=!1)}}static UseLinkSkill(t){var e,i;t&&(this.Zqi?ModelManager_1.ModelManager.BattleLinkModel.HasLinkEntityId(t.Id)?Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"[BattleLink]触发队友大招失败, 该entity已触发过",["entityId",t.Id]):(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"[BattleLink]触发队友大招成功",["MessageId",this.Zqi],["entityId",t.Id]),t=t.GetComponent(160),e=MathUtils_1.MathUtils.LongToBigInt(this.Zqi),(i=PreloadConfigStatementPart1_1.configCommonParamById.GetLong54Config("LinkSkillNotifyBuff"))&&t.AddBuff(BigInt(i),{InstigatorId:t.CreatureDataId,Reason:"触发Link大招",PreMessageId:e})):Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"[BattleLink]触发队友大招失败",["MessageId",this.Zqi]))}static StartLink(t=0){t=0===t?TimeUtil_1.TimeUtil.GetServerTimeStamp():t;UiManager_1.UiManager.IsViewOpen("BattleLinkView")?EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnBattleLinkRestart,t):UiManager_1.UiManager.OpenView("BattleLinkView",t),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"[BattleLink]Link倒计时开始")}static StopLink(){EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnBattleLinkStop),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"[BattleLink]Link倒计时结束")}static StartLinkExplosion(){this.StopLink(),this.TryPlaySplitScreen()}static TryPlaySplitScreen(){this.Tza||(ModelManager_1.ModelManager.BattleLinkModel?.CheckSplitScreenRes()&&this.awa?(this.Tza=!0,this.Lza(),ModelManager_1.ModelManager.BattleLinkModel.PlayRoleAnim(!0),this.LinkExplosionStart()):Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"[BattleLink]分屏衔接播放失败"))}static Lza(){var t,e=ModelManager_1.ModelManager.SceneTeamModel.GetCurrentEntity.Entity,e=(e&&(e=e.GetComponent(19))&&(t=e?.CreateGameplayCue(BattleLinkDefine_1.linkBurstPostEffect),this.yta=e?.GetCueByHandle(t)),BattleLinkDefine_1.LINK_POST_EFFECT_DURATION*TimeUtil_1.TimeUtil.InverseMillisecond);this.j3=TimerSystem_1.TimerSystem.Delay(()=>{this.j3=void 0,this.eRe(),this.PKa()},e),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"[BattleLink]播放分屏衔接")}static eRe(){this.yta&&(this.yta.Destroy(),this.yta=void 0)}static PKa(){var t=ModelManager_1.ModelManager.BattleLinkModel,e=t?.GetSplitScreenMainBp(),t=t?.GetSplitScreenSeq();e&&t&&this.awa?(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"[BattleLink]分屏Seq开始播放"),ModelManager_1.ModelManager.BattleLinkModel.PlayRoleAnim(),AudioSystem_1.AudioSystem.SetState("game_rogue_link_state","in_link"),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",42,"[BattleLink]Link音乐切入"),ModelManager_1.ModelManager.BattleLinkModel.PlayRoleLinkAudio(),PreloadControllerClassPart1_1.CameraController.SequenceCamera.PlayerComponent.SetBlendTime(0,0),PreloadControllerClassPart1_1.CameraController.SequenceCamera.PlayerComponent.StopSequence(),this.awa.SetSequence(t),this.GPe.Add(ModelManager_1.ModelManager.CameraModel.SequenceCamera.DisplayComponent.CineCamera),this.awa.SetBindingByTag(seqCameraTag,this.GPe,!1),this.GPe.Empty(),this.GPe.Add(e),this.awa.SetBindingByTag(bgTag,this.GPe,!1),this.GPe.Empty(),PreloadControllerClassPart1_1.CameraController.EnterCameraMode(1),e.SetActorHiddenInGame(!1),e.Start(),this.awa.SequencePlayer.OnFinished.Clear(),this.awa.SequencePlayer.OnFinished.Add(this.uwa),this.awa.SequencePlayer.Play(),RenderUtil_1.RenderUtil.BeginPSOSyncMode()):(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"[BattleLink]分屏Seq播放失败"),this.LinkExplosionEnd())}static LinkExplosionStart(){this.tdl=!0,this.Aza=BattleUiControl_1.BattleUiControl.SetBattleViewInvisible(),GameModeController_1.GameModeController.SetTimeDilation(0),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"[BattleLink]分屏假时停开始")}static LinkExplosionEnd(){if(this.tdl=!1,this.Aza&&BattleUiControl_1.BattleUiControl.SetBattleViewVisible(this.Aza),this.Aza=void 0,GameModeController_1.GameModeController.SetTimeDilation(1),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"[BattleLink]分屏假时停结束"),ModelManager_1.ModelManager.BattleLinkModel?.ResetLinkSkillStatus(),this.Zqi){var t=ModelManager_1.ModelManager.SceneTeamModel.GetCurrentEntity.Entity,e=PreloadConfigStatementPart1_1.configCommonParamById.GetLong54ArrayConfig("LinkBrustBuffs"),i=PreloadConfigStatementPart1_1.configCommonParamById.GetLong54ArrayConfig("LinkBrustBullets"),n=t.GetComponent(160),a=MathUtils_1.MathUtils.LongToBigInt(this.Zqi);if(e)for(const r of e)n.AddBuff(BigInt(r),{InstigatorId:n.CreatureDataId,Reason:"Link爆发结束增加buff",PreMessageId:a});if(i)for(const l of i)BulletController_1.BulletController.CreateBulletCustomTarget(t,l.toString(),void 0,{},a)}}static SetPlayerUltraSkillEnable(t){var e=Global_1.Global.BaseCharacter?.CharacterActorComponent?.Entity?.GetComponent(191);e&&(t?e.RemoveTag(-732810197):e.AddTag(-732810197))}static SetMessageId(t){this.Zqi=t}}exports.BattleLinkController=BattleLinkController,(_a=BattleLinkController).a5a=0,BattleLinkController.SHa=!1,BattleLinkController.Aza=void 0,BattleLinkController.Zqi=void 0,BattleLinkController.Tza=!1,BattleLinkController.yta=void 0,BattleLinkController.awa=void 0,BattleLinkController.GPe=UE.NewArray(UE.Actor),BattleLinkController.j3=void 0,BattleLinkController.ynh=new Map,BattleLinkController.Snh=!0,BattleLinkController.tdl=!1,BattleLinkController.s5a=()=>{_a.a5a=(_a.a5a+1)%2},BattleLinkController.gTn=(t,e)=>{Info_1.Info.IsBuildShipping||0===e&&_a.a5a&&(t===InputMappingsDefine_1.actionMappings.技能1?_a.TryPlaySplitScreen():t===InputMappingsDefine_1.actionMappings.切换角色4&&(UiManager_1.UiManager.IsViewOpen("BattleLinkView")?EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnBattleLinkRestart,TimeUtil_1.TimeUtil.GetServerTimeStamp()):UiManager_1.UiManager.OpenView("BattleLinkView")))},BattleLinkController.BJe=(t,e,i)=>{_a.Snh&&!_a.ynh.has(t)&&_a.Enh(t);var n=_a.ynh.get(t);n?3===(n.Entity?.GetComponent(34)?.GetSkillInfo(e))?.SkillGenre&&ModelManager_1.ModelManager.BattleLinkModel.CanUseLinkSkill(t)&&(ModelManager_1.ModelManager.BattleLinkModel.AddLinkEntityId(t),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnBattleLinkStop),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnBattleLinkStatusChanged,3)):Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"[BattleLink]EntityCache中找不到entity",["entityId",t])},BattleLinkController.dLe=()=>{var t=ModelManager_1.ModelManager.CreatureModel?.GetPlayerId();t&&(t=ModelManager_1.ModelManager.SceneTeamModel.GetTeamPlayerData(t)?.GetCurrentGroup())&&(t=(t?.GetRoleList()).map(t=>ConfigManager_1.ConfigManager.RoleConfig.GetBaseRoleId(t.RoleId)),ModelManager_1.ModelManager.BattleLinkModel.UpdateMainBp(t)),_a.ynh.clear(),_a.Snh=!0},BattleLinkController.uwa=()=>{_a.Tza=!1,Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"[BattleLink]分屏Seq播放结束");var t=ModelManager_1.ModelManager.BattleLinkModel?.GetSplitScreenMainBp(),t=(t?.End(),t?.SetActorHiddenInGame(!0),ModelManager_1.ModelManager.CameraModel.SequenceCamera.DisplayComponent.CineCamera);t.GetAttachParentActor()&&t.K2_DetachFromActor(),PreloadControllerClassPart1_1.CameraController.ExitCameraMode(1),_a.LinkExplosionEnd(),RenderUtil_1.RenderUtil.EndPSOSyncMode()},BattleLinkController.X0l=t=>{ModelManager_1.ModelManager.BattleLinkModel?.HandleLinkingStateNotify(t),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"[BattleLink]接收Link状态改变通知",["status",t.PEl],["msgId",t._Vn])},BattleLinkController.Y0l=t=>{ModelManager_1.ModelManager.BattleLinkModel?.HandleLinkExitNotify(t),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"[BattleLink]接收Link退出通知",["status",t.PEl],["reason",t.x9n]),AudioSystem_1.AudioSystem.SetState("game_rogue_link_state","not_in_link"),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",42,"[BattleLink]Link音乐切出")};
//# sourceMappingURL=BattleLinkController.js.map