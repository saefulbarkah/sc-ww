
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BattleLinkModel=void 0;const UE=require("ue"),ActorSystem_1=require("../../../../Core/Actor/ActorSystem"),AudioSystem_1=require("../../../../Core/Audio/AudioSystem"),CustomPromise_1=require("../../../../Core/Common/CustomPromise"),Log_1=require("../../../../Core/Common/Log"),Time_1=require("../../../../Core/Common/Time"),BattleLinkCharacterById_1=require("../../../../Core/Define/ConfigQuery/BattleLinkCharacterById"),RoleInfoById_1=require("../../../../Core/Define/ConfigQuery/RoleInfoById"),ModelBase_1=require("../../../../Core/Framework/ModelBase"),ResourceSystem_1=require("../../../../Core/Resource/ResourceSystem"),DataTableUtil_1=require("../../../../Core/Utils/DataTableUtil"),MathUtils_1=require("../../../../Core/Utils/MathUtils"),EventDefine_1=require("../../../Common/Event/EventDefine"),EventSystem_1=require("../../../Common/Event/EventSystem"),ConfigManager_1=require("../../../Manager/ConfigManager"),ControllerHolder_1=require("../../../Manager/ControllerHolder"),ModelManager_1=require("../../../Manager/ModelManager"),CharacterNameDefines_1=require("../../../NewWorld/Character/Common/CharacterNameDefines"),PreloadConfigStatementPart1_1=require("../../../Preload/PreloadConfigStatementPart1"),SequenceDefine_1=require("../../Plot/Sequence/SequenceDefine"),BattleLinkController_1=require("./BattleLinkController"),BattleLinkDefine_1=require("./BattleLinkDefine"),THREE_ROLE=3,TWO_ROLE=2,ACTIVITY_ID=102600001;class BattleLinkModel extends ModelBase_1.ModelBase{constructor(){super(...arguments),this.swa=void 0,this.hwa=void 0,this.Kul=void 0,this.lwa=void 0,this._wa=void 0,this.Inh=void 0,this.F$=void 0,this.Osl=void 0,this.bal=void 0,this.qal=void 0,this.NUe=-1,this.sll=-1,this.Wke=void 0,this.Phl=!1,this.whl=!1,this.RKa=void 0,this.uJa=void 0,this.vZa=void 0,this.t_l=!1,this.T_l=void 0,this.L_l=void 0,this.UKa=0}OnInit(){return!0}OnLeaveLevel(){return this.swa&&ActorSystem_1.ActorSystem.Put("BattleLinkModel.OnLeaveLevel",this.swa),this.swa=void 0,this.hwa=void 0,this.Kul=void 0,this.lwa?.clear(),this._wa?.clear(),this.Inh?.clear(),this.F$?.clear(),this.Osl?.clear(),this.bal?.clear(),this.qal?.clear(),this.NUe=-1,this.sll=-1,this.Phl=!1,this.whl=!1,this.L_l=void 0,this.t_l=!1,this.RKa=void 0,!(this.UKa=0)}R_l(){var t=ModelManager_1.ModelManager.CreatureModel.GetInstanceId();if(!this.T_l){var e=ConfigManager_1.ConfigManager.DreamLinkConfig?.GetActivityConfig(ACTIVITY_ID);if(!e)return;var i,s,e=e.PreloadRoleIds;this.T_l=new Map;for([i,s]of e.entries()){var o=s.split(";").map(t=>parseInt(t));this.T_l.set(i,o)}}let r=this.T_l.get(t);return r=r||this.Wke}SetRoleIdList(t){Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"[BattleLink]设置角色列表",["roleIdList",t]),this.Phl=!1,this.whl=!1,t.length===THREE_ROLE?(this.Wke=[t[1],t[0],t[2]],this.Phl=!0):t.length===TWO_ROLE?(this.Wke=[t[1],t[0]],this.whl=!0):this.Wke=t,this.sll=t[0]}PreloadRes(){const t=new CustomPromise_1.CustomPromise;return this.L_l=this.R_l(),this.L_l||(this.L_l=[]),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"[BattleLink]开始预加载资源",["roleIdList",this.L_l]),this.ksl(this.L_l).then(()=>{this.mll(this.L_l).then(()=>{this.MZa(),this.UpdateMainBp(this.Wke),t.SetResult(!0)}).catch(()=>{t.SetResult(!1)})}).catch(()=>{t.SetResult(!1)}),t}async ksl(t){const s=[];t.forEach((t,e)=>{var i=BattleLinkCharacterById_1.configBattleLinkCharacterById.GetConfig(t);i?s.push(this.dll(t,i.CharacterDataAsset)):Log_1.Log.CheckError()&&Log_1.Log.Error("Battle",67,"[BattleLink]找不到roleId的配置",["roleid",t])}),await Promise.all(s)}async mll(t){const o=[];o.push(this.cwa()),o.push(this.mwa(BattleLinkDefine_1.THREE_ROLE_SEQ_PATH)),o.push(this.mwa(BattleLinkDefine_1.TWO_ROLE_SEQ_PATH)),t.forEach((t,e)=>{var i,s=this.Osl?.get(t),s=(s?(s.CharacterActorClass&&(i=UE.KismetSystemLibrary.GetPathName(s.CharacterActorClass),o.push(this.dwa(t,i))),s.Cos_Pose_AnimSequence&&(i=UE.KismetSystemLibrary.GetPathName(s.Cos_Pose_AnimSequence),o.push(this.Gal(t,i)))):Log_1.Log.CheckError()&&Log_1.Log.Error("Battle",67,"[BattleLink]找不到角色对应的DA",["roleid",t]),BattleLinkCharacterById_1.configBattleLinkCharacterById.GetConfig(t));s?(1===s.NeedLoadMesh&&(i=RoleInfoById_1.configRoleInfoById.GetConfig(t)?.MeshId)&&(s=DataTableUtil_1.DataTableUtil.GetDataTableRowFromName(0,i.toString())?.网格体?.ToAssetPathName())&&s.length&&"None"!==s&&o.push(this.Tnh(t,s)),1105===t&&(o.push(this.Tnh(t,BattleLinkDefine_1.ZHEZHI_WEAPON_MESH,!0)),o.push(this.Gal(t,BattleLinkDefine_1.ZHEZHI_WEAPON_ANIM,!0)))):Log_1.Log.CheckError()&&Log_1.Log.Error("Battle",67,"[BattleLink]找不到roleId的配置",["roleid",t])}),await Promise.all(o)}async cwa(){const e=new CustomPromise_1.CustomPromise;return ResourceSystem_1.ResourceSystem.LoadAsync(BattleLinkDefine_1.BATTLE_LINK_BP_PATH,UE.Class,t=>{t?this.swa=ActorSystem_1.ActorSystem.Get(t,MathUtils_1.MathUtils.DefaultTransform):Log_1.Log.CheckError()&&Log_1.Log.Error("Battle",67,"[BattleLink]加载BP_SplitScreen失败"),e.SetResult()},100),e.Promise}async dll(e,t){const i=new CustomPromise_1.CustomPromise;return ResourceSystem_1.ResourceSystem.LoadAsync(t,UE.BP_SplitScreenCharacterData_C,t=>{t?(this.Osl||(this.Osl=new Map),this.Osl.set(e,t),i.SetResult()):Log_1.Log.CheckError()&&Log_1.Log.Error("Battle",67,"[BattleLink]加载角色DA失败")},100),i.Promise}async Gal(e,i,s=!1){const o=new CustomPromise_1.CustomPromise;return ResourceSystem_1.ResourceSystem.LoadAsync(i,UE.AnimSequence,t=>{t?(s?(this.bal||(this.bal=new Map),this.bal):(this._wa||(this._wa=new Map),this._wa)).set(e,t):Log_1.Log.CheckError()&&Log_1.Log.Error("Battle",67,"[BattleLink]加载anim失败",["roleId",e],["path",i]),o.SetResult()},100),o.Promise}async dwa(e,t){const i=new CustomPromise_1.CustomPromise;return ResourceSystem_1.ResourceSystem.LoadAsync(t,UE.Class,t=>{t?(this.lwa||(this.lwa=new Map),this.lwa.set(e,t)):Log_1.Log.CheckError()&&Log_1.Log.Error("Battle",67,"[BattleLink]加载角色SeqBp失败"),i.SetResult()},100),i.Promise}async mwa(e){const i=new CustomPromise_1.CustomPromise;return ResourceSystem_1.ResourceSystem.LoadAsync(e,UE.LevelSequence,t=>{t?e===BattleLinkDefine_1.THREE_ROLE_SEQ_PATH?this.hwa=t:this.Kul=t:Log_1.Log.CheckError()&&Log_1.Log.Error("Battle",67,"[BattleLink]加载Seq失败",["path",e]),i.SetResult()},100),i.Promise}async Tnh(e,i,s=!1){const o=new CustomPromise_1.CustomPromise;return ResourceSystem_1.ResourceSystem.LoadAsync(i,UE.SkeletalMesh,t=>{t?(s?(this.qal||(this.qal=new Map),this.qal):(this.Inh||(this.Inh=new Map),this.Inh)).set(e,t):Log_1.Log.CheckError()&&Log_1.Log.Error("Battle",67,"[BattleLink]加载Mesh失败",["roleId",e],["path",i]),o.SetResult()},100),o.Promise}CheckSplitScreenRes(){return this.swa?this.Phl||this.whl?this.Phl&&!this.hwa?(Log_1.Log.CheckWarn()&&Log_1.Log.Warn("Battle",67,"[BattleLink]播放分屏时资源没准备好: ThreeRoleSeq"),!1):!(this.whl&&!this.Kul&&(Log_1.Log.CheckWarn()&&Log_1.Log.Warn("Battle",67,"[BattleLink]播放分屏时资源没准备好: TwoRoleSeq"),1)):(Log_1.Log.CheckWarn()&&Log_1.Log.Warn("Battle",67,"[BattleLink]非三人或双人队伍, 播放分屏检查seq失败"),!1):(Log_1.Log.CheckWarn()&&Log_1.Log.Warn("Battle",67,"[BattleLink]播放分屏时资源没准备好: MainBp"),!1)}MZa(){this.swa&&(this.swa.End(),this.NUe=ModelManager_1.ModelManager.CreatureModel.GetInstanceId(),this.swa.K2_SetActorLocation(this.GetBpLocation(),!1,void 0,!1),this.swa.SetActorHiddenInGame(!0))}UpdateMainBp(t){this.swa&&(this.SetRoleIdList(t),this.swa.Reset(),this.Phl?(this.swa.E_LinkPos_1=0,this.swa.E_LinkPos_2=.5,this.swa.E_LinkPos_3=1):(this.swa.E_LinkPos_1=1,this.swa.E_LinkPos_2=0),t=[this.swa.CharacterActor_1,this.swa.CharacterActor_2],this.Phl&&t.push(this.swa.CharacterActor_3),t.forEach((t,e)=>{var i,s;e>=this.Wke.length||(i=this.Wke[e],s=this.lwa?.get(i),t?.SetChildActorClass(s),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"[BattleLink]分屏Bp设置ChildActor",["roleId",i],["class",s]),(s=t?.ChildActor?.GetComponentByClass(UE.SkeletalMeshComponent.StaticClass()))&&((t=this.Inh?.get(i))&&s.SetSkeletalMesh(t),t=this.qal?.get(i))&&(s=s.GetChildComponent(1))&&(s.SetSkeletalMesh(t),s.SetVisibility(!0),s.SetActive(!0)),(t=this.Osl?.get(i))&&this.Nsl(e,t))}))}Nsl(t,e){if(this.swa)switch(t){case 0:this.swa.PointLight1_Location=e.PointLight_Location,this.swa.PointLight1_ToonLightColor=e.PointLight_Color,this.swa.EyeLightSimulation_Color1=e.EyeLightSimulation_Color;break;case 1:this.swa.PointLight2_Location=e.PointLight_Location,this.swa.PointLight2_ToonLightColor=e.PointLight_Color,this.swa.EyeLightSimulation_Color2=e.EyeLightSimulation_Color;break;case 2:this.swa.PointLight3_Location=e.PointLight_Location,this.swa.PointLight3_ToonLightColor=e.PointLight_Color,this.swa.EyeLightSimulation_Color3=e.EyeLightSimulation_Color}}SZa(t,e,i){var s,e=e.ChildActor;e?(e=e.GetComponentByClass(UE.SkeletalMeshComponent.StaticClass()))?(s=e.GetLinkedAnimGraphInstanceByTag(CharacterNameDefines_1.CharacterNameDefines.ABP_BASE),i?(i=this._wa?.get(t),(i=s?.PlaySlotAnimationAsDynamicMontage(i,SequenceDefine_1.ABP_Seq_Slot_Name,0,0,1,1))&&(s?.Montage_Pause(i),this.F$||(this.F$=new Map),this.F$.set(t,i))):((i=this.F$?.get(t))&&(s?.Montage_Resume(i),this.F$?.delete(t)),(s=this.bal?.get(t))&&(i=e.GetChildComponent(1))&&i.PlayAnimation(s,!1))):Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"[BattleLink]找不到ChildActor的骨骼网格体",["roleId",t]):Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"[BattleLink]分屏Bp的ChildActor为空",["roleId",t])}PlayRoleAnim(t=!1){this.swa&&(this.SZa(this.Wke[0],this.swa.CharacterActor_1,t),this.SZa(this.Wke[1],this.swa.CharacterActor_2,t),this.Phl)&&this.SZa(this.Wke[2],this.swa.CharacterActor_3,t)}PlayRoleLinkAudio(){var e=ConfigManager_1.ConfigManager.DreamLinkConfig?.GetActivityConfig(ACTIVITY_ID);if(ConfigManager_1.ConfigManager.DreamLinkConfig&&e){var i=e.FirstWhiteCatDungeonId;if(this.Phl&&this.NUe===i){let t=!0;for(const s of this.Wke)t=t&&e.PlotRoleLinkTeam.includes(s);if(t)return i=e.PlotRoleLinkAudio,AudioSystem_1.AudioSystem.PostEvent(i),void(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[BattleLink]播放剧情Link语音.",["Event",i]))}this.Ful()}}Ful(){var t;this.sll<0?Log_1.Log.CheckWarn()&&Log_1.Log.Warn("Audio",42,"[BattleLink]播放Link语音时获取当前角色失败",["RoleId",this.sll]):(t=ConfigManager_1.ConfigManager.DreamLinkConfig.GetRoleConfig(this.sll))?(t=t.RoleLinkAudio,AudioSystem_1.AudioSystem.PostEvent(t),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[BattleLink]播放主控角色Link语音",["Event",t])):Log_1.Log.CheckWarn()&&Log_1.Log.Warn("Audio",42,"[BattleLink]播放Link语音时获取当前角色配置失败",["RoleId",this.sll])}GetSplitScreenMainBp(){return this.swa}GetSplitScreenSeq(){return this.Phl?this.hwa:this.whl?this.Kul:void 0}GetLinkDuration(){return this.uJa||(this.uJa=PreloadConfigStatementPart1_1.configCommonParamById.GetIntConfig("LinkPrepareDuration")),this.uJa}GetBpLocation(){return this.vZa||(this.vZa=new UE.Vector(0,0,-3e3)),this.vZa}CheckInBattleLink(){var t,e;return!!ControllerHolder_1.ControllerHolder.GameModeController.IsInInstance()&&(t=ModelManager_1.ModelManager.CreatureModel.GetInstanceId(),23===ConfigManager_1.ConfigManager.InstanceDungeonConfig.GetConfig(t)?.InstSubType||!(!(e=PreloadConfigStatementPart1_1.configCommonParamById.GetIntArrayConfig("LinkInstanceIds"))||!e.includes(t)))}GetLinkStatus(){return this.UKa}CanUseLinkSkill(t=void 0){if(2!==this.UKa&&3!==this.UKa)return!1;if(this.t_l)return!1;let e=t;return!(!(e=e||ModelManager_1.ModelManager.SceneTeamModel?.GetCurrentEntity?.Entity?.Id)||this.HasLinkEntityId(e))}ResetLinkSkillStatus(){this.SetLinkSkillInCd(!1),this.RKa=void 0}UpdateLinkStatus(t,e=void 0){this.UKa=t,this.SetLinkSkillInCd(!1),0===t?(this.RKa=void 0,ControllerHolder_1.ControllerHolder.BattleLinkController.StopLink(),ControllerHolder_1.ControllerHolder.BattleLinkController.SetMessageId(void 0)):2===t?this.RKa=void 0:3===t?(e=MathUtils_1.MathUtils.LongToNumber(e||Time_1.Time.Now),ControllerHolder_1.ControllerHolder.BattleLinkController.StartLink(e)):4===t&&ControllerHolder_1.ControllerHolder.BattleLinkController.StartLinkExplosion(),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnBattleLinkStatusChanged,t)}HandleLinkingStateNotify(t){ControllerHolder_1.ControllerHolder.BattleLinkController.SetMessageId(t._Vn),0===t.PEl?this.UpdateLinkStatus(2):this.Phl||this.whl?this.Phl&&t.PEl<3||this.whl&&t.PEl<2?this.UpdateLinkStatus(3,t.J8n):this.UpdateLinkStatus(4):this.UpdateLinkStatus(0)}HandleLinkExitNotify(t){this.UpdateLinkStatus(0)}AddLinkEntityId(t){this.RKa?this.RKa.includes(t)||this.RKa.push(t):this.RKa=[t],this.SetLinkSkillInCd(!0)}HasLinkEntityId(t){return!!this.RKa?.includes(t)}SetLinkSkillInCd(t){this.t_l!==t&&(this.t_l=t,BattleLinkController_1.BattleLinkController.SetPlayerUltraSkillEnable(!t))}}exports.BattleLinkModel=BattleLinkModel;
//# sourceMappingURL=BattleLinkModel.js.map