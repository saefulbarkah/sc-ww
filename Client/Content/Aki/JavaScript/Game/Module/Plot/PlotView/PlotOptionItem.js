
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PlotOptionItem=void 0;const UE=require("ue"),Log_1=require("../../../../Core/Common/Log"),GlobalConfigFromCsvByName_1=require("../../../../Core/Define/ConfigQuery/GlobalConfigFromCsvByName"),MultiTextLang_1=require("../../../../Core/Define/ConfigQuery/MultiTextLang"),TalkOptionIconById_1=require("../../../../Core/Define/ConfigQuery/TalkOptionIconById"),TextById_1=require("../../../../Core/Define/ConfigQuery/TextById"),Protocol_1=require("../../../../Core/Define/Net/Protocol"),InputDevice_1=require("../../../../Launcher/InputDevice/InputDevice"),PublicUtil_1=require("../../../Common/PublicUtil"),LevelGameplayActionsDefine_1=require("../../../LevelGamePlay/LevelGameplayActionsDefine"),ConfigManager_1=require("../../../Manager/ConfigManager"),ControllerHolder_1=require("../../../Manager/ControllerHolder"),ModelManager_1=require("../../../Manager/ModelManager"),ToggleActionItem_1=require("../../Common/Toggle/ToggleActionItem"),TsInteractionUtils_1=require("../../Interaction/TsInteractionUtils"),PlotSubtitleView_1=require("../../Sequence/Subtitle/PlotSubtitleView"),GridProxyAbstract_1=require("../../Util/Grid/GridProxyAbstract"),PlotController_1=require("../PlotController"),SequenceController_1=require("../Sequence/SequenceController"),PlotView_1=require("./PlotView");class PlotOptionItem extends GridProxyAbstract_1.GridProxyAbstract{constructor(e){super(),this.$_i=void 0,this.fzi=0,this.Option=void 0,this.pzi="",this.vzi=void 0,this.Mzi=void 0,this.Ezi=0,this.tui=void 0,this.OptionIndex=-1,this.Szi=!1,this.yzi=void 0,this.aui=!1,this.Lke=()=>{var e;return!this.$_i.IsPlayingReleaseSequence&&(e=this.$_i.GetToggleItem().GetToggleState(),!this.aui||1!==e)},this._ui=()=>{this.tui&&this.tui(this)},this.OptionClick=(e=0)=>{ModelManager_1.ModelManager.PlotModel.OptionEnable?(ModelManager_1.ModelManager.PlotModel.OptionEnable=!1,this.aui=!0,this.$_i.PlayReleaseSequence().then(()=>{switch(this.$_i.SetRaycastTarget(!1),this.fzi){case 0:this.vzi?(PlotController_1.PlotController.EndInteraction("Flow"===this.Mzi.Type.Type),TsInteractionUtils_1.TsInteractionUtils.HandleInteractionOptionNew(this.Mzi,this.vzi)):PlotController_1.PlotController.EndInteraction();break;case 1:ModelManager_1.ModelManager.PlotModel.MarkGrayOption(this.Ezi,this.OptionIndex),this.yzi instanceof PlotView_1.PlotView?ControllerHolder_1.ControllerHolder.FlowController.FlowShowTalk.SelectOption(this.OptionIndex,this.Option.Actions):SequenceController_1.SequenceController.SelectOption(this.OptionIndex,this.Ezi)}},()=>{})):Log_1.Log.CheckWarn()&&Log_1.Log.Warn("Plot",26,"剧情选项点击失效",["index",this.OptionIndex],["id",this.Ezi])},this.yzi=e}OnRegisterComponent(){this.ComponentRegisterInfos=[[0,UE.UIItem],[1,UE.UIItem]]}async OnBeforeStartAsync(){var e=this.GetItem(0);this.$_i=new ToggleActionItem_1.ToggleActionItem,await this.$_i.CreateThenShowByActorAsync(e.GetOwner())}OnStart(){this.aui=!1,this.$_i.SetFunction(this.OptionClick),this.$_i.GetToggleItem().OnUndeterminedClicked.Add(this.OptionClick),this.$_i.GetToggleItem().CanExecuteChange.Bind(this.Lke),this.Izi()}OnBeforeDestroy(){this.Tzi(),this.$_i.Destroy()}Izi(){this.$_i.GetToggleItem().OnHover.Add(this._ui)}Tzi(){this.$_i.GetToggleItem().OnHover.Clear()}BindOnHover(e){this.tui=e}SetSelectedDisplay(e){if(this.GetItem(1).SetUIActive(e),(!e||!InputDevice_1.InputDevice.IsInTouch())&&this.$_i){const t=this.$_i.GetToggleItem();if(t)if(e)t.SetToggleState(0,!1),t.SetToggleState(1,!1);else if(this.Option?.ReadMarkEnabled)if(this.CheckToggleGray()){const t=this.$_i.GetToggleItem();void t.SetToggleState(2)}else t.SetToggleState(0,!1);else t.SetToggleState(0,!1)}}SetupSubtitleOption(e,t){this.fzi=1,this.Option=e,this.pzi=e.TidTalkOption,this.Ezi=t,this.OptionIndex=ModelManager_1.ModelManager.PlotModel.GetOptionIndex(e,t);e=PublicUtil_1.PublicUtil.GetFlowConfigLocalText(this.pzi);this.Lzi(this.fui(),e)}SetupInteractiveOption(e,t){this.fzi=0,this.Mzi=e,this.vzi=t;t=PublicUtil_1.PublicUtil.GetConfigTextByKey(e.TidContent);this.Lzi(this.fui(),t)}SetupLeaveOption(e){this.Szi=!0,this.fzi=0,this.Mzi=void 0,this.vzi=void 0,this.Lzi(this.fui(),e)}fui(){let t=void 0;switch(this.fzi){case 0:{if(!this.Mzi){var i=this.IsLeaveItem()?"Leave":"Dialog";t=this.Dzi(i);break}if(this.IsTask()){var o=this.Mzi.Context;if(!o)break;let e=void 0;switch(o.Type){case 2:e=o.QuestId;break;case 6:e=o.TreeConfigId}if(void 0===e)break;i=ModelManager_1.ModelManager.QuestNewModel.GetQuest(e);if(!i)break;i=ConfigManager_1.ConfigManager.MapConfig.GetTaskMarkConfig(i.QuestMarkId);t=i?.NpcTaskIcon;break}let e="Dialog";e=1===this.Option?.OptionStyle?"OS":this.Mzi.Icon??"Dialog",t=this.Dzi(e);break}case 1:this.Option&&(i=this.Option.Icon||1,i=TalkOptionIconById_1.configTalkOptionIconById.GetConfig(i))&&(t=i.Icon)}return t??""}Lzi(e,t){let i=t;1===this.fzi&&(i=ModelManager_1.ModelManager.PlotModel.PlotTextReplacer.Replace(i)),this.$_i.SetToggleTexture(e),this.$_i.SetToggleText(i)}Dzi(e){e=GlobalConfigFromCsvByName_1.configGlobalConfigFromCsvByName.GetConfig("EInteractIcon."+e)??GlobalConfigFromCsvByName_1.configGlobalConfigFromCsvByName.GetConfig("EInteractDefaultIcon."+e);return void 0===e?"":e.Value}IsTask(){var e=this.Mzi?.Context;return!!e&&(2===e.Type||6===e.Type&&e.BtType===Protocol_1.Aki.Protocol.hps.Proto_BtTypeQuest)}IsOpenSystemBoard(){if("Actions"===this.Mzi?.Type?.Type)for(const e of(this.Mzi?.Type).Actions)if("OpenSystemBoard"===e.Name)return!0;return!1}IsLeaveItem(){return this.Szi}CheckToggleGray(){return ModelManager_1.ModelManager.PlotModel.IsOptionGray(this.Ezi,this.OptionIndex)}Refresh(e,t,i){e?e instanceof LevelGameplayActionsDefine_1.CommonInteractOption?this.Rzi(e):this.Uzi(e):this.Azi(),this.aui=!1,this.SetSelectedDisplay(!1),this.$_i.SetRaycastTarget(!0)}Rzi(e){this.yzi instanceof PlotSubtitleView_1.PlotSubtitleView||(this.SetupInteractiveOption(e,this.yzi.InteractController),this.SetActive(!0))}Azi(){var e=MultiTextLang_1.configMultiTextLang.GetLocalTextNew(TextById_1.configTextById.GetConfig("Leave").Text);this.SetupLeaveOption(e)}Uzi(e){this.SetupSubtitleOption(e,this.yzi.CurrentSubtitle.Id)}GetToggleItem(){return this.$_i?.GetToggleItem()}}exports.PlotOptionItem=PlotOptionItem;
//# sourceMappingURL=PlotOptionItem.js.map