
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.OnlineModel=exports.onlineDisabledSourceTipsId=exports.onlineContinuingChallengeIcon=void 0;const CommonParamById_1=require("../../../Core/Define/ConfigCommon/CommonParamById"),Protocol_1=require("../../../Core/Define/Net/Protocol"),ModelBase_1=require("../../../Core/Framework/ModelBase"),EventDefine_1=require("../../Common/Event/EventDefine"),EventSystem_1=require("../../Common/Event/EventSystem"),TimeUtil_1=require("../../Common/TimeUtil"),ModelManager_1=require("../../Manager/ModelManager"),OnlineHallData_1=require("./OnlineHallData");exports.onlineContinuingChallengeIcon={[0]:"ContinuingChallengeAccept",1:"ContinuingChallengeRefuse",2:"ContinuingChallengePending"},exports.onlineDisabledSourceTipsId={[0]:"OnlineDisabledByNonOnlineQuest",1:"OnlineDisabledByNonOnlinePlay",2:"OnlineDisabledByTrialRole"};class OnlineModel extends ModelBase_1.ModelBase{constructor(){super(...arguments),this.ZGi=void 0,this.eNi=void 0,this.tNi=void 0,this.WorldTeamPlayerFightInfo=[],this.iNi=Protocol_1.Aki.Protocol.$8s.Proto_ConfirmJoin,this.oNi=void 0,this.rNi=0,this.nNi=0,this.sNi=0,this.aNi=0,this.hNi=void 0,this.lNi=3,this._Ni=!1,this.uNi=!1,this.cNi=void 0,this.mNi=new Map,this.dNi=-1,this.CNi=-1,this.gNi=!0,this.fNi=new Map,this.CachePlayerData=void 0,this.HallViewIsShowSearching=!1,this.WCa=(t,e)=>{var i=ModelManager_1.ModelManager.WorldLevelModel.OriginWorldLevel;return t.PlayerOriginWorldLevel>i&&e.PlayerOriginWorldLevel>i||t.PlayerOriginWorldLevel<=i&&e.PlayerOriginWorldLevel<=i?e.PlayerLastOfflineTime-t.PlayerLastOfflineTime:t.PlayerOriginWorldLevel-e.PlayerOriginWorldLevel},this._Da=new Map}OnInit(){return this.ZGi=new Array,this.eNi=new Array,this.tNi=new Array,this.oNi=new Map,this.hNi=new Map,this.rNi=-1,this.aNi=-1,this.nNi=CommonParamById_1.configCommonParamById.GetIntConfig("apply_valid_time"),this.sNi=CommonParamById_1.configCommonParamById.GetIntConfig("world_level_enter_diff"),this.cNi=new Map,!0}OnClear(){return this.ZGi&&(this.ZGi.length=0),this.ZGi=void 0,this.eNi&&(this.eNi.length=0),this.eNi=void 0,this.tNi&&(this.tNi.length=0),this.tNi=void 0,this.oNi&&this.oNi.clear(),this.oNi=void 0,this.hNi&&this.hNi.clear(),this.hNi=void 0,this.rNi=void 0,this.nNi=void 0,this.sNi=void 0,this.cNi?.clear(),this.cNi=void 0,this.mNi&&this.mNi.clear(),this.fNi&&this.fNi.clear(),this.dNi=-1,this.CNi=-1,this.gNi=!0}OnLeaveLevel(){return this.mNi&&this.mNi.clear(),this.dNi=-1,this.CNi=-1,this.gNi=!0,this._Da.clear(),!0}OnChangeMode(){return this._Da.clear(),!0}ClearOnlineTeamMap(){this.hNi&&this.hNi.clear()}get StrangerWorld(){return this.ZGi}get FriendWorld(){return this.eNi}get SearchResult(){return this.tNi}get CurrentPermissionsSetting(){return this.iNi}get CurrentApply(){return this.oNi.get(this.rNi)}get CurrentApplyList(){return this.oNi}get ApplyCd(){return this.nNi}get EnterDiff(){return this.sNi}get OwnerId(){return this.aNi}get TeamMaxSize(){return this.lNi}get ShowCanJoin(){return this.uNi}get ShowFriend(){return this._Ni}get ChallengeApplyPlayerId(){return this.dNi}get NextInitiateTime(){return this.CNi}get NextInitiateLeftTime(){return this.CNi-TimeUtil_1.TimeUtil.GetServerTime()}get AllowInitiate(){return this.gNi}SetHallShowCanJoin(t){this.uNi=t}SetHallShowFriend(t){this._Ni=t}SetTeamOwnerId(t){this.aNi=t}SetPermissionsSetting(t){this.iNi=t}CleanSearchResultList(){this.tNi.length=0}CleanFriendWorldList(){this.eNi.length=0}CleanStrangerWorldList(){this.ZGi.length=0}CleanCurrentApply(){this.oNi.delete(this.rNi),this.rNi=-1}PushSearchResultList(t){this.tNi.push(t)}PushFriendWorldList(t){this.eNi.push(t)}PushStrangerWorldList(t){this.ZGi.push(t)}SortWorldList(t){(t?this.eNi:this.ZGi)?.sort(this.WCa)}PushCurrentApplyList(t){this.oNi.set(t.PlayerId,t),-1===this.rNi&&(this.rNi=t.PlayerId)}PushCurrentTeamList(t){this.hNi.set(t.PlayerId,t)}DeleteCurrentApplyListById(e){if(this.oNi.delete(e),this.oNi.size<1)this.rNi=-1;else{let t=this.nNi;for(const[e,i]of this.oNi)i.ApplyTimeLeftTime<=t&&(t=i.ApplyTimeLeftTime,this.rNi=e)}}DeleteCurrentTeamListById(t){this.hNi.delete(t)}ResetTeamDataPlayer(t){for(const i of this.hNi){var e=i[1];e.PlayerNumber>t&&e.PlayerNumber--}}GetCurrentApplyListById(t){return this.oNi.get(t)}GetCurrentTeamListById(t){return this.hNi.get(t)}GetCurrentApplyList(){var t,e,i=new Array;for([t,e]of this.oNi)0<t&&i.push(e);return i.sort((t,e)=>t.ApplyTimeLeftTime-e.ApplyTimeLeftTime)}GetCurrentApplySize(){return this.oNi.size}GetCurrentTeamSize(){return this.hNi.size}GetIsTeamModel(){return-1!==this.aNi}GetIsMyTeam(){return ModelManager_1.ModelManager.OnlineModel.OwnerId===ModelManager_1.ModelManager.PlayerInfoModel.GetId()}GetExistOnlineTeam(){return-1!==ModelManager_1.ModelManager.OnlineModel.OwnerId}GetCanJoinFormStranger(){var t=ModelManager_1.ModelManager.WorldLevelModel.CurWorldLevel,e=new Array;for(const i of this.ZGi)i.WorldLevel<=t+this.EnterDiff&&e.push(i);return e}GetCanJoinFormFriend(){var t=ModelManager_1.ModelManager.WorldLevelModel.CurWorldLevel,e=new Array;for(const i of this.eNi)this.CanJoinOtherWorld(t,i.WorldLevel)&&e.push(i);return e}CanJoinOtherWorld(t,e){return t+this.EnterDiff>=e}GetTeamList(){var t=new Array;for(const e of this.hNi)t.push(e[1]);return t.sort((t,e)=>t.PlayerNumber-e.PlayerNumber)}DisableOnline(t,e,i=0){e?this.cNi?.set(i,t):this.cNi?.delete(i),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnlineDisableStateChange)}IsOnlineDisabled(){return!!this.cNi&&0<this.cNi.size}GetOnlineDisabledSource(){return this.cNi}ClearWorldTeamPlayerFightInfo(){this.WorldTeamPlayerFightInfo.length=0}DeleteWorldTeamPlayerFightInfo(t){for(const e of this.WorldTeamPlayerFightInfo)e.PlayerId===t&&this.WorldTeamPlayerFightInfo.splice(this.WorldTeamPlayerFightInfo.indexOf(e),1)}PushWorldTeamPlayerFightInfo(t){this.WorldTeamPlayerFightInfo.push(t)}GetWorldTeamPlayerFightInfo(t){for(const e of this.WorldTeamPlayerFightInfo)if(e.PlayerId===t)return e}GetAllWorldTeamPlayer(){var t=new Array;for(const e of this.WorldTeamPlayerFightInfo)t.push(e.PlayerId);return t}RefreshWorldTeamRoleInfo(t){for(const r of t){var e=this.GetWorldTeamPlayerFightInfo(r.q5n);if(e)for(const s of r.xVn)if(-1===s.AVn){var i=new Array;for(const n of s.sUs)i.push(new OnlineHallData_1.WorldTeamRoleInfo(n.O6n,n.P6n));e.RoleInfos=i}}this.WorldTeamPlayerResetIndex()}WorldTeamPlayerResetIndex(){let t=0;for(const e of this.WorldTeamPlayerFightInfo)for(const i of e.RoleInfos)i.RoleIndex=t++}ResetContinuingChallengeConfirmState(){this.mNi.clear();for(const e of ModelManager_1.ModelManager.CreatureModel.GetAllScenePlayers()){var t=e.GetPlayerId();this.mNi.set(t,2)}}SetContinuingChallengeConfirmState(t,e){this.mNi.set(t,e)}GetContinuingChallengeConfirmState(t){return this.mNi.get(t)}SetChallengeApplyPlayerId(t){this.dNi=t}RefreshInitiateTime(){this.CNi=TimeUtil_1.TimeUtil.GetServerTime()+this.ApplyCd}SetAllowInitiate(t){this.gNi=t}SetPlayerTeleportState(t,e){this.fNi.set(t,e)}GetPlayerTeleportState(t){return this.fNi.get(t)}DeletePlayerTeleportState(t){this.fNi.delete(t)}ClearPlayerTeleportState(){this.fNi.clear()}SetRoleActivated(t,e){let i=this._Da.get(t);if(e){if(i){for(const[r,s]of i){const n=ModelManager_1.ModelManager.CreatureModel.GetEntityById(r)?.Entity;n?.Valid&&n.Enable(s,"[OnlineModel] 传送中隐藏")}this._Da.delete(t)}}else{const n=ModelManager_1.ModelManager.SceneTeamModel.GetTeamItem(t,{ParamType:2,IsControl:!0})?.EntityHandle?.Entity;if(n?.Valid&&(i||(i=new Map,this._Da.set(t,i)),!i.get(n.Id))){const s=n.Disable("[OnlineModel] 传送中隐藏");i.set(n.Id,s)}}}RemovePlayerDisableHandles(t){this._Da.delete(t)}}exports.OnlineModel=OnlineModel;
//# sourceMappingURL=OnlineModel.js.map