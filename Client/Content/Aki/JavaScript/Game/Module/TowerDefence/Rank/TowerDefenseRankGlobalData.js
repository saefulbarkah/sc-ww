
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TowerDefenseRankGlobalData=void 0;const Protocol_1=require("../../../../Core/Define/Net/Protocol"),TimeUtil_1=require("../../../Common/TimeUtil"),ConfigManager_1=require("../../../Manager/ConfigManager"),TowerDefenceDefine_1=require("../TowerDefenceDefine"),TowerDefenseRankItemData_1=require("./TowerDefenseRankItemData");class TowerDefenseRankGlobalData{constructor(){this._rc=!1,this.crc=new Map,this.urc=[],this.drc=new Map,this.mrc=[],this.frc=new Map,this.grc=new Map,this.Crc=void 0,this.prc=void 0,this.Znc=(e,t)=>t.PassScore-e.PassScore,this.esc=(e,t)=>e.PassScore-t.PassScore}get IsOpenAnonymousName(){return this._rc}SetIsOpenAnonymousName(e){this._rc=e}yrc(e,t,i){var s=ConfigManager_1.ConfigManager.InstanceDungeonConfig.GetTowerDefenseInstanceByInstance(e),e=s.IsDifficult?this.esc:this.Znc,a=(i.length=0,ConfigManager_1.ConfigManager.InstanceDungeonConfig.GetTowerDefenseRankListSize());t.sort(e);let r=0,n=0;for(let e=0;e<t.length&&!(e>=a);e++){var h=t[e];h.IsEmpty||(0!==e&&!(s.IsDifficult?h.PassScore>n:h.PassScore<n)||(r++,n=h.PassScore),h.Rank=r,i.push(h))}}tsc(e){var t=ConfigManager_1.ConfigManager.InstanceDungeonConfig.GetTowerDefenseInstanceByInstance(e),t=new TowerDefenseRankItemData_1.TowerDefenseRankItemData(!1,t.IsDifficult,Protocol_1.Aki.Protocol.$ic.create());return this.Mrc(t,e),t}isc(e){var t=ConfigManager_1.ConfigManager.InstanceDungeonConfig.GetTowerDefenseInstanceByInstance(e),t=new TowerDefenseRankItemData_1.TowerDefenseRankItemData(!0,t.IsDifficult,Protocol_1.Aki.Protocol.$ic.create());return this.Erc(t,e),t}Src(e){let t=this.frc.get(e),i=(t=t||this.tsc(e),this.Crc=t,this.Crc.IsInRank=this.urc.includes(t),this.grc.get(e));i=i||this.isc(e),this.prc=i,this.prc.IsInRank=this.mrc.includes(i)}Irc(e){let t=this.crc.get(e);return t||(t=[],this.crc.set(e,t)),t}Trc(e){let t=this.drc.get(e);return t||(t=[],this.drc.set(e,t)),t}RefreshAllPassDataRank(e){this.yrc(e,this.Irc(e),this.urc),this.yrc(e,this.Trc(e),this.mrc),this.Src(e),this.RefreshSelfRankItemDataName(e)}SetFriendServerData(e){if(this.crc.clear(),this.drc.clear(),0<e.length)for(const s of e){var t=ConfigManager_1.ConfigManager.InstanceDungeonConfig.GetTowerDefenseConfigById(s.e8n),i=new TowerDefenseRankItemData_1.TowerDefenseRankItemData(!s.Fic,t.IsDifficult,s.Nic);i.IsSelfInData||(i.IsOnline?this.Trc(t.InstanceId):this.Irc(t.InstanceId)).push(i)}}rsc(e){for(const i of e.values())for(const s of i)if(s.IsSelfInData){var t=i.indexOf(s);if(0<=t){i.splice(t,1);break}}}Mrc(e,t){e.IsSelf=!0,this.frc.set(t,e)}Erc(e,t){e.IsSelf=!0,this.grc.set(t,e)}SetSelfServerData(e){if(this.rsc(this.crc),this.rsc(this.drc),0<e.length)for(const s of e){var t=ConfigManager_1.ConfigManager.InstanceDungeonConfig.GetTowerDefenseConfigById(s.e8n),i=new TowerDefenseRankItemData_1.TowerDefenseRankItemData(!s.Fic,t.IsDifficult,s.Nic);(i.IsOnline?(this.Erc(i,t.InstanceId),this.Trc(t.InstanceId)):(this.Mrc(i,t.InstanceId),this.Irc(t.InstanceId)))?.push(i)}}RefreshSelfRankItemDataName(e){var t=this.crc.get(e);if(t)for(const i of t)i.IsSelfInData&&i.RefreshPlayerName(this.IsOpenAnonymousName);t=this.drc.get(e);if(t)for(const s of t)s.IsSelfInData&&s.RefreshPlayerName(this.IsOpenAnonymousName)}GetRankDataListByTabType(e){return e===TowerDefenceDefine_1.ETabType.Single?this.urc:this.mrc}GetSelfRankDataByTabType(e){return e===TowerDefenceDefine_1.ETabType.Single?this.Crc:this.prc}GetBestScoreText(e){this.Src(e);var t,i,e=ConfigManager_1.ConfigManager.InstanceDungeonConfig.GetTowerDefenseInstanceByInstance(e);return this.Crc.IsEmpty!==this.prc.IsEmpty?(t=(this.prc.IsEmpty?this.Crc:this.prc).PassScore,e.IsDifficult?TimeUtil_1.TimeUtil.GetTimeDataFormat(t):t.toString()):(t=this.Crc.PassScore,i=this.prc.PassScore,e.IsDifficult?TimeUtil_1.TimeUtil.GetTimeDataFormat(Math.min(t,i)):Math.max(t,i).toString())}IsOwnSingleBestScore(e){var t=this.Crc.IsEmpty,i=this.prc.IsEmpty;return!(t!==i||!t)||(t!==i?i:(t=this.Crc.PassScore,i=this.prc.PassScore,ConfigManager_1.ConfigManager.InstanceDungeonConfig.GetTowerDefenseInstanceByInstance(e).IsDifficult?t<=i:i<=t))}}exports.TowerDefenseRankGlobalData=TowerDefenseRankGlobalData;
//# sourceMappingURL=TowerDefenseRankGlobalData.js.map