
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.RoleSkinTabView=void 0;const UE=require("ue"),Time_1=require("../../../../../Core/Common/Time"),EventDefine_1=require("../../../../Common/Event/EventDefine"),EventSystem_1=require("../../../../Common/Event/EventSystem"),LocalStorageDefine_1=require("../../../../Common/LocalStorageDefine"),ConfigManager_1=require("../../../../Manager/ConfigManager"),ControllerHolder_1=require("../../../../Manager/ControllerHolder"),ModelManager_1=require("../../../../Manager/ModelManager"),PreloadConfigStatementPart1_1=require("../../../../Preload/PreloadConfigStatementPart1"),UiTabViewBase_1=require("../../../../Ui/Base/UiTabViewBase"),NoCircleAttachView_1=require("../../../AutoAttach/NoCircleAttachView"),ConfirmBoxController_1=require("../../../ConfirmBox/ConfirmBoxController"),ConfirmBoxDefine_1=require("../../../ConfirmBox/ConfirmBoxDefine"),RoleController_1=require("../../../RoleUi/RoleController"),ScrollingTipsController_1=require("../../../ScrollingTips/ScrollingTipsController"),UiCameraAnimationManager_1=require("../../../UiCameraAnimation/UiCameraAnimationManager"),LoadAsyncPromise_1=require("../../../UiComponent/LoadAsyncPromise"),GenericLayout_1=require("../../../Util/Layout/GenericLayout"),LguiUtil_1=require("../../../Util/LguiUtil"),SkinController_1=require("../../SkinController"),WeaponSkinDefine_1=require("../../Tab/Weapon/WeaponSkinDefine"),RoleSkinItem_1=require("../Item/RoleSkinItem"),RoleSkinObtainItem_1=require("../Item/RoleSkinObtainItem");class RoleSkinTabView extends UiTabViewBase_1.UiTabViewBase{constructor(){super(...arguments),this.GIl=void 0,this.ObtainLayout=void 0,this.Vtl=void 0,this.kIl=void 0,this.OIl=0,this.NIl=!1,this.sbl=0,this.abl=0,this.w7l=!0,this.FIl=i=>{var e=new RoleSkinItem_1.RoleSkinItem;return e.CreateThenShowByActor(i),e.ButtonFunction=this.VIl,e},this.iil=()=>new RoleSkinObtainItem_1.RoleSkinObtainItem,this.VIl=i=>{this.OIl!==i&&(this.OIl=i,this.GIl.GetCurrentSelectIndex()!==i&&this.GIl.AttachToIndex(i),i=this.kIl[this.OIl],this.Hqe(i),ControllerHolder_1.ControllerHolder.GuideController.TryFinishRunningGuides())},this.HIl=i=>{1===i?(this.UiViewSequence?.PlaySequence("UiIn"),this.Vtl.SetCaptionItemActive(!0),this.GetButton(3).RootUIComp.SetUIActive(!this.w7l)):(this.UiViewSequence?.PlaySequence("UiOut"),this.Vtl.SetCaptionItemActive(!1),this.GetButton(3).RootUIComp.SetUIActive(!1)),ControllerHolder_1.ControllerHolder.GuideController.TryFinishRunningGuides()},this.jIl=()=>{var i=this.kIl[this.OIl];SkinController_1.SkinController.OpenSkinShowView(i.GetItemId())},this.WIl=()=>{this.lbl()&&(this.OIl--,this.Hqe(this.kIl[this.OIl]),this.GIl.AttachToIndex(this.OIl,!1))},this.QIl=()=>{this.lbl()&&(this.OIl++,this.Hqe(this.kIl[this.OIl]),this.GIl.AttachToIndex(this.OIl,!1))},this.KIl=i=>{this.NIl=1===i,this.Vtl.IsWearWeaponSkin=this.NIl;var i=this.kIl[this.OIl],e=i.GetRoleSkinConfig().SuitWeaponSkinId,e=(ModelManager_1.ModelManager.RoleSkinModel.CheckSuitWeaponFirstWear(e)&&(this.GetUiNiagara(16).SetUIActive(!1),ModelManager_1.ModelManager.RoleSkinModel.RecordSuitWeaponFirstWear(e,!1)),this.NIl&&(e=ConfigManager_1.ConfigManager.SkinConfig.GetWeaponSkinConfig(i.GetRoleSkinConfig().SuitWeaponSkinId),this.Vtl.TsUiSceneRoleActor?.Model?.CheckGetComponent(15)?.ReplaceWeaponModel(e.Models)),UiCameraAnimationManager_1.UiCameraAnimationManager.GetLastHandleData());e&&UiCameraAnimationManager_1.UiCameraAnimationManager.PushCameraHandleByHandleName(e.HandleName,!0,!0,"1001"),this.$Il(i,this.NIl),this.XIl(this.NIl)},this.gke=()=>this.lbl(),this.YIl=()=>{var i=new ConfirmBoxDefine_1.ConfirmBoxDataNew(231);ConfirmBoxController_1.ConfirmBoxController.ShowConfirmBoxNew(i)},this.zIl=()=>{var i=ModelManager_1.ModelManager.SceneTeamModel.GetCurrentEntity.Entity.GetComponent(194);i.HasTag(-1371021686)||i.HasTag(1996802261)?ScrollingTipsController_1.ScrollingTipsController.ShowTipsByTextId("Text_ForbiddenActionInFight_Text"):i.HasTag(-1504358738)?ScrollingTipsController_1.ScrollingTipsController.ShowTipsByTextId("Text_ForbiddenActionInSwimming_Text"):i.HasTag(504239013)?ScrollingTipsController_1.ScrollingTipsController.ShowTipsByTextId("Text_ForbiddenActionInClimbing_Text"):i.HasTag(40422668)?ScrollingTipsController_1.ScrollingTipsController.ShowTipsByTextId("Text_ForbiddenActionMidair_Text"):(i=this.kIl[this.OIl],RoleController_1.RoleController.RoleSkinChangeRequest(this.Vtl.RoleId,i.ItemId,this.NIl,this.JIl))},this.JIl=(i,e)=>{i=ModelManager_1.ModelManager.RoleSkinModel.GetRoleSkinData(i);this.$Il(i,e),this.GIl.RefreshItems(),e&&this.Vtl.InitSelectedWeaponSkinId()}}OnRegisterComponent(){this.ComponentRegisterInfos=[[0,UE.UIItem],[1,UE.UIItem],[2,UE.UIExtendToggle],[3,UE.UIButtonComponent],[4,UE.UIButtonComponent],[5,UE.UIButtonComponent],[6,UE.UIText],[7,UE.UIText],[8,UE.UIText],[9,UE.UIItem],[10,UE.UIExtendToggle],[11,UE.UIButtonComponent],[12,UE.UIVerticalLayout],[13,UE.UIItem],[14,UE.UIButtonComponent],[15,UE.UIItem],[16,UE.UINiagara]],this.BtnBindInfo=[[2,this.HIl],[3,this.jIl],[4,this.WIl],[5,this.QIl],[10,this.KIl],[11,this.YIl],[14,this.zIl]]}async OnBeforeStartAsync(){this.Vtl=this.ExtraParams,this.Vtl.SelectRoleSkinId<=0&&(i=ModelManager_1.ModelManager.RoleModel.GetRoleInstanceById(this.Vtl.RoleId),this.Vtl.SelectRoleSkinId=i.GetRoleSkinId());var i=ModelManager_1.ModelManager.RoleSkinModel.GetRoleSkinData(this.Vtl.SelectRoleSkinId);this.NIl=i.IsWearWeaponSkin(),this.Vtl.IsWearWeaponSkin=this.NIl,this.sbl=PreloadConfigStatementPart1_1.configCommonParamById.GetIntConfig("SkinDetailButtonGap"),await this.N2l(),this.GIl=new NoCircleAttachView_1.NoCircleAttachView(this.GetItem(0).GetOwner());this.GetItem(1).SetUIActive(!1),this.GIl.CreateItems(this.GetItem(1).GetOwner(),-50,this.FIl),this.ObtainLayout=new GenericLayout_1.GenericLayout(this.GetVerticalLayout(12),this.iil,this.GetItem(13).GetOwner()),this.GetExtendToggle(2).SetToggleState(1);var i=this.GetExtendToggle(10),e=this.NIl?1:0;i.SetToggleState(e),i.CanExecuteChange.Bind(this.gke),this.ZIl()}async N2l(){var i=ConfigManager_1.ConfigManager.UiResourceConfig.GetResourcePath("Ani_RoleSkin_Offset"),i=new LoadAsyncPromise_1.LoadAsyncPromise(i,UE.CurveFloat),e=ConfigManager_1.ConfigManager.UiResourceConfig.GetResourcePath("Ani_RoleSkin_Scale"),e=new LoadAsyncPromise_1.LoadAsyncPromise(e,UE.CurveFloat),t=ConfigManager_1.ConfigManager.UiResourceConfig.GetResourcePath("Ani_RoleSkin_Alpha"),t=new LoadAsyncPromise_1.LoadAsyncPromise(t,UE.CurveFloat);await Promise.all([i.Promise,e.Promise,t.Promise]).then(i=>{RoleSkinItem_1.RoleSkinItem.OffsetCurve=i[0],RoleSkinItem_1.RoleSkinItem.ScaleCurve=i[1],RoleSkinItem_1.RoleSkinItem.AlphaCurve=i[2]})}ZIl(){this.kIl=ModelManager_1.ModelManager.RoleSkinModel.GetRoleSkinDataList(this.Vtl.RoleId),this.GIl.ReloadView(this.kIl.length,this.kIl)}Hqe(i){this.Vtl.SelectRoleSkinId=i.GetItemId();var e=i.GetRoleSkinConfig();LguiUtil_1.LguiUtil.SetLocalTextNew(this.GetText(6),e.TitleName),LguiUtil_1.LguiUtil.SetLocalTextNew(this.GetText(7),e.SubDecName),LguiUtil_1.LguiUtil.SetLocalTextNew(this.GetText(8),e.BgDescription),this.ObtainLayout.SetActive(i.IsLocked()&&0<e.ItemAccess.length),this.$Il(i,this.NIl),this.eTl(e.Id),this.GetButton(4).RootUIComp.SetUIActive(0<this.OIl),this.GetButton(5).RootUIComp.SetUIActive(this.OIl<this.kIl.length-1),this.w7l=i.IsOriginalSkin(),this.GetButton(3).RootUIComp.SetUIActive(!this.w7l),this.GetItem(9).SetUIActive(0<e.SuitWeaponSkinId);let t=ModelManager_1.ModelManager.RoleSkinModel.CheckSuitWeaponFirstWear(e.SuitWeaponSkinId);t&&this.NIl&&(t=!1,ModelManager_1.ModelManager.RoleSkinModel?.RecordSuitWeaponFirstWear(e.SuitWeaponSkinId,!1)),this.GetUiNiagara(16).SetUIActive(t),RoleController_1.RoleController.RefreshUiSceneRoleActor(this.Vtl.TsUiSceneRoleActor,this.Vtl.RoleId,i.ItemId);e=this.NIl&&0<e.SuitWeaponSkinId;e&&this.tTl(i),this.XIl(e),this.bl1(i)}$Il(i,e){var t=this.GetButton(14);t.RootUIComp.SetUIActive(!i.IsLocked()),t.SetSelfInteractive(this.CanWearSkin(i,e))}bl1(i){i.IsLocked()||(ModelManager_1.ModelManager.NewFlagModel.RemoveNewFlag(LocalStorageDefine_1.ELocalStoragePlayerKey.RoleSkinRedDot,i.GetItemId()),ModelManager_1.ModelManager.NewFlagModel.SaveNewFlagConfig(LocalStorageDefine_1.ELocalStoragePlayerKey.RoleSkinRedDot),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.RoleSkinRedDotRefresh,i.GetRoleId()),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.MainViewRoleButtonRefreshByRoleSkin))}CanWearSkin(i,e){var t;return!(i.IsLocked()||i.IsWear()&&((t=i.GetRoleSkinConfig().SuitWeaponSkinId)<=0||(i=ModelManager_1.ModelManager.WeaponSkinModel.GetSkinIdByRoleId(i.GetRoleId())===t)&&e||!i&&!e))}tTl(i){0<i.GetRoleSkinConfig().SuitWeaponSkinId?(i=ConfigManager_1.ConfigManager.SkinConfig.GetWeaponSkinConfig(i.GetRoleSkinConfig().SuitWeaponSkinId),this.Vtl.TsUiSceneRoleActor?.Model?.CheckGetComponent(15)?.ReplaceWeaponModel(i.Models)):this.K7l()}K7l(){var i,e=ModelManager_1.ModelManager.WeaponSkinModel.GetSkinIdByRoleId(this.Vtl.RoleId),t=this.Vtl.TsUiSceneRoleActor;e===WeaponSkinDefine_1.WEAPON_SKIN_DEFAULT_ID?(i=ModelManager_1.ModelManager.WeaponModel.GetWeaponDataByIncId(this.Vtl.WeaponIncId).GetWeaponConfig(),t?.Model?.CheckGetComponent(15)?.ReplaceWeaponModel(i.Models)):(i=ConfigManager_1.ConfigManager.SkinConfig.GetWeaponSkinConfig(e),t?.Model?.CheckGetComponent(15)?.ReplaceWeaponModel(i.Models))}XIl(i){i?RoleController_1.RoleController.PlayRoleMontage(6,!1):RoleController_1.RoleController.PlayRoleMontage(3,!1)}OnBeforeShow(){var i=this.kIl.findIndex(i=>i.ItemId===this.Vtl.SelectRoleSkinId),i=(this.GIl.AttachToIndex(i,!0),this.OIl=i,this.kIl[this.OIl]);this.GIl.RefreshItems(),this.Hqe(i),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnRoleSkinSubViewShow,0===this.OIl&&1<this.kIl.length)}eTl(i){i=ModelManager_1.ModelManager.InventoryModel.GetGetWayDataList(i);this.ObtainLayout.RefreshByData(i)}OnBeforeHide(){this.iTl(),this.rTl()}iTl(){this.K7l()}rTl(){var i=ModelManager_1.ModelManager.RoleModel.GetRoleInstanceById(this.Vtl.RoleId);void 0!==i&&void 0!==this.Vtl.TsUiSceneRoleActor&&RoleController_1.RoleController.RefreshUiSceneRoleActor(this.Vtl.TsUiSceneRoleActor,this.Vtl.RoleId,i.GetRoleSkinId())}lbl(){if(0!==this.abl&&Time_1.Time.Now-this.abl<=this.sbl)return!1;return this.abl=Time_1.Time.Now,!0}}exports.RoleSkinTabView=RoleSkinTabView;
//# sourceMappingURL=RoleSkinTabView.js.map