
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MonsterGroupInfo=exports.MonsterPatrolInfo=exports.MonsterGroupPatrolModel=exports.MONSTER_GROUP_PATROL_KEY=void 0;const cpp_1=require("cpp"),UE=require("ue"),Info_1=require("../../../Core/Common/Info"),Log_1=require("../../../Core/Common/Log"),LogAnalyzer_1=require("../../../Core/Common/LogAnalyzer"),Protocol_1=require("../../../Core/Define/Net/Protocol"),ModelBase_1=require("../../../Core/Framework/ModelBase"),Net_1=require("../../../Core/Net/Net"),SplineCurve_1=require("../../../Core/Utils/Curve/SplineCurve"),Quat_1=require("../../../Core/Utils/Math/Quat"),Rotator_1=require("../../../Core/Utils/Math/Rotator"),Transform_1=require("../../../Core/Utils/Math/Transform"),Vector_1=require("../../../Core/Utils/Math/Vector"),MathUtils_1=require("../../../Core/Utils/MathUtils"),IComponent_1=require("../../../UniverseEditor/Interface/IComponent"),ModelManager_1=require("../../Manager/ModelManager"),CharacterUnifiedStateTypes_1=require("../../NewWorld/Character/Common/Component/Abilities/CharacterUnifiedStateTypes"),CombatDebugController_1=require("../../Utils/CombatDebugController"),REPARAM_STEPS=6,END_DISTANCE=30,IS_WITH_EDITOR=cpp_1.KuroApplication.IsWithEditor()?1:void 0;exports.MONSTER_GROUP_PATROL_KEY="MonsterGroupPatrol";class MonsterGroupPatrolModel extends ModelBase_1.ModelBase{constructor(){super(...arguments),this.MonsterPbDataIdList=new Set,this.MonsterEntityInfoMap=new Map,this.MonsterGroups=new Map}OnInit(){return!0}OnClear(){return this.MonsterPbDataIdList.clear(),this.MonsterEntityInfoMap.clear(),this.MonsterGroups.clear(),!0}RecordGroupMonsterPbDataId(t){for(const o of t)Log_1.Log.CheckDebug()&&Log_1.Log.Debug("SceneItem",42,"[GroupAi.Patrol] 记录群组巡逻实体PbDataId",["Id",o]),this.MonsterPbDataIdList.add(o)}IsMonsterInGroup(t){return this.MonsterPbDataIdList.has(t)}RemoveMonsterGroup(t){if(this.MonsterGroups.has(t)){var o=this.MonsterGroups.get(t);for(const r of o.GroupInfo)this.MonsterPbDataIdList.delete(r[1].EntityId);o.Clear(),this.MonsterGroups.delete(t)}}GetMonsterGroup(t){if(this.MonsterGroups.size)return this.MonsterGroups.get(t)}GetMonsterInfoByEntityId(t){return this.MonsterEntityInfoMap.get(t)}GenerateAddMonsterGroup(t,o){o=this.UNl(o);return o?(this.MonsterGroups.set(t,o),!0):(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("SceneItem",42,"[GroupAi.Patrol] 等实体加载完后没有GroupInfo"),!1)}UNl(t){var o=new MonsterGroupInfo;if(o.Init(t)){for(const r of o.GroupInfo)this.MonsterEntityInfoMap.set(r[1].EntityId,r[1]);return o}Log_1.Log.CheckDebug()&&Log_1.Log.Debug("AI",42,"[GroupAi.Patrol] 初始化失败，不进行群组游荡")}}exports.MonsterGroupPatrolModel=MonsterGroupPatrolModel;class MonsterPatrolInfo{constructor(t,o,r){this.PbDataId=0,this.EntityId=0,this.IsCaptain=!1,this.PauseLocation=Vector_1.Vector.Create(),this.PauseDirection=Vector_1.Vector.Create(),this.RelativeLocation=Vector_1.Vector.Create(),this.Group=void 0,this.ActorComp=void 0,this.MoveComp=void 0,this.PatrolComp=void 0,this.Tih=0,this.PbDataId=t,this.EntityId=o.Entity.Id,this.ActorComp=o,this.MoveComp=this.ActorComp.Entity.GetComponent(167),this.Group=r}get GroupPatrolState(){return this.Tih}set GroupPatrolState(t){t!==this.Tih&&(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("AI",42,"[GroupAi.Patrol] ChangeInfoPatrolStateInternal",["PbDataId",this.ActorComp?.CreatureData?.GetPbDataId()],["EntityId",this.ActorComp?.Entity?.Id],["val",t]),this.Group.ChangeInfoPatrolStateInternal(this.Tih,t),this.Tih=t)}ResetRelativeLocation(){var t=ModelManager_1.ModelManager.CreatureModel.GetEntityData(this.PbDataId);this.RelativeLocation.Set(t?.Transform?.Pos.X??0,t?.Transform?.Pos.Y??0,t?.Transform?.Pos.Z??0)}SetIsCaptain(){this.IsCaptain=!0,this.PatrolComp=this.ActorComp.Entity.GetComponent(42),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("AI",42,"[GroupAi.Patrol] 更新群组队长",["PbDataId",this.ActorComp?.CreatureData?.GetPbDataId()],["EntityId",this.ActorComp?.Entity?.Id])}CalculateRelativeLocation(t,o){this.IsCaptain||(MonsterPatrolInfo.Lih.Set(t,o,Vector_1.Vector.OneVectorProxy),MonsterPatrolInfo.Lih.InverseTransformPosition(this.RelativeLocation,this.RelativeLocation),this.RelativeLocation.Z=0,Log_1.Log.CheckDebug()&&Log_1.Log.Debug("AI",42,"[GroupAi.Patrol] 更新相对队长坐标",["PbDataId",this.ActorComp?.CreatureData?.GetPbDataId()],["EntityId",this.ActorComp?.Entity?.Id],["RelativeLocation",this.RelativeLocation]))}}(exports.MonsterPatrolInfo=MonsterPatrolInfo).Lih=Transform_1.Transform.Create();class MonsterGroupInfo{constructor(){this.DNl=0,this.wih=-1,this.LAl=0,this.RAl=0,this.Aih=[],this.GroupInfo=new Map,this.ANl=0,this.Htn=0,this.md=void 0,this.$ie=void 0,this.PNl=!1,this.UAl=0,this.xNl=!1}get CaptainInfo(){if(this.GroupInfo.has(this.wih))return this.GroupInfo.get(this.wih)}Init(t){return this.ANl=t.Option.Leader,this.kih(t.Entities),!!this.Oih(t.Option.SplineEntityId)&&this.wNl()}wNl(){return this.BNl(),!!this.bNl()&&(this.qNl(),this.GNl(),!0)}Clear(){this.ExitPatrol(),this.GroupInfo.clear(),this.$ie=void 0,this.md=void 0,this.$ie=void 0}CheckMonsterValid(){MonsterGroupInfo.kNl.length=0;for(const o of this.GroupInfo){var t=o[1];t.ActorComp?.Valid&&t.MoveComp?.Valid||MonsterGroupInfo.kNl.push(t.EntityId)}if(0<MonsterGroupInfo.kNl.length){for(const r of MonsterGroupInfo.kNl)this.GroupInfo.delete(r);if(0===this.GroupInfo.size)return!1;this.wNl()}return!0}GetAllMonsterInState(){for(let t=0;t<4;t++)if(this.Aih[t]===this.LAl)return t;return 4}ChangeInfoPatrolStateInternal(t,o){this.Aih[t]--,this.Aih[o]++}ReadyToStartPatrol(){for(const o of this.GroupInfo){var t=o[1];this.DAl(t)}}PausePatrol(){for(const o of this.GroupInfo){var t=o[1];2===t.GroupPatrolState&&(t.GroupPatrolState=1,this.ONl(t),t.IsCaptain?t.PatrolComp?.PausePatrol(this.Htn,exports.MONSTER_GROUP_PATROL_KEY):t.MoveComp?.MoveController.StopMove())}}ExitPatrol(){for(const o of this.GroupInfo){var t=o[1];2===t.GroupPatrolState&&(t.GroupPatrolState=3,t.IsCaptain?t.PatrolComp?.StopPatrol(this.Htn):t.MoveComp?.MoveController.StopMove())}}CheckMonsterMoveSpeed(){for(const e of this.GroupInfo){const i=e[1];var t,o,r;i.IsCaptain?this.AAl(i):(o=i.MoveComp?.MoveController)&&(t=Math.min(END_DISTANCE,.5*i.ActorComp.Radius),(r=o.GetMoveToLocationLogic()?.GetCurrentDistance()??-1)<0?o.NavigateMoveToLocation({Position:this.xAl(i),ReferencePosition:()=>this.xAl(i),Distance:END_DISTANCE+t,MoveState:CharacterUnifiedStateTypes_1.ECharMoveState.Walk,ReturnTimeoutFailed:3}):(o=i.ActorComp?.Owner)instanceof UE.Character&&(r=.02*MathUtils_1.MathUtils.Clamp(r-50-t,-50,300)*.125+.875,o.SetAnimRootMotionTranslationScale(r)))}}kih(t){var o=new Array;for(const s of t){ModelManager_1.ModelManager.CreatureModel.GetEntitiesWithPbDataId(s,o);var r=o[0]?.Entity,e=r?.GetComponent(3),i=r?.GetComponent(39);r&&e?i?(i=new MonsterPatrolInfo(s,e,this),this.GroupInfo.set(r.Id,i)):Log_1.Log.CheckWarn()&&Log_1.Log.Warn("AI",42,"[GroupAi.Patrol] 实体没有移动组件",["PbDataId",s]):Log_1.Log.CheckWarn()&&Log_1.Log.Warn("AI",42,"[GroupAi.Patrol] 没有实体",["PbDataId",s])}}Oih(t){var o,r,e=ModelManager_1.ModelManager.CreatureModel.GetCompleteEntityData(t);return e?(o=(0,IComponent_1.getComponent)(e.ComponentsData,"SplineComponent"))&&o.Option.Points?o.Option.Points.length<2?(Log_1.Log.CheckError()&&Log_1.Log.Error("AI",42,"[GroupAi.Patrol] 群组巡逻样条点数量小于2",["SplineEntityId",t]),!1):((r=new SplineCurve_1.SplineCurve(REPARAM_STEPS)).InitPoints(o.Option.Points),e.Transform&&r.SetSplineTransform(e.Transform,!1),this.Htn=t,this.md=r,(this.$ie=o).Option.Type===IComponent_1.ESplineType.Patrol&&o.Option.CycleOption?.Type===IComponent_1.EPatrolCycleMode.Loop&&(this.PNl=o.Option.CycleOption.IsCircle),!0):(Log_1.Log.CheckError()&&Log_1.Log.Error("AI",42,"[GroupAi.Patrol] 无法找到样条组件配置",["SplineEntityId",t]),!1):(Log_1.Log.CheckError()&&Log_1.Log.Error("AI",42,"[GroupAi.Patrol] 无法找到SplineEntityData",["SplineEntityId",t]),!1)}BNl(){for(let t=this.Aih.length=0;t<4;t++)this.Aih.push(0);for(const o of this.GroupInfo){var t=o[1];this.Aih[t.GroupPatrolState]=this.Aih[t.GroupPatrolState]+1}this.LAl=this.GroupInfo.size}bNl(){this.wih=-1;var t=ModelManager_1.ModelManager.CreatureModel.GetEntityData(this.ANl)?.Transform?.Pos;MonsterGroupInfo.jye.Set(t?.X??0,t?.Y??0,t?.Z??0);let o=MathUtils_1.MathUtils.MaxFloat,r=0;for(const s of this.GroupInfo){var e=s[1],i=(e.IsCaptain=!1,e.ResetRelativeLocation(),Vector_1.Vector.DistSquared(e.RelativeLocation,MonsterGroupInfo.jye));o>i&&(o=i,r=e.EntityId)}return!!this.GroupInfo.has(r)&&(this.GroupInfo.get(r).SetIsCaptain(),this.wih=r,!0)}qNl(){if(this.CaptainInfo?.ActorComp){let t=0,o=0;this.RAl=0;for(const i of this.GroupInfo){var r,e=i[1];!e.IsCaptain&&(r=ModelManager_1.ModelManager.CreatureModel.GetEntityData(this.ANl)?.Transform?.Rot,MonsterGroupInfo.Gco.Set(r?.Y??0,r?.Z??0,r?.X??0),MonsterGroupInfo.Gco.Quaternion(MonsterGroupInfo.jJo),e.CalculateRelativeLocation(this.CaptainInfo.RelativeLocation,MonsterGroupInfo.jJo),(0===t||t>e.RelativeLocation.X)&&(t=e.RelativeLocation.X),0===o||o<e.RelativeLocation.X)&&(o=e.RelativeLocation.X)}this.RAl=t+o}}GNl(){for(const o of this.GroupInfo){var t=o[1];this.ONl(t)}}ONl(t){let o=this.DNl;(o<0||o>=this.md.GetSplinePointsNum())&&(o=0),this.md.GetDirectionAtSplinePoint(o,1,MonsterGroupInfo.jye),MonsterGroupInfo.jye.Z=0,this.xNl&&MonsterGroupInfo.jye.UnaryNegation(MonsterGroupInfo.jye),t.PauseDirection.DeepCopy(MonsterGroupInfo.jye),t.IsCaptain?this.md.GetLocationAtSplinePoint(o,1,MonsterGroupInfo.jye):(MonsterGroupInfo.jye.Rotation(MonsterGroupInfo.Gco),MonsterGroupInfo.Lih.SetRotation(MonsterGroupInfo.Gco.Quaternion(MonsterGroupInfo.jJo)),this.md.GetLocationAtSplinePoint(o,1,MonsterGroupInfo.jye),MonsterGroupInfo.Lih.SetLocation(MonsterGroupInfo.jye),MonsterGroupInfo.Lih.SetScale3D(Vector_1.Vector.OneVectorProxy),MonsterGroupInfo.Lih.TransformPosition(t.RelativeLocation,MonsterGroupInfo.jye)),t.PauseLocation.DeepCopy(MonsterGroupInfo.jye)}DAl(t){t.MoveComp&&!t.MoveComp.MoveController.IsMoving()&&t.MoveComp.MoveController.MoveToLocation({Position:t.PauseLocation,CallbackList:[()=>{t.GroupPatrolState=2}],Distance:END_DISTANCE,MoveState:CharacterUnifiedStateTypes_1.ECharMoveState.Walk,ReturnTimeoutFailed:3})}PAl(t){if(this.UAl!==t){this.UAl=t;for(const r of this.GroupInfo){var o=r[1];o.IsCaptain||(o.RelativeLocation.X*=-1,o.RelativeLocation.Y*=-1,o.RelativeLocation.X+=this.RAl)}this.xNl=!this.xNl}}xAl(t){return MonsterGroupInfo.Lih.FromUeTransform(this.CaptainInfo.ActorComp.ActorTransform),MonsterGroupInfo.Lih.TransformPosition(t.RelativeLocation,MonsterGroupInfo.jye),MonsterGroupInfo.jye.Z-=this.CaptainInfo.ActorComp.HalfHeight,MonsterGroupInfo.jye}AAl(o){var t,r=o.PatrolComp;r&&!r.IsInPatrol()&&(!r||r.GetIsPauseState(this.Htn)?(o.GroupPatrolState=2,r.ResumePatrol(this.Htn,exports.MONSTER_GROUP_PATROL_KEY)):(t={DebugMode:!1,UseNearestPoint:!0,IgnorePointDirection:!0,ReturnFalseWhenNavigationFailed:!1,NoRequestServer:!0,OnArrivePointHandle:()=>{var t=this.md.GetSplinePointsNum()-1;this.DNl=o.PatrolComp.GetLastPointRawIndex(),this.PNl&&this.DNl%t==0&&this.PAl(this.DNl),this.BJo()},OnPatrolEndHandle:()=>{this.ExitPatrol()}},o.GroupPatrolState=2,r.StartSplineCurvePatrol(this.Htn,this.md,this.$ie,t)))}BJo(){for(const i of this.GroupInfo){var t,o,r,e=i[1];e.IsCaptain||e.MoveComp?.MoveController&&((t=(o=e.ActorComp.Entity.GetComponent(61)).GetCurrentMoveSample()).P5n=e.ActorComp.ActorLocationProxy,o.PendingMoveInfos.push(t),(r=Protocol_1.Aki.Protocol.Yus.create()).uhh=ModelManager_1.ModelManager.GameModeModel.IsMulti?ModelManager_1.ModelManager.OnlineModel.OwnerId:ModelManager_1.ModelManager.CreatureModel.GetPlayerId(),r.WRs.push(o.CollectPendingMoveInfos()),Net_1.Net.Send(25001,r),Info_1.Info.IsBuildDevelopmentOrDebug&&(o={scene_id:ModelManager_1.ModelManager.CreatureModel.GetSceneId(),instance_id:ModelManager_1.ModelManager.CreatureModel.GetInstanceId(),msg_id:25001,immediately:!0,sub_count:r.WRs.length,is_multi:ModelManager_1.ModelManager.GameModeModel.IsMulti,ed:IS_WITH_EDITOR,br:LogAnalyzer_1.LogAnalyzer.GetBranch()},r=JSON.stringify(o),CombatDebugController_1.CombatDebugController.DataReport("COMBAT_MESSAGE_COUNT",r)),Log_1.Log.CheckDebug())&&Log_1.Log.Debug("AI",42,"向服务器同步怪物位置",["EntityId",e.EntityId],["PbDataId",e.PbDataId],["X",t.P5n.X],["Y",t.P5n.Y],["Z",t.P5n.Z])}}}(exports.MonsterGroupInfo=MonsterGroupInfo).kNl=[],MonsterGroupInfo.jye=Vector_1.Vector.Create(),MonsterGroupInfo.Lih=Transform_1.Transform.Create(),MonsterGroupInfo.Gco=Rotator_1.Rotator.Create(),MonsterGroupInfo.jJo=Quat_1.Quat.Create();
//# sourceMappingURL=MonsterGroupPatrolModel.js.map