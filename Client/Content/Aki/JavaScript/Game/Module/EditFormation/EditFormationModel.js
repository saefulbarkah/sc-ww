
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.EditFormationModel=void 0;const Log_1=require("../../../Core/Common/Log"),ModelBase_1=require("../../../Core/Framework/ModelBase"),ModelManager_1=require("../../Manager/ModelManager"),CharacterAttributeTypes_1=require("../../NewWorld/Character/Common/Component/Abilities/CharacterAttributeTypes"),EditFormationData_1=require("./EditFormationData"),EditFormationDefine_1=require("./EditFormationDefine"),HEALTH_ID=3;class EditingRoleData{constructor(t){this.Position=0,this.RoleId=0,this.Position=t}}class EditFormationModel extends ModelBase_1.ModelBase{constructor(){super(...arguments),this.s5t=new Map,this.a5t=void 0,this.h5t=new Map}UpdatePlayerFormations(t){this.s5t.clear();let r=0;var o=new Map;for(const M of t){var e=M.W5n,a=e===ModelManager_1.ModelManager.PlayerInfoModel.GetId();for(const h of M.kVn){var i=h.GVn;if(a||!(0<i)){a&&h.OVn&&(r=i);let t=o.get(i);t||(t=new Array,o.set(i,t));for(const c of h.dUs){var n=a&&c.Q6n===h.NVn;t.push([c,e,n])}}}}for(const g of o){var s=g[0],d=new EditFormationData_1.EditFormationData(s);this.s5t.set(s,d);for(const m of g[1]){var f=m[0],l=m[1],u=m[2];d.AddRoleData(f.Q6n,f.Or1,f.F6n,l,u)}s===r&&(this.a5t=d)}}ChangeEditedMainRole(){var t=ModelManager_1.ModelManager.RoleModel;for(const e of this.h5t.values())for(const a of e){var r,o=a.RoleId;t.IsMainRole(o)&&(r=t.GetNewMainRoleId(o))&&o!==r&&(a.RoleId=r)}}InitEditingFormationMap(){this.h5t.clear();for(const r of this.s5t.values()){var t=r.FormationId;for(const o of r.GetRoleDataMap().values())this.SetEditingRoleId(t,o.Position,o.ConfigId)}}IsRoleDead(t){var r=ModelManager_1.ModelManager.SceneTeamModel.GetTeamItem(t,{ParamType:0,OnlyMyRole:!0});return r?r.IsDead():!(r=ModelManager_1.ModelManager.RoleModel.GetRoleDataById(t))||r.GetAttributeData().GetAttrValueById(HEALTH_ID)<=0}SetEditingRoleId(t,r,o=0,e=!0){if(r>EditFormationDefine_1.EDITE_FORAMTION_MAX_NUM||r<=0)return!1;if(!this.IsMyPosition(r))return!1;let a=this.h5t.get(t);if(!a){a=new Array,this.h5t.set(t,a);for(let t=1;t<=EditFormationDefine_1.EDITE_FORAMTION_MAX_NUM;t++)a.push(new EditingRoleData(t))}var i=[];for(const s of a){s.Position===r&&(s.RoleId=o);var n=s.RoleId;n&&i.push(n)}if(!ModelManager_1.ModelManager.GameModeModel.IsMulti&&e)for(const d of a){const o=i[d.Position-1];d.RoleId=o??0}return!0}GetEditingRoleId(t,r){t=this.h5t.get(t);if(t)for(const o of t)if(o.Position===r)return o.RoleId;return 0}GetEditingRolePosition(t,r){t=this.h5t.get(t);if(t)for(const o of t)if(o.RoleId===r)return o.Position;return-1}GetEditingRoleIdList(t){var r=new Array,t=this.h5t.get(t);if(t)for(const e of t){var o=e.RoleId;o&&r.push(o)}return r}GetAllEditingFormation(){var t,r,o=new Map;for([t,r]of this.h5t){var e=[];for(const i of r){var a=i.RoleId;a&&e.push(a)}o.set(t,e)}return o}IsInEditingFormation(t,r){return 0<this.GetEditingRolePosition(t,r)}GetFormationData(t){return this.s5t.get(t)}get GetCurrentFormationData(){return this.a5t}get GetCurrentFormationId(){return this.a5t?.FormationId}IsRoleInCurrentFormation(t){return void 0!==this.a5t&&this.a5t.GetRoleIdList.includes(t)}ApplyCurrentFormationData(t){t=this.s5t.get(t);t&&(Log_1.Log.CheckInfo()&&Log_1.Log.Info("Formation",48,"设置当前编队数据 [ApplyCurrentFormationData]",["data",t]),this.a5t=t)}IsMyPosition(t){var r;return!ModelManager_1.ModelManager.GameModeModel.IsMulti||(r=ModelManager_1.ModelManager.OnlineModel.GetIsMyTeam(),(t=this.GetCurrentFormationData?.GetRoleDataByPosition(t))?.ConfigId?ModelManager_1.ModelManager.PlayerInfoModel.GetId()===t.PlayerId:r)}GetFormationAverageLevel(){let t=0,r=0;for(const e of ModelManager_1.ModelManager.SceneTeamModel.GetTeamEntities()){var o=e.Entity?.GetComponent(162);o&&(t+=o.GetCurrentValue(CharacterAttributeTypes_1.EAttributeId.Proto_Lv),r++)}return r?t/r:0}}exports.EditFormationModel=EditFormationModel;
//# sourceMappingURL=EditFormationModel.js.map