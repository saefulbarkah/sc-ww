
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.GameAudioModel=exports.CHECK_TIME_OUT_COOLDOWN_RECORD=void 0;const AudioSystem_1=require("../../../Core/Audio/AudioSystem"),Log_1=require("../../../Core/Common/Log"),Time_1=require("../../../Core/Common/Time"),GongduolaPassengerVoiceConfigByRoleIdAndTriggerType_1=require("../../../Core/Define/ConfigQuery/GongduolaPassengerVoiceConfigByRoleIdAndTriggerType"),EntitySystem_1=require("../../../Core/Entity/EntitySystem"),ModelBase_1=require("../../../Core/Framework/ModelBase"),MathUtils_1=require("../../../Core/Utils/MathUtils"),IAction_1=require("../../../UniverseEditor/Interface/IAction"),EventDefine_1=require("../../Common/Event/EventDefine"),EventSystem_1=require("../../Common/Event/EventSystem"),ModelManager_1=require("../../Manager/ModelManager"),VehicleModel_1=require("../../NewWorld/Vehicle/Model/VehicleModel"),PreloadConfigStatementPart1_1=require("../../Preload/PreloadConfigStatementPart1"),FlowController_1=require("../Plot/Flow/FlowController");exports.CHECK_TIME_OUT_COOLDOWN_RECORD=1e4;class EntityCooldownProbability{constructor(){this.EntityId=0,this.TagComp=void 0,this.AudioEventCooldownTimeMap=void 0}Init(e){this.EntityId=e,this.AudioEventCooldownTimeMap=new Map,this.TagComp=EntitySystem_1.EntitySystem.GetComponent(e,194)}Clear(){this.TagComp=void 0,this.AudioEventCooldownTimeMap?.clear(),this.AudioEventCooldownTimeMap=void 0}CheckTimeOutCooldownRecords(){this.AudioEventCooldownTimeMap||(this.AudioEventCooldownTimeMap=new Map);var e=[];for(const o of this.AudioEventCooldownTimeMap)Time_1.Time.Now-o[1].Time<Math.max(o[1].Cooldown,exports.CHECK_TIME_OUT_COOLDOWN_RECORD)?this.TagComp||(this.TagComp=EntitySystem_1.EntitySystem.GetComponent(this.EntityId,194)):(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[EntityCooldownProbability] 记录的AudioEvent冷却时间一定时间未使用过，删除该条记录",["EntityId",this.EntityId],["AudioEvent",o[0]],["IntervalTime",Time_1.Time.Now-o[1].Time]),e.push(o[0]));for(const i of e)this.AudioEventCooldownTimeMap.delete(i);return 0===this.AudioEventCooldownTimeMap.size}CheckPlayAudio(o,i){if(i.TagProbability&&this.TagComp&&0<i.TagProbability.Num())for(let e=0;e<i.TagProbability.Num();e++){var t,r=i.TagProbability.Get(e);if(this.TagComp.HasTag(r.GameplayTag.TagId))return(t=this.u_l(o,r.Probability,r.CooldownTime))&&Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[EntityCooldownProbability] 通过了配置的概率和CD检查，正常播放AudioEvent",["EntityId",this.EntityId],["AudioEvent",o],["Tag",r.GameplayTag.TagName],["Probability",r.Probability],["CooldownTime",r.CooldownTime]),t}var e=this.u_l(o,i.DefaultProbability,i.DefaultCooldownTime);return e&&Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[EntityCooldownProbability] 通过了默认概率和CD检查，正常播放AudioEvent",["EntityId",this.EntityId],["AudioEvent",o],["Probability",i.DefaultProbability],["CooldownTime",i.DefaultCooldownTime]),e}u_l(e,o,i){if(this.c_l(o)){this.AudioEventCooldownTimeMap||(this.AudioEventCooldownTimeMap=new Map);var t=this.AudioEventCooldownTimeMap.has(e)?Time_1.Time.Now-this.AudioEventCooldownTimeMap.get(e).Time:-1;if(t<0||i<t)return 0!==i&&(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[EntityCooldownProbability] 通过概率和CD检查，更新Map",["EntityId",this.EntityId],["AudioEvent",e],["距离上一次播放",t]),this.AudioEventCooldownTimeMap.set(e,{Time:Time_1.Time.Now,Cooldown:i})),!0;Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[EntityCooldownProbability] 播放Audio不满足CD检查",["EntityId",this.EntityId],["AudioEvent",e],["CooldownTime",i],["距离上一次播放",t])}else Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[EntityCooldownProbability] 播放Audio不满足概率检查",["EntityId",this.EntityId],["AudioEvent",e],["Probability",o]);return!1}c_l(e){return 1===e||0===e?1===e:Math.random()<e}}class GameAudioModel extends ModelBase_1.ModelBase{constructor(){super(...arguments),this.u6l=0,this.d6l=0,this.m_l=new Map,this.Obl=0,this.Nbl=0,this.RNl=0,this.Bbl=0,this.bbl=0,this.qbl=!1,this.m6l=0,this.C6l=0,this.g6l=0,this.f6l=0,this.Cjo=e=>{e.FlowIncId===this.p6l?.PlotHandle?.Handle&&(this.p6l.PlotHandle=void 0,Log_1.Log.CheckDebug())&&Log_1.Log.Debug("Audio",42,"[Vehicle.Audio] 贡多拉与角色共乘剧情播放结束")},this.v6l=!1,this.p6l=void 0}OnInit(){return this.u6l=PreloadConfigStatementPart1_1.configCommonParamById.GetIntConfig("GondolaRideSharingAudioCoolDown")??0,this.d6l=PreloadConfigStatementPart1_1.configCommonParamById.GetIntConfig("GondolaRideSharingPlotCoolDown")??0,!0}CheckTimeOutCooldownRecords(){var e=[];for(const o of this.m_l)o[1].CheckTimeOutCooldownRecords()&&(o[1].Clear(),e.push(o[0]));for(const i of e)Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[EntityCooldownProbability] 记录的实体上所有AudioEvent都一定时间未使用过，删除该条记录",["EntityId",i]),this.m_l.delete(i)}CheckAudioProbabilityInfo(e,o,i){if(!i||0===i.DefaultCooldownTime&&1===i.DefaultProbability&&(!i.TagProbability||0===i.TagProbability.Num()))return!0;if(0===i.DefaultProbability&&(!i.TagProbability||0===i.TagProbability.Num()))return!1;if(!this.m_l.has(e)){const r=new EntityCooldownProbability;r.Init(e);var t=r.CheckPlayAudio(o,i);return t&&this.m_l.set(e,r),t}const r=this.m_l.get(e);return r.CheckPlayAudio(o,i)}AddAllGondolaMusic(e){this.Obl=ModelManager_1.ModelManager.GameAudioModel.AddGondolaKeepDriveMusic(),this.Nbl=ModelManager_1.ModelManager.GameAudioModel.AddGondolaStopDriveMusic(),this.RNl=ModelManager_1.ModelManager.GameAudioModel.AddGondolaSlowToFastSound(e)}StopAllGondolaMusic(){this.ENl(),ModelManager_1.ModelManager.VehicleModel.RemoveKeepDrivingInfo(this.Obl),ModelManager_1.ModelManager.VehicleModel.RemoveKeepDrivingInfo(this.Nbl),ModelManager_1.ModelManager.VehicleModel.RemoveKeepDrivingInfo(this.RNl)}AddGondolaKeepDriveMusic(){const e=PreloadConfigStatementPart1_1.configCommonParamById.GetStringConfig("GondolaKeepDriveAudio");var o=PreloadConfigStatementPart1_1.configCommonParamById.GetIntConfig("GondolaKeepDriveSpeed"),i=PreloadConfigStatementPart1_1.configCommonParamById.GetIntConfig("GondolaKeepDriveDuration"),o=new VehicleModel_1.KeepDrivingDurationAtSpeed([o,MathUtils_1.MathUtils.MaxFloat],i,()=>!this.qbl,()=>{this.qbl||(this.qbl=!0,0!==this.bbl&&(AudioSystem_1.AudioSystem.ExecuteAction(this.bbl,0),this.bbl=0),this.Bbl=AudioSystem_1.AudioSystem.PostEvent(e),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[Vehicle.Audio] PostEvent 播放船歌",["Name",e]))});return ModelManager_1.ModelManager.VehicleModel?.AddKeepDrivingInfo(o)??0}AddGondolaStopDriveMusic(){var e=PreloadConfigStatementPart1_1.configCommonParamById.GetIntConfig("GondolaStopDriveSpeed"),o=PreloadConfigStatementPart1_1.configCommonParamById.GetIntConfig("GondolaStopDriveDuration"),e=new VehicleModel_1.KeepDrivingDurationAtSpeed([0,e],o,()=>this.qbl,()=>{this.qbl&&this.ENl()});return ModelManager_1.ModelManager.VehicleModel?.AddKeepDrivingInfo(e)??0}ENl(){this.qbl=!1;var e=PreloadConfigStatementPart1_1.configCommonParamById.GetStringConfig("GondolaStopDriveAudio");0!==this.Bbl&&(AudioSystem_1.AudioSystem.ExecuteAction(this.Bbl,0,{TransitionDuration:3500}),this.Bbl=0),this.bbl=AudioSystem_1.AudioSystem.PostEvent(e),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[Vehicle.Audio] PostEvent 停止船歌",["Name",e])}AddGondolaSlowToFastSound(o){const i=PreloadConfigStatementPart1_1.configCommonParamById.GetStringConfig("GondolaSlowToFastSoundEvent");var e=PreloadConfigStatementPart1_1.configCommonParamById.GetIntConfig("GondolaSoundSpeedDivide"),t=PreloadConfigStatementPart1_1.configCommonParamById.GetIntConfig("GondolaSlowToFastSoundCoolDown"),e=new VehicleModel_1.PlayDrivingSoundOnReachSpeed([e,MathUtils_1.MathUtils.MaxFloat],t,void 0,()=>{var e=o?.GetComponent(1);e?(AudioSystem_1.AudioSystem.PostEvent(i,e.Owner),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[Vehicle.Audio] PostEvent 从慢速到快速播放音效",["Name",i],["Owner",e.Owner?.GetName()])):Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[Vehicle.Audio] 贡多拉从慢速到快速播放音效失败,没有Actor",["Entity",o?.Id])});return ModelManager_1.ModelManager.VehicleModel?.AddKeepDrivingInfo(e)??0}GondolaGetOnAudioEvent(e){var o=PreloadConfigStatementPart1_1.configCommonParamById.GetStringConfig("GondolaGetOnAudioEvent"),i=e?.GetComponent(1);i?(AudioSystem_1.AudioSystem.PostEvent(o,i.Owner),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[Vehicle.Audio] PostEvent 贡多拉上下船播放音效",["Name",o],["Owner",i.Owner?.GetName()])):Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[Vehicle.Audio] 贡多拉从慢速到快速播放音效失败,没有Actor",["Entity",e?.Id])}RegisterDriveAudioEvent(e,o){this.p6l={RoleId:e,RoleCreatureId:o,PassengerId:0,PassengerActor:void 0},EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.PlotNetworkEnd,this.Cjo),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[Vehicle.Audio] 触发与角色共乘",["roleId",this.p6l.RoleId],["roleCreatureId",this.p6l.RoleCreatureId]),this.m6l=ModelManager_1.ModelManager.GameAudioModel.AddRideSharingKeepMoveAudio(),this.C6l=ModelManager_1.ModelManager.GameAudioModel.AddRideSharingKeepIdleAudio(),this.g6l=ModelManager_1.ModelManager.GameAudioModel.AddRideSharingMovingInfo(),this.f6l=ModelManager_1.ModelManager.GameAudioModel.AddRideSharingStopMovingAudio()}RemoveDriveAudioEvent(){ModelManager_1.ModelManager.VehicleModel.RemoveKeepDrivingInfo(this.m6l),ModelManager_1.ModelManager.VehicleModel.RemoveKeepDrivingInfo(this.C6l),ModelManager_1.ModelManager.VehicleModel.RemoveKeepDrivingInfo(this.g6l),ModelManager_1.ModelManager.VehicleModel.RemoveKeepDrivingInfo(this.f6l),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.PlotNetworkEnd,this.Cjo),this.y6l(MathUtils_1.MathUtils.MaxFloat),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[Vehicle.Audio] 退出与角色共乘",["roleId",this.p6l?.RoleId],["roleCreatureId",this.p6l?.RoleCreatureId]),this.p6l=void 0}y6l(e){let o=!0;return this.p6l?.AudioHandle&&(this.p6l.AudioHandle.Priority<e?(AudioSystem_1.AudioSystem.ExecuteAction(this.p6l.AudioHandle.Handle,0),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[Vehicle.Audio] 打断当前正在播放优先级更低的共乘语音"),this.p6l.AudioHandle=void 0):o=!1),this.p6l?.PlotHandle&&(this.p6l.PlotHandle.Priority<e?(FlowController_1.FlowController.FinishFlow("退出共乘停止角色共乘剧情",this.p6l.PlotHandle.Handle,!1),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[Vehicle.Audio] 打断当前正在播放优先级更低的共乘剧情"),this.p6l.PlotHandle=void 0):o=!1),!!o}S6l(){var e,o;this.p6l&&(o=(e=ModelManager_1.ModelManager.CreatureModel?.GetEntity(this.p6l.RoleCreatureId))?.Entity?.GetComponent(1),e?.Entity&&o?(this.p6l.PassengerActor=o,this.p6l.PassengerId=e.Entity.Id):(Log_1.Log.CheckError()&&Log_1.Log.Error("Audio",42,"[Vehicle.Audio] 贡多拉与角色共乘语音事件播放,没有乘客实体",["roleId",this.p6l.RoleId],["roleCreatureId",this.p6l.RoleCreatureId]),this.p6l=void 0))}CheckRideSharingState(){return!!ModelManager_1.ModelManager.VehicleModel.CanRiderSharing&&!(!ModelManager_1.ModelManager.VehicleModel.RideSharingInfo||!this.p6l||!this.p6l.PassengerActor&&(this.S6l(),!this.p6l?.PassengerActor))}AddRideSharingKeepMoveAudio(){var e=PreloadConfigStatementPart1_1.configCommonParamById.GetIntConfig("GondolaRoleAudioKeepMove"),e=new VehicleModel_1.KeepDrivingDurationAtSpeed([1,MathUtils_1.MathUtils.MaxFloat],e,()=>this.CheckRideSharingState(),()=>{this.PlayRideSharingPlotAudio(IAction_1.EGondolaVoiceTriggeredType.KeepMoving)},Math.max(e,this.d6l));return ModelManager_1.ModelManager.VehicleModel?.AddKeepDrivingInfo(e)??0}AddRideSharingKeepIdleAudio(){var e=PreloadConfigStatementPart1_1.configCommonParamById.GetIntConfig("GondolaRoleAudioIdle"),e=new VehicleModel_1.KeepDrivingDurationAtSpeed([0,1],e,()=>this.CheckRideSharingState(),()=>{this.PlayRideSharingPlotAudio(IAction_1.EGondolaVoiceTriggeredType.StayIdle)},Math.max(e,this.d6l));return ModelManager_1.ModelManager.VehicleModel?.AddKeepDrivingInfo(e)??0}AddRideSharingMovingInfo(){const e=PreloadConfigStatementPart1_1.configCommonParamById.GetIntConfig("GondolaRoleAudioStopMove");var o=new VehicleModel_1.KeepDrivingDurationAtSpeed([1,MathUtils_1.MathUtils.MaxFloat],e,()=>!this.v6l,()=>{this.v6l||(this.v6l=!0,Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[Vehicle.Audio] 达成持续移动N秒",["Time",e]))});return ModelManager_1.ModelManager.VehicleModel?.AddKeepDrivingInfo(o)??0}AddRideSharingStopMovingAudio(){var e=new VehicleModel_1.KeepDrivingDurationAtSpeed([0,0],0,()=>this.v6l,()=>{this.v6l&&(this.v6l=!1,this.PlayRideSharingPlotAudio(IAction_1.EGondolaVoiceTriggeredType.StopMoving))});return ModelManager_1.ModelManager.VehicleModel?.AddKeepDrivingInfo(e)??0}PlayRideSharingPlotAudio(e){var o,i,t;return!!(ModelManager_1.ModelManager.VehicleModel?.RideSharingInfo&&this.p6l?.PassengerActor?.Owner||(this.S6l(),this.p6l?.PassengerActor))&&!(!(o=this.M6l(this.p6l.RoleId,e))||(i=o.PlotFlow&&3===o.PlotFlow.length,0===(t=this.E6l(i,o)).length?(Log_1.Log.CheckError()&&Log_1.Log.Error("Audio",42,"[Vehicle.Audio] 贡多拉与角色共乘语音播放失败，没有对应Event配置",["roleId",this.p6l.RoleId],["type",this.I6l(e)],["PlotFlow",o.PlotFlow],["Voice",o.Voice]),1):this.y6l(o.Priority)?this.CheckAudioProbabilityInfo(this.p6l.PassengerId,t,{DefaultCooldownTime:i?this.u6l:this.d6l,DefaultProbability:1})?(i?this.T6l(o):this.b6l(o),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[Vehicle.Audio] 贡多拉与角色共乘语音播放",["Event",t],["roleId",this.p6l.RoleId],["type",this.I6l(e)]),0):(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[Vehicle.Audio] 贡多拉与角色共乘语音播放CD中"),1):(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[Vehicle.Audio] 触发贡多拉共乘语音失败，当前正在播放的共乘语音优先级大于或等于触发语音",["roleId",this.p6l.RoleId],["type",this.I6l(e)]),1)))}M6l(e,o){var i=GongduolaPassengerVoiceConfigByRoleIdAndTriggerType_1.configGongduolaPassengerVoiceConfigByRoleIdAndTriggerType.GetConfigList(e,o);if(i&&0!==i.length)return i[0];Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[Vehicle.Audio] 贡多拉与角色共乘语音播放失败，没有对应配置",["roleId",e],["type",this.I6l(o)])}E6l(e,o){let i="";if(e)for(const t of o.PlotFlow)i+=t;else o.Voice&&0<o.Voice.length&&(i=o.Voice);return i}T6l(e){this.p6l.PlotHandle={Priority:e.Priority,Handle:0},this.p6l.PlotHandle.Handle=FlowController_1.FlowController.StartFlow(e.PlotFlow[0],parseInt(e.PlotFlow[1]),parseInt(e.PlotFlow[2]))}b6l(i){this.p6l.AudioHandle={Priority:i.Priority,Handle:0},this.p6l.AudioHandle.Handle=AudioSystem_1.AudioSystem.PostEvent(i.Voice,this.p6l.PassengerActor.Owner,{CallbackMask:1,CallbackHandler:(e,o)=>{Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Audio",42,"[Vehicle.Audio] 语音播放完成回调",["Event",i.Voice]),this.p6l&&(this.p6l.AudioHandle=void 0)}})}I6l(e){switch(e){case IAction_1.EGondolaVoiceTriggeredType.FindTreasure:return"找到海上宝箱";case IAction_1.EGondolaVoiceTriggeredType.InviteRole:return"邀请角色上船";case IAction_1.EGondolaVoiceTriggeredType.KeepMoving:return"保持移动N秒";case IAction_1.EGondolaVoiceTriggeredType.OpenCompass:return"打开指南针";case IAction_1.EGondolaVoiceTriggeredType.StayIdle:return"保持静止N秒";case IAction_1.EGondolaVoiceTriggeredType.StopMoving:return"移动N秒后停止移动";default:return"到特定区域/未知"}}}exports.GameAudioModel=GameAudioModel;
//# sourceMappingURL=GameAudioModel.js.map