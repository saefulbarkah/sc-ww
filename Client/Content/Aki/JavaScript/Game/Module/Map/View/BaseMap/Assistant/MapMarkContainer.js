
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MapMarkContainer=void 0;const Log_1=require("../../../../../../Core/Common/Log"),Vector_1=require("../../../../../../Core/Utils/Math/Vector"),EventDefine_1=require("../../../../../Common/Event/EventDefine"),EventSystem_1=require("../../../../../Common/Event/EventSystem"),ModelManager_1=require("../../../../../Manager/ModelManager"),GeneralLogicTreeUtil_1=require("../../../../GeneralLogicTree/GeneralLogicTreeUtil"),TrackController_1=require("../../../../Track/TrackController"),MapDefine_1=require("../../../MapDefine"),MapUtil_1=require("../../../MapUtil"),MapLogger_1=require("../../../Misc/MapLogger"),MapMarkPreemptiveFrameQueue_1=require("./MapFrameTaskQueue/MapMarkPreemptiveFrameQueue");class MapMarkContainer{constructor(){this.vlh=new MapMarkPreemptiveFrameQueue_1.MapMarkPreemptiveFrameQueue(50),this.rUi=new Map,this.Mlh=new Map,this.nUi=new Map,this.hUi=new Map,this.sUi=new Set,this.aUi=new Set,this.TDl=new Set,this.Jh1=new Set([11,22,17])}Tick(){this.vlh.TryExecuteNextTask()}ClearMarkItems(e){if(e){var t=this.rUi.get(e);if(t){for(var[,r]of t)this.hUi.delete(r.MarkId),r.Destroy(),this.LUi(r);t.clear()}t=this.Mlh.get(e);if(t){for(var[,i]of t)i.Destroy();t.clear()}this.vlh.CancelMapTaskByType(e)}else this.nIl(this.rUi),this.nIl(this.Mlh),this.sUi.clear(),this.rUi.clear(),this.Mlh.clear(),this.nUi.clear(),this.vlh.Dispose()}AddMarkItem(t,r){if(r)if(r.IsTracked&&12!==r.MarkType&&(ModelManager_1.ModelManager.MapModel.SetCurTrackMark([r.MarkType,r.MarkId]),this.sUi.add(r)),r.IsDiffMap())this.Slh(t,r);else{let e=this.GetMarkItemsByType(t,!1);e||(e=new Map,this.rUi.set(t,e)),e.has(r.MarkId)?MapLogger_1.MapLogger.ErrorOnce(r.MarkId,63,"重复添加标记_MarkMgr",["MarkId",r.MarkId]):(e.set(r.MarkId,r),this.TUi(r),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.AddMapMark,r))}}Slh(t,r){if(r){let e=this.GetDifferMapMarkItemsByType(t);e||(e=new Map,this.Mlh.set(t,e)),e.set(r.MarkId,r)}}RemoveMarkItem(e,t){this.vlh.CancelMapTask(e,t);e=this.GetMarkItemsByType(e);if(e&&0!==e.size){var r=e.get(t);if(e.delete(t),this.hUi.delete(t),r)return this.LUi(r),Log_1.Log.CheckInfo()&&Log_1.Log.Info("Map",63,"移除标记_MarkMgr",["MarkId",t]),r}}nIl(e){for(var[,t]of e)for(var[,r]of t)this.hUi.delete(r.MarkId),r.Destroy()}TUi(e){var t,r=e.WorldPosition;r&&(r=this.ConvertWorldPositionToIndex(r),(t=this.nUi.get(r))?this.Zh1(t,e):(t=(new Set).add(e),this.nUi.set(r,t)),e.GridId=r)}Zh1(e,t){e.has(t)?MapLogger_1.MapLogger.ErrorOnce(t.MarkId,63,"重复添加标记到格子集合中_MarkMarkContainer",["MarkId",t.MarkId]):e.add(t)}LUi(e){var t=e.GridId,t=this.nUi.get(t);t&&t.delete(e)}ExistMarkItem(e,t){return void 0!==this.GetMarkItemPurely(e,t)}ExistMarkItemTask(e,t){return this.vlh.HasTask(e,t)}GetMarkItem(e,t){return this.vlh.ForceExecuteTask(e,t),this.GetMarkItemPurely(e,t)}GetMarkItemPurely(e,t){if(0===e){const i=this.GetMarkItemById(t);return i}var r=this.GetMarkItemsByType(e);if(r){const i=r.get(t);return i||this.GetDifferMapMarkItem(e,t)}}GetMarkItemById(i,e=!1){var t=e=>{let t=void 0;for(var[,r]of e)if(t=r.get(i))break;return t};let r=t(this.GetAllMarkItems());return void 0===r&&e&&(e=this.GetAllDiffMapMarkItems(),r=t(e)),r}GetDifferMapMarkItem(e,t){e=this.GetDifferMapMarkItemsByType(e);if(e)return e.get(t)||void 0}GetMarkItemsByType(e,t=!0){var r=this.rUi.get(e);return(!r||r.size<=0)&&t?this.GetDifferMapMarkItemsByType(e):r}GetDifferMapMarkItemsByType(e){return this.Mlh.get(e)}GetAllMarkItems(){return this.rUi}GetAllDiffMapMarkItems(){return this.Mlh}ConvertWorldPositionToIndex(e){var t=Math.floor(Math.round(e.X*MapDefine_1.MARK_WORLD_TO_HASH_SCALE)/MapDefine_1.MARK_SCOPE),e=Math.floor(Math.round(e.Y*MapDefine_1.MARK_WORLD_TO_HASH_SCALE)/MapDefine_1.MARK_SCOPE);return t*MapDefine_1.MARK_HASH_XY_PANDING+e}GetAroundIndex(e){return new Set([e,e+MapDefine_1.MARK_HASH_XY_PANDING,e-MapDefine_1.MARK_HASH_XY_PANDING,e+1,e-1,e+MapDefine_1.MARK_HASH_XY_PANDING-1,e+MapDefine_1.MARK_HASH_XY_PANDING+1,e-MapDefine_1.MARK_HASH_XY_PANDING-1,e-MapDefine_1.MARK_HASH_XY_PANDING+1])}GetMarkItemsByClickPosition(e){var e=MapUtil_1.MapUtil.UiPosition2WorldPosition(e),e=this.ConvertWorldPositionToIndex(e),t=[];for(const i of this.GetAroundIndex(e)){var r=this.nUi.get(i);r&&t.push(...r)}return t}UpdateNearbyMarkItem(e,t,r){this.vlh.Flush();var i,e=this.ConvertWorldPositionToIndex(e),a=this.GetAroundIndex(e);for(const M of a){var s=this.nUi.get(M);if(s)for(const f of s)this.hUi.has(f.MarkId)||11===f.MarkType||this.hUi.set(f.MarkId,f)}this.LDl();for([,i]of this.hUi){t(i);var o=i.GridId;this.TDl.has(i.MarkId)||i.IsCanShowView&&a.has(o)||(this.aUi.add(i),this.hUi.delete(i.MarkId))}for(const k of this.sUi)t(k);if(0!==this.aUi.size){for(const p of this.aUi){var n=p.GridId;a.has(n)||p.IsDestroy||(p.LogicUpdate(GeneralLogicTreeUtil_1.GeneralLogicTreeUtil.GetPlayerLocation()),r(p))}this.aUi.clear()}for(const v of a){var h=this.nUi.get(v);if(h)for(const _ of h)t(_)}}LDl(){this.TDl.clear();for(const r of this.Jh1){var e=this.GetMarkItemsByType(r);if(e)for(var[,t]of e)this.hUi.set(t.MarkId,t),this.TDl.add(t.MarkId)}}FindNearbyMarkItems(r,e,i){this.vlh.Flush();var t=this.ConvertWorldPositionToIndex(r),a=Math.ceil(1/(MapDefine_1.MARK_SCOPE*MapDefine_1.MARK_WORLD_TO_HASH_SCALE))+1,s=this.GetAroundIndex(t);let o=Array.from(s.values());var n=new Set;n.add(t);for(let e=0;e<=a;++e){var h=[];for(const p of o)if(!n.has(p)){for(const v of this.GetAroundIndex(p))n.has(v)||h.push(v);n.add(p)}o=h}const M=[],f=e*e;for(const _ of n){var k=this.nUi.get(_);k&&k.forEach(e=>{var t;(i?.(e)??!0)&&(t=Vector_1.Vector.DistSquared(e.WorldPosition,r))<=f&&M.push([e,t])})}return 0<M.length&&M.sort((e,t)=>e[1]-t[1]),M}RemoveDynamicMark(e,t){var r=this.GetMarkItem(e,t);r&&(this.TrackMapMark(e,r.MarkId,!1),this.hUi.has(t)&&this.hUi.delete(t),void 0!==(r=this.RemoveMarkItem(e,t)))&&r.Destroy()}TrackMapMark(t,r,i,a=!1){var s=ModelManager_1.ModelManager.TrackModel.GetTrackData(1,r),o=this.GetMarkItem(t,r);if(o||s){let e=0;s&&(e=s.TrackSource,s.IconPath=o?.IconPath??s.IconPath),o&&(e=o.TrackSource);s=ModelManager_1.ModelManager.TrackModel.IsTracking(e,r);if(a||s!==i)if(i){if(o){let e=void 0;1===o.MarkItemType&&(e=o?.MarkConfig),TrackController_1.TrackController.StartTrack({TrackSource:o.TrackSource,Id:r,MarkType:t,MarkConfig:e,IconPath:o.IconPath,TrackTarget:o.TrackTarget,TrackInstanceId:o.MapId}),this.sUi.add(o)}}else TrackController_1.TrackController.EndTrack(e,r),o&&(this.aUi.add(o),this.sUi.delete(o))}}TrackMark(e){e=this.GetMarkItem(e.MarkType??0,e.Id);e&&!e.IsTracked&&e.LogicUpdate(GeneralLogicTreeUtil_1.GeneralLogicTreeUtil.GetPlayerLocation()),((e&&e.View)??e?.IsTracked)&&this.sUi.add(e)}UnTrackMark(e){e=this.GetMarkItem(e.MarkType??0,e.Id);e&&e.View&&(this.sUi.delete(e),this.aUi.add(e))}ClearTrackMark(){for(const e of this.sUi)e&&e.View&&this.aUi.add(e);this.sUi.clear()}GetTrackMenuMarkList(){const t=[];return this.GetMarkItemsByType(11,!1)?.forEach(e=>{t.push(e)}),this.GetMarkItemsByType(12,!1)?.forEach(e=>{e.IsTracked&&t.push(e)}),this.sUi.forEach(e=>{e.IsTracked&&!e.IsDiffMap()&&t.push(e)}),t}GetNavigateMarkList(){const t=[];this.GetMarkItemsByType(11,!1)?.forEach(e=>{t.push(e)}),this.GetDifferMapMarkItemsByType(11)?.forEach(e=>{MapUtil_1.MapUtil.IsInBigWorld(e.MapId)&&t.push(e)});var e=ModelManager_1.ModelManager.QuestNewModel.GetCurTrackedQuest(),r=e?.GetFirstNoHideActiveChildQuestNode()?.NodeId??0,e=e?.GetDefaultMark(r)??0,r=this.GetMarkItem(12,e);return r&&r.IsBtTypeQuest()&&t.push(r),t}RemoveNeedUpdateMark(e){this.hUi.has(e)&&this.hUi.delete(e)}AddCreateMarkTask(e,t,r,i){this.vlh.AddTask({Priority:e?0:1,MarkType:t,MarkId:r,Execute:i})}}exports.MapMarkContainer=MapMarkContainer;
//# sourceMappingURL=MapMarkContainer.js.map