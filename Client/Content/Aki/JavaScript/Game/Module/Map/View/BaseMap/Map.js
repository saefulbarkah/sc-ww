
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BaseMap=void 0;const UE=require("ue"),CustomPromise_1=require("../../../../../Core/Common/CustomPromise"),Vector2D_1=require("../../../../../Core/Utils/Math/Vector2D"),EventDefine_1=require("../../../../Common/Event/EventDefine"),EventSystem_1=require("../../../../Common/Event/EventSystem"),ConfigManager_1=require("../../../../Manager/ConfigManager"),ModelManager_1=require("../../../../Manager/ModelManager"),UiPanelBase_1=require("../../../../Ui/Base/UiPanelBase"),LevelSequencePlayer_1=require("../../../Common/LevelSequencePlayer"),GeneralLogicTreeUtil_1=require("../../../GeneralLogicTree/GeneralLogicTreeUtil"),MarkRangeImageComponent_1=require("../../Marks/MarkItemView/Components/MarkRangeImageComponent"),MapMarkMgr_1=require("./Assistant/MapMarkMgr"),MapTileMgr_1=require("./Assistant/MapTileMgr");class BaseMap extends UiPanelBase_1.UiPanelBase{constructor(e,t,i,s,a=1,r=100,n){super(),this.SelfPlayerNode=void 0,this.PlayerArrow=void 0,this.PlayerOutOfBoundIndicator=void 0,this.MapType=2,this.dAi=1,this.lUi=1,this.CAi=void 0,this.gAi=void 0,this.fAi=void 0,this.kut=void 0,this.pAi=100,this.vAi=void 0,this.C1a=!1,this._Ui=void 0,this.jnn=void 0,this.TRi=void 0,this.MAi=()=>{this.gAi.OnMapSetUp(),this.CAi.OnMapSetup(),this.RootItem.SetUIActive(!0)},this.z5l=void 0,this.J5l=void 0,this.Z5l=0,this.e8l=0,this._Ui=e,this.MapType=t,this.dAi=i,this.kut=s,this.lUi=a,this.pAi=r,this.fAi=n}get MapRootItem(){return this.RootItem}Tick(){this.CAi?.Tick()}OnBeforeDestroy(){this.UnBindEvents(),this.CAi.Dispose(),this.CAi=void 0,this.gAi.Dispose(),this.gAi=void 0,this.jnn?.Destroy(),this.jnn=void 0}OnRegisterComponent(){this.ComponentRegisterInfos=[[0,UE.UIItem],[1,UE.UIItem],[2,UE.UIItem],[3,UE.UIItem],[4,UE.UIItem],[5,UE.UITexture],[6,UE.UIItem],[7,UE.UIItem],[8,UE.UITexture],[9,UE.UITexture],[10,UE.UIItem]]}OnStart(){this.SetMapScale(this.dAi),this.F$t(this.lUi),this.yWe(),this.RootItem.SetUIActive(!1),2===this.MapType&&this.MAi(),this.SelfPlayerNode=this.GetItem(0),this.PlayerOutOfBoundIndicator=this.GetItem(2),this.PlayerArrow=this.GetItem(1),this.RootItem.SetHierarchyIndex(0);var e=this.GetItem(6);e.SetWidth(2*this.pAi),e.SetHeight(2*this.pAi),e.SetUIActive(!1),this.vAi=new LevelSequencePlayer_1.LevelSequencePlayer(e),this.Xa1()}F$t(e){var t=this.GetItem(3),i=this.GetItem(4);let s=this.GetTexture(5);2===BaseMap.MapMaterialVersion&&(s=this.GetTexture(9));var a=this.GetItem(7),r=this.GetTexture(8),t=(this.CAi=new MapMarkMgr_1.MapMarkMgr(this.MapType,this._Ui,t,this.kut,e),this.CAi.Initialize(),this.GetItem(10)),e={MapRootItem:this.RootItem,TileContainer:i,TileTexture:s,SubMapContainer:a,SubMapTexture:r,MapType:this.MapType,MapId:this._Ui,MapVersion:BaseMap.MapMaterialVersion,PreloadTiles:this.fAi,FogUnlockItem:t};this.gAi=new MapTileMgr_1.MapTileMgr(e),this.gAi.Initialize()}get MarkContainer(){return this.GetItem(3)}get FogUnlockAnchorItem(){return this.GetItem(10)}yWe(){2!==this.MapType&&(ModelManager_1.ModelManager.GameModeModel.WorldDone?this.MAi():EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.WorldDone,this.MAi))}UnBindEvents(){2!==this.MapType&&EventSystem_1.EventSystem.Has(EventDefine_1.EEventName.WorldDone,this.MAi)&&EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.WorldDone,this.MAi)}GetAllMarkItems(){return this.CAi.GetAllMarkItems()}GetMarkItemsByType(e,t=!0){return this.CAi.GetMarkItemsByType(e,t)}GetMarkItemsByClickPosition(e){return this.CAi.GetMarkItemsByClickPosition(e)}GetMarkItem(e,t){return this.CAi.GetMarkItem(e,t)}CreateCustomMark(e){return this.CAi.CreateDynamicMark(e)}FindNearbyMarkItems(e,t,i){return this.CAi.FindNearbyMarkItems(e,t,i)}GetTrackMenuMarkList(){return this.CAi.GetTrackMenuMarkList()}GetNavigateMarkList(){return this.CAi.GetNavigateMarkList()}get MapOffset(){return this.gAi.MapOffset}get FakeOffset(){return this.gAi.FakeOffset}ShowSubMapTile(e,t,i){this.gAi.ShowSubMapByPosition(e,t,i)}HideSubMapTile(){this.gAi.HideSubMap()}GetWorldMapCenterAreaId(){return this.gAi.GetWorldMapCenterAreaId()}GetSubMapGroupIdByPosition(){return this.gAi.GetSubMapGroupByRootItemPosition()}SetMapScale(e){this.RootItem.SetUIRelativeScale3D(new UE.Vector(e,e,e))}HandleFogAreaOpen(e){this.gAi.HandleFogAreaOpen(e)}HandleMapTileDelegate(){this.gAi.HandleDelegate()}UnBindMapTileDelegate(){this.gAi.UnBindDelegate()}HandleSceneGamePlayMarkItemOpen(e,t,i){e=this.GetMarkItemsByType(e);e&&e.forEach(e=>{e&&e.MarkConfig&&e.MarkConfig.RelativeSubType===i&&(e.IsCanShowView=!0,e.ViewUpdateAsync(GeneralLogicTreeUtil_1.GeneralLogicTreeUtil.GetPlayerLocation()).then(()=>{e.View?.PlayUnlockSequence()},void 0))})}SetClickRangeVisible(e,t=Vector2D_1.Vector2D.Create(0,0)){this._1a(e,t)}async _1a(e,t){var i;return this.C1a!==e&&(i=this.GetItem(6),this.C1a=e,this.C1a?(i.SetUIActive(this.C1a),i.D_SetWorldScale3D(new UE.VectorDouble(1,1,1)),i?.SetAnchorOffset(t.ToUeVector2D(!0)),await this.vAi?.PlaySequenceAsync("Start",new CustomPromise_1.CustomPromise)):(await this.vAi?.PlaySequenceAsync("Close",new CustomPromise_1.CustomPromise),i?.SetUIActive(this.C1a))),!0}InValidMapTile(e){return this.gAi.InValidTile(e)}SyncTransformToFrontContainer(){var e=this.GetRootItem(),t=e.GetAnchorOffset(),t=(this.z5l!==t&&(this.z5l=t,this.kut.SetAnchorOffset(t)),e.RelativeScale3D),t=(this.J5l!==t&&(this.J5l=t,this.kut.D_SetRelativeScale3D(new UE.VectorDouble(t))),e.Width),e=e.Height,i=this.Z5l!==t,s=this.e8l!==e;i&&(this.Z5l=t,this.kut.SetWidth(t)),s&&(this.e8l=e,this.kut.SetHeight(e))}async EOl(){this.jnn||(this.jnn=new MarkRangeImageComponent_1.MarkRangeImageComponent,this.TRi=this.jnn.CreateThenShowByResourceIdAsync("UiItem_MarkArea_Prefab",this.RootItem,!0)),await this.TRi}async SetRangeComponentShow(e,t,i){await this.EOl();var s=t&&i?0:ConfigManager_1.ConfigManager.CommonConfig.GetPlayPointTrackRange();this.jnn?.SetUiActive(!0),this.jnn?.GetRootItem().SetAnchorOffset(e.ToUeVector2D(!0)),this.jnn?.RangeArea.SetWidth(t??s),this.jnn?.RangeArea.SetHeight(i??s),ModelManager_1.ModelManager.WorldMapModel.MapRangeInfo={Position:e,Width:t,Height:i,MapId:this._Ui}}async SetRangeComponentHide(){await this.IOl(),this.jnn?.SetUiActive(!1),ModelManager_1.ModelManager.WorldMapModel.MapRangeInfo=void 0}async IOl(){await this.TRi}Xa1(){var e=ModelManager_1.ModelManager.WorldMapModel.MapRangeInfo;e&&e.MapId===this._Ui&&(this.Ya1()?this.SetRangeComponentHide():this.SetRangeComponentShow(e.Position,e.Width,e.Height))}Ya1(){var e,t=ModelManager_1.ModelManager.WorldMapModel.NavigateMarkShowRangeInfo;return!!t&&((e=this.GetMarkItem(t.MarkType,t.MarkId))?(e.MarkItemEntity.IsTempHide=e.MarkItemEntity.IsTempMapMark,e.GamePlayIsDiscover()??!1):!!(e=ConfigManager_1.ConfigManager.MapConfig.GetConfigMark(t.MarkId))&&(t=e.MapId,e=e.GamePlayId,ModelManager_1.ModelManager.LevelPlayReportModel.IsCommonLevelPlayDiscover(t,e)))}}(exports.BaseMap=BaseMap).MapMaterialVersion=2;
//# sourceMappingURL=Map.js.map