
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BattleQteContext=void 0;const Log_1=require("../../../../Core/Common/Log"),ControllerHolder_1=require("../../../Manager/ControllerHolder"),ModelManager_1=require("../../../Manager/ModelManager"),CommonQteContext_1=require("../CommonQte/CommonQteContext"),BattleQteCustomAction_1=require("./BattleQteCustomAction"),TARGET_QTE_SOURCER=0,TARGET_PLAYER_SELF=1;class BattleQteContext extends CommonQteContext_1.CommonQteContext{constructor(){super(...arguments),this.BattleQteId=0,this.BattleQteSource=void 0,this.MessageId=void 0,this.EntityHandle=void 0}OnQteSuccess(){1!==this.State&&(this.State=1,Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"战斗Qte触发成功",["HandleId",this.HandleId],["BattleQteId",this.BattleQteId]),this.kUe(!0),ControllerHolder_1.ControllerHolder.CommonQteController.StopQte(this.HandleId))}OnQteFail(){2!==this.State&&(this.State=2,Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"战斗Qte触发失败",["HandleId",this.HandleId],["BattleQteId",this.BattleQteId]),this.kUe(!1),ControllerHolder_1.ControllerHolder.CommonQteController.StopQte(this.HandleId))}kUe(t){var o=ModelManager_1.ModelManager.CommonQteModel?.GetBattleQteConfig(this.BattleQteId);if(o){var r=this.EntityHandle?.Entity,a=ModelManager_1.ModelManager.SceneTeamModel?.GetCurrentEntity?.Entity,i=t?o.SuccessActions:o.FailActions,s=i.Num();let e=void 0;for(let t=0;t<s;t++){var l=i.Get(t);(e=l.Target===TARGET_QTE_SOURCER?r:l.Target===TARGET_PLAYER_SELF?a:void 0)?this.jUe(e,l):Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"战斗Qte行为执行失败, 目标配置错误",["HandleId",this.HandleId],["BattleQteId",this.BattleQteId],["ActionIndex",t],["Target",l.Target])}}}jUe(r,t){if(this.MessageId){var a=r.GetComponent(203);let e=!0,o=void 0;if(a){var i=t.TagConditions,s=i.Num();for(let t=0;t<s;t++){var l=i.Get(t);if(!a.HasTag(l.TagId)){e=!1,o=l;break}}}if(a&&e){Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"战斗Qte行为开始执行",["HandleId",this.HandleId],["BattleQteId",this.BattleQteId],["MessageId",this.MessageId]);var n=t.AddTags,d=n.Num();for(let t=0;t<d;t++)a.AddTag(n.Get(t).TagId);var _=t.RemoveTags,Q=_.Num();for(let t=0;t<Q;t++)a.RemoveTag(_.Get(t).TagId);let e=void 0;var h=t.AddBuffs,m=h.Num();if(0<m&&(e=e??r.GetComponent(172)))for(let t=0;t<m;t++){var C=Number(h.Get(t));e.AddBuff(C,{InstigatorId:e.CreatureDataId,Reason:"战斗Qte结束时添加buff",PreMessageId:this.MessageId})}var v=t.RemoveBuffs,g=v.Num();if(0<g&&(e=e??r.GetComponent(172)))for(let t=0;t<g;t++){var u=Number(v.Get(t));e.RemoveBuff(u,-1,"战斗Qte结束时移除buff",this.MessageId)}var I=t.AddBullets,c=I.Num();for(let t=0;t<c;t++){var f=Number(I.Get(t));ControllerHolder_1.ControllerHolder.BulletController.CreateBulletCustomTarget(r,f.toString(),void 0,{},this.MessageId)}var L,A=t.UseSkillId,H=(A&&(L=r.GetComponent(39))&&(-1!==t.ChangeMainSkillPriority&&(H=L?.CurrentSkill)&&3!==H.SkillInfo?.SkillGenre&&L.SetSkillPriority(H.SkillId,t.ChangeMainSkillPriority),L.BeginSkill(A,{Context:"BattleQteContext.HandleActionInternal"})),t.CustomAction);if(0<H)switch(H){case 1:(0,BattleQteCustomAction_1.battleQteChangeRole)();break;case 2:var M=Number(t.CustomActionParam);M&&(0,BattleQteCustomAction_1.battleQteChangeRole)(M)}}else Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"战斗Qte行为执行失败, tag条件不满足",["HandleId",this.HandleId],["BattleQteId",this.BattleQteId],["TagName",o?.TagName])}else Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"战斗Qte执行行为失败, 上下文Id不合法",["HandleId",this.HandleId],["BattleQteId",this.BattleQteId],["MessageId",this.MessageId])}}exports.BattleQteContext=BattleQteContext;
//# sourceMappingURL=BattleQteContext.js.map