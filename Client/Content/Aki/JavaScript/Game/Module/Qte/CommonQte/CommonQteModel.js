
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CommonQteModel=void 0;const UE=require("ue"),CustomPromise_1=require("../../../../Core/Common/CustomPromise"),Log_1=require("../../../../Core/Common/Log"),ModelBase_1=require("../../../../Core/Framework/ModelBase"),ResourceSystem_1=require("../../../../Core/Resource/ResourceSystem"),DataTableUtil_1=require("../../../../Core/Utils/DataTableUtil"),BattleQteContext_1=require("../BattleQte/BattleQteContext"),CommonQteContext_1=require("./CommonQteContext"),DT_COMMON_QTE_PATH="/Game/Aki/Data/Qte/DT_CommonQte.DT_CommonQte",DT_BATTLE_QTE_PATH="/Game/Aki/Data/Qte/DT_BattleQte.DT_BattleQte";class CommonQteModel extends ModelBase_1.ModelBase{constructor(){super(...arguments),this.hJ=-1,this.ZEl=0,this.Qnc=void 0,this.Knc=void 0,this.tIl=void 0,this.Jcc=void 0,this.IsRefreshMode=!1}OnLeaveLevel(){return this.tIl?.clear(),this.Jcc?.clear(),this.Qnc=void 0,!(this.Knc=void 0)}StartQte(t,e=void 0,o=void 0,i=0){var s,r=this.GetCommonQteConfig(t);if(r)return(s=new CommonQteContext_1.CommonQteContext).QteId=t,s.HandleId=this.ZEl++,s.SetConfig(r),s.SuccessCallback=e,s.FailCallback=o,s.Source=i,this.hJ=s.HandleId,this.tIl||(this.tIl=new Map),this.tIl.set(s.HandleId,s),s}StartBattleQte(t,e,o,i){var s=this.GetBattleQteConfig(t);if(s){var r,a=this.GetCommonQteConfig(s.QteId);if(a)return(r=new BattleQteContext_1.BattleQteContext).QteId=s.QteId,r.BattleQteId=t,r.HandleId=this.ZEl++,r.MessageId=e,r.EntityHandle=o,r.SetConfig(a),r.Source=0,r.BattleQteSource=i,this.hJ=r.HandleId,this.tIl||(this.tIl=new Map),this.tIl.set(r.HandleId,r),r}}GetCommonQteConfig(t){this.Qnc||(this.Qnc=ResourceSystem_1.ResourceSystem.GetLoadedAsset(DT_COMMON_QTE_PATH,UE.DataTable));var e=DataTableUtil_1.DataTableUtil.GetDataTableRow(this.Qnc,t.toString());return e||Log_1.Log.CheckError()&&Log_1.Log.Error("CommonQte",67,"找不到通用QTE配置",["QteId",t]),e}GetBattleQteConfig(t){this.Knc||(this.Knc=ResourceSystem_1.ResourceSystem.GetLoadedAsset(DT_BATTLE_QTE_PATH,UE.DataTable));var e=DataTableUtil_1.DataTableUtil.GetDataTableRow(this.Knc,t.toString());return e||Log_1.Log.CheckError()&&Log_1.Log.Error("CommonQte",67,"找不到战斗QTE配置",["BattleQteId",t]),e}GetQteHandle(){return this.hJ}ClearQteHandle(){this.hJ=-1}GetQteContext(t){return this.tIl?.get(t)}GetQteIcon(t){return this.Jcc?.get(t)}async LoadQteIcon(e,o){const i=new CustomPromise_1.CustomPromise;var t=ResourceSystem_1.ResourceSystem.GetLoadedAsset(o,UE.LGUITexturePackerSpriteData);return t?(void 0===this.Jcc&&(this.Jcc=new Map),this.Jcc.set(e,t),i.SetResult(!0)):ResourceSystem_1.ResourceSystem.LoadAsync(o,UE.LGUITexturePackerSpriteData,t=>{t?(void 0===this.Jcc&&(this.Jcc=new Map),this.Jcc.set(e,t),i.SetResult(!0)):(Log_1.Log.CheckError()&&Log_1.Log.Error("CommonQte",67,"QTE加载图标失败",["iconPath",o]),i.SetResult(!1))},100),i.Promise}GetQteIconPath(t){t=this.GetCommonQteConfig(t);if(t)return t.BaseConfig.SingleClickConfig.UIConfig.Icon.ToAssetPathName()}ClearPreloadCache(){this.Jcc?.clear()}}exports.CommonQteModel=CommonQteModel;
//# sourceMappingURL=CommonQteModel.js.map