
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CommonQteController=void 0;const AudioSystem_1=require("../../../../Core/Audio/AudioSystem"),Log_1=require("../../../../Core/Common/Log"),ControllerBase_1=require("../../../../Core/Framework/ControllerBase"),TimerSystem_1=require("../../../../Core/Timer/TimerSystem"),EventDefine_1=require("../../../Common/Event/EventDefine"),EventSystem_1=require("../../../Common/Event/EventSystem"),ModelManager_1=require("../../../Manager/ModelManager"),UiManager_1=require("../../../Ui/UiManager"),GameModeController_1=require("../../../World/Controller/GameModeController"),EXTRA_EXPIRED_TIME=5e3,MAX_EXPIRED_TIME=6e4;class CommonQteController extends ControllerBase_1.ControllerBase{static OnInit(){return!0}static OnLeaveLevel(){return this.IsInQte()&&this.SetQteTimeDilation(1),this.ClearQte(),!0}static StartQte(o,e=void 0,t=void 0,i=0){if(this.IsInQte())Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"当前存在执行中的Qte, 无法开始新的Qte",["HandleId",this.nx?.HandleId],["Id",o]);else{const s=ModelManager_1.ModelManager.CommonQteModel?.StartQte(o,e,t,i);if(s){this.zEl=!0,this.nx=s,Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"通用Qte开始",["HandleId",this.nx.HandleId],["Id",o]);const r=s.GetViewName();if(r)return UiManager_1.UiManager.IsViewOpen(r)?UiManager_1.UiManager.CloseView(r,e=>{e?UiManager_1.UiManager.OpenView(r,s.HandleId):(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"重新打开Qte界面失败, 停止当前Qte",["HandleId",s.HandleId],["Id",o],["ViewName",r]),this.JEl())}):UiManager_1.UiManager.OpenView(r,s.HandleId,(e,t)=>{e?(this.yd_(),e=s.IsPermanent?MAX_EXPIRED_TIME:s.Duration+EXTRA_EXPIRED_TIME,this.Sd_=TimerSystem_1.TimerSystem.Delay(()=>{Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"通用Qte超时, 触发保底",["HandleId",s.HandleId],["Id",o]),this.JEl()},e)):(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"打开Qte界面失败, 停止当前Qte",["HandleId",s.HandleId],["Id",o],["ViewName",r]),this.JEl())}),this.PlayQteAudio(s.Config.AudioConfig.AudioEventStart),this.AddExtraEffect(s.Config.ExtraConfig),this.SetQteTimeDilation(s.Config.BaseConfig.TimeDilation),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.CommonQteStart,this.nx.HandleId),s;Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"通用Qte开始失败, 无对应的Qte界面",["HandleId",this.nx.HandleId],["Id",o],["ViewName",r]),this.ClearQte()}else Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"通用Qte开始失败, 获取context为空",["Id",o])}}static StopQte(e){e===this.nx?.HandleId&&(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"停止QTE",["HandleId",this.nx?.HandleId],["Id",this.nx?.QteId]),this.JEl())}static StopCurrentQte(){Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"停止当前QTE",["HandleId",this.nx?.HandleId],["Id",this.nx?.QteId]),this.JEl()}static JEl(){Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"通用Qte结束",["HandleId",this.nx?.HandleId],["Id",this.nx?.QteId],["State",this.nx?.State]),this.nx?.IsSuccess()?this.PlayQteAudio(this.nx?.Config.AudioConfig.AudioEventSuccess):this.nx?.IsFail()&&this.PlayQteAudio(this.nx?.Config.AudioConfig.AudioEventFail),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.CommonQteEnd,this.nx?.HandleId),ModelManager_1.ModelManager.CommonQteModel?.ClearQteHandle(),this.ClearQte(),this.SetQteTimeDilation(1)}static IsInQte(){return this.zEl}static ClearQte(){this.RemoveExtraEffect(),this.yd_(),this.zEl=!1,this.nx?.Clear(),this.nx=void 0}static yd_(){this.Sd_&&TimerSystem_1.TimerSystem.Remove(this.Sd_),this.Sd_=void 0}static SetQteTimeDilation(e){ModelManager_1.ModelManager.GameModeModel?.IsMulti||GameModeController_1.GameModeController.SetTimeDilation(e)}static AddExtraEffect(t){if(t.HideAllBattleUi)this.SIl=!0,ModelManager_1.ModelManager.BattleUiModel.ChildViewData.HideBattleView(6,[20]);else{this.SIl=!1;var o=t.HideUIElement.Num();if(0<o){var i=[];for(let e=0;e<o;e++)i.push(t.HideUIElement.Get(e));ModelManager_1.ModelManager.BattleUiModel.ChildViewData.SetChildrenVisible(6,i,!1),this.yIl=i}else this.yIl=void 0}}static RemoveExtraEffect(){var e;this.SIl?(ModelManager_1.ModelManager.BattleUiModel.ChildViewData.ShowBattleView(6),this.SIl=!1):(e=this.yIl)&&(ModelManager_1.ModelManager.BattleUiModel.ChildViewData.SetChildrenVisible(6,e,!0),this.yIl=void 0)}static PlayQteAudio(e){e&&(e=(0,AudioSystem_1.parseAudioEventPath)(e.ToAssetPathName()))&&AudioSystem_1.AudioSystem.PostEvent(e)}}(exports.CommonQteController=CommonQteController).nx=void 0,CommonQteController.zEl=!1,CommonQteController.SIl=!1,CommonQteController.yIl=void 0,CommonQteController.Sd_=void 0;
//# sourceMappingURL=CommonQteController.js.map