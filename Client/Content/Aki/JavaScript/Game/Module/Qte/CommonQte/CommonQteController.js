
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CommonQteController=void 0;const AudioSystem_1=require("../../../../Core/Audio/AudioSystem"),Log_1=require("../../../../Core/Common/Log"),Time_1=require("../../../../Core/Common/Time"),ControllerBase_1=require("../../../../Core/Framework/ControllerBase"),TimerSystem_1=require("../../../../Core/Timer/TimerSystem"),EventDefine_1=require("../../../Common/Event/EventDefine"),EventSystem_1=require("../../../Common/Event/EventSystem"),ModelManager_1=require("../../../Manager/ModelManager"),UiManager_1=require("../../../Ui/UiManager"),GameModeController_1=require("../../../World/Controller/GameModeController"),EXTRA_EXPIRED_TIME=5e3,MAX_EXPIRED_TIME=6e4;class CommonQteController extends ControllerBase_1.ControllerBase{static OnInit(){return!0}static OnLeaveLevel(){return this.IsInQte()&&this.SetQteTimeDilation(1),this.ClearQte(),this.ClearPreloadQteRes(),!0}static StartQte(e,t=void 0,o=void 0,i=0){let r=void 0;if(this.IsInQte()?r="当前存在执行中的Qte, 无法开始新的Qte":this.Xcc&&(r="Qte预加载中, 无法开始新的Qte"),r)Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,r,["HandleId",this.nx?.HandleId],["QteId",e],["Source",i]);else{t=ModelManager_1.ModelManager.CommonQteModel?.StartQte(e,t,o,i);if(t)return Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"通用Qte开始",["HandleId",t.HandleId],["QteId",e],["Source",i]),this.Wnc(t)?t:void 0;Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"通用Qte开始失败, 获取context为空",["QteId",e])}}static StartBattleQte(e,t,o,i){let r=void 0;var a,s;if(this.IsInQte()?r="当前存在执行中的Qte, 无法开始新的Qte":this.Xcc?r="Qte预加载中, 无法开始新的Qte":ModelManager_1.ModelManager.GameModeModel?.IsMulti?r="联机状态下不能触发战斗Qte":0===Time_1.Time.FlowTimeDilation?r="副本时停中, 不能触发战斗Qte":(s=(n=(a=ModelManager_1.ModelManager.SceneTeamModel?.GetCurrentTeamItem)?.EntityHandle)?.Entity,n&&n.Valid&&s?a?.IsDead()?r="当前角色已死亡, 不能触发战斗Qte":s.GetComponent(120)?.HasPauseLock()&&(r="当前角色大招时停中, 不能触发战斗Qte"):r="当前角色实体无效, 不能触发战斗Qte"),r)Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,r,["HandleId",this.nx?.HandleId],["BattleQteId",e],["Source",i]);else{var n=ModelManager_1.ModelManager.CommonQteModel?.StartBattleQte(e,t,o,i);if(n)return Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"战斗Qte开始",["HandleId",n.HandleId],["BattleQteId",e],["Source",i]),this.Wnc(n)?n:void 0;Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"战斗Qte开始失败, 获取context为空",["BattleQteId",e])}}static Wnc(o){var e=o.QteId;return this.zEl=!0,this.nx=o,this.PreloadQteRes([e]).then(e=>{var t=this.Ycc;t?(t.SetQteContext(o),t.PlayQteStart(),this.zcc(o),this.Ycc=void 0):(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"打开Qte界面失败, 停止当前Qte",["HandleId",o.HandleId],["QteId",o.QteId],["ViewName","CommonQteView"]),this.JEl())}),this.PlayQteAudio(o.Config.AudioConfig.AudioEventStart),this.AddExtraEffect(o.Config.ExtraConfig),this.SetQteTimeDilation(o.Config.BaseConfig.TimeDilation),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.CommonQteStart,this.nx.HandleId),!0}static zcc(e){this.Md_();var t=e.IsPermanent?MAX_EXPIRED_TIME:e.Duration+EXTRA_EXPIRED_TIME;this.Ed_=TimerSystem_1.TimerSystem.Delay(()=>{Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"通用Qte超时, 触发保底",["HandleId",e.HandleId],["QteId",e.QteId]),this.JEl()},t)}static StopQte(e){e===this.nx?.HandleId&&(Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"停止QTE",["HandleId",this.nx?.HandleId],["QteId",this.nx?.QteId]),this.JEl())}static StopCurrentQte(){Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"停止当前QTE",["HandleId",this.nx?.HandleId],["QteId",this.nx?.QteId]),this.JEl()}static JEl(){Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"通用Qte结束",["HandleId",this.nx?.HandleId],["QteId",this.nx?.QteId],["State",this.nx?.State]),this.nx?.IsSuccess()?this.PlayQteAudio(this.nx?.Config.AudioConfig.AudioEventSuccess):this.nx?.IsFail()&&this.PlayQteAudio(this.nx?.Config.AudioConfig.AudioEventFail),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.CommonQteEnd,this.nx?.HandleId),ModelManager_1.ModelManager.CommonQteModel?.ClearQteHandle(),this.ClearQte(),this.SetQteTimeDilation(1)}static IsInQte(){return this.zEl}static ClearQte(){this.RemoveExtraEffect(),this.Md_(),this.zEl=!1,this.Xcc=!1,this.nx?.Clear(),this.nx=void 0,this.Ycc=void 0}static Md_(){this.Ed_&&TimerSystem_1.TimerSystem.Remove(this.Ed_),this.Ed_=void 0}static SetQteTimeDilation(e){ModelManager_1.ModelManager.GameModeModel?.IsMulti||GameModeController_1.GameModeController.SetTimeDilation(e)}static AddExtraEffect(t){if(t.HideAllBattleUi)this.SIl=!0,ModelManager_1.ModelManager.BattleUiModel.ChildViewData.HideBattleView(6,[20]);else{this.SIl=!1;var o=t.HideUIElement.Num();if(0<o){var i=[];for(let e=0;e<o;e++)i.push(t.HideUIElement.Get(e));ModelManager_1.ModelManager.BattleUiModel.ChildViewData.SetChildrenVisible(6,i,!1),this.yIl=i}else this.yIl=void 0}}static RemoveExtraEffect(){var e;this.SIl?(ModelManager_1.ModelManager.BattleUiModel.ChildViewData.ShowBattleView(6),this.SIl=!1):(e=this.yIl)&&(ModelManager_1.ModelManager.BattleUiModel.ChildViewData.SetChildrenVisible(6,e,!0),this.yIl=void 0)}static PlayQteAudio(e){e&&(e=(0,AudioSystem_1.parseAudioEventPath)(e.ToAssetPathName()))&&AudioSystem_1.AudioSystem.PostEvent(e)}static async PreloadQteRes(e){this.Xcc=!0,!this.Ycc&&(UiManager_1.UiManager.IsViewOpen("CommonQteView")&&await UiManager_1.UiManager.CloseViewAsync("CommonQteView"),t=await UiManager_1.UiManager.OpenViewAsync("CommonQteView"))&&(this.Ycc=UiManager_1.UiManager.GetView(t));var t,o,i=[];for(const r of e)ModelManager_1.ModelManager.CommonQteModel?.GetQteIcon(r)||(o=ModelManager_1.ModelManager.CommonQteModel?.GetQteIconPath(r))&&i.push(ModelManager_1.ModelManager.CommonQteModel.LoadQteIcon(r,o));return await Promise.all(i),!(this.Xcc=!1)}static ClearPreloadQteRes(){this.Ycc&&(UiManager_1.UiManager.CloseView("CommonQteView"),this.Ycc=void 0),ModelManager_1.ModelManager.CommonQteModel?.ClearPreloadCache()}}(exports.CommonQteController=CommonQteController).nx=void 0,CommonQteController.zEl=!1,CommonQteController.SIl=!1,CommonQteController.yIl=void 0,CommonQteController.Ed_=void 0,CommonQteController.Xcc=!1,CommonQteController.Ycc=void 0;
//# sourceMappingURL=CommonQteController.js.map