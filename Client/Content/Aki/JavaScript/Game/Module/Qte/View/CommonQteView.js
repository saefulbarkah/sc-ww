
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CommonQteView=void 0;const UE=require("ue"),Info_1=require("../../../../Core/Common/Info"),Log_1=require("../../../../Core/Common/Log"),EventDefine_1=require("../../../Common/Event/EventDefine"),EventSystem_1=require("../../../Common/Event/EventSystem"),TimeUtil_1=require("../../../Common/TimeUtil"),ControllerHolder_1=require("../../../Manager/ControllerHolder"),ModelManager_1=require("../../../Manager/ModelManager"),InputDistributeController_1=require("../../../Ui/InputDistribute/InputDistributeController"),InputMappingsDefine_1=require("../../../Ui/InputDistribute/InputMappingsDefine"),UiManager_1=require("../../../Ui/UiManager"),CombineKeyItem_1=require("../../BattleUi/Views/KeyItem/CombineKeyItem"),LevelSequencePlayer_1=require("../../Common/LevelSequencePlayer"),CommonQteViewBase_1=require("./CommonQteViewBase");class CommonQteView extends CommonQteViewBase_1.CommonQteViewBase{constructor(){super(...arguments),this.Qtt=void 0,this.Zcc=void 0,this.OOi=void 0,this.d5l=void 0,this.DOt=void 0,this.NUi=void 0,this.SPe=void 0,this.gmc=void 0,this.NTe=0,this.NQa=!1,this.FQa="",this.iIl=-1,this.rIl=void 0,this.TYa=!1,this.fhc=!0,this.e1c=!1,this.Cmc=!1,this.$xt=t=>{"Start"===t?this.IsQteEnd||(this.SPe?.PlayLevelSequenceByName("Loop"),!this.IsPause&&0<this.NTe?this.FOi("Loop",1/this.NTe):this.FOi("Loop",0),this.IsMobile||this.Zcc?.SetUIActive(!0),this.IsQteStart=!0,this.TYa=!0):"Success"!==t&&"Fail"!==t||UiManager_1.UiManager.CloseView("CommonQteView")},this.BOi=(t,i)=>{this.del()?0===i&&this.bOi():Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"通用Qte输入无效")},this.jj_=(t,i)=>{Info_1.Info.IsInGamepad()&&ModelManager_1.ModelManager.SkillButtonUiModel?.GamepadData?.SwitchInteractData.IsSwitchInteractOpen&&2===ModelManager_1.ModelManager.SkillButtonUiModel?.GamepadData?.SwitchInteractData.State&&this.FQa===InputMappingsDefine_1.actionMappings.幻象1&&(this.del()?0===i&&this.bOi():Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"通用Qte输入无效"))}}OnRegisterComponent(){super.OnRegisterComponent(),this.IsMobile?this.ComponentRegisterInfos=[[0,UE.UIItem],[1,UE.UIButtonComponent],[2,UE.UISprite],[3,UE.UIItem]]:this.ComponentRegisterInfos=[[0,UE.UIItem],[1,UE.UIItem],[2,UE.UIItem],[3,UE.UISprite],[4,UE.UIButtonComponent],[5,UE.UIItem]]}async OnBeforeStartAsync(){var t;!this.IsMobile&&(this.Qtt=new CombineKeyItem_1.CombineKeyItem,t=this.GetItem(2))&&await this.Qtt?.CreateByActorAsync(t.GetOwner())}OnStart(){super.OnStart(),this.IsMobile?(this.OOi=this.GetItem(0),this.d5l=this.GetButton(1),this.DOt=this.GetSprite(2),this.NUi=this.GetItem(3)):(this.OOi=this.GetItem(0),this.d5l=this.GetButton(4),this.DOt=this.GetSprite(3),this.Zcc=this.GetItem(1),this.Zcc?.SetUIActive(!1),this.NUi=this.GetItem(5)),this.d5l?.OnPointDownCallBack.Bind(()=>{this.qOi()}),this.SPe=new LevelSequencePlayer_1.LevelSequencePlayer(this.OOi),this.SPe.BindSequenceCloseEvent(this.$xt),this.gmc=new LevelSequencePlayer_1.LevelSequencePlayer(this.NUi),this.OOi?.SetUIActive(!1)}OnBeforeDestroy(){super.OnBeforeDestroy(),!this.IsQteEnd&&this.rIl?.IsActive()&&ControllerHolder_1.ControllerHolder.CommonQteController.StopQte(this.rIl.HandleId),this.t1c(),this.jQa(),this.d5l?.OnPointDownCallBack.Unbind(),this.SPe?.Clear(),this.gmc?.Clear(),this.rIl=void 0,this.iIl=-1,this.FQa=""}SetQteContext(t){this.iIl=t.HandleId;var i=(this.rIl=t).GetAction(),i=(i&&(this.FQa=i,this.Qtt?.RefreshAction(i),this.Qtt?.Show()),this.NTe=Math.max(0,t.Duration*TimeUtil_1.TimeUtil.Millisecond),this.TYa=!1,this.fhc=!0,this.Cmc=!1,t.GetUiConfig()),i=(i&&(this.fhc=0===i.InteractiveTiming,this.Cmc=i.IsShowBorder),this.fhc&&(this.TYa=!0),ModelManager_1.ModelManager.CommonQteModel?.GetQteIcon(t.QteId));i?(this.DOt?.SetSprite(i,!1),this.DOt?.SetUIActive(!0)):Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"获取Qte图标失败",["QteId",t.QteId]),this.i1c(),3===t.Source&&(i=UiManager_1.UiManager.GetViewByName("VideoView"))&&(t=i.GetRootItem())&&this.GetRootItem().SetUIParent(t)}PlayQteStart(){this.IsQteEnd||(this.OOi?.SetUIActive(!0),this.SPe?.PlayLevelSequenceByName("Start"),this.Cmc&&(this.NUi?.SetUIActive(!0),this.gmc?.PlayLevelSequenceByName("Start")),this.r1c(),this.HQa())}CommonQteEnd(t){this.iIl!==t||this.IsQteEnd||(this.IsQteEnd=!0,this.HandleQteEnd())}RefreshOnBattleUiVisibleChanged(){var t;2!==this.rIl?.Source&&3!==this.rIl?.Source&&(t=ModelManager_1.ModelManager.BattleUiModel.ChildViewData.GetChildVisible(20),this.SetActive(t))}HQa(){this.NQa||(this.NQa=!0,this.IsMobile)||(InputDistributeController_1.InputDistributeController.BindActionIgnoreLimit(this.FQa,this.BOi),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"通用QTE绑定Action",["Action",this.FQa]),this.FQa===InputMappingsDefine_1.actionMappings.幻象1&&InputDistributeController_1.InputDistributeController.BindActionIgnoreLimit(InputMappingsDefine_1.actionMappings.通用交互,this.jj_))}jQa(){this.NQa&&(this.NQa=!1,this.IsMobile||(InputDistributeController_1.InputDistributeController.UnBindActionIgnoreLimit(this.FQa,this.BOi),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"通用QTE解绑Action",["Action",this.FQa]),this.FQa===InputMappingsDefine_1.actionMappings.幻象1&&InputDistributeController_1.InputDistributeController.UnBindActionIgnoreLimit(InputMappingsDefine_1.actionMappings.通用交互,this.jj_)))}r1c(){this.e1c||(this.e1c=!0,ModelManager_1.ModelManager.InputDistributeModel?.AddNotAllowFightInputViewName("CommonQteView"),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnAddNotAllowFightInputViewName))}t1c(){this.e1c&&(this.e1c=!1,ModelManager_1.ModelManager.InputDistributeModel?.RemoveNotAllowFightInputViewName("CommonQteView"),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnRemoveNotAllowFightInputViewName))}del(){return!!this.TYa}qOi(){this.del()?this.bOi():Log_1.Log.CheckDebug()&&Log_1.Log.Debug("CommonQte",67,"通用Qte输入无效")}bOi(){this.rIl&&this.rIl.IsActive()&&this.rIl.IsPending()&&this.rIl.Response()}HandleQteEnd(){this.IsMobile||this.Zcc?.SetUIActive(!1),this.SPe?.StopCurrentSequence(),this.rIl?.IsSuccess()?this.SPe?.PlayLevelSequenceByName("Success"):this.SPe?.PlayLevelSequenceByName("Fail"),this.Cmc&&(this.gmc?.StopCurrentSequence(),this.gmc?.PlayLevelSequenceByName("Close")),this.t1c(),this.jQa()}FOi(t,i){this.OOi.GetOwner().GetSequencePlayerByKey(t)?.SequencePlayer?.SetPlayRate(i)}OnQtePause(){this.FOi("Loop",0)}OnQteResume(){0<this.NTe?this.FOi("Loop",1/this.NTe):this.FOi("Loop",0)}OnTick(t){!this.IsQteStart||this.IsQteEnd||this.IsPause||this.rIl&&(this.rIl.UpdateTime(t),ModelManager_1.ModelManager.CommonQteModel?.IsRefreshMode)&&this.i1c()}i1c(){var t;this.rIl&&(t=this.rIl.GetUiConfig()?.UIConfig)&&(this.OOi.SetAnchorAlign(t.AnchorHAlign,t.AnchorVAlign),this.OOi.SetAnchorOffset(t.AnchorOffset))}}exports.CommonQteView=CommonQteView;
//# sourceMappingURL=CommonQteView.js.map