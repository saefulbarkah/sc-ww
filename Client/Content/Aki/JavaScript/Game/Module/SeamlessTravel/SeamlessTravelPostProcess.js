
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SeamlessTravelPostProcess=void 0;const UE=require("ue"),ActorSystem_1=require("../../../Core/Actor/ActorSystem"),Log_1=require("../../../Core/Common/Log"),ResourceSystem_1=require("../../../Core/Resource/ResourceSystem"),MathUtils_1=require("../../../Core/Utils/MathUtils"),Global_1=require("../../Global"),GlobalData_1=require("../../GlobalData"),DEFAULT_TRANSITION_POSTPROCESS_PRIORITY=9999;class SeamlessTravelPostProcess{constructor(){this.Hte=void 0,this.nx=void 0,this.kyc=void 0,this.Oyc=void 0,this.qyc=!1,this.CurrentBlendStatus=0,this.Gyc=0,this.Fyc=0,this.Nyc=void 0,this.Vyc=void 0}get IsInit(){return this.qyc}get IsActive(){return 0!==this.CurrentBlendStatus}Init(t,s){this.Hte=Global_1.Global.BaseCharacter?.CharacterActorComponent,this.Hte?(this.CurrentBlendStatus=0,this.nx=t,this.IsInit?s(!0):(this.Gyc=this.nx.EffectExpandTime*MathUtils_1.MathUtils.SecondToMillisecond,this.Fyc=this.nx.EffectCollapseTime*MathUtils_1.MathUtils.SecondToMillisecond,this.Oyc=this.nx.TransitionWeatherDaPath,this.jyc(t=>{this.qyc=!0,s(t)}))):Log_1.Log.CheckError()&&Log_1.Log.Error("Teleport",39,"[无缝传送PPV]初始化失败，无效的ActorComp",["ActorName",Global_1.Global.BaseCharacter?.GetName()])}jyc(i){this.kyc=ActorSystem_1.ActorSystem.Get(UE.KuroPostProcessVolume.StaticClass(),this.Hte?.ActorTransform??MathUtils_1.MathUtils.DefaultTransformDouble),this.kyc.IsValid()?(GlobalData_1.GlobalData.IsPlayInEditor&&this.kyc.SetActorLabel("SeamlessTravelPostProcessVolume"),this.kyc.BlendWeight=0,this.kyc.bUnbound=!0,this.kyc.bEnabled=!1,this.kyc.Priority=DEFAULT_TRANSITION_POSTPROCESS_PRIORITY,UE.KuroRenderingRuntimeBPPluginBPLibrary.MarkWorldPostProcessPriorityDirty(this.kyc),this.Oyc?.length?ResourceSystem_1.ResourceSystem.LoadAsync(this.Oyc,UE.KuroWeatherDataAsset,(t,s)=>{t?(this.kyc?.SetWeatherDataAsset(t),i(!0)):(Log_1.Log.CheckError()&&Log_1.Log.Error("Teleport",39,"[无缝传送PPV] 加载DA失败",["path",s],["ActorName",Global_1.Global.BaseCharacter?.GetName()]),i(!1))}):i(!0)):(Log_1.Log.CheckError()&&Log_1.Log.Error("Teleport",39,"[无缝传送PPV] 创建PPV失败",["ActorName",Global_1.Global.BaseCharacter?.GetName()]),i(!1))}Tick(t){if(this.IsInit&&this.kyc?.IsValid()&&this.IsActive&&this.Hte){var s,i=this.kyc.BlendWeight;switch(this.CurrentBlendStatus){case 2:this.kyc.BlendWeight=MathUtils_1.MathUtils.Clamp(i+t/this.Gyc,0,1),this.kyc.D_K2_SetActorLocation(this.Hte.ActorLocation,!1,void 0,!0),this.kyc.bEnabled=0<this.kyc.BlendWeight,this.kyc.PostModify(),1!==i&&1===this.kyc.BlendWeight&&(s=this.Nyc,this.Nyc=void 0,this.CurrentBlendStatus=1,s?.(!0));break;case 3:this.kyc.BlendWeight=MathUtils_1.MathUtils.Clamp(i-t/this.Fyc,0,1),this.kyc.D_K2_SetActorLocation(this.Hte.ActorLocation,!1,void 0,!0),this.kyc.bEnabled=0<this.kyc.BlendWeight,this.kyc.PostModify(),0!==i&&0===this.kyc.BlendWeight&&(s=this.Vyc,this.Vyc=void 0,this.CurrentBlendStatus=0,s?.(!0))}}}Destroy(){this.kyc?.IsValid()&&(this.kyc.BlendWeight=0,this.kyc.bUnbound=!1,this.kyc.bEnabled=!1,this.kyc.Priority=0,ActorSystem_1.ActorSystem.Put("SeamlessTravelPostProcess.Destroy",this.kyc)),this.kyc=void 0,this.Hte=void 0,this.nx=void 0,this.CurrentBlendStatus=0,this.Nyc=void 0,this.Vyc=void 0}AppearEffect(t){this.IsInit&&this.kyc?.IsValid()?(this.Nyc=t,this.CurrentBlendStatus=2):t(!1)}DisappearEffect(t){this.IsInit&&this.kyc?.IsValid()?(this.Vyc=t,this.CurrentBlendStatus=3):t(!1)}}exports.SeamlessTravelPostProcess=SeamlessTravelPostProcess;
//# sourceMappingURL=SeamlessTravelPostProcess.js.map