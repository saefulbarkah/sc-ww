
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ShipTowerView=void 0;const puerts_1=require("puerts"),UE=require("ue"),Log_1=require("../../../../Core/Common/Log"),TimerSystem_1=require("../../../../Core/Timer/TimerSystem"),MathCommon_1=require("../../../../Core/Utils/Math/MathCommon"),EventDefine_1=require("../../../Common/Event/EventDefine"),EventSystem_1=require("../../../Common/Event/EventSystem"),ConfigManager_1=require("../../../Manager/ConfigManager"),ControllerHolder_1=require("../../../Manager/ControllerHolder"),ModelManager_1=require("../../../Manager/ModelManager"),RedDotController_1=require("../../../RedDot/RedDotController"),UiViewBase_1=require("../../../Ui/Base/UiViewBase"),PopupCaptionItem_1=require("../../../Ui/Common/PopupCaptionItem"),UiLayer_1=require("../../../Ui/UiLayer"),LoadAsyncPromise_1=require("../../UiComponent/LoadAsyncPromise"),ShipTowerDefine_1=require("../ShipTowerDefine"),ShipTowerStageItemBase_1=require("./ShipTowerStageItemBase"),stageTypeMap=new Map([[0,ShipTowerStageItemBase_1.ShipTowerStageItemOneTime],[1,ShipTowerStageItemBase_1.ShipTowerStageItemRefresh],[2,ShipTowerStageItemBase_1.ShipTowerStageItemEndless]]),MASK_LAYER_TAG="ShipTower.CheckNeedShowView";class ShipTowerView extends UiViewBase_1.UiViewBase{constructor(){super(...arguments),this.OpenParam=void 0,this.zJa=void 0,this.UiScrollViewStage=void 0,this.rH_=void 0,this.V8_=[],this.Aa_=.001,this.oH_=0,this.nH_=0,this.Pa_=void 0,this.wa_=0,this.BA_=new Map,this.hpt=[],this.sma=void 0,this.UiCureChangeArea=void 0,this.ChangeAreaScrollDuration=0,this.UiCureFlipPage=void 0,this.UiCureScrollTo=void 0,this.FlipPageDistanceThreshold=0,this.FlipPageScrollDuration=0,this.FlipPageIntervalDistance=0,this.sH_=void 0,this.aH_=void 0,this.hH_=void 0,this.lH_=void 0,this._H_=0,this.cH_=0,this.uH_=0,this.dH_=0,this.mH_=new UE.Rotator(0,0,0),this.fH_=new UE.Rotator(0,0,0),this.gH_=new UE.Rotator(0,0,0),this.KH_=!1,this.XH_=!0,this.bzt=!1,this.pKe=()=>(this.bzt=!0,Log_1.Log.CheckDebug()&&Log_1.Log.Debug("ShipTower",69,"拖动开始"),!0),this.SKe=()=>(this.bzt=!1,Log_1.Log.CheckDebug()&&Log_1.Log.Debug("ShipTower",69,"拖动结束"),!0),this.VW_=t=>{this.jW_(!1)},this.Ua_=()=>{ModelManager_1.ModelManager.ShipTowerModel.OpenViewBuff({OperationType:0})},this.R2e=()=>{ModelManager_1.ModelManager.ShipTowerModel.OpenViewReward()},this.cq_=()=>{ModelManager_1.ModelManager.ShipTowerModel.OpenViewRecord()},this.Ba_=()=>{if(!this.YH_()){for(const t of this.Pa_)if(t.OutIndex+1<this.wa_)return void this.zH_(t.OutIndex);this.zH_(0)}},this.qa_=()=>{if(!this.JH_()){for(const t of this.Pa_)if(t.OutIndex>this.wa_)return void this.zH_(t.OutIndex);this.zH_(this.Pa_[this.Pa_.length-1].OutIndex)}},this.ZH_=()=>{TimerSystem_1.TimerSystem.Next(()=>{this.IsDestroyOrDestroying||(this.ScrollTweenerEnd(),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Temp",69,"Tweener滚动完成"))})},this.ka_=t=>{var i,e,t=t.Y;t!==this.Aa_&&(this.Aa_=t,e=(i=this.UiScrollViewStage.ContentUIItem.GetAnchorOffsetY()??0)-this.nH_,this.nH_=i,this.Oa_(i),this.CH_(i),this.UpdateGearScroll(e),this.UpdateCompassPercent(t),Log_1.Log.CheckDebug())&&Log_1.Log.Debug("ShipTower",69,"关卡列表滚动",["比例[0-1]",t],["增值",e],["位置",i],["顶部关卡索引",this.wa_],["调试状态",ModelManager_1.ModelManager.ShipTowerModel.DebugParallaxSub])},this.e9_=()=>{var t=ModelManager_1.ModelManager.ShipTowerModel.IsExistFirstGetBuff();this.GetItem(28)?.SetUIActive(t)},this.uq_=()=>{var t=ModelManager_1.ModelManager.ShipTowerModel.IsEndlessRecordOpen();this.GetButton(2)?.RootUIComp.SetUIActive(t)},this.kOe=()=>{this.OG_(),ModelManager_1.ModelManager.ShipTowerModel.TimeIsOver()&&(this.jm(),ModelManager_1.ModelManager.ShipTowerModel?.CheckIsNeedShowConfirmSeasonUpdate())},this.Usa=()=>{this.OpenParam?.IsFromInstanceDungeon?ModelManager_1.ModelManager.ShipTowerModel.OpenConfirmBackWorld():this.CloseMe()},this.xA_=()=>{this.GG_()},this.T7_=t=>{this.BA_.get(t)?.UpdateData()},this._ti=()=>{ControllerHolder_1.ControllerHolder.HelpController.OpenHelpById(ShipTowerDefine_1.SHIP_TOWER_HELP_ID)}}OnRegisterComponent(){this.ComponentRegisterInfos=[[0,UE.UIItem],[1,UE.UIButtonComponent],[2,UE.UIButtonComponent],[3,UE.UIText],[4,UE.UIText],[5,UE.UIButtonComponent],[6,UE.UIButtonComponent],[7,UE.UIItem],[8,UE.UIItem],[9,UE.UIItem],[10,UE.UIItem],[11,UE.UIItem],[12,UE.UIItem],[13,UE.UIItem],[14,UE.UIItem],[15,UE.UIItem],[16,UE.UIItem],[17,UE.UIItem],[18,UE.UIItem],[19,UE.UIText],[20,UE.UIItem],[21,UE.UIScrollViewWithScrollbarComponent],[22,UE.UIButtonComponent],[23,UE.UIItem],[24,UE.UIItem],[26,UE.UISprite],[25,UE.UISprite],[27,UE.UISprite],[28,UE.UIItem]],this.BtnBindInfo=[[1,this.Ua_],[2,this.cq_],[5,this.Ba_],[6,this.qa_],[22,this.R2e]]}Ss_(){this.OpenParam?.IsOpenCover||ModelManager_1.ModelManager.ShipTowerModel.ClearChallengeStageData(),Log_1.Log.CheckInfo()&&Log_1.Log.Info("ShipTower",69,"",["DataParam",this.OpenParam])}async H8_(){this.OpenParam?.IsFromInstanceDungeon||await ModelManager_1.ModelManager.ShipTowerModel.OpenWelcomeView()}async OnCreateAsync(){this.UiCureChangeArea=await this.SAo(ShipTowerDefine_1.shipTowerCurveRes.ChangeArea),this.UiCureFlipPage=await this.SAo(ShipTowerDefine_1.shipTowerCurveRes.FlipPage),this.UiCureScrollTo=this.UiCureChangeArea}async SAo(t){t=ConfigManager_1.ConfigManager.UiResourceConfig.GetResourcePath(t);return new LoadAsyncPromise_1.LoadAsyncPromise(t,UE.CurveFloat).Promise}async OnBeforeStartAsync(){this.Ss_(),await this.H8_(),await ModelManager_1.ModelManager.ShipTowerModel.CheckInitProto(),this.zJa=new PopupCaptionItem_1.PopupCaptionItem(this.GetItem(0)),this.zJa.SetCloseCallBack(this.Usa),this.zJa.SetHelpBtnActive(!0),this.zJa.SetHelpCallBack(this._ti),await this.Ga_()}OnStart(){this.sH_=this.GetItem(24),this.aH_=this.GetSprite(26),this.hH_=this.GetSprite(25),this.lH_=this.GetSprite(27),this.UiScrollViewStage=this.GetScrollViewWithScrollbar(21),this.pH_(),this.vH_(),this.yH_(),this.SH_(),this.UiScrollViewStage.ScrollToEaseType=28,this.UiScrollViewStage.OnScrollValueChange.Bind(this.ka_),this.UiScrollViewStage.OnPointerBeginDragCallBack.Bind(this.pKe),this.UiScrollViewStage.OnPointerEndDragCallBack.Bind(this.SKe),this.oH_=this.UiScrollViewStage.ContentUIItem.GetAnchorOffsetY()??0,this.nH_=this.oH_,this.rH_=this.GetItem(20),this.Pa_=ConfigManager_1.ConfigManager.ShipTowerConfig.GetAllShowStageCfg(),this.$8_(),this.Oa_(this.oH_),this.EA_(),this.InitCurStageItemPos()}InitCurStageItemPos(){var t,i,e=this.t9_();e&&(this.EH_(0,!1),e=(e=this.GetItem(7+e.OrderIndex-1)).GetStretchTop()+e.GetHeight()/2,t=this.UiScrollViewStage.RootUIComp.GetHeight(),i=this.UiScrollViewStage.ContentUIItem.GetHeight(),i=Math.max(0,Math.min(i-t,e-t/2)),this.UiScrollViewStage.SetScrollValue(new UE.Vector2D(0,i)))}t9_(){return void 0!==this.OpenParam?.StageId?ModelManager_1.ModelManager.ShipTowerModel.GetStageDataById(this.OpenParam.StageId):ModelManager_1.ModelManager.ShipTowerModel.GetNextChallengeStageData()}$8_(){for(let t=0;t<this.rH_.UIChildren.Num();t++){var i=this.rH_.UIChildren.Get(t),e=this.MH_(i);this.V8_.push({Item:i,InitPosY:i.GetAnchorOffsetY()??0,ParallaxSub:e})}}MH_(t,i=1,e=1){t=t.GetDisplayName().split("#"),t=Number(t[i]);return isNaN(t)?e:t/100}pH_(){var t=this.UiScrollViewStage.RootUIComp;this.FlipPageScrollDuration=this.MH_(t,1,.2),this.FlipPageDistanceThreshold=this.MH_(t,2,300),this.FlipPageIntervalDistance=this.MH_(t,3,2)}vH_(){this.ChangeAreaScrollDuration=this.MH_(this.sH_)}yH_(){this._H_=this.MH_(this.aH_,1,300),this.cH_=this.MH_(this.hH_,1,600)}SH_(){this.uH_=this.MH_(this.lH_,1,-45),this.dH_=this.MH_(this.lH_,2,45)}EA_(){var t=this.OpenParam?.StageId??ModelManager_1.ModelManager.ShipTowerModel.TowerStageDataList[0].Id,i=this.OpenParam?.ApplyTeamEditStageId,e=this.OpenParam?.IsOpenStageDesc,s=this.OpenParam?.IsOpenCover;e&&ModelManager_1.ModelManager.ShipTowerModel.OpenViewDesc({StageId:t,ApplyTeamEditStageId:i,IsOpenCover:s},()=>{this.b7_()})}OnAddEventListener(){EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.ShipTowerRewardReceive,this.xA_),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.ShipTowerSureResetStage,this.T7_),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.ShipTowerStageUpdate,this.T7_),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.ShipTowerSureCoverChallenge,this.T7_),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.ShipTowerBuffNewUpdate,this.e9_),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.ShipTowerEndlessRecordUpdate,this.uq_),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OpenView,this.VW_),RedDotController_1.RedDotController.BindRedDot("ShipTowerReward",this.GetItem(23))}OnRemoveEventListener(){EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.ShipTowerRewardReceive,this.xA_),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.ShipTowerSureResetStage,this.T7_),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.ShipTowerStageUpdate,this.T7_),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.ShipTowerSureCoverChallenge,this.T7_),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.ShipTowerBuffNewUpdate,this.e9_),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.ShipTowerEndlessRecordUpdate,this.uq_),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OpenView,this.VW_),RedDotController_1.RedDotController.UnBindRedDot("ShipTowerReward")}OnBeforeShow(){this.Slo();this.sma=TimerSystem_1.RealTimeTimerSystem.Forever(this.kOe,500),ModelManager_1.ModelManager.ShipTowerModel.CloseWelcomeView()}OnAfterPlayStartSequence(){this.OpenParam?.IsOpenStageDesc||this.b7_()}async b7_(){this.jW_(!0),await this.HW_().finally(()=>{this.jW_(!1)})}async HW_(){await ModelManager_1.ModelManager.ShipTowerModel.CheckIsNeedShowSeasonReview(),await ModelManager_1.ModelManager.ShipTowerModel.CheckShowGetBuff()}jW_(t){UiLayer_1.UiLayer.SetShowMaskLayer(MASK_LAYER_TAG,t)}OnAfterHide(){this.jm()}OnBeforeDestroy(){this.UiScrollViewStage.OnScrollValueChange.Unbind(),this.UiScrollViewStage.OnPointerBeginDragCallBack.Unbind(),this.UiScrollViewStage.OnPointerEndDragCallBack.Unbind(),this.i9_()}OnAfterDestroy(){}async Ga_(){0===ModelManager_1.ModelManager.ShipTowerModel.TowerStageDataList.length&&ModelManager_1.ModelManager.ShipTowerModel.CreateDefaultStageDataList();var t=ModelManager_1.ModelManager.ShipTowerModel.TowerStageDataList;let s=7;await Promise.all(t.map(async t=>{var i=this.GetItem(s++),e=new(stageTypeMap.get(t.StageType));await e.Init(i,t),this.BA_.set(t.Id,e),this.hpt.push(e)}))}YH_(){return this.Aa_<=.05}JH_(){return.95<=this.Aa_}zH_(t){this.XH_&&(ModelManager_1.ModelManager.ShipTowerModel.DebugParallaxSub&&this.vH_(),this.UiScrollViewStage.ScrollToDuration=this.ChangeAreaScrollDuration,this.UiCureScrollTo=this.UiCureChangeArea,this.EH_(t))}ScrollToIndexFlipPage(t,i=!0){this.UiScrollViewStage.ScrollToDuration=this.FlipPageScrollDuration,this.UiCureScrollTo=this.UiCureFlipPage,i?this.EH_(t):this.r9_(t)}o9_(t){return MathCommon_1.MathCommon.Clamp(7+t,7,18)}EH_(t,i=!0){var e=this.o9_(t),s=this.GetItem(e),h=(0,puerts_1.$ref)(new UE.Vector2D(this.UiScrollViewStage.ContentUIItem.RelativeLocation));this.UiScrollViewStage.StopMovement(),this.UiScrollViewStage.ScrollToTop(h,s,i),this.UiScrollViewStage.Tweener?.SetCurveFloat(this.UiCureScrollTo),i&&(this.ScrollTweenerStart(),this.n9_()),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("ShipTower",69,"关卡滚动到顶部",["第几艘",t+1],["组件索引",e])}r9_(t,i=!0){var e=this.o9_(t),s=this.GetItem(e),h=(0,puerts_1.$ref)(new UE.Vector2D(this.UiScrollViewStage.ContentUIItem.RelativeLocation));this.UiScrollViewStage.StopMovement(),this.UiScrollViewStage.ScrollToBottom(h,s,i),this.UiScrollViewStage.Tweener?.SetCurveFloat(this.UiCureScrollTo),i&&(this.ScrollTweenerStart(),this.n9_()),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("ShipTower",69,"关卡滚动到底部",["第几艘",t+1],["组件索引",e])}ScrollTweenerStart(){this.XH_=!1,this.UiScrollViewStage.SetRayCastTargetForScrollView(!1),this.s9_(!1)}s9_(i){this.hpt.forEach(t=>{t.SetClickEnable(i)})}ScrollTweenerEnd(){this.XH_=!0,this.UiScrollViewStage.SetRayCastTargetForScrollView(!0),this.s9_(!0)}n9_(){this.KH_||this.UiScrollViewStage.Tweener&&(this.KH_=!0,this.UiScrollViewStage.Tweener.OnCompleteCallBack.Bind(this.ZH_))}i9_(){this.KH_=!1,this.UiScrollViewStage.Tweener?.OnCompleteCallBack.Unbind()}CH_(s){const h=ModelManager_1.ModelManager.ShipTowerModel.DebugParallaxSub;this.V8_.forEach(t=>{var i=h?this.MH_(t.Item):t.ParallaxSub,e=t.InitPosY+(s-this.oH_)*i;t.Item.SetAnchorOffsetY(e),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("ShipTower",69,"更新视差节点位置",["节点名",t.Item.GetDisplayName()],["位置",e],["相对比例",i])})}UpdateGearScroll(t){ModelManager_1.ModelManager.ShipTowerModel.DebugParallaxSub&&this.yH_();var i=t/this._H_*360,e=t/this.cH_*360;this.fH_.Yaw=this.fH_.Yaw+i,this.gH_.Yaw=this.gH_.Yaw-e,this.aH_.SetUIRelativeRotation(this.fH_),this.hH_.SetUIRelativeRotation(this.gH_),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("ShipTower",69,"更新齿轮滚动",["增值",t],["齿轮角度",i],["大齿轮角度",e],["齿轮长度",this._H_],["大齿轮长度",this.cH_])}UpdateCompassPercent(t){ModelManager_1.ModelManager.ShipTowerModel.DebugParallaxSub&&this.SH_();var i=this.dH_-this.uH_,e=t*i+this.uH_;this.mH_.Yaw=e,this.lH_.SetUIRelativeRotation(this.mH_),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("ShipTower",69,"更新指南针进度",["比例[0-1]",t],["总角度",i],["当前角度",e],["开始角度",this.uH_],["结束角度",this.dH_])}Oa_(i){let e=this.wa_;for(let t=7;t<=18;t++){var s=this.GetItem(t),h=s.GetHeight(),s=s.GetStretchTop()+h;if(e=t-7+1,i<=s)break}if(this.wa_!==e){this.wa_=e;for(const t of this.Pa_)if(t.OutIndex>=this.wa_){this.GetText(19).ShowTextNew(t.Name);break}}}CheckFlipPage(i){var e=this.nH_;if(this.XH_&&!(this.Aa_<=0||1<=this.Aa_||this.bzt)){var t=ModelManager_1.ModelManager.ShipTowerModel.DebugParallaxSub;if(t&&this.pH_(),!(Math.abs(i)>this.FlipPageIntervalDistance)){var s=this.UiScrollViewStage.RootUIComp.GetHeight();for(let t=0;t<this.Pa_.length;t++){var h=this.Pa_[t-1],r=this.Pa_[t];if(h&&h.OutIndex+1===r.OutIndex)return void this.a9_(h.OutIndex-1,h.OutIndex,s,0<i);if(this.h9_(r.OutIndex,e))return;if(this.l9_(r.OutIndex-1,e+s))return}}}}a9_(t,i,e,s){var h=this.nH_,r=h+e,a=this.GetStageItemPosY(t,!1),o=this.GetStageItemPosY(i);if(!(r<a+.5*this.FlipPageDistanceThreshold)){if(!(r<o))return(a=this.UiScrollViewStage.ContentUIItem.GetHeight())<=o+e?a-e-h<.5*this.FlipPageDistanceThreshold?void this.ScrollToIndexFlipPage(i,!0):void this.ScrollToIndexFlipPage(s?i:t,s):void(h>o+.5*this.FlipPageDistanceThreshold||this.ScrollToIndexFlipPage(i));this.ScrollToIndexFlipPage(s?i:t,s)}}h9_(t,i){var e=this.GetStageItemPosY(t),s=this.FlipPageDistanceThreshold,i=i-e;return-s<i&&i<s&&(.5*-s<i?this.ScrollToIndexFlipPage(t,!0):this.ScrollToIndexFlipPage(t-1,!1),!0)}l9_(t,i){i-=this.GetStageItemPosY(t,!1);return i>-this.FlipPageDistanceThreshold&&i<this.FlipPageDistanceThreshold&&(i<.5*this.FlipPageDistanceThreshold?this.ScrollToIndexFlipPage(t,!1):this.ScrollToIndexFlipPage(t+1,!0),!0)}GetStageItemPosY(t,i=!0){var t=this.o9_(t),t=this.GetItem(t),e=t.GetStretchTop();return i?e:e+t.GetHeight()}Slo(){this.uq_(),this.GG_(),this.e9_()}GG_(){var t=ModelManager_1.ModelManager.ShipTowerModel.GetRewardProgressText(),t=ModelManager_1.ModelManager.ShipTowerModel.GetCurrentStageSeasonName()+`(${t})`;this.GetText(3).SetText(t),this.OG_()}OG_(){var t=ModelManager_1.ModelManager.ShipTowerModel.GetRewardCountDownDesc();this.GetText(4)?.SetText(t)}jm(){TimerSystem_1.RealTimeTimerSystem.Has(this.sma)&&(TimerSystem_1.RealTimeTimerSystem.Remove(this.sma),this.sma=void 0)}}exports.ShipTowerView=ShipTowerView;
//# sourceMappingURL=ShipTowerView.js.map