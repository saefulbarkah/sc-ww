
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ShipTowerModel=void 0;const CustomPromise_1=require("../../../Core/Common/CustomPromise"),Log_1=require("../../../Core/Common/Log"),CommonDefine_1=require("../../../Core/Define/CommonDefine"),Protocol_1=require("../../../Core/Define/Net/Protocol"),ModelBase_1=require("../../../Core/Framework/ModelBase"),MathUtils_1=require("../../../Core/Utils/MathUtils"),EventDefine_1=require("../../Common/Event/EventDefine"),EventSystem_1=require("../../Common/Event/EventSystem"),LocalStorage_1=require("../../Common/LocalStorage"),LocalStorageDefine_1=require("../../Common/LocalStorageDefine"),TimeUtil_1=require("../../Common/TimeUtil"),ConfigManager_1=require("../../Manager/ConfigManager"),ControllerHolder_1=require("../../Manager/ControllerHolder"),ModelManager_1=require("../../Manager/ModelManager"),UiManager_1=require("../../Ui/UiManager"),UiModel_1=require("../../Ui/UiModel"),ActivityShipTowerController_1=require("../Activity/ActivityContent/ShipTower/ActivityShipTowerController"),ConfirmBoxDefine_1=require("../ConfirmBox/ConfirmBoxDefine"),EditFormationData_1=require("../EditFormation/EditFormationData"),EditFormationDefine_1=require("../EditFormation/EditFormationDefine"),ScrollingTipsController_1=require("../ScrollingTips/ScrollingTipsController"),ShipTowerBuffData_1=require("./ShipTowerBuffData"),ShipTowerDefine_1=require("./ShipTowerDefine"),ShipTowerStageData_1=require("./ShipTowerStageData");class ShipTowerModel extends ModelBase_1.ModelBase{constructor(){super(...arguments),this.O8_=!1,this.zn_=[],this.Jn_=new Map,this.DebugParallaxSub=!1,this.Zn_=[],this.es_=new Map,this.ts_=new Map,this.is_=[],this.rs_=new Map,this.wG_=new Map,this.hA_=0,this.RG_=0,this.AG_=!1,this.PG_=!1,this.lA_=[],this._A_=new Set,this.cA_=0,this.RecordList=[],this.Zk_=0,this.eq_=0,this.ChallengeStageData=void 0,this.ChallengeBuffIdList=[],this.ReviewList=[],this.xG_=[],this.ShowBuffIdList=[],this.LV_=void 0,this.c7_=void 0,this.u7_=void 0,this.CurSelectBuffData=void 0,this.PlayerGetBuffSet=new Set,this.IsShowLeftTeamPanel=!1,this.AddNormalStackChildView=(e,t)=>{e&&UiModel_1.UiModel.NormalStack.Peek()?.AddChildViewById(t)},this.CheckCanOpen=()=>{var e,t;return ModelManager_1.ModelManager.OnlineModel.GetIsTeamModel()?(ControllerHolder_1.ControllerHolder.ScrollingTipsController.ShowTipsByTextId("ErrorCode_600064_Text"),!1):((e=this.IsOpen())||(t=ConfigManager_1.ConfigManager.FunctionConfig.GetFunctionCondition(10081)?.OpenConditionId)&&(t=ConfigManager_1.ConfigManager.ConditionConfig.GetConditionGroupConfig(t))?.HintText&&ControllerHolder_1.ControllerHolder.ScrollingTipsController.ShowTipsByTextId(t.HintText),e)},this.d7_=()=>{this.LeaveBattle()||this.CloseMainView()},this.LeaveBattle=()=>!!this.CheckInBattleShipTower()&&(EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.ResetToBattleView),ModelManager_1.ModelManager.TowerModel.CurrentTowerId=-1,ControllerHolder_1.ControllerHolder.InstanceDungeonEntranceController.LeaveInstanceDungeon(),!0)}get CurSeason(){return this.hA_}get CurSeasonEndTime(){return this.RG_}get CurIsHaveRecord(){return this.AG_}get TowerStageDataList(){return this.zn_}get TowerStageDataMap(){return this.Jn_}get GetRewardTotalNum(){return this.eq_}OnInit(){return UiManager_1.UiManager.AddOpenViewCheckFunction("ShipTowerView",this.CheckCanOpen,"ShipTowerModel.CheckCanOpen"),!0}OnClear(){return UiManager_1.UiManager.RemoveOpenViewCheckFunction("ShipTowerView",this.CheckCanOpen),this.zn_.length=0,this.Jn_.clear(),this.Zn_.length=0,this.es_.clear(),!0}OnLeaveLevel(){return!0}InitData(){this.O8_||(this.O8_=!0,this.N6_(),this.uA_(),this.VH_())}VH_(){var e=LocalStorage_1.LocalStorage.GetPlayer(LocalStorageDefine_1.ELocalStoragePlayerKey.ShipTowerGetBuffSet);e&&Array.from(e).forEach(e=>{this.PlayerGetBuffSet.add(e)})}AddPlayerGetBuff(e){this.PlayerGetBuffSet.add(e),LocalStorage_1.LocalStorage.SetPlayer(LocalStorageDefine_1.ELocalStoragePlayerKey.ShipTowerGetBuffSet,this.PlayerGetBuffSet),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.ShipTowerBuffNewUpdate)}N6_(){this.V6_(ShipTowerDefine_1.SHIP_TOWER_ZERO_SEASON)}V6_(e){ConfigManager_1.ConfigManager.ShipTowerConfig.GetBuffCfgBySeason(e)?.forEach(e=>{this.j6_(e)}),this.H6_()}CheckOldSeasonBuffQualityList(){this.Zn_.forEach(e=>{var t;e.BuffList.some(e=>this.$6_(e))&&(t=e.BuffList.filter(e=>!this.$6_(e)),e.BuffList.unshift(...t),e.BuffList.splice(t.length),0===e.BuffList.length)&&this.es_.delete(e.Quality)})}$6_(e){return this.IsOldSeason(e.Season)}IsOldSeason(e){return e!==ShipTowerDefine_1.SHIP_TOWER_ZERO_SEASON&&e!==this.CurSeason}j6_(e){var t;this.ts_.has(e.Id)||((t=new ShipTowerBuffData_1.ShipTowerBuffData).Init(e),this.ts_.set(e.Id,t),this.es_.has(t.Quality)?this.es_.get(t.Quality).BuffList.push(t):(e={Quality:t.Quality,Title:t.GetQualityTitle(),BuffList:[t]},this.es_.set(t.Quality,e)))}H6_(){this.Zn_.length=0,this.Zn_.push(...Array.from(this.es_.values())),this.Zn_.sort((e,t)=>t.Quality-e.Quality)}async CheckInitProto(){this.UG_()&&await ControllerHolder_1.ControllerHolder.ShipTowerController.SlashAndTowerInfoRequest()}UG_(){return!(!this.IsOpen()||this.TowerStageDataList[0]?.IsHaveProtoData&&!this.TimeIsOver())}uA_(){this.lA_.length=0,this.lA_.push(this.CreateAreaDataById(ShipTowerDefine_1.SHIP_TOWER_ZERO_SEASON))}CreateDefaultStageDataList(){this.TowerStageDataList.length||[0,1].forEach(e=>{ConfigManager_1.ConfigManager.ShipTowerConfig.GetStageCfgBySeason(e)?.forEach(e=>{this.os_(e)})})}ns_(e){var t=ConfigManager_1.ConfigManager.ShipTowerConfig.GetStageCfgById(e);if(t)return this.os_(t);Log_1.Log.CheckError()&&Log_1.Log.Error("ShipTower",69,"CreateStageDataById",["id",e])}os_(e){if(this.Jn_.has(e.Id)){const t=this.Jn_.get(e.Id);return this.zn_.includes(t)||this.zn_.push(t),t}const t=new ShipTowerStageData_1.ShipTowerStageData;return t.Init(e),t.SetOrderIndex(this.zn_.length+1),this.zn_.push(t),this.Jn_.set(e.Id,t),t}GetStageDataById(e){return this.Jn_.get(e)}GetBuffQualityList(e=!1){return e&&this.ss_(),this.Zn_}ss_(){this.Zn_.forEach(e=>{e.BuffList.sort((e,t)=>e.Id-t.Id)})}GetBuffDataByBuffId(e){return this.ts_.get(e)}SelectDefaultBuff(t){for(const i of this.GetBuffQualityList(!0)){var e=i.BuffList.find(e=>e.IsCanUse(t));if(e)return void e.SetSelected(!0)}this.GetBuffQualityList()[0]?.BuffList[0]?.SetSelected(!0)}GetRecommendLevelByInstId(e){return ConfigManager_1.ConfigManager.InstanceDungeonConfig.GetRecommendLevel(e,ModelManager_1.ModelManager.WorldLevelModel.CurWorldLevel)}GetTeamTabList(){return this.is_.length||(this.is_.push({TabType:0,Title:ShipTowerDefine_1.shipTowerTextKey.RoleList}),this.is_.push({TabType:1,Title:ShipTowerDefine_1.shipTowerTextKey.UseTeam})),this.is_}IsOtherTeamRoleData(e){return this.rs_.has(e)}GetOtherTeamRoleData(e){return this.rs_.get(e)}AddOtherTeamRoleData(e){this.rs_.set(e.RoleIdEdit,e)}GetAllTeamRoleData(e){return this.wG_.get(e)}AddAllTeamRoleData(e){this.wG_.set(e.RoleIdEdit,e)}ClearAllTeamRoleData(){this.wG_.clear()}ClearOtherTeamRoleData(){this.rs_.clear()}GetNextChallengeStageData(t){return this.zn_.find(e=>!e.IsPassed()&&e.IsUnLocked()&&e!==t)??this.zn_[this.zn_.length-1]}OpenViewMain(e){UiManager_1.UiManager.OpenView("ShipTowerView",e)}OpenViewDesc(e,i){UiManager_1.UiManager.OpenView("ShipTowerDescView",e,(e,t)=>{this.AddNormalStackChildView(e,t),i?.(e,t)})}OpenViewBuff(e){UiManager_1.UiManager.OpenView("ShipTowerBuffView",e,this.AddNormalStackChildView)}OpenViewCover(e){UiManager_1.UiManager.OpenView("ShipTowerCoverView",e,this.AddNormalStackChildView)}OpenViewReset(e){UiManager_1.UiManager.OpenView("ShipTowerResetView",e,this.AddNormalStackChildView)}OpenViewReward(e){UiManager_1.UiManager.OpenView("ShipTowerRewardView",e,this.AddNormalStackChildView)}OpenViewPassBuffShow(e){UiManager_1.UiManager.OpenView("ShipTowerPassBuffShowView",e,this.AddNormalStackChildView)}OpenViewTeamRecommend(e){UiManager_1.UiManager.OpenView("ShipTowerTeamRecommendView",e,this.AddNormalStackChildView)}OpenViewMonsterDesc(e){UiManager_1.UiManager.OpenView("ShipTowerMonsterDescView",e,this.AddNormalStackChildView)}OpenViewRecord(e){UiManager_1.UiManager.OpenView("ShipTowerRecordView",e,this.AddNormalStackChildView)}OpenViewReview(e){UiManager_1.UiManager.OpenView("ShipTowerReviewView",e,this.AddNormalStackChildView)}as_(e,t,i=!0){return!e||e.Q4n!==Protocol_1.Aki.Protocol.Q4n.KRs&&(Log_1.Log.CheckInfo()&&Log_1.Log.Info("ShipTower",69,"CheckErrorCode",["ErrorCode",e.Q4n],["MsgId",t]),i&&ControllerHolder_1.ControllerHolder.ErrorCodeController.OpenErrorCodeTipView(e.Q4n,t),!0)}UpdateResultNotify(e){var t,i,r,s,a=this.GetStageDataById(e.ELl);a?this.CheckIsNeedShowConfirmSeasonUpdate()||(a.ProtoTeamEditFromResult(e),t=a.NewChallengeScore,i=a.IsNewRecord(t),s=ShipTowerDefine_1.shipTowerTextKey.MonsterScore,r=ShipTowerDefine_1.shipTowerTextKey.TimeScore,s=[{TotalTitle:a.TeamDataList[0].AreaName,TitleA:s,TitleB:r,ScoreA:e.kL_,ScoreB:e.qL_},{TotalTitle:a.TeamDataList[1].AreaName,TitleA:s,TitleB:r,ScoreA:e.OL_,ScoreB:e.GL_}],UiManager_1.UiManager.OpenView("ShipTowerFightFinishView",{TotalScore:t,GradeResId:this.GetStageGradeResIdByStageId(a.Id,t),IsNewRecord:i,ButtonList:this.wV_(a,t),AreaList:s})):this.LeaveBattle()}wV_(e,t){var i,r=[{ButtonTextId:ShipTowerDefine_1.shipTowerTextKey.Leave,DescriptionTextId:void 0,IsTimeDownCloseView:!0,IsClickedCloseView:!0,OnClickedCallback:this.OpenViewMain.bind(this,{StageId:e.Id,IsFromInstanceDungeon:!0})},{ButtonTextId:ShipTowerDefine_1.shipTowerTextKey.ConfirmResult,DescriptionTextId:void 0,IsTimeDownCloseView:!0,IsClickedCloseView:!0,OnClickedCallback:void 0}];return e.IsNeedSureScore?(r[0]=void 0,r[1].OnClickedCallback=e.SureResultFromInstance.bind(e)):(e.IsEndLess?(r[1].ButtonTextId=ShipTowerDefine_1.shipTowerTextKey.Retry,r[1].OnClickedCallback=e.GotoDescFromInstance.bind(e)):e.CheckPass(t)?(t=this.GetNextChallengeStageData(e),i=ConfigManager_1.ConfigManager.TextConfig.GetMultiTextByKey(t.TitleKey),r[1].ButtonTextId=ShipTowerDefine_1.shipTowerTextKey.Continue,r[1].DescriptionTextId=ShipTowerDefine_1.shipTowerTextKey.GoOnTower,r[1].DescriptionArgs=[i,t.OrderIndex],r[1].OnClickedCallback=e.GotoNextDescFromInstance.bind(e,t)):(r[1].ButtonTextId=ShipTowerDefine_1.shipTowerTextKey.Retry,r[1].DescriptionTextId=ShipTowerDefine_1.shipTowerTextKey.NotFinished,r[1].OnClickedCallback=e.GotoDescFromInstance.bind(e)),e.SaveLastData()),r}UpdateLevelPlayNotify(e){e.xL_.forEach(e=>{var t=this.GetStageDataById(e.s5n);t?.ProtoNotifyUpdateData(e),t?.IsEndLess&&!this.IsOldSeason(t.BelongToSeason)&&t.IsTeamSetRoleFinish()&&(this.AG_=!0,EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.ShipTowerEndlessRecordUpdate))}),this.dA_()}SlashAndTowerInfoResponse(e){this.as_(e,16849,!1)||(this.zn_.length=0,e?.xL_.forEach(e=>{this.ns_(e.s5n)}),this.hA_=this.zn_[this.zn_.length-1]?.BelongToSeason??1,this.RG_=MathUtils_1.MathUtils.LongToNumber(e.sG_),this.AG_=!!e.hG_,this.PG_=!!e.aG_,this.CheckOldSeasonBuffQualityList(),this.V6_(this.CurSeason),e?.xL_.forEach(e=>{this.GetStageDataById(e.s5n)?.ProtoUpdateData(e)}),this._A_.clear(),e?.UL_.forEach(e=>{this._A_.add(e)}),this.oQ_(e?.iQ_??[]),this.ClearAreaList(),this.GetAreaList())}SlashAndTowerScoreRewardResponse(e){this.as_(e,23571)||(this._A_.add(this.cA_),this.dA_(),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.ShipTowerRewardReceive,this.cA_))}EndLessHistoryResponse(e){this.as_(e,19548)||(this.RecordList.length=0,this.tq_(ShipTowerDefine_1.shipTowerTextKey.CurrentRecord,e.DL_),this.tq_(ShipTowerDefine_1.shipTowerTextKey.HistoryRecord,e.BL_))}tq_(e,t){if(t&&0!==t?.s5n){var i=ShipTowerDefine_1.shipTowerTextKey.ReachDate,r=MathUtils_1.MathUtils.LongToNumber(t.nG_);const s={Id:0,Name:e,Desc:ConfigManager_1.ConfigManager.TextConfig.GetMultiTextByKey(i,i),TimeContent:TimeUtil_1.TimeUtil.DateFormat4String(r),RecordList:[]};e=(e,t)=>{if(t){var i=t.ML_?.bL_??[];const r=t.oG_??[];e={Title:ConfigManager_1.ConfigManager.TextConfig.GetMultiTextByKey(e,e),Score:t.tBs,Wave:t.EL_,TeamList:i.map((e,t)=>({Id:e,Count:r[t]??0})),BuffId:t.ML_?.LL_??0};s.RecordList.push(e)}};e(ShipTowerDefine_1.shipTowerTextKey.TeamName1,t.IL_),e(ShipTowerDefine_1.shipTowerTextKey.TeamName2,t.TL_),this.RecordList.push(s)}}SlashAndTowerSaveRecordResponse(e,t){this.as_(t,28508)||(this.GetStageDataById(e)?.CoverChallenge(),this.dA_(),ScrollingTipsController_1.ScrollingTipsController.ShowTipsByTextId(ShipTowerDefine_1.shipTowerTextKey.CoverChallenge),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.ShipTowerSureCoverChallenge,e))}SlashAndTowerResetResponse(e,t){this.as_(t,16258)||(this.GetStageDataById(e)?.ResetStage(),this.dA_(),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.ShipTowerSureResetStage,e),ScrollingTipsController_1.ScrollingTipsController.ShowTipsByTextId(ShipTowerDefine_1.shipTowerTextKey.ResetStage))}SlashAndTowerRecommendResponse(e,t){this.as_(t,22559)||this.GetStageDataById(e)?.ProtoUpdateTeamRecommendList(t)}SlashAndTowerReviewResponse(e){this.as_(e,16655)||(this.ReviewList.length=0,e?._G_.forEach(e=>{var t=e.lG_,e=e.SMs;this.ReviewList.push({Title:this.GetStageNameById(t),Score:e,Grade:this.GetStageGradeResIdByStageId(t,e),StageId:t})}))}GetPlayerTeamList(){var t=[];for(let e=1;e<EditFormationDefine_1.MAX_FORMATION_ID;e++){var i=ModelManager_1.ModelManager.EditFormationModel.GetFormationData(e);t.push(i||new EditFormationData_1.EditFormationData(e))}return t}UpdateToEdit(){this.zn_.forEach(e=>{e.UpdateToEdit()})}GetAreaList(){return 2<=this.lA_.length||(this.lA_.push(this.CreateAreaDataById(this.CurSeason)),this.lA_.push(this.CreateAreaDataById(this.CurSeason,!0)),this.dA_()),this.lA_}CreateAreaDataById(e,t=!1){var i=this.GetRewardListByAreaId(e,t);let r=ShipTowerDefine_1.shipTowerTextKey.AreaNameShallow;return e!==ShipTowerDefine_1.SHIP_TOWER_ZERO_SEASON&&(r=t?ShipTowerDefine_1.shipTowerTextKey.AreaNameDead:ShipTowerDefine_1.shipTowerTextKey.AreaNameDeep),{Id:e,Index:this.lA_.length,Name:r,Desc:"",RewardList:i,IsEndless:t,MaxScore:i[i.length-1]?.TotalScore??0}}GetRewardListByAreaId(e,t=!1){const r=[];return ConfigManager_1.ConfigManager.ShipTowerConfig.GetChallengeRewardCfgBySeason(e)?.forEach(e=>{if(t===e.EndLessReward){const i=[];ConfigManager_1.ConfigManager.RewardConfig.GetDropPackage(e.RewardId)?.DropPreview.forEach((e,t)=>{i.push([{ItemId:t,IncId:0},e])}),r.push({Id:e.Id,TitleKey:e.Desc,TotalScore:e.SumScore,RewardList:i,IsReceive:!1,IsProgress:!1,IsCompleted:!1})}}),r}ClearAreaList(){for(let e=this.lA_.length-1;0<=e;e--)this.lA_[e].Id!==ShipTowerDefine_1.SHIP_TOWER_ZERO_SEASON&&this.lA_.splice(e,1)}dA_(){this.Zk_=0,this.eq_=0,this.lA_.forEach(e=>{const s=e.Id,a=e.IsEndless,i=this.TowerStageDataList.reduce((e,t)=>{var i=t.BelongToSeason===s,r=t.IsEndLess===a;return e+(i&&r?t.CurrentScore:0)},0);e.Desc=`<color=#fee488ff>${i}</color>/`+e.MaxScore;let r=!0,o=!1;e.RewardList.forEach(e=>{var t=this._A_.has(e.Id);e.IsReceive=!t&&i>=e.TotalScore,e.IsProgress=!t&&i<e.TotalScore,e.IsCompleted=t,e.IsCompleted||(r=!1),e.IsReceive&&(o=!0,this.Zk_++),this.eq_++}),e.IsFinish=r,e.IsRedPoint=o,e.RewardList?.sort((e,t)=>e.IsReceive!==t.IsReceive?e.IsReceive?-1:1:e.IsProgress!==t.IsProgress?e.IsProgress?-1:1:e.Id-t.Id)}),this.lA_.sort((e,t)=>e.IsFinish!==t.IsFinish?e.IsFinish?1:-1:e.Index-t.Index),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.RedDotUpdateShipTowerReward),ActivityShipTowerController_1.ActivityShipTowerController.RefreshActivityRedDot()}async ReceiveAward(e){this.cA_=e,await ControllerHolder_1.ControllerHolder.ShipTowerController.SlashAndTowerScoreRewardRequest(e)}GetRewardProgressText(e=!0){let t=0,i=0;const r=this.IsPassZeroSeason();return this.lA_.filter(e=>{e=e.Id===ShipTowerDefine_1.SHIP_TOWER_ZERO_SEASON;return r?!e:e}).forEach(e=>{t+=e.RewardList.filter(e=>e.IsCompleted).length,i+=e.RewardList.length}),e?`<color=#fadf85>${t}</color>/`+i:t+"/"+i}GetRemainTime(){return this.CurSeasonEndTime<=0?0:this.CurSeasonEndTime-TimeUtil_1.TimeUtil.GetServerTime()}TimeIsOver(){return this.GetRemainTime()<=0}GetRewardCountDownDesc(){var e=ShipTowerDefine_1.shipTowerTextKey.RewardCountDownDesc,t=this.GetRemainTime(),t=TimeUtil_1.TimeUtil.GetRemainTimeDataFormat3(t);return ConfigManager_1.ConfigManager.TextConfig.GetMultiText(e,t.CountDownText)}IsCanReceiveAward(){return 0<this.Zk_}IsEndlessRecordOpen(){return this.CurIsHaveRecord}IsCanUseRole(e){return!!ModelManager_1.ModelManager.RoleModel.GetRoleInstanceById(e)}async RequestRecord(){await ControllerHolder_1.ControllerHolder.ShipTowerController.EndLessHistoryRequest()}IsOpen(){return ModelManager_1.ModelManager.FunctionModel.IsOpen(10081)}CheckInBattleShipTower(){var e;return!(!ControllerHolder_1.ControllerHolder.GameModeController.IsInInstance()||(e=ModelManager_1.ModelManager.CreatureModel.GetInstanceId(),!(e=ConfigManager_1.ConfigManager.InstanceDungeonConfig.GetConfig(e)))||27!==e.InstSubType)}StartChallenge(e){var t=(this.ChallengeStageData=e).TeamDataList.map(e=>e.BuffDataEdit?.Id??0);this.oQ_(t),ControllerHolder_1.ControllerHolder.ShipTowerController.RequestChallenge(e)}oQ_(e){this.ChallengeBuffIdList.length=0,this.ChallengeBuffIdList.push(...e)}AgainChallenge(){var e;this.iq_()&&(e=ModelManager_1.ModelManager.CreatureModel.GetInstanceId(),e=this.ChallengeStageData?.TeamDataList[1].InstId===e,ControllerHolder_1.ControllerHolder.ShipTowerController.RequestChallenge(this.ChallengeStageData,e,!0))}OpenViewMainFromFight(){var e;this.iq_()&&(e=this.ChallengeStageData.Id,this.OpenViewMain({StageId:e,IsFromInstanceDungeon:!0}))}iq_(){if(!this.ChallengeStageData){const t=ModelManager_1.ModelManager.CreatureModel.GetInstanceId();var e=this.zn_.find(e=>e.InstIds.includes(t));if(!e)return!1;this.ChallengeStageData=e}return!0}ClearChallengeStageData(){this.ChallengeStageData&&(this.ChallengeStageData.UpdateToEdit(),this.ChallengeStageData=void 0)}async CheckIsNeedShowSeasonReview(){if(!this.c7_||this.c7_.IsFulfilled()){if(this.TimeIsOver()&&await this.CheckInitProto(),!this.PG_)return!1;await ControllerHolder_1.ControllerHolder.ShipTowerController.SlashAndTowerReviewRequest(),this.c7_=new CustomPromise_1.CustomPromise,this.OpenViewReview({SeasonId:this.CurSeason,Promise:this.c7_}),this.PG_=!1,this.MW_()}return await this.c7_.Promise,!0}MW_(){var e=this.zn_.filter(e=>e.IsOldSeasonData());e.length&&(e.forEach(e=>{e.ResetStage()}),this.dA_())}GetStageGradeResId(e){e=ShipTowerDefine_1.shipTowerScoreGradeMap[e];return(e||ShipTowerDefine_1.shipTowerScoreGradeMap.D).ResId}GetStageGradeResIdByStageId(e,t){var i=this.GetStageDataById(e);return i?i.GetStageGradeResIdByScore(t):(i=ConfigManager_1.ConfigManager.ShipTowerConfig.GetStageCfgById(e))?this.GetStageGradeResIdByScore(t,i.TargetScore,i.ScoreStage):void 0}GetStageGradeResIdByScore(t,i,r){for(let e=i.length-1;0<=e;e--)if(t>=i[e])return this.GetStageGradeResId(r[e])}GetStageNameById(e){var t=this.GetStageDataById(e);let i=void 0;t&&(i=t.TitleKey);t=ConfigManager_1.ConfigManager.ShipTowerConfig.GetStageCfgById(e);return(i=t?t.Title:i)?ConfigManager_1.ConfigManager.TextConfig.GetMultiTextByKey(i,i):""}GetInTheBattleBuffInfo(){var e=this.iq_()?this.ChallengeStageData:this.zn_[0];const t=ModelManager_1.ModelManager.CreatureModel.GetInstanceId();var e=e?.TeamDataList.findIndex(e=>e.InstId===t)??0,e=this.ChallengeBuffIdList[e],e=(ConfigManager_1.ConfigManager.ShipTowerConfig?.GetBuffCfgById(e))?.ItemId??this.ts_.values().next().value.ItemId,i=ConfigManager_1.ConfigManager.InventoryConfig.GetItemConfig(e),r=i.Name,s=i.ObtainedShowDescription;return{TitleKey:r,SubTitleKey:"GhostShipItemQuality_Text"+i.QualityId,ItemInfo:{ItemConfigId:e,Data:void 0,Type:4},DescInfoList:[{DescKey:s,DescUseChangeColor:!0}],DescTitleKey:ShipTowerDefine_1.shipTowerTextKey.BattleBuffSkillTitle}}AddShowBuffId(e,t=!0){this.xG_.push(e),t&&(this.ShowBuffIdList.push(e),UiManager_1.UiManager.IsViewOpen("ShipTowerShowBuffView")||UiManager_1.UiManager.OpenView("ShipTowerShowBuffView"))}async CheckShowGetBuff(){if(!this.u7_||this.u7_.IsFulfilled()){if(this.xG_.length<=0)return!1;this.u7_=new CustomPromise_1.CustomPromise,UiManager_1.UiManager.OpenView("ShipTowerGetBuffView",{ItemDataList:this.m7_(),Promise:this.u7_}),this.xG_.length=0}return await this.u7_.Promise,!0}ClearGetBuffIdList(){this.xG_.length=0}m7_(){const i=[],r=new Map;return this.xG_.forEach(e=>{var t,e=this.GetBuffDataByBuffId(e);e&&(r.has(e.ItemId)?r.get(e.ItemId)[1]++:(t=[{ItemId:e.ItemId,IncId:0},0],i.push(t),r.set(e.ItemId,t)))}),i}async OpenWelcomeView(){this.LV_&&!this.LV_.IsFulfilled()||(this.LV_=new CustomPromise_1.CustomPromise,UiManager_1.UiManager.OpenView("ShipTowerWelcomeView",{Promise:this.LV_})),await this.LV_.Promise}CloseWelcomeView(){UiManager_1.UiManager.CloseView("ShipTowerWelcomeView")}CloseMainView(){UiManager_1.UiManager.CloseView("ShipTowerView")}GetSeasonCountDownData(){let e=this.GetRemainTime();var t=(e=e<=1?1:e)>=CommonDefine_1.SECOND_PER_DAY?3:e>=CommonDefine_1.SECOND_PER_HOUR?2:1,i=e>=CommonDefine_1.SECOND_PER_DAY?2:e>=CommonDefine_1.SECOND_PER_HOUR?1:0;return TimeUtil_1.TimeUtil.GetCountDownDataFormat2(e,t,i)}GetStageAreaName(e){const t=void 0===e?this.GetCurrentStage():this.GetStageDataById(e)??this.zn_[0],i=this.zn_.findIndex(e=>e.Id===t?.Id);e=ConfigManager_1.ConfigManager.ShipTowerConfig.GetAllShowStageCfg().find(e=>e.OutIndex>=i);return e?ConfigManager_1.ConfigManager.TextConfig.GetMultiTextByKey(e.Name,e.Name):""}GetCurrentStageSeasonName(){if(this.GetCurrentStage()?.BelongToSeason===ShipTowerDefine_1.SHIP_TOWER_ZERO_SEASON){const e=ShipTowerDefine_1.shipTowerTextKey.OneTimeSeasonName;return ConfigManager_1.ConfigManager.TextConfig.GetMultiTextByKey(e,e)}const e=ShipTowerDefine_1.shipTowerTextKey.RefreshSeasonName;return ConfigManager_1.ConfigManager.TextConfig.GetMultiTextByKey(e,e)}GetCurrentStageSeasonName2(){if(this.GetCurrentStage()?.BelongToSeason===ShipTowerDefine_1.SHIP_TOWER_ZERO_SEASON){const e=ShipTowerDefine_1.shipTowerTextKey.AreaNameShallow;return ConfigManager_1.ConfigManager.TextConfig.GetMultiTextByKey(e,e)}const e=ShipTowerDefine_1.shipTowerTextKey.AreaNameRefresh;return ConfigManager_1.ConfigManager.TextConfig.GetMultiTextByKey(e,e)}GetCurrentStage(){for(let e=this.zn_.length-1;0<=e;e--){var t=this.zn_[e];if(t.IsUnLocked())return t}return this.zn_[0]}IsPassZeroSeason(){return this.GetCurrentStage()?.BelongToSeason!==ShipTowerDefine_1.SHIP_TOWER_ZERO_SEASON}GetEndlessStageData(){return this.zn_.find(e=>e.IsEndLess)??this.zn_[0]}CheckIsNeedShowConfirmSeasonUpdate(e){return!!this.f7_()&&(this.g7_(e),!0)}f7_(){return!!this.PG_||!!this.TimeIsOver()}g7_(e){var t=new ConfirmBoxDefine_1.ConfirmBoxDataNew(256),e=e??this.d7_;t.FunctionMap.set(1,e),t.FunctionMap.set(2,e),ControllerHolder_1.ControllerHolder.ConfirmBoxController.ShowConfirmBoxNew(t)}OpenConfirmBackWorld(){var e=new ConfirmBoxDefine_1.ConfirmBoxDataNew(254);e.FunctionMap.set(2,this.LeaveBattle),ControllerHolder_1.ControllerHolder.ConfirmBoxController.ShowConfirmBoxNew(e)}IsExistFirstGetBuff(){return this.Zn_.some(e=>e.BuffList.some(e=>e.IsFirstGet()))}}exports.ShipTowerModel=ShipTowerModel;
//# sourceMappingURL=ShipTowerModel.js.map