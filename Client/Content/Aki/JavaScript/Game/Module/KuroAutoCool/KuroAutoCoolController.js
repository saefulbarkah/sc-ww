
"use strict";var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.KuroAutoCoolController=void 0;const puerts_1=require("puerts"),UE=require("ue"),Log_1=require("../../../Core/Common/Log"),ControllerBase_1=require("../../../Core/Framework/ControllerBase"),GameSettingsDeviceRender_1=require("../../../Game/GameSettings/GameSettingsDeviceRender"),GameSettingsManager_1=require("../../../Game/GameSettings/GameSettingsManager"),GameSettingsUtils_1=require("../../../Game/GameSettings/GameSettingsUtils"),GlobalData_1=require("../../../Game/GlobalData"),Platform_1=require("../../../Launcher/Platform/Platform"),KuroPerformanceController_1=require("../KuroPerformance/KuroPerformanceController");class KuroAutoCoolController extends ControllerBase_1.ControllerBase{static SetMaxFrameRate(t){UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"t.MaxFPS "+t)}static GetCurrentValue(t){return GameSettingsManager_1.GameSettingsManager.Get(t).GetCurrentValue()}static ApplyNiagaraQuality(t){var e=GameSettingsDeviceRender_1.GameSettingsDeviceRender.IsIosAndAndroidHighDevice();UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"r.DisableDistortion "+(0<t&&e?0:1)),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"fx.Niagara.QualityLevel "+(0<t?1:0))}static ApplyMobileResolution(t){let e=GameSettingsDeviceRender_1.GameSettingsDeviceRender.GetMobileResolutionByIndex(t);t=UE.KismetSystemLibrary.GetConsoleVariableFloatValue("r.SecondaryScreenPercentage.GameViewport");GameSettingsDeviceRender_1.GameSettingsDeviceRender.GetDefaultScreenResolution().Y<750&&t<70&&(e=Math.min(1.5*e,100)),UE.KismetSystemLibrary.ExecuteConsoleCommand(GlobalData_1.GlobalData.World,"r.ScreenPercentage "+e)}static ReduceImageQualityAndFrameRate(){let t=UE.KuroRenderingRuntimeBPPluginBPLibrary.GetMaxFps(),e=this.GetCurrentValue(67),o=this.GetCurrentValue(55),r=this.GetCurrentValue(64),i=this.GetCurrentValue(56),s=this.GetCurrentValue(54),a=this.GetCurrentValue(79);this.RKo&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("Render",68,"自动降温触发前",["CurrentFps",t],["Resolution",e],["Niagara",o],["ImageDetail",i],["VolumeLight",r],["Shadow",s],["NpcDensity",a]),55<t?(this.cZa=!0,this.SetMaxFrameRate(55),t=55,o&&o>this.nMl&&(this.ApplyNiagaraQuality(this.nMl),o=this.nMl),e&&e>this.sMl&&(this.ApplyMobileResolution(this.sMl),e=this.sMl)):50<t&&t<=55?(this.cZa=!0,this.SetMaxFrameRate(50),t=50,r&&r>this.aMl&&(GameSettingsUtils_1.GameSettingsUtils.ApplyVolumeLight(this.aMl),r=this.aMl),i&&i>this.lMl&&(GameSettingsUtils_1.GameSettingsUtils.ApplyImageDetail(this.lMl),i=this.lMl)):45<t&&t<=50?(this.cZa=!0,this.SetMaxFrameRate(45),t=45,a&&a>this.hMl&&(GameSettingsUtils_1.GameSettingsUtils.ApplyNpcDensity(this.hMl),a=this.hMl)):40<t&&t<=45&&(this.cZa=!0,this.SetMaxFrameRate(40),t=40,s)&&s>this._Ml&&(GameSettingsUtils_1.GameSettingsUtils.ApplyShadowQuality(this._Ml),s=this._Ml),this.RKo&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("Render",68,"自动降温触发后",["CurrentFps",t],["Resolution",e],["Niagara",o],["ImageDetail",i],["VolumeLight",r],["NpcDensity",a],["Shadow",s])}static RestoreImageQualityAndFrameRate(){this.cZa=!1;let t=UE.KuroRenderingRuntimeBPPluginBPLibrary.GetMaxFps();var e=this.GetCurrentValue(67),o=this.GetCurrentValue(55),r=this.GetCurrentValue(64),i=this.GetCurrentValue(56),s=this.GetCurrentValue(54),a=this.GetCurrentValue(79);this.RKo&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("Render",68,"自动降温恢复前",["CurrentFps",t]),55<=t&&t<60?(this.SetMaxFrameRate(60),t=60,o&&o>this.nMl&&this.ApplyNiagaraQuality(o),e&&e>this.sMl&&this.ApplyMobileResolution(e)):50<=t&&t<55?(this.SetMaxFrameRate(55),t=55,r&&r>this.aMl&&GameSettingsUtils_1.GameSettingsUtils.ApplyVolumeLight(r),i&&i>this.lMl&&GameSettingsUtils_1.GameSettingsUtils.ApplyImageDetail(i)):45<=t&&t<50?(this.SetMaxFrameRate(50),t=50,a&&a>this.hMl&&GameSettingsUtils_1.GameSettingsUtils.ApplyNpcDensity(a)):40<=t&&t<45&&(this.SetMaxFrameRate(45),t=45,s)&&s>this._Ml&&GameSettingsUtils_1.GameSettingsUtils.ApplyShadowQuality(s),this.RKo&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("Render",68,"自动降温恢复后",["CurrentFps",t],["Resolution",e],["Niagara",o],["ImageDetail",i],["VolumeLight",r],["NpcDensity",a],["Shadow",s])}static ltl(){var t=UE.KuroRenderingRuntimeBPPluginBPLibrary.GetCpuTemperature();this.RKo&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("Render",68,"当前CPU温度",["CpuTemperature",t]),this.$Xr=0,this.cZa&&t<this.h_l?this.RestoreImageQualityAndFrameRate():t>=this.h_l&&this.ReduceImageQualityAndFrameRate()}static OnInit(){return this.TemperatureDelegate=(0,puerts_1.toManualReleaseDelegate)(this.htl),!(this.cZa=!1)}static OnClear(){return(0,puerts_1.releaseManualReleaseDelegate)(this.htl),!0}static OnTick(t){var e;0<UE.KuroRenderingRuntimeBPPluginBPLibrary.GetCVarFloat("r.Kuro.AutoCoolEnable")&&(e=0<UE.KuroRenderingRuntimeBPPluginBPLibrary.GetCVarFloat("r.Kuro.AutoCoolUIEnable"),Platform_1.Platform.IsMobilePlatform())&&e&&(this.$Xr+=t,this.$Xr>this.uZa)&&(KuroPerformanceController_1.KuroPerformanceController.IsEnable?UE.KuroPerformanceBPLibrary.GetCurrentTemperatureData(this.TemperatureDelegate):this.ltl(),this.$Xr=0)}}exports.KuroAutoCoolController=KuroAutoCoolController,(_a=KuroAutoCoolController).uZa=1e4,KuroAutoCoolController.RKo=!0,KuroAutoCoolController.h_l=65,KuroAutoCoolController.$Xr=0,KuroAutoCoolController.cZa=!1,KuroAutoCoolController.sMl=1,KuroAutoCoolController.nMl=1,KuroAutoCoolController.lMl=1,KuroAutoCoolController.aMl=0,KuroAutoCoolController.hMl=1,KuroAutoCoolController._Ml=1,KuroAutoCoolController.TemperatureDelegate=void 0,KuroAutoCoolController.htl=(t,e,o)=>{_a.RKo&&Log_1.Log.CheckInfo()&&Log_1.Log.Info("Render",68,"KuroAutoCoolController.temperature",["bResult",t],["currentTemperature",e],["tempBudget",o]),!t||o<=5?_a.ReduceImageQualityAndFrameRate():_a.cZa&&_a.RestoreImageQualityAndFrameRate()};
//# sourceMappingURL=KuroAutoCoolController.js.map