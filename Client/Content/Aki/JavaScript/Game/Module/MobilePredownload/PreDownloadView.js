
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PreDownloadView=void 0;const UE=require("ue"),CustomPromise_1=require("../../../Core/Common/CustomPromise"),Time_1=require("../../../Core/Common/Time"),CommonParamById_1=require("../../../Core/Define/ConfigCommon/CommonParamById"),NetworkDefine_1=require("../../../Launcher/NetworkDefine"),PreDownloadManager_1=require("../../../Launcher/PreDownload/PreDownloadManager"),LauncherLog_1=require("../../../Launcher/Util/LauncherLog"),EventDefine_1=require("../../Common/Event/EventDefine"),EventSystem_1=require("../../Common/Event/EventSystem"),ConfigManager_1=require("../../Manager/ConfigManager"),ControllerHolder_1=require("../../Manager/ControllerHolder"),ModelManager_1=require("../../Manager/ModelManager"),UiViewBase_1=require("../../Ui/Base/UiViewBase"),ConfirmBoxDefine_1=require("../ConfirmBox/ConfirmBoxDefine"),PreDownloadDefine_1=require("./PreDownloadDefine");class PreDownloadView extends UiViewBase_1.UiViewBase{constructor(){super(...arguments),this.L6e=void 0,this.lyc=0,this.Qz="",this._yc="",this.cyc="",this.I5t=()=>{ControllerHolder_1.ControllerHolder.PreDownloadController.ClosePreDownloadView()},this.idc=()=>{ControllerHolder_1.ControllerHolder.PreDownloadController.OnModeChange()},this.rdc=()=>{var e;!PreDownloadManager_1.PreDownloadManager.Get().IsComplete()&&(e=CommonParamById_1.configCommonParamById.GetIntConfig("panel_interval_time"),!this.L6e||Time_1.Time.Now-this.L6e>=e)&&(this.L6e=Time_1.Time.Now,ModelManager_1.ModelManager.PreDownloadModel.SwitchResumeOrPause())},this.odc=(e=!1)=>{var o=ModelManager_1.ModelManager.PreDownloadModel.GetDownloadMode(),r=PreDownloadManager_1.PreDownloadManager.Get(),n=r.IsComplete(),i=this.GetText(9),r=r.IsDownloading();if(LauncherLog_1.LauncherLog.Info("get pre download state update",["is complete",n],["is downloading",r]),n){this.GetButton(1).RootUIComp.SetUIActive(!1);const a=ConfigManager_1.ConfigManager.TextConfig.GetMultiTextByKey(PreDownloadDefine_1.COMPLETE_TXT);i?.SetText(a),void this.UpdatePatchDownProgress(!1,this.lyc,"","0B/s",this.cyc,this.cyc).then(()=>{var e=ConfigManager_1.ConfigManager.TextConfig.GetMultiTextByKey(PreDownloadDefine_1.COMPLETE_TXT);this.GetText(7)?.SetText(e)})}else{this.GetButton(1).RootUIComp.SetUIActive(!0);n=ConfigManager_1.ConfigManager.TextConfig.GetMultiTextByKey(0===o?PreDownloadDefine_1.SPEEDMODE_TXT:PreDownloadDefine_1.NORMALMODE_TXT);const a=ConfigManager_1.ConfigManager.TextConfig.GetMultiTextByKey(r?PreDownloadDefine_1.PAUSING_TXT:PreDownloadDefine_1.DOWNLOADING_TXT);this.GetText(8)?.SetText(n),i?.SetText(a),e||r||ModelManager_1.ModelManager.PreDownloadModel.IsBinPatching()||this.UpdatePatchDownProgress(!1,this.lyc,this.Qz,"0B/s",this._yc,this.cyc)}}}OnRegisterComponent(){this.ComponentRegisterInfos=[[0,UE.UIButtonComponent],[1,UE.UIButtonComponent],[2,UE.UIButtonComponent],[3,UE.UITexture],[4,UE.UIText],[5,UE.UIText],[6,UE.UITexture],[7,UE.UIText],[8,UE.UIText],[9,UE.UIText]],this.BtnBindInfo=[[0,this.I5t],[1,this.idc],[2,this.rdc]]}OnStart(){var e=ConfigManager_1.ConfigManager.UiResourceConfig.GetResourcePath(PreDownloadDefine_1.PREVIEW_BGID);this.SetTextureByPath(e,this.GetTexture(6)),PreDownloadManager_1.PreDownloadManager.Get().SetView(this)}OnBeforeShow(){this.L6e=void 0,this.Sdc()}OnAfterShow(){PreDownloadManager_1.PreDownloadManager.Get().IsDownloading()||(UE.KuroLauncherLibrary.GetNetworkConnectionType()===NetworkDefine_1.ENetworkType.Cell?ControllerHolder_1.ControllerHolder.PreDownloadController.OnCellNetTypeChanged():ModelManager_1.ModelManager.PreDownloadModel.GetHasStartDownload()||(ModelManager_1.ModelManager.PreDownloadModel.StartPreDownload(),this.odc()))}OnBeforeDestroy(){ModelManager_1.ModelManager.PreDownloadModel.ClearView()}OnAddEventListener(){EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.PreDownloadStateUpdate,this.odc)}OnRemoveEventListener(){EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.PreDownloadStateUpdate,this.odc)}async UpdatePatchDownProgress(e,o,r,n,i,a){var t=PreDownloadManager_1.PreDownloadManager.Get().IsDownloading(),e=(ModelManager_1.ModelManager.PreDownloadModel?.OnUpdateDownData(e,o,r,t?n:"0B/s",i,a),this.lyc=o,this.Qz=r,this._yc=i,this.cyc=a,ConfigManager_1.ConfigManager.TextConfig.GetMultiTextByKey(t?"PreDownload_Downloading":"PreDownload_IsPausing"));this.GetText(7)?.SetText(e),this.GetTexture(3)?.SetFillAmount(o);this.GetText(5)?.SetText(r);e=`${t?n:"0B/s"}(${i}/${a})  ${(100*o).toFixed(2).toString()}%`;return this.GetText(4)?.SetText(e),new Promise(e=>{e()})}async BinPatchProgress(e,o,r,...n){ModelManager_1.ModelManager.PreDownloadModel?.OnBinPatch(e,o,r,...n),this.lyc=o;e=ConfigManager_1.ConfigManager.TextConfig.GetMultiTextByKey("PreDownload_BinPatch");this.GetText(7)?.SetText(e),this.GetTexture(3)?.SetFillAmount(o);this.GetText(5)?.SetText("");r=(100*o).toFixed(2).toString()+"%";return this.GetText(4)?.SetText(r),new Promise(e=>{e()})}async ShowDialog(e,o,r,n,i,a,...t){if(LauncherLog_1.LauncherLog.Info("PreDownload Get ShowDialog with ",["contentId",r]),LauncherLog_1.LauncherLog.Info("PreDownload Get ShowDialog with Args",["contentId",t]),"HotFixUseNetworkDownload"===i)return PreDownloadManager_1.PreDownloadManager.Get().IsDownloading();o=ControllerHolder_1.ControllerHolder.PreDownloadController.GetLocalText(o),t=ControllerHolder_1.ControllerHolder.PreDownloadController.GetLocalText(r,...t);const s=new CustomPromise_1.CustomPromise;var r="HotFixNotEnoughSpace"===r;return ModelManager_1.ModelManager.PreDownloadModel.PausePreDownload(r?4:3),a?((r=new ConfirmBoxDefine_1.ConfirmBoxDataNew(274)).SetTitle(o),r.SetTextArgs(t),r.SetBtnText(0,ControllerHolder_1.ControllerHolder.PreDownloadController.GetLocalText(a)),r.FunctionMap.set(1,()=>{s.SetResult(!0)}),ControllerHolder_1.ControllerHolder.ConfirmBoxController.ShowConfirmBoxNew(r)):((a=new ConfirmBoxDefine_1.ConfirmBoxDataNew(275)).SetTitle(o),a.SetTextArgs(t),a.SetBtnText(0,ControllerHolder_1.ControllerHolder.PreDownloadController.GetLocalText(n)),a.SetBtnText(1,ControllerHolder_1.ControllerHolder.PreDownloadController.GetLocalText(i)),a.FunctionMap.set(1,()=>{s.SetResult(!1),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.PreDownloadStateUpdate)}),a.FunctionMap.set(2,()=>{s.SetResult(!0),ModelManager_1.ModelManager.PreDownloadModel.ResumePreDownload()}),ControllerHolder_1.ControllerHolder.ConfirmBoxController.ShowConfirmBoxNew(a)),s.Promise}Sdc(){this.odc(!0);var e,o=ModelManager_1.ModelManager.PreDownloadModel.IsBinPatching(),r=this.GetText(7),n=this.GetTexture(3),i=this.GetText(5),a=this.GetText(4);o&&ModelManager_1.ModelManager.PreDownloadModel.BinPatch?(o=ModelManager_1.ModelManager.PreDownloadModel.BinPatch,e=ConfigManager_1.ConfigManager.TextConfig.GetMultiTextByKey("PreDownload_BinPatch"),r?.SetText(e),n?.SetFillAmount(o.Rate),i?.SetText(""),e=(100*o.Rate).toFixed(2).toString()+"%",a?.SetText(e)):ModelManager_1.ModelManager.PreDownloadModel.UpdateData?(o=ModelManager_1.ModelManager.PreDownloadModel.UpdateData,this.UpdatePatchDownProgress(!1,o.Rate,o.FileName,o.SpeedText,o.SizeCurrent,o.SizeTotal)):(r?.SetText(""),n?.SetFillAmount(0),i?.SetText(""),a?.SetText(""))}}exports.PreDownloadView=PreDownloadView;
//# sourceMappingURL=PreDownloadView.js.map