
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.DreamLinkScoreItem=void 0;const UE=require("ue"),CustomPromise_1=require("../../../../../Core/Common/CustomPromise"),Log_1=require("../../../../../Core/Common/Log"),Stats_1=require("../../../../../Core/Common/Stats"),ResourceSystem_1=require("../../../../../Core/Resource/ResourceSystem"),MathUtils_1=require("../../../../../Core/Utils/MathUtils"),EventDefine_1=require("../../../../Common/Event/EventDefine"),EventSystem_1=require("../../../../Common/Event/EventSystem"),ConfigManager_1=require("../../../../Manager/ConfigManager"),ModelManager_1=require("../../../../Manager/ModelManager"),LevelSequencePlayer_1=require("../../../Common/LevelSequencePlayer"),BaseScoreItem_1=require("./BaseScoreItem"),DREAM_LINK_SCORE_GROUP_ID=4,SCORE_LEVEL_UP_NIAGARA_PATH="/Game/Aki/Effect/UI/Niagaras/RouGe/NS_Fx_LGUI_RouGeIcon_Brust_Weak.NS_Fx_LGUI_RouGeIcon_Brust_Weak",SCORE_FULL_NIAGARA_PATH="/Game/Aki/Effect/UI/Niagaras/RouGe/NS_Fx_LGUI_RouGeIcon_Brust.NS_Fx_LGUI_RouGeIcon_Brust",MAX_SMOOTH_TIME=200;class DreamLinkScoreItem extends BaseScoreItem_1.BaseScoreItem{constructor(){super(...arguments),this.SPe=void 0,this.Chl=void 0,this.ghl=void 0,this.wIn=void 0,this.phl=void 0,this.edt=void 0,this.xvi=void 0,this.hll=void 0,this.ael=!1,this.hel=0,this._el=0,this.uel=0,this.xte=0,this.cel=0,this.fhl=0,this.yBn=void 0,this.SBn=void 0,this.IBn=void 0,this.TBn=void 0,this.vhl=void 0,this.Mhl=void 0,this.Shl=0,this.oTn=(t,i)=>{if(this.IsValidScore(t)){if(this.IsHideOrHiding&&this.ShowScore(),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"DreamLink评分变化",["scoreId",t],["score",i]),i<this.IBn.LowerUpperLimits[0])this.SBn=void 0;else if(i>=this.TBn.LowerUpperLimits[1])this.SBn=this.TBn;else if(this.SBn=void 0,this.yBn)for(const s of this.yBn)if(i>=s.LowerUpperLimits[0]&&i<s.LowerUpperLimits[1]){this.SBn=s;break}this.SIn(i,this.SBn)}else this.IsShowOrShowing&&this.HideScore()}}OnRegisterComponent(){this.ComponentRegisterInfos=[[0,UE.UISprite],[1,UE.UISprite],[2,UE.UISprite],[3,UE.UISprite],[4,UE.UIItem],[5,UE.UIText],[6,UE.UINiagara]]}async OnCreateAsync(){await this.YIn(SCORE_LEVEL_UP_NIAGARA_PATH,0),await this.YIn(SCORE_FULL_NIAGARA_PATH,1)}OnStart(){super.OnStart(),this.SPe=new LevelSequencePlayer_1.LevelSequencePlayer(this.RootItem),this.wIn=this.GetUiNiagara(6),this.wIn?.SetUIActive(!1),this.phl=[this.GetSprite(2),this.GetSprite(1),this.GetSprite(0)],this.yhl(),this.GetSprite(3)?.SetUIActive(!1),this.xvi=this.GetText(5),this.xvi?.SetText("0%"),this.edt=this.GetItem(4),this.hll=new UE.Rotator(0,0,0),this.yBn=ConfigManager_1.ConfigManager.BattleScoreConfig.GetBattleScoreActionConfigByGroupId(DREAM_LINK_SCORE_GROUP_ID),this.rTn();for(var[t,i]of ModelManager_1.ModelManager.BattleScoreModel.GetScoreMap())0<i&&this.oTn(t,i);EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.BattleScoreChanged,this.oTn)}OnBeforeDestroy(){this.SPe?.Clear(),this.SPe=void 0,EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.BattleScoreChanged,this.oTn),super.OnBeforeDestroy()}async YIn(t,i){const s=new CustomPromise_1.CustomPromise;return ResourceSystem_1.ResourceSystem.LoadAsync(t,UE.NiagaraSystem,t=>{0===i?this.ghl=t:1===i&&(this.Chl=t),s.SetResult()},103),s.Promise}SIn(t,i){Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"DreamLink评分UI更新",["score",t],["level",i?.Level]),this.ael=!!i,this.mel(t),0<this.xte&&(i=Math.floor(t/this.xte*100),this.xvi?.SetText(i+"%"))}OnTick(t){if(DreamLinkScoreItem.Ult.Start(),this.ael&&this.uel!==this._el&&this.GetActive()){this.cel=Math.min(MAX_SMOOTH_TIME,this.cel+t);t=this.cel/MAX_SMOOTH_TIME;if(this.uel=this.hel*(1-t)+this._el*t,0<this.xte){var i=this.uel/this.xte,t=this.fhl;if(this.phl)for(let t=0;t<this.phl.length;t++){var s=this.phl[t];t<this.fhl||this.uel>=this.vhl[t]&&(this.uel<this.vhl[t+1]?(this.fhl=t,s.SetFillAmount(i)):(this.uel===this.vhl[this.Shl]&&(this.fhl=this.Shl),s.SetFillAmount(this.Mhl[t+1])))}t<this.fhl&&(this.fhl<this.Shl?this.wIn?.SetNiagaraSystem(this.ghl):this.wIn?.SetNiagaraSystem(this.Chl),this.wIn?.SetUIActive(!0),this.wIn?.ActivateSystem(!0)),this.hll.Yaw=-360*i,this.edt?.SetUIRelativeRotation(this.hll)}}DreamLinkScoreItem.Ult.Stop()}mel(t){0<t?(this.hel=this.uel,this._el=t,this.cel=0):(this.hel=this.uel,this._el=0,this.cel=MAX_SMOOTH_TIME,this.yhl())}yhl(){if(this.fhl=0,this.phl)for(const t of this.phl)t.SetFillAmount(0)}rTn(){if(this.IBn=void 0,this.TBn=void 0,this.vhl=[],this.Mhl=[],this.yBn&&0!==this.yBn.length){let t=MathUtils_1.MathUtils.Int32Max,i=0;for(const e of this.yBn){var s=e.Level;t>s&&(t=s,this.IBn=e),i<s&&(i=s,this.TBn=e),this.vhl.push(e.LowerUpperLimits[0])}if(this.Shl=this.vhl.length-1,this.xte=this.TBn.LowerUpperLimits[1],0<this.xte)for(const h of this.vhl)this.Mhl.push(h/this.xte);else Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"DreamLink评分最大值不合法",["MaxScore",this.xte])}else Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Battle",67,"DreamLink评分配置缺失")}IsValidScore(t){t=ModelManager_1.ModelManager.BattleScoreModel?.GetScoreConfig(t,!0);return!(!t||5!==t.Type)}ShowScore(){super.ShowScore(),this.Show()}HideScore(){super.HideScore(),this.Hide()}}(exports.DreamLinkScoreItem=DreamLinkScoreItem).Ult=Stats_1.Stat.Create("[BattleView]DreamLinkScoreItemTick");
//# sourceMappingURL=DreamLinkScoreItem.js.map