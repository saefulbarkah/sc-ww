
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MissionPanelChildStep=void 0;const ue_1=require("ue"),CustomPromise_1=require("../../../../../Core/Common/CustomPromise"),Protocol_1=require("../../../../../Core/Define/Net/Protocol"),IQuest_1=require("../../../../../UniverseEditor/Interface/IQuest"),EventDefine_1=require("../../../../Common/Event/EventDefine"),EventSystem_1=require("../../../../Common/Event/EventSystem"),LevelGeneralContextDefine_1=require("../../../../LevelGamePlay/LevelGeneralContextDefine"),ConfigManager_1=require("../../../../Manager/ConfigManager"),ControllerHolder_1=require("../../../../Manager/ControllerHolder"),ModelManager_1=require("../../../../Manager/ModelManager"),LevelSequencePlayer_1=require("../../../Common/LevelSequencePlayer"),StepWithStatusItem_1=require("./TreeStep/StepWithStatusItem"),UNLOCK_ANIM="Unlock";class MissionPanelChildStep extends StepWithStatusItem_1.StepWithStatusItem{constructor(){super(),this.Oct=void 0,this.kct=void 0,this.Fct=void 0,this.Tj_=void 0,this.LevelSequencePlayer=void 0,this.HF_=void 0,this.$F_=void 0,this.bj_=void 0,this.Lj_=void 0,this.Vct=void 0,this.Hct=void 0,this.jct=IQuest_1.EQuestScheduleType.None,this.kr_=!0,this.wj_=!1,this.Eh_=!1,this.m1_=0,this.yct=t=>{switch(t){case"Success":this.DescribeTextComp?.SetColor(this.Vct);break;case"Fail":this.DescribeTextComp?.SetColor(this.Hct);break;case"Start":this.HF_?.IsPending()&&this.HF_.SetResult(!0);break;case"Close":this.$F_?.IsPending()&&this.$F_.SetResult(!0);break;case UNLOCK_ANIM:this.bj_?.IsPending()&&this.bj_.SetResult(!0)}},this.nJa=t=>{t===UNLOCK_ANIM&&(this.m1_===MissionPanelChildStep.C1_&&this.Lj_?.IsPending()&&this.Lj_.SetResult(!0),MissionPanelChildStep.C1_++)},this.Oct=ue_1.Color.FromHex("ECE5D8FF"),this.kct=ue_1.Color.FromHex("ADADADFF"),this.Fct=ue_1.Color.FromHex("C9F797FF")}OnRegisterComponent(){super.OnRegisterComponent(),this.ComponentRegisterInfos.push([5,ue_1.UIItem]),this.ComponentRegisterInfos.push([6,ue_1.UISprite])}OnStart(){super.OnStart(),this.LevelSequencePlayer=new LevelSequencePlayer_1.LevelSequencePlayer(this.RootItem),this.LevelSequencePlayer.BindSequenceCloseEvent(this.yct),this.RootActor.OnSequencePlayEvent.Bind(this.nJa),this.GetItem(5)?.SetUIActive(!1),this.GetSprite(6)?.SetUIActive(!1),this.Tj_=this.RootActor.GetComponentByClass(ue_1.UISizeControlByOther.StaticClass()),this.Q5_()}OnBeforeDestroy(){EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnActivitySequenceEmitEvent,this.nJa)}OnAfterShow(){this.LevelSequencePlayer?.ResumeSequence()}OnAfterHide(){this.LevelSequencePlayer?.PauseSequence()}async StartShow(t){await this.ShowAsync(),this.LevelSequencePlayer?.PlayLevelSequenceByName("Start");var i=this.CheckVisible();this.HF_=new CustomPromise_1.CustomPromise,!t&&i||this.LevelSequencePlayer.EndSequenceLastFrame("Start"),await this.HF_.Promise}async EndShow(t){this.LevelSequencePlayer?.PlayLevelSequenceByName("Close");var i=this.CheckVisible();this.$F_=new CustomPromise_1.CustomPromise,!t&&i||this.LevelSequencePlayer.EndSequenceLastFrame("Close"),await this.$F_.Promise,await this.Refresh(void 0,void 0),await this.HideAsync()}async OnReset(){this.LevelSequencePlayer?.StopCurrentSequence(!0,!0),await this.HideAsync(),this.GetItem(5)?.SetUIActive(!1),await super.OnReset()}UpdateStepInfo(){this.Wct(),this.Ih_(),super.UpdateStepInfo(),this.Q5_()}Q5_(){this.GetItem(5)?.SetUIActive(this.IsDescribeTextVisible),this.Tj_?.SetControlHeight(this.IsDescribeTextVisible),this.IsDescribeTextVisible||this.RootItem?.SetHeight(0)}Ih_(){var t;this.wj_||(t=this.CheckMeetPreCondition(),this.kr_!==t&&(t?this.PlayUnlockAnim():(this.kr_=!1,this.DescribeTextComp.SetColor(this.kct),this.GetSprite(6)?.SetAlpha(1),this.GetSprite(6)?.SetUIActive(!0),0===this.Config?.ShowSource&&(this.Config.UsePreStateText=!0))))}async PlayUnlockAnim(){this.LevelSequencePlayer&&(this.wj_=!0,this.m1_=MissionPanelChildStep.C1_,EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnActivitySequenceEmitEvent,this.nJa),this.LevelSequencePlayer.StopCurrentSequence(!0,!0),this.LevelSequencePlayer.PlayLevelSequenceByName(UNLOCK_ANIM),this.Lj_=new CustomPromise_1.CustomPromise,await this.Lj_.Promise,this.Eh_=!0,this.DescribeTextComp?.SetColor(this.Oct),0===this.Config?.ShowSource&&(this.Config.UsePreStateText=!1),this.bj_=new CustomPromise_1.CustomPromise,await this.bj_.Promise,EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnActivitySequenceEmitEvent,this.nJa),this.Eh_=!1,this.wj_=!1,this.kr_=!0,this.GetSprite(6)?.SetUIActive(!1))}CheckCanShowStatusRoot(){return this.kr_?super.CheckCanShowStatusRoot():this.Eh_}CheckCanUpdateStatusNode(){return this.kr_}CheckMeetPreCondition(){if(0===this.Config?.ShowSource){var t=ModelManager_1.ModelManager.GeneralLogicTreeModel.GetBehaviorTree(this.ShowData?.Id);if(t&&t.BtType!==Protocol_1.Aki.Protocol.hps.Proto_BtTypeQuest){var i=this.Config.QuestScheduleType;if(i.Type===IQuest_1.EQuestScheduleType.ChildQuestCompleted){i=i?.TitlePreState;if(i)return t=LevelGeneralContextDefine_1.GeneralLogicTreeContext.Create(t.BtType,t.TreeIncId,t.TreeConfigId,void 0,void 0),ControllerHolder_1.ControllerHolder.LevelGeneralController.CheckConditionNew(i.SwitchConditions,void 0,t)}}}return!0}Wct(){var i=this.Config.QuestScheduleType;if(this.jct!==i.Type)switch(this.jct=i.Type,i.Type){case IQuest_1.EQuestScheduleType.ChildQuestCompleted:case"FishingEntrust":this.Vct=this.Fct,this.Hct=this.kct;var e=ConfigManager_1.ConfigManager.UiResourceConfig.GetResourcePath("SP_MissionState"),s=ConfigManager_1.ConfigManager.UiResourceConfig.GetResourcePath("SP_MissionComplete"),h=ConfigManager_1.ConfigManager.UiResourceConfig.GetResourcePath("SP_MissionLose");this.SetSpriteByPath(e,this.StepStatusNode,!0),this.SetSpriteByPath(s,this.StepSuccess,!0),this.SetSpriteByPath(h,this.StepLose,!0);break;case IQuest_1.EQuestScheduleType.Condition:case IQuest_1.EQuestScheduleType.TimeLeft:{let t=void 0;t=(i.Type,IQuest_1.EQuestScheduleType.Condition,i),this.Vct=this.Oct,this.Hct=this.kct;e=1===t.IconType?"SP_DailyTowerStarBg":"SP_ComStateOffline",s=ConfigManager_1.ConfigManager.UiResourceConfig.GetResourcePath(e),h=(this.SetSpriteByPath(s,this.StepStatusNode,!0),1===t.IconType?"SP_DailyTowerStar":"SP_ComStateOnline"),e=ConfigManager_1.ConfigManager.UiResourceConfig.GetResourcePath(h);this.SetSpriteByPath(e,this.StepSuccess,!0),this.SetSpriteByPath(s,this.StepLose,!0);break}}}OnStatusChanged(t){switch(t){case 0:this.DescribeTextComp.SetColor(this.Oct);break;case 1:this.LevelSequencePlayer.StopCurrentSequence(!0,!0),this.LevelSequencePlayer.PlayLevelSequenceByName("Success");break;case 2:this.LevelSequencePlayer.StopCurrentSequence(!0,!0),this.LevelSequencePlayer.PlayLevelSequenceByName("Fail")}}async OnConfigRefresh(t,i){await super.OnConfigRefresh(t,i),this.kr_=!0,this.Eh_=!1,this.LevelSequencePlayer?.StopCurrentSequence(!0,!0)}}(exports.MissionPanelChildStep=MissionPanelChildStep).C1_=0;
//# sourceMappingURL=MissionPanelChildStep.js.map