
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuffItemContainer=void 0;const Log_1=require("../../../../Core/Common/Log"),Time_1=require("../../../../Core/Common/Time"),ConfigCommon_1=require("../../../../Core/Config/ConfigCommon"),ControllerHolder_1=require("../../../Manager/ControllerHolder"),ModelManager_1=require("../../../Manager/ModelManager"),BuffItemInfo_1=require("../BuffItemInfo"),BuffItem_1=require("./BuffItem"),MAX_ITEM_COUNT=6,TICK_INTERVAL_FRAME_AT_MORE=2;class BuffItemContainer{constructor(){this.dkn=[],this.Ckn=new Map,this.gkn=new Map,this.fkn=[],this._nt=[],this.unt=[],this.pkn=void 0,this.aa=0,this.oWl=!1,this.m1t=void 0,this.vkn=void 0,this.SGl=0}Init(t,i=MAX_ITEM_COUNT,e=!1){this.pkn=t,this.aa=i,this.oWl=e}Tick(i){var t=Time_1.Time.Frame;if(!(t<this.SGl)){this.dkn.length>MAX_ITEM_COUNT&&(this.SGl=t+TICK_INTERVAL_FRAME_AT_MORE);for(const h of this.dkn){var e=h.BuffItem;if(!e)break;e.Tick(i)}for(let t=this._nt.length-1;0<=t;t--){var s=this._nt[t];s.TickHiding(i)||(this._nt.splice(t,1),s.GetRootItem().SetHierarchyIndex(this.dkn.length+this._nt.length),this.unt.push(s))}}}RefreshBuff(t){this.ClearAll(),t?.IsInit?(this.m1t=t.Entity.GetComponent(163),this.vkn=t.Entity.GetComponent(179),t=t.Entity.GetComponent(19),this.Fah(t),(t=ControllerHolder_1.ControllerHolder.FormationDataController.GetPlayerEntity(ModelManager_1.ModelManager.CreatureModel.GetPlayerId())?.GetComponent(214))&&this.Fah(t)):(this.m1t=void 0,this.vkn=void 0)}Fah(t){for(const e of t.GetAllCurrentCueRef()){var i=e.CueConfig;2!==i.CueType&&14!==i.CueType||this.AddBuffByCue(i,e.ActiveHandleId)}}AddBuffByCue(i,e,s=!1){var t,h=i.CueType;if(2===h)this.nWl(i)&&!this.Ckn.has(e)&&(f=this.Skn(e))&&((t=this.Mkn(i)).SingleBuff=f,this.Ckn.set(e,t),this.Ekn(t,s));else if(14===h&&this.nWl(i)){var f=(0,ConfigCommon_1.toBigIntTemp)(i.Id);let t=this.gkn.get(f);if(t)return t.BuffHandleSet.has(e)?void 0:void t.BuffHandleSet.add(e);(t=this.Mkn(i)).BuffHandleSet.add(e),this.gkn.set(f,t),this.Ekn(t,s)}}nWl(t){return!(this.oWl&&4<t.Parameters.length&&"1"===t.Parameters[4])}RemoveBuffByCue(t,i,e=!1){var s,h=t.CueType;2===h?(s=this.Ckn.get(i))&&(this.Ckn.delete(i),this.ykn(s,e)):14===h&&(s=(0,ConfigCommon_1.toBigIntTemp)(t.Id),h=this.gkn.get(s))&&h.BuffHandleSet.has(i)&&(h.BuffHandleSet.delete(i),h.BuffHandleSet.size<=0)&&(this.gkn.delete(s),this.ykn(h,e))}Mkn(t){let i=void 0;return(i=0<this.fkn.length?this.fkn.pop():new BuffItemInfo_1.BuffItemInfo).SortId=BuffItemInfo_1.BuffItemInfo.GenSortId(),i.Priority=t.Priority,i.BuffCueConfig=t,i}Ikn(t){t.Clear(),this.fkn.push(t)}Ekn(t,i=!1){var e=this.Tkn(t);e<this.aa&&(this.dkn.length>this.aa&&this.DeactivateBuffItem(this.dkn[this.aa],!1),t.BuffItem=this.cst(),this.mst(t,e,i))}Tkn(i){var e=this.dkn.length;for(let t=0;t<e;t++){var s=this.dkn[t];if(0<=BuffItemInfo_1.BuffItemInfo.Compare(s,i))return this.dkn.splice(t,0,i),t}return this.dkn.push(i),e}ykn(t,i=!1){var e=this.dkn.indexOf(t);e<0||(this.dkn.splice(e,1),e<this.aa&&(this.DeactivateBuffItem(t,i),this.dkn.length>=this.aa)&&((e=this.dkn[this.aa-1]).BuffItem&&Log_1.Log.CheckError()&&Log_1.Log.Error("Battle",17,"有残留的buffItem引用",["cueId",e.BuffCueConfig?.Id]),e.BuffItem=this.cst(),this.mst(e,this.aa-1,!1)),this.Ikn(t))}Skn(t){let i=this.m1t.GetBuffByHandle(t);return i=i||this.vkn?.GetFormationBuffComp()?.GetBuffByHandle(t)}cst(){return 0<this.unt.length?this.unt.pop():new BuffItem_1.BuffItem(this.pkn)}mst(t,i,e=!1){var s=t.BuffItem;s.Activate(t.BuffCueConfig,t.SingleBuff,e),i<=0?s.GetRootItem().SetHierarchyIndex(0):(t=this.dkn[i-1].BuffItem)?s.GetRootItem().SetHierarchyIndex(t.GetRootItem().GetHierarchyIndex()+1):Log_1.Log.CheckError()&&Log_1.Log.Error("Battle",17,"要插入的buff图标前面的buff没有buffItem")}DeactivateBuffItem(t,i=!1){var e=t.BuffItem;e&&(t.BuffItem=void 0,(i?(e.DeactivateWithCloseAnim(),this._nt):(e.Deactivate(),e.GetRootItem().SetHierarchyIndex(this.dkn.length+this._nt.length),this.unt)).push(e))}ClearAll(){for(const t of this.dkn)t.BuffItem?.DestroyCompatible();this.dkn.length=0,this.Ckn.clear(),this.gkn.clear(),this.fkn.length=0;for(const i of this._nt)i.Deactivate(),i.DestroyCompatible();this._nt.length=0;for(const e of this.unt)e.DestroyCompatible();this.unt.length=0,this.SGl=0}}exports.BuffItemContainer=BuffItemContainer;
//# sourceMappingURL=BuffItemContainer.js.map