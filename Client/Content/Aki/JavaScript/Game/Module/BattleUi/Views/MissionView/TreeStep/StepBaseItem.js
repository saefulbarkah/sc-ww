
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.StepBaseItem=void 0;const ue_1=require("ue"),Protocol_1=require("../../../../../../Core/Define/Net/Protocol"),StringUtils_1=require("../../../../../../Core/Utils/StringUtils"),ConfigManager_1=require("../../../../../Manager/ConfigManager"),ModelManager_1=require("../../../../../Manager/ModelManager"),UiPanelBase_1=require("../../../../../Ui/Base/UiPanelBase"),GeneralLogicTreeController_1=require("../../../../GeneralLogicTree/GeneralLogicTreeController"),MapUtil_1=require("../../../../Map/MapUtil"),QuestUtil_1=require("../../../../QuestNew/QuestUtil"),LguiUtil_1=require("../../../../Util/LguiUtil"),MissionViewStepTextUtil_1=require("../MissionViewStepTextUtil"),StepMotionArtTextController_1=require("./StepMotionArtTextController");class StepBaseItem extends UiPanelBase_1.UiPanelBase{constructor(){super(...arguments),this.K5_=new Map,this.DescribeTextComp=void 0,this.DistanceTextComp=void 0,this.StepReferenceSource=0,this.ShowData=void 0,this.Config=void 0,this.DescribeTextVisible=!1,this.DistanceTextVisible=!1,this.Qmt=()=>{var i;return!this.K5_.get(0)?.Enable&&!(!this.ShowData||!this.Config||(i=MissionViewStepTextUtil_1.MissionViewStepTextUtil.GetStepTextByConfig(this.ShowData.Id,this.Config),StringUtils_1.StringUtils.IsBlank(i))||(this.DescribeTextComp.SetText(i),0))},this.UpdateDistanceText=()=>{if(!this.ShowData||!this.Config||0!==this.ShowData.DataSource||0!==this.Config.ShowSource)return!1;var t=this.ShowData.Id;if(!GeneralLogicTreeController_1.GeneralLogicTreeController.IsShowTrackDistance(t,this.Config))return!1;t=ModelManager_1.ModelManager.GeneralLogicTreeModel.GetBehaviorTree(t);if(!t)return!1;if(t.IsInTrackRange())return!1;var e=GeneralLogicTreeController_1.GeneralLogicTreeController.GetTitleTrackNodeId(this.Config),r=t.GetNodeDungeonId(),s=ModelManager_1.ModelManager.CreatureModel.GetInstanceId();if(MapUtil_1.MapUtil.IsDungeonDiffWorld(s,r)){if(t.BtType!==Protocol_1.Aki.Protocol.hps.Proto_BtTypeQuest)return!1;s=t.GetTrackAreaInfo(e);if(!s)return!1;r=ConfigManager_1.ConfigManager.AreaConfig.GetLevelOneAreaId(s),r=0!==r?r:s,s=ConfigManager_1.ConfigManager.AreaConfig.GetAreaInfo(r);if(!s)return!1;let i=ConfigManager_1.ConfigManager.AreaConfig.GetAreaLocalName(s.Title);return StringUtils_1.StringUtils.IsBlank(i)&&(i=s.Title),LguiUtil_1.LguiUtil.SetLocalTextNew(this.DistanceTextComp,"CrossMapMissionTips",i),!0}r=t.GetNodeTrackPosition(e);return!!r&&QuestUtil_1.QuestUtil.SetTrackDistanceText(this.DistanceTextComp,r)}}get IsDescribeTextVisible(){var i=this.K5_.get(0);return i?.Enable?i.CheckTextVisible():this.DescribeTextVisible}OnRegisterComponent(){this.ComponentRegisterInfos=[[0,ue_1.UIText],[1,ue_1.UIText]]}async OnBeforeStartAsync(){var i;await super.OnBeforeStartAsync(),this.StepReferenceSource=this.OpenParam,this.DescribeTextComp=this.GetText(0),this.DescribeTextComp.OnSelfLanguageChange.Bind(this.Qmt),this.DistanceTextComp=this.GetText(1),this.DistanceTextComp.SetUIActive(!0),0===this.StepReferenceSource&&(i=new StepMotionArtTextController_1.StepMotionArtTextController(this.DescribeTextComp.GetParentAsUIItem()),this.K5_.set(0,i))}OnAfterHide(){for(var[,i]of this.K5_)i.Hide()}OnBeforeDestroy(){this.DescribeTextComp?.OnSelfLanguageChange.Unbind(),this.ShowData=void 0,this.Config=void 0,this.DescribeTextComp=void 0,this.DistanceTextComp=void 0}OnTick(i){if(this.IsShowOrShowing)for(var[,t]of this.K5_)t.OnTick(i)}CheckVisible(){return void 0!==this.Config&&void 0!==this.ShowData}UpdateByConfig(){this.ShowData&&(this.Vr_(),this.DescribeTextComp.SetUIActive(this.DescribeTextVisible),this.DistanceTextComp.SetUIActive(this.DistanceTextVisible))}async Refresh(i,t){this.ShowData=i,this.Config!==t&&(this.Config=t,await this.OnConfigRefresh(this.ShowData,this.Config)),this.UpdateByConfig()}Vr_(){var i=this.CheckVisible();this.DescribeTextVisible=i,(this.DistanceTextVisible=i)&&this.UpdateStepInfo()}UpdateStepInfo(){this.DescribeTextVisible=this.Qmt(),this.DistanceTextVisible=this.UpdateDistanceText()}CheckNeedUpdateDescribeText(){return!0}async OnConfigRefresh(i,t){var e,r=[];for([,e]of this.K5_)r.push(e.OnConfigRefresh(i,t));await Promise.all(r)}async OnReset(){await this.Refresh(void 0,void 0)}}exports.StepBaseItem=StepBaseItem;
//# sourceMappingURL=StepBaseItem.js.map