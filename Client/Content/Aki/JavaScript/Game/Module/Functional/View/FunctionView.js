
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.FunctionView=void 0;const UE=require("ue"),Log_1=require("../../../../Core/Common/Log"),BackgroundCardById_1=require("../../../../Core/Define/ConfigQuery/BackgroundCardById"),PlayerExpByPlayerLevel_1=require("../../../../Core/Define/ConfigQuery/PlayerExpByPlayerLevel"),Protocol_1=require("../../../../Core/Define/Net/Protocol"),Platform_1=require("../../../../Launcher/Platform/Platform"),PlatformSdkManagerNew_1=require("../../../../Launcher/Platform/PlatformSdk/PlatformSdkManagerNew"),EventDefine_1=require("../../../Common/Event/EventDefine"),EventSystem_1=require("../../../Common/Event/EventSystem"),CloudGameManager_1=require("../../../Manager/CloudGameManager"),ConfigManager_1=require("../../../Manager/ConfigManager"),ControllerHolder_1=require("../../../Manager/ControllerHolder"),ModelManager_1=require("../../../Manager/ModelManager"),RedDotController_1=require("../../../RedDot/RedDotController"),UiViewBase_1=require("../../../Ui/Base/UiViewBase"),UiManager_1=require("../../../Ui/UiManager"),NoCircleAttachView_1=require("../../AutoAttach/NoCircleAttachView"),CommonInputViewController_1=require("../../Common/InputView/Controller/CommonInputViewController"),ConfirmBoxDefine_1=require("../../ConfirmBox/ConfirmBoxDefine"),LguiUtil_1=require("../../Util/LguiUtil"),WorldLevelController_1=require("../../WorldLevel/WorldLevelController"),FunctionController_1=require("../FunctionController"),FunctionAttachItemGrid_1=require("./FunctionAttachItemGrid"),FunctionBottomButtonItem_1=require("./FunctionBottomButtonItem"),FunctionTabLayout_1=require("./FunctionTabLayout");class FunctionView extends UiViewBase_1.UiViewBase{constructor(){super(...arguments),this.ovt=void 0,this.B7t=void 0,this.G7t=void 0,this.N7t=void 0,this.O7t=void 0,this.k7t=void 0,this.F7t=void 0,this.V7t=void 0,this.H7t=new Map,this.ypt=new Array,this.j7t=void 0,this.W7t=()=>{this.CloseMe()},this.K7t=()=>{ControllerHolder_1.ControllerHolder.ConfirmBoxController.ShowReturnLoginConfirmBox()},this.Q7t=()=>{ControllerHolder_1.ControllerHolder.KuroSdkController.OpenNotice()},this.X7t=()=>{FunctionController_1.FunctionController.OpenFunctionRelateView(10020)},this.$7t=()=>{WorldLevelController_1.WorldLevelController.OpenWorldLevelInfoView()},this.Y7t=()=>{UiManager_1.UiManager.OpenView("TimeOfDaySecondView")},this.J7t=()=>{FunctionController_1.FunctionController.OpenFunctionRelateView(10019)},this.z7t=()=>{ControllerHolder_1.ControllerHolder.GenericPromptController.ShowPromptByCode("CopiedMyUid"),UE.LGUIBPLibrary.ClipBoardCopy(ModelManager_1.ModelManager.PlayerInfoModel.GetId().toString())},this.Z7t=()=>{FunctionController_1.FunctionController.OpenFunctionRelateView(10049)},this.eHt=()=>{ModelManager_1.ModelManager.FunctionModel.IsOpen(10060)&&UiManager_1.UiManager.OpenView("PersonalRootView",ModelManager_1.ModelManager.PersonalModel.GetPersonalInfoData())},this.tHt=()=>{UiManager_1.UiManager.OpenView("PersonalOptionView")},this.iHt=()=>{CommonInputViewController_1.CommonInputViewController.OpenPersonalSignInputView()},this.oHt=()=>{CommonInputViewController_1.CommonInputViewController.OpenSetRoleNameInputView()},this.rHt=()=>{var e;this.ovt.MovingState()||this.ovt.GetCurrentSelectIndex()<=0||(e=this.ovt.GetCurrentSelectIndex()-1,this.ovt.AttachToIndex(e,!1))},this.nHt=()=>{var e;this.ovt.MovingState()||this.ovt.GetCurrentSelectIndex()>=this.ovt.GetDataLength()||(e=this.ovt.GetCurrentSelectIndex()+1,this.ovt.AttachToIndex(e,!1))},this.cWs=()=>{if(ModelManager_1.ModelManager.GameModeModel.IsMulti){let e=void 0;(e=ModelManager_1.ModelManager.OnlineModel.GetIsMyTeam()?new ConfirmBoxDefine_1.ConfirmBoxDataNew(100):new ConfirmBoxDefine_1.ConfirmBoxDataNew(78)).FunctionMap.set(2,()=>{ControllerHolder_1.ControllerHolder.OnlineController.LeaveWorldTeamRequest(ModelManager_1.ModelManager.FunctionModel.PlayerId),this.CloseMe()}),ControllerHolder_1.ControllerHolder.ConfirmBoxController.ShowConfirmBoxNew(e)}},this.sHt=()=>{this.N7t.SetUIActive(!1),this.G7t.SetUIActive(!1)},this.aHt=()=>{this.hHt()},this.$At=()=>{this.r9t()},this.XAt=()=>{var e=ModelManager_1.ModelManager.FunctionModel.GetPlayerName();e&&this.GetText(0).SetText(e)},this.lHt=()=>{this._Ht()},this.uHt=()=>{this.cHt()},this.mHt=()=>{var e,t=ModelManager_1.ModelManager.PersonalModel.GetBirthday(),i=this.GetText(26);0===t?LguiUtil_1.LguiUtil.SetLocalText(i,"BirthDay","--","--"):(e=Math.floor(t/100),t=t%100,LguiUtil_1.LguiUtil.SetLocalText(i,"BirthDay",e,t))},this.dHt=e=>{this.BNe(e),this.B7t.SetToggleSelectByIndex(e)},this.CHt=(e,t,i)=>{e=new FunctionAttachItemGrid_1.FunctionAttachItemGrid(e);return e.SetNeedAnim(0===t),this.H7t.set(t,e),e}}OnRegisterComponent(){this.ComponentRegisterInfos=[[0,UE.UIText],[1,UE.UIText],[2,UE.UIText],[3,UE.UIButtonComponent],[4,UE.UIText],[5,UE.UIText],[6,UE.UIButtonComponent],[7,UE.UIButtonComponent],[8,UE.UIButtonComponent],[9,UE.UISprite],[10,UE.UIItem],[11,UE.UITexture],[12,UE.UIButtonComponent],[13,UE.UIButtonComponent],[14,UE.UIButtonComponent],[15,UE.UIButtonComponent],[16,UE.UIButtonComponent],[17,UE.UIButtonComponent],[18,UE.UIItem],[19,UE.UIItem],[20,UE.UIButtonComponent],[21,UE.UIButtonComponent],[22,UE.UIButtonComponent],[23,UE.UITexture],[24,UE.UIButtonComponent],[25,UE.UIText],[26,UE.UIText],[27,UE.UIButtonComponent],[28,UE.UIItem],[29,UE.UIItem],[30,UE.UIGridLayout],[31,UE.UIItem],[32,UE.UIButtonComponent],[33,UE.UISprite],[34,UE.UIItem],[35,UE.UIItem],[36,UE.UISprite]],this.BtnBindInfo=[[6,this.W7t],[7,this.K7t],[8,this.X7t],[3,this.$7t],[12,this.Y7t],[13,this.J7t],[14,this.z7t],[15,this.Q7t],[20,this.Z7t],[21,this.eHt],[22,this.tHt],[24,this.iHt],[27,this.oHt],[17,this.rHt],[16,this.nHt],[32,this.cWs]]}OnStart(){this.G7t=this.GetButton(17).RootUIComp,this.N7t=this.GetButton(16).RootUIComp,this.O7t=this.GetItem(19),this.k7t=this.GetItem(18),this.B7t=new FunctionTabLayout_1.FunctionTabLayout(this.GetItem(28)),this.ovt=new NoCircleAttachView_1.NoCircleAttachView(this.GetItem(10).GetOwner());var e=this.GetItem(29),e=(e.SetUIActive(!1),this.ovt.CreateItems(e.GetOwner(),0,this.CHt),this.ovt.SetDragBeginCallback(this.sHt),this.ovt.SetMoveMultiFactor(50),this.F7t=new FunctionBottomButtonItem_1.FunctionBottomButtonItem(this.GetButton(8).RootUIComp,"FunctionMail"),this.V7t=new FunctionBottomButtonItem_1.FunctionBottomButtonItem(this.GetButton(15).RootUIComp,"FunctionNotice"),ModelManager_1.ModelManager.FunctionModel.IsOpen(10060)),e=(this.GetButton(21).RootUIComp.SetRaycastTarget(e),this.GetButton(7).RootUIComp.SetUIActive(!CloudGameManager_1.CloudGameManager.IsCloudGame),this.gHt(),this.ovt.GetCurrentSelectIndex());this.BNe(e),this.B7t.SetToggleSelectByIndex(e),Platform_1.Platform.IsPs5Platform()&&(this.GetButton(14)?.SetSelfInteractive(!1),this.GetSprite(36)?.SetUIActive(!1))}OnAddEventListener(){EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.CurWorldLevelChange,this.aHt),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnSignChange,this.$At),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnNameChange,this.XAt),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnHeadIconChange,this.lHt),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnCardChange,this.uHt),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnBirthChange,this.mHt),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.FunctionGridSelected,this.dHt),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnFunctionViewShow)}OnRemoveEventListener(){EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.CurWorldLevelChange,this.aHt),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnSignChange,this.$At),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnNameChange,this.XAt),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnHeadIconChange,this.lHt),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnCardChange,this.uHt),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnBirthChange,this.mHt),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.FunctionGridSelected,this.dHt)}BNe(e){this.G7t.SetUIActive(0<e),this.N7t.SetUIActive(e<this.ovt.GetDataLength()-1),this.O7t.SetUIActive(this.fHt(e)),this.k7t.SetUIActive(this.pHt(e))}fHt(i){var r=[];for(let e=0,t=i;e<t;++e)r.push(...this.ypt[e]);for(const t of r){var e=ModelManager_1.ModelManager.FunctionModel.GetFunctionItemRedDotName(t);if(e){e=ModelManager_1.ModelManager.RedDotModel.GetRedDot(e);if(e&&e.IsRedDotActive())return!0}}return!1}pHt(i){var r=[];for(let e=i+1,t=this.ypt.length;e<t;++e)r.push(...this.ypt[e]);for(const t of r){var e=ModelManager_1.ModelManager.FunctionModel.GetFunctionItemRedDotName(t);if(e){e=ModelManager_1.ModelManager.RedDotModel.GetRedDot(e);if(e&&e.IsRedDotActive())return!0}}return!1}OnBeforeShow(){this.vHt(),this.MHt(),this.K8e(),this.mWs()}OnAfterShow(){this.EHt()}OnAfterHide(){this.Ovt()}OnBeforeDestroy(){for(const e of this.ovt.GetItems())this.AddChild(e);this.B7t.Destroy(),this.F7t.Destroy(),this.V7t.Destroy(),this.ovt?.Clear()}K8e(){this.F7t.BindRedDot(),this.V7t.BindRedDot(),RedDotController_1.RedDotController.BindRedDot("PersonalCard",this.GetItem(34))}Ovt(){this.F7t.UnBindRedDot(),this.V7t.UnBindRedDot(),RedDotController_1.RedDotController.UnBindGivenUi("PersonalCard",this.GetItem(34))}vHt(){this.K7e(),this.SHt(),this.hHt(),this._Ht(),this.cHt(),this.r9t(),this.yHt()}K7e(){var e=ModelManager_1.ModelManager.FunctionModel.GetPlayerName();this.GetText(0).SetText(e)}SHt(){var e,t=ModelManager_1.ModelManager.FunctionModel.GetPlayerLevel(),t=(LguiUtil_1.LguiUtil.SetLocalText(this.GetText(4),"PlayerLevelNum",t),LguiUtil_1.LguiUtil.SetLocalText(this.GetText(1),"UserId",ModelManager_1.ModelManager.FunctionModel.PlayerId),PlayerExpByPlayerLevel_1.configPlayerExpByPlayerLevel.GetConfig(t));t?.PlayerExp&&(e=ModelManager_1.ModelManager.FunctionModel.GetPlayerExp(),LguiUtil_1.LguiUtil.SetLocalText(this.GetText(5),"ExpText",e,t.PlayerExp),this.GetSprite(9).SetFillAmount(e/t.PlayerExp))}hHt(){LguiUtil_1.LguiUtil.SetLocalText(this.GetText(2),"WorldLevelNum",ModelManager_1.ModelManager.WorldLevelModel.CurWorldLevel)}_Ht(){var e=ModelManager_1.ModelManager.PlayerInfoModel.GetNumberPropById(4);const t=this.GetTexture(11);var e=ModelManager_1.ModelManager.PersonalModel.GetPlayerHeadData(e);void 0!==e&&(t.SetUIActive(!1),this.SetTextureShowUntilLoaded(e.GetRoleHeadIconCircle(),t,()=>{t.SetUIActive(!0)}),e=ModelManager_1.ModelManager.PersonalModel.CheckCanShowPersonalTip(),this.GetItem(35).SetUIActive(e))}cHt(){var e=ModelManager_1.ModelManager.PersonalModel.GetCurCardId();e&&(e=BackgroundCardById_1.configBackgroundCardById.GetConfig(e))&&this.SetTextureByPath(e.FunctionViewCardPath,this.GetTexture(23))}r9t(){var e=ModelManager_1.ModelManager.PersonalModel.GetSignature(),t=this.GetText(25);e?t.SetText(e):LguiUtil_1.LguiUtil.SetLocalText(t,"ClickToSetSign")}yHt(){var e,t=ModelManager_1.ModelManager.PersonalModel.GetBirthday(),i=this.GetText(26);0===t?LguiUtil_1.LguiUtil.SetLocalText(i,"BirthDay","--","--"):(e=Math.floor(t/100),t=t%100,LguiUtil_1.LguiUtil.SetLocalText(i,"BirthDay",e,t))}IHt(e){var t=this.GetItem(31),i=t.GetStretchRight();t.SetStretchRight(i+e)}gHt(){this.j7t=this.THt(),this.IHt(this.j7t.OffsetWidth);var e=ModelManager_1.ModelManager.FunctionModel.GetShowFunctionIdList(),t=e.length;this.ypt=[];let i=0;for(;t>i+this.j7t.TotalGridNumber;)this.ypt.push(e.slice(i,i+this.j7t.TotalGridNumber)),i+=this.j7t.TotalGridNumber;this.ypt.push(e.slice(i,t));var r=Math.ceil(t/this.j7t.TotalGridNumber);this.B7t.RefreshTab(r),this.ovt.SetBoundDistance(0),this.ovt.ReloadView(r,this.ypt)}LHt(i){var r=this.ypt;let o=-1;for(let e=0,t=r.length;e<t;++e)r[e].includes(i)&&(o=e);return o}mWs(){var e,t=this.GetButton(32)?.RootUIComp;ModelManager_1.ModelManager.GameModeModel.IsMulti?(t?.SetUIActive(!0),e=ModelManager_1.ModelManager.OnlineModel.GetCurrentTeamListById(ModelManager_1.ModelManager.FunctionModel.PlayerId)?.PingState,this.pOi(e)):t?.SetUIActive(!1)}pOi(e){var t,i=this.GetSprite(33);i.SetUIActive(!0),e===Protocol_1.Aki.Protocol.r7s.Proto_UNKNOWN?(t=ConfigManager_1.ConfigManager.UiResourceConfig?.GetResourcePath("SP_SignalUnknown"),this.SetSpriteByPath(t,i,!1)):e===Protocol_1.Aki.Protocol.r7s.Proto_GREAT?(t=ConfigManager_1.ConfigManager.UiResourceConfig?.GetResourcePath("SP_SignalGreat"),this.SetSpriteByPath(t,i,!1)):e===Protocol_1.Aki.Protocol.r7s.Proto_GOOD?(t=ConfigManager_1.ConfigManager.UiResourceConfig?.GetResourcePath("SP_SignalGood"),this.SetSpriteByPath(t,i,!1)):e===Protocol_1.Aki.Protocol.r7s.Proto_POOR&&(t=ConfigManager_1.ConfigManager.UiResourceConfig?.GetResourcePath("SP_SignalPoor"),this.SetSpriteByPath(t,i,!1))}GetGuideUiItemAndUiItemForShowEx(e){if(1<e.length||isNaN(Number(e[0])))Log_1.Log.CheckError()&&Log_1.Log.Error("Guide",16,"功能菜单聚焦引导的ExtraParam配置错误",["configParams",e]);else{var e=Number(e[0]),t=this.LHt(e);if(-1===t)Log_1.Log.CheckError()&&Log_1.Log.Error("Guide",16,"功能菜单聚焦引导的ExtraParam配置错误, 检查functionId",["functionId",e]);else{this.ovt.AttachToIndex(t,!0);t=this.H7t.get(t);if(t){t=t.GetFunctionItem(e);if(t.GetActive()){t=t.GetButtonItem();if(t)return[t,t]}}else Log_1.Log.CheckError()&&Log_1.Log.Error("Guide",16,"功能菜单聚焦引导的ExtraParam配置错误, 检查functionId",["functionId",e])}}}MHt(){this.GetButton(8).SetSelfInteractive(ModelManager_1.ModelManager.FunctionModel.IsOpen(10020)),this.GetButton(12).SetSelfInteractive(ModelManager_1.ModelManager.FunctionModel.IsOpen(10018)),this.GetButton(13).SetSelfInteractive(ModelManager_1.ModelManager.FunctionModel.IsOpen(10019)),this.GetButton(15).SetSelfInteractive(ControllerHolder_1.ControllerHolder.KuroSdkController.CanUseSdk()||PlatformSdkManagerNew_1.PlatformSdkManagerNew.IsSdkOn),this.GetButton(20).SetSelfInteractive(ModelManager_1.ModelManager.FunctionModel.IsOpen(10049))}EHt(){Log_1.Log.CheckInfo()&&Log_1.Log.Info("Functional",10,"功能开启界面Start阶段计算数据输出",["剩余宽度",this.j7t.OffsetWidth],["显示数量",this.j7t.TotalGridNumber]);var e=this.THt();Log_1.Log.CheckInfo()&&Log_1.Log.Info("Functional",10,"功能开启界面AfterShow阶段计算数据输出",["剩余宽度",e.OffsetWidth],["显示数量",e.TotalGridNumber])}THt(){var e=this.GetItem(29),t=this.GetGridLayout(30),i=t.GetCellSize(),r=t.GetSpacing(),t=t.GetPadding(),o=e.GetWidth(),e=e.GetHeight(),n=(o-t.Left-t.Right)%(i.X+r.X),s=n>=i.X?1:0,o=Math.floor((o-t.Left-t.Right)/(i.X+r.X))+s,s=(e-t.Top-t.Bottom)%(i.Y+r.Y)>i.Y?1:0;return{TotalGridNumber:o*(Math.floor((e-t.Top-t.Bottom)/(i.Y+r.Y))+s),OffsetWidth:n>=i.X?n-i.X:n+r.X}}}exports.FunctionView=FunctionView;
//# sourceMappingURL=FunctionView.js.map