
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CommonActivityView=void 0;const UE=require("ue"),CustomPromise_1=require("../../../../Core/Common/CustomPromise"),Macro_1=require("../../../../Core/Preprocessor/Macro"),EventDefine_1=require("../../../Common/Event/EventDefine"),EventSystem_1=require("../../../Common/Event/EventSystem"),GameSettingsDeviceRender_1=require("../../../GameSettings/GameSettingsDeviceRender"),GlobalData_1=require("../../../GlobalData"),ControllerHolder_1=require("../../../Manager/ControllerHolder"),ModelManager_1=require("../../../Manager/ModelManager"),UiViewBase_1=require("../../../Ui/Base/UiViewBase"),PopupCaptionItem_1=require("../../../Ui/Common/PopupCaptionItem"),LevelSequencePlayer_1=require("../../Common/LevelSequencePlayer"),ConfirmBoxDefine_1=require("../../ConfirmBox/ConfirmBoxDefine"),HelpController_1=require("../../Help/HelpController"),GenericScrollViewNew_1=require("../../Util/ScrollView/GenericScrollViewNew"),ActivityCommonDefine_1=require("../ActivityCommonDefine"),ActivityManager_1=require("../ActivityManager"),ActivityPageSelectContent_1=require("./SubView/ActivityPageSelectContent"),ActivitySwitchToggle_1=require("./SubView/ActivitySwitchToggle"),ActivityTipsButton_1=require("./SubView/ActivityTipsButton");class CommonActivityView extends UiViewBase_1.UiViewBase{constructor(){super(...arguments),this.e5e=!0,this.lqe=void 0,this.t5e=0,this.bel=void 0,this.i5e=void 0,this.o5e=void 0,this.r5e=void 0,this.n5e=void 0,this.qel=new Map([[0,0],[1,0]]),this.s5e=void 0,this.a5e=new Map,this.SPe=void 0,this.h5e=[],this.PRn=[],this._5e=()=>{this.u5e(!0)},this.XOe=()=>{HelpController_1.HelpController.OpenHelpById(this.t5e)},this.$Oe=()=>{this.CloseMe()},this.c5e=(t,e)=>{e&&this.m5e(t)},this.d5e=(t,e)=>this.n5e!==t,this.C5e=()=>{var t=new ActivityPageSelectContent_1.ActivityPageSelectContent;return t.BindCanToggleExecuteChange(this.A5e),t.BindToggleClick(this.Bke),t},this.A5e=(t,e)=>!0,this.Bke=(t,e)=>{e&&this.Gel(t,!0)},this.CLn=t=>{t.length<=0||(this.lqe.SetCurrencyItemVisible(!0),this.lqe.SetCurrencyItemList(t).catch(()=>{}))},this.cMl=t=>{this.UiBlurBehaviour?.ChangeNeedBlurState(t)},this.p5e=t=>{t&&(t=ModelManager_1.ModelManager.ActivityModel.GetActivityById(t))&&t.CheckIfInShowTime()&&(this.qel.set(t.TimeType,t.Id),t.TimeType!==this.n5e?this.Oel(t.TimeType,!0):this.v5e(this.n5e,!0))},this.M5e=t=>{this.k4e===t&&this.s5e?.RefreshView()},this.OnActivityUpdate=()=>{var t=()=>{EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.ResetToBattleView)},e=new ConfirmBoxDefine_1.ConfirmBoxDataNew(115);e.FunctionMap.set(1,t),e.FunctionMap.set(0,t),ControllerHolder_1.ControllerHolder.ConfirmBoxController.ShowConfirmBoxNew(e)},this.E5e=t=>{this.s5e?.PlaySubViewSequence(t)},this.u5e=(t,e=0,i)=>{this.PRn=ActivityCommonDefine_1.activityViewStateSequence[e],t!==this.e5e&&(this.e5e=t,this.UiViewSequence.PlaySequence(t?this.PRn[0]:this.PRn[1],i),this.s5e?.OnCommonViewStateChange(t)),this.RefreshTabIcon()}}get k4e(){return this.qel.get(this.n5e??0)}OnRegisterComponent(){this.ComponentRegisterInfos=[[0,UE.UIItem],[1,UE.UIScrollViewWithScrollbarComponent],[2,UE.UIItem],[3,UE.UIItem],[4,UE.UIItem],[5,UE.UIItem],[6,UE.UIItem],[7,UE.UITexture],[7,UE.UITexture],[8,UE.UIButtonComponent],[9,UE.UIItem],[10,UE.UIItem],[11,UE.UIItem],[12,UE.UIItem],[13,UE.UIText]],this.BtnBindInfo=[[8,this._5e]]}OnAddEventListener(){this.S5e(),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.ActivityViewChange,this.p5e),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.ActivityViewRefreshCurrent,this.M5e),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnActivityClose,this.OnActivityUpdate),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnActivityOpen,this.OnActivityUpdate),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.PlaySequenceEventByStringParam,this.E5e),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.SetActivityViewState,this.u5e),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.SetActivityViewCurrency,this.CLn),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.ChangeActivityViewNeedBlurState,this.cMl)}OnRemoveEventListener(){this.y5e(),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.ActivityViewChange,this.p5e),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.ActivityViewRefreshCurrent,this.M5e),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnActivityClose,this.OnActivityUpdate),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnActivityOpen,this.OnActivityUpdate),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.PlaySequenceEventByStringParam,this.E5e),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.SetActivityViewState,this.u5e),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.SetActivityViewCurrency,this.CLn),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.ChangeActivityViewNeedBlurState,this.cMl)}async OnBeforeStartAsync(){this.I5e(),await this.T5e()}I5e(){var t=this.GetScrollViewWithScrollbar(1);this.i5e=new GenericScrollViewNew_1.GenericScrollViewNew(t,this.C5e)}async T5e(){var t=[];this.lqe=new PopupCaptionItem_1.PopupCaptionItem(this.GetItem(0)),this.lqe.SetHelpCallBack(this.XOe),this.lqe.SetCloseCallBack(this.$Oe),this.SPe=new LevelSequencePlayer_1.LevelSequencePlayer(this.RootItem),this.o5e=new ActivitySwitchToggle_1.ActivitySwitchToggle(0),t.push(this.o5e.CreateByActorAsync(this.GetItem(3).GetOwner())),this.AddChild(this.o5e),this.o5e.BindOnToggleFunction(this.c5e),this.o5e.BindOnCanToggleExecuteChange(this.d5e),this.r5e=new ActivitySwitchToggle_1.ActivitySwitchToggle(1),t.push(this.r5e.CreateByActorAsync(this.GetItem(4).GetOwner())),this.AddChild(this.r5e),this.r5e.BindOnToggleFunction(this.c5e),this.r5e.BindOnCanToggleExecuteChange(this.d5e),this.bel=new ActivityTipsButton_1.ActivityTipsButton,t.push(this.bel.CreateByActorAsync(this.GetItem(10).GetOwner())),await Promise.all(t)}OnStart(){var[t,e]=this.OpenParam??[4,0],t=(ModelManager_1.ModelManager.ActivityModel.SendActivityViewOpenLogData(t),this.PRn=ActivityCommonDefine_1.activityViewStateSequence[0],this.lqe.SetTitleLocalText("Activity_Title"),this.uxt(),ModelManager_1.ModelManager.ActivityModel.GetCurrentShowingActivities());let i=void 0;var s=[],h=[],n=[],r=[];for(const a of t)a.Id===e&&(i=a),(0===a.TimeType?(h.push(a.Id),s):(r.push(a.Id),n)).push(a);var[t,o]=[0<s.length,0<n.length];i=i||(t?s:n)[0],this.GetItem(9).SetUIActive(t&&o),this.o5e.BindRedDotIds(h),this.r5e.BindRedDotIds(r),this.h5e=0===i.TimeType?s:n,this.qel.set(i.TimeType,i.Id),this.Oel(i.TimeType,!1),this.m5e(i.TimeType,!1)}OnBeforeShow(){for(const t of this.h5e)if(!t.CheckIfInShowTime())return void ControllerHolder_1.ControllerHolder.ActivityController.RequestActivityData().finally(()=>{this.OnActivityUpdate()});this.s5e?.RefreshView(),GameSettingsDeviceRender_1.GameSettingsDeviceRender.TemporaryDisableDLSSG("CommonActivityView")}async OnBeforeHideAsync(){await this.s5e?.BeforeHideSelfAsync(),GameSettingsDeviceRender_1.GameSettingsDeviceRender.CancelTemporaryDisableDLSSG("CommonActivityView")}OnBeforeDestroy(){this.a5e.forEach((t,e)=>{this.AddChild(t)}),this.a5e.clear()}m5e(t,e=!0){(0===(this.n5e=t)?this.r5e:this.o5e).SetToggleState(!1,!1),this.GetItem(11).SetUIActive(!1),this.GetItem(12).SetUIActive(!1),this.v5e(t,!1).finally(()=>{this.SPe.PlayLevelSequenceByName(e?"SwitchModel":"SwitchList",!0),this.GetItem(11).SetUIActive(!0),this.GetItem(12).SetUIActive(!0)})}Oel(t,e){(0===t?this.o5e:this.r5e).SetToggleState(!0,e)}async Gel(t,e){t.Id!==this.k4e&&this.i5e.GetScrollItemByKey(this.k4e)?.SetToggleState(!1,!1),this.qel.set(this.n5e,t.Id),t.NeedSelfControlFirstRedPoint()||ControllerHolder_1.ControllerHolder.ActivityController.RequestReadActivity(t),await this.f5e(e)}S5e(){}y5e(){}async v5e(e,t){var i=ModelManager_1.ModelManager.ActivityModel.GetCurrentShowingActivities();this.h5e=i.filter(t=>t.TimeType===e),await this.i5e.RefreshByDataAsync(this.h5e);let s=0;for(let t=0;t<this.h5e.length;t++)if(this.k4e===this.h5e[t].Id){s=t;break}i=this.i5e.GetScrollItemByIndex(s);i&&(this.i5e.LateScrollTo(i.GetRootItem()),i.SetToggleState(!0,!1),await this.Gel(this.h5e[s],t))}async f5e(t){var e=ModelManager_1.ModelManager.ActivityModel.GetActivityById(this.k4e);this.D5e(e),await this.R5e(e,t)}D5e(t){var e=t.GetTitle();this.t5e=t.GetHelpId(),this.lqe.SetHelpBtnActive(0!==this.t5e),this.lqe.SetTitle(e.replace(/<.*?>/g,"")),this.bel.SetActive(t.LocalConfig.ShowPermanentTips),this.RefreshTabIcon()}async WNe(t){const e=new CustomPromise_1.CustomPromise;var i=this.GetTexture(7),t=(i.SetUIActive(!1),t.BgTexturePath);this.SetTextureByPath(t,i,void 0,()=>{e.SetResult()}),await e.Promise}async R5e(t,e){let i=this.a5e.get(t);if(!i){var s=ActivityManager_1.ActivityManager.GetActivityController(t.Type),h=this.GetItem(5),n=s.GetActivityResource(t);if(!(i=s.CreateSubPageComponent(t)))return;i.SetData(t),await i.CreateByPathAsync(n,h),this.a5e.set(t,i)}this.k4e===t.Id&&(await this.WNe(t),this.s5e?.SetActive(!1),this.lqe.SetCurrencyItemVisible(!1),this.s5e=i,await this.s5e.BeforeShowSelfAsync(),this.s5e.RefreshView(),this.GetTexture(7).SetUIActive(!0),this.s5e.SetActive(!0),e&&(this.UiViewSequence.HasSequenceNameInPlaying("Switch")?this.UiViewSequence.ReplaySequence("Switch"):this.UiViewSequence.PlaySequence("Switch")),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnSelectActivityAndSubViewReady,this.k4e))}RefreshTabIcon(){var t=ModelManager_1.ModelManager.ActivityModel.GetActivityById(this.k4e).LocalConfig,t=this.e5e?t.TabResource:t.TabResource2;t&&this.lqe.SetTitleIcon(t)}uxt(){var t=this.GetText(13);GlobalData_1.GlobalData.IsPlayInEditor?t.SetUIActive(!0):t.SetUIActive(!1)}W6l(t){this.GetText(13).SetText("DebugId: "+t)}GetGuideUiItemAndUiItemForShowEx(t){if(void 0!==this.s5e)return this.s5e.GetGuideUiItemAndUiItemForShowEx(t)}}exports.CommonActivityView=CommonActivityView;
//# sourceMappingURL=CommonActivityView.js.map