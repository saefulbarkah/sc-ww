
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BabelTowerLevelInfoView=void 0;const UE=require("ue"),EventDefine_1=require("../../../../Common/Event/EventDefine"),EventSystem_1=require("../../../../Common/Event/EventSystem"),ConfigManager_1=require("../../../../Manager/ConfigManager"),ControllerHolder_1=require("../../../../Manager/ControllerHolder"),ModelManager_1=require("../../../../Manager/ModelManager"),UiViewBase_1=require("../../../../Ui/Base/UiViewBase"),PopupCaptionItem_1=require("../../../../Ui/Common/PopupCaptionItem"),UiManager_1=require("../../../../Ui/UiManager"),LoginDefine_1=require("../../../Login/Data/LoginDefine"),MultiTeamRoleSelectView_1=require("../../../RoleSelect/MultiTeamRoleSelectView"),LguiUtil_1=require("../../../Util/LguiUtil"),BabelTowerController_1=require("./BabelTowerController"),BabelTowerLevelBuffItem_1=require("./BabelTowerLevelBuffItem"),BabelTowerTeamItem_1=require("./BabelTowerTeamItem"),ROLE_TEAM_SIZE=3;class BabelTowerLevelInfoView extends UiViewBase_1.UiViewBase{constructor(){super(...arguments),this.Sic=void 0,this.lqe=void 0,this.Mic=void 0,this.Eic=void 0,this.d8t=void 0,this.nqe=()=>{UiManager_1.UiManager.IsViewShow("MultiTeamRoleSelectView")||UiManager_1.UiManager.OpenView("MultiTeamRoleSelectView",this.D5t())},this.Ylo=()=>{var t=ModelManager_1.ModelManager.RoleModel;let i=!1;for(let e=0;e<this.Sic.RoleList.length;e++){var r=this.Sic.RoleList[e];t.IsMainRole(r)&&(i=!0,this.Sic.RoleList[e]=0)}if(i){var e=[];for(const o of this.Sic.RoleList)0!==o&&e.push(o);for(;e.length<3;)e.push(0);this.Sic.RoleList=e}},this.X4t=t=>{for(let e=0;e<ROLE_TEAM_SIZE;e++)this.Sic.RoleList[e]=0;for(let e=0;e<t.length;e++){var i=t[e];this.Sic.RoleList[e]=i}this.XSn()},this._fc=e=>{var t=BabelTowerController_1.BabelTowerController.GetBabelTowerData().RoleLockData.get(this.Sic.BabelTowerLevelId)??[];for(const r of e)if(0!==r){var i=ConfigManager_1.ConfigManager.RoleConfig.GetRoleConfig(r).WeaponType;if(0<t.length&&!t?.includes(i))return ControllerHolder_1.ControllerHolder.ScrollingTipsController.ShowTipsByTextId("BabelTowerDebuffRoleSelectionTips"),!1}return!0},this.XSn=()=>{this.$Sn(),this.RefreshTeamRole()},this.L3e=()=>{BabelTowerController_1.BabelTowerController.BabelTowerStartRequest(this.Sic.InstanceId,this.Sic.RoleList,this.Sic.BabelTowerLevelId,this.Sic.BuffList)},this.dic=()=>{UiManager_1.UiManager.OpenView("InstanceDungeonMonsterPreView",this.Sic.InstanceId)},this.zal=()=>{var e=ConfigManager_1.ConfigManager.BabelTowerConfig.GetBabelTowerLevelConfig(this.Sic.BabelTowerLevelId),t=e.IsDifficult,i=e.OptionalBabelBuff,r=[],o=BabelTowerController_1.BabelTowerController.GetBabelTowerData();for(const l of i){let e=0;t&&(o.GetBuffIsLock(l)?e=1:0<(a=o.GetBuffIsUse(l))&&a!==this.Sic.BabelTowerLevelId&&(e=2));var a={Id:l,State:e};r.push(a)}var s=[];for(const n of this.Sic.BuffList)s.push(n);i={LevelId:this.Sic.BabelTowerLevelId,CurrentSelectBuffList:s,MaxSelectBuffCount:e.OptionalBabelBuffNum,AllBuffList:r,OnConfirmCallBack:this.Iic};UiManager_1.UiManager.OpenView("BabelTowerBuffSelectView",i)},this.Iic=e=>{this.Sic.BuffList=e,this.tst()}}OnRegisterComponent(){this.ComponentRegisterInfos=[[0,UE.UIItem],[1,UE.UIButtonComponent],[2,UE.UIArtText],[3,UE.UIItem],[4,UE.UIText],[5,UE.UIItem],[6,UE.UIItem],[7,UE.UIItem],[8,UE.UIItem],[9,UE.UIButtonComponent]],this.BtnBindInfo=[[9,this.L3e],[1,this.dic]]}async OnBeforeStartAsync(){this.lqe=new PopupCaptionItem_1.PopupCaptionItem,await this.lqe.CreateThenShowByActorAsync(this.GetItem(0).GetOwner()),this.lqe.SetCloseCallBack(()=>{this.CloseMe()}),this.d8t=new BabelTowerTeamItem_1.BabelTowerTeamItem,this.d8t.OnClickBtnCallBack=this.nqe,await this.d8t.CreateByActorAsync(this.GetItem(7).GetOwner()),this.d8t.SetActive(!0),this.Mic=new BabelTowerLevelBuffItem_1.BabelTowerLevelBuffItem,await this.Mic.CreateThenShowByActorAsync(this.GetItem(5).GetOwner()),this.Mic.OnClickBtnCallBack=this.zal,this.Eic=new BabelTowerLevelBuffItem_1.BabelTowerLevelBuffItem,await this.Eic.CreateThenShowByActorAsync(this.GetItem(6).GetOwner()),this.Eic.OnClickBtnCallBack=this.zal}OnStart(){this.Sic=this.OpenParam,EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnRoleChangeEnd,this.Ylo)}OnBeforeDestroy(){EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnRoleChangeEnd,this.Ylo)}OnBeforeShow(){for(let e=0;e<this.Sic.RoleList.length;e++){var t=this.Sic.RoleList[e];if(ModelManager_1.ModelManager.RoleModel.IsMainRole(t)&&!ModelManager_1.ModelManager.RoleModel.GetRoleInstanceById(t)){this.Sic.RoleList[e]=0;break}}this.Og()}D5t(){var e,t=this.Sic.InstanceId,i=ConfigManager_1.ConfigManager.InstanceDungeonConfig.GetConfig(t)?.FightFormationId,i=ConfigManager_1.ConfigManager.EditBattleTeamConfig.GetFightFormationConfig(i),r=ModelManager_1.ModelManager.RoleModel.GetRoleList(),o=[],a=BabelTowerController_1.BabelTowerController.GetBabelTowerData().RoleLockData.get(this.Sic.BabelTowerLevelId)??[];for(const _ of r)0!==_.GetRoleId()&&(e=_.GetRoleConfig().WeaponType,e=MultiTeamRoleSelectView_1.MultiTeamRoleGridData.Phrase(_,!1,!1,0<a.length&&!a.includes(e)),o.push(e));var s=[],r=i?.TrialRole??[],i=ModelManager_1.ModelManager.PlayerInfoModel.GetPlayerGender(),l=[];for(const M of ConfigManager_1.ConfigManager.RoleConfig.GetMainRoleByGender(1===i?LoginDefine_1.ELoginSex.Boy:LoginDefine_1.ELoginSex.Girl))l.push(M.Id);for(const u of r){var n=ConfigManager_1.ConfigManager.RoleConfig.GetTrialRoleConfigByGroupId(u);ModelManager_1.ModelManager.RoleModel.IsMainRole(n.ParentId)&&!l.includes(n.ParentId)||(n=ModelManager_1.ModelManager.RoleModel.GetRoleDataById(n.Id))&&s.push(MultiTeamRoleSelectView_1.MultiTeamRoleGridData.Phrase(n,!1,!1))}var i=MultiTeamRoleSelectView_1.MultiTeamRoleData.Phrase("BossRushNormalRole",o),r=new Array,h=(0<s.length&&(h=MultiTeamRoleSelectView_1.MultiTeamRoleData.Phrase("BossRushTrailRole",s),r.push(h)),r.push(i),this.Sic.RoleList),f=[];for(const v of h)0!==v&&f.push(v);i=MultiTeamRoleSelectView_1.MultiTeamRoleSelectData.Phrase(5,3,f,void 0,this._fc,this.X4t,void 0,r);return ModelManager_1.ModelManager.EditBattleTeamModel.SetInstanceDungeonId(t),i}$Sn(){var e=this.Sic.InstanceId,e=ModelManager_1.ModelManager.BabelTowerModel.GetIfLevelTooLow(e,this.Sic.RoleList);this.GetItem(8).SetUIActive(e)}RefreshTeamRole(){var t=BabelTowerController_1.BabelTowerController.GetBabelTowerData().RoleLockData.get(this.Sic.BabelTowerLevelId)??[],i=this.Sic.RoleList;for(let e=0;e<i.length;e++){var r=i[e];0!==r&&(r=ConfigManager_1.ConfigManager.RoleConfig.GetRoleConfig(r).WeaponType,0<t.length&&!t?.includes(r))&&(i[e]=0)}var e=this.Sic.InstanceId;this.d8t.RefreshItem(i,e)}tst(){var e=this.Sic.BuffList,t=0<e?.length?e[0]:0,t=(this.Mic?.RefreshItem(this.Sic.BuffCount<1,t),1<e?.length?e[1]:0);this.Eic?.RefreshItem(this.Sic.BuffCount<2,t)}aqe(){this.GetArtText(2).SetText((this.Sic.StarNumber<10?"0":"")+this.Sic.StarNumber);var e,t=ConfigManager_1.ConfigManager.BabelTowerConfig.GetBabelTowerLevelConfig(this.Sic.BabelTowerLevelId),t=ModelManager_1.ModelManager.BabelTowerModel.CalculateDifficultyConfigByStarNum(t.ActivityId,this.Sic.StarNumber);t&&(e=UE.Color.FromHex(t.TextBgColor),this.GetItem(3).SetColor(e),LguiUtil_1.LguiUtil.SetLocalTextNew(this.GetText(4),t.DifficultyTextKey))}Og(){this.XSn(),this.tst(),this.aqe()}}exports.BabelTowerLevelInfoView=BabelTowerLevelInfoView;
//# sourceMappingURL=BabelTowerLevelInfoView.js.map