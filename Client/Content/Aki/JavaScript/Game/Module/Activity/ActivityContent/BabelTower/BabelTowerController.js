
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BabelTowerController=void 0;const BabelTowerLevelById_1=require("../../../../../Core/Define/ConfigQuery/BabelTowerLevelById"),Protocol_1=require("../../../../../Core/Define/Net/Protocol"),Net_1=require("../../../../../Core/Net/Net"),MathUtils_1=require("../../../../../Core/Utils/MathUtils"),EventDefine_1=require("../../../../Common/Event/EventDefine"),EventSystem_1=require("../../../../Common/Event/EventSystem"),LocalStorage_1=require("../../../../Common/LocalStorage"),LocalStorageDefine_1=require("../../../../Common/LocalStorageDefine"),ConfigManager_1=require("../../../../Manager/ConfigManager"),ControllerHolder_1=require("../../../../Manager/ControllerHolder"),ModelManager_1=require("../../../../Manager/ModelManager"),UiTimeDilation_1=require("../../../../Ui/Base/UiTimeDilation"),UiManager_1=require("../../../../Ui/UiManager"),ConfirmBoxDefine_1=require("../../../ConfirmBox/ConfirmBoxDefine"),ItemRewardController_1=require("../../../ItemReward/ItemRewardController"),ItemRewardDefine_1=require("../../../ItemReward/ItemRewardDefine"),ActivityControllerBase_1=require("../../ActivityControllerBase"),BabelTowerData_1=require("./BabelTowerData"),BabelTowerSubView_1=require("./BabelTowerSubView");class BabelTowerController extends ActivityControllerBase_1.ActivityControllerBase{constructor(){super(...arguments),this.EJ_=e=>{var t=BabelTowerController.GetBabelTowerData();for(const r of e.xX_)(ConfigManager_1.ConfigManager.BabelTowerConfig.GetBabelTowerLevelConfig(r.ELl).IsDifficult?t.HardLevelDataMap:t.NormalLevelDataMap).set(r.ELl,r),t.RoleLockData.set(r.ELl,r.TX_);EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.BabelTowerRefreshLevelInfo)},this.TJ_=e=>{var t=BabelTowerController.GetBabelTowerData();for(const r of e.UX_)t.DeTermUnlock.set(r.RX_,r.AX_)},this.bJ_=e=>{var t=BabelTowerController.GetBabelTowerData();for(const r of e.DX_)t.BuffUnlock.set(r.PX_,r.AX_)},this.LJ_=e=>{var t=BabelTowerController.GetBabelTowerData();for(const r of e.E$s)t.NormalQuest.set(r.s5n,r);EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.BabelTowerRefreshQuestState),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.RefreshCommonActivityRedDot,t.Id)},this.wJ_=e=>{var t=BabelTowerController.GetBabelTowerData();for(const r of e.E$s)t.DailyQuest.set(r.s5n,r);EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.BabelTowerRefreshQuestState),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.RefreshCommonActivityRedDot,t.Id)},this.RJ_=t=>{const a=ModelManager_1.ModelManager.BabelTowerModel.CurrentChallengeInstData;if(a){const _=a.LevelId;var r=a.CurStarNum;const c=BabelTowerLevelById_1.configBabelTowerLevelById.GetConfig(_),w=c.InstId;var o=c.PassStar,n=o<=r;if(t.qX_&&c.IsDifficult)i={LevelId:_,StarNum:r,PassDate:Number(MathUtils_1.MathUtils.LongToBigInt(t.Qxs)),PassTime:t.Y2s,TeamRoleIdList:ModelManager_1.ModelManager.SceneTeamModel.GetTeamRoleConfigIdList(),BuffIdList:a.BuffSelection,DeTermIdList:a.DeTermIdList},UiManager_1.UiManager.OpenView("BabelTowerSettlementView",i);else{let e=void 0;var i=t.qX_?ItemRewardDefine_1.BABEL_TOWER_SUCCESS:ItemRewardDefine_1.BABEL_TOWER_FAIL;if(t.qX_){r={NewBabelBuffIds:t.dsc,NewBabelDeTermIds:t.msc,StarTextParam:{Params:[r,o],TextKey:n?"Text_BabelResultOverStarNum_Text":"Text_BabelResultUnderStarNum_Text"},TipTextId:n?"Text_BabelResultOverStarTip_Text":"Text_BabelResultUnderStarTip_Text"};e={ConfigId:i,IsSuccess:!0,BabelTowerSuccessData:r}}else{var l=[],o=ModelManager_1.ModelManager.TrainingDegreeModel.GetTrainingDataList();if(o)for(const e of o){var s={TrainingData:e};l.push(s)}e={ConfigId:i,IsSuccess:!1,ExploreBarDataList:l}}r=[],o=(r.push({ButtonTextId:"Text_ButtonTextExit_Text",DescriptionTextId:void 0,IsTimeDownCloseView:!1,IsClickedCloseView:!1,OnClickedCallback:e=>{UiManager_1.UiManager.OpenView("BabelTowerNormalLevelChoseView",{IfReturnToBabelTowerMainView:!0,IfLeaveInstanceDungeonWhenMainViewClose:!0})}}),!(t.qX_&&n));o&&(r.push({ButtonTextId:"Text_ChallengeAgain_Text",DescriptionTextId:void 0,IsTimeDownCloseView:!1,IsClickedCloseView:!1,OnClickedCallback:()=>{var t=UiManager_1.UiManager.GetViewByName("ExploreRewardView").GetBottomToggleState();if(t&&1===t){let e=0;t=a.DeTermIdList;if(t)for(const o of t){var r=ConfigManager_1.ConfigManager.BabelTowerConfig.GetBabelTowerDeTerm(o);e+=r.Star}t={BabelTowerLevelId:_,InstanceId:w,RoleList:BabelTowerController.GetTeamRoleConfigIdListWithFill(),BuffList:a?.BuffSelection??[-1,-1],BuffCount:c.OptionalBabelBuffNum,StarNumber:e};UiManager_1.UiManager.OpenView("BabelTowerLevelInfoView",t)}else BabelTowerController.ReChallengeBabelTower()}}),e.StateToggle={DescriptionTextId:"Text_ChangeFormation_Text"}),e.ButtonInfoList=r,ItemRewardController_1.ItemRewardController.OpenExploreRewardViewNew(e)}}},this.cac=e=>{ModelManager_1.ModelManager.BabelTowerModel.UpdateCurrentChallengeInstDataByNotify(e)},this.Vfc=e=>{BabelTowerController.GetBabelTowerData().CurrentItemCount=e.Ofc}}OnOpenView(e){}OnGetActivityResource(e){return"UiItem_ActivityBabel"}OnCreateSubPageComponent(e){return new BabelTowerSubView_1.BabelTowerSubView}OnCreateActivityData(e){return BabelTowerController.ActivityId=e.s5n,new BabelTowerData_1.BabelTowerData}OnGetIsOpeningActivityRelativeView(){return!1}OnRegisterNetEvent(){Net_1.Net.Register(16173,this.EJ_),Net_1.Net.Register(24929,this.TJ_),Net_1.Net.Register(19807,this.bJ_),Net_1.Net.Register(17729,this.LJ_),Net_1.Net.Register(16827,this.wJ_),Net_1.Net.Register(20640,this.RJ_),Net_1.Net.Register(23844,this.cac),Net_1.Net.Register(26106,this.Vfc)}OnUnRegisterNetEvent(){Net_1.Net.UnRegister(16173),Net_1.Net.UnRegister(24929),Net_1.Net.UnRegister(19807),Net_1.Net.UnRegister(17729),Net_1.Net.UnRegister(16827),Net_1.Net.UnRegister(20640),Net_1.Net.UnRegister(23844),Net_1.Net.UnRegister(26106)}OnAddEvents(){}OnRemoveEvents(){}static async SelectBabelActivityDeTermRequest(e,t){var r=Protocol_1.Aki.Protocol.yX_.create(),e=(r.GX_=e,r.IX_=t,await Net_1.Net.CallAsync(22309,r));return!(!e||e.Q4n!==Protocol_1.Aki.Protocol.Q4n.KRs&&(ControllerHolder_1.ControllerHolder.ErrorCodeController.OpenErrorCodeTipView(e.Q4n,29457),1))}static BabelTowerTaskRewardRequest(e){var t=Protocol_1.Aki.Protocol._X_.create();t.gps=e,Net_1.Net.Call(16761,t,e=>{e&&e.Q4n!==Protocol_1.Aki.Protocol.Q4n.KRs&&ControllerHolder_1.ControllerHolder.ErrorCodeController.OpenErrorCodeTipView(e.Q4n,23402)})}static BabelTowerDailyTaskRewardRequest(e){var t=Protocol_1.Aki.Protocol.uX_.create();t.gps=e,Net_1.Net.Call(26924,t,e=>{e&&e.Q4n!==Protocol_1.Aki.Protocol.Q4n.KRs&&ControllerHolder_1.ControllerHolder.ErrorCodeController.OpenErrorCodeTipView(e.Q4n,29979)})}static ResetBabelTowerLevelRequest(e){var t=Protocol_1.Aki.Protocol.mX_.create();t.GX_=e,Net_1.Net.Call(17942,t,e=>{e&&e.Q4n!==Protocol_1.Aki.Protocol.Q4n.KRs&&ControllerHolder_1.ControllerHolder.ErrorCodeController.OpenErrorCodeTipView(e.Q4n,16808)})}static BabelTowerSettlementRequest(){var e=Protocol_1.Aki.Protocol.CX_.create();Net_1.Net.Call(25217,e,e=>{e&&e.Q4n!==Protocol_1.Aki.Protocol.Q4n.KRs&&ControllerHolder_1.ControllerHolder.ErrorCodeController.OpenErrorCodeTipView(e.Q4n,28844)})}static ReChallengeBabelTower(){var e=ModelManager_1.ModelManager.BabelTowerModel.CurrentChallengeInstData,t=e.LevelId,r=BabelTowerLevelById_1.configBabelTowerLevelById.GetConfig(t).InstId,o=this.GetTeamRoleConfigIdListWithFill();this.BabelTowerStartRequest(r,o,t,e.BuffSelection??[])}static GetTeamRoleConfigIdListWithFill(){var t=ModelManager_1.ModelManager.SceneTeamModel.GetTeamRoleConfigIdList();for(let e=t.length;e<3;e++)t.push(0);return t}static BabelTowerStartRequest(e,t,r,o){r={ELl:r,TLl:o};ModelManager_1.ModelManager.InstanceDungeonModel.InstanceEnterContentText.NX_=r,ControllerHolder_1.ControllerHolder.InstanceDungeonController.PrewarTeamFightRequest(e,t,0,0)}static GetBabelTowerData(){return ModelManager_1.ModelManager.ActivityModel.GetActivityById(BabelTowerController.ActivityId)}static OnClickInstanceDungeonExitButton(){var e=new ConfirmBoxDefine_1.ConfirmBoxDataNew(276);e.IsEscViewTriggerCallBack=!1;e.FunctionMap.set(1,()=>{UiManager_1.UiManager.OpenView("BabelTowerMainView",{IfLeaveInstanceDungeonWhenClose:!0})}),e.FunctionMap.set(2,()=>{this.ReChallengeBabelTower()}),e.FinishOpenFunction=(e,t)=>{this.ahi=t,UiTimeDilation_1.UiTimeDilation.SetGameTimeDilation({ViewId:this.ahi,TimeDilation:0,DebugName:"ConfirmBoxView",Reason:"InstanceDungeon"})},e.BeforePlayCloseFunction=()=>{this.ahi<0||(UiTimeDilation_1.UiTimeDilation.SetGameTimeDilation({ViewId:this.ahi,TimeDilation:1,DebugName:"ConfirmBoxView",Reason:"InstanceDungeon"}),this.ahi=-1)},ControllerHolder_1.ControllerHolder.ConfirmBoxController.ShowConfirmBoxNew(e)}static SaveNewLevelData(e){var t=LocalStorage_1.LocalStorage.GetPlayer(LocalStorageDefine_1.ELocalStoragePlayerKey.BabelTowerNewLevel)??new Map;t.set(e,!0),LocalStorage_1.LocalStorage.SetPlayer(LocalStorageDefine_1.ELocalStoragePlayerKey.BabelTowerNewLevel,t)}static SaveNewLevelClickData(e,t){var r=LocalStorage_1.LocalStorage.GetPlayer(LocalStorageDefine_1.ELocalStoragePlayerKey.BabelTowerNewLevelHasClick)??new Map;r.set(e,!0),LocalStorage_1.LocalStorage.SetPlayer(LocalStorageDefine_1.ELocalStoragePlayerKey.BabelTowerNewLevelHasClick,r),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.BabelTowerLevelClick,e),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.BabelTowerDifficultyLevelClick,t)}}(exports.BabelTowerController=BabelTowerController).ActivityId=0,BabelTowerController.ahi=-1;
//# sourceMappingURL=BabelTowerController.js.map