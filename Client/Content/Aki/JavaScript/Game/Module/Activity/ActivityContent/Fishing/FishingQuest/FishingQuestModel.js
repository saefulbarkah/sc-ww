
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.FishingQuestModel=void 0;const Protocol_1=require("../../../../../../Core/Define/Net/Protocol"),ModelBase_1=require("../../../../../../Core/Framework/ModelBase"),TimerSystem_1=require("../../../../../../Core/Timer/TimerSystem"),Vector_1=require("../../../../../../Core/Utils/Math/Vector"),EventDefine_1=require("../../../../../Common/Event/EventDefine"),EventSystem_1=require("../../../../../Common/Event/EventSystem"),TimeUtil_1=require("../../../../../Common/TimeUtil"),ConfigManager_1=require("../../../../../Manager/ConfigManager"),ControllerHolder_1=require("../../../../../Manager/ControllerHolder"),ModelManager_1=require("../../../../../Manager/ModelManager"),PreloadConfigStatementPart1_1=require("../../../../../Preload/PreloadConfigStatementPart1"),PreloadControllerClassPart2_1=require("../../../../../Preload/PreloadControllerClassPart2"),UiManager_1=require("../../../../../Ui/UiManager"),MissionViewDefine_1=require("../../../../BattleUi/Views/MissionView/MissionViewDefine"),ConfirmBoxDefine_1=require("../../../../ConfirmBox/ConfirmBoxDefine"),MapDefine_1=require("../../../../Map/MapDefine"),FishingController_1=require("../FishingController"),FishingDefine_1=require("../FishingDefine"),MAX_INT32_NUMBER=2147483647;class FishingQuestModel extends ModelBase_1.ModelBase{constructor(){super(...arguments),this.EntrustPool=[],this.kW_=0,this.CurrentTraceItem=0,this.rB_=void 0,this.hk_=!1,this.lk_=0,this._k_=0,this.$k_=void 0,this.NO_=0,this.EntrustRefreshCostRatio=0,this.Xbe=void 0,this.DayStartTime=0,this.DayEndTime=0,this.p$_=!1,this.qW_=!1,this.TraceFormClick=!1,this.OW_=0,this.GW_=!1,this.CurrentEntrusts=new Map,this.UnDeliverableItemIdSet=new Set,this.Px_=()=>{this.xx_()},this.Ux_=()=>{this.xx_()},this.p5a=()=>{this.hk_&&(this.lk_?this.TraceItem(this.lk_):(this.CurrentTraceEntrust=this._k_,this.TraceEntrust())),this.hk_=!1,this._k_=0,this.lk_=0},this.qd_=e=>{e?this.ReTraceMapMark():this.RemoveAndUnTrackMark(!1)},this.FW_=e=>{this.OW_===e&&this.CurrentTraceItem&&this.TraceItem(this.CurrentTraceItem)},this.u3e=()=>{var e;this.CurrentTraceEntrust&&FishingController_1.FishingController.IsInFishingShip()&&ConfigManager_1.ConfigManager.FishingConfig.GetFishingEntrust(this.CurrentTraceEntrust).IsNight&&(e=this.IsInNight(),this.p$_!==e?(this.TraceEntrust(),((this.p$_=e)&&!this.qW_||!e&&this.qW_)&&(this.GW_=!0)):this.GW_&&(this.GW_=!1,this.TraceEntrust()))}}get CurrentTraceEntrust(){return this.kW_}set CurrentTraceEntrust(e){this.EndShowTrackText(),this.kW_=e}OnInit(){for(const e of ConfigManager_1.ConfigManager.FishingConfig.GetAllFishingEntrustPool())this.EntrustPool.push(e.Id);return this.DayStartTime=PreloadConfigStatementPart1_1.configCommonParamById.GetIntConfig("FishingDayBegin"),this.DayEndTime=PreloadConfigStatementPart1_1.configCommonParamById.GetIntConfig("FishingDayEnd"),this.p$_=this.IsInNight(),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.FishingRefreshDockId,this.Px_),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.FishingRefreshBackpackData,this.Ux_),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.WorldDoneAndCloseLoading,this.p5a),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.DriveFishingShipStateChanged,this.qd_),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.FishingPointFinish,this.FW_),this.Xbe=TimerSystem_1.TimerSystem.Forever(this.u3e,3*TimeUtil_1.TimeUtil.InverseMillisecond),!0}OnClear(){return EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.FishingRefreshDockId,this.Px_),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.FishingRefreshBackpackData,this.Ux_),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.WorldDoneAndCloseLoading,this.p5a),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.DriveFishingShipStateChanged,this.qd_),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.FishingPointFinish,this.FW_),TimerSystem_1.TimerSystem.Remove(this.Xbe),!0}e$_(){if(this.UnDeliverableItemIdSet.clear(),this.CurrentTraceEntrust){var e,i,t=this.CurrentEntrusts.get(this.CurrentTraceEntrust);if(3===t)for([e,i]of ConfigManager_1.ConfigManager.FishingConfig.GetFishingEntrust(this.CurrentTraceEntrust).EntrustTarget)e&&i&&ModelManager_1.ModelManager.DockyardModel.GetItemCountByItemId(e)<i&&this.UnDeliverableItemIdSet.add(e)}}IsUnDeliverableByItemId(e){for(const i of this.UnDeliverableItemIdSet.values())if(i===e)return!0;return!1}IsAcceptedEntrustItem(e){for(var[i,t]of this.CurrentEntrusts)if(3===t||2===t)for(const r of ConfigManager_1.ConfigManager.FishingConfig.GetFishingEntrust(i).EntrustTarget.keys())if(e===r)return!0;return!1}UpdateEntrusts(e){this.CurrentEntrusts.clear(),this.CurrentTraceItem=0;for(const r of Object.keys(e)){var i=parseInt(r);switch(e[r]){case Protocol_1.Aki.Protocol.hR_.Proto_Created:this.CurrentEntrusts.set(i,0);break;case Protocol_1.Aki.Protocol.hR_.Proto_Acceptable:this.CurrentEntrusts.set(i,1);break;case Protocol_1.Aki.Protocol.hR_.Proto_Accepted:var t=this.GetEntrustsDeliverable(i);this.CurrentEntrusts.set(i,t?2:3)}}void 0!==this.CurrentTraceEntrust&&(this.Wk_(),0!==this.CurrentTraceEntrust)&&this.TraceEntrust(),this.e$_()}GetEntrustsDeliverable(e){var i=ConfigManager_1.ConfigManager.FishingConfig.GetFishingEntrust(e);return 0===i.EntrustType||1===i.EntrustType?!(!this.GetEntrustsTargetEnough(e)||i.EntrustDestination&&ModelManager_1.ModelManager.FishingModel.DockId!==i.EntrustDestination):2===i.EntrustType&&ModelManager_1.ModelManager.FishingModel.DockId===i.EntrustDestination}GetEntrustsTargetEnough(e){var i,t,e=ConfigManager_1.ConfigManager.FishingConfig.GetFishingEntrust(e);if(0!==e.EntrustType&&1!==e.EntrustType)return 2===e.EntrustType;for([i,t]of e.EntrustTarget){if(!i||!t)return!1;if(ModelManager_1.ModelManager.DockyardModel.GetItemCountByItemId(i)<t)return!1}return!0}GetEntrustsByPoolType(e){var i,t=[],r=0<ModelManager_1.ModelManager.FishingModel.DockId;for([i]of this.CurrentEntrusts){if(!r){var n=this.CurrentEntrusts.get(i);if(2!==n&&3!==n)continue}ConfigManager_1.ConfigManager.FishingConfig.GetFishingEntrust(i).EntrustPool===e&&t.push(i)}return t}GetPoolHasAnyEntrust(e){var i,t=0<ModelManager_1.ModelManager.FishingModel.DockId;for([i]of this.CurrentEntrusts){if(!t){var r=this.CurrentEntrusts.get(i);if(2!==r&&3!==r)continue}if(ConfigManager_1.ConfigManager.FishingConfig.GetFishingEntrust(i).EntrustPool===e)return!0}return!1}GetPoolHasAnyAcceptedEntrust(e){for(var[i]of this.CurrentEntrusts){i=this.CurrentEntrusts.get(i);if(2===i||3===i)return!0}return!1}GetEntrustsLockState(e){return 0===this.CurrentEntrusts.get(e)}GetEntrustsRefreshCost(e){e=ConfigManager_1.ConfigManager.FishingConfig.GetFishingEntrust(e),e=ConfigManager_1.ConfigManager.FishingConfig.GetFishingManualRefreshByEntrustPoolTypeAndStar(e.EntrustPool,e.Star);return e&&e[0]?e[0]?.RefreshCost*((100-this.EntrustRefreshCostRatio)/100):-1}GetTraceEntrustItem(){if(this.CurrentTraceEntrust){const r=ConfigManager_1.ConfigManager.FishingConfig.GetFishingEntrust(this.CurrentTraceEntrust);var e,i;if(2!==r.EntrustType)for([e,i]of r.EntrustTarget)if(e&&i)if(ModelManager_1.ModelManager.DockyardModel.GetItemCountByItemId(e)<i){const r=ConfigManager_1.ConfigManager.FishingConfig.GetFishingItemConfig(e);var t=r.Relation??0;return 0<t?t:e}}return-1}VO_(){var e;return this.CurrentTraceEntrust?(e=ConfigManager_1.ConfigManager.FishingConfig.GetFishingEntrust(this.CurrentTraceEntrust).EntrustDestination)<=0?this.jO_():e:-1}jO_(){var e=ModelManager_1.ModelManager.FishingModel.UnlockPort,i=this.lVe();if(!i)return-1;let t=MAX_INT32_NUMBER,r=void 0;for(const s of e){var n=ConfigManager_1.ConfigManager.FishingConfig.GetFishingPortConfig(s).EntityConfigId,n=ModelManager_1.ModelManager.CreatureModel.GetEntityData(n);n&&(n={X:(n=n.Transform.Pos).X??0,Y:n.Y??0,Z:n.Z??0},n=Vector_1.Vector.Create(n),(n=Vector_1.Vector.Dist(i,n))<t)&&(t=n,r=s)}return r||-1}TraceEntrust(){var e,i;this.qW_=!1,this.OW_=0,this.CurrentTraceItem=0,this.RemoveAndUnTrackMark(),ModelManager_1.ModelManager.LoadingModel.IsLoading&&this.CurrentTraceEntrust?(this.hk_=!0,this._k_=this.CurrentTraceEntrust):(this.CurrentTraceEntrust&&(this.StartShowTrackText(this.CurrentTraceEntrust),(e=this.GetTraceEntrustItem())<=0?(this.qW_=!0,(i=this.VO_())<=0?(UiManager_1.UiManager.IsViewOpen("FishingQuestView")||UiManager_1.UiManager.IsViewOpen("FishingHandBookView"))&&ControllerHolder_1.ControllerHolder.ScrollingTipsController.ShowTipsByTextId("Fishing_CurrentEntrustCannotTrace"):(i=ConfigManager_1.ConfigManager.FishingConfig.GetFishingPortConfig(i),PreloadControllerClassPart2_1.MapController.RequestTrackMapMark(34,i.MarkId,!0),this.NO_=i.MarkId,UiManager_1.UiManager.IsViewOpen("FishingQuestView")&&this.TraceFormClick&&UiManager_1.UiManager.CloseView("FishingQuestView"))):(this.m$l(e,0),this.qW_&&this.TraceFormClick&&UiManager_1.UiManager.IsViewOpen("FishingQuestView")&&UiManager_1.UiManager.CloseView("FishingQuestView"))),this.TraceFormClick=!1)}StartShowTrackText(t,r=0){if(t){var n,s,a=ConfigManager_1.ConfigManager.FishingConfig.GetFishingEntrust(t),o=[];for([n,s]of a.TargetDesText){var h={ShowSource:1,TidTitle:s,ProgressTargetId:n,QuestScheduleType:{Type:"FishingEntrust"}};o.push(h)}let e=void 0,i=void 0;1===o.length?e=o[0]:i=o;t=MissionViewDefine_1.FishingEntrustViewShowData.Create(t,20,a.Name,e,i);EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.FishingEntrustStartShowTrackText,t,r)}}EndShowTrackText(e=0){EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.FishingEntrustEndShowTrackText,this.CurrentTraceEntrust,e)}TraceItem(e){this.qW_=!1,this.CurrentTraceEntrust=0,this.OW_=0,this.RemoveAndUnTrackMark(),ModelManager_1.ModelManager.LoadingModel.IsLoading&&e?(this.hk_=!0,this.lk_=e):e<=0||(this.CurrentTraceItem=e,this.m$l(e,1),this.qW_&&UiManager_1.UiManager.IsViewOpen("FishingHandBookView")&&UiManager_1.UiManager.CloseView("FishingHandBookView"))}m$l(n,s){var a,o,h,_=this.lVe();if(_){let e=MAX_INT32_NUMBER,i=void 0,t=void 0,r=void 0;for(const g of ConfigManager_1.ConfigManager.FishingConfig.GetFishingPointByShowItem(n))ModelManager_1.ModelManager.FishingModel.GetFishingPointHaveFinishingIdByConfigId(g.Id)||(a=ModelManager_1.ModelManager.FishingModel.GetFishingPointEntityIdByConfigId(g.Id),(o=ModelManager_1.ModelManager.CreatureModel.GetEntityData(a))&&(o={X:(o=o.Transform.Pos).X??0,Y:o.Y??0,Z:o.Z??0},o=Vector_1.Vector.Create(o),(h=Vector_1.Vector.Dist(_,o))<e)&&(e=h,i=o,t=a,r=g.Id));i&&void 0!==t?((UiManager_1.UiManager.IsViewOpen("FishingQuestView")||UiManager_1.UiManager.IsViewOpen("FishingHandBookView"))&&ControllerHolder_1.ControllerHolder.ScrollingTipsController.ShowTipsByTextId("Fishing_DetectSuccess"),this.OW_=r,this.oB_(t,s),this.qW_=!0):(UiManager_1.UiManager.IsViewOpen("FishingQuestView")||UiManager_1.UiManager.IsViewOpen("FishingHandBookView"))&&(3!==ConfigManager_1.ConfigManager.FishingConfig.GetFishingItemConfig(n).Time||ModelManager_1.ModelManager.FishingQuestModel.IsInNight()?ControllerHolder_1.ControllerHolder.ScrollingTipsController.ShowTipsByTextId("Fishing_FishingPointCannotTrace"):ControllerHolder_1.ControllerHolder.ScrollingTipsController.ShowTipsByTextId("Fishing_NightTargetTip"))}}lVe(){var e=ModelManager_1.ModelManager.SceneTeamModel.GetCurrentEntity;if(e){e=e.Entity.GetComponent(3);if(e)return e.ActorLocationProxy}}oB_(e,i){if(this.$k_=new MapDefine_1.FishingPointMarkCreateInfo({TrackTarget:e,MarkConfigId:FishingDefine_1.FISHING_POINT_MARK_ID,MarkType:32,EntityConfigId:e,DestroyOnUnTrack:!0,FishPointDetectSourceType:i,MapAndDungeonInfo:{MapConfigId:MapDefine_1.BIG_WORLD_MAP_ID,DungeonId:MapDefine_1.BIG_WORLD_MAP_ID}}),ModelManager_1.ModelManager.FishingModel.IsOnShipVehicle())return this.rB_=ModelManager_1.ModelManager.MapModel.CreateMapMark(this.$k_),ModelManager_1.ModelManager.MapModel.SetTrackMark(this.$k_.MarkType,this.rB_,!0),this.rB_}RemoveAndUnTrackMark(e=!0){this.rB_&&(ModelManager_1.ModelManager.MapModel.RemoveMapMark(32,this.rB_),this.rB_=void 0,e)&&(this.$k_=void 0),0!==this.NO_&&(PreloadControllerClassPart2_1.MapController.RequestTrackMapMark(34,this.NO_,!1),this.NO_=0)}Wk_(){ModelManager_1.ModelManager.MapModel.RemoveMapMarkByType(32)}ReTraceMapMark(){this.$k_&&void 0===this.rB_&&(this.rB_=ModelManager_1.ModelManager.MapModel.CreateMapMark(this.$k_),ModelManager_1.ModelManager.MapModel.SetTrackMark(this.$k_.MarkType,this.rB_,!0))}xx_(){for(var[e,i]of this.CurrentEntrusts)3!==i&&2!==i||(i=this.GetEntrustsDeliverable(e),this.CurrentEntrusts.set(e,i?2:3));this.CurrentTraceEntrust&&this.TraceEntrust(),this.e$_()}OnFishingItemSell(e,i){for(var[t,r]of this.CurrentEntrusts){t=ConfigManager_1.ConfigManager.FishingConfig.GetFishingEntrust(t);if(t.EntrustPool!==FishingDefine_1.FISHING_QUICK_SAIL_POOL&&1!==r&&0!==r)for(var[n]of t.EntrustTarget)if(e.includes(n))return(n=new ConfirmBoxDefine_1.ConfirmBoxDataNew(249)).IsEscViewTriggerCallBack=!1,n.FunctionMap.set(0,()=>{PreloadControllerClassPart2_1.ConfirmBoxController.CloseConfirmBoxView()}),n.FunctionMap.set(1,()=>{UiManager_1.UiManager.OpenView("FishingQuestView")}),n.FunctionMap.set(2,()=>{i()}),PreloadControllerClassPart2_1.ConfirmBoxController.ShowConfirmBoxNew(n),!0}return!1}AutoTraceEntrust(){var e,i,t=[];for([e,i]of this.CurrentEntrusts){var r=ConfigManager_1.ConfigManager.FishingConfig.GetFishingEntrust(e);r.EntrustPool!==FishingDefine_1.FISHING_QUICK_SAIL_POOL&&1!==i&&0!==i&&t.push(r)}t.length<=0||(t.sort((e,i)=>{var t=e.EntrustPool,r=i.EntrustPool;return t!==r?t-r:e.Star-i.Star}),FishingController_1.FishingController.RequestFishingEntrustTrace(t[0].Id))}IsInNight(){var e=ModelManager_1.ModelManager.TimeOfDayModel.GameTime.Hour;return e>=this.DayEndTime||e<this.DayStartTime}}exports.FishingQuestModel=FishingQuestModel;
//# sourceMappingURL=FishingQuestModel.js.map