
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ScratchTicketMainView=void 0;const UE=require("ue"),Log_1=require("../../../../../../Core/Common/Log"),MultiTextLang_1=require("../../../../../../Core/Define/ConfigQuery/MultiTextLang"),TimerSystem_1=require("../../../../../../Core/Timer/TimerSystem"),StringUtils_1=require("../../../../../../Core/Utils/StringUtils"),EventDefine_1=require("../../../../../Common/Event/EventDefine"),EventSystem_1=require("../../../../../Common/Event/EventSystem"),TimeUtil_1=require("../../../../../Common/TimeUtil"),UiTickViewBase_1=require("../../../../../Ui/Base/UiTickViewBase"),PopupCaptionItem_1=require("../../../../../Ui/Common/PopupCaptionItem"),UiLayer_1=require("../../../../../Ui/UiLayer"),ItemRewardController_1=require("../../../../ItemReward/ItemRewardController"),ScrollingTipsController_1=require("../../../../ScrollingTips/ScrollingTipsController"),GenericLayout_1=require("../../../../Util/Layout/GenericLayout"),ActivityFunctionalTypeA_1=require("../../UniversalComponents/Functional/ActivityFunctionalTypeA"),ActivityTitleTypeA_1=require("../../UniversalComponents/Title/ActivityTitleTypeA"),ActivityScratchTicketController_1=require("../ActivityScratchTicketController"),ActivityScratchTicketDefine_1=require("../ActivityScratchTicketDefine"),ScratchTicketData_1=require("../Data/ScratchTicketData"),ScratchTicketCellItem_1=require("./Item/ScratchTicketCellItem"),ScratchTicketConditionItem_1=require("./Item/ScratchTicketConditionItem"),ScratchTicketRewardItemGrid_1=require("./Item/ScratchTicketRewardItemGrid"),ScratchTicketTabItem_1=require("./Item/ScratchTicketTabItem");class ScratchTicketMainView extends UiTickViewBase_1.UiTickViewBase{constructor(){super(...arguments),this.gLt=void 0,this.lqe=void 0,this.Jol=void 0,this.o8a=void 0,this.B7t=void 0,this.tnl=void 0,this.H3e=void 0,this.pol=void 0,this.inl=void 0,this.rnl=void 0,this.TDe=void 0,this.PCl=void 0,this.e8=TimeUtil_1.TimeUtil.InverseMillisecond,this.$An=i=>{"Refresh"===i&&(this.nnl(this.rnl),this.wCl(this.rnl))},this.fpl=()=>{var i=this.pol.GetRoundDataList();this.B7t.RefreshByData(i),this.snl()},this.onl=(i,t)=>{void 0!==this.inl&&this.inl.SetSelect(!1,!1);var e=this.rnl;this.inl=t,this.inl.SetSelect(!0,!1),this.rnl=i,this.BCl(this.rnl,e),this.nnl(this.rnl),this.snl()},this.anl=i=>{var t;i.IsLock()&&(void 0===this.rnl||1!==this.rnl.GetRoundState()?ScrollingTipsController_1.ScrollingTipsController.ShowTipsByTextId("ScratchCardActivity_ClickTips02"):this.pol.GetRemainCount()<=0?ScrollingTipsController_1.ScrollingTipsController.ShowTipsByTextId("ScratchCardActivity_ClickTips01"):(t=this.rnl.Id,ActivityScratchTicketController_1.ActivityScratchTicketController.SendScratchCardRewardRequest(t,i.Index,this.lnl)))},this.lnl=(h,i,r,c)=>{if(i===this.rnl.Id&&!(r.length<=0))if(1===r.length)UiLayer_1.UiLayer.SetShowMaskLayer("ScratchTicketMainView",!0),this.hgl(r[0]),this.bdl(),TimerSystem_1.TimerSystem.Delay(()=>{UiLayer_1.UiLayer.SetShowMaskLayer("ScratchTicketMainView",!1),this.o1l(h,c)},r[0].DelayInterval);else{this.hgl(r[0]);let t=r[0].DelayInterval,e=1,s=0;this.bdl(),UiLayer_1.UiLayer.SetShowMaskLayer("ScratchTicketMainView",!0);this.TDe=TimerSystem_1.TimerSystem.Forever(i=>{(s+=i)<t||(s%=t,e>=r.length?(UiLayer_1.UiLayer.SetShowMaskLayer("ScratchTicketMainView",!1),this.o1l(h,c),this.jm()):t=e===r.length-1?(this.hgl(r[e]),ActivityScratchTicketDefine_1.LAST_DELAY_INTERVAL):(this.hgl(r[e]),r[e].DelayInterval),e++)},ActivityScratchTicketDefine_1.FOREVER_DELAY_INTERVAL)}},this.$ll=()=>{var i;2===this.rnl.GetRoundState()?(i=this.pol.GetRoundDataList(),this.B7t.RefreshByData(i),this.hnl()):this.snl()},this.Jvt=()=>{this.CloseMe()},this.n8a=()=>new ScratchTicketConditionItem_1.ScratchTicketConditionItem,this.unl=()=>{var i=new ScratchTicketTabItem_1.ScratchTicketTabItem;return i.SetClickToggleCallback(this.onl),i},this.cnl=()=>{var i=new ScratchTicketCellItem_1.ScratchTicketCellItem;return i.SetClickCallback(this.anl),i},this.CreateRewardGridItem=()=>{return new ScratchTicketRewardItemGrid_1.ScratchTicketRewardItemGrid}}OnRegisterComponent(){this.ComponentRegisterInfos=[[0,UE.UIItem],[1,UE.UIItem],[2,UE.UIItem],[3,UE.UIVerticalLayout],[4,UE.UIVerticalLayout],[5,UE.UIGridLayout],[6,UE.UIItem],[7,UE.UIMultiTemplateLayout],[9,UE.UISprite],[8,UE.UIItem],[10,UE.UIItem]]}async OnBeforeStartAsync(){this.pol=this.OpenParam,this.pol instanceof ScratchTicketData_1.ScratchTicketData?(this.o8a=new GenericLayout_1.GenericLayout(this.GetVerticalLayout(3),this.n8a),this.tnl=new GenericLayout_1.GenericLayout(this.GetGridLayout(5),this.cnl),this.H3e=new GenericLayout_1.GenericLayout(this.GetMultiTemplateLayout(7),this.CreateRewardGridItem),this.lqe=new PopupCaptionItem_1.PopupCaptionItem(this.GetItem(6)),this.lqe.SetCloseCallBack(this.Jvt),await this.lqe.SetCurrencyItemList([this.pol.GetCostItemId()]),this.gLt=new ActivityTitleTypeA_1.ActivityTitleTypeA,await this.gLt.CreateThenShowByActorAsync(this.GetItem(0).GetOwner()),this.Jol=new ActivityFunctionalTypeA_1.ActivityFunctionalTypeA(void 0),await this.Jol.CreateThenShowByActorAsync(this.GetItem(1).GetOwner()),await this.mnl(),await this.Xal(),this.snl()):Log_1.Log.CheckError()&&Log_1.Log.Error("ScratchTicket",58,"ScratchTicketMainView无效输入")}OnAddEventListener(){EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnActivitySequenceEmitEvent,this.$An),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnScratchTicketConditionRefresh,this.fpl)}OnRemoveEventListener(){EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnActivitySequenceEmitEvent,this.$An),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnScratchTicketConditionRefresh,this.fpl)}GetGuideUiItemAndUiItemForShowEx(i){if(0!==i.length&&!isNaN(Number(i[0]))){i=Number(i[0]),i=this.tnl?.GetItemByIndex(i);if(void 0!==i)return[i,i]}}async mnl(){this.B7t=new GenericLayout_1.GenericLayout(this.GetVerticalLayout(4),this.unl);var i=this.pol.GetRoundDataList();await this.B7t.RefreshByDataAsync(i)}async Xal(){var i,t=this.pol.GetFirstProgressRoundDataIndex();t<0||(i=this.pol.GetRoundDataList(),this.inl=this.B7t.GetLayoutItemByKey(t),this.inl.SetSelect(!0,!1),this.rnl=i[t],i=this.rnl.GetCellDataList(),await this.tnl.RefreshByDataAsync(i))}hnl(){var i=this.pol.GetFirstProgressRoundDataIndex();i<0||this.B7t.GetLayoutItemByKey(i).SetSelect(!0,!0)}nnl(i){const t=i.GetDiagonalResultList();if(!(t.length<=0)){UiLayer_1.UiLayer.SetShowMaskLayer("ScratchTicketMainView",!0),this.hgl(t[0]),this._nl(t[0].RewardList);let i=1;this.PCl=TimerSystem_1.TimerSystem.Forever(()=>{i>=t.length?(UiLayer_1.UiLayer.SetShowMaskLayer("ScratchTicketMainView",!1),this.bCl()):(this.hgl(t[i]),i++)},ActivityScratchTicketDefine_1.REVEAL_DELAY_INTERVAL)}}snl(){var i;this.pol.GetScratchCardActivityConfig()&&this.pol.LocalConfig&&(this.gLt.SetTitleByText(this.pol.GetTitle()),this.H3e.RefreshByData(this.rnl.GetRemainRewardList()),this.FNe(),i=this.rnl.GetRoundState(),this.Jol.PanelLock.SetUiActive(0===i),this.Jol.PanelActivate.SetUiActive(2===i),this.Jol.FunctionButton.SetUiActive(!1),this.Jol.PanelActivate.SetTextByTextId("ScratchCardActivity_CompleteDesc"),i=this.rnl.Config.TogRoundIcon,this.SetSpriteByPath(i,this.GetSprite(9),!1,void 0),i=this.pol.IsAllRoundFinish(),this.lqe.SetCurrencyItemVisible(!i),this.GetItem(10).SetUIActive(!i),this.GetItem(8).SetUIActive(i),i=this.pol.GetConditionDataList(),this.o8a.RefreshByData(i))}FNe(){var i=this.pol.EndOpenTime,t=TimeUtil_1.TimeUtil.GetServerTime(),i=Math.max(i-t,1);const e=TimeUtil_1.TimeUtil.GetRemainTimeDataFormat3(i),s=MultiTextLang_1.configMultiTextLang.GetLocalTextNew("ScratchCardActivity_TimeDesc");if(this.gLt.SetTimeTextByText(StringUtils_1.StringUtils.Format(s,e.CountDownText)),0===this.rnl.GetRoundState()){i=this.rnl.GetUnlockTime()*TimeUtil_1.TimeUtil.Millisecond-t,t=this.rnl.GetPreRoundState();if(0<i){const e=TimeUtil_1.TimeUtil.GetRemainTimeDataFormat3(i),s=StringUtils_1.StringUtils.Format(MultiTextLang_1.configMultiTextLang.GetLocalTextNew("ScratchCardActivity_NoJoinTips01"),e.CountDownText);this.Jol.PanelLock.SetTextByText(s)}else 2!==t?this.Jol.PanelLock.SetTextByTextId("ScratchCardActivity_NoJoinTips02"):this.Jol.PanelLock.SetTextByTextId("ScratchCardActivity_NoJoinTips03")}}OnTick(i){this.e8+=i,this.e8>=TimeUtil_1.TimeUtil.InverseMillisecond&&(this.FNe(),this.e8%=TimeUtil_1.TimeUtil.InverseMillisecond)}OnBeforeHide(){this.jm(),this.bCl()}jm(){TimerSystem_1.TimerSystem.Has(this.TDe)&&(TimerSystem_1.TimerSystem.Remove(this.TDe),this.TDe=void 0)}bCl(){TimerSystem_1.TimerSystem.Has(this.PCl)&&(TimerSystem_1.TimerSystem.Remove(this.PCl),this.PCl=void 0)}bdl(){TimerSystem_1.TimerSystem.Delay(()=>{this.PlaySequence("Shake")},ActivityScratchTicketDefine_1.SHOW_SHAKE_INTERVAL)}BCl(i,t){var i=this.pol.GetRoundDataIndex(i),t=this.pol.GetRoundDataIndex(t),e=i<t,s=Math.min(i,t),i=Math.max(i,t);1===i&&0===s&&this.UiViewSequence.PlaySequencePurely("SwitchA",!0,e),2===i&&0===s&&this.UiViewSequence.PlaySequencePurely("SwitchB",!0,e),2===i&&1===s&&this.UiViewSequence.PlaySequencePurely("SwitchC",!0,e)}wCl(i){i=this.pol.GetRoundDataIndex(i);1===i?this.UiViewSequence.PlaySequencePurely("SwitchA",!0):2===i&&this.UiViewSequence.PlaySequencePurely("SwitchB",!0)}o1l(i,t){0===i?(ActivityScratchTicketController_1.ActivityScratchTicketController.ShowScratchTicketRewardTip(t),this.$ll()):ItemRewardController_1.ItemRewardController.OpenCommonRewardView(ActivityScratchTicketDefine_1.SCRATCH_TICKET_REWRAD_CONFIG_ID,t,this.$ll)}hgl(i){0<i.RewardList.length&&this._nl(i.RewardList),"Empty"!==i.SequenceName&&this.UiViewSequence.PlaySequence(i.SequenceName)}_nl(i){for(const s of i){var t=this.tnl.GetLayoutItemByKey(s.Index),e=this.rnl.GetCellDataByIndex(s.Index);void 0!==t&&t.RefreshByResultData(e,s)}}}exports.ScratchTicketMainView=ScratchTicketMainView;
//# sourceMappingURL=ScratchTicketMainView.js.map