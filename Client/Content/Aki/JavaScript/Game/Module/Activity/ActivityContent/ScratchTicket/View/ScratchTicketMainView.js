
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ScratchTicketMainView=void 0;const UE=require("ue"),Log_1=require("../../../../../../Core/Common/Log"),MultiTextLang_1=require("../../../../../../Core/Define/ConfigQuery/MultiTextLang"),TimerSystem_1=require("../../../../../../Core/Timer/TimerSystem"),StringUtils_1=require("../../../../../../Core/Utils/StringUtils"),EventDefine_1=require("../../../../../Common/Event/EventDefine"),EventSystem_1=require("../../../../../Common/Event/EventSystem"),TimeUtil_1=require("../../../../../Common/TimeUtil"),UiTickViewBase_1=require("../../../../../Ui/Base/UiTickViewBase"),PopupCaptionItem_1=require("../../../../../Ui/Common/PopupCaptionItem"),UiLayer_1=require("../../../../../Ui/UiLayer"),ItemRewardController_1=require("../../../../ItemReward/ItemRewardController"),ScrollingTipsController_1=require("../../../../ScrollingTips/ScrollingTipsController"),GenericLayout_1=require("../../../../Util/Layout/GenericLayout"),ActivityFunctionalTypeA_1=require("../../UniversalComponents/Functional/ActivityFunctionalTypeA"),ActivityTitleTypeA_1=require("../../UniversalComponents/Title/ActivityTitleTypeA"),ActivityScratchTicketController_1=require("../ActivityScratchTicketController"),ActivityScratchTicketDefine_1=require("../ActivityScratchTicketDefine"),ScratchTicketData_1=require("../Data/ScratchTicketData"),ScratchTicketCellItem_1=require("./Item/ScratchTicketCellItem"),ScratchTicketConditionItem_1=require("./Item/ScratchTicketConditionItem"),ScratchTicketRewardItemGrid_1=require("./Item/ScratchTicketRewardItemGrid"),ScratchTicketTabItem_1=require("./Item/ScratchTicketTabItem");class ScratchTicketMainView extends UiTickViewBase_1.UiTickViewBase{constructor(){super(...arguments),this.gLt=void 0,this.lqe=void 0,this.hnl=void 0,this.o8a=void 0,this.B7t=void 0,this.cnl=void 0,this.H3e=void 0,this.Dol=void 0,this.mnl=void 0,this.dnl=void 0,this.TDe=void 0,this.Wvl=void 0,this.e8=TimeUtil_1.TimeUtil.InverseMillisecond,this.$An=i=>{"Refresh"===i&&(this.gnl(this.dnl),this.Qvl(this.dnl))},this.tkl=()=>{var i=this.Dol.GetRoundDataList();this.B7t.RefreshByData(i),this.pnl()},this.Cnl=(i,t)=>{void 0!==this.mnl&&this.mnl.SetSelect(!1,!1);var e=this.dnl;this.mnl=t,this.mnl.SetSelect(!0,!1),this.dnl=i,this.Kvl(this.dnl,e),this.gnl(this.dnl),this.pnl()},this.fnl=i=>{var t;i.IsLock()&&(void 0===this.dnl||1!==this.dnl.GetRoundState()?ScrollingTipsController_1.ScrollingTipsController.ShowTipsByTextId("ScratchCardActivity_ClickTips02"):this.Dol.GetRemainCount()<=0?ScrollingTipsController_1.ScrollingTipsController.ShowTipsByTextId("ScratchCardActivity_ClickTips01"):(t=this.dnl.Id,ActivityScratchTicketController_1.ActivityScratchTicketController.SendScratchCardRewardRequest(t,i.Index,this.vnl)))},this.vnl=(r,i,h,c)=>{if(i===this.dnl.Id&&!(h.length<=0))if(1===h.length)UiLayer_1.UiLayer.SetShowMaskLayer("ScratchTicketMainView",!0),this.nSl(h[0]),this.C0l(),TimerSystem_1.TimerSystem.Delay(()=>{UiLayer_1.UiLayer.SetShowMaskLayer("ScratchTicketMainView",!1),this.v_l(r,c)},h[0].DelayInterval);else{this.nSl(h[0]);let t=h[0].DelayInterval,e=1,s=0;this.C0l(),UiLayer_1.UiLayer.SetShowMaskLayer("ScratchTicketMainView",!0);this.TDe=TimerSystem_1.TimerSystem.Forever(i=>{(s+=i)<t||(s%=t,e>=h.length?(UiLayer_1.UiLayer.SetShowMaskLayer("ScratchTicketMainView",!1),this.v_l(r,c),this.jm()):t=e===h.length-1?(this.nSl(h[e]),ActivityScratchTicketDefine_1.LAST_DELAY_INTERVAL):(this.nSl(h[e]),h[e].DelayInterval),e++)},ActivityScratchTicketDefine_1.FOREVER_DELAY_INTERVAL)}},this.Nhl=()=>{var i;2===this.dnl.GetRoundState()?(i=this.Dol.GetRoundDataList(),this.B7t.RefreshByData(i),this.Mnl()):this.pnl()},this.Jvt=()=>{this.CloseMe()},this.n8a=()=>new ScratchTicketConditionItem_1.ScratchTicketConditionItem,this.ynl=()=>{var i=new ScratchTicketTabItem_1.ScratchTicketTabItem;return i.SetClickToggleCallback(this.Cnl),i},this.Enl=()=>{var i=new ScratchTicketCellItem_1.ScratchTicketCellItem;return i.SetClickCallback(this.fnl),i},this.CreateRewardGridItem=()=>{return new ScratchTicketRewardItemGrid_1.ScratchTicketRewardItemGrid}}OnRegisterComponent(){this.ComponentRegisterInfos=[[0,UE.UIItem],[1,UE.UIItem],[2,UE.UIItem],[3,UE.UIVerticalLayout],[4,UE.UIVerticalLayout],[5,UE.UIGridLayout],[6,UE.UIItem],[7,UE.UIMultiTemplateLayout],[9,UE.UISprite],[8,UE.UIItem],[10,UE.UIItem]]}async OnBeforeStartAsync(){this.Dol=this.OpenParam,this.Dol instanceof ScratchTicketData_1.ScratchTicketData?(this.o8a=new GenericLayout_1.GenericLayout(this.GetVerticalLayout(3),this.n8a),this.cnl=new GenericLayout_1.GenericLayout(this.GetGridLayout(5),this.Enl),this.H3e=new GenericLayout_1.GenericLayout(this.GetMultiTemplateLayout(7),this.CreateRewardGridItem),this.lqe=new PopupCaptionItem_1.PopupCaptionItem(this.GetItem(6)),this.lqe.SetCloseCallBack(this.Jvt),await this.lqe.SetCurrencyItemList([this.Dol.GetCostItemId()]),this.gLt=new ActivityTitleTypeA_1.ActivityTitleTypeA,await this.gLt.CreateThenShowByActorAsync(this.GetItem(0).GetOwner()),this.hnl=new ActivityFunctionalTypeA_1.ActivityFunctionalTypeA(void 0),await this.hnl.CreateThenShowByActorAsync(this.GetItem(1).GetOwner()),await this.Inl(),await this.Ill(),this.pnl()):Log_1.Log.CheckError()&&Log_1.Log.Error("ScratchTicket",58,"ScratchTicketMainView无效输入")}OnAddEventListener(){EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnActivitySequenceEmitEvent,this.$An),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnScratchTicketConditionRefresh,this.tkl)}OnRemoveEventListener(){EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnActivitySequenceEmitEvent,this.$An),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnScratchTicketConditionRefresh,this.tkl)}GetGuideUiItemAndUiItemForShowEx(i){if(0!==i.length&&!isNaN(Number(i[0]))){i=Number(i[0]),i=this.cnl?.GetItemByIndex(i);if(void 0!==i)return[i,i]}}async Inl(){this.B7t=new GenericLayout_1.GenericLayout(this.GetVerticalLayout(4),this.ynl);var i=this.Dol.GetRoundDataList();await this.B7t.RefreshByDataAsync(i)}async Ill(){var i,t=this.Dol.GetFirstProgressRoundDataIndex();t<0||(i=this.Dol.GetRoundDataList(),this.mnl=this.B7t.GetLayoutItemByKey(t),this.mnl.SetSelect(!0,!1),this.dnl=i[t],i=this.dnl.GetCellDataList(),await this.cnl.RefreshByDataAsync(i))}Mnl(){var i=this.Dol.GetFirstProgressRoundDataIndex();i<0||this.B7t.GetLayoutItemByKey(i).SetSelect(!0,!0)}gnl(i){const t=i.GetDiagonalResultList();if(!(t.length<=0)){UiLayer_1.UiLayer.SetShowMaskLayer("ScratchTicketMainView",!0),this.nSl(t[0]),this.Snl(t[0].RewardList);let i=1;this.Wvl=TimerSystem_1.TimerSystem.Forever(()=>{i>=t.length?(UiLayer_1.UiLayer.SetShowMaskLayer("ScratchTicketMainView",!1),this.$vl()):(this.nSl(t[i]),i++)},ActivityScratchTicketDefine_1.REVEAL_DELAY_INTERVAL)}}pnl(){var i;this.Dol.GetScratchCardActivityConfig()&&this.Dol.LocalConfig&&(this.gLt.SetTitleByText(this.Dol.GetTitle()),this.H3e.RefreshByData(this.dnl.GetRemainRewardList()),this.FNe(),i=this.dnl.GetRoundState(),this.hnl.PanelLock.SetUiActive(0===i),this.hnl.PanelActivate.SetUiActive(2===i),this.hnl.FunctionButton.SetUiActive(!1),this.hnl.PanelActivate.SetTextByTextId("ScratchCardActivity_CompleteDesc"),i=this.dnl.Config.TogRoundIcon,this.SetSpriteByPath(i,this.GetSprite(9),!1,void 0),i=this.Dol.IsAllRoundFinish(),this.lqe.SetCurrencyItemVisible(!i),this.GetItem(10).SetUIActive(!i),this.GetItem(8).SetUIActive(i),i=this.Dol.GetConditionDataList(),this.o8a.RefreshByData(i))}FNe(){var i=this.Dol.EndOpenTime,t=TimeUtil_1.TimeUtil.GetServerTime(),i=Math.max(i-t,1);const e=TimeUtil_1.TimeUtil.GetRemainTimeDataFormat3(i),s=MultiTextLang_1.configMultiTextLang.GetLocalTextNew("ScratchCardActivity_TimeDesc");if(this.gLt.SetTimeTextByText(StringUtils_1.StringUtils.Format(s,e.CountDownText)),0===this.dnl.GetRoundState()){i=this.dnl.GetUnlockTime()*TimeUtil_1.TimeUtil.Millisecond-t,t=this.dnl.GetPreRoundState();if(0<i){const e=TimeUtil_1.TimeUtil.GetRemainTimeDataFormat3(i),s=StringUtils_1.StringUtils.Format(MultiTextLang_1.configMultiTextLang.GetLocalTextNew("ScratchCardActivity_NoJoinTips01"),e.CountDownText);this.hnl.PanelLock.SetTextByText(s)}else 2!==t?this.hnl.PanelLock.SetTextByTextId("ScratchCardActivity_NoJoinTips02"):this.hnl.PanelLock.SetTextByTextId("ScratchCardActivity_NoJoinTips03")}}OnTick(i){this.e8+=i,this.e8>=TimeUtil_1.TimeUtil.InverseMillisecond&&(this.FNe(),this.e8%=TimeUtil_1.TimeUtil.InverseMillisecond)}OnBeforeHide(){UiLayer_1.UiLayer.SetShowMaskLayer("ScratchTicketMainView",!1),this.jm(),this.$vl()}jm(){TimerSystem_1.TimerSystem.Has(this.TDe)&&(TimerSystem_1.TimerSystem.Remove(this.TDe),this.TDe=void 0)}$vl(){TimerSystem_1.TimerSystem.Has(this.Wvl)&&(TimerSystem_1.TimerSystem.Remove(this.Wvl),this.Wvl=void 0)}C0l(){TimerSystem_1.TimerSystem.Delay(()=>{this.PlaySequence("Shake")},ActivityScratchTicketDefine_1.SHOW_SHAKE_INTERVAL)}Kvl(i,t){var i=this.Dol.GetRoundDataIndex(i),t=this.Dol.GetRoundDataIndex(t),e=i<t,s=Math.min(i,t),i=Math.max(i,t);1===i&&0===s&&this.UiViewSequence.PlaySequencePurely("SwitchA",!0,e),2===i&&0===s&&this.UiViewSequence.PlaySequencePurely("SwitchB",!0,e),2===i&&1===s&&this.UiViewSequence.PlaySequencePurely("SwitchC",!0,e)}Qvl(i){i=this.Dol.GetRoundDataIndex(i);1===i?this.UiViewSequence.PlaySequencePurely("SwitchA",!0):2===i&&this.UiViewSequence.PlaySequencePurely("SwitchB",!0)}v_l(i,t){0===i?(ActivityScratchTicketController_1.ActivityScratchTicketController.ShowScratchTicketRewardTip(t),this.Nhl()):ItemRewardController_1.ItemRewardController.OpenCommonRewardView(ActivityScratchTicketDefine_1.SCRATCH_TICKET_REWRAD_CONFIG_ID,t,this.Nhl)}nSl(i){0<i.RewardList.length&&this.Snl(i.RewardList),"Empty"!==i.SequenceName&&this.UiViewSequence.PlaySequence(i.SequenceName)}Snl(i){for(const s of i){var t=this.cnl.GetLayoutItemByKey(s.Index),e=this.dnl.GetCellDataByIndex(s.Index);void 0!==t&&t.RefreshByResultData(e,s)}}}exports.ScratchTicketMainView=ScratchTicketMainView;
//# sourceMappingURL=ScratchTicketMainView.js.map