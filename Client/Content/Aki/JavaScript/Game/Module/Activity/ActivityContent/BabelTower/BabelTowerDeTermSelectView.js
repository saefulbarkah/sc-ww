
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BabelTowerDeTermSelectView=void 0;const UE=require("ue"),ConfigManager_1=require("../../../../Manager/ConfigManager"),ControllerHolder_1=require("../../../../Manager/ControllerHolder"),ModelManager_1=require("../../../../Manager/ModelManager"),RedDotController_1=require("../../../../RedDot/RedDotController"),UiViewBase_1=require("../../../../Ui/Base/UiViewBase"),PopupCaptionItem_1=require("../../../../Ui/Common/PopupCaptionItem"),UiManager_1=require("../../../../Ui/UiManager"),ConfirmBoxDefine_1=require("../../../ConfirmBox/ConfirmBoxDefine"),LguiUtil_1=require("../../../Util/LguiUtil"),GenericScrollViewNew_1=require("../../../Util/ScrollView/GenericScrollViewNew"),BabelTowerController_1=require("./BabelTowerController"),BabelTowerDeTermSelectDesItem_1=require("./BabelTowerDeTermSelectDesItem"),BabelTowerDeTermSelectItem_1=require("./BabelTowerDeTermSelectItem");class BabelTowerDeTermSelectView extends UiViewBase_1.UiViewBase{constructor(){super(...arguments),this.lqe=void 0,this.yq=0,this.cic=void 0,this.rmc=[],this.uic=void 0,this.L3e=()=>{const e=[];var r,i,t,o=ModelManager_1.ModelManager.BabelTowerModel.DeTermSelectInfo;let a=0;for([r,i]of o)2===i&&e.push(r),2!==i&&3!==i||(t=ConfigManager_1.ConfigManager.BabelTowerConfig.GetBabelTowerDeTerm(r),a+=t.Star);a<ConfigManager_1.ConfigManager.BabelTowerConfig.GetBabelTowerLevelConfig(this.yq).PassStar?((o=new ConfirmBoxDefine_1.ConfirmBoxDataNew(277)).FunctionMap.set(2,()=>{this.omc(e,a)}),ControllerHolder_1.ControllerHolder.ConfirmBoxController.ShowConfirmBoxNew(o)):this.omc(e,a)},this.omc=(e,o)=>{BabelTowerController_1.BabelTowerController.SelectBabelActivityDeTermRequest(this.yq,e).then(e=>{if(e){var e=ConfigManager_1.ConfigManager.BabelTowerConfig.GetBabelTowerLevelConfig(this.yq),r=BabelTowerController_1.BabelTowerController.GetBabelTowerData(),r=(e.IsDifficult?r.HardLevelDataMap:r.NormalLevelDataMap).get(this.yq),i=[],t=r?.LX_??[];for(let e=0;e<3;e++)t.length>e?i.push(t[e]):i.push(0);r={BabelTowerLevelId:this.yq,InstanceId:e.InstId,RoleList:i,BuffList:r?.Dks??[-1,-1],BuffCount:e.OptionalBabelBuffNum,StarNumber:o};UiManager_1.UiManager.OpenView("BabelTowerLevelInfoView",r)}})},this.Ud_=()=>{UiManager_1.UiManager.OpenView("BabelTowerQuestView")},this.dic=()=>{var e=ConfigManager_1.ConfigManager.BabelTowerConfig.GetBabelTowerLevelConfig(this.yq);UiManager_1.UiManager.OpenView("InstanceDungeonMonsterPreView",e.InstId)},this.KAt=()=>{var e=new ConfirmBoxDefine_1.ConfirmBoxDataNew(271);e.FunctionMap.set(2,()=>{var e,r,i=ModelManager_1.ModelManager.BabelTowerModel.DeTermSelectInfo;for([e,r]of i)3!==r&&i.set(e,0);for(const t of this.cic.GetScrollItemList())t.ClearSelect();this.vic()}),ControllerHolder_1.ControllerHolder.ConfirmBoxController.ShowConfirmBoxNew(e)},this.mic=()=>{return new BabelTowerDeTermSelectItem_1.BabelTowerDeTermSelectItem},this.fic=()=>{var e=new BabelTowerDeTermSelectDesItem_1.BabelTowerDeTermSelectDesItem;return e.OnClickCallBack=this.nmc,e},this.gic=e=>{this.Cic(e)},this.nmc=r=>{for(let e=0;e<this.rmc.length;e++){var i;this.rmc[e].AllDeTerm.includes(r)&&(i=this.cic.GetItemByIndex(e),this.cic.ScrollTo(i),this.cic.GetScrollItemByIndex(e)?.PlayPositionSequence(r))}}}OnRegisterComponent(){this.ComponentRegisterInfos=[[0,UE.UIItem],[1,UE.UIButtonComponent],[2,UE.UIScrollViewWithScrollbarComponent],[3,UE.UIItem],[4,UE.UIButtonComponent],[5,UE.UIScrollViewWithScrollbarComponent],[6,UE.UIItem],[14,UE.UIItem],[15,UE.UIText],[10,UE.UIText],[7,UE.UIItem],[8,UE.UIText],[9,UE.UIText],[11,UE.UIItem],[12,UE.UIText],[13,UE.UIArtText],[16,UE.UIButtonComponent],[17,UE.UIButtonComponent],[18,UE.UIText],[19,UE.UIItem],[20,UE.UIItem]],this.BtnBindInfo=[[17,this.L3e],[4,this.KAt],[16,this.Ud_],[1,this.dic]]}async OnBeforeStartAsync(){this.lqe=new PopupCaptionItem_1.PopupCaptionItem,await this.lqe.CreateThenShowByActorAsync(this.GetItem(0).GetOwner()),this.lqe.SetCloseCallBack(()=>{this.CloseMe()}),this.cic=new GenericScrollViewNew_1.GenericScrollViewNew(this.GetScrollViewWithScrollbar(2),this.mic),this.uic=new GenericScrollViewNew_1.GenericScrollViewNew(this.GetScrollViewWithScrollbar(5),this.fic)}OnStart(){RedDotController_1.RedDotController.BindRedDot("BabelTowerQuestRedDot",this.GetItem(20)),this.yq=this.OpenParam,this.GetText(9).SetUIActive(!1),ModelManager_1.ModelManager.BabelTowerModel.DeTermSelectInfo.clear(),this.vic(),this.GetScrollViewWithScrollbar(2).Content.GetComponentByClass(UE.UIInturnAnimController.StaticClass())?.Play(),this.GetScrollViewWithScrollbar(5).Content.GetComponentByClass(UE.UIInturnAnimController.StaticClass())?.Play()}OnBeforeShow(){this.Og()}Og(){var e,r=ConfigManager_1.ConfigManager.BabelTowerConfig.GetBabelTowerLevelConfig(this.yq);LguiUtil_1.LguiUtil.SetLocalTextNew(this.GetText(8),r.NameText),this.GetItem(19).SetUIActive(r.IsDifficult),r.IsDifficult?(e=BabelTowerController_1.BabelTowerController.GetBabelTowerData().HardLevelDataMap.get(this.yq)?.wX_??0,this.GetText(10).SetText(e+""),LguiUtil_1.LguiUtil.SetLocalTextNew(this.GetText(18),"BabelTowerHardStar")):(this.GetText(10).SetText(r.PassStar+""),LguiUtil_1.LguiUtil.SetLocalTextNew(this.GetText(18),"BabelTowerNormalStar"))}vic(){var i=ConfigManager_1.ConfigManager.BabelTowerConfig.GetBabelTowerLevelConfig(this.yq),t=(this.rmc=[],BabelTowerController_1.BabelTowerController.GetBabelTowerData()),o=t.GetDailyLevel().includes(this.yq)?t.GetDailyDeTerm():[];if(0<i.FixBabelDeTermds?.length){let e=[],r=ConfigManager_1.ConfigManager.BabelTowerConfig.GetBabelTowerDeTerm(i.FixBabelDeTermds[0]).GroupId;for(const n of i.FixBabelDeTermds){var a,s=ConfigManager_1.ConfigManager.BabelTowerConfig.GetBabelTowerDeTerm(n);for(s.GroupId!==r&&(a={IsNecessary:!0,AllDeTerm:e,DailyDeTerm:o,OnChangeSelectDeTerm:this.gic},this.rmc.push(a),r=s.GroupId,e=[]);s.Star>e.length+1;)e.push(0);e.push(n),ModelManager_1.ModelManager.BabelTowerModel.DeTermSelectInfo.set(n,3)}t={IsNecessary:!0,AllDeTerm:e,DailyDeTerm:o,OnChangeSelectDeTerm:this.gic};this.rmc.push(t)}var e=[];for(const l of i.BabelTowerDeTermMutexArray){e=[];for(const h of ConfigManager_1.ConfigManager.BabelTowerConfig.GetBabelTowerDeTermMutual(l).MutexDeTermGroup)e.push(...this.rhc(h));var r={IsNecessary:!1,AllDeTerm:e,DailyDeTerm:o,OnChangeSelectDeTerm:this.gic};this.rmc.push(r)}this.cic?.RefreshByData(this.rmc),this.Cic()}rhc(e){var r=BabelTowerController_1.BabelTowerController.GetBabelTowerData(),i=[],t=[];for(const s of ConfigManager_1.ConfigManager.BabelTowerConfig.GetBabelTowerDeTermByGroupId(e))t.push(s);t.sort((e,r)=>e.Line!==r.Line?e.Line-r.Line:e.Star-r.Star);let o=1,a=1;for(const n of t){for(a!==n.Line&&(a=n.Line,o=1);n.Star>o;)i.push(0),o++;i.push(n.Id),r.GetDeTermIsLock(n.Id)?ModelManager_1.ModelManager.BabelTowerModel.DeTermSelectInfo.set(n.Id,1):r.GetDeTermIsUse(this.yq,n.Id)?ModelManager_1.ModelManager.BabelTowerModel.DeTermSelectInfo.set(n.Id,2):ModelManager_1.ModelManager.BabelTowerModel.DeTermSelectInfo.set(n.Id,0),o++}for(;o<=3;)i.push(0),o++;return i}Cic(r){var e=[];let i=0;for(const[r,s]of ModelManager_1.ModelManager.BabelTowerModel.DeTermSelectInfo)if(0!==r&&(2===s||3===s)){e.push(r);const o=ConfigManager_1.ConfigManager.BabelTowerConfig.GetBabelTowerDeTerm(r);i+=o.Star}e.sort((e,r)=>{e=ConfigManager_1.ConfigManager.BabelTowerConfig.GetBabelTowerDeTerm(e);return ConfigManager_1.ConfigManager.BabelTowerConfig.GetBabelTowerDeTerm(r).Star-e.Star}),this.uic?.RefreshByData(e,()=>{if(r)for(const e of this.uic.GetScrollItemList())e.DeTermId===r&&(this.uic?.LateScrollTo(e.GetRootItem()),e.PlayChoseSequence())}),this.GetArtText(13).SetText((i<10?"0":"")+i);var t=i<ConfigManager_1.ConfigManager.BabelTowerConfig.GetBabelTowerLevelConfig(this.yq).PassStar;this.GetItem(11).SetUIActive(t),this.GetItem(7).SetUIActive(e.length<=0);const o=ConfigManager_1.ConfigManager.BabelTowerConfig.GetBabelTowerLevelConfig(this.yq);var a,t=ModelManager_1.ModelManager.BabelTowerModel.CalculateDifficultyConfigByStarNum(o.ActivityId,i);t&&(a=UE.Color.FromHex(t.TextBgColor),this.GetItem(14).SetColor(a),LguiUtil_1.LguiUtil.SetLocalTextNew(this.GetText(15),t.DifficultyTextKey))}}exports.BabelTowerDeTermSelectView=BabelTowerDeTermSelectView;
//# sourceMappingURL=BabelTowerDeTermSelectView.js.map