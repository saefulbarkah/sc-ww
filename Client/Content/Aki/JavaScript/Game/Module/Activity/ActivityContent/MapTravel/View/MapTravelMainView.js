
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MapTravelMainView=void 0;const UE=require("ue"),CommonParamById_1=require("../../../../../../Core/Define/ConfigCommon/CommonParamById"),PropRewardConfById_1=require("../../../../../../Core/Define/ConfigQuery/PropRewardConfById"),MathUtils_1=require("../../../../../../Core/Utils/MathUtils"),StringUtils_1=require("../../../../../../Core/Utils/StringUtils"),EventDefine_1=require("../../../../../Common/Event/EventDefine"),EventSystem_1=require("../../../../../Common/Event/EventSystem"),ConfigManager_1=require("../../../../../Manager/ConfigManager"),UiViewBase_1=require("../../../../../Ui/Base/UiViewBase"),PopupCaptionItem_1=require("../../../../../Ui/Common/PopupCaptionItem"),LevelSequencePlayer_1=require("../../../../Common/LevelSequencePlayer"),GenericLayout_1=require("../../../../Util/Layout/GenericLayout"),LguiUtil_1=require("../../../../Util/LguiUtil"),ActivitySmallItemGrid_1=require("../../UniversalComponents/ActivitySmallItemGrid"),ActivityButtonItem_1=require("../../UniversalComponents/Functional/ActivityButtonItem"),ActivityFunctionalTypeA_1=require("../../UniversalComponents/Functional/ActivityFunctionalTypeA"),ActivityMapTravelController_1=require("../ActivityMapTravelController"),MapTravelSubViewButton_1=require("./Component/MapTravelSubViewButton"),MapTravelSubViewPhantomCollect_1=require("./Component/MapTravelSubViewPhantomCollect"),MapTravelSubViewPhantomQuest_1=require("./Component/MapTravelSubViewPhantomQuest"),MapTravelSubViewSoarChallenge_1=require("./Component/MapTravelSubViewSoarChallenge"),MapTravelSubViewTravelTask_1=require("./Component/MapTravelSubViewTravelTask"),SPINE_PLAY_TIME_SCALE=1.5,openTweenGroupDefine=[0,-1,-1,1],closeTweenGroupDefine=[1,-1,0,-1],SPINE_LAYER_WIDTH=2520;class MapTravelMainView extends UiViewBase_1.UiViewBase{constructor(){super(...arguments),this.nol=void 0,this.E4l=void 0,this.I4l=void 0,this.T4l=void 0,this.b4l=void 0,this.L4l=void 0,this.A4l=new Map,this.SubViewProxyMap=new Map,this.ActivityBaseData=void 0,this.R4l=0,this.x4l=-1,this.r5l=!1,this.o5l=0,this.B8l=new UE.Rotator(0,0,0),this.BgOffset=0,this.BgScale=1,this.BgLocation=void 0,this.w4l=()=>{0===this.R4l?this.CloseMe():this.P4l()},this.$An=t=>{"LevelChange"===t&&this.o4l(this.x4l)},this.U4l=()=>{this.x4l=this.x4l-1,this.UiViewSequence.PlaySequence("SwitchLeft",!0)},this.D4l=()=>{this.x4l=this.x4l+1,this.UiViewSequence.PlaySequence("SwitchRight",!0)},this.B4l=()=>{ActivityMapTravelController_1.ActivityMapTravelController.RequestMapTravelLevelUp(t=>{this.r5l=t})},this.dvt=t=>{0===this.R4l&&("CommonRewardView"===t&&(0<this.o5l?this.n5l():this.q4l()),"RoleLevelUpSuccessAttributeView"===t)&&this.q4l()},this.OnOpenSubView=t=>{this.k4l(t)}}OnRegisterComponent(){this.ComponentRegisterInfos=[[0,UE.UIItem],[1,UE.UIText],[2,UE.UITexture],[3,UE.UIText],[4,UE.UIButtonComponent],[5,UE.UIButtonComponent],[6,UE.UIItem],[7,UE.UIMultiTemplateLayout],[8,UE.UIItem],[9,UE.UIItem],[10,UE.UIText],[11,UE.UIItem],[12,UE.UIItem],[13,UE.UIItem],[14,UE.UIItem],[15,UE.UIItem],[16,UE.UIItem],[17,UE.UIItem],[18,UE.UIItem],[19,UE.UITexture],[20,UE.UIItem],[21,UE.UIItem],[22,UE.SpineSkeletonAnimationComponent],[23,UE.UIItem],[24,UE.UIItem],[25,UE.UIItem],[26,UE.UIItem],[27,UE.UIItem]],this.BtnBindInfo=[[4,this.U4l],[5,this.D4l]]}async OnBeforeStartAsync(){var t;this.ActivityBaseData=this.OpenParam,this.ActivityBaseData&&(t=[],this.nol=new PopupCaptionItem_1.PopupCaptionItem,t.push(this.nol.CreateThenShowByActorAsync(this.GetItem(0).GetOwner())),this.nol.SetCloseCallBack(this.w4l),this.E4l=new LevelSequencePlayer_1.LevelSequencePlayer(this.GetItem(0)),this.T4l=new ActivityFunctionalTypeA_1.FunctionalPanelConditionLock,t.push(this.T4l.CreateByActorAsync(this.GetItem(13).GetOwner())),this.b4l=new ActivityFunctionalTypeA_1.FunctionalPanelConditionActivate,t.push(this.b4l.CreateByActorAsync(this.GetItem(12).GetOwner())),this.L4l=new ActivityButtonItem_1.ActivityButtonItem,t.push(this.L4l.CreateByActorAsync(this.GetItem(11).GetOwner())),this.L4l.SetFunction(this.B4l),t.push(this.G4l()),this.I4l=new GenericLayout_1.GenericLayout(this.GetMultiTemplateLayout(7),()=>new ActivitySmallItemGrid_1.ActivitySmallItemGrid),await Promise.all(t))}async G4l(){var t,i,e=[];for([t,i]of[[1,14],[2,15],[3,16],[4,17]]){var s=new MapTravelSubViewButton_1.MapTravelSubViewButton(t);e.push(s.CreateThenShowByActorAsync(this.GetItem(i).GetOwner())),this.A4l.set(t,s),s.SetFunction(this.OnOpenSubView)}await Promise.all(e)}OnStart(){this.L4l.SetRedDotVisible(!0),this.x4l=this.ActivityBaseData.TravelLevel;var t=this.ActivityBaseData.GetActivityConfig(),t=(this.nol.SetTitleByTextIdAndArgNew(t.TabName.get(0)),this.GetSpine(22).SetTimeScale(SPINE_PLAY_TIME_SCALE),this.GetItem(25)),i=this.GetItem(27),e=i.K2_GetComponentLocation(),s=(this.BgOffset=Math.abs(t.K2_GetComponentLocation().X-e.X),SPINE_LAYER_WIDTH);this.BgScale=(this.BgOffset+s)/s*i.K2_GetComponentScale().X,this.BgLocation=this.GetItem(27).K2_GetComponentLocation(),this.BgLocation=new UE.Vector(t.K2_GetComponentLocation().X,e.Y,t.K2_GetComponentLocation().Z)}OnBeforeShow(){this.D5e()}OnBeforeDestroy(){this.B8l=void 0,this.BgLocation=void 0}OnAddEventListener(){EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnActivitySequenceEmitEvent,this.$An),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.CloseView,this.dvt)}OnRemoveEventListener(){EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnActivitySequenceEmitEvent,this.$An),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.CloseView,this.dvt)}D5e(){this.o4l(this.x4l),this.O4l()}o4l(t){var i=t<this.ActivityBaseData.TravelLevel,e=(t<this.ActivityBaseData.TravelLevel?this.F4l(t):t===this.ActivityBaseData.TravelLevel?this.N4l(t):this.V4l(t),this.ActivityBaseData.TravelLevelData.get(t)),e=ConfigManager_1.ConfigManager.ActivityMapTravelConfig.GetLevelExpConfig(e.Id),s=(this.GetText(1).SetText(t.toString()),this.o5l=0,CommonParamById_1.configCommonParamById.GetIntConfig("FlyStrengthItemId")),h=[];for(const a of 0<e.RewardDropId?ConfigManager_1.ConfigManager.RewardConfig.GetDropPackagePreviewItemList(e.RewardDropId):[]){var r={Item:a,HasClaimed:i};h.push(r),a[0].ItemId===s&&this.o5l++}this.I4l.RefreshByData(h),this.GetItem(6).SetUIActive(0<h.length),this.GetItem(9).SetUIActive(!StringUtils_1.StringUtils.IsEmpty(e.TipsLock)),StringUtils_1.StringUtils.IsEmpty(e.TipsLock)||(e=i?e.TipsDone:e.TipsLock,LguiUtil_1.LguiUtil.SetLocalTextNew(this.GetText(10),e)),this.GetButton(4).RootUIComp.SetUIActive(0<t),this.GetButton(5).RootUIComp.SetUIActive(t<this.ActivityBaseData.MaxTravelLevel)}j4l(t,i){this.q8l(t/i),LguiUtil_1.LguiUtil.SetLocalTextNew(this.GetText(3),"MapTravelExpYellow_Text",t,i),this.GetText(3).SetUIActive(!0)}q8l(t){var t=MathUtils_1.MathUtils.Clamp(t,0,1),i=(this.GetTexture(2).SetFillAmount(t),360*(1-t));this.B8l.Yaw=i,this.GetItem(24).SetUIActive(.5<t),this.GetItem(23).SetUIRelativeRotation(this.B8l),this.GetItem(24).SetUIRelativeRotation(this.B8l)}F4l(t){var t=this.ActivityBaseData.TravelLevelData.get(t),i=t.TargetExp,t=t.TargetExp;this.j4l(i,t),this.T4l.SetUiActive(!1),this.b4l.SetUiActive(!0),this.L4l.SetUiActive(!1),this.b4l.SetTextByTextId("MapTravelReward_Get")}N4l(t){var t=this.ActivityBaseData.MaxTravelLevel===t,i=!t&&this.ActivityBaseData.CanTravelLevelUp(),e=this.ActivityBaseData.GetCurrentExp(),s=this.ActivityBaseData.GetCurrentTargetExp();t?(this.q8l(1),LguiUtil_1.LguiUtil.SetLocalTextNew(this.GetText(3),"MapTravelLevelMaxYellow_Text"),this.GetText(3).SetUIActive(!0)):this.j4l(e,s),this.T4l.SetUiActive(!t&&!i),this.T4l.SetTextByTextId("PrefabTextItem_2462272635_Text"),this.b4l.SetUiActive(t),this.L4l.SetUiActive(i),t&&this.b4l.SetTextByTextId("MapTravelLv_Max"),i&&this.UiViewSequence.PlaySequence("PreLevelUp")}V4l(t){var i=this.ActivityBaseData.TravelLevelData.get(t),t=this.ActivityBaseData.MaxTravelLevel===t,i=t?i.AccumulateExp:i.TargetExp;t?(this.q8l(0),this.GetText(3).SetUIActive(!1)):this.j4l(0,i),this.T4l.SetUiActive(!0),this.T4l.SetTextByTextId("MapTravelLevelOverUp_Text"),this.b4l.SetUiActive(!1),this.L4l.SetUiActive(!1)}q4l(){this.r5l&&(this.UiViewSequence.PlaySequence("LevelUp",!1),this.x4l=this.x4l+1,this.o4l(this.x4l),this.O4l())}n5l(){var i=CommonParamById_1.configCommonParamById.GetIntConfig("FlyStrengthItemId"),i=ConfigManager_1.ConfigManager.InventoryConfig.GetItemConfig(i);if(i&&i.Parameters){let t=0;for(var[,e]of i.Parameters){t=e;break}if(0!==t){i=PropRewardConfById_1.configPropRewardConfById.GetConfig(t);if(i){let t=0;for(const s of i.Props)if(10===s.Id){t=s.Value;break}0!==t&&(t*=this.o5l,ActivityMapTravelController_1.ActivityMapTravelController.OpenSoarStrengthView(t))}}}}O4l(){var t,i,e=this.ActivityBaseData.GetActivityConfig();for([t,i]of this.A4l.entries()){var[s,h]=this.ActivityBaseData.GetTypeProgress(t),r=Math.ceil(s/h*100),r=(i.SetProgressText(r+"%"),i.SetProgressTextChangeColor(s!==h),i.SetNameTextId(e.TabName.get(t)),this.ActivityBaseData.GetTypeRedDotState(t)),a=this.ActivityBaseData.GetTypeNewState(t);i.SetItemNew(!r&&a),i.RefreshRedDot(r),i.SetItemDone(s===h)}}async H4l(t){var i=this.SubViewProxyMap.get(t);if(!i){var e=this.GetItem(18);switch(t){case 1:var s=new MapTravelSubViewTravelTask_1.MapTravelSubViewTravelTask(this.ActivityBaseData),s=(await s.CreateByResourceIdAsync("UiItem_TravelMapTask",e),{Type:t,SpineSkinName:"Green",UiProxy:s});return this.SubViewProxyMap.set(t,s),s;case 2:s=new MapTravelSubViewPhantomQuest_1.MapTravelSubViewQuest(this.ActivityBaseData),s=(await s.CreateByResourceIdAsync("UiItem_TravelMapPhantomTask",e),{Type:t,SpineSkinName:"Blue",UiProxy:s});return this.SubViewProxyMap.set(t,s),s;case 3:s=new MapTravelSubViewPhantomCollect_1.MapTravelSubViewPhantomCollect(this.ActivityBaseData),s=(await s.CreateByResourceIdAsync("UiItem_TravelMapPhantomCollect",e),{Type:t,SpineSkinName:"Grey",UiProxy:s});return this.SubViewProxyMap.set(t,s),s;case 4:s=new MapTravelSubViewSoarChallenge_1.MapTravelSubViewSoarChallenge(this.ActivityBaseData),s=(await s.CreateByResourceIdAsync("UiItem_TravelMapSoarChallenge",e),{Type:t,SpineSkinName:"Orange",UiProxy:s});return this.SubViewProxyMap.set(t,s),s}}return i}async k4l(t){this.R4l=t;const i=await this.H4l(t);if(i){const e=this.ActivityBaseData.GetActivityConfig();this.SetTextureShowUntilLoaded(e.TabIcon.get(t),this.GetTexture(19));this.G1a(t,!0),this.GetSpine(22).SetSkin(i.SpineSkinName),this.GetSpine(22).SetAnimation(0,"AniOpen",!1).AnimationComplete.Add(()=>{this.nol.SetTitleByTextIdAndArgNew(e.TabName.get(t)),this.E4l.PlayLevelSequenceByName("Start",!1),i.UiProxy.SetActive(!0),i.UiProxy.PlayStartSequence()}),this.E4l.PlayLevelSequenceByName("Close"),this.UiViewSequence.PlaySequence("AniOpen",!0)}}async P4l(){var t=this.R4l;const i=await this.H4l(t);i&&(i.UiProxy.NeedDestroySelf&&this.SubViewProxyMap.delete(t),this.D5e(),i.UiProxy.PlayCloseSequence().finally(()=>{i.UiProxy.SetActive(!1)}),this.G1a(t,!1),this.GetSpine(22).SetSkin(i.SpineSkinName),this.GetSpine(22).SetAnimation(0,"AniClose",!1).AnimationComplete.Add(()=>{var t=this.ActivityBaseData.GetActivityConfig();this.nol.SetTitleByTextIdAndArgNew(t.TabName.get(0)),this.E4l.PlayLevelSequenceByName("Start",!1),i.UiProxy.NeedDestroySelf&&i.UiProxy.Destroy()}),this.E4l.PlayLevelSequenceByName("Close"),this.UiViewSequence.PlaySequence("AniClose",!0),this.R4l=0)}G1a(i,e){var s=(e?this.GetItem(20):this.GetItem(21)).GetOwner().K2_GetComponentsByClass(UE.LGUIPlayTweenComponent.StaticClass()),h=s.Num(),r=e?openTweenGroupDefine:closeTweenGroupDefine;for(let t=0;t<h;t++){var a=s.Get(t);switch(r[t]){case 1:var n=a.GetPlayTween(),o=this.A4l.get(i).GetIconItem().K2_GetComponentLocation();e?(this.c7l(n,o,!0),this.c7l(n,this.BgLocation,!1)):(this.c7l(n,this.BgLocation,!0),this.c7l(n,o,!1));break;case 0:n=a.GetPlayTween();this.c7l(n,new UE.Vector(this.BgScale,this.BgScale,this.BgScale),!e)}a.Stop(),a.Play()}}c7l(t,i,e){e?t.from=i:t.to=i}}exports.MapTravelMainView=MapTravelMainView;
//# sourceMappingURL=MapTravelMainView.js.map