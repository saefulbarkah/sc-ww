
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ActivityRecallHelper=void 0;const Log_1=require("../../../../../../Core/Common/Log"),MapMarkByMarkId_1=require("../../../../../../Core/Define/ConfigQuery/MapMarkByMarkId"),StringUtils_1=require("../../../../../../Core/Utils/StringUtils"),LocalStorage_1=require("../../../../../Common/LocalStorage"),LocalStorageDefine_1=require("../../../../../Common/LocalStorageDefine"),ConfigManager_1=require("../../../../../Manager/ConfigManager"),ModelManager_1=require("../../../../../Manager/ModelManager"),UiManager_1=require("../../../../../Ui/UiManager"),AdventureGuideController_1=require("../../../../AdventureGuide/AdventureGuideController"),LogReportController_1=require("../../../../LogReport/LogReportController"),LogReportDefine_1=require("../../../../LogReport/LogReportDefine"),ScrollingTipsController_1=require("../../../../ScrollingTips/ScrollingTipsController"),WorldMapController_1=require("../../../../WorldMap/WorldMapController"),ActivityManager_1=require("../../../ActivityManager"),ActivityRecallDefine_1=require("../ActivityRecallDefine");class ActivityRecallHelper{static get ActivityRecallData(){var e=ModelManager_1.ModelManager.ActivityRecallModel.ActivityId;return ModelManager_1.ModelManager.ActivityModel.GetActivityById(e)}static get ActivityRecallController(){return ActivityManager_1.ActivityManager.GetActivityController(ActivityRecallHelper.ActivityRecallData.Type)}static get IsActivityOpen(){return!!ActivityRecallHelper.ActivityRecallData&&ActivityRecallHelper.ActivityRecallData.IsActivityOpen()}static get ActivityRecallFirstShow(){var e,r;return void 0===ActivityRecallHelper.WQa&&(e=LocalStorage_1.LocalStorage.GetPlayer(LocalStorageDefine_1.ELocalStoragePlayerKey.ActivityRecallWatchFirstShowTime),r=ActivityRecallHelper.ActivityRecallData.EndShowTime,ActivityRecallHelper.WQa=void 0===e||e<r),ActivityRecallHelper.WQa}static set ActivityRecallFirstShow(e){var r;ActivityRecallHelper.WQa!==e&&(e||(r=ActivityRecallHelper.ActivityRecallData.EndShowTime,LocalStorage_1.LocalStorage.SetPlayer(LocalStorageDefine_1.ELocalStoragePlayerKey.ActivityRecallWatchFirstShowTime,r)),ActivityRecallHelper.WQa=e)}static get IsActivityRecallReady(){return 0!==ModelManager_1.ModelManager.ActivityRecallModel.ActivityId&&void 0!==ActivityRecallHelper.ActivityRecallData}static RefreshItemGrid(e,r,t,[i,a,l]){var o=r.Id;switch(ConfigManager_1.ConfigManager.InventoryConfig.GetItemDataTypeByConfigId(o)){case 1:var c=ConfigManager_1.ConfigManager.RoleConfig.GetRoleConfig(o),c={Data:r,ElementId:c.ElementId,Type:2,ItemConfigId:o,BottomText:t.toString(),QualityId:c.QualityId,IsLockVisible:i,IsReceivableVisible:a,IsReceivedVisible:l};e.Apply(c);break;case 3:c={Data:r,Type:3,ItemConfigId:o,BottomText:t.toString(),IsLockVisible:i,IsReceivableVisible:a,IsReceivedVisible:l};e.Apply(c);break;default:c={Data:r,Type:4,ItemConfigId:o,BottomText:t.toString(),IsLockVisible:i,IsReceivableVisible:a,IsReceivedVisible:l};e.Apply(c)}}static RequestAllScoreRewards(){var e=ConfigManager_1.ConfigManager.ActivityRecallConfig.GetAllRecallScoreRewardConfigList();const t=ActivityRecallHelper.ActivityRecallData,i=[];e.forEach(e=>{var r=e.Id;1===t.GetRecallTaskScoreRewardState(e)&&i.push(r)}),0<i.length&&ActivityRecallHelper.ActivityRecallController.RequestClaimScoreReward(i)}static IsRecallEntryType(e){return 1===e||0===e||2===e||3===e}static RecallTaskJump(e){var r=e.TaskType,t=e.TaskSubType;if(r===ActivityRecallDefine_1.EActivityRecallTaskType.Constant){if(1===t)return this.Hda(e);if(2===t)return this.jda(e)}if(r===ActivityRecallDefine_1.EActivityRecallTaskType.DailyA||r===ActivityRecallDefine_1.EActivityRecallTaskType.DailyB){if(4===t)return this.Wda(e);if(3===t)return this.Qda(e)}return Log_1.Log.CheckWarn()&&Log_1.Log.Warn("ActivityRecall",63,"[回流活动]ActivityRecallHelper->RecallTaskJump 没有定义该类型的回流活动任务跳转！",["recallTaskType: ",r],["recallTaskSubType: ",t],["config: ",e]),!1}static Hda(e){var r=ActivityRecallHelper.GetFirstMainLineUnFinishTaskId();return void 0===r?(ScrollingTipsController_1.ScrollingTipsController.ShowTipsByTextId("RecallActivity_Tips_01"),!1):(UiManager_1.UiManager.OpenView("QuestView",r),!0)}static jda(e){var r=ActivityRecallHelper.GetFirstShowRoleQuest();return void 0===r?(ScrollingTipsController_1.ScrollingTipsController.ShowTipsByTextId("RecallActivity_Role_Precondition"),!1):(UiManager_1.UiManager.OpenView("QuestView",r.Id),!0)}static GetFirstShowRoleQuest(){var e=ModelManager_1.ModelManager.QuestNewModel.GetQuestsByType(3);e.sort((e,r)=>{var t=ConfigManager_1.ConfigManager.QuestNewConfig.GetQuestMainTypeConfig(e.MainTypeId),i=ConfigManager_1.ConfigManager.QuestNewConfig.GetQuestMainTypeConfig(r.MainTypeId);return t&&i?t.SortValue!==i.SortValue?t.SortValue-i.SortValue:e.Id-r.Id:0});for(const r of e)if(r.CanShowInUiPanel())return r}static Wda(e){var r=ModelManager_1.ModelManager.TrainingDegreeModel.GetTrainingDataList();if(void 0===r)return AdventureGuideController_1.AdventureGuideController.OpenGuideView("NewSoundAreaView"),!1;r.sort((e,r)=>{var t=StringUtils_1.StringUtils.IsEmpty(e.TipsId)?0:1,i=StringUtils_1.StringUtils.IsEmpty(r.TipsId)?0:1;return t!=i?i-t:e.FillAmount-r.FillAmount});r=r[0];return 0===r.TrainingType||1===r.TrainingType?(AdventureGuideController_1.AdventureGuideController.OpenGuideView("NewSoundAreaView",19),!0):3===r.TrainingType?(AdventureGuideController_1.AdventureGuideController.OpenGuideView("NewSoundAreaView",4),!0):2===r.TrainingType&&(AdventureGuideController_1.AdventureGuideController.OpenGuideView("NewSoundAreaView",22),!0)}static Qda(e){var r=ModelManager_1.ModelManager.MapModel.GetAllUnlockedAreas();if(void 0===r||r.size<=0)return ScrollingTipsController_1.ScrollingTipsController.ShowTipsByTextId("RecallActivity_Tips_01"),!1;var t,i=[];for([t]of r){var a=ModelManager_1.ModelManager.ExploreProgressModel.GetExploreAreaData(t);void 0!==a&&i.push(a)}if(i.sort((e,r)=>e.GetProgress()-r.GetProgress()),i.length<=0)return ScrollingTipsController_1.ScrollingTipsController.ShowTipsByTextId("RecallActivity_Tips_01"),Log_1.Log.CheckWarn()&&Log_1.Log.Warn("ActivityRecall",63,"[回流活动]ActivityRecallHelper->RecallDailyExploreTaskJump 探索任务跳转失败，当前没有探索度数据"),!1;let l=void 0;for(const n of i){var o=n.AreaId,c=ConfigManager_1.ConfigManager.AreaConfig.GetAreaInfo(o);if(void 0===c)Log_1.Log.CheckWarn()&&Log_1.Log.Warn("ActivityRecall",63,"[回流活动]ActivityRecallHelper->RecallDailyExploreTaskJump 探索任务跳转缺少area配置, 请检查q.区域表",["areaId: ",o]);else if(0===c.DeliveryMarkId)ScrollingTipsController_1.ScrollingTipsController.ShowTipsByTextId("RecallActivity_Tips_01"),Log_1.Log.CheckWarn()&&Log_1.Log.Warn("ActivityRecall",63,"[回流活动]ActivityRecallHelper->RecallDailyExploreTaskJump 探索任务跳转缺少DeliveryMarkId配置, 请检查q.区域表,并联系技术策划对齐",["areaId: ",o],["DeliveryMarkId: ",c.DeliveryMarkId]);else{o=c.DeliveryMarkId,o=MapMarkByMarkId_1.configMapMarkByMarkId.GetConfig(o);if(ModelManager_1.ModelManager.MapModel.CheckFogUnlocked(o.FogHide)){l=c;break}}}return void 0===l?(ScrollingTipsController_1.ScrollingTipsController.ShowTipsByTextId("RecallActivity_Tips_01"),!1):(r={MarkId:l.DeliveryMarkId,MarkType:l.DeliveryMarkType,StartScale:ModelManager_1.ModelManager.WorldMapModel.MapScaleMin,OpenFogId:0},WorldMapController_1.WorldMapController.OpenView(2,!1,r),!0)}static GetMinExploreAreaInfo(){var e=ModelManager_1.ModelManager.MapModel.GetAllUnlockedAreas();if(!(void 0===e||e.size<=0)){var r,t=[];for([r]of e){var i=ModelManager_1.ModelManager.ExploreProgressModel.GetExploreAreaData(r);void 0!==i&&t.push(i)}if(t.sort((e,r)=>e.GetProgress()-r.GetProgress()),!(t.length<=0)){let e=void 0;for(const o of t){var a=o.AreaId,a=ConfigManager_1.ConfigManager.AreaConfig.GetAreaInfo(a);if(void 0!==a&&0!==a.DeliveryMarkId){var l=a.DeliveryMarkId,l=MapMarkByMarkId_1.configMapMarkByMarkId.GetConfig(l);if(ModelManager_1.ModelManager.MapModel.CheckFogUnlocked(l.FogHide)){e=a;break}}}return e}}}static IsMainLineTaskFinish(e){let r=!0;return e.ArgId.forEach(e=>{e=ModelManager_1.ModelManager.QuestNewModel.CheckQuestFinished(e);r=r&&e}),r}static IsRoleTaskFinish(){var e=ModelManager_1.ModelManager.QuestNewModel.GetFirstShowQuestByType(3);return void 0!==e&&ModelManager_1.ModelManager.QuestNewModel.CheckQuestFinished(e.Id)}static GetFirstUnFinishTask(e){for(const t of e.ArgId){var r=ModelManager_1.ModelManager.QuestNewModel.GetQuestState(t);if(0!==r&&3!==r)return t}}static GetFirstMainLineUnFinishTaskId(){var e=ModelManager_1.ModelManager.QuestNewModel.GetFirstShowQuestByType(1);if(e)return e.Id}static CheckIfEntryOpen(e){return ModelManager_1.ModelManager.ActivityRecallModel.CheckIfEntryOpen(e)}static GetValidGachaPool(e){return ModelManager_1.ModelManager.ActivityRecallModel.GetValidGachaPool(e)}static ReportRecallLog1023(e){ActivityRecallHelper.aga("1023",e)}static ReportRecallLog1024(e,r=0){ActivityRecallHelper.aga("1024",e,r)}static aga(e,r,t=0){var i=ActivityRecallHelper.ActivityRecallData,a=new LogReportDefine_1.ActivityRecallLogData;a.event_id=e,a.i_activity_id=i.Id,a.i_activity_type=i.Type,a.i_time_left=i.GetActivityOpenTimeLeft(),a.i_type=r,a.i_quest_id=t,LogReportController_1.LogReportController.LogReport(a)}static GetGachaRoleId(e){return ActivityRecallHelper.GetValidGachaPool(e).PreviewIdList[0]}static GetGachaTrialRoleId(e){e=ActivityRecallHelper.GetGachaRoleId(e);return ConfigManager_1.ConfigManager.GachaConfig.GetGachaTextureInfo(e).TrialId}static GetRoleConfigByGachaId(e){e=ActivityRecallHelper.GetGachaRoleId(e);return ConfigManager_1.ConfigManager.GachaConfig.GetRoleInfoById(e)}static GetRecallOpenEntryViewConfigList(){var e,r=[],t=ModelManager_1.ModelManager.ActivityRecallModel.GetRecallEntryConfigByEntryType(1),t=(r.push(t),ModelManager_1.ModelManager.ActivityRecallModel.GetRecallEntryConfigByEntryType(2)),[t,i]=(r.push(t),ModelManager_1.ModelManager.ActivityRecallModel.GetRecallRoleEntryConfigByEntryType()),[a]=ActivityRecallHelper.CheckIfEntryOpen(t);let l=!1;return void 0!==i&&([e]=ActivityRecallHelper.CheckIfEntryOpen(i),l=e),(a||l)&&(a&&r.push(t),!a)&&l&&r.push(i),r}static GetSortedOpenRecallBaseConfigList(){var e=[];for(const r of ModelManager_1.ModelManager.ActivityRecallModel.GetRecallBaseConfigNewestList(3))ActivityRecallHelper.CheckIfEntryOpen(r)[0]&&e.push(r);return e}static GetSortedOpenRecallEntryConfigList(){var[e,r]=ModelManager_1.ModelManager.ActivityRecallModel.GetRecallRoleEntryConfigByEntryType(),t=[];return t.push(e),t.push(r),t.sort((e,r)=>{if(void 0===e||void 0===r){const t=e?1:0,i=r?1:0;return i-t}const t=ActivityRecallHelper.CheckIfEntryOpen(e)[0]?1:0,i=ActivityRecallHelper.CheckIfEntryOpen(r)[0]?1:0;return i-t}),t}}(exports.ActivityRecallHelper=ActivityRecallHelper).WQa=void 0;
//# sourceMappingURL=ActivityRecallHelper.js.map